{"TopicId":94922,"ForumId":70,"TopicTitle":"Pinning down a memory leak (?)","CreatedByName":"AccidentalDisassembly","CreatedById":110936,"CreatedDateTime":"2014-12-29T22:29:36Z","PageNum":1,"Articles":[{"CreatedByName":"AccidentalDisassembly","CreatedById":110936,"CreatedDateTime":"2014-12-29T22:29:36Z","Content":"\n\u003Cp\u003EOn my heavily-modded install of \u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EKSP\u003C/strong\u003E: 0.90, Win 32 version\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EOS\u003C/strong\u003E: Win 8.1 Enterprise x64\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EInstall location\u003C/strong\u003E: C:\\Games\\KSPNew\\\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EMods installed\u003C/strong\u003E: see picture below\u003C/p\u003E\u003Cp\u003E*I believe* all mods are up to date, but this has happened for a while and has not changed as I have updated mods as they\u0027re released.\u003C/p\u003E\u003Cp\u003E...when I load the game, I use about 2.3GB of RAM when first arriving at the KSC screen. However, after a while playing, invariably I run out of memory.\u003C/p\u003E\u003Cp\u003ENo, I am not using ATM - instead, I converted basically every texture in GameData to DDS using DDS4KSP (except for ones whose conversion caused problems/crashes, such as a couple in NearFutureSolar), resizing them to 0.5x dimensions (or smaller). I found this gave me more RAM savings than ATM.\u003C/p\u003E\u003Cp\u003EI would assume that different scenes, different numbers of parts in view, more or less flights, and all that sort of thing would make memory vary - and it does vary, but the trend is always upward. I would also assume that starting the game using 2.3GB is not really dangerous territory for running out of memory because of the number of parts I\u0027ve loaded.\u003C/p\u003E\u003Cp\u003ENumber of scene switches (in and out of VAB, reverts, switching to different craft on the Mun or Minmus or whatever) *seems* to affect RAM usage, where switching scenes more = pushing the \u0022baseline\u0022 of RAM usage higher and higher. \u003C/p\u003E\u003Cp\u003ELikewise, loading a craft in the VAB (for example) will make RAM jump maybe 200MB or so, and then closing the VAB or hitting \u0022new craft\u0022 will not result in that RAM usage going back down - it fluctuates, certainly, and sometimes by a lot, but the trend is upward. If I load a craft when 2800MB of RAM is in use (for instance), usage will jump to 3.0GB and never go back under 2900MB or so even when I leave the VAB and change scenes a bunch of times. Loading craft in VAB/SPH *seems* to be the single biggest contributor, since I noticed large jumps in memory use when doing so.\u003C/p\u003E\u003Cp\u003EIs there any way to pin down what (or which mod) is causing this phenomenon? I would like to be able to actually play for more than 30 mins or so without running out of memory on an install that really seems like it shouldn\u0027t.\u003C/p\u003E\u003Cp\u003EHere\u0027s a \u003Cstrong\u003Elog\u003C/strong\u003E: \u003Ca href=\u0022https://dl.dropboxusercontent.com/u/59567837/output_logMemoryLeak.txt\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://dl.dropboxusercontent.com/u/59567837/output_logMemoryLeak.txt\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EIn that log, I was able to crash the game due to being out of memory by doing \u003Cem\u003Enothing \u003C/em\u003Ebut switching between scenes / vessels (on the Mun and Minmus), returning to the KSC, loading vehicles in the VAB and SPH. Did not launch anything, did not do any science, etc.\u003C/p\u003E\u003Cp\u003EAnd here\u0027s a screenshot of my \u003Cstrong\u003EGameData folder \u003C/strong\u003E(EriksParts contains random, one-off parts from certain mods I liked but didn\u0027t want every part from - no DLLs in there):\u003C/p\u003E\u003Cp\u003ENote that I have deleted many, many parts from the larger parts packs (like KW, B9, NovaPunch) in order to save RAM, so I\u0027m not actually trying to run all of those mods at the same time, really.\u003C/p\u003E\u003Cp\u003E\u003Cimg src=\u0022https://dl.dropboxusercontent.com/u/59567837/gamedata12-29-2014.png\u0022 alt=\u0022gamedata12-29-2014.png\u0022\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-12-29T22:32:26Z\u0022 title=\u002212/29/2014 10:32  PM\u0022 data-short=\u00229 yr\u0022\u003EDecember 29, 2014\u003C/time\u003E by AccidentalDisassembly\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"kerbiloid","CreatedById":129408,"CreatedDateTime":"2014-12-30T06:29:01Z","Content":"\n\u003Cp\u003E(Just ideas.)\u003C/p\u003E\u003Cp\u003EAs it\u0027s generally acknowledged that KSP loads all assets at once on the game start, the problem is not in additional loading of something.\u003C/p\u003E\u003Cp\u003EAs while playing the RAM usage continuously increases until the game crash, we can say that the game releases memory blocks more slowly than allocates the new ones.\u003C/p\u003E\u003Cp\u003EAs while staying inside VAB we can load/create and destroy ships a hundred times per game session with no crash and with more or less constant RAM usage, so game objects are definitely destroyed by the game engine when become unreferenced.\u003C/p\u003E\u003Cp\u003ESo, as C# memory management is based on a garbage collector - a \u0022subprocess\u0022 which periodically checks which objects have become unreferenced and releases unused memory blocks, we can presume that:\u003C/p\u003E\u003Cp\u003E- When we are in VAB, the new objects are being created slowly - just on mouse clicks. The garbage collector from time to time checks the memory and releases unused memory - ad infinitum.\u003C/p\u003E\u003Cp\u003E- When we are playing, say, on a simple ship landed on a planet, new objects are also not created too fast. The game can last for hours.\u003C/p\u003E\u003Cp\u003E- When we are playing actively moving (launching/docking/landing) among multiple objects, the new objects are created too fast, and Garbage Collector just lags to release all destroyed objects (as the new ones are created in real time, while GC runs from time to time).\u003C/p\u003E\u003Cp\u003EThat\u0027s just my vision, maybe erroneous.\u003C/p\u003E\n"},{"CreatedByName":"AccidentalDisassembly","CreatedById":110936,"CreatedDateTime":"2014-12-30T07:45:22Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022kerbiloid\u0022 data-cite=\u0022kerbiloid\u0022\u003E\u003Cdiv\u003E(Just ideas.)\u003Cp\u003EAs it\u0027s generally acknowledged that KSP loads all assets at once on the game start, the problem is not in additional loading of something.\u003C/p\u003E\u003Cp\u003EAs while playing the RAM usage continuously increases until the game crash, we can say that the game releases memory blocks more slowly than allocates the new ones.\u003C/p\u003E\u003Cp\u003EAs while staying inside VAB we can load/create and destroy ships a hundred times per game session with no crash and with more or less constant RAM usage, so game objects are definitely destroyed by the game engine when become unreferenced.\u003C/p\u003E\u003Cp\u003ESo, as C# memory management is based on a garbage collector - a \u0022subprocess\u0022 which periodically checks which objects have become unreferenced and releases unused memory blocks, we can presume that:\u003C/p\u003E\u003Cp\u003E- When we are in VAB, the new objects are being created slowly - just on mouse clicks. The garbage collector from time to time checks the memory and releases unused memory - ad infinitum.\u003C/p\u003E\u003Cp\u003E- When we are playing, say, on a simple ship landed on a planet, new objects are also not created too fast. The game can last for hours.\u003C/p\u003E\u003Cp\u003E- When we are playing actively moving (launching/docking/landing) among multiple objects, the new objects are created too fast, and Garbage Collector just lags to release all destroyed objects (as the new ones are created in real time, while GC runs from time to time).\u003C/p\u003E\u003Cp\u003EThat\u0027s just my vision, maybe erroneous.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI don\u0027t know much about programming, but it sounds plausible - however, I can\u0027t stay inside the VAB and load/create/destroy ad infinitum, or at least I am pretty sure I can\u0027t. The more I load/new/load/new etc., the more ram is used. Usage does vary, but it trends upward. \u003C/p\u003E\u003Cp\u003EIs there any way to figure out what\u0027s going on? I am at my wits\u0027 end, I just want to play (with the mods I have chosen and which don\u0027t push me anywhere near the memory limit initially). =(\u003C/p\u003E\n"},{"CreatedByName":"Jebadiah Kerban","CreatedById":114356,"CreatedDateTime":"2014-12-31T10:52:36Z","Content":"\n\u003Cp\u003EHi.\u003C/p\u003E\u003Cp\u003ECould i please have the log?\u003C/p\u003E\u003Cp\u003Ealso i would like to know:\u003C/p\u003E\u003Cp\u003ERam_GB_:\u003C/p\u003E\u003Cp\u003EHard_drive space free:\u003C/p\u003E\u003Cp\u003EFPS:\u003C/p\u003E\u003Cp\u003Ealso every mod uses 100MB of ram at least to run so if you have 20 mods you will need 6.2GB of ram with 2 GB hard_drivespace free\u003C/p\u003E\n"},{"CreatedByName":"Rasip","CreatedById":127136,"CreatedDateTime":"2014-12-31T11:35:31Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Jebadiah Kerban\u0022 data-cite=\u0022Jebadiah Kerban\u0022\u003E\u003Cdiv\u003E\u003Cp\u003Ealso every mod uses 100MB of ram at least to run\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EWhere did you get that number? I\u0027ve got 34 mods running right now and am only at 1.4GB. By your math i should be using 3.3GB just for the mods.\u003C/p\u003E\u003Cp\u003EOP, the memory leak is in KSP itself. Over 90% of the out of memory crashes I\u0027ve seen have been while loading into the VAB.\u003C/p\u003E\n"},{"CreatedByName":"Jebadiah Kerban","CreatedById":114356,"CreatedDateTime":"2015-01-01T06:54:38Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Rasip\u0022 data-cite=\u0022Rasip\u0022\u003E\u003Cdiv\u003EWhere did you get that number? I\u0027ve got 34 mods running right now and am only at 1.4GB. By your math i should be using 3.3GB just for the mods.\u003Cp\u003EOP, the memory leak is in KSP itself. Over 90% of the out of memory crashes I\u0027ve seen have been while loading into the VAB. so that means im dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb dumb\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EToo many mods then or some ids are the same\u003C/p\u003E\n"},{"CreatedByName":"AccidentalDisassembly","CreatedById":110936,"CreatedDateTime":"2015-01-02T19:47:44Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Jebadiah Kerban\u0022 data-cite=\u0022Jebadiah Kerban\u0022\u003E\u003Cdiv\u003E\u003Cp\u003EHi.\u003C/p\u003E\u003Cp\u003ECould i please have the log?\u003C/p\u003E\u003Cp\u003EToo many mods then or some ids are the same\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThe log is linked in my post. The word \u0022log\u0022 is even in bold. I don\u0027t have too many mods - I start at 2.3GB used, and it simply goes up from there \u003Cem\u003Ewithout installing any more mods - \u003C/em\u003Ejust by playing, and especially by loading craft in the VAB/SPH. Nothing gets unloaded, maybe. I don\u0027t know.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022\u003E\u003Cdiv\u003EOP, the memory leak is in KSP itself.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EMan, I hope Squad will look at memory use in KSP, if that\u0027s the case. EDIT: Unless it\u0027s a Unity thing, in which case I hope they\u0027ll write many angry letters. It seems rather important to address memory leaks and memory usage more generally in a game that derives most of its lasting interest (and its proselytizing fans) from the ability to mod it, which takes memory, of course.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-01-02T19:54:06Z\u0022 title=\u002201/02/2015 07:54  PM\u0022 data-short=\u00229 yr\u0022\u003EJanuary 2, 2015\u003C/time\u003E by AccidentalDisassembly\u003C/strong\u003E\n\u003C/span\u003E\n"}]}