{"TopicId":41548,"ForumId":20,"TopicTitle":"KSPAddon bug causes mod incompatibilities","CreatedByName":"Majiir","CreatedById":7550,"CreatedDateTime":"2013-08-08T02:15:06Z","PageNum":1,"Articles":[{"CreatedByName":"Majiir","CreatedById":7550,"CreatedDateTime":"2013-08-08T02:15:06Z","Content":"\n\u003Cp\u003E\u003Cstrong\u003E\u003Cspan style=\u0022color:#800080;\u0022\u003E\u003Cspan style=\u0022font-size:10px;\u0022\u003EThis issue has been resolved and the fix is no longer necessary.\u003C/span\u003E\u003C/span\u003E\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003E---------------\u003C/p\u003E\u003Cp\u003EHi folks,\u003C/p\u003E\u003Cp\u003EIf you\u0027re having issues with mod compatibility where one seems to \u0022disable\u0022 the other, you may be a victim of a KSPAddon bug. I discovered this while hunting down the cause of the Kethane and UniverseReplacer conflict.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EWhat is KSPAddon?\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003EThis feature was \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/showthread.php/34013-0-20-PartTools-GameDatabase-and-new-features\u0022 rel=\u0022external nofollow\u0022\u003Eadded in the KSP 0.20 update\u003C/a\u003E. A class tagged with KSPAddon can start without an associated part, which is useful for mods that add behavior at a higher level. Some mods that have part functionality also use KSPAddon to run background tasks or handle plugin-wide data.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EWhat\u0027s the problem?\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003EThere\u0027s a bug in the addon loader (in the stock game) that can cause mod compatibility issues. KSPAddon has a \u0022once\u0022 parameter which, if set to \u003Cem\u003Etrue\u003C/em\u003E will cause that addon to only be started once (until the game is restarted). Once an addon starts, the addon loader adds it to a list of addons to skip for next time. The problem is in how entries in this list are compared; the addon loader only looks at the two attribute parameters. So, if you have two addons from two different mods that are both configured to start at the main menu and start only once, \u003Cem\u003Eonly one addon will ever start\u003C/em\u003E because when the loader sees the second one, it thinks it\u0027s already been loaded and skips it. \u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EHow do I fix it?\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003EUntil this is fixed in the base game, you have two options. You can set the \u0022once\u0022 parameter to false and refactor your code to support that, or you can use my KSPAddonFixed attribute. This requires an additional type parameter which should equal the type you\u0027re applying the attribute to.\u003C/p\u003E\u003Cp\u003EExample usage:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E[KSPAddonFixed(KSPAddon.Startup.MainMenu, true, typeof(MyAddon))]\u003Cbr\u003Epublic class MyAddon : MonoBehaviour\u003Cbr\u003E{\u003Cbr\u003E// ...\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EKSPAddonFixed source (under \u003Ca href=\u0022http://creativecommons.org/publicdomain/zero/1.0/\u0022 rel=\u0022external nofollow\u0022\u003ECC0 Public Domain Dedication\u003C/a\u003E):\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E/// \u0026lt;summary\u0026gt;\u003Cbr\u003E/// KSPAddon with equality checking using an additional type parameter. Fixes the issue where AddonLoader prevents multiple start-once addons with the same start scene.\u003Cbr\u003E/// \u0026lt;/summary\u0026gt;\u003Cbr\u003Epublic class KSPAddonFixed : KSPAddon, IEquatable\u0026lt;KSPAddonFixed\u0026gt;\u003Cbr\u003E{\u003Cbr\u003E    private readonly Type type;\u003Cbr\u003E\u003Cbr\u003E    public KSPAddonFixed(KSPAddon.Startup startup, bool once, Type type)\u003Cbr\u003E        : base(startup, once)\u003Cbr\u003E    {\u003Cbr\u003E        this.type = type;\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public override bool Equals(object obj) {\u003Cbr\u003E        if (obj.GetType() != this.GetType()) { return false; }\u003Cbr\u003E        return Equals((KSPAddonFixed)obj);\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public bool Equals(KSPAddonFixed other)\u003Cbr\u003E    {\u003Cbr\u003E        if (this.once != other.once) { return false; }\u003Cbr\u003E        if (this.startup != other.startup) { return false; }\u003Cbr\u003E        if (this.type != other.type) { return false; }\u003Cbr\u003E        return true;\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public override int GetHashCode()\u003Cbr\u003E    {\u003Cbr\u003E        return this.startup.GetHashCode() ^ this.once.GetHashCode() ^ this.type.GetHashCode();\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EI advise including the KSPAddonFixed source in your plugin. You could reference another plugin using it, but that\u0027s a hassle; multiple definitions with the same name won\u0027t cause any harm (since they\u0027ll be in different namespaces).\u003C/p\u003E\u003Cp\u003E[EDIT] On the KSP issue tracker: \u003Ca href=\u0022http://bugs.kerbalspaceprogram.com/issues/1176\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://bugs.kerbalspaceprogram.com/issues/1176\u003C/a\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-07-19T06:18:09Z\u0022 title=\u002207/19/2014 06:18  AM\u0022 data-short=\u00229 yr\u0022\u003EJuly 19, 2014\u003C/time\u003E by Majiir\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"TaranisElsu","CreatedById":57742,"CreatedDateTime":"2013-08-08T06:21:39Z","Content":"\n\u003Cp\u003EInteresting. I experienced that when I had two KSPAddon MonoBehaviors in the same plugin that both only wanted to be started once. Nice to see that it wasn\u0027t something that I was doing wrong.\u003C/p\u003E\n"},{"CreatedByName":"MSD","CreatedById":59320,"CreatedDateTime":"2013-08-08T23:25:54Z","Content":"\n\u003Cp\u003EThanks, so I now can use both\u003C/p\u003E\n"},{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-11T12:55:58Z","Content":"\n\u003Cp\u003EHello everyone, sorry for the necro, but I was wondering if it has been fixed since it\u0027s been almost a year or if Majir\u0027s fix still applies.\u003C/p\u003E\n"},{"CreatedByName":"Majiir","CreatedById":7550,"CreatedDateTime":"2014-07-19T06:17:19Z","Content":"\n\u003Cp\u003EThis fix is no longer necessary as of a few updates ago.\u003C/p\u003E\n"},{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-07-19T10:32:44Z","Content":"\n\u003Cp\u003EThank you \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"}]}