{"TopicId":110576,"ForumId":29,"TopicTitle":"[Answered] Persistent Fields and Revert to VAB","CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-05-24T02:19:42Z","PageNum":1,"Articles":[{"CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-05-24T02:19:42Z","Content":"I\u0027ve got a mod that allows you to tweak some of the fields in ModuleProceduralFairing. It also sets these fields to persistent so that on vehicle load those changes will, well, persist.\n\nWhen you load a vessel in the VAB, everything\u0027s fine.\n\nWhen you fly, return to the space center, and load from the tracking station, everything\u0027s fine.\n\nWhen you revert to launch, everything\u0027s fine.\n\n...\n\nWhen you *revert to VAB,* all the fields revert to their default values.\n\nIs it normal for persistent values to act weird when reverting to VAB/SPH, or could this be a mysterious quirk with ModuleProceduralFairing?\n\n**Edited \u003Ctime datetime=\u00222015-06-23T00:01:57Z\u0022 title=\u002206/23/2015 12:01  AM\u0022 data-short=\u00229 yr\u0022\u003EJune 23, 2015\u003C/time\u003E by Wheffle**"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2015-05-25T03:14:50Z","Content":"Doesn\u0027t sound like a problem with persistence but rather with determining when to poke your stored values at ModuleProceduralFairing?\n\nI.e. your module\u0027s values may be fine but if you don\u0027t always apply them to the MPF module you sit next to then sometimes it\u0027ll look like the values don\u0027t get saved. Or am I misreading?"},{"CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-05-25T19:14:44Z","Content":"Well, i actually set ModuleProceduralFairing\u0027s own fields to persistant. I guess there might be code somewhere that only fires on Revert to VAB that doesn\u0027t expect those to be persistant, but that sounds weird to me.\n\nYou didn\u0027t misread, i just didnt clarify ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif)\n\n**Edited \u003Ctime datetime=\u00222015-05-25T19:17:29Z\u0022 title=\u002205/25/2015 07:17  PM\u0022 data-short=\u00229 yr\u0022\u003EMay 25, 2015\u003C/time\u003E by Wheffle**"},{"CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-06-04T03:05:01Z","Content":"Still no luck finding out what\u0027s going on here. Although manually re-loading the vessel after a revert-to-VAB is a reliable work-around, I\u0027m still haunted by the apparent secret code that gets fired (or not fired) specifically with revert-to-VAB. I would assume all it does it change the scene to the editor and then load the autosaved vessel, but in that case you\u0027d think manually re-loading the vessel wouldn\u0027t help anything.\n\nI\u0027m not well versed in this, so any insight would be appreciated. Otherwise I think I\u0027m going to shelve this unsolved mystery."},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2015-06-04T03:42:57Z","Content":"I just had a thought, how are you saving your data exactly?\n\nOne quirk of KSP is that when you click the \u0022launch\u0022 to go VAB-Flight and \u0022rever to VAB\u0022 to go flight-VAB, KSP does not actually use your saved vessel as named, rather it uses \u0022Auto-Saved Vessel\u0022. This is why if you don\u0027t click the save button before launching, you sometimes lose changes because KSP saves to \u0022Auto-Saved Vessel\u0022, not your named vessel, on launch.\n\nBecause you mention that manually reloading the vessel is a reliable work around, I wonder if this is the issue (or part of it) that you are running into.\n\nD."},{"CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-06-04T08:48:02Z","Content":"\u003E \n\u003E I just had a thought, how are you saving your data exactly?\n\u003E One quirk of KSP is that when you click the \u0022launch\u0022 to go VAB-Flight and \u0022rever to VAB\u0022 to go flight-VAB, KSP does not actually use your saved vessel as named, rather it uses \u0022Auto-Saved Vessel\u0022. This is why if you don\u0027t click the save button before launching, you sometimes lose changes because KSP saves to \u0022Auto-Saved Vessel\u0022, not your named vessel, on launch.\n\u003E \n\u003E Because you mention that manually reloading the vessel is a reliable work around, I wonder if this is the issue (or part of it) that you are running into.\n\u003E \n\u003E D.\n\nYou know, that could have something to do with it, but I\u0027m not sure.\n\nAll I\u0027m doing is setting fields (which already exist) in ModuleProceduralFairing to persistent and hoping the dev\u0027s code behind the module does the rest. So far it works as expected in every tested case except revert to VAB. Does auto save have some kind of issue with persistent fields?\n\n    //pretty much what\u0027s going onpf = getProceduralFairingModule();pf.Fields[\u0022fieldNameHere\u0022].isPersistent = true;"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2015-06-04T09:03:48Z","Content":"When do you do that ? Start, Awake ? It may be that the even order is different when comming back to the VAB and you set the field as persistent after the loading is done"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2015-06-04T09:40:28Z","Content":"\u003E \n\u003E Well, i actually set ModuleProceduralFairing\u0027s own fields to persistant.\n\nThis is your main problem. Your code works in the editor because the changes it makes to persistence are in effect every time the craft gets saved there. But they\u0027re lost whenever a part is instantiated (until your OnStart runs). You might think you could just edit the ModuleProceduralFairings field persistence on the part prefab but unfortunately each module seems to recreate its own fields when instantiated and any changes to the prefab\u0027s fields are lost.\n\nThat\u0027s why you\u0027re seeing oddness in revert. When the vessel gets loaded in flight, a snapshot is created before any PartModule OnStarts are run and saved to ShipConstruction.ShipConfig which is what gets used when reverting to VAB. Since your code hasn\u0027t run yet, the fields you want to save aren\u0027t yet persistent and don\u0027t get saved to this config so when the player reverts, any changes are lost"},{"CreatedByName":"Merill","CreatedById":136069,"CreatedDateTime":"2015-06-04T16:42:38Z","Content":"I tried to do that with reflection (to attack the KSPfield). But it\u0027s not possible. \n\nInstead, in onSave, i create nodes from the other module data. In onLoad, i load the data from my node and set them to the other module\u0027s fields."},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2015-06-04T21:29:33Z","Content":"But are you doing anything in the OnStart() method?\n\nIn the editor, when loading a vessel from file, the partModule\u0027s OnLoad() method runs before the OnStart() method does. If you have any initialization or setup code in OnStart(), it can wipe the data you just loaded in the OnLoad() method.\n\nNote that in flight, afaik the OnStart() method runs before the OnLoad() method does just to make things extra confusing.\n\nD."},{"CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-06-05T22:10:47Z","Content":"Thanks for the replies! Really super appreciated.\n\n\u003E \n\u003E This is your main problem. Your code works in the editor because the changes it makes to persistence are in effect every time the craft gets saved there. But they\u0027re lost whenever a part is instantiated (until your OnStart runs). You might think you could just edit the ModuleProceduralFairings field persistence on the part prefab but unfortunately each module seems to recreate its own fields when instantiated and any changes to the prefab\u0027s fields are lost.\n\u003E That\u0027s why you\u0027re seeing oddness in revert. When the vessel gets loaded in flight, a snapshot is created before any PartModule OnStarts are run and saved to ShipConstruction.ShipConfig which is what gets used when reverting to VAB. Since your code hasn\u0027t run yet, the fields you want to save aren\u0027t yet persistent and don\u0027t get saved to this config so when the player reverts, any changes are lost\n\nForgive me, I\u0027m still a little bit lost. The changes remain when you launch the vessel, revert to launch or focus a vessel from the tracking station, as well as when you load the ship from a file in the VAB. What\u0027s happening different that only happens specifically on revert to VAB?\n\nIn other words, if ModuleProceduralFairing\u0027s fields become non-persistent again (and ignore saved persistent values) every time the part is instantiated, then my code shouldn\u0027t work on launch or in any of those other circumstances, because I\u0027m setting them to persistent in the OnStart() method which is running after ModuleProceduralFairing does its thing (I think).\n\nMaybe I\u0027m not understanding the exact order in which modules load and perform their OnStart()/OnAwake()/OnLoad() methods?"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2015-06-06T11:08:40Z","Content":"\u003E \n\u003E Forgive me, I\u0027m still a little bit lost. The changes remain when you launch the vessel, revert to launch or focus a vessel from the tracking station, as well as when you load the ship from a file in the VAB. What\u0027s happening different that only happens specifically on revert to VAB?\n\nThe short answer is that reverting to the VAB causes the editor to load from a ConfigNode that was created when the fairing module\u0027s fields weren\u0027t set to persistent. \n\nThis happens because when you enter flight, the vessel gets created from the various part prefabs which wipe your persistence changes, and then *that* instance of the vessel is saved before any OnStarts run. Why doesn\u0027t the game just use the ConfigNode it must have loaded from disk instead? I have no idea\n\n\u003E \n\u003E In other words, if ModuleProceduralFairing\u0027s fields become non-persistent again (and ignore saved persistent values)\n\nThat\u0027s not what persistent means. Persistence simply means \u0022write this value to the disk when object is saved\u0022. All KSPFields will load data from a ConfigNode if it contains a name-value key for it. Non-persistent fields won\u0027t normally have this value saved in a ConfigNode and instead will end up with whatever their clone-source field value is.\n\nAnyway, to solve your problem, move your persistent attribute changes into OnAwake and set your slider initial values in OnLoad (instead of alongside your persistence changes).\n\n**Edited \u003Ctime datetime=\u00222015-06-06T11:14:03Z\u0022 title=\u002206/06/2015 11:14  AM\u0022 data-short=\u00229 yr\u0022\u003EJune 6, 2015\u003C/time\u003E by xEvilReeperx**"},{"CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-06-06T20:14:08Z","Content":"Thank you for taking time to thoroughly explain! It\u0027s been a learning experience. Now that I understand a little better I\u0027ll make some changes and see what happens."},{"CreatedByName":"Wheffle","CreatedById":74893,"CreatedDateTime":"2015-06-23T00:01:38Z","Content":"Just to follow up, switching over to OnAwake() seems to have worked. Thanks for the help ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)"}]}