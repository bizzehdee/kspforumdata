{"TopicId":121100,"ForumId":44,"TopicTitle":"KSP, Linux, swap \u0026amp; hibernate","CreatedByName":"Laie","CreatedById":110461,"CreatedDateTime":"2015-09-17T17:22:13Z","PageNum":1,"Articles":[{"CreatedByName":"Laie","CreatedById":110461,"CreatedDateTime":"2015-09-17T17:22:13Z","Content":"\n\u003Cp\u003ESo, I like hibernate (suspend-to-disk). However, it doesn\u0027t play nicely with KSP:\u003C/p\u003E\u003Cp\u003EWhen I log back in, KSP is still there, but barely responding. By all appearences, it is still mostly on disk and data is being pulled into RAM \u0022as needed\u0022. Trying to work around the issue by doing a swapoff/swapon, I find that swapoff takes about ten minutes (varying from case to case, I\u0027ve seen everything between 6 and 15 minutes). Data rate from disk is low, often on the order of 1MB/s, but one CPU is fully maxed out.\u003C/p\u003E\u003Cp\u003EEven better: if I kill KSP before or during swapoff, the swap clears much faster. It still hogs one CPU, but only for 90-120 seconds. Well, it\u0027s not surprising that discarding data is much easier than sorting it out, but frankly, I\u0027d have expected the disk to be the bottleneck in either case.\u003C/p\u003E\u003Cp\u003EBy comparison, the act of suspending to disk works very quickly. It pretty much has to be a single contigouos write in order to finish as fast as it does.\u003C/p\u003E\u003Cp\u003EWhat is going on here, why is it so CPU-intensive to get the data back from disk?\u003C/p\u003E\n"},{"CreatedByName":"rtxoff","CreatedById":107622,"CreatedDateTime":"2015-09-17T17:59:20Z","Content":"\n\u003Cp\u003EI guess it\u0027s because the the wake up process is entirely controlled by the firmware in the motherboard and that one often doesn\u0027t use the full speed of the interfaces for compatibility reasons. Also it might take some time until all the peripherals are back online, there might be an intended pause until all of them back to nominal. Additionally it might be a bit tricky to get the processor into the exact same state it was before the hibernation. This all takes more time i guess then just writing their actual states to the disk.\u003C/p\u003E\n"},{"CreatedByName":"LordFerret","CreatedById":111598,"CreatedDateTime":"2015-09-17T20:04:51Z","Content":"\n\u003Cp\u003EWhen you hibernate in Linux, the entire contents of memory are swapped out as an image and then the machine and all its services are shut down; On restart, the system boots, sees the image in swap and loads it and executes from there. When you suspend, everything is left in memory and the machine (cpu and memory) goes into a low power state, with the hard drives, display, and other peripherals being powered off; On restore, the power state is brought back up (cpu and memory) and hard drives and display and such are re-enabled.\u003C/p\u003E\u003Cp\u003EAccording to the Debian Wiki, there is an alternative for the slow recovery from hibernation; And that is to suspend first, then hibernate. You can read more about it \u003Ca href=\u0022https://wiki.debian.org/Hibernation\u0022 rel=\u0022external nofollow\u0022\u003Ehere\u003C/a\u003E.\u003C/p\u003E\n"},{"CreatedByName":"Laie","CreatedById":110461,"CreatedDateTime":"2015-09-17T20:50:32Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022LordFerret\u0022 data-cite=\u0022LordFerret\u0022\u003E\u003Cdiv\u003EWhen you hibernate [...] When you suspend, [...]\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThat\u0027s why I like the terms \u0022suspend-to-disk\u0022 and \u0022suspend-to-ram\u0022, which are usually well understood regardless of what branding one is used to.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022LordFerret\u0022 data-cite=\u0022LordFerret\u0022\u003E\u003Cdiv\u003EAccording to the Debian Wiki, there is an alternative for the slow recovery from hibernation; And that is to suspend first, then hibernate. You can read more about it \u003Ca href=\u0022https://wiki.debian.org/Hibernation\u0022 rel=\u0022external nofollow\u0022\u003Ehere\u003C/a\u003E.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003E(reading, following links, reading some more) As I understand it, this saves time on the way down: suspend-to-ram, put it in your pocket, and if you don\u0027t use it within a configurable time, it will suspend to disk.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022LordFerret\u0022 data-cite=\u0022LordFerret\u0022\u003E\u003Cdiv\u003EWhen you hibernate in Linux, the entire contents of memory are swapped out as an image and then the machine and all its services are shut down; On restart, the system boots, sees the image in swap and loads it and executes from there.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThis pretty much sums up all I know about the process. I\u0027d have expected that writing and reading should take about the same amount of time, and that the system won\u0027t become available until memory has been fully restored from disk. Both assumptions are obviously wrong, but I don\u0027t know why.\u003C/p\u003E\u003Cp\u003EIncidentally, on windows, it\u0027s the other way \u0027round: the process of suspending to disk takes friggin\u0027 ages, but restore happens quickly and completely. Linux also restores quickly, but unlike windows, the running applications aren\u0027t fully useable: they\u0027re apparently being pulled from swap on demand. No matter how long the box has been sitting there showing the password prompt, once I sign on and touch anything, there\u0027s a noticable delay until it responds. For a terminal window or a browser tab, the delay is short and easy to ignore. KSP, on the other hand, takes a minute to show any response and will lag horribly for an hour or more. Swapoff really is the only cure; it takes a good while to complete, but once it\u0027s done, all is well.\u003C/p\u003E\n"},{"CreatedByName":"LordFerret","CreatedById":111598,"CreatedDateTime":"2015-09-17T21:44:57Z","Content":"\n\u003Cp\u003EI\u0027m not an expert on it, but I will say that I can imagine \u003Cem\u003E\u003Cspan style=\u0022text-decoration:underline;\u0022\u003Ethere is a lot more at play\u003C/span\u003E\u003C/em\u003E than just swapping a memory image to/from disk during hibernation. If you\u0027ll think about it: all of the system services, all those open files/devices and the handles assigned, what memory allocated to who, etc ... when you return from hibernation, all of that must somehow be restored/reinstated into a system coming out of a cold boot - after all, your system was saved in a state with having all such allocations and references.\u003C/p\u003E\u003Cp\u003EUnlike Windows, I\u0027d bet you could find more comprehensive documentation as to what actually goes on with Linux hibernation.\u003C/p\u003E\u003Cp\u003E\u003Cspan style=\u0022font-size:8px;\u0022\u003E\u003Cspan style=\u0022color:#C0C0C0;\u0022\u003E- - - Updated - - -\u003C/span\u003E\u003C/span\u003E\u003C/p\u003E\u003Cp\u003EThis is a bit dated, but you might want to check it out anyway...\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://www.kernel.org/doc/Documentation/power/basic-pm-debugging.txt\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://www.kernel.org/doc/Documentation/power/basic-pm-debugging.txt\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan style=\u0022font-size:8px;\u0022\u003E\u003Cspan style=\u0022color:#C0C0C0;\u0022\u003E- - - Updated - - -\u003C/span\u003E\u003C/span\u003E\u003C/p\u003E\u003Cp\u003EThis is a bit more in-depth; It covers device power managment, suspend, and hibernation. I\u0027m about to read through it myself. Enjoy.\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://lxr.free-electrons.com/source/Documentation/power/devices.txt\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://lxr.free-electrons.com/source/Documentation/power/devices.txt\u003C/a\u003E\u003C/p\u003E\n"}]}