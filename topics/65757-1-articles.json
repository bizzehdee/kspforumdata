{"TopicId":65757,"ForumId":29,"TopicTitle":"Adding an EVENT to a part in code","CreatedByName":"codepoet","CreatedById":73449,"CreatedDateTime":"2014-03-14T09:30:24Z","PageNum":1,"Articles":[{"CreatedByName":"codepoet","CreatedById":73449,"CreatedDateTime":"2014-03-14T09:30:24Z","Content":"\n\u003Cp\u003EI want to be able to add and event to a par in code, but am struggling to figure out how to do this.\u003C/p\u003E\u003Cp\u003EThe reason is that I want to add / remove options when the player right clicks on a part while in flight. I need to be able to add / remove any umber of options, so I can\u0027t just hide/display them. Does anyone know how to do this, or think of another mod that already does it, so I can go an look at its code?\u003C/p\u003E\u003Cp\u003EThanks\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-03-14T16:56:35Z","Content":"\n\u003Cp\u003EOkay, I thought about this a bit and the best answer I can give you is \u0022maybe\u0022.\u003C/p\u003E\u003Cp\u003EI would need more details on what you are trying to do, what I think you are trying to do should be possible, but your post leaves it vague enough the answer could also be that it is not possible.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"codepoet","CreatedById":73449,"CreatedDateTime":"2014-03-14T18:28:38Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Diazo\u0022 data-cite=\u0022Diazo\u0022\u003E\u003Cdiv\u003EOkay, I thought about this a bit and the best answer I can give you is \u0022maybe\u0022.\u003Cp\u003EI would need more details on what you are trying to do, what I think you are trying to do should be possible, but your post leaves it vague enough the answer could also be that it is not possible.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI want to be able to right click on apart that have kerbals in it and choose things for a particular kerbal to do - so if there are six kerals in a part I would add six events - \u0022Change Jeb\u0027s socks\u0022 ; \u0022Change Bill\u0027s socks\u0022 ; \u0022Change Bob\u0027s socks\u0022 etc etc. Or maybe there are other options depending on the situation.\u003C/p\u003E\u003Cp\u003EDoes that help? Does that turn your \u0022maybe\u0022 into a \u0022yes\u0022?\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-03-14T19:20:50Z","Content":"\n\u003Cp\u003E2 thoughts come to mind on how to do that.\u003C/p\u003E\u003Cp\u003EThe first is to make several empty KSPEvents that are hidden by default and only become visible when they are populated with an action.\u003C/p\u003E\u003Cp\u003EThis is probably the easier way, but however many fields you create is a hard limit. If you create 30 fields and end up with 33 actions, the last 3 actions would not be visible. Having said that, at 30 actions the menu would extend off the screen.\u003C/p\u003E\u003Cp\u003EThe second is to find where the right-click list is stored and dynamically add your actions to that list directly.\u003C/p\u003E\u003Cp\u003EWhile probably more difficulty, this method is more flexible and does not have any limit on the number of actions you can add.\u003C/p\u003E\u003Cp\u003EAnd this is as far as I can help you. I have not done anything that resembles either of those scenarios so I would not know where to start in terms of actually writing code.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"notfirestorm","CreatedById":66483,"CreatedDateTime":"2014-03-14T22:18:04Z","Content":"\n\u003Cp\u003EQuestion: is the events you\u0027re trying to code time-critical (like you need to toggle your air intakes on an SSTO), or are they more \u0027do it when you\u0027re safely in orbit\u0027? If it\u0027s the latter, you might have more options available to you...\u003C/p\u003E\u003Cp\u003EIf you don\u0027t mind learning how to make GUIs, you could make an event that shows/hides a window where you control the GUI and can loop through each crew in the part and display a button for them to change their socks. And... if there is a case where you need to change socks in an emergency, you could make two events, one that hides/shows the custom GUI window, and the other \u0027Emergency Change All Crew Socks\u0027 that just changes all the crews socks. Give me a few minutes to dig through my code that does stuff like this and I\u0027ll post it here.\u003C/p\u003E\u003Cp\u003EEDIT: Code followeth. This may not compile, so be warned\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Eprivate Boolean showingCrewSockUi = false;\u003Cbr\u003Eprivate Rect crewSockUiWindow= new Rect(100f, 100f, 250f, 400f);\u003Cbr\u003Eprivate Vector2 crewSockScrollPosition = new Vector2(0.0f, 0.0f);\u003Cbr\u003E\u003Cbr\u003E    [KSPEvent(guiActive=true, guiName=\u0022Manage Crew Socks\u0022)]\u003Cbr\u003E    public void ManageCrewSocks()\u003Cbr\u003E    {\u003Cbr\u003E        if (!showingCrewSockUi )\u003Cbr\u003E        {\u003Cbr\u003E            RenderingManager.AddToPostDrawQueue(0, drawCrewSocks);\u003Cbr\u003E            showingCrewSockUi = true;\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    [KSPAction(\u0022Manage Crew Socks\u0022)]\u003Cbr\u003E    public void ManageCrewSocksAction(KSPActionParam param)\u003Cbr\u003E    {\u003Cbr\u003E        ManageCrewSocks();\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public void drawCrewSocks()\u003Cbr\u003E    {\u003Cbr\u003E        if (showingCrewSockUi )\u003Cbr\u003E        {\u003Cbr\u003E            crewSockUiWindow= GUILayout.Window(424242, crewSockUiWindow, drawCrewSocksWindow, \u0022Manage Crew Socks\u0022);\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    private void drawCrewSocksWindow(int id)\u003Cbr\u003E    {\u003Cbr\u003E        GUILayout.BeginVertical();\u003Cbr\u003E        GUILayout.BeginHorizontal();\u003Cbr\u003E        GUILayout.Label(\u0022Click on a crew to change their socks!\u0022);\u003Cbr\u003E        GUILayout.EndHorizontal();\u003Cbr\u003E        crewSockScrollPosition = GUILayout.BeginScrollView(crewSockScrollPosition);\u003Cbr\u003E        foreach (ProtoCrewMember kerbal in part.protoModuleCrew)\u003Cbr\u003E        {\u003Cbr\u003E            GUILayout.BeginHorizontal();\u003Cbr\u003E            if (GUILayout.Button(\u0022Change Socks of \u0022\u002Bkerbal.name))\u003Cbr\u003E            {\u003Cbr\u003E                ChangeCrewsSocks(kerbal); // Your internal change sock function goeth here\u003Cbr\u003E            }\u003Cbr\u003E            GUILayout.EndHorizontal();\u003Cbr\u003E        }\u003Cbr\u003E        GUILayout.EndScrollView();\u003Cbr\u003E        GUILayout.BeginHorizontal();\u003Cbr\u003E        if (GUILayout.Button(\u0022Close\u0022)\u003Cbr\u003E        {\u003Cbr\u003E            RenderingManager.RemoveFromPostDrawQueue(0, drawCrewSocks);\u003Cbr\u003E            showingCrewSockUi = false;\u003Cbr\u003E        }\u003Cbr\u003E        GUILayout.EndHorizontal();\u003Cbr\u003E        GUILayout.EndVertical();\u003Cbr\u003E        GUI.DragWindow();\u003Cbr\u003E    }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EBasically what this *should* do is give you a right click menu option that when clicked, pops up a window that should show all the kerbals currently in that part, and if you click on their names, it will change their socks, and if you click on the close button, it closes the popup window.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-03-14T22:38:09Z\u0022 title=\u002203/14/2014 10:38  PM\u0022 data-short=\u002210 yr\u0022\u003EMarch 14, 2014\u003C/time\u003E by notfirestorm\u003C/strong\u003E\n\u003Cbr\u003EAdding code to example\n\u003C/span\u003E\n"},{"CreatedByName":"codepoet","CreatedById":73449,"CreatedDateTime":"2014-03-14T22:27:15Z","Content":"\n\u003Cp\u003EI could build a GUI (and know how a do so (although I am not very good at it!) ) \u003C/p\u003E\u003Cp\u003EHowever I am hoping to write a mod that purposly avoids displaying another GUI window. I am trying to make it appear very small, minimal and simple.\u003C/p\u003E\u003Cp\u003EIn answer to your question, I do not think time critical is a big concern for me.\u003C/p\u003E\n"},{"CreatedByName":"notfirestorm","CreatedById":66483,"CreatedDateTime":"2014-03-14T22:42:17Z","Content":"\n\u003Cp\u003EAlright, but a problem you\u0027ll probably hit trying to make right click buttons for every crew currently in the part is that\u003C/p\u003E\u003Cp\u003E 1) you are going to be forcing all parts of your type to have that number of crew capacity, and\u003C/p\u003E\u003Cp\u003E 2) I don\u0027t think you\u0027ll be able to change the name of the events to match the Kerbal\u0027s name currently in that seat, the events will be like \u0022Change Kerbal\u0027s socks in Seat 1\u0022\u003C/p\u003E\u003Cp\u003EI applaud you trying not to resort to a popup window though, because they are annoying, but sometimes you don\u0027t have a choice.\u003C/p\u003E\u003Cp\u003EEDIT: Actually I take #2 back. I think you can edit the text on the fly in the OnUpdate() override method:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eif (part.protoModuleCrew.Count \u0026gt;= 1)\u003Cbr\u003E{\u003Cbr\u003EEvents[\u0022ChangeKerbalsSocksInSeat1\u0022].active = true;\u003Cbr\u003EEvents[\u0022ChangeKerbalsSocksInSeat1\u0022].guiText = \u0022Change \u0022 \u002B part.protoModuleCrew[0].name \u002B \u0022\u0027s socks\u0022;\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-03-14T22:50:04Z\u0022 title=\u002203/14/2014 10:50  PM\u0022 data-short=\u002210 yr\u0022\u003EMarch 14, 2014\u003C/time\u003E by notfirestorm\u003C/strong\u003E\n\u003Cbr\u003ENow with Code tags!\n\u003C/span\u003E\n"},{"CreatedByName":"Faark","CreatedById":69775,"CreatedDateTime":"2014-03-15T11:06:07Z","Content":"\n\u003Cp\u003EYou could also try to add an new element to Events. Though this will probably come with some issues you have to resolve manually, like GUIs not properly updating (though that might be an issue anyway; there was some expensive code to force-update the right menu in some forum thread) or KSP trying to save \u0026amp; restore your events. Haven\u0027t used it in a while, but the code could look sth like that:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Eclass myBomb: PartModule{\u003Cbr\u003E    void updateEvents(){\u003Cbr\u003E        Events.Clear();\u003Cbr\u003E        if(ExplodeEventAvailable){\u003Cbr\u003E            Events.Add(new BaseEvent(Events, \u0022explodeMyBomb\u0022, ()=\u0026gt;{\u003Cbr\u003E                Part.Explode();\u003Cbr\u003E                // more logic to dmg related stuff\u003Cbr\u003E            }, new KSPEvent{ guiName = \u0022Detonate NOW!\u0022, guiActive = true });\u003Cbr\u003E        }\u003Cbr\u003E        foreach(var vessel in VesselsInCloseRange){\u003Cbr\u003E             Events.Add(new BaseEvent(Events, \u0022targetVessel\u0022\u002Bvessel.id, ()=\u0026gt;{\u003Cbr\u003E                 SetTarget(Vessel);\u003Cbr\u003E             }, new KSPEvent{ guiName = \u0022Target Vessel \u0022\u002Bvessel.name, guiActive = true });\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E    void Awake(){\u003Cbr\u003E        updateEvents();\u003Cbr\u003E    }\u003Cbr\u003E    void SetTarget(Vessel vessel){\u003Cbr\u003E        // ...\u003Cbr\u003E    }\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"}]}