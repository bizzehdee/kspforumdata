{"TopicId":135013,"ForumId":29,"TopicTitle":"Engine propellant switching","CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-26T18:33:32Z","PageNum":1,"Articles":[{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-26T18:33:32Z","Content":"\n\u003Cp\u003E\nI\u0027m working on a mod for engines. One basic function is supposed to be switching the propellant on an engine, like fuelswitch does for fueltanks. It is supposed to function as an alternative to the engine switch like on rapiers. I aim at integrating against tech level, and maybe inflight upgrading by EVA or something.\n\u003C/p\u003E\n\u003Cp\u003E\nNow, my current issue is, I cannot get the propellant switch to work. I can change the name of the propellant, but that does not change the propellant.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://drive.google.com/file/d/0B8MQtxvD6CVRTGRmOWtfUlNWcFU/view?usp=sharing\u0022 rel=\u0022external nofollow\u0022\u003EA copy of the full C# module in it\u0027s current state can be obtained here.\u003C/a\u003E\n\u003C/p\u003E\n\u003Cdiv class=\u0022ipsSpoiler\u0022 data-ipsspoiler=\u0022\u0022\u003E\n\u003Cdiv class=\u0022ipsSpoiler_header\u0022\u003E\n\u003Cspan\u003ESpoiler\u003C/span\u003E\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsSpoiler_contents\u0022\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\n\u003Cspan\u003E        private void assignPropToPart(bool calledByPlayer)\n        {\n            foreach (var moduleEngine in ModuleEngines)\n            {\n                foreach(var prop in moduleEngine.propellants)\n                {\n                    //Debug.Log(prop.id \u002B \u0022 / \u0022 \u002B prop.name \u002B \u0022 / \u0022 \u002B prop.ignoreForIsp \u002B \u0022 / \u0022);\n                    if (prop.name == \u0022LiquidFuel\u0022)\n                    {\n\n                    }\n                    else if (prop.name == \u0022IntakeAir\u0022)\n                    {\n                        prop.name = \u0022Oxidizer\u0022;\n                        //prop.id\n                        //[Log]: 374119730 / LiquidFuel / False /     \n                        //[Log]: -1909417378 / Oxidizer / True / \n                    }\n                }\n            }\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/div\u003E\n\u003Cp\u003E\nI think I need to change the \u0022.id\u0022 of the propellant to get the game to recognise the change. If this is what I need to do, then I do not know how to obtain the resource ID\u0027s other than through the error logs in KSP. I\u0027ve tried \u0022PartResourceLibrary.GetDefinition(string)\u0022 but I get an error I simply cannot figure out how to fix. --\u0026gt;\u00A0\u0022An object reference is required for the non-static field, method, or property \u0027PartResourceLibrary.GetDefinition(string)\u0027.\u0022\n\u003C/p\u003E\n\u003Cp\u003E\nI reality I would really like to be able to delete the old propellants and replace them by new ones.\n\u003C/p\u003E\n\u003Cp\u003E\nCan anyone help?\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"wasml","CreatedById":120438,"CreatedDateTime":"2016-03-26T18:51:53Z","Content":"\n\u003Cp\u003E\nTry PartResourceLibrary.Instance.GetDefinition(string) will get you the id - can\u0027t speak to your other question.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-03-26T18:56:17Z\u0022 title=\u002203/26/2016 06:56  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 26, 2016\u003C/time\u003E by wasml\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-26T18:59:45Z","Content":"\n\u003Cp\u003E\nThanks wasml, will try that!\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nEDIT:\n\u003C/p\u003E\n\u003Cp\u003E\nAfter testing I can say that\u00A0 \u003Cspan style=\u0022color:rgb(39,42,52);font-family:\u0027Helvetica Neue\u0027, Helvetica, Arial, sans-serif;font-size:14px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:22.4px;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;float:none;background-color:rgb(255,255,255);\u0022\u003EPartResourceLibrary.Instance.GetDefinition(string)\u003C/span\u003E \u00A0does give me access to the propellant (resource id), and can be changed. However, I still don\u0027t know how to delete existing ones. =\u0026gt; I stuck to the amount of propellents there are initially...\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-03-26T19:03:32Z\u0022 title=\u002203/26/2016 07:03  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 26, 2016\u003C/time\u003E by Warezcrawler\u003C/strong\u003E\n\u003Cbr\u003ETested Reply from wasml\n\u003C/span\u003E\n"},{"CreatedByName":"wasml","CreatedById":120438,"CreatedDateTime":"2016-03-26T19:32:39Z","Content":"\n\u003Cp\u003E\nI had something working previously (in the editor anyway) that went something like this:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E            part.Resources.list.Remove(oldResource);\n            cellResource = AddResourceToPart(part, newResource.name, newVolume);\n            part.Resources.UpdateList();\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nThere\u0027s some commented out code in that area so I I was working on it and don\u0027t remember if the above was the working code.\n\u003C/p\u003E\n"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2016-03-26T19:59:02Z","Content":"\n\u003Cp\u003E\nIt would be better to just make a ConfigNode, stick the new PROPELLANT nodes in it, and call the engine\u0027s OnLoad on the confignode.\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-26T21:29:12Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222474853\u0022 data-ipsquote-contentid=\u0022135013\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221459022342\u0022 data-ipsquote-userid=\u002275006\u0022 data-ipsquote-username=\u0022NathanKell\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, NathanKell said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nIt would be better to just make a ConfigNode, stick the new PROPELLANT nodes in it, and call the engine\u0027s OnLoad on the confignode.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nOK... Sorry but I\u0027ve never used ConfigNode before. So how does it work. How do if declare it correctly and find the node I wish to process, i.e. the part which have my module, and the player have just right clicked in order to do their thing?\n\u003C/p\u003E\n"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2016-03-26T21:58:13Z","Content":"\n\u003Cp\u003E\nConfigNode foo = new ConfigNode();\n\u003C/p\u003E\n\u003Cp\u003E\nConfigNode propNode = foo.AddNode(\u0022PROPELLANT\u0022);\n\u003C/p\u003E\n\u003Cp\u003E\npropNode.AddValue(\u0022name\u0022, \u0022LiquidFuel\u0022);\n\u003C/p\u003E\n\u003Cp\u003E\npropNode.AddValue(\u0022ratio\u0022, 0.9f);\n\u003C/p\u003E\n\u003Cp\u003E\n// do Ox too\n\u003C/p\u003E\n\u003Cp\u003E\nengineModule.Load(foo);\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-26T22:23:27Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222475013\u0022 data-ipsquote-contentid=\u0022135013\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221459029493\u0022 data-ipsquote-userid=\u002275006\u0022 data-ipsquote-username=\u0022NathanKell\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n20 minutes ago, NathanKell said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nConfigNode foo = new ConfigNode();\n\u003C/p\u003E\n\u003Cp\u003E\nConfigNode propNode = foo.AddNode(\u0022PROPELLANT\u0022);\n\u003C/p\u003E\n\u003Cp\u003E\npropNode.AddValue(\u0022name\u0022, \u0022LiquidFuel\u0022);\n\u003C/p\u003E\n\u003Cp\u003E\npropNode.AddValue(\u0022ratio\u0022, 0.9f);\n\u003C/p\u003E\n\u003Cp\u003E\n// do Ox too\n\u003C/p\u003E\n\u003Cp\u003E\nengineModule.Load(foo);\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThat\u0027s great. And my testing just showed that it does delete the old nodes for propellants at the same tid. It does not save with the game through. So am I forced to load the configuration of the engine each time the module loads?\n\u003C/p\u003E\n"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2016-03-26T22:46:49Z","Content":"\n\u003Cp\u003E\nYep, you are.\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-27T00:01:21Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222475081\u0022 data-ipsquote-contentid=\u0022135013\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221459032409\u0022 data-ipsquote-userid=\u002275006\u0022 data-ipsquote-username=\u0022NathanKell\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, NathanKell said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nYep, you are.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThank you so much. I\u0027ve used days on the web trying to figure this one out. I\u0027m not home yet, but this was a mayor help!\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-27T15:41:33Z","Content":"\n\u003Cp\u003E\nOK, next issue. When changing the propellants I want to activate drawgauge for the new propellant. Now this happens like this\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003EpropNode.AddValue(\u0022DrawGauge\u0022, true);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nHowever, KSP does not remove the gauge of past propellants like when using the engineswitch on the rapier. How do I get it to reset the gauges?\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve tried this before updating the propellants, but it doesn\u0027t have an effect.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003Eforeach (var localPropellant in moduleEngine.propellants)\n{\n\tlocalPropellant.drawStackGauge = false;\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nIf I quicksave and reload, the gauges are perfectly aligned to the propellant setup. So I figure it just a matter of forcing KSP to update the gauges.\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-03-27T18:58:01Z","Content":"\n\u003Cp\u003E\nAnother issue I\u0027ve run into. Since changing propellant should change ISP (atmCurve and velCurve) as well, I figured I\u0027d replace these as well. So I have these defined in my module as they are defined in the engine module.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003EMODULE\n{\n  name = EngineClassSwitch\n  //engineID = \u0022NOT IMPLEMENTED\u0022\n  //engineNames = \u0022NOT IMPLEMENTED\u0022\n  propellantNames = LiquidFuel;LiquidFuel,Oxidizer;MonoPropellant\n  propellantRatios = 100;45,55;100\n  propellantIgnoreForIsp = false;false,false;false\t\t\t//default = false\n  stagingEnabled = false\n  availableInFlight = false\n  availableInEditor = true\n  velCurve\n  {\n    key = 0 1 0 0.08333334\n    key = 1 0.98 0.42074 0.42074\n  }\n  atmCurve\n  {\n    key = 0 0 0 0\n    key = 1 1 7.914787 7.914787\n  }\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nThe value in the curves are just for testing. Now I need to load them, and I currently do that like this\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E        [KSPField]\n        public FloatCurve[] velCurve;\n        [KSPField]\n        public FloatCurve[] atmCurve;\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nI\u0027m not sure that is correct. Next I need to transfer these curves into the engine when I change the propellant. I just can\u0027t figure out how to manipulate those curves. I\u0027ve tried ConfigNode, but they did not seem to update like the propellant.\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve tried something like this, but it does \u003Cu\u003E\u003Cstrong\u003ENOT\u003C/strong\u003E\u003C/u\u003E work.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003Eforeach (var moduleEngine in ModuleEngines)\n{\n    //moduleEngine.velCurve = velCurve;\n    Debug.LogError(\u0022moduleEngine.velCurve.ToString \u0022 \u002B moduleEngine.velCurve.ToString());\n    Debug.LogError(\u0022moduleEngine.atmCurve.ToString \u0022 \u002B moduleEngine.atmCurve.ToString());\n\n    //moduleEngine.velCurve.Curve.\n    int i = 0;\n    foreach(var key in moduleEngine.velCurve.Curve.keys)\n    {\n        Debug.LogError(\u0022Key[\u0022 \u002B i \u002B \u0022]: \u0022 \u002B key.time \u002B \u0022 \u0022 \u002B key.value \u002B \u0022 \u0022 \u002B key.inTangent \u002B \u0022 \u0022 \u002B key.outTangent);\n        i\u002B\u002B;\n    }\n    //moduleEngine.velCurve.Curve.AddKey(0, 1, 0, 0);\n    //moduleEngine.atmCurve = atmCurve;\n\n    ConfigNode newVelCurveNode = new ConfigNode();\n    ConfigNode Node = newVelCurveNode.AddNode(\u0022velCurve\u0022);\n    Node.AddValue(\u0022key\u0022, \u00220 1 1 1\u0022);\n    Node.AddValue(\u0022key\u0022, \u00220.2 0.98 2 2\u0022);\n    moduleEngine.Load(Node);\n    i = 0;\n    foreach (var key in moduleEngine.velCurve.Curve.keys)\n    {\n        Debug.LogError(\u0022Key[\u0022 \u002B i \u002B \u0022]: \u0022 \u002B key.time \u002B \u0022 \u0022 \u002B key.value \u002B \u0022 \u0022 \u002B key.inTangent \u002B \u0022 \u0022 \u002B key.outTangent);\n        i\u002B\u002B;\n    }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nI hope someone out there can help me figure this thing out....\n\u003C/p\u003E\n"}]}