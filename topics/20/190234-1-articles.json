{"TopicId":190234,"ForumId":20,"TopicTitle":"The Trouble with the Unity upgrade","CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2019-12-08T03:29:36Z","PageNum":1,"Articles":[{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2019-12-08T03:29:36Z","Content":"\n\u003Cp\u003E\nI\u0027ve been working my way through all my mods, and was pretty happy with the way things were going. \u00A0I had actually finished updating all the code-based mods and was proceeding on the Part-only mods, when a bug report made me aware of a significant issue with a few mods. \u00A0So I went ahead and built a full debugging environment, loaded up my new career game and took a look at the log file.\n\u003C/p\u003E\n\u003Cp\u003E\nInitially I thought it was just a bug, but then I found the same problem in 4 mods which were not mine, and 3 of mine, so I knew there was something pervasive and started to look.\u00A0 Then I started realizing that there had been various reports of KSP just hanging, just before it got to the main menu.\n\u003C/p\u003E\n\u003Cp\u003E\nAs I started looking into this, I found that my new career install was hanging about 3/4 of the time before the main menu, but when I removed the bad mods (at the time, a total of 7 in a 150 mod install), the hangs disappeared.\u00A0 \u00A0I realized I was onto something rather big.\n\u003C/p\u003E\n\u003Cp\u003E\nThese were errors which weren\u0027t showing up in the regular log file, I needed to be running a debug version to see the errors; the debug version is much more verbose in logging.\n\u003C/p\u003E\n\u003Cp\u003E\nWhat I found was that as a result of the Unity upgrade, a lot of what used to be acceptable coding was no longer acceptable. \u00A0Actually, in one sense the coding never should have been considered acceptable, but it worked, so was never an issue until now.\n\u003C/p\u003E\n\u003Cp\u003E\nI broke the issues down into the following categories:\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nUnityException: get_dataPath is not allowed to be called from a MonoBehaviour constructor (or instance field initializer), call it in Awake or Start instead.\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp style=\u0022margin-left:80px;\u0022\u003E\nA somewhat misleading description, most often caused by trying to reference \u003Cstrong\u003EKSPUtil.ApplicationRootPath\u003C/strong\u003E in either a constructor or as a property in a MonoBehaviour class\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nUnityException: RandomRangeInt is not allowed to be called from a MonoBehaviour constructor (or instance field initializer), call it in Awake or Start instead.\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp style=\u0022margin-left:80px;\u0022\u003E\nThis happened a few times, \u003Cstrong\u003ERandomRangeInt \u003C/strong\u003Ewas being called in either a constructor or as a property in a MonoBehaviour class\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nUnityException: SupportsTextureFormatNative is not allowed to be called from a MonoBehaviour constructor (or instance field initializer), call it in Awake or Start instead.\u00A0\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp style=\u0022margin-left:80px;\u0022\u003E\nVery obscure, took a while to track down. \u00A0A \u003Cstrong\u003ETexture2D \u003C/strong\u003Eor \u003Cstrong\u003ETexture3D \u003C/strong\u003Ewas being initialized in either a constructor or as a property in a MonoBehaviour class\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nException loading ScenarioModule *********** System.TypeInitializationException: The type initializer for *********.********* threw an exception. ---\u0026gt; UnityEngine.UnityException: get_dataPath is not allowed to be called from a MonoBehaviour constructor (or instance field initializer), call it in Awake or Start instead. Called from MonoBehaviour ********** on game object \u0027ScenarioLogic\u0027.\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp style=\u0022margin-left:80px;\u0022\u003E\nA very obscure message. \u00A0Turned out that the original mod was written as a ScenarioModule and worked well, but in the updated game it seems that things which were being done inside the ScenarioModule which should have been in a MonoBehaviour were causing problems.\u00A0 The symptom of this was getting null refs when attempting to enter some or all of the buildings at the \u003Cabbr title=\u0022Kerbal Space Center\u0022\u003EKSC\u003C/abbr\u003E\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nUnity not being thread safe\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp style=\u0022margin-left:80px;\u0022\u003E\nThis was a problem with the KSP-AVC and MiniAVC mods.\u00A0 I had seen a couple of messages about MiniAVC not working, and was planning on getting to it when finished with all the updates.\u00A0\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nTracking these issues down in over 160 mods, written by at a guess of over 100 authors, turned out to be a major timesink.\u00A0 As of now I\u0027m pretty sure I\u0027ve caught most if not all of these issues in my mods.\u00A0 In total about 30 of my mods, both adopted and ones that I write, were affected.\u00A0 I also did some work on other author\u0027s mods to fix the issues and have submitted PRs (fixes) to all of those authors.\u00A0\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nPlease note that while I listed the majority of the issues above, I think there were a few which I fixed which were mostly one-offs.\n\u003C/p\u003E\n\u003Cp\u003E\nThe main reason this happened now was as a result of the Unity upgrade.\u00A0 The new version of Unity fixed a lot of bugs as well as adding significant performance improvements.\u00A0 Many of the issues I found and corrected were actually poor coding practice, but was accepted because Unity allowed it.\u00A0 There were times in the previous version of Unity that KSP used that these issues arose, but that was in some very limited and specific instances.\n\u003C/p\u003E\n\u003Cp\u003E\nFor myself, everytime I adopt a new mod moving forward, I\u0027ll be testing it in a debug install to catch any issues before it gets released.\n\u003C/p\u003E\n"},{"CreatedByName":"Arco123","CreatedById":201477,"CreatedDateTime":"2019-12-08T03:50:42Z","Content":"\n\u003Cp\u003E\nI also got the 2d bug as well when trying (Still trying)\u00A0to find out what mod caused all the lag with solar panels and not producing power.\n\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2019-12-08T05:19:34Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223714725\u0022 data-ipsquote-contentid=\u0022190234\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221575777042\u0022 data-ipsquote-userid=\u0022201477\u0022 data-ipsquote-username=\u0022Arco123\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, Arco123 said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI also got the 2d bug as well when trying (Still trying)\u00A0to find out what mod caused all the lag with solar panels and not producing power.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nPost a list of your mods, if you have a .\u003Cabbr title=\u0022Comprehensive Kerbal Archive Network (a KSP mod manager)\u0022\u003Eckan\u003C/abbr\u003E file that would be better\n\u003C/p\u003E\n"},{"CreatedByName":"Lisias","CreatedById":187168,"CreatedDateTime":"2019-12-08T10:17:40Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223714719\u0022 data-ipsquote-contentid=\u0022190234\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221575775776\u0022 data-ipsquote-userid=\u0022129964\u0022 data-ipsquote-username=\u0022linuxgurugamer\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n10 hours ago, linuxgurugamer said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cul\u003E\u003Cli\u003E\nUnity not being thread safe\n\u003C/li\u003E\n\u003C/ul\u003E\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI\u0027m still trying to understand this behaviour, but my tests apparently tells me that is not exactly \u0022threading safe\u0022 issues, but \u0022threading bounds violations\u0022 issues.\n\u003C/p\u003E\n\u003Cp\u003E\nA long time ago, in a galaxy far, far away \u003Cspan\u003E\u003Cimg alt=\u0022:P\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 title=\u0022:P\u0022\u003E\u003C/span\u003E\u00A0I was programming in Symbian (and late for Bada\u2026 urk..), and these guys had a problem - the thread used for instancing your program was not the thread used to run your objects. So you could not make some calls (in special, memory allocation, as your heap and stack was not created yet, as your running thread was not created yet!) on the object constructor. So they created a hook called \u0022Create\u0022 (if memory serves me well) where you should put any initialization code that would need using a stack and/or heap - as system calls). You could initialize variables and static memory on the Constructor, however.\n\u003C/p\u003E\n\u003Cp\u003E\nThis is interestingly similar to the Awake stunt.\n\u003C/p\u003E\n\u003Cp\u003E\nOn Android, at least on the 2.3 times (and later on 4.x, the latest one I messed with), we had another restriction (Java2ME programmers also had it - yeah, I\u0027m that old!): you could not make calls or update UI objects outside the UI thread. This is how they prevented to have to\u00A0shove mutexes on the UI objects, what would make the UI somewhat cranky to the\u00A0user. So, if you would need to create threads to do some grunt work (and we always had to create threads to do grunt work, otherwise that work would be executed on the UI\u0027s thread, and again you would have a cranky UI), any update to the UI needed by that thread of\u00A0yours would need\u00A0to be inside a Runnable and then inserted into a queue loop, that the UI thread would periodically flush. So, yeah, asynchronous UI updates for you every time you would need to do some I/O or heavy computation. \u003Cem\u003E[ If you needed to be sure the current thread would continue only after the UI is updated,\u00A0\u003Cstrong\u003Eyou\u003C/strong\u003E\u00A0had to create a mutex, shove the Runnable on the queue (with code to free the mutex on a\u00A0\u003Cstrong\u003Efinally\u003C/strong\u003E\u00A0- to prevent deadlocks), and then lock on the mutex. Somewhat messy sometimes, but it did had the work done. ]\u003C/em\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nIt\u0027s my understanding that Unity (or at least KSP) is/are exploring multiple threads\u00A0since KSP 1.4, and so apparently different hooks are being called from different threads, and so your code would be using different stacks depending of who is calling your hook.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222019-12-08T13:43:00Z\u0022 title=\u002212/08/2019 01:43  PM\u0022 data-short=\u00224 yr\u0022\u003EDecember 8, 2019\u003C/time\u003E by Lisias\u003C/strong\u003E\n\u003Cbr\u003Etyops as usulla\u2026 (and a small addendum)\n\u003C/span\u003E\n"},{"CreatedByName":"nwillard","CreatedById":197319,"CreatedDateTime":"2019-12-08T10:20:46Z","Content":"\n\u003Cp\u003E\nWow linuxgurugamer, you\u0027re like, a real-life superhero.\n\u003C/p\u003E\n"},{"CreatedByName":"Arco123","CreatedById":201477,"CreatedDateTime":"2019-12-08T15:11:43Z","Content":"\n\u003Cp\u003E\nIma post a list of them along with the log. A couple pics as well. I\u0027m away from my pc so I cant right now. But is there anything else that you need? I\u0027m thinking it\u0027s koperous or planet shine but Planet shine has already been tested. I do have 57 mods...\n\u003C/p\u003E\n\u003Cp\u003E\nAlso, where\u0027s the .\u003Cabbr title=\u0022Comprehensive Kerbal Archive Network (a KSP mod manager)\u0022\u003ECKAN\u003C/abbr\u003E file... I just got it.\n\u003C/p\u003E\u003Cp\u003E\nAlso, the bug is like this. Whenever I extend some solar panels (Any kind. Only ones that ARE solar.) or all of them. My frame rate drops to well below 10 fps. About 5-7. I click on them and they aren\u0027t producing power. Even when in space and pointed at the sun. So, I checked the console to find some red message spamming it. (I\u0027ll post that soon.) Whenever I retract them it stops and doesn\u0027t occur. But if I extend them... (It happens...)\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nAlso, it happens randomly without extending them even if you don\u0027t have any.\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222019-12-08T15:13:40Z\u0022 title=\u002212/08/2019 03:13  PM\u0022 data-short=\u00224 yr\u0022\u003EDecember 8, 2019\u003C/time\u003E by Arco123\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Stone Blue","CreatedById":77721,"CreatedDateTime":"2019-12-08T15:44:31Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223714898\u0022 data-ipsquote-contentid=\u0022190234\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221575817903\u0022 data-ipsquote-userid=\u0022201477\u0022 data-ipsquote-username=\u0022Arco123\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n31 minutes ago, Arco123 said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\n\u00A0I\u0027m thinking it\u0027s koperous\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI hope you dont mean Kopernicus... That mod has not been updated for 1.8.\u002B, which means *any* planet, system, or other mod that depends on it will not work in 1.8.\u002B, and most likely cause ALL kinds of issues... Thats why Kop is version locked: because it can wreak havoc in an incompatable KSP version install\u003Cbr\u003E\u003Cbr\u003E\nPlus, i vaguely remember some mod cauisng that solar panel issue, and I also seem to feel like it it *was* a Kopernicus issue? vOv\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222019-12-08T15:45:40Z\u0022 title=\u002212/08/2019 03:45  PM\u0022 data-short=\u00224 yr\u0022\u003EDecember 8, 2019\u003C/time\u003E by Stone Blue\u003C/strong\u003E\n\u003C/span\u003E\n"}]}