{"TopicId":24163,"ForumId":36,"TopicTitle":"Getting distance to the terrain from a ship\u0026#039;s coordinates. Help!","CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T07:20:42Z","PageNum":1,"Articles":[{"CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T07:20:42Z","Content":"\n\u003Cp\u003EI\u0027ve been playing with various bits of information available during flight, but nothing seems to give very conclusive or consistent results (or behavior; one seems to stick to the value of -1 after fluctuating wildly during launch).\u003C/p\u003E\u003Cp\u003EI have no idea how I should go about doing this.\u003C/p\u003E\n"},{"CreatedByName":"TheCardinal","CreatedById":22874,"CreatedDateTime":"2013-04-26T09:02:34Z","Content":"\n\u003Cp\u003EWhat are you trying to determine, (true) altititude or what?\u003C/p\u003E\n"},{"CreatedByName":"shand","CreatedById":57781,"CreatedDateTime":"2013-04-26T09:33:48Z","Content":"\n\u003Cp\u003Ewhat information source you using? in game only altitude from sea level is avalible i think. use kerbal engineer redux or mechjeb (personally i prefer redux for data).\u003C/p\u003E\n"},{"CreatedByName":"Tetriswizard","CreatedById":19871,"CreatedDateTime":"2013-04-26T09:55:34Z","Content":"\n\u003Cp\u003ETake a look at this image I just created.\u003C/p\u003E\u003Cp\u003E\u003Cimg src=\u0022http://i.imgur.com/qDPHKv0.png\u0022 alt=\u0022qDPHKv0.png\u0022\u003E\u003C/p\u003E\u003Cp\u003EIn this instance, let\u0027s assume:\u003C/p\u003E\u003Cp\u003E- That you are at A\u003C/p\u003E\u003Cp\u003E- You want to be at C\u003C/p\u003E\u003Cp\u003E- Up is the Y Axis\u003C/p\u003E\u003Cp\u003ENow that we have assumed those things, lets clear some other things up.\u003C/p\u003E\u003Cp\u003E- L, W, and H are the distance between your targets X, Y and Z co-ords\u003C/p\u003E\u003Cp\u003E- a is the distance between You/A and the air above C, which is also the same as your Up/Y co-ords\u003C/p\u003E\u003Cp\u003E- b is the distance between You/A and your target\u003C/p\u003E\u003Cp\u003EUse Pythagorean formula to find a, using the forward and sideways co-ords\u003C/p\u003E\u003Cp\u003Ea = sqr[ (L*L) \u002B (W*W) ]\u003C/p\u003E\u003Cp\u003EWith sqr representing Square Root.\u003C/p\u003E\u003Cp\u003ENow you have the distance from your co-ords to the Up/Y co-ords above your target, C.\u003C/p\u003E\u003Cp\u003ESince we have a, we can now move on to the grey plane. The grey plane is neither the Sideway/X, Up/Y, or Forward/Z planes, but a mixture of the three, with the Up/Y plane being the major one.\u003C/p\u003E\u003Cp\u003EAnother thing to note is that we want to find c, which is the distance between A and C.\u003C/p\u003E\u003Cp\u003EThis is easy, as it is just another Pythagorean formula.\u003C/p\u003E\u003Cp\u003Ec = sqr[ (a*a) \u002B (b*\u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_cool.png\u0022 alt=\u0022B)\u0022\u003E ]\u003C/p\u003E\u003Cp\u003EAfter going through with that formula, you will have c. c is the distance between You/A and Your Target/C\u003C/p\u003E\u003Cp\u003EI hope this helped, and if anyone sees anything wrong with this, tell me. I\u0027m just going by memory.\u003C/p\u003E\n"},{"CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T10:11:52Z","Content":"\n\u003Cp\u003EI\u0027m looking for a way to determine the exact distance between me and a planet\u0027s collision mesh so I\u0027m not taken by surprise when I crash into it. Distance to the ground itself, not the altitude reading.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222013-04-26T10:16:07Z\u0022 title=\u002204/26/2013 10:16  AM\u0022 data-short=\u002211 yr\u0022\u003EApril 26, 2013\u003C/time\u003E by ummwut\u003C/strong\u003E\n\u003Cbr\u003EBecause.\n\u003C/span\u003E\n"},{"CreatedByName":"shand","CreatedById":57781,"CreatedDateTime":"2013-04-26T10:20:41Z","Content":"\n\u003Cp\u003Eah ok, so mechjeb or engineer redux are the only two methods i can think of without using the tuna can (2 man lander has radar alt.)\u003C/p\u003E\n"},{"CreatedByName":"Tetriswizard","CreatedById":19871,"CreatedDateTime":"2013-04-26T10:24:35Z","Content":"\n\u003Cp\u003EThis isn\u0027t for an altitude reading, this is for the distance between your X, Y and Z co-ordinates, and the X, Y and Z co-ordinates you designate\u003C/p\u003E\n"},{"CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T10:28:20Z","Content":"\n\u003Cp\u003E@tetriswizard: I know. Relax. It wouldn\u0027t be hard to extend it to 4-D or 5-D or 5.2-D either. I didn\u0027t major in math for nothing \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 alt=\u0022:P\u0022\u003E\u003C/p\u003E\u003Cp\u003E@shand: I guess I\u0027ll have to crawl through the source for Engineer Redux to get answers, something I hope I didn\u0027t need to do, as I fully expected a simple solution. Oh well!\u003C/p\u003E\n"},{"CreatedByName":"Michael Kim","CreatedById":38782,"CreatedDateTime":"2013-04-26T10:30:10Z","Content":"\n\u003Cp\u003EShare some of my code here, which you can also find in \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/showthread.php/24678\u0022 rel=\u0022external nofollow\u0022\u003EHydroTech RCS Autopilot\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EMethod #1: Physics contact, i.e. go down from a point and see how far it can go until hitting the ground\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E        protected bool PhysicsContactMethod(\u003Cbr\u003E            Vector3 origin,\u003Cbr\u003E            Vector3 direction,\u003Cbr\u003E            float maxDistance, // the max distance of detection, to pass into Physics.Raycast\u003Cbr\u003E            out float result\u003Cbr\u003E            )\u003Cbr\u003E        {\u003Cbr\u003E            RaycastHit sfc;\u003Cbr\u003E            if (Physics.Raycast(origin, direction, out sfc, maxDistance, 1 \u0026lt;\u0026lt; 15))\u003Cbr\u003E            {\u003Cbr\u003E                result = sfc.distance;\u003Cbr\u003E                return true;\u003Cbr\u003E            }\u003Cbr\u003E            else\u003Cbr\u003E            {\u003Cbr\u003E                result = 0.0F;\u003Cbr\u003E                return false;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EMethod #2: Load main body terrain information and get terrain height of given latitude/longitude\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E        protected bool MainBodyTerrainMethod(Vector3 origin, out float result)\u003Cbr\u003E        {\u003Cbr\u003E            if (MainBody.pqsController != null)\u003Cbr\u003E            {\u003Cbr\u003E                result = (float)(\u003Cbr\u003E                    altASL - (MainBody.pqsController.GetSurfaceHeight(\u003Cbr\u003E                        QuaternionD.AngleAxis(MainBody.GetLongitude(origin), Vector3d.down)\u003Cbr\u003E                            * QuaternionD.AngleAxis(MainBody.GetLatitude(origin),\u003Cbr\u003E                        Vector3d.forward) * Vector3d.right\u003Cbr\u003E                        ) - MainBody.pqsController.radius)\u003Cbr\u003E                    );\u003Cbr\u003E                return true;\u003Cbr\u003E            }\u003Cbr\u003E            else\u003Cbr\u003E            {\u003Cbr\u003E                result = 0.0F;\u003Cbr\u003E                return false;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Ewhere\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003EaltASL = (float)MainBody.GetAltitude(origin);\u003Cbr\u003E/* EDIT: forgot this */ CelestialBody MainBody { get { return FlightGlobals.ActiveVessel.mainBody; } }\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EAlso, if you want the true altitude (distance to terrain OR sea), make sure to pick the smaller one.\u003C/p\u003E\u003Cp\u003EBTW, MechJeb has done almost everything, and its code is available online, so it\u0027s a good idea to learn things from it if you\u0027re new.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222013-04-26T10:33:16Z\u0022 title=\u002204/26/2013 10:33  AM\u0022 data-short=\u002211 yr\u0022\u003EApril 26, 2013\u003C/time\u003E by Michael Kim\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-04-26T13:08:50Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022ummwut\u0022 data-cite=\u0022ummwut\u0022\u003E\u003Cdiv\u003EI fully expected a simple solution. Oh well!\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHeight above terrain is easy enough, it\u0027s vessel.heightFromTerrain. If you want your height about your predicated landing spot the difficult bit is predicting it - especially with atmosphere. Once you have it then you can use GetSurfaceHeight.\u003C/p\u003E\u003Cp\u003EI believe Mechjeb\u0027s landing autopilot does landing predictions, so that\u0027s probably the code to look at.\u003C/p\u003E\n"},{"CreatedByName":"Michael Kim","CreatedById":38782,"CreatedDateTime":"2013-04-26T14:02:03Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022EndlessWaves\u0022 data-cite=\u0022EndlessWaves\u0022\u003E\u003Cdiv\u003EHeight above terrain is easy enough, it\u0027s vessel.heightFromTerrain.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EIt doesn\u0027t work when the vessel is high above the surface. I did look at MechJeb, and what it does is exactly using the two methods I listed above (or more precisely speaking, I learned them from MechJeb but wrote the code in my own way). Don\u0027t use heightFromTerrain when in orbit, seriously.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222013-04-26T14:04:50Z\u0022 title=\u002204/26/2013 02:04  PM\u0022 data-short=\u002211 yr\u0022\u003EApril 26, 2013\u003C/time\u003E by Michael Kim\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-04-26T14:35:52Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Michael Kim\u0022 data-cite=\u0022Michael Kim\u0022\u003E\u003Cdiv\u003EIt doesn\u0027t work when the vessel is high above the surface. \u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EWell no, it obviously won\u0027t work when there\u0027s no terrain loaded below you. I\u0027m slightly surprised it doesn\u0027t fall back to height from surface automatically but it should be easy to do it manually if it does give junk data.\u003C/p\u003E\n"},{"CreatedByName":"Michael Kim","CreatedById":38782,"CreatedDateTime":"2013-04-26T15:22:23Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022EndlessWaves\u0022 data-cite=\u0022EndlessWaves\u0022\u003E\u003Cdiv\u003EWell no, it obviously won\u0027t work when there\u0027s no terrain loaded below you. I\u0027m slightly surprised it doesn\u0027t fall back to height from surface automatically but it should be easy to do it manually if it does give junk data.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EWell anyway MechJeb doesn\u0027t use it. I\u0027m not saying MechJeb is god here, but at least it means heightFromTerrain is not the best choice.\u003C/p\u003E\n"},{"CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T15:24:00Z","Content":"\n\u003Cp\u003E@Michael Kim: Can you go through the first PHP code box and tell me about what each item is and what it\u0027s doing? There\u0027s very little documentation on the Assembly-CSharp library.\u003C/p\u003E\u003Cp\u003EAlso, HeightFromTerrain and HeightFromSurface do not work. Or if they do, their output is indecipherable to me.\u003C/p\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-04-26T15:36:16Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022ummwut\u0022 data-cite=\u0022ummwut\u0022\u003E\u003Cdiv\u003E@Michael Kim: Can you go through the first PHP code box and tell me about what each item is and what it\u0027s doing? There\u0027s very little documentation on the Assembly-CSharp library.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EPhysics.Raycast is a unity function, not a KSP one:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://docs.unity3d.com/Documentation/ScriptReference/Physics.Raycast.html\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://docs.unity3d.com/Documentation/ScriptReference/Physics.Raycast.html\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EAll it\u0027s doing is hitting the first collision box along the distance vector specified. It\u0027s likely to return no hit or the spherical surface if you\u0027re too far away for the terrain to load. \u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022ummwut\u0022 data-cite=\u0022ummwut\u0022\u003E\u003Cdiv\u003E\u003Cp\u003EAlso, HeightFromTerrain and HeightFromSurface do not work. Or if they do, their output is indecipherable to me.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI haven\u0027t used them recently but I\u0027d expect to get height in meters. What values are you getting?\u003C/p\u003E\n"},{"CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T15:45:45Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022EndlessWaves\u0022 data-cite=\u0022EndlessWaves\u0022\u003E\u003Cdiv\u003EPhysics.Raycast is a unity function, not a KSP one:\u003Cp\u003E\u003Ca href=\u0022http://docs.unity3d.com/Documentation/ScriptReference/Physics.Raycast.html\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://docs.unity3d.com/Documentation/ScriptReference/Physics.Raycast.html\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EAll it\u0027s doing is hitting the first collision box along the distance vector specified. It\u0027s likely to return no hit or the spherical surface if you\u0027re too far away for the terrain to load. \u003C/p\u003E\u003Cp\u003EI haven\u0027t used them recently but I\u0027d expect to get height in meters. What values are you getting?\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ERaycast I understand; it\u0027s pretty straightforward.\u003C/p\u003E\u003Cp\u003EHFT and HFS both give a value of -1 above 20k meters, but below that, HeightFromTerrain gives what I assume is exactly what it says on the tin, in meters.\u003C/p\u003E\u003Cp\u003EFor CelestialBody, what\u0027s SurfaceNVector? I assume it\u0027s a point tangent to the terrain pointing north, but does it assume the Body is a perfect sphere?\u003C/p\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-04-26T15:56:48Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022ummwut\u0022 data-cite=\u0022ummwut\u0022\u003E\u003Cdiv\u003EHFT and HFS both give a value of -1 above 20k meters, but below that, HeightFromTerrain gives what I assume is exactly what it says on the tin, in meters.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHFS isn\u0027t the altitude reading? Just use something like\u003C/p\u003E\u003Cp\u003E(this.transform.position - body.transform.position).magnitude - body.radius\u003C/p\u003E\u003Cp\u003Ewhen HFT is returning -1.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022ummwut\u0022 data-cite=\u0022ummwut\u0022\u003E\u003Cdiv\u003E\u003Cp\u003EFor CelestialBody, what\u0027s SurfaceNVector? I assume it\u0027s a point tangent to the terrain pointing north, but does it assume the Body is a perfect sphere?\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI\u0027d assumed it was a normal vector. It does seem to go by a perfect sphere though.\u003C/p\u003E\n"},{"CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T16:00:37Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022EndlessWaves\u0022 data-cite=\u0022EndlessWaves\u0022\u003E\u003Cdiv\u003E\u003Cp\u003E(this.transform.position - body.transform.position).magnitude - body.radius\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EWhat is transform and what is this doing? I\u0027m really not familiar with game programming or 3D calculations.\u003C/p\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-04-26T17:32:44Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022ummwut\u0022 data-cite=\u0022ummwut\u0022\u003E\u003Cdiv\u003EWhat is transform and what is this doing? I\u0027m really not familiar with game programming or 3D calculations.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EEvery GameObject has a Transform component attached to it, this holds the position, rotation and scale of the object. In this case we\u0027re grabbing the position.\u003C/p\u003E\u003Cp\u003EThe line as a whole subtracts the position of the vessel from the position of the centre of the planet, which gives you the vector between planet and vessel. It then takes the length of this vector (aka distance from vessel to center of planet) and subtracts the radius of the planet giving you the distance to the mean level.\u003C/p\u003E\n"},{"CreatedByName":"ummwut","CreatedById":29846,"CreatedDateTime":"2013-04-26T23:45:37Z","Content":"\n\u003Cp\u003EAh! That makes sense.\u003C/p\u003E\n"}]}