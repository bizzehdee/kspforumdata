{"TopicId":200860,"ForumId":29,"TopicTitle":"Probable Quaternion question re. Navball and where ship is pointing","CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2021-03-09T03:50:47Z","PageNum":1,"Articles":[{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2021-03-09T03:50:47Z","Content":"\n\u003Cp\u003E\nI need to be able to know how far off a vessel is pointing from what one of the modes (selectable).\u00A0 For example, I would need to know how far off a vessel is from pointing Prograde, and also, would be nice to be able to get the rate at which the vessel is changing orientation.\n\u003C/p\u003E\n\u003Cp\u003E\nI believe this would need Quaternions, which I really don\u0027t understand \u003Cspan\u003E:-(\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan\u003EGood news (for me) is that I just need to know how far off it is, doesn\u0027t really matter which direction it is off in.\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan\u003EAny help would be appreciated.\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan\u003EI found this code, which I think may be part of what\u0027s needed.\u00A0 It seems to get the angles for pitch, yaw and roll of the vessel, I believe that if I can get the same for the desired direction, then it\u0027s a simple matter of subtraction.\u003C/span\u003E\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003Eprivate Quaternion updateHeadingPitchRollField (Vessel v)\n{\n    Vector3d CoM, north, up;\n    Quaternion rotationSurface;\n    CoM = v.CoM;\n    up = (CoM - v.mainBody.position).normalized;\n    north = Vector3d.Exclude(up, (v.mainBody.position \u002B v.mainBody.transform.up * (float)v.mainBody.Radius) - CoM).normalized;\n    rotationSurface = Quaternion.LookRotation(north, up);\n    return Quaternion.Inverse(Quaternion.Euler(90, 0, 0) * Quaternion.Inverse(v.GetTransform().rotation) * rotationSurface);\n}\n\nQuaternion attitude = updateHeadingPitchRollField(ActiveVessel);\n\nfloat pitch = (float) ((attitude.eulerAngles.x \u0026gt; 180) ? (360.0 - attitude.eulerAngles.x) : -attitude.eulerAngles.x);\nfloat yaw = (float) attitude.eulerAngles.y;\nfloat roll = (float) ((attitude.eulerAngles.z \u0026gt; 180) ? (attitude.eulerAngles.z - 360.0) : attitude.eulerAngles.z);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"ValiZockt","CreatedById":197053,"CreatedDateTime":"2021-03-09T10:21:31Z","Content":"\n\u003Cp\u003E\nDo you need them separated in pitch, yaw, roll? If not you can simply use Vector3.Angle:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003EVector3 currentOrientation = vessel.referenceTransform.up //up is foward\nVector3 targetOrientation //your desired direction\nfloat angle = Vector3.Angle(currentOrientation, targetOrientation)\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nIf you want to know how much your translating (or rotating)\u00A0in each direction you can use vessel.angularVelocity\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222021-03-09T10:21:43Z\u0022 title=\u002203/09/2021 10:21  AM\u0022 data-short=\u00223 yr\u0022\u003EMarch 9, 2021\u003C/time\u003E by ValiZockt\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2021-03-09T14:01:52Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223937839\u0022 data-ipsquote-contentid=\u0022200860\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221615285291\u0022 data-ipsquote-userid=\u0022197053\u0022 data-ipsquote-username=\u0022ValiZockt\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n4 hours ago, ValiZockt said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nDo you need them separated in pitch, yaw, roll? If not you can simply use Vector3.Angle:\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nVery helpful, thanks\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223937839\u0022 data-ipsquote-contentid=\u0022200860\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221615285291\u0022 data-ipsquote-userid=\u0022197053\u0022 data-ipsquote-username=\u0022ValiZockt\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n4 hours ago, ValiZockt said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nVector3 targetOrientation //your desired direction\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nSo all I need (for now) is to get the correct targetOrientation for each of the various autopilot modes, \u003Cs\u003Eincluding a maneuver node\u003C/s\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cs\u003EI got the maneuver node angle working.\u003C/s\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cs\u003ERegarding the Vector3.Angle, it\u0027s not obvious whether the vessel is pointing close to the node or in the opposite direction.\u00A0 I think I can live without it, but would like to know if there was a way to get a full 0 (pointing straight at th etarget orientation) to 180 (pointing away from the target orientation)\u003C/s\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nI though I had it working, but it\u0027s not perfect.\u00A0 This seems to be somewhat working:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E                Vector3 currentOrientation = FlightGlobals.ActiveVessel.ReferenceTransform.up; //up is foward\n                Vector3 targetOrientation = //your desired direction\n                        manNode.nodeRotation.eulerAngles;\n\n                manNode.nodeRotation.ToAngleAxis(out float angle2, out targetOrientation);\n\n                float angle = Vector3.Angle(currentOrientation, targetOrientation);\n                GUILayout.Label(\u0022Angle to  node: \u0022);\n                GUILayout.TextField(angle.ToString(\u0022F2\u0022));\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nWhen pointing to the maneuver node, the angle is 90.\n\u003C/p\u003E\n\u003Cp\u003E\nwhen pointing directly away from the maneuver node, the angle is 90\n\u003C/p\u003E\n\u003Cp\u003E\nAnywhere else, it\u0027s very odd and not consistent\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222021-03-09T14:47:10Z\u0022 title=\u002203/09/2021 02:47  PM\u0022 data-short=\u00223 yr\u0022\u003EMarch 9, 2021\u003C/time\u003E by linuxgurugamer\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"ValiZockt","CreatedById":197053,"CreatedDateTime":"2021-03-09T18:56:43Z","Content":"\n\u003Cp\u003E\nmanNode.nodeRotation.eulerAngles is a rotation, not a direction. Use manNode.GetBurnVector(vessel.orbit);\n\u003C/p\u003E\n\u003Cp\u003E\nVector3.Angle is an absolute value, but you can calculate the polarity by using the cross product of both vectors and invert the angle if\u00A0y is negative\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003EVector3 currentOrientation = FlightGlobals.ActiveVessel.ReferenceTransform.up; //up is foward\nVector3 targetOrientation = manNode.GetBurnVector(vessel.orbit);\n\nfloat angle = Vector3.Angle(currentOrientation, targetOrientation);\nVector3 polarity = Vector3.Cross(currentOrientation, targetOrientation);\nif (polarity.y \u0026lt; 0) \n    angle = -angle;\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222021-03-09T19:01:22Z\u0022 title=\u002203/09/2021 07:01  PM\u0022 data-short=\u00223 yr\u0022\u003EMarch 9, 2021\u003C/time\u003E by ValiZockt\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2021-03-10T13:43:37Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223938043\u0022 data-ipsquote-contentid=\u0022200860\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221615316203\u0022 data-ipsquote-userid=\u0022197053\u0022 data-ipsquote-username=\u0022ValiZockt\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n18 hours ago, ValiZockt said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nmanNode.nodeRotation.eulerAngles is a rotation, not a direction. Use manNode.GetBurnVector(vessel.orbit);\n\u003C/p\u003E\n\u003Cp\u003E\nVector3.Angle is an absolute value, but you can calculate the polarity by using the cross product of both vectors and invert the angle if\u00A0y is negative\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\n\u003Cspan class=\u0022pln\u0022\u003EVector3 currentOrientation = FlightGlobals.ActiveVessel.ReferenceTransform.up; //up is foward\nVector3 targetOrientation = manNode.GetBurnVector(vessel.orbit);\n\nfloat angle = Vector3.Angle(currentOrientation, targetOrientation);\nVector3 polarity = Vector3.Cross(currentOrientation, targetOrientation);\nif (polarity.y \u0026lt; 0) \n    angle = -angle;\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThank you so much, working like a charm\n\u003C/p\u003E\n"}]}