{"TopicId":113294,"ForumId":29,"TopicTitle":"Need new and more experienced eyes to take a look - what am I doing wrong?","CreatedByName":"tg626","CreatedById":112361,"CreatedDateTime":"2015-06-18T03:30:53Z","PageNum":1,"Articles":[{"CreatedByName":"tg626","CreatedById":112361,"CreatedDateTime":"2015-06-18T03:30:53Z","Content":"\n\u003Cp\u003EI had really hoped to get this myself, but after getting this to (I thought) work properly, I find that it sometimes works as intended, sometimes refires the sound over and over and over forever and never lets the ports actually dock... :/\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eusing System;using System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Enamespace DockingSounds\u003Cbr\u003E{\u003Cbr\u003E    class DPSoundFX : PartModule\u003Cbr\u003E    {\u003Cbr\u003E        [KSPField]\u003Cbr\u003E        public string sound_docking = \u0022DPSoundFX/Sounds/dock\u0022;\u003Cbr\u003E        [KSPField]\u003Cbr\u003E        public string sound_undocking = \u0022DPSoundFX/Sounds/undock\u0022;\u003Cbr\u003E        public FXGroup dockSound = null;\u003Cbr\u003E        public FXGroup undockSound = null;\u003Cbr\u003E\u003Cbr\u003E        public bool createGroup (FXGroup group, string name, bool loop)\u003Cbr\u003E        {\u003Cbr\u003E            if (name != string.Empty) {\u003Cbr\u003E                if (!GameDatabase.Instance.ExistsAudioClip (name))\u003Cbr\u003E                    return false;\u003Cbr\u003E                group.audio = gameObject.AddComponent\u0026lt;AudioSource\u0026gt; ();\u003Cbr\u003E                group.audio.volume = GameSettings.SHIP_VOLUME;\u003Cbr\u003E                group.audio.rolloffMode = AudioRolloffMode.Logarithmic;\u003Cbr\u003E                group.audio.dopplerLevel = 0f;\u003Cbr\u003E                group.audio.panLevel = 1f;\u003Cbr\u003E                group.audio.clip = GameDatabase.Instance.GetAudioClip (name);\u003Cbr\u003E                group.audio.loop = loop;\u003Cbr\u003E                group.audio.playOnAwake = false;             \u003Cbr\u003E                return true;\u003Cbr\u003E            }\u003Cbr\u003E            return false;\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        public void DPFXdock (GameEvents.FromToAction\u0026lt;Part, Part\u0026gt; partAction)\u003Cbr\u003E        {\u003Cbr\u003E            //Debug.LogError (\u0022[DPSoundFX] Docking\u0022);\u003Cbr\u003E            //Debug.LogError (\u0022               Docked FROM   : \u0022 \u002B partAction.from.vessel.vesselName);\u003Cbr\u003E            //Debug.LogError (\u0022               Docked TO     : \u0022 \u002B partAction.to.vessel.vesselName);\u003Cbr\u003E            //Debug.LogError (\u0022               Docked FROM ID: \u0022 \u002B partAction.from.vessel.id.ToString ());\u003Cbr\u003E            //Debug.LogError (\u0022               Docked TO ID  : \u0022 \u002B partAction.to.vessel.id.ToString ());\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] Playing: \u0022 \u002B sound_docking);\u003Cbr\u003E            if (!dockSound.audio.isPlaying){ \u003Cbr\u003E                dockSound.audio.Play ();\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public void DPFXundock (Part part)\u003Cbr\u003E        {\u003Cbr\u003E            print (\u0022[DPSoundFX] Undocking \u0022 \u002B part.vessel);\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] Playing: \u0022 \u002B sound_undocking);\u003Cbr\u003E            undockSound.audio.Play ();\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public override void OnStart (PartModule.StartState state)\u003Cbr\u003E        {\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] OnStart Called: State is \u0022 \u002B state);\u003Cbr\u003E\u003Cbr\u003E            if (HighLogic.LoadedScene != GameScenes.FLIGHT)\u003Cbr\u003E                return;\u003Cbr\u003E\u003Cbr\u003E            base.OnStart (state);\u003Cbr\u003E\u003Cbr\u003E            if (createGroup (undockSound, sound_undocking, false)) {\u003Cbr\u003E                GameEvents.onPartUndock.Add (DPFXundock);\u003Cbr\u003E            } else {\u003Cbr\u003E                Debug.LogError (\u0022[DPSoundFX]ERROR - file \u0022 \u002B sound_undocking \u002B \u0022.* not found!\u0022);\u003Cbr\u003E            }\u003Cbr\u003E            if (createGroup (dockSound, sound_docking, false)) {\u003Cbr\u003E                GameEvents.onPartCouple.Add (DPFXdock);\u003Cbr\u003E            } else {\u003Cbr\u003E                Debug.LogError (\u0022[DPSoundFX]ERROR - file \u0022 \u002B sound_docking \u002B \u0022.* not found!\u0022);\u003Cbr\u003E            }\u003Cbr\u003E\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] OnStart Executed: State was \u0022 \u002B state);\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EWhen it goes wrong, I get NRE\u0027s in the log (below) there\u0027s only one isPlaying conditional statement because I removed them at one point as a test and then replaced the one for docking on my last try. All it did was change it from a machingun buzz of repeated playbacks to one after another after another...\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://www.dropbox.com/s/4nrp6gh3u3s0ktw/DPSoutput_log.txt?dl=0\u0022 rel=\u0022external nofollow\u0022\u003EOutput Log\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EI\u0027m sure this is just a matter of me being stupid, or knowing just enough to get myself into trouble, as I\u0027ve never taken a single class of any kind on anything beyond BASIC programming (as in BASIC language, I\u0027m 45)\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-18T03:33:01Z\u0022 title=\u002206/18/2015 03:33  AM\u0022 data-short=\u00229 yr\u0022\u003EJune 18, 2015\u003C/time\u003E by tg626\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Crzyrndm","CreatedById":92871,"CreatedDateTime":"2015-06-18T03:45:52Z","Content":"\n\u003Cp\u003EWell for one, that\u0027s going to add the DPFXundock once for every part that has the module every time you enter the flight scene (so if you have 5 parts with the module active, the function will get called 5 times for each time you enter the flight scene on an undock event). Try the KSPAddon type of plugin for which there is only a single instance per scene (\u003Ca href=\u0022https://github.com/Crzyrndm/SASTuningFix/blob/master/SASTuningFix/SASTuningFix.cs#L9-L10\u0022 rel=\u0022external nofollow\u0022\u003Esimple example\u003C/a\u003E), and remove the event in OnDestroy so you only ever have a single event trigger\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-18T03:47:57Z\u0022 title=\u002206/18/2015 03:47  AM\u0022 data-short=\u00229 yr\u0022\u003EJune 18, 2015\u003C/time\u003E by Crzyrndm\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"tg626","CreatedById":112361,"CreatedDateTime":"2015-06-18T03:59:09Z","Content":"\n\u003Cp\u003ESo there is on instance of my code running for every docking port in the scene? (It\u0027s added to all ports via module manager).\u003C/p\u003E\u003Cp\u003EAnd every instance if the code is called when any port is docked or undocked?\u003C/p\u003E\u003Cp\u003EBeyond that, having no idea how to do what you suggested ( even with the example) just proves how out of my depth I am!!! \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"Crzyrndm","CreatedById":92871,"CreatedDateTime":"2015-06-18T04:46:41Z","Content":"\n\u003Cp\u003EDammit, I\u0027ve confused myself. I was wrong, each event belongs to an instance of the module so the function wouldn\u0027t be called multiple times if you only entered the scene once. Addon type plugin also won\u0027t work because you need the part location.\u003C/p\u003E\u003Cp\u003EStart again from the beginning.\u003C/p\u003E\u003Cp\u003EEvent subscription in OnStart. Check. That\u0027s fine because the callback is specific to the module. You need one for each module so the sound gets played in the correct location\u003C/p\u003E\u003Cp\u003EEvent subscription removed in OnDestroy(). Not happening. If you enter the flight scene, leave it, and then come back, that original event is still floating around waiting to fire (with a null function to call because the part module instance it was attached to is dead\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Evoid OnDestroy()\u003Cbr\u003E{\u003Cbr\u003E    GameEvents.On*Dock.Remove(\u0026lt;func\u0026gt;);\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EEvent callback checks to see if either of the parts that are undocking are the one it is attached to. Also not happening. The callback will fire for \u003Cstrong\u003Eall\u003C/strong\u003E subscribers, not just the ones attached to parts involved in the event.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eif (!dockSound.audio.isPlaying \u0026amp;\u0026amp; [B]partAction.part = this.part[/B]) // or w/e the part lookup is in the event parameter\u003Cbr\u003E{ \u003Cbr\u003E    dockSound.audio.Play ();\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EMy bad for making things confusing \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 alt=\u0022;)\u0022\u003E\u003C/p\u003E\u003Cp\u003EEDIT\u003C/p\u003E\u003Cp\u003EAnd now I\u0027m really confused, if the first one worked...\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-18T05:12:29Z\u0022 title=\u002206/18/2015 05:12  AM\u0022 data-short=\u00229 yr\u0022\u003EJune 18, 2015\u003C/time\u003E by Crzyrndm\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"tg626","CreatedById":112361,"CreatedDateTime":"2015-06-18T05:35:15Z","Content":"\n\u003Cp\u003EOMG! That was IT (I think... it worked just now, but it\u0027s done that before and then goobered up on me when I restarted the game later, so...)\u003C/p\u003E\u003Cp\u003EHere\u0027s what I did based on your advice (that last post I was able to follow LOL)\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eusing System;using System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Enamespace DockingSounds\u003Cbr\u003E{\u003Cbr\u003E    class DPSoundFX : PartModule\u003Cbr\u003E    {\u003Cbr\u003E        [KSPField]\u003Cbr\u003E        public string sound_docking = \u0022DPSoundFX/Sounds/dock\u0022;\u003Cbr\u003E        [KSPField]\u003Cbr\u003E        public string sound_undocking = \u0022DPSoundFX/Sounds/undock\u0022;\u003Cbr\u003E        static bool eventAddedDocking = false;\u003Cbr\u003E        static bool eventAddedUndocking = false;\u003Cbr\u003E        static bool groupCreatedDocking = false;\u003Cbr\u003E        static bool groupCreatedUndocking = false;\u003Cbr\u003E        public FXGroup dockSound = null;\u003Cbr\u003E        public FXGroup undockSound = null;\u003Cbr\u003E\u003Cbr\u003E        public bool createGroup (FXGroup group, string name, bool loop)\u003Cbr\u003E        {\u003Cbr\u003E            if (name != string.Empty) {\u003Cbr\u003E                if (!GameDatabase.Instance.ExistsAudioClip (name)) {\u003Cbr\u003E                    Debug.LogError (\u0022[DPSoundFX]ERROR - file \u0022 \u002B name \u002B \u0022.* not found!\u0022);\u003Cbr\u003E                    return false;\u003Cbr\u003E                }\u003Cbr\u003E                group.audio = gameObject.AddComponent\u0026lt;AudioSource\u0026gt; ();\u003Cbr\u003E                group.audio.volume = GameSettings.SHIP_VOLUME;\u003Cbr\u003E                group.audio.rolloffMode = AudioRolloffMode.Logarithmic;\u003Cbr\u003E                group.audio.dopplerLevel = 0f;\u003Cbr\u003E                group.audio.panLevel = 1f;\u003Cbr\u003E                group.audio.clip = GameDatabase.Instance.GetAudioClip (name);\u003Cbr\u003E                group.audio.loop = loop;\u003Cbr\u003E                group.audio.playOnAwake = false;             \u003Cbr\u003E                return true;\u003Cbr\u003E            }\u003Cbr\u003E            return false;\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        public void DPFXdock (GameEvents.FromToAction\u0026lt;Part, Part\u0026gt; partAction)\u003Cbr\u003E        {\u003Cbr\u003E            //Debug.LogError (\u0022[DPSoundFX] Docking\u0022);\u003Cbr\u003E            //Debug.LogError (\u0022               Docked FROM   : \u0022 \u002B partAction.from.vessel.vesselName);\u003Cbr\u003E            //Debug.LogError (\u0022               Docked TO     : \u0022 \u002B partAction.to.vessel.vesselName);\u003Cbr\u003E            //Debug.LogError (\u0022               Docked FROM ID: \u0022 \u002B partAction.from.vessel.id.ToString ());\u003Cbr\u003E            //Debug.LogError (\u0022               Docked TO ID  : \u0022 \u002B partAction.to.vessel.id.ToString ());\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] Playing: \u0022 \u002B sound_docking);\u003Cbr\u003E            if (!this.dockSound.audio.isPlaying) { \u003Cbr\u003E                this.dockSound.audio.Play ();\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public void DPFXundock (Part part)\u003Cbr\u003E        {\u003Cbr\u003E            print (\u0022[DPSoundFX] Undocking \u0022 \u002B part.vessel);\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] Playing: \u0022 \u002B sound_undocking);\u003Cbr\u003E            if (!this.dockSound.audio.isPlaying) {\u003Cbr\u003E                this.undockSound.audio.Play ();\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public override void OnStart (PartModule.StartState state)\u003Cbr\u003E        {\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] OnStart Called: State is \u0022 \u002B state);\u003Cbr\u003E\u003Cbr\u003E            if (HighLogic.LoadedScene != GameScenes.FLIGHT)\u003Cbr\u003E                return;\u003Cbr\u003E\u003Cbr\u003E            base.OnStart (state);\u003Cbr\u003E\u003Cbr\u003E            groupCreatedDocking = createGroup (dockSound, sound_docking, false);\u003Cbr\u003E            groupCreatedUndocking = createGroup (undockSound, sound_undocking, false);\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            if (groupCreatedDocking \u0026amp;\u0026amp; !eventAddedDocking) {\u003Cbr\u003E                GameEvents.onPartCouple.Add (DPFXdock);\u003Cbr\u003E                eventAddedDocking = true;\u003Cbr\u003E            }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            if (groupCreatedUndocking \u0026amp;\u0026amp; !eventAddedUndocking) {\u003Cbr\u003E                GameEvents.onPartUndock.Add (DPFXundock);\u003Cbr\u003E                eventAddedUndocking = true;\u003Cbr\u003E            }\u003Cbr\u003E\u003Cbr\u003E            Debug.LogError (\u0022[DPSoundFX] OnStart Executed: State was \u0022 \u002B state);\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan style=\u0022font-size:8px;\u0022\u003E\u003Cspan style=\u0022color:#C0C0C0;\u0022\u003E- - - Updated - - -\u003C/span\u003E\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E%^\u0026amp;%*^@# it all...\u003C/p\u003E\u003Cp\u003EStill getting:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003ENullReferenceException  at (wrapper managed-to-native) UnityEngine.AudioSource:get_isPlaying ()\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at DockingSounds.DPSoundFX.DPFXdock (FromToAction\u00602 partAction) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at EventData\u00601[GameEvents\u002BFromToAction\u00602[Part,Part]].Fire (FromToAction\u00602 data) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at Part.Couple (.Part tgtPart) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at ModuleDockingNode.DockToVessel (.ModuleDockingNode node) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at ModuleDockingNode.\u0026lt;SetupFSM\u0026gt;m__166 () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at KerbalFSM.RunEvent (.KFSMEvent evt) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at KerbalFSM.updateFSM (KFSMUpdateMode mode) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at KerbalFSM.UpdateFSM () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E  at ModuleDockingNode.Update () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E(Filename:  Line: -1)\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Ein the log, only now I get NO sound and no docking, they are just sticking to each other \u0022magnetically\u0022... In the first test, I was getting the sound, using 2 rovers with ports. Then I launched 2 capsules and I get this magneto thing, and no sound.\u003C/p\u003E\u003Cp\u003EI know darn well there\u0027s no voodoo in coding, but it sure seems like it\u0027s possessed!!! \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_undecided.gif\u0022 alt=\u0022:huh:\u0022\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-18T05:49:16Z\u0022 title=\u002206/18/2015 05:49  AM\u0022 data-short=\u00229 yr\u0022\u003EJune 18, 2015\u003C/time\u003E by tg626\u003C/strong\u003E\n\u003Cbr\u003EReformatted code\n\u003C/span\u003E\n"},{"CreatedByName":"tg626","CreatedById":112361,"CreatedDateTime":"2015-06-18T06:09:33Z","Content":"\n\u003Cp\u003EOk... I\u0027ll add the onDestroy bit - I forgot about it honestly but that won\u0027t happen until tomorrow evening, gotta sleep now and work in the am.\u003C/p\u003E\u003Cp\u003EThis is going to nag my mind all day too... \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue2.gif\u0022 alt=\u0022:sticktongue:\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"tg626","CreatedById":112361,"CreatedDateTime":"2015-06-19T03:28:41Z","Content":"\n\u003Cp\u003EThat did it! OnDestroy got it working as intended. Thanks for the insights!\u003C/p\u003E\n"}]}