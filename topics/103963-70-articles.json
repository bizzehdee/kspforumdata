{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":70,"Articles":[{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-10-27T21:13:01Z","Content":"\u003E \n\u003E Right, more stuff to work with *and* more stuff to cause you to pull your hair out from. Looking awesome though. Wish I wasn\u0027t on a non-gaming laptop computer, or I\u0027d install this stuff in a heartbeat. As it is, if I tried to compress the process into a heartbeat, I\u0027d be dead.\n\nIt could be a lot of fun actually, I think SQUAD could enable physically based rendering and HDR for everything."},{"CreatedByName":"sDaZe","CreatedById":111181,"CreatedDateTime":"2015-10-28T00:59:09Z","Content":"Hey Blackrack, have you worked on that duna sunrise and sunset yet? Or do you plan to soon"},{"CreatedByName":"pingopete","CreatedById":74168,"CreatedDateTime":"2015-10-28T07:10:48Z","Content":"\u003E \n\u003E I was working on this but didn\u0027t release it.\n\u003E My internship ends soon and I\u0027m going to have loads and loads of free time while I figure out what to do next/obtain a new visa. Basically, expect daily updates in december and lots of the good stuff I\u0027ve been promising for a while around christmas and in January.\n\nAwesome! Thanks for your work!"},{"CreatedByName":"RandomRyan","CreatedById":142844,"CreatedDateTime":"2015-11-01T10:19:22Z","Content":"does this add clouds?"},{"CreatedByName":"Red Iron Crown","CreatedById":12858,"CreatedDateTime":"2015-11-01T11:40:28Z","Content":"\u003E \n\u003E does this add clouds?\n\nNo. Environmental Visual Enhancements is the mod for that."},{"CreatedByName":"cobbman11","CreatedById":76711,"CreatedDateTime":"2015-11-03T04:17:12Z","Content":"All I want for Christmas are Scatterer updates."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-04T22:04:18Z","Content":"Thought of a way to get the moon to show clearly through the sky... My plan is to add another material on-top of the scaled space terrain material that will be a multiplicative shader to enhance the terminator and illuminate the body more. Then we just put the shader on the Transparent-1 queue. Should show up before the clouds, but after the atmosphere ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)"},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2015-11-05T12:17:00Z","Content":"One question - why doesn\u0027t Scatterer effect show up on top of EVE clouds? CLouds all the way up to horison look weird, especially when there are some mountains on the horizon.\n\nI use old .25 EVE. New one is too buggy for me."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-11-05T13:32:17Z","Content":"\u003E \n\u003E Thought of a way to get the moon to show clearly through the sky... My plan is to add another material on-top of the scaled space terrain material that will be a multiplicative shader to enhance the terminator and illuminate the body more. Then we just put the shader on the Transparent-1 queue. Should show up before the clouds, but after the atmosphere ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)\n\nSo basically it\u0027s a multiplicative shader, would it cover all of the body or only the illuminated parts? Also, probably this would require HDR for correct rendering but no problem with that, HDR works fine in scaled space however I couldn\u0027t think of a way to make the terrain scaled space shaders render in higher intensities so HDR would really mask the dark areas of a body.\n\n\u003E \n\u003E One question - why doesn\u0027t Scatterer effect show up on top of EVE clouds? CLouds all the way up to horison look weird, especially when there are some mountains on the horizon.\n\u003E I use old .25 EVE. New one is too buggy for me.\n\nBecause the clouds don\u0027t write to the depth buffer. I actually thought clouds all the way to the horizon look weird also. I thought about this a bit a while ago and I think the easiest way to simulate this would be to modifiy the EVE clouds shader and make the clouds fade out towards the horizon/depending on viewing angle, distance to clouds and camera altitude.\n\n**Edited \u003Ctime datetime=\u00222015-11-05T13:46:34Z\u0022 title=\u002211/05/2015 01:46  PM\u0022 data-short=\u00228 yr\u0022\u003ENovember 5, 2015\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-05T15:18:35Z","Content":"\u003E \n\u003E So basically it\u0027s a multiplicative shader, would it cover all of the body or only the illuminated parts? Also, probably this would require HDR for correct rendering but no problem with that, HDR works fine in scaled space however I couldn\u0027t think of a way to make the terrain scaled space shaders render in higher intensities so HDR would really mask the dark areas of a body.\n\nExactly. It would cover everything basically, as it goes into the materials list. This is how I\u0027m doing city lights now so I am not forced to replace the terrain shader. It wouldn\u0027t require HDR, but I think it would make it look better. I\u0027m excited, this should work really well ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)\n\n\u003E \n\u003E Because the clouds don\u0027t write to the depth buffer. I actually thought clouds all the way to the horizon look weird also. I thought about this a bit a while ago and I think the easiest way to simulate this would be to modifiy the EVE clouds shader and make the clouds fade out towards the horizon/depending on viewing angle, distance to clouds and camera altitude.\n\nEVE does some basic stuff around this (View.Normal), but I always wanted to go back and improve it."},{"CreatedByName":"HerrGeneral","CreatedById":63453,"CreatedDateTime":"2015-11-05T17:40:04Z","Content":"\u003E \n\u003E Thought of a way to get the moon to show clearly through the sky... My plan is to add another material on-top of the scaled space terrain material that will be a multiplicative shader to enhance the terminator and illuminate the body more. Then we just put the shader on the Transparent-1 queue. Should show up before the clouds, but after the atmosphere ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)\n\nI think if you enhance it too much it\u0027d look weird, though. Look at the Moon in the daytime sky sometime- it\u0027s very low contrast with respect to the scattered background, and blends in fairly well if you\u0027re not looking for it. I would really like to see an enhanced, sharper terminator though- the current one on airless bodies is very diffuse and undefined, although this is kind of a side effect of how small Kerbal celestial bodies are."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-11-05T17:55:16Z","Content":"\u003E \n\u003E I think if you enhance it too much it\u0027d look weird, though. Look at the Moon in the daytime sky sometime- it\u0027s very low contrast with respect to the scattered background, and blends in fairly well if you\u0027re not looking for it. I would really like to see an enhanced, sharper terminator though- the current one on airless bodies is very diffuse and undefined, although this is kind of a side effect of how small Kerbal celestial bodies are.\n\n\u003E \n\u003E Exactly. It would cover everything basically, as it goes into the materials list. This is how I\u0027m doing city lights now so I am not forced to replace the terrain shader. It wouldn\u0027t require HDR, but I think it would make it look better. I\u0027m excited, this should work really well ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)\n\nI think in the end it\u0027s all about trial and error and playing with the settings until it looks right. What I\u0027m concerned about is making the dark parts of the moon invisible from the atmosphere, I\u0027m not sure if your method would help with this, even with HDR, as everything (dark and light areas) will get multiplied by the same amount. Though I can imagine making a quick approximation that lights the light areas and leaves the rest as is (based on direction of the sun), or does the opposite."},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2015-11-05T18:32:35Z","Content":"\u003E \n\u003E I think if you enhance it too much it\u0027d look weird, though. Look at the Moon in the daytime sky sometime- it\u0027s very low contrast with respect to the scattered background, and blends in fairly well if you\u0027re not looking for it. I would really like to see an enhanced, sharper terminator though- the current one on airless bodies is very diffuse and undefined, although this is kind of a side effect of how small Kerbal celestial bodies are.\n\nNo, current terminator is the effect of terrain not casting shadows."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-05T18:41:56Z","Content":"\u003E \n\u003E I think in the end it\u0027s all about trial and error and playing with the settings until it looks right. What I\u0027m concerned about is making the dark parts of the moon invisible from the atmosphere, I\u0027m not sure if your method would help with this, even with HDR, as everything (dark and light areas) will get multiplied by the same amount. Though I can imagine making a quick approximation that lights the light areas and leaves the rest as is (based on direction of the sun), or does the opposite.\n\nThat\u0027s the beauty of it though... we could do all sorts of funny things with it. I\u0027ve been messing around with blending (I finally understand how it works now! ) One thought I had, was encoding an \u0022Visibility\u0022 metric into the alpha channel of rendered stuff for Scatterer to use (This doesn\u0027t seem to affect rendering otherwise). Then scaterer could use the DestAlpha multiplier with blending instead of OneMinusSourceAlpha. BTW, the \u0022OneMinusSourceAlpha\u0022 helps ensures lerp-like blending. If you want, you can use \u0022One\u0022 there to allow more background through, thought it may overpower things to white."},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2015-11-05T19:02:42Z","Content":"Well, I like the mun we now have. But IMO of you somehow make terrain cast shadows it would instantly solve the problem of terminator and a few more."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-11-05T19:12:44Z","Content":"\u003E \n\u003E That\u0027s the beauty of it though... we could do all sorts of funny things with it. I\u0027ve been messing around with blending (I finally understand how it works now! ) One thought I had, was encoding an \u0022Visibility\u0022 metric into the alpha channel of rendered stuff for Scatterer to use (This doesn\u0027t seem to affect rendering otherwise). Then scaterer could use the DestAlpha multiplier with blending instead of OneMinusSourceAlpha. BTW, the \u0022OneMinusSourceAlpha\u0022 helps ensures lerp-like blending. If you want, you can use \u0022One\u0022 there to allow more background through, thought it may overpower things to white.\n\nI\u0027m not sure I understand all the blending modes well, but for the view from orbit scatterer uses additive blending (Blend One One) right now and for the ground view (haze/postprocessing) regular alpha blending (Blend SrcAlpha OneMinusSrcAlpha).\n\nNot sure I understand how your idea works, so basically everything will have alpha values but won\u0027t use alpha blending itself? Then scatterer just uses these alpha values for itself? If I\u0027m getting it right, I think this is a great idea, and would definitely work, let me just think about this a bit more.\n\nMy current idea was to just use HDR and use high brightness values for the scaledSpace objects and the atmosphere, and then finding a way to make the bright areas much brighter than the dark ones on the terrain, this would automatically produce all the desired effects, but also some glare/bloom can be simulated from high luminosity objects if needed simple postprocessing shaders. All other simulators use this approach too (Proland, Space engine, outerra). We could try with your multiplicative shader, or we could also contact SQUAD and ask them for their shader source code (not sure if they\u0027d be open to this).\n\nBut yeah, your approach seems like a good idea. Also, what is lerp-like blending?"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-05T19:47:38Z","Content":"Bingo. We would just adjust the ground view to be \u0022Blend SrcAlpha DstAlpha\u0022 Everything should already be writing 1 if it is opaque ( should is the operative factor. I am not certain about things like water.) and we could adjust it for things like clouds (distance) and the luminosity of bodies.\n\n- - - Updated - - -\n\nBingo. For the ground view we would use alpha additive \u0022Blend SrcAlpha DstAlpha\u0022, and this should let us write in a value for alpha that would let us fade it out. Would work perfectly for celestial bodies, writing 1 with lots of light, 0 for none. Should work for clouds too if I encode a \u0022distance\u0022 metric to the clouds... though I guess I could probably just make the clouds fade out...\n\nConcerns:\n\n1) Not sure if all shaders write to alpha (they should though) or if the values are as we would expect them to be.\n\n2) Not sure for certain that cameras share a universal frame buffer (but I think this is how it works)\n\nThe HDR method might work, but I think you\u0027d still have issues with the sky-body interaction.Either the body is above it (don\u0027t see blue) or below it(don\u0027t see Mun), and neither would exactly produce the results you\u0027d like. Does Mun show through right now in scatterer or is it hidden? I would expect it to be hidden unless the proland stuff includes some mechanism to render moons.\n\nEDIT: Realized that bodies are rendered in scaled space and therefor can\u0027t show above scatterer render.\n\n**Edited \u003Ctime datetime=\u00222015-11-05T19:50:19Z\u0022 title=\u002211/05/2015 07:50  PM\u0022 data-short=\u00228 yr\u0022\u003ENovember 5, 2015\u003C/time\u003E by rbray89**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-11-05T21:48:44Z","Content":"\u003E \n\u003E Bingo. We would just adjust the ground view to be \u0022Blend SrcAlpha DstAlpha\u0022 Everything should already be writing 1 if it is opaque ( should is the operative factor. I am not certain about things like water.) and we could adjust it for things like clouds (distance) and the luminosity of bodies.\n\u003E - - - Updated - - -\n\u003E \n\u003E Bingo. For the ground view we would use alpha additive \u0022Blend SrcAlpha DstAlpha\u0022, and this should let us write in a value for alpha that would let us fade it out. Would work perfectly for celestial bodies, writing 1 with lots of light, 0 for none. Should work for clouds too if I encode a \u0022distance\u0022 metric to the clouds... though I guess I could probably just make the clouds fade out...\n\u003E \n\u003E Concerns:\n\u003E \n\u003E 1) Not sure if all shaders write to alpha (they should though) or if the values are as we would expect them to be.\n\u003E \n\u003E 2) Not sure for certain that cameras share a universal frame buffer (but I think this is how it works)\n\u003E \n\u003E The HDR method might work, but I think you\u0027d still have issues with the sky-body interaction.Either the body is above it (don\u0027t see blue) or below it(don\u0027t see Mun), and neither would exactly produce the results you\u0027d like. Does Mun show through right now in scatterer or is it hidden? I would expect it to be hidden unless the proland stuff includes some mechanism to render moons.\n\u003E \n\u003E EDIT: Realized that bodies are rendered in scaled space and therefor can\u0027t show above scatterer render.\n\nThe mun currently shows through the scatterer effects. What I call the \u0022sky shader\u0022 uses additive blending, is rendered to scaled space, and renders on top of it\u0027s parent celestial object, also in top of other celestial bodies but I control on top of which one or under which one it renders using draw orders, so when the mun passes in front of kerbin it\u0027s not occluded. The same shader is also used for the planet\u0027s atmosphere when viewed from a high orbit. The postprocessing shader is only used on top of terrain and is rendered to the far camera, it uses alpha blending. So basically, the terrain itself renders on top of the sky, and the postprocessing shader renders on top of the terrain. An additional \u0022extinction\u0022 layer is also used:\n\n![dTt3d7l.jpg](http://i.imgur.com/dTt3d7l.jpg)\n\n![zB8SC7P.jpg](http://i.imgur.com/zB8SC7P.jpg)\n\nEdited: Also I know this is pretty random, but I felt like saying this here: Scatterer is one of the things I\u0027m proudest of in my life, and I aim to see it through to the end.\n\n**Edited \u003Ctime datetime=\u00222015-11-05T23:22:50Z\u0022 title=\u002211/05/2015 11:22  PM\u0022 data-short=\u00228 yr\u0022\u003ENovember 5, 2015\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-05T23:27:11Z","Content":"Ah, I see... So if we had something that wrote the alpha value as an indicator of how visible through atmosphere it should be, the extinction and sky (and possibly haze) shader should be able to use that to blend. You may even be able to remove the extinction shader and just rely on the sky shader. You also wouldn\u0027t have to fiddle with queue order. I assume you do that with the material render queue?"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-11-05T23:42:16Z","Content":"\u003E \n\u003E Ah, I see... So if we had something that wrote the alpha value as an indicator of how visible through atmosphere it should be, the extinction and sky (and possibly haze) shader should be able to use that to blend. You may even be able to remove the extinction shader and just rely on the sky shader. You also wouldn\u0027t have to fiddle with queue order. I assume you do that with the material render queue?\n\nProbably but I\u0027m not sure yet, I need to have the sky on additive blending, else the blending looks weird as hell near the edge of the atmosphere. Like this [http://i.imgur.com/yA9XJGW.jpg](http://i.imgur.com/yA9XJGW.jpg).\n\nAlso, the extinction shader does tint the colors in a realistic manner (it uses the same calculations as those that give the sun it\u0027s reddish tint on sunsets/sunrise, though it may still need some tweaking), so probably I won\u0027t get rid of it.\n\nYes indeed, I do that with the material render queue, I check the nearby planets to see if they are between the camera and the parent planet or farther away and adjust accordingly.\n\n**Edited \u003Ctime datetime=\u00222015-11-05T23:46:46Z\u0022 title=\u002211/05/2015 11:46  PM\u0022 data-short=\u00228 yr\u0022\u003ENovember 5, 2015\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-05T23:55:13Z","Content":"\u003E \n\u003E Probably but I\u0027m not sure yet, I need to have the sky on additive blending, else the blending looks weird as hell near the edge of the atmosphere. Like this [http://i.imgur.com/yA9XJGW.jpg](http://i.imgur.com/yA9XJGW.jpg).\n\u003E Also, the extinction shader does tint the colors in a realistic manner (it uses the same calculations as those that give the sun it\u0027s reddish tint on sunsets/sunrise, though it may still need some tweaking), so probably I won\u0027t get rid of it.\n\u003E \n\u003E Yes indeed, I do that with the material render queue, I check the nearby planets to see if they are between the camera and the parent planet or farther away and adjust accordingly.\n\nThe sky can still be additive, it would just be additive based on the alpha value of whatever is behind it (more or less alpha would affect it in some way)\n\nEDIT: Info on blend modes here: [http://elringus.me/blend-modes-in-unity/](http://elringus.me/blend-modes-in-unity/)\n\nBasically, Blending can have multiple opps, and the first parameter is what to multiply the source color with (generated by shader) and the second parameter is what to multiply the destination color (frame buffer) with. These to resulting values are added (or other operation based on BlendOp) to produce the final value. You can also specify separate blending for alpha if that is what you want.\n\n**Edited \u003Ctime datetime=\u00222015-11-05T23:59:45Z\u0022 title=\u002211/05/2015 11:59  PM\u0022 data-short=\u00228 yr\u0022\u003ENovember 5, 2015\u003C/time\u003E by rbray89**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-11-06T00:12:27Z","Content":"\u003E \n\u003E The sky can still be additive, it would just be additive based on the alpha value of whatever is behind it (more or less alpha would affect it in some way)\n\u003E EDIT: Info on blend modes here: [http://elringus.me/blend-modes-in-unity/](http://elringus.me/blend-modes-in-unity/)\n\u003E \n\u003E Basically, Blending can have multiple opps, and the first parameter is what to multiply the source color with (generated by shader) and the second parameter is what to multiply the destination color (frame buffer) with. These to resulting values are added (or other operation based on BlendOp) to produce the final value. You can also specify separate blending for alpha if that is what you want.\n\nCool, then in this case I could create some sort of additive alpha blending and it would work."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-06T00:16:05Z","Content":"\u003E \n\u003E Cool, then in this case I could create some sort of additive alpha blending and it would work.\n\nBingo. At least, that\u0027s the theory. I\u0027m probably going to be trying this out soon..."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-11-06T00:35:45Z","Content":"\u003E \n\u003E Bingo. At least, that\u0027s the theory. I\u0027m probably going to be trying this out soon...\n\nLooking forward to it.\n\nAlso, up there you mentioned \u00222) Not sure for certain that cameras share a universal frame buffer (but I think this is how it works)\u0022, not sure what you mean here, but when I tried applying multiplicative blending effects to the far camera they also applied to what the scaledspace camera has already rendered so I think it may be the case."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-11-06T00:57:09Z","Content":"\u003E \n\u003E Looking forward to it.\n\u003E Also, up there you mentioned \u00222) Not sure for certain that cameras share a universal frame buffer (but I think this is how it works)\u0022, not sure what you mean here, but when I tried applying multiplicative blending effects to the far camera they also applied to what the scaledspace camera has already rendered so I think it may be the case.\n\nAh, perfect! That\u0027s what I want to hear!"}]}