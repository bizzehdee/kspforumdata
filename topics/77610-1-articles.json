{"TopicId":77610,"ForumId":36,"TopicTitle":"Thread/Socket Gets Killed?","CreatedByName":"gudenau","CreatedById":40555,"CreatedDateTime":"2014-07-14T16:15:56Z","PageNum":1,"Articles":[{"CreatedByName":"gudenau","CreatedById":40555,"CreatedDateTime":"2014-07-14T16:15:56Z","Content":"\n\u003Cp\u003EI am attempting to create a Socket in a second thread to communicate with a different application. The application will have the ships stats displayed for now, but more will come later.\u003C/p\u003E\u003Cp\u003EMy problem is that my Thread/Socket seems to die as soon as the player leaves the Main Menu, any help would be appreciated.\u003C/p\u003E\u003Cp\u003EServer (Java):\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Epackage org.gudenau.pc.kerbal.kerbaldisplay;\u003Cbr\u003E\u003Cbr\u003Eimport java.awt.GridLayout;\u003Cbr\u003Eimport java.io.IOException;\u003Cbr\u003Eimport java.io.InputStream;\u003Cbr\u003Eimport java.io.OutputStream;\u003Cbr\u003Eimport java.net.ServerSocket;\u003Cbr\u003Eimport java.net.Socket;\u003Cbr\u003Eimport java.util.HashMap;\u003Cbr\u003E\u003Cbr\u003Eimport javax.swing.JFrame;\u003Cbr\u003Eimport javax.swing.JLabel;\u003Cbr\u003Eimport javax.swing.JPanel;\u003Cbr\u003E\u003Cbr\u003Epublic class KerbalDisplay {\u003Cbr\u003E\u003Cbr\u003E\tprivate final static HashMap\u0026lt;Integer, Class\u0026lt;? extends Packet\u0026gt;\u0026gt; packetMap = new HashMap\u0026lt;Integer, Class\u0026lt;? extends Packet\u0026gt;\u0026gt;();\u003Cbr\u003E\u003Cbr\u003E\tprivate JFrame frame;\u003Cbr\u003E\tprivate JLabel active;\u003Cbr\u003E\u003Cbr\u003E\tprivate void main() throws IOException {\u003Cbr\u003E\t\tServerSocket server = new ServerSocket(1001);\u003Cbr\u003E\u003Cbr\u003E\t\twhile(true){\u003Cbr\u003E\t\t\tSocket client = server.accept();\u003Cbr\u003E\u003Cbr\u003E\t\t\tframe = new JFrame(\u0022Kerbal Display\u0022);\u003Cbr\u003E\t\t\tJPanel panel = new JPanel(new GridLayout(2, 0));\u003Cbr\u003E\t\t\tframe.add(panel);\u003Cbr\u003E\u003Cbr\u003E\t\t\tpanel.add(new JLabel(\u0022Vessel != null:\u0022));\u003Cbr\u003E\t\t\tactive = new JLabel(\u0022false\u0022);\u003Cbr\u003E\t\t\tpanel.add(active);\u003Cbr\u003E\u003Cbr\u003E\t\t\tframe.pack();\u003Cbr\u003E\t\t\tframe.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);\u003Cbr\u003E\t\t\tframe.setResizable(false);\u003Cbr\u003E\t\t\tframe.setVisible(true);\u003Cbr\u003E\u003Cbr\u003E\t\t\tInputStream in = client.getInputStream();\u003Cbr\u003E\t\t\tOutputStream out = client.getOutputStream();\u003Cbr\u003E\u003Cbr\u003E\t\t\tbyte[] buffer = null;\u003Cbr\u003E\t\t\tbyte tmp = -1;\u003Cbr\u003E\t\t\tint bufferOffset = -1;\u003Cbr\u003E\t\t\tint type = -1;\u003Cbr\u003E\u003Cbr\u003E\t\t\tint count = 0;\u003Cbr\u003E\u003Cbr\u003E\t\t\ttry {\u003Cbr\u003E\t\t\t\tThread.sleep(10);\u003Cbr\u003E\t\t\t} catch (InterruptedException e1) {}\u003Cbr\u003E\u003Cbr\u003E\t\t\twhile(true){\u003Cbr\u003E\t\t\t\tout.write(new byte[]{0, 0});\u003Cbr\u003E\u003Cbr\u003E\t\t\t\tif(in.available() \u0026gt; 0){\u003Cbr\u003E\t\t\t\t\ttmp = (byte) in.read();\u003Cbr\u003E\u003Cbr\u003E\t\t\t\t\tif(buffer == null){\u003Cbr\u003E\t\t\t\t\t\tbuffer = new byte[tmp];\u003Cbr\u003E\t\t\t\t\t}else if(type == -1){\u003Cbr\u003E\t\t\t\t\t\ttype = tmp;\u003Cbr\u003E\t\t\t\t\t\tbufferOffset = 0;\u003Cbr\u003E\t\t\t\t\t}else{\u003Cbr\u003E\t\t\t\t\t\tbuffer[bufferOffset\u002B\u002B] = tmp;\u003Cbr\u003E\u003Cbr\u003E\t\t\t\t\t\tif(bufferOffset == buffer.length){\u003Cbr\u003E\t\t\t\t\t\t\tprocessPacket(type, buffer);\u003Cbr\u003E\t\t\t\t\t\t\tbuffer = null;\u003Cbr\u003E\t\t\t\t\t\t\ttype = -1;\u003Cbr\u003E\t\t\t\t\t\t}\u003Cbr\u003E\t\t\t\t\t}\u003Cbr\u003E\t\t\t\t}else{\u003Cbr\u003E\t\t\t\t\ttry {\u003Cbr\u003E\t\t\t\t\t\tThread.sleep(1);\u003Cbr\u003E\t\t\t\t\t} catch (InterruptedException e) {}\u003Cbr\u003E\t\t\t\t}\u003Cbr\u003E\u003Cbr\u003E\t\t\t\tcount\u002B\u002B;\u003Cbr\u003E\u003Cbr\u003E\t\t\t\tif(count \u0026gt;= 1024){\u003Cbr\u003E\t\t\t\t\tcount = 0;\u003Cbr\u003E\t\t\t\t\tbyte[] outBuffer = new byte[]{1, 0, 0};\u003Cbr\u003E\t\t\t\t\tSystem.out.println(outBuffer[0]);\u003Cbr\u003E\t\t\t\t\tout.write(outBuffer);\u003Cbr\u003E\t\t\t\t}\u003Cbr\u003E\t\t\t}\u003Cbr\u003E\t\t}\u003Cbr\u003E\t}\u003Cbr\u003E\u003Cbr\u003E\tprivate void processPacket(int type, byte[] buffer) {\u003Cbr\u003E\t\tswitch(type){\u003Cbr\u003E\t\tcase 0:\u003Cbr\u003E\t\t\tactive.setText((buffer[0] == 1) \u002B \u0022\u0022);\u003Cbr\u003E\t\t}\u003Cbr\u003E\t}\u003Cbr\u003E\u003Cbr\u003E\tpublic static void main(String[] args) throws IOException{\u003Cbr\u003E\t\tnew KerbalDisplay().main();\u003Cbr\u003E\t}\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EPlugin:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Eusing System;\u003Cbr\u003Eusing System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing System.Threading;\u003Cbr\u003E\u003Cbr\u003Eusing System.Net;\u003Cbr\u003Eusing System.Net.Sockets;\u003Cbr\u003Eusing System.IO;\u003Cbr\u003E\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003Epublic class HelloKerbinModController {\u003Cbr\u003E    public void start() {\u003Cbr\u003E        IPAddress address = IPAddress.Loopback;\u003Cbr\u003E        IPEndPoint ipEndPoint = new IPEndPoint(address, 1001);\u003Cbr\u003E        socket = new Socket(address.AddressFamily, SocketType.Stream, ProtocolType.Tcp);\u003Cbr\u003E        socket.NoDelay = false;\u003Cbr\u003E\u003Cbr\u003E        socket.Connect(ipEndPoint);\u003Cbr\u003E\u003Cbr\u003E        byte[] tmp = null;\u003Cbr\u003E        byte data = 0;\u003Cbr\u003E        int rec;\u003Cbr\u003E        int tmpOffset = 0;\u003Cbr\u003E\u003Cbr\u003E        while(socket.IsBound){\u003Cbr\u003E            if(socket.Available \u0026gt; 0){\u003Cbr\u003E                tmp = new byte[socket.Available];\u003Cbr\u003E                rec = socket.Receive(tmp);\u003Cbr\u003E\u003Cbr\u003E                for (tmpOffset = 0; tmpOffset \u0026lt; rec; tmpOffset\u002B\u002B)\u003Cbr\u003E                {\u003Cbr\u003E                    data = tmp[tmpOffset];\u003Cbr\u003E\u003Cbr\u003E                    handleInputByte(data);\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    private byte[] buffer = null;\u003Cbr\u003E    private int bufferOffset = 0;\u003Cbr\u003E    private int type = -1;\u003Cbr\u003E    private Socket socket;\u003Cbr\u003E\u003Cbr\u003E    private void handleInputByte(byte data){\u003Cbr\u003E        if(buffer == null){\u003Cbr\u003E            buffer = new byte[data];\u003Cbr\u003E            bufferOffset = 0;\u003Cbr\u003E        }\u003Cbr\u003E        else if (type == -1)\u003Cbr\u003E        {\u003Cbr\u003E            type = data;\u003Cbr\u003E        }\u003Cbr\u003E        else {\u003Cbr\u003E            buffer[bufferOffset\u002B\u002B] = data;\u003Cbr\u003E\u003Cbr\u003E            if(bufferOffset == buffer.Length){\u003Cbr\u003E                processPacket();\u003Cbr\u003E                buffer = null;\u003Cbr\u003E                type = -1;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    private void processPacket() {\u003Cbr\u003E        switch(type){\u003Cbr\u003E            case 0:\u003Cbr\u003E                sendVesselData();\u003Cbr\u003E                break;\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    private void sendVesselData()\u003Cbr\u003E    {\u003Cbr\u003E        Vessel ship = FlightGlobals.ActiveVessel;\u003Cbr\u003E\u003Cbr\u003E        byte[] data = {1, 0, (byte)(ship == null ? 1 : 0) };\u003Cbr\u003E\u003Cbr\u003E        socket.Send(data);\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    private void informUser(String message) {\u003Cbr\u003E        ScreenMessages.PostScreenMessage(message, 30F, ScreenMessageStyle.UPPER_RIGHT);\u003Cbr\u003E        MonoBehaviour.print(message);\u003Cbr\u003E    }\u003Cbr\u003E}\u003Cbr\u003E\u003Cbr\u003E[KSPAddon(KSPAddon.Startup.MainMenu, false)]\u003Cbr\u003Epublic class HelloKerbinModConnection : MonoBehaviour\u003Cbr\u003E{\u003Cbr\u003E    public void Start()\u003Cbr\u003E    {\u003Cbr\u003E        HelloKerbinModController hkmc = new HelloKerbinModController();\u003Cbr\u003E        Thread thread = new Thread(hkmc.start);\u003Cbr\u003E        thread.Start();\u003Cbr\u003E    }\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-07-14T16:29:15Z","Content":"\n\u003Cp\u003EI think you are misunderstanding how the KSPAddon attribute works.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E[KSPAddon(KSPAddon.Startup.MainMenu, false)]\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Emeans only run while at the main menu screen. So when you switch to the Space Center (load a save), it stops your plug in as you are no longer at the Main Menu.\u003C/p\u003E\u003Cp\u003EI\u0027m not sure of exactly how to go about what you need.\u003C/p\u003E\u003Cp\u003EI\u0027d try to find a mod that runs all the time and see how they do it, I\u0027ve not tried this myself but there are several issues that you might run into from reading posts on the forum.\u003C/p\u003E\u003Cp\u003ENotably if you set run once to true, look into using KSPAddonFixed instead to get around a bug in the KSPAddon attribute.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"gudenau","CreatedById":40555,"CreatedDateTime":"2014-07-14T16:53:49Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Diazo\u0022 data-cite=\u0022Diazo\u0022\u003E\u003Cdiv\u003EI think you are misunderstanding how the KSPAddon attribute works.\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E[KSPAddon(KSPAddon.Startup.MainMenu, false)]\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Emeans only run while at the main menu screen. So when you switch to the Space Center (load a save), it stops your plug in as you are no longer at the Main Menu.\u003C/p\u003E\u003Cp\u003EI\u0027m not sure of exactly how to go about what you need.\u003C/p\u003E\u003Cp\u003EI\u0027d try to find a mod that runs all the time and see how they do it, I\u0027ve not tried this myself but there are several issues that you might run into from reading posts on the forum.\u003C/p\u003E\u003Cp\u003ENotably if you set run once to true, look into using KSPAddonFixed instead to get around a bug in the KSPAddon attribute.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThe boolean is a one-shot, if true it will be run every time, not kept running.\u003C/p\u003E\u003Cp\u003EI see no KSPAddonFixed.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-07-14T17:15:31Z","Content":"\n\u003Cp\u003EFrom the developer\u0027s release notes on KSPAddon:\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022\u003E\u003Cdiv\u003EKSPAddon \u0026amp; AddonLoader\u003Cp\u003EAddonLoader is a simple system which allows modders to instantiate Unity MonoBehaviours without need to messily overload Part, PartModule or UnitTests. To do this you tag a component in your assembly with the KSPAddon attribute. This attribute allows you to set which scene the component is instantiated in and also if it should be repeatedly instantiated upon transition into that scene. If you want the component to not be destroyed then you should set \u0027once\u0027 to true and manually call DontDestroyOnLoad.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThe way I read that is when a class is instantiated for a scene, if the bool is set to false, it instantiates every time you transfer to the scene.\u003C/p\u003E\u003Cp\u003EIf you do not call DontDestroyOnLoad, your class is destroyed when you leave the scene, I assume that this explains why you are seeing what you are because your class is only active while you are at the main menu.\u003C/p\u003E\u003Cp\u003EThe wildcard is the fact that you are calling a new thread. I\u0027m not sure how that is going to affect things so you will have to experiment I guess.\u003C/p\u003E\u003Cp\u003EKSPAddonFixed is a work around Majiir has come up with for a bug in Squads handling of add-ons that set the run once bool to true. \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/45107-KSPAddon-bug-causes-mod-incompatibilities\u0022 rel=\u0022external nofollow\u0022\u003ELink here has the full details.\u003C/a\u003E\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"gudenau","CreatedById":40555,"CreatedDateTime":"2014-07-14T17:38:21Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Diazo\u0022 data-cite=\u0022Diazo\u0022\u003E\u003Cdiv\u003EFrom the developer\u0027s release notes on KSPAddon:\u003Cp\u003EThe way I read that is when a class is instantiated for a scene, if the bool is set to false, it instantiates every time you transfer to the scene.\u003C/p\u003E\u003Cp\u003EIf you do not call DontDestroyOnLoad, your class is destroyed when you leave the scene, I assume that this explains why you are seeing what you are because your class is only active while you are at the main menu.\u003C/p\u003E\u003Cp\u003EThe wildcard is the fact that you are calling a new thread. I\u0027m not sure how that is going to affect things so you will have to experiment I guess.\u003C/p\u003E\u003Cp\u003EKSPAddonFixed is a work around Majiir has come up with for a bug in Squads handling of add-ons that set the run once bool to true. \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/45107-KSPAddon-bug-causes-mod-incompatibilities\u0022 rel=\u0022external nofollow\u0022\u003ELink here has the full details.\u003C/a\u003E\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThanks, where did you find that?\u003C/p\u003E\u003Cp\u003EEdit:\u003C/p\u003E\u003Cp\u003EDontDestroyOnLoad does not seem to exist... I feel like a I made a great big derp.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-07-14T17:57:33Z","Content":"\n\u003Cp\u003EMy quote was from \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/34013-0-20-PartTools-GameDatabase-and-new-features?p=423632\u0026amp;viewfull=1#post423632\u0022 rel=\u0022external nofollow\u0022\u003EMu\u0027s post here announcing the new features in the 0.20 release.\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EOn the DontDestroyOnLoad I am at a loss as I\u0027ve never tried to use it myself.\u003C/p\u003E\u003Cp\u003EEverything I\u0027ve done is confined to flight mode or the editor and I\u0027ve been allowing KSP to destroy my classes when I leave those scenes to make sure I keep all my references straight by making sure they refresh when I come back to the scene later.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"gudenau","CreatedById":40555,"CreatedDateTime":"2014-07-14T18:23:23Z","Content":"\n\u003Cp\u003EDontDestroyOnLoad(transform.gameObject);\u003C/p\u003E\n"},{"CreatedByName":"Zarenor","CreatedById":76712,"CreatedDateTime":"2014-07-14T23:03:15Z","Content":"\n\u003Cp\u003EYour issue is choosing MainMenu as your startpoint - most mods for overall functionality use Instantly with once as true, or use EveryScene, and once = false, and plan for whichever they use. Bear in mind that instantly starts during the load screen (as will EveryScene, I believe)\u003C/p\u003E\u003Cp\u003EKSPAddonFixed is no longer necessary - the bug it fixes has been... fixed. \u003C/p\u003E\u003Cp\u003EHope that helps \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"}]}