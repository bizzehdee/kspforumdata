{"TopicId":153344,"ForumId":36,"TopicTitle":"How to differentiate ground from rocks and buildings (raycast hits)","CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2016-12-11T05:24:35Z","PageNum":1,"Articles":[{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2016-12-11T05:24:35Z","Content":"\n\u003Cp\u003E\nI\u0027m trying to make my LaserDist mod a bit smarter about reporting the kind of thing the laser has hit: ground versus building versus scatter rock (that last one is only for mods have made the scatter rocks have colliders).\n\u003C/p\u003E\n\u003Cp\u003E\nThe current logic is along these lines (this is a simplified version that demonstrates where I\u0027m having a problem with a lot of the extra stuff stripped out):\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode\u0022\u003E\nRaycastHit hit = bestLateUpdateHit; // bestLateUpdateHit is populated elsewhere in the mod\n\nGameObject hitObject = (hit.transform == null ? null : hit.transform.gameObject);\nif (hitObject != null)\n{\n    CelestialBody body = hitObject.GetComponentInParent\u0026lt;CelestialBody\u0026gt;();\n    if (body != null)\n    {\n        // code that handles the case where the raycast hit terrain\n    }\n    else\n    {\n        // code that handles the case where the raycast hit something other than terrain.\n    }\n}\u003C/pre\u003E\n\u003Cp\u003E\nThe problem is that in my testing for whether the raycast hit terrain or something else, testing for CelestialBody generates false positives because in addition to being true for terrain, it\u0027s also true for space center buildings, and every other non-vessel object.\u00A0 This makes sense if SQUAD has designed things so that the buildings are children of the CelestialBody just like the terrain polygons are, which of course they have to be so they can stay \u0022glued\u0022 to the planet surface and move with it.\n\u003C/p\u003E\n\u003Cp\u003E\nSo what I\u0027m looking for, is what type \u0022T\u0022, or what set of \u0022T\u0022\u0027s can I use in the call GetComponentInParent\u0026lt;T\u0026gt;() that will help me distinguish \u0022this thing is the ground\u0022 from \u0022this thing isn\u0027t the ground\u0022?\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve been trying to find experimentally at runtime just what the full parent-chain looks like for my hits all the way up (i.e. this component is a member of this component which is a member of this component, etc) but the problem I\u0027m having is that C# won\u0027t allow me to make type T in the various thingy.GetFoo\u0026lt;T\u0026gt;() calls be the open-ended GameObject type or Component type.\u00A0 It insists I use a type a bit more specific than that, and the whole point of the excercise is that I don\u0027t actually know what those types are yet and I\u0027m trying to discover them.\u00A0 I haven\u0027t found in the Unity API where the call is for \u0022just get the immediate parent, and I don\u0027t know yet what type that parent will be.\u00A0 I\u0027d like to print it at runtime.\u0022\n\u003C/p\u003E\n\u003Cp\u003E\nSo because I don\u0027t know the actual component tree layout SQUAD uses for terrain versus building meshes, and I haven\u0027t succeeded at finding that \u0022just get me the parent\u0022 call so I can do my own investigation and learn it, I don\u0027t know how to discover what kind of thing my raycast has hit.\n\u003C/p\u003E\n\u003Cp\u003E\nDoes anyone know which type T with GetComponentInParent\u0026lt;T\u0026gt;() will find a hit for ground but not for buildings?\u00A0 (or visa-versa).\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2016-12-11T19:48:22Z","Content":"\n\u003Cp\u003E\nMaybe look at the layer the objects are on? (GameObject.layer)\n\u003C/p\u003E\n\u003Cp\u003E\nGoing to poke at this myself, if that question could be answered it would help my Landing Aid mod.\n\u003C/p\u003E\n\u003Cp\u003E\nD.\n\u003C/p\u003E\n\u003Cp\u003E\nedit:\u00A0 It appears that everything \u0022ground\u0022 is on layer 15, at least the PQS objects and the Launchpad models. Currently testing but it looks like that if the GameObject hit has a Component of Type \u0022PQ\u0022, then it\u0027s a PQS object, otherwise it\u0027s a model of some sort.\n\u003C/p\u003E\n\u003Cp\u003E\nedit the 2nd: Looking at your post again, the parent/child relationship appears to be through the transform objects.\n\u003C/p\u003E\n\u003Cp\u003E\nSo \u0022MyGameObject.transform.parent.GameObject\u0022 is a reference to the parent GameObject.\n\u003C/p\u003E\n\u003Cp\u003E\nedit the 3rd: So, it\u0027s looking pretty solid.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003ELayerMask testMask = 1 \u0026lt;\u0026lt; 15; //cast against layer 15 only.\nif (Physics.Raycast(pRayDown, out pHit, (float)(FlightGlobals.ActiveVessel.mainBody.Radius \u002B FlightGlobals.ActiveVessel.altitude), testMask)) //cast ray\n{\n     if(pHit.collider.gameObject.GetComponent\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;PQ\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E() != null)\n     {\n        //Hit PQS\n     }\n     else\n     {\n        /Hit something else\n     }\n     }\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nFor sure you need to ignore layer 10 (scaled space stuff) and the layer that parts themselves are on. (Forgot to note it, not sure what layer number it is.)\n\u003C/p\u003E\n\u003Cp\u003E\nThe wildcard is the mods that add terrain, I only tested stock against the \u003Cabbr title=\u0022Kerbal Space Center\u0022\u003EKSC\u003C/abbr\u003E buildings and the ground (including under the oceans) near it.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nedit the last: The annoying part is that water seems to have no collider to hit, a raycast with a LayerMask of ~0 (which should hit anything) still hits the PQS terrain on the seabed.\n\u003C/p\u003E\n\u003Cp\u003E\nAlso, parts attached to the current vessel appear to be on layer 0 and I\u0027m not able to determine if seperated parts (another vessel) are also on layer 0 or not.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nedit the next day: Looks like all actual parts are on layer zero, you have to do a if(!FlightGlobas.ActiveVessel.Parts.Contains(pHit.collider.gameObject.GetComponentUpwards\u0026lt;Part\u0026gt;()) check to see if the part you hit is on the focus vessel or not.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-12-12T14:33:09Z\u0022 title=\u002212/12/2016 02:33  PM\u0022 data-short=\u00227 yr\u0022\u003EDecember 12, 2016\u003C/time\u003E by Diazo\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Ger_space","CreatedById":167349,"CreatedDateTime":"2016-12-14T09:00:10Z","Content":"\n\u003Cp\u003E\nBuildings and anomalies are of the type\u00A0\u003Ca href=\u0022https://kerbalspaceprogram.com/api/class_p_q_s_city.html\u0022 rel=\u0022external nofollow\u0022\u003EPQSCity\u003C/a\u003E or PQSCity2, which inherit from PQSSurfaceObject. They are attached to the parent body. All other PQSMods are for altering the terrain elevation, so\u00A0 they could be treated as CeletialBody surface.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2017-01-23T16:52:24Z","Content":"\n\u003Cp\u003E\nI found this thread when looking for information about raycasts as\u00A0I just happened to be going through BD armory code to try to figure out how it interacts with physicsless parts. But in any case, here\u0027s the way BD\u0027s code detects a \u003Cabbr title=\u0022Kerbal Space Center\u0022\u003EKSC\u003C/abbr\u003E building:\u003Cbr\u003E\u003Cbr\u003E\nDestructibleBuilding building = rayHit.collider.GetComponentInParent\u0026lt;DestructibleBuilding\u0026gt;();\u003Cbr\u003E\u003Cbr\u003E\nI have no info on scatter or other sorts of non terrain\u00A0though.\u003Cbr\u003E\u003Cbr\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222017-01-23T16:52:48Z\u0022 title=\u002201/23/2017 04:52  PM\u0022 data-short=\u00227 yr\u0022\u003EJanuary 23, 2017\u003C/time\u003E by allmhuran\u003C/strong\u003E\n\u003C/span\u003E\n"}]}