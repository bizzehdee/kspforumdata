{"TopicId":104266,"ForumId":44,"TopicTitle":"Following in HarvesteR\u0027s footsteps (Unity maths)","CreatedByName":"Corbald","CreatedById":2219,"CreatedDateTime":"2015-04-16T17:17:06Z","PageNum":1,"Articles":[{"CreatedByName":"Corbald","CreatedById":2219,"CreatedDateTime":"2015-04-16T17:17:06Z","Content":"(Mods: Is this the right place to ask this?)\n\nHey all, I need some help! I have been working for a while on a project of my own. I have a lot of stuff that I have already done, but now it comes time to do the thing I\u0027ve been dreading the most... the math of orbital dynamics and conics. I have a rudimentary understanding of how cones draw ellipses and how planets sit in the foci, but I\u0027m trying to really wrap my mind around the math. I can\u0027t read mathematical notation and have only a high-school education. I\u0027m ADHD and haven\u0027t been in school for 24 years. As you can imagine, this has been an uphill battle for me, the entire time! None the less, I have tackled a lot of difficult problems, including dynamic LoD, procedural generation, networking, optimization and more.\n\nIn trying to make the numbers actually mean something to my idiot brain, I stumbled upon a post by none other than HarvesteR, himself ([http://www.orbiter-forum.com/showthread.php?t=20580](http://www.orbiter-forum.com/showthread.php?t=20580)). He seems to be asking some of the same questions that I am, and seems to be at around the same stage that I am (at that moment in time). Now, we all know that he was successful in *his* attempts, so I think I\u0027m on the right track.\n\nIn that post, Arrowstar very kindly supplies him with a MATLAB example which spits out all the relevant data points for an orbit. I\u0027m really hoping you guys can help me get the MATLAB gibberish to produce some real numbers, so that I can actually learn something and get my mind to visualize these concepts. I have a lot of references that I have dug up via Googling around, and I hope that if I can get this thing running, I can actually make some headway.\n\nHere\u0027s what I have: (I have commented relevant lines of code with the pertinent questions I have.)\n\n    using UnityEngine;using System.Collections;public class Manager : MonoBehaviour{    // Use this for initialization    void Start()    {        GameObject[] Objects = GameObject.FindGameObjectsWithTag(\u0022Star\u0022);        //Initial \u0027kick\u0027        foreach (GameObject ObjectA in Objects)        {            ObjectA.GetComponent().AddForce(new Vector3(0, 0, 1)); //Initial \u0027kick\u0027        }    }    void ApplyGravity(Rigidbody A, Rigidbody     {        //This is how to get the distance vector between two objects. (I totally stole most of this function,         //but I understand it now, so I\u0027ll rewrite it to suit my project, later.)        Vector3 dist = B.transform.position - A.transform.position;        float r = dist.magnitude;        dist /= r;        //This is the Newton\u0027s equation        //G = 6.67 * 10^-11 N.m\u00C3\u201A\u00C2\u00B2.kg^-2        double G = 6.674f * (10 ^ 11);        float force = ((float)G * A.mass * B.mass) / (r * r);        //Then, just apply the forces        A.AddForce(dist * force);        B.AddForce(-dist * force);        //note that there are only two objects in my scene, a \u0027planet\u0027 with x,y,z locked, and a \u0027moon\u0027        //the \u0027moon\u0027 is the only object which will get a force, for this example, due to the constraints on the other body.        //DrawOrbit(A.position, A.position \u002B A.velocity, dist * force); //this will call the orbital calculation stuff below.    }\n\nHere\u0027s the code for the function I\u0027m having issues with\n\n        void DrawOrbit(Vector3 rVect, Vector3 vVect, float muCB)    {        //Here begins the MATLAB code provided to HarvesteR        //  function [sma, ecc, inc, longAscNode, ArgPeri, TrueAnom] = getKeplerFromState(rVect,vVect,muCB)         //% getKeplerFromState() returns Keplerian orbital elements when provided        //% with the state (cartesian position vector, cartesian velocity vector) of        //% a spacecraft or celestial body.        //%        //% INPUTS        //% rVect - a 3x1 vector that contains the x,y,z components of the orbiting        //% body\u0027s current position relative to the central body.  Units: [km]        //% vVect - a 3x1 vector that contains the x,y,z components of the orbiting        //% body\u0027s current velocity vector relative to the central body.  Units:        //% [km/sec]        //% muCB - the gravitational parameter of the central body.  Units: km^3/s^2 //(What, of the above, goes here?        //%        //%OUTPUTS        //% sma - semi-major axis of the orbit.  Units: [km]        //% ecc - eccentricity of the orbit.  Units: dimensionless        //% inc - inclination angle of the orbit.  Units: radian        //% longAscNode - Longitude of ascending node of the orbit.  Units: radian        //% ArgPeri - Argument of periapse of the orbit.  Units: radian.        //% TrueAnom - Current true anomaly of the spacecraft/body in the orbit.        //% Units: radian        //r=norm(rVect);        //rUnitVect=rVect/r;        //v=norm(vVect);        float r = rVect.magnitude; //matlab \u0027norm\u0027 is Unity Vector3.magnitude?        Vector3 rUnitVect = rVect.normalized; // rVect/r is Unity Vector3.normalized?        float v = vVect.magnitude;        //hVect=cross(rVect,vVect);        //h=norm(hVect);        //hUnitVect=hVect/h;        //ThetaUnitVect=cross(hUnitVect,rUnitVect);        Vector3 hVect = Vector3.Cross(rVect, vVect);        float h = hVect.magnitude;        Vector3 hUnitVect = hVect.normalized;        Vector3 ThetaUnitVect = Vector3.Cross(hUnitVect, rUnitVect);        //Energy=v^2/2 - muCB/r;        //sma=-muCB/(2*Energy);        float Energy = Mathf.Pow( v, 2 )/ 2 - muCB / r; //Am I doing order of operation right?        float sma = -muCB / (2 * Energy);        //p=h^2/muCB;        //ecc=sqrt(-p/sma \u002B 1);        float p = Mathf.Pow(h, 2) / muCB;        float ecc = Mathf.Sqrt(-p / sma \u002B 1);        //TrueAnom=acos((p/r - 1)/(ecc));        //if(dot(rVect,vVect)\u003C0)        //    TrueAnom=-TrueAnom;        //end        float TrueAnom = Mathf.Acos((p / r - 1) / ecc);        if (Vector3.Dot(rVect, vVect) \u003C 0)        {            TrueAnom = -TrueAnom;        }        //inc=acos(hUnitVect(3));        float inc = Mathf.Acos(hUnitVect[2]); //Unity vectors are from 0-2, not 1-3        //longAscNode_1=AngleZero2Pi(asin(hUnitVect(1)/sin(inc))); //is AngleZero2Pi a matlab function? what is this?        //longAscNode_2=AngleZero2Pi(pi-asin(hUnitVect(1)/sin(inc)));        //longAscNode_3=AngleZero2Pi(acos(-hUnitVect(2)/sin(inc)));        //longAscNode_4=AngleZero2Pi(-acos(-hUnitVect(2)/sin(inc)));        //longAscNodeSet1=round(1000*[longAscNode_1,longAscNode_2])/1000; //is this a Mathf.Round as a vector2?        //longAscNodeSet2=round(1000*[longAscNode_3,longAscNode_4])/1000;        //[val,ia,ib]=intersect(longAscNodeSet1,longAscNodeSet2); //am I finding the intersection of two vector2\u0027s? I don\u0027t know how to read this!        //longAscNode=longAscNodeSet1(ia); //I don\u0027t know how to read this!        //Theta_1=AngleZero2Pi(asin(rUnitVect(3)/sin(inc))); //Quesion as above        //Theta_2=AngleZero2Pi(pi-asin(rUnitVect(3)/sin(inc)));        //Theta_3=AngleZero2Pi(acos(ThetaUnitVect(3)/sin(inc)));        //Theta_4=AngleZero2Pi(-acos(ThetaUnitVect(3)/sin(inc)));        //ThetaSet1=round(1000*[Theta_1,Theta_2])/1000; //Quesion as above        //ThetaSet2=round(1000*[Theta_3,Theta_4])/1000;        //[val,ia,ib]=intersect(ThetaSet1,ThetaSet2); //Quesion as above        //Theta=ThetaSet1(ia); //Quesion as above        //ArgPeri=Theta-TrueAnom; //If I could figure out the above, this might make sense!        //some stuff will go here to draw the elipse/orbits. I\u0027ll tackle that later, after I make sense of the rest.    }\n\nFinally, some code to apply a basic orbit, it\u0027s bad, but it\u0027s working\n\n        void FixedUpdate()    {        //Get every object         GameObject[] Objects = GameObject.FindGameObjectsWithTag(\u0022Star\u0022); //This runs too often. Extract to Start() later to optimize.        //the gravity between each couple of object is calculated        foreach (GameObject ObjectA in Objects)        {            foreach (GameObject ObjectB in Objects)            {                //Objects must not self interact                 if (ObjectA == ObjectB)                    continue;                ApplyGravity(ObjectA.GetComponent(), ObjectB.GetComponent()); //should store these GetComponents, they run too often.            }        }    }}\n\nHopefully, someone can make some sense of this. I\u0027m really stuck here! Please note that I DO NOT intend to reuse 90% of this code, as it\u0027s not all mine. Once I can understand what\u0027s going on, I\u0027ll re-write for my project.\n\n**Edited \u003Ctime datetime=\u00222015-04-16T17:34:19Z\u0022 title=\u002204/16/2015 05:34  PM\u0022 data-short=\u00229 yr\u0022\u003EApril 16, 2015\u003C/time\u003E by Corbald**"},{"CreatedByName":"*Aqua*","CreatedById":103926,"CreatedDateTime":"2015-04-17T01:10:24Z","Content":"My comments start with // \\*\\*\\*.\n\n    //r=norm(rVect);//rUnitVect=rVect/r;//v=norm(vVect);// *** about Unity Vector3: http://docs.unity3d.com/ScriptReference/Vector3.html// *** looks rightfloat r = rVect.magnitude; //matlab \u0027norm\u0027 is Unity Vector3.magnitude?Vector3 rUnitVect = rVect.normalized; // rVect/r is Unity Vector3.normalized?float v = vVect.magnitude;//hVect=cross(rVect,vVect);//h=norm(hVect);//hUnitVect=hVect/h;//ThetaUnitVect=cross(hUnitVect,rUnitVect);Vector3 hVect = Vector3.Cross(rVect, vVect);float h = hVect.magnitude;Vector3 hUnitVect = hVect.normalized;Vector3 ThetaUnitVect = Vector3.Cross(hUnitVect, rUnitVect);//Energy=v^2/2 - muCB/r;//sma=-muCB/(2*Energy);float Energy = Mathf.Pow( v, 2 )/ 2 - muCB / r; //Am I doing order of operation right?        // *** looks ok, but if you are unsure put it into brackets        // *** example: ((v*v) / 2) - (muCB / r) - it\u0027ll calculate v*v fist, then v\u00C3\u201A\u00C2\u00B2 / 2, then muCB / r and finally the substractionfloat sma = -muCB / (2 * Energy);//p=h^2/muCB;//ecc=sqrt(-p/sma \u002B 1);float p = Mathf.Pow(h, 2) / muCB;float ecc = Mathf.Sqrt(-p / sma \u002B 1);//TrueAnom=acos((p/r - 1)/(ecc));//if(dot(rVect,vVect)\u003C0)//    TrueAnom=-TrueAnom;//endfloat TrueAnom = Mathf.Acos((p / r - 1) / ecc);if (Vector3.Dot(rVect, vVect) \u003C 0){    TrueAnom = -TrueAnom;}//inc=acos(hUnitVect(3));float inc = Mathf.Acos(hUnitVect[2]); //Unity vectors are from 0-2, not 1-3//longAscNode_1=AngleZero2Pi(asin(hUnitVect(1)/sin(inc))); //is AngleZero2Pi a matlab function? what is this?        // *** couldn\u0027t find that in the documentation, must be a custom method or from an old MATLAB version//longAscNode_2=AngleZero2Pi(pi-asin(hUnitVect(1)/sin(inc)));//longAscNode_3=AngleZero2Pi(acos(-hUnitVect(2)/sin(inc)));//longAscNode_4=AngleZero2Pi(-acos(-hUnitVect(2)/sin(inc)));//longAscNodeSet1=round(1000*[longAscNode_1,longAscNode_2])/1000; //is this a Mathf.Round as a vector2?        // *** I think it is.//longAscNodeSet2=round(1000*[longAscNode_3,longAscNode_4])/1000;//[val,ia,ib]=intersect(longAscNodeSet1,longAscNodeSet2); //am I finding the intersection of two vector2\u0027s? I don\u0027t know how to read this!        // *** foo[a, b, c] is an array: \u0027foo\u0027 is the name of it, abc are the names of three elements inside the array.        // *** The named elements allow direct access to array element.        // *** Therefore [val,ia,ib] is an unnamed array with three elements, named val, ia and ib.//longAscNode=longAscNodeSet1(ia); //I don\u0027t know how to read this!        // *** I, too, have no idea what happens here.//Theta_1=AngleZero2Pi(asin(rUnitVect(3)/sin(inc))); //Quesion as above//Theta_2=AngleZero2Pi(pi-asin(rUnitVect(3)/sin(inc)));//Theta_3=AngleZero2Pi(acos(ThetaUnitVect(3)/sin(inc)));//Theta_4=AngleZero2Pi(-acos(ThetaUnitVect(3)/sin(inc)));//ThetaSet1=round(1000*[Theta_1,Theta_2])/1000; //Quesion as above//ThetaSet2=round(1000*[Theta_3,Theta_4])/1000;//[val,ia,ib]=intersect(ThetaSet1,ThetaSet2); //Quesion as above//Theta=ThetaSet1(ia); //Quesion as above//ArgPeri=Theta-TrueAnom; //If I could figure out the above, this might make sense!//some stuff will go here to draw the elipse/orbits. I\u0027ll tackle that later, after I make sense of the rest.\n\n    void FixedUpdate(){    //Get every object     GameObject[] Objects = GameObject.FindGameObjectsWithTag(\u0022Star\u0022); //This runs too often. Extract to Start() later to optimize.            // *** Am I right that the amount of \u0027Star\u0027 objects don\u0027t change while playing? In that case it might be a good idea to only            // *** search for them once and put the result into an array.    //the gravity between each couple of object is calculated    foreach (GameObject ObjectA in Objects)    {        foreach (GameObject ObjectB in Objects)                // *** Two nested loops are bad if there are a lot of objects because they need a runtime of (number of objects)^2.                // *** You can do this when you know the number of objects stays small.        {            //Objects must not self interact             if (ObjectA == ObjectB)                continue;            ApplyGravity(ObjectA.GetComponent(), ObjectB.GetComponent()); //should store these GetComponents, they run too often.                    // *** Same as above. If the objects don\u0027t get replaced during play, store them into a property or something like that to avoid using the methods.        }    }}\n\nIf you want to understand what you are calculating then read a book about the prediction calculation of an orbit. Whoever wrote the MATLAB code did the same thing. A lot of that stuff is weird for me, too.\n\n**Edited \u003Ctime datetime=\u00222015-04-17T01:13:53Z\u0022 title=\u002204/17/2015 01:13  AM\u0022 data-short=\u00229 yr\u0022\u003EApril 17, 2015\u003C/time\u003E by \\*Aqua\\***"},{"CreatedByName":"Corbald","CreatedById":2219,"CreatedDateTime":"2015-04-17T02:50:34Z","Content":"Hey Aqua, thanks for the response. Looks like I need to know how AngleZero2Pi works. Hopefully someone that understands the maths can help me figure that out. Unfortunately, I can\u0027t learn from math books, as previous experience has taught me. My mind can\u0027t stay focused to that degree. I HAVE, however, primed myself with a bit of understanding from the helpful folks who air lessons on Youtube. That said, I\u0027m not going to understand it until I put it in practice. Thus this endeavor.\n\nSo, the questions remaining are:\n\nHow do these work?\n\n    //longAscNode_1=AngleZero2Pi(asin(hUnitVect(1)/sin(inc))); //is AngleZero2Pi a matlab function? what is this?        // *** couldn\u0027t find that in the documentation, must be a custom method or from an old MATLAB version//longAscNode_2=AngleZero2Pi(pi-asin(hUnitVect(1)/sin(inc)));//longAscNode_3=AngleZero2Pi(acos(-hUnitVect(2)/sin(inc)));//longAscNode_4=AngleZero2Pi(-acos(-hUnitVect(2)/sin(inc)));\n\nAnd:\n\n    //[val,ia,ib]=intersect(longAscNodeSet1,longAscNodeSet2); //am I finding the intersection of two vector2\u0027s? I don\u0027t know how to read this!        // *** foo[a, b, c] is an array: \u0027foo\u0027 is the name of it, abc are the names of three elements inside the array.        // *** The named elements allow direct access to array element.        // *** Therefore [val,ia,ib] is an unnamed array with three elements, named val, ia and ib.//longAscNode=longAscNodeSet1(ia); //I don\u0027t know how to read this!        // *** I, too, have no idea what happens here.\n\nif longAscNodeSet1 and longAscNodeSet2 are vector2\u0027s, then [val,ia,ib] should be a vector2, but it\u0027s got three elements. what the heck is \u0027val\u0027? If it IS a vector 2, then longAscNodeSet1(ia) should be something like longAscNodeSet1.x, riiiight?\n\n\\*Later\\*, I found this for [val,ia,ib]=intersect(longAscNodeSet1,longAscNodeSet2):\n\n    Define two vectors with values in common.A = [7 1 7 7 4]; B = [7 0 4 4 0];Find the values common to both A and B, as well as the index vectors ia and ib, such that C = A(ia) and C = B(ib).[C,ia,ib] = intersect(A,C =     4     7ia =     5     1ib =     3     1\n\nWorst case: I write a function which does this, myself. Does unity do anything like this, built in? I\u0027ll run with the assumption that it does not (since I can\u0027t find anything in their docs) and code my own, but if anyone knows a shortcut, lemme know!\n\nThat just leaves AngleZero2Pi! Anyone have insight?"},{"CreatedByName":"Fel","CreatedById":57121,"CreatedDateTime":"2015-04-17T05:43:38Z","Content":"\u003E \n\u003E Hey Aqua, thanks for the response. Looks like I need to know how AngleZero2Pi works. Hopefully someone that understands the maths can help me figure that out. Unfortunately, I can\u0027t learn from math books, as previous experience has taught me. My mind can\u0027t stay focused to that degree. I HAVE, however, primed myself with a bit of understanding from the helpful folks who air lessons on Youtube. That said, I\u0027m not going to understand it until I put it in practice. Thus this endeavor.\n\u003E So, the questions remaining are:\n\u003E \n\u003E How do these work?\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E     //longAscNode_1=AngleZero2Pi(asin(hUnitVect(1)/sin(inc))); //is AngleZero2Pi a matlab function? what is this?        // *** couldn\u0027t find that in the documentation, must be a custom method or from an old MATLAB version//longAscNode_2=AngleZero2Pi(pi-asin(hUnitVect(1)/sin(inc)));//longAscNode_3=AngleZero2Pi(acos(-hUnitVect(2)/sin(inc)));//longAscNode_4=AngleZero2Pi(-acos(-hUnitVect(2)/sin(inc)));\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E And:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E     //[val,ia,ib]=intersect(longAscNodeSet1,longAscNodeSet2); //am I finding the intersection of two vector2\u0027s? I don\u0027t know how to read this!        // *** foo[a, b, c] is an array: \u0027foo\u0027 is the name of it, abc are the names of three elements inside the array.        // *** The named elements allow direct access to array element.        // *** Therefore [val,ia,ib] is an unnamed array with three elements, named val, ia and ib.//longAscNode=longAscNodeSet1(ia); //I don\u0027t know how to read this!        // *** I, too, have no idea what happens here.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E if longAscNodeSet1 and longAscNodeSet2 are vector2\u0027s, then [val,ia,ib] should be a vector2, but it\u0027s got three elements. what the heck is \u0027val\u0027? If it IS a vector 2, then longAscNodeSet1(ia) should be something like longAscNodeSet1.x, riiiight?\n\u003E \n\u003E \\*Later\\*, I found this for [val,ia,ib]=intersect(longAscNodeSet1,longAscNodeSet2):\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E     Define two vectors with values in common.A = [7 1 7 7 4]; B = [7 0 4 4 0];Find the values common to both A and B, as well as the index vectors ia and ib, such that C = A(ia) and C = B(ib).[C,ia,ib] = intersect(A,C =     4     7ia =     5     1ib =     3     1\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Worst case: I write a function which does this, myself. Does unity do anything like this, built in? I\u0027ll run with the assumption that it does not (since I can\u0027t find anything in their docs) and code my own, but if anyone knows a shortcut, lemme know!\n\u003E \n\u003E That just leaves AngleZero2Pi! Anyone have insight?\n\n[http://www.google.com/search?q=%2BAngleZero2Pi\u0026spell\u0026hl=en\u0026sa=X\u0026\u0026as_q\u0026nfpr=1](https://www.google.com/search?q=%2BAngleZero2Pi\u0026spell\u0026hl=en\u0026sa=X\u0026\u0026as_q\u0026nfpr=1)\n\nCustom function, my guess? some kind of wrap.\n\nAngle = 540; \n\nEquivalent Angle = 540 - 360 = 180\n\n[http://www.mathworks.com/help/map/ref/wraptopi.html](http://www.mathworks.com/help/map/ref/wraptopi.html)\n\n    longAscNodeSet1=round(1000*[longAscNode_1,longAscNode_2])/1000;longAscNodeSet2=round(1000*[longAscNode_3,longAscNode_4])/1000;[val,ia,ib]=intersect(longAscNodeSet1,longAscNodeSet2);longAscNode=longAscNodeSet1(ia);\n\nthis just says, stupidly (the performance gain for using SSE code is near zero) [actually, I would argue that it is worse off because it is bad SSE code]\n\n    if (longAscNode_1 == longAscNode_3 || longAscNode_1 == longAscNode_4) longAscNode = longAscNode_1;if (longAscNode_2 == longAscNode_3 || longAscNode_2 == longAscNode_4) longAscNode = longAscNode_2;Of course, \u0022if both\u0022 then you get a bug where longAscNode = [longAscNode_1, longAscNode_2]\n\n**Edited \u003Ctime datetime=\u00222015-04-17T05:56:26Z\u0022 title=\u002204/17/2015 05:56  AM\u0022 data-short=\u00229 yr\u0022\u003EApril 17, 2015\u003C/time\u003E by Fel**"},{"CreatedByName":"Corbald","CreatedById":2219,"CreatedDateTime":"2015-04-17T14:27:23Z","Content":"Fel, Aqua, you two are CHAMPS! Chuck Norris aspires to be like you! This should be enough for me to get something working!\n\nFel, I should have realized that the longAscNode gobbledygook was if\u0027s. Makes sense when you run numbers through it! DOH! The Lambda wrapping function would have kept me guessing for weeks! I kept getting lost in the interior of the function\u0027s argument calls! Thanks for clearing that up, especially."}]}