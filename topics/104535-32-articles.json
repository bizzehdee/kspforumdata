{"TopicId":104535,"ForumId":34,"TopicTitle":"1.1.2 Magic Smoke Industries Infernal Robotics 2.0.2","CreatedByName":"sirkut","CreatedById":57229,"CreatedDateTime":"2015-04-20T21:18:38Z","PageNum":32,"Articles":[{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-05T19:10:11Z","Content":"I don\u0027t know of any way to make the joints themselves less wobbly. I know the IR peeps have looked at it a few times over many months and there doesn\u0027t seem to be a solution, it\u0027s a KSP/unity engine thing as I recall. Something about the servo having to use a type of joint whose properties are set at a level that is inaccessible to modders."},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T06:08:37Z","Content":"I\u0027ve rewritten my code to use the KOS API and it is much nicer to read, but I have a problem: There doesn\u0027t seem to be a way to disengage limits when using the API, so calls to :moveto() always result in \u0022snapping\u0022 when the target position is approached at high accelerations  Example at end of post.\n\nI fear that the moveto() function is setting the limit and then just moving towards it, so disabling the limit wouldn\u0027t be possible, meaning there isn\u0027t a way to avoid the snapping when using the API. \n\nI know high accelerations are \u0022weird\u0022, but I don\u0027t think they should cause a problem. There\u0027s no problem when servos are starting to move, only when they are stopping. When decelerating to a limit, can\u0027t the speed of the servo calculated by the acceleration behaviour be clamped to a maximum no higher than the current speed? Maybe I should inform myself of the actual IR code. In any case, if there\u0027s no solution to be found then maybe an option to \u0022disable\u0022 the acceleration behaviour for a servo via the API/tweakable if desired?  \n\n    if acceleration = -1 {  // decelerating\n       servoSpeed = max(calculateAcceleratedSpeed(), currentServoSpeed); \n    }\n\nHere\u0027s the code:\n\n    declare s is addons:ir:allservos[0].\n    \n    declare ms is list(list(0, 1), list(90, 2), list(45, 1), list(-45, 2)).\n    declare i is 0.\n    \n    set s:acceleration to 500.\n    set s:speed to 1.\n    \n    until false {\tif not s:ismoving {\ts:moveto(ms[i][0], ms[i][1]).\tset i to i \u002B 1.\tif i = 3 { set i to 0. }}\n    }\n\n\u003Ciframe data-controller=\u0022core.front.core.autoSizeIframe\u0022 src=\u0022https://forum.kerbalspaceprogram.com/?app=core\u0026module=system\u0026controller=embed\u0026url=https%3A%2F%2Fgfycat.com%2FPoliticalSnarlingAztecant\u0026key=PoliticalSnarlingAztecant\u0022\u003E\u003C/iframe\u003E\n\n**Edited \u003Ctime datetime=\u00222016-03-06T07:06:22Z\u0022 title=\u002203/06/2016 07:06  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 6, 2016\u003C/time\u003E by allmhuran**"},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-06T07:38:44Z","Content":"Interpolator that accounts for acceleration has an edge case when servo approaches target position. Its not my code, but I\u0027ll take a look. For now you can try lower acceleration."},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T07:46:04Z","Content":"I hope a simple fix is as above.... ie, clamp the result of the declerated speed calculation to a maximum of the current speed (obv not for acceleration since that would clamp the speed to 0 and it would never accelerate!)   \n\nUnfortunately I can\u0027t use a lower acceleration. I need the servo speeds to move from point A to point B in a known time T (because I\u0027m trying to keep several servos in synch), which means I need to call moveto(B, abs(B - A) / T). If the servos have any appreciable acceleration or deceleration, then the calculation doesn\u0027t work. I could try to factor the acceleration and deceleration into the calculation but I expect this will be more work than KOS can do in one frame (especially since it introduces a dependency where the timing depends on the acceleration of the servo that will take the longest to accelerate/declerate, and... well it\u0027s just really complicated), which makes the point moot since the timing will be out if update ticks occur while the calculation is being done.\n\n**Edited \u003Ctime datetime=\u00222016-03-06T07:56:46Z\u0022 title=\u002203/06/2016 07:56  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 6, 2016\u003C/time\u003E by allmhuran**"},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-06T08:01:29Z","Content":"\u003E \n\u003E \n\u003E 11 minutes ago, allmhuran said:\n\u003E \n\u003E \n\u003E I hope a simple fix is as above.... ie, clamp the result of the declerated speed calculation to a maximum of the current speed (obv not for acceleration since that would clamp the speed to 0 and it would never accelerate!)   \n\u003E   \n\u003E \n\u003E Unfortunately I can\u0027t use a lower acceleration. I need the servo speeds to move from point A to point B in a known time T (because I\u0027m trying to keep several servos in synch), which means I need to call moveto(B, abs(B - A) / T). If the servos have any appreciable acceleration or deceleration, then the calculation doesn\u0027t work. I could try to factor the acceleration and deceleration into the calculation but I expect this will be more work than KOS can do in one frame (especially since it introduces a dependency where the timing depends on the acceleration of the servo that will take the longest to accelerate/declerate, and... well it\u0027s just really complicated), which makes the point moot since the timing will be out if update ticks occur while the calculation is being done.\n\u003E \n\nThere is also a problem of a Physics tick\n\n[https://github.com/MagicSmokeIndustries/InfernalRobotics/blob/develop/InfernalRobotics/InfernalRobotics/Command/Interpolator.cs#L133](https://github.com/MagicSmokeIndustries/InfernalRobotics/blob/develop/InfernalRobotics/InfernalRobotics/Command/Interpolator.cs#L133)\n\nAs you see here there is plenty of clamping but i believe the problem is with this 10% overhead, which gets noticeable at you level of acceleration"},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T08:04:58Z","Content":"Aww crap. Those damn physics ticks.  \n\nEdit: Hang on, that\u0027s just the returning out of the tick for the interpolator itself... surely a return from interpolator\u0027s update() doesn\u0027t force a return from the whole IR update(), preventing any other IR operations from occurring during that physics tick.... Again, I should probably look at the code myself to see all of this. But yeah, I definitely need to be able to move multiple servos in one tick.\n\n**Edited \u003Ctime datetime=\u00222016-03-06T08:07:24Z\u0022 title=\u002203/06/2016 08:07  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 6, 2016\u003C/time\u003E by allmhuran**"},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-06T08:06:47Z","Content":"\u003E \n\u003E \n\u003E Just now, allmhuran said:\n\u003E \n\u003E \n\u003E Aww crap. Those damn physics ticks.\n\u003E \n\nYou see from the line I linked that [@pellinor](https://forum.kerbalspaceprogram.com/index.php?/profile/85299-pellinor/) left a very generous margin for edge case - I can lower it and give you a custom dll to test out"},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T08:09:58Z","Content":"Yeah I see the problem. It is being overly careful about overshooting. Erm, one sec, let me think on that for a moment."},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-06T08:13:17Z","Content":"he uses mavDeltaVel (derived from max acceleration) instead of current velocity, I think that is where the problem lies"},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T08:17:46Z","Content":"Yeah, it looks backwards. A higher acceleration should allow it to get *closer* to the limit before having to say \u0022I\u0027m probably going to cross the limit next frame, so just jump to the limit now\u0022. Ie, The better your brakes, the later you can hit them. But instead, a higher acceleration is causing it to jump to the limit earlier."},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-06T08:37:50Z","Content":"\u003E \n\u003E \n\u003E 19 minutes ago, allmhuran said:\n\u003E \n\u003E \n\u003E Yeah, it looks backwards. A higher acceleration should allow it to get *closer* to the limit before having to say \u0022I\u0027m probably going to cross the limit next frame, so just jump to the limit now\u0022. Ie, The better your brakes, the later you can hit them. But instead, a higher acceleration is causing it to jump to the limit earlier.\n\u003E \n\nTry this build (re-uploaded the new dll)\n\n[https://github.com/MagicSmokeIndustries/InfernalRobotics/releases/tag/0.21.5-pre](https://github.com/MagicSmokeIndustries/InfernalRobotics/releases/tag/0.21.5-pre)"},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T08:40:44Z","Content":"Roger, grabbing it now. I have an intuition that this can all be much simpler and yet more accurate, I\u0027m just trying to figure out the best solution ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022)"},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T08:49:32Z","Content":"Yep, that fixes it for arbitrarily large accelerations!"},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-06T08:50:47Z","Content":"\u003E \n\u003E \n\u003E Just now, allmhuran said:\n\u003E \n\u003E \n\u003E Yep, that fixes it for arbitrarily large accelerations!\n\u003E \n\nGreat. If you come up with a better algo feel free post here or as a github issue."},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T08:54:28Z","Content":"It doesn\u0027t seem necessary anymore ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022) But I might think about it for fun anyway.\n\nThanks yet again, by the way."},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T09:15:08Z","Content":"Let me show you how much that helps with servo synchronization. Here\u0027s three quick clips back to back. First the old code with 500 acceleration (lol), then the old code with 50 acceleration (wobbly because servos aren\u0027t synched), finally the new code with acceleration 2000 (smooooth).  \n\n\u003Ciframe data-controller=\u0022core.front.core.autoSizeIframe\u0022 src=\u0022https://forum.kerbalspaceprogram.com/?app=core\u0026module=system\u0026controller=embed\u0026url=http%3A%2F%2Fgfycat.com%2FSereneNaughtyAdmiralbutterfly\u0026key=SereneNaughtyAdmiralbutterfly\u0022\u003E\u003C/iframe\u003E\n\n**Edited \u003Ctime datetime=\u00222016-03-06T09:15:54Z\u0022 title=\u002203/06/2016 09:15  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 6, 2016\u003C/time\u003E by allmhuran**"},{"CreatedByName":"pellinor","CreatedById":85299,"CreatedDateTime":"2016-03-06T14:58:45Z","Content":"\u003E \n\u003E \n\u003E 6 hours ago, allmhuran said:\n\u003E \n\u003E \n\u003E Yeah I see the problem. It is being overly careful about overshooting. Erm, one sec, let me think on that for a moment.\n\u003E \n\nIn my understanding the underlying problem is that you are doing the interpolation yourself, and then the result is streamed to the IR interpolator which is told to come to a stop at each position.\n\nI think a cleaner way to handle this would be to offer a mode that tries to keep its target speed until reaching the target position, assuming he will get new commands on the fly. It would only brake after overshooting, or when approaching a hard limit. This could actually work without the realtime requirement of getting new positions every physics tick.\n\nAnother way is to disable/bypass the interpolation entirely (i.e. write positions directly). This is more or less what happens when you set huge acceleration values. There might still be a bit of weirdness here and there because it was not an intended use case when I wrote the interpolation code.\n\nOf course the silver bullet would be true synchronous interpolation, i.e. only one interpolator for a set of servos. You would give it a list of positions, then it would calculate its dynamics (maxSpeed/maxAcc) based on the distance and dynamics of the involved servos, and move them all in sync. This is pretty straightforward for basic linear motion, but can become a huge can of worms once you get nonlinear (e.g. change \u0027direction\u0027 without stopping).\n\nEdit: one more remark to the braking code: when determining maxSpeed from the distance to the limit, we are working on a SQRT curve, close to zero where it has a vertical tangent. So the problem is badly conditioned and the code for the last tick was done more or less by trial and error.\n\n**Edited \u003Ctime datetime=\u00222016-03-06T15:12:06Z\u0022 title=\u002203/06/2016 03:12  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 6, 2016\u003C/time\u003E by pellinor**"},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-06T15:05:07Z","Content":"\u003E \n\u003E \n\u003E 6 minutes ago, pellinor said:\n\u003E \n\u003E \n\u003E In my understanding the underlying problem is that you are doing the interpolation yourself, and then the result is streamed to the IR interpolator which is told to come to a stop at each position.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I think a cleaner way to handle this would be to offer a mode that tries to keep its target speed until reaching the target position, assuming he will get new commands on the fly. It would only brake after overshooting, or when approaching a hard limit. This could actually work without the realtime requirement of getting new positions every physics tick.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Another way is to disable/bypass the interpolation entirely (i.e. write positions directly). This is more or less what happens when you set huge acceleration values. There might still be a bit of weirdness here and there because it was not an intended use case when I wrote the interpolation code.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Of course the silver bullet would be true synchronous interpolation, i.e. only one interpolator for a set of servos. You would give it a list of positions, then it would calculate its dynamics (maxSpeed/maxAcc) based on the distance and dynamics of the involved servos, and move them all in sync. This is pretty straightforward for basic linear motion, but can become a huge can of worms once you get nonlinear (e.g. change \u0027direction\u0027 without stopping).\n\u003E \n\nHi, long time no see ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022) Here are the changes I made:\n\n[https://github.com/MagicSmokeIndustries/InfernalRobotics/pull/74/files#diff-e2ca92d8a9e6bebed32c75d95e97a475L133](https://github.com/MagicSmokeIndustries/InfernalRobotics/pull/74/files#diff-e2ca92d8a9e6bebed32c75d95e97a475L133)\n\nI moved the edge case check after the newVel is calculated and performed the check against it versus raw maxDeltaVel, which was too high in [@allmhuran](https://forum.kerbalspaceprogram.com/index.php?/profile/66124-allmhuran/)\u0027s case\n\nAs for option to disable the acceleration completely - I\u0027ll see whether it is possible to untie interpolation easily.\n\n**Edited \u003Ctime datetime=\u00222016-03-06T15:06:25Z\u0022 title=\u002203/06/2016 03:06  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 6, 2016\u003C/time\u003E by Ziw**"},{"CreatedByName":"pellinor","CreatedById":85299,"CreatedDateTime":"2016-03-06T15:30:45Z","Content":"\u003E \n\u003E \n\u003E 15 minutes ago, Ziw said:\n\u003E \n\u003E \n\u003E Hi, long time no see ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022) Here are the changes I made:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [https://github.com/MagicSmokeIndustries/InfernalRobotics/pull/74/files#diff-e2ca92d8a9e6bebed32c75d95e97a475L133](https://github.com/MagicSmokeIndustries/InfernalRobotics/pull/74/files#diff-e2ca92d8a9e6bebed32c75d95e97a475L133)\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I moved the edge case check after the newVel is calculated and performed the check against it versus raw maxDeltaVel, which was too high in [@allmhuran](https://forum.kerbalspaceprogram.com/index.php?/profile/66124-allmhuran/)\u0027s case\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E As for option to disable the acceleration completely - I\u0027ll see whether it is possible to untie interpolation easily.\n\u003E \n\nActually this is not an edge case but the end condition, i.e. the regular way of a servo to stop.\n\nIf maxDeltaVel was high, this means that the servo jumped to its commandPos in the old version. If the new version behaves differently, it does not consider the movement finished, and will be interrupted later by the next command. I guess this invalidates some of my considerations, in this case bypassing the interpolator will behave like the old version before your change."},{"CreatedByName":"allmhuran","CreatedById":66124,"CreatedDateTime":"2016-03-06T16:07:45Z","Content":"\u003E \n\u003E \n\u003E 58 minutes ago, pellinor said:\n\u003E \n\u003E \n\u003E \u003E \n\u003E \u003E \n\u003E \u003E 58 minutes ago, pellinor said:\n\u003E \u003E \n\u003E \u003E \n\u003E \u003E I think a cleaner way to handle this would be to offer a mode that tries to keep its target speed until reaching the target position, assuming he will get new commands on the fly. It would only brake after overshooting, or when approaching a hard limit. This could actually work without the realtime requirement of getting new positions every physics tick.\n\u003E \u003E \n\u003E \u003E \n\u003E \u003E \n\u003E \u003E \n\u003E \u003E Another way is to disable/bypass the interpolation entirely (i.e. write positions directly). This is more or less what happens when you set huge acceleration values. There might still be a bit of weirdness here and there because it was not an intended use case when I wrote the interpolation code.\n\u003E \u003E \n\u003E \u003E \n\u003E \u003E \n\u003E \u003E \n\u003E \u003E Of course the silver bullet would be true synchronous interpolation, i.e. only one interpolator for a set of servos. You would give it a list of positions, then it would calculate its dynamics (maxSpeed/maxAcc) based on the distance and dynamics of the involved servos, and move them all in sync. This is pretty straightforward for basic linear motion, but can become a huge can of worms once you get nonlinear (e.g. change \u0027direction\u0027 without stopping).\n\u003E \u003E\n\u003E \n\nYep, the non-linearity of the problem is what makes it very expensive to try to handle in kOS, hence the choice to turn in into a linear problem with a really high acceleration value - an unaccelerated mode, just as you\u0027ve described.  \n\nFor controlling the servos, my own algorithm takes a set of positions which it is going to cycle through. But before anything starts, I first create a smoothed set to use as the first argument for the move command: If the previous target, current target, and next target are all in order, I push the current target out to the next target. So, for example, an original set of positions {0, 20, 40, 50, 20, 30} is turned into {0, 40, 50, 50, 20, 30}, but the speed component still uses the orignal set. Ie, when moveto() is called, the speed is set so that the servo reaches the position of the original set in a specified time, but the servo \u0022limit\u0022 itself is set out beyond that point, so that if it gets there a little \u0022early\u0022 it is allowed to overshoot. In situations where it has to reverse, though, an overshoot is prevented. This can cause a slight jitter as a servo stops for a frame or two, but it\u0027s not too bad."},{"CreatedByName":"wjb55","CreatedById":149860,"CreatedDateTime":"2016-03-06T21:43:21Z","Content":"Hello, I was wondering if there was a chance for a variable geometry hinge like in the original damned robotics (I think it was that pack) so that aircraft such as the b1 or f14 become more viable"},{"CreatedByName":"V8jester","CreatedById":136093,"CreatedDateTime":"2016-03-06T22:36:03Z","Content":"\u003E \n\u003E \n\u003E 52 minutes ago, wjb55 said:\n\u003E \n\u003E \n\u003E Hello, I was wondering if there was a chance for a variable geometry hinge like in the original damned robotics (I think it was that pack) so that aircraft such as the b1 or f14 become more viable\n\u003E \n\nWelcome to the forum.\n\nYou can make a swept wing aircraft using the \u0022Docking washer\u0022 from the main IR Pack found **[Here](https://forum.kerbalspaceprogram.com/index.php?/topic/104535-105-magic-smoke-industries-infernal-robotics-0214/)**\n\nWhat I did in this video was, use a Docking Washer on each wing (Assembled one at a time. Docking washer\u0027s don\u0027t work using symmetry). Then I also used **[Quantum Struts](https://forum.kerbalspaceprogram.com/index.php?/topic/84630-105-quantumstrutscontinued-14-magical-struts-for-rigidifying-outside-the-vab/)** to secure the wings in either swept or forward positions.\n\n\u003Ciframe allowfullscreen=\u0022true\u0022 frameborder=\u00220\u0022 height=\u0022270\u0022 src=\u0022https://www.youtube.com/embed/3yGxv_NeJVM?feature=oembed\u0022 width=\u0022480\u0022\u003E\u003C/iframe\u003E\n\n**Edited \u003Ctime datetime=\u00222016-03-06T22:37:11Z\u0022 title=\u002203/06/2016 10:37  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 6, 2016\u003C/time\u003E by V8jester**"},{"CreatedByName":"wjb55","CreatedById":149860,"CreatedDateTime":"2016-03-06T22:40:03Z","Content":"Ah thank you I will try that tomorrow as I used just the regular hinges you can probably guess how that turned out"},{"CreatedByName":"ss8913","CreatedById":94747,"CreatedDateTime":"2016-03-07T00:30:59Z","Content":"I\u0027m having a lot of trouble with the structural strength of these parts.  I wanted to make a crane that could load/unload a 3.75m Kontainer of heavy goods from a spaceplane to a mining base.  I counterweighted it with a big tank of water for ballast.  looked great in VAB.  When I launched it, all of the telescopic pistons just collapsed under the weight and the whole thing, plus the launchpad, just exploded.  The rotatrons also seem to have very weak structural strength.  I\u0027m already using Kerbal Joint Reinforcement.  Is there any solution to this?  I need a \\*heavy\\* cargo crane, we\u0027re talking about moving 200t of cargo at a time here (3.75m Kontainers hold a lot!)"},{"CreatedByName":"Ziw","CreatedById":135292,"CreatedDateTime":"2016-03-07T07:56:00Z","Content":"\u003E \n\u003E \n\u003E 7 hours ago, ss8913 said:\n\u003E \n\u003E \n\u003E I\u0027m having a lot of trouble with the structural strength of these parts.  I wanted to make a crane that could load/unload a 3.75m Kontainer of heavy goods from a spaceplane to a mining base.  I counterweighted it with a big tank of water for ballast.  looked great in VAB.  When I launched it, all of the telescopic pistons just collapsed under the weight and the whole thing, plus the launchpad, just exploded.  The rotatrons also seem to have very weak structural strength.  I\u0027m already using Kerbal Joint Reinforcement.  Is there any solution to this?  I need a \\*heavy\\* cargo crane, we\u0027re talking about moving 200t of cargo at a time here (3.75m Kontainers hold a lot!)\n\u003E \n\nPlease try using Zodius reworked parts (linked multiple times here), they are reported to be a bit less wonky. Also you may want to scale up some parts, because original ones are not designed to hold such weights."}]}