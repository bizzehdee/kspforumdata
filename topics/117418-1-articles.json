{"TopicId":117418,"ForumId":16,"TopicTitle":"incorrect stage only- resources?","CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-01T20:45:33Z","PageNum":1,"Articles":[{"CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-01T20:45:33Z","Content":"I have a problem with the resource display, it\u0027s telling me I have the next stage\u0027s tanks in use for the current stage as well. As far as I can see I have the stages set up correctly and I re-built the bottom stages in vab to make sure, but the problem persists :/ In every other way, the craft works, this is a nuisance because I need to see how much fuel I have in the current stage, otherwise the kOS staging logic won\u0027t work, not easily at least. Help?\n\n![QJQeu-bMcXKve0ewZONzFtWmRHN-8w7z0mAJXtkHVHw=w1623-h993-no](https://lh3.googleusercontent.com/QJQeu-bMcXKve0ewZONzFtWmRHN-8w7z0mAJXtkHVHw=w1623-h993-no)\n\n**Edited \u003Ctime datetime=\u00222015-08-04T09:02:56Z\u0022 title=\u002208/04/2015 09:02  AM\u0022 data-short=\u00228 yr\u0022\u003EAugust 4, 2015\u003C/time\u003E by kurja**"},{"CreatedByName":"AlanP","CreatedById":148656,"CreatedDateTime":"2015-08-01T21:48:33Z","Content":"That has been broken since I\u0027ve been playing, two year now. I can only assume that someone has submitted a bug report and they have not found it to be a priority yet or they just forgot about it."},{"CreatedByName":"AlanP","CreatedById":148656,"CreatedDateTime":"2015-08-01T21:56:49Z","Content":"with the stage only not working, could you read the total fuel and subtract the stages fuel in some kind of if then check. I don\u0027t use Kos so it\u0027s just a suggestion. I just looked at the Kos command list you might have to you it as a function of mass. Hope it helps."},{"CreatedByName":"AlanP","CreatedById":148656,"CreatedDateTime":"2015-08-01T22:01:39Z","Content":"Here\u0027s a link to a command that may help\n\n[http://ksp-kos.github.io/KOS_DOC/bindings.html#stage](http://ksp-kos.github.io/KOS_DOC/bindings.html#stage)"},{"CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-02T07:48:23Z","Content":"\u003E \n\u003E Here\u0027s a link to a command that may help\n\u003E [http://ksp-kos.github.io/KOS_DOC/bindings.html#stage](http://ksp-kos.github.io/KOS_DOC/bindings.html#stage)\n\nThat\u0027s what I used and it returns the same (incorrect) value as shown in the gui. There are ofc other ways to check for when to stage but for a generic solution stage:liquidfuel would be the best, as timers or such would always be launcher-specific."},{"CreatedByName":"AlanP","CreatedById":148656,"CreatedDateTime":"2015-08-02T16:51:29Z","Content":"what I was suggesting is use current fuel - 220 to exclude the next stage as the4 trigger. \n\na picture of the script would be helpful and what it is returning.\n\n- - - Updated - - -\n\nTry this \n\n IF STAGE:LIQUIDFUEL \u003C 220.1"},{"CreatedByName":"Kryxal","CreatedById":102688,"CreatedDateTime":"2015-08-02T23:31:35Z","Content":"What happens if you redo the staging to have decouplers as their own stage?"},{"CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-03T04:20:25Z","Content":"\u003E \n\u003E what I was suggesting is use current fuel - 220 to exclude the next stage as the4 trigger. \n\u003E a picture of the script would be helpful and what it is returning.\n\u003E \n\u003E - - - Updated - - -\n\u003E \n\u003E Try this \n\u003E \n\u003E  IF STAGE:LIQUIDFUEL \u003C 220.1\n\nAnd when the next stage has only 180 units of fuel in it? There are ofc many workarounds but for a generic solution that could be used on different crafts, workarounds like that are... not really desirable.\n\nThat\u0027s (almost) exactly what I did though, in a separate staging code just for that one stage. If you\u0027re interested I can paste the code in the evening (7am in this part of the world now).\n\n- - - Updated - - -\n\n\u003E \n\u003E What happens if you redo the staging to have decouplers as their own stage?\n\nThanks for the idea, I have to try and see."},{"CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-03T14:13:18Z","Content":"\u003E \n\u003E What happens if you redo the staging to have decouplers as their own stage?\n\nYay, that works! Thanks ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)\n\nHere\u0027s the staging code I came up with so far:\n\n    //discarding solid boosterswhen stage:solidfuel \u003C 1 then {    stage.    print \u0022booster separation @ stage\u0022 \u002B stage:number.    print \u0022----------\u0022.}//staging. 1st line contains check for misbehaving resource indicatorwhen stage:liquidfuel \u003C 1 OR ((stage:number = 2) AND (stage:liquidfuel \u003C 181)) then {    stage.    print \u0022staged \u0022 \u002B stage:number.\tprint \u0022----------\u0022.    if stage:number \u003E 0 {\t\t\tpreserve.\t\t     }if stage:number \u003C 1 {\t\t\tprint \u0022last stage activated.\u0022.\t\t\tprint \u0022end staging check.\u0022.\t\t\tprint \u0022----------\u0022.\t\t }}"},{"CreatedByName":"AlanP","CreatedById":148656,"CreatedDateTime":"2015-08-03T16:42:56Z","Content":"Can you have it print the value of stage:liquidfuel to see what it is returning?"},{"CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-03T17:06:03Z","Content":"ofc. It returns the same value as is shown in stock gui."},{"CreatedByName":"AlanP","CreatedById":148656,"CreatedDateTime":"2015-08-04T02:40:45Z","Content":"It looks like your way should work. Either the math function is not working or there\u0027s some other syntax problem. You could try printing the result of the function to see what it is doing.\n\nI\u0027m not seeing\n\n print \u0022booster separation @ stage\u0022 \u002B stage:number.\n\n print \u0022----------\u0022.\n\nin your picture. Is this picture using the script you provided? What I\u0027m suggesting is it getting stuck after the last stage.\n\nI would post the question in the Kos forum."},{"CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-04T04:38:10Z","Content":"\u003E \n\u003E It looks like your way should work. Either the math function is not working or there\u0027s some other syntax problem. You could try printing the result of the function to see what it is doing.\n\nThe code I posted (with the extra check for the particular stage) does already work for this rocket, and better yet, as suggested in this thread moving the engines and decouplers in separate stages keeps the game from counting the next stage\u0027s fuel as belonging to the current stage. That requires other tweaks to the logic though.\n\n\u003E \n\u003E I\u0027m not seeing\n\u003E \n\u003E  print \u0022booster separation @ stage\u0022 \u002B stage:number.\n\u003E \n\u003E  print \u0022----------\u0022.\n\u003E \n\u003E in your picture. Is this picture using the script you provided? What I\u0027m suggesting is it getting stuck after the last stage.\n\nRocket in the picture didn\u0027t have solid boosters I think. Or the print command was not used on that flight. Either way that part of the code works as expected.\n\n\u003E I would post the question in the Kos forum.\n\nI really think this is a problem with KSP, not kOS. Since having the decouplers on their own stages sort of fixed the issue I\u0027m marking this as solved."},{"CreatedByName":"AlanP","CreatedById":148656,"CreatedDateTime":"2015-08-04T05:25:28Z","Content":"ok then I\u0027m on to other things.\n\nHave Fun!"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2015-08-04T08:40:21Z","Content":"\u003E \n\u003E The code I posted (with the extra check for the particular stage) does already work for this rocket, and better yet, as suggested in this thread moving the engines and decouplers in separate stages keeps the game from counting the next stage\u0027s fuel as belonging to the current stage. That requires other tweaks to the logic though.\n\u003E Rocket in the picture didn\u0027t have solid boosters I think. Or the print command was not used on that flight. Either way that part of the code works as expected.\n\u003E \n\u003E I really think this is a problem with KSP, not kOS. Since having the decouplers on their own stages sort of fixed the issue I\u0027m marking this as solved.\n\nYeah the problem has plagued us in kOS for ages and we knew it was the main stock game\u0027s fault but it\u0027s hard to get action on bugs that are discovered by a mod because the presumption is always that the mod \\*caused\\* the bug rather than that the mod just made the bug become properly detected and quantified.\n\nHistory: In the past, kOS did its own homebrewed \u0022how much resource in current stage\u0022 calculation, with a complex walk of the parts tree, which meant we had to reverse-engineer how SQUAD made complex things like fuel line hoses work and parts that connect but don\u0027t allow fuel (like struts). In so doing we got the feeling that our code was going to be super fragile and break with the next update, just because what the stock game was doing to handle things (especially the weird hack they did for fuel hoses) seemed like exactly the sort of spaghetti design that would be changed later and we were getting too dependent on making assumptions about the inner guts of the data structure - exactly the sort of thing that should be kept private (but wasn\u0027t) and masked behind an API intermediary layer. This made us nervous and so we switched to calling SQUAD\u0027s own built-in routines to get resources in stage instead of doing the work ourselves, with an eye toward future-compatibility.\n\nThis made it so things didn\u0027t break when there were massive overhauls to the fuel/resource system in later releases of KSP, which was good, but then meant we \u0022inherited\u0022 stock KSP\u0027s bugs in how it is calculating the stage resources. In other words, it\u0027s wrong, but at least its the SAME wrongness the stock game is giving, and not a new wrongness kOS is adding."},{"CreatedByName":"kurja","CreatedById":66303,"CreatedDateTime":"2015-08-04T09:02:42Z","Content":"You made the right call imho, KSP may (knock knock) eventually get fixed and in the meantime it\u0027s at least easy to troubleshoot stuff like this when the mod is using same numbers as the game itself."}]}