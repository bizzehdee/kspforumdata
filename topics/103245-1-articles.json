{"TopicId":103245,"ForumId":29,"TopicTitle":"Help with stopping part thumbnail model from changing when part is changed in editor","CreatedByName":"SuperRedNova","CreatedById":115837,"CreatedDateTime":"2015-04-02T16:07:07Z","PageNum":1,"Articles":[{"CreatedByName":"SuperRedNova","CreatedById":115837,"CreatedDateTime":"2015-04-02T16:07:07Z","Content":"\n\u003Cp\u003EI am making a part module that will change the color of one of a part\u0027s rendered meshes, but am getting an annoying bug where model in the preview thumbnail changes to the color of the part instance in the editor that was most recently changed. It is the right color (whatever is defined in the part.cfg) when first loading into the editor or spawning a new instance of the part, but then will still change afterwards. Any help I can get to fix this would be appreciated.\u003C/p\u003E\u003Cp\u003ESo far I have tried instantiating the part, both in onAwake() (makes it so that both the preview model and the part I\u0027m trying to change the color of don\u0027t change, until the part is loaded in a new scene) and in onStart() (bad idea, calls itself recursively), along with messing around with the prefabs, because I read that they have something to do with the preview model here, although I\u0027ve had no luck with this so far.\u003C/p\u003E\u003Cblockquote lang=\u0022en\u0022\u003E\u003Ca href=\u0022//imgur.com/a/RXgp2\u0022 rel=\u0022external nofollow\u0022\u003EJavascript is disabled. View full album\u003C/a\u003E\u003C/blockquote\u003E\u003Cp\u003E\u003C/p\u003E\u003Cblockquote\u003E\u003Cdiv\u003E\u003Cbr\u003Eusing System;using System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Enamespace KSPModelRocketry\u003Cbr\u003E{\u003Cbr\u003E public class VariableTexture : PartModule\u003Cbr\u003E {\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E public static float scale = 21;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E [KSPField(guiActiveEditor = true, guiName = \u0022Red\u0022, guiFormat = \u0022F2\u0022, isPersistant = true)]\u003Cbr\u003E [UI_FloatRange(minValue = 0, maxValue = 1, stepIncrement = .05f)]\u003Cbr\u003E public float red = 1f;\u003Cbr\u003E private float r;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E [KSPField(guiActiveEditor = true, guiName = \u0022Green\u0022, guiFormat = \u0022F2\u0022, isPersistant = true)]\u003Cbr\u003E [UI_FloatRange(minValue = 0, maxValue = 1, stepIncrement = .05f)]\u003Cbr\u003E public float green = 1f;\u003Cbr\u003E private float g;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E [KSPField(guiActiveEditor = true, guiName = \u0022Blue\u0022, guiFormat = \u0022F2\u0022, isPersistant = true)]\u003Cbr\u003E [UI_FloatRange(minValue = 0, maxValue = 1, stepIncrement = .05f)]\u003Cbr\u003E public float blue = 1f;\u003Cbr\u003E private float b;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E [KSPField]\u003Cbr\u003E public string textureMeshName = \u0022Variable\u0022;\u003Cbr\u003E public Mesh textureMesh;\u003Cbr\u003E public Renderer texRend;\u003Cbr\u003E public Material mat;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E [KSPField]\u003Cbr\u003E public bool newUV = true;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E public float updateDelay = 0;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E public override void OnAwake()\u003Cbr\u003E {\u003Cbr\u003E changeColor(true);\u003Cbr\u003E setUV(newUV);\u003Cbr\u003E base.OnAwake();\u003Cbr\u003E }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E /// \u0026lt;summary\u0026gt;\u003Cbr\u003E /// Raises the start event.\u003Cbr\u003E /// \u0026lt;/summary\u0026gt;\u003Cbr\u003E /// \u0026lt;param name=\u0022state\u0022\u0026gt;State.\u0026lt;/param\u0026gt;\u003Cbr\u003E public override void OnStart(StartState state)\u003Cbr\u003E {\u003Cbr\u003E changeColor(true);\u003Cbr\u003E setUV(newUV);\u003Cbr\u003E base.OnStart(state);\u003Cbr\u003E }\u003Cbr\u003E /// \u0026lt;summary\u0026gt;\u003Cbr\u003E /// Standardizes the uv coords of the mesh.\u003Cbr\u003E /// \u0026lt;/summary\u0026gt;\u003Cbr\u003E private void setUV(bool newUV)\u003Cbr\u003E {\u003Cbr\u003E if (textureMesh == null)\u003Cbr\u003E {\u003Cbr\u003E textureMesh = part.FindModelComponent\u0026lt;MeshFilter\u0026gt;(textureMeshName).mesh;\u003Cbr\u003E }\u003Cbr\u003E if (newUV)\u003Cbr\u003E {\u003Cbr\u003E Vector2[] uvs = new Vector2[textureMesh.vertices.Length];\u003Cbr\u003E for (int i = 0; i \u0026lt; uvs.Length; i\u002B\u002B)\u003Cbr\u003E {\u003Cbr\u003E int j = i % 4;\u003Cbr\u003E switch (j)\u003Cbr\u003E {\u003Cbr\u003E case 0:\u003Cbr\u003E uvs[i] = Vector2.zero;\u003Cbr\u003E break;\u003Cbr\u003E case 1:\u003Cbr\u003E uvs[i] = Vector2.up;\u003Cbr\u003E break;\u003Cbr\u003E case 2:\u003Cbr\u003E uvs[i] = Vector2.right;\u003Cbr\u003E break;\u003Cbr\u003E case 3:\u003Cbr\u003E uvs[i] = Vector2.one;\u003Cbr\u003E break;\u003Cbr\u003E }\u003Cbr\u003E }\u003Cbr\u003E textureMesh.uv = uvs;\u003Cbr\u003E }\u003Cbr\u003E }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E /// \u0026lt;summary\u0026gt;\u003Cbr\u003E /// Called every frame.\u003Cbr\u003E /// \u0026lt;/summary\u0026gt;\u003Cbr\u003E public void Update()\u003Cbr\u003E {\u003Cbr\u003E if (HighLogic.LoadedSceneIsEditor)\u003Cbr\u003E {\u003Cbr\u003E updateDelay -= Time.deltaTime;\u003Cbr\u003E if (updateDelay \u0026lt;= 0)\u003Cbr\u003E {\u003Cbr\u003E changeColor();\u003Cbr\u003E updateDelay = 0.02f;\u003Cbr\u003E }\u003Cbr\u003E }\u003Cbr\u003E }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E /// \u0026lt;summary\u0026gt;\u003Cbr\u003E /// Changes the color of a mesh of a part implementing this PartModlue based on it\u0027s red, green, and blue values.\u003Cbr\u003E /// \u0026lt;/summary\u0026gt;\u003Cbr\u003E public void changeColor(Boolean forceChange = false)\u003Cbr\u003E {\u003Cbr\u003E if (texRend == null)\u003Cbr\u003E {\u003Cbr\u003E texRend = part.FindModelComponent\u0026lt;Renderer\u0026gt;(textureMeshName);\u003Cbr\u003E mat = new Material(texRend.material.shader);\u003Cbr\u003E }\u003Cbr\u003E if (red != r | green != g | blue != b | forceChange)\u003Cbr\u003E {\u003Cbr\u003E r = red;\u003Cbr\u003E g = green;\u003Cbr\u003E b = blue;\u003Cbr\u003E Color color = new Color(r, g, \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_cool.png\u0022 alt=\u0022B)\u0022\u003E;\u003Cbr\u003E Texture2D tex = new Texture2D(10, 10);\u003Cbr\u003E Color[] colors = new Color[tex.height * tex.width];\u003Cbr\u003E for (int i = 0; i \u0026lt; colors.Length; i\u002B\u002B)\u003Cbr\u003E {\u003Cbr\u003E colors[i] = color;\u003Cbr\u003E }\u003Cbr\u003E tex.SetPixels(colors);\u003Cbr\u003E tex.Apply();\u003Cbr\u003E mat.mainTexture = tex;\u003Cbr\u003E texRend.material = mat;\u003Cbr\u003E if (forceChange)\u003Cbr\u003E {\u003Cbr\u003E print(\u0022[VariableTexture]:Changing Color! \u0022 \u002Bcolor);\u003Cbr\u003E }\u003Cbr\u003E }\u003Cbr\u003E }\u003Cbr\u003E }\u003Cbr\u003E}\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003C/blockquote\u003E\u003Cp\u003EEdit: was testing a little more and noticed that when you load in a vessel with multiple of the same part that implements the partmodule, they are all the same color. this was working before I added onAwake() (which I added to try and make the parts the right color in the editor) as seen here:\u003C/p\u003E\u003Cp\u003E\u003Cimg src=\u0022http://i.imgur.com/xL54br1.png\u0022 alt=\u0022xL54br1.png\u0022\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-04-02T16:55:10Z\u0022 title=\u002204/02/2015 04:55  PM\u0022 data-short=\u00229 yr\u0022\u003EApril 2, 2015\u003C/time\u003E by SuperRedNova\u003C/strong\u003E\n\u003Cbr\u003Eanother problem\n\u003C/span\u003E\n"},{"CreatedByName":"Crzyrndm","CreatedById":92871,"CreatedDateTime":"2015-04-02T19:12:39Z","Content":"\n\u003Cp\u003EI don\u0027t have any ideas about what the cause of your issue is, but there are a few odd things in that script\u003C/p\u003E\u003Cp\u003E1) Identical code in OnAwake and OnStart\u003C/p\u003E\u003Cp\u003EUse one or the other, there\u0027s no point using both for the same purposes. My intepretation of Awake in that it exists so you can ensure variables are initialised before other modules go looking for it in Start which just isn\u0027t an issue here\u003C/p\u003E\u003Cp\u003E2) The delay code in Update\u003C/p\u003E\u003Cp\u003EWhat is that for? If you want to skip a frame between running setColor, toggle a boolean or use a coroutine. That delay depends on Time.deltaTime being exactly what you expect it to be for any user which is not guaranteed\u003C/p\u003E\n"},{"CreatedByName":"SuperRedNova","CreatedById":115837,"CreatedDateTime":"2015-04-09T21:11:40Z","Content":"\n\u003Cp\u003EI\u0027ve since fixed this by setting the original texture to the desired color and getting rid of the onAwake method entirely, which isn\u0027t my prefered way but it gets the job done.\u003C/p\u003E\u003Cp\u003EMy logic for having both methods was this: just having onStart would leave the texture for the model in the thumbnail, so I had added the awake method, but I still needed the onstart method to try and set the color for each instance of the part that was on the vessel when loading in to a new scene. This ended up causing more problems then it solved, unfortunately.\u003C/p\u003E\u003Cp\u003EThanks for pointing out the delay code though, I had had it in there because I saw it in someone else\u0027s code that seemed like they were trying to do something similar, but now that I think about it isn\u0027t really needed.\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2015-04-09T23:55:32Z","Content":"\n\u003Cp\u003EUnity will try to \u003Ca href=\u0022http://docs.unity3d.com/ScriptReference/SerializeField.html\u0022 rel=\u0022external nofollow\u0022\u003Eserialize public fields\u003C/a\u003E and copy them to the new clone. This causes all of your clones to try to manipulate the same Renderer since your if statements will only cause a new Renderer and Material to be created once during the load screen. Make those fields private or mark them [DontSerialize], or rework your code to remove that kind of state checking logic\u003C/p\u003E\n"},{"CreatedByName":"SuperRedNova","CreatedById":115837,"CreatedDateTime":"2015-04-10T18:07:15Z","Content":"\n\u003Cp\u003EThat was exactly the information I needed, thank you.\u003C/p\u003E\n"}]}