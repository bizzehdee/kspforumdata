{"TopicId":135483,"ForumId":29,"TopicTitle":"Cannot figure out how to save, ScenarioModule keeps resetting!","CreatedByName":"TheBossk","CreatedById":161171,"CreatedDateTime":"2016-03-31T08:29:16Z","PageNum":1,"Articles":[{"CreatedByName":"TheBossk","CreatedById":161171,"CreatedDateTime":"2016-03-31T08:29:16Z","Content":"\n\u003Cp\u003E\nHi!\u00A0 This is my first post to this forum, so I hope everything is alright.\u00A0 I\u0027ve been searching here and on Google for a week and hit an enormous amount of dead ends.\n\u003C/p\u003E\n\u003Cp\u003E\nAs the title says, I\u0027ve hit a wall with the KSPScenario system, trying to save/load data from my mod.\u00A0 I have my save/load methods properly overridden in a ScenarioModule tagged with the KSPScenario attribute.\u00A0 I have a static Dictionary in another class with the data I want to save.\u00A0 Beyond there is where the problems begin.\n\u003C/p\u003E\n\u003Cp\u003E\nMy custom PartModule has to do some math upon startup to deduct resources.\u00A0 Initially I figured, great, I\u0027ll do it in OnStart.\u00A0 However, the Scenario Module always runs OnLoad after the PartModule\u0027s OnStart, loading data into memory from BEFORE the update.\u00A0 Here is the current flow:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E-- Flight Scene is loaded --\n\nPartModule.OnStart(..)\n  Check tracking info, which is already in memory, in State 1\n  Update tracking to State 2\n\nScenarioModule.OnLoad(..)\n  Loads tracking info still in State 1 - correct data is overridden!\n\nScenarioModule.OnSave(..)\n\nPartModule.FixedUpdate(..)\n  Sometimes starts as early as before ScenarioModule.OnLoad(..)\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nPartModule.OnStart takes the initial values (State 1), updates them (State 2), and then returns.\u00A0 When ScenarioModule.OnLoad is called, it overwrites the data, putting it back in State 1.\u00A0 Ideally OnLoad would only trigger when loading from a persistence file, but I haven\u0027t found a way to control for that.\n\u003C/p\u003E\n\u003Cp\u003E\nI have tried an enormous amount of workarounds, including:\n\u003C/p\u003E\n\u003Col\u003E\u003Cli\u003E\nManually invoke ScenarioModule.OnSave(..) at the end of OnStart with a modified, correct ConfigNode.\u00A0 OnLoad still loaded the stale data.\n\u003C/li\u003E\n\u003Cli\u003E\nMove OnStart logic to OnInitialize.\u00A0 This worked when loading a vessel already in flight, although OnInitialize started an indeterminate time after FixedUpdate began iterating.\u00A0 The problem arose when creating a new vessel (i.e. vessel rollout).\u00A0 There, OnInitialize was triggered so EARLY that the PartModule\u0027s reference to vessel was null.\n\u003C/li\u003E\n\u003Cli\u003E\nTry manually writing/loading to persistent.sfs at the end of OnStart, similar to item #1.\u00A0 Made me uneasy, but no matter - it didn\u0027t work anyway.\n\u003C/li\u003E\n\u003Cli\u003E\nTry waiting for FlightGlobals.ready before doing the initialization logic.\u00A0 This flag sometimes triggered before OnLoad, and sometimes after.\n\u003C/li\u003E\n\u003Cli\u003E\nBlock the loader and/or the game from proceeding until the other had reached an acceptable point.\u00A0 These worked in a vacuum, but are impossible to get working when multiple vessels are active, for the simple reason that I cannot tell whether OnLoad is simply loading from a scene change, or from a user-instigated persistence file load.\n\u003C/li\u003E\n\u003Cli\u003E\nManually modify the ScenarioModule\u0027s ConfigNode (via snapshot.GetData()).\n\u003C/li\u003E\n\u003Cli\u003E\nTweak the KSPScenario attributes.\u00A0 I\u0027ve tried just SpaceCenter, just PSystem (OnLoad/Save never fired), and the full collection of in-game scenes (SC, Tracking, Flight).\u00A0 The problem is that if I remove some of these scenes, then it will not load, but it also will not save.\u00A0 This was easily tested by trying to quicksave, then checking the log file.\n\u003C/li\u003E\n\u003Cli\u003E\nThrow an exception in OnLoad to manually check the stack track for \u0022GamePersistence.LoadGame.\u0022\u00A0 This would work for OnSave (which I don\u0027t need to touch), but for OnLoad the source is ScenarioRunner.AddModule every time.\n\u003C/li\u003E\n\u003Cli\u003E\n...and more\n\u003C/li\u003E\n\u003C/ol\u003E\u003Cp\u003E\nHow can I save data to the persistence file (using a ScenarioModule, I assume) without it being overwritten?\u00A0 I\u0027ve tried so many things at this point, I\u0027m starting to go crazy.\u00A0 It doesn\u0027t seem like anything involving the load sequence is deterministic.\n\u003C/p\u003E\n\u003Cp\u003E\nI also suspect (from the aforementioned stack traces) that the game is actually adding a new copy of the scenario to every scene via ScenarioRunner.AddModule.\u00A0 Even if I just specify one scene (e.g. GameScenes.SPACECENTER), it does this every time I load the SpaceCenter.\n\u003C/p\u003E\n\u003Cp\u003E\nEvery post I\u0027ve found says ScenarioModules are the way to go if saving data to the persistence file, but it seems like such a convoluted way to operate.\u00A0 On the other hand, I used to be load/saving via GameEvents.OnGameStateSaved.Add(..), and I suspect I\u0027d have the same problems there.\n\u003C/p\u003E\n\u003Cp\u003E\n...Bottom line is, I\u0027m just looking to save some data.\u00A0 Any feedback on how I can do that?\n\u003C/p\u003E\n\u003Cp\u003E\nThanks!\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-03-31T19:28:54Z\u0022 title=\u002203/31/2016 07:28  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 31, 2016\u003C/time\u003E by TheBossk\u003C/strong\u003E\n\u003Cbr\u003EClarified issue in early paragraph\n\u003C/span\u003E\n"},{"CreatedByName":"Crzyrndm","CreatedById":92871,"CreatedDateTime":"2016-03-31T09:57:53Z","Content":"\n\u003Cp\u003E\nSome more ideas:\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\n(probably) easy but slightly hacky way out, use a coroutine to delay the functionality currently executing in OnStart for 1-2 frames to put it after the scenarioModule is loaded\n\u003C/li\u003E\n\u003Cli\u003E\nAssign to a static variable in the scenario module from the partModule to tell it that data is already loaded and the data from OnLoad can be discarded\n\u003C/li\u003E\n\u003Cli\u003E\nRead through the source of scenario modules from other mods to see if any similar situations have already been dealt with(eg. \u003Ca href=\u0022https://github.com/ferram4/Ferram-Aerospace-Research/blob/master/FerramAerospaceResearch/FARSettingsScenarioModule.cs\u0022 rel=\u0022external nofollow\u0022\u003EFAR\u003C/a\u003E, TACLS, ...)\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\nIt sounds like you\u0027re trying to do something odd though as I\u0027m not quite grasping why the bad data is ever being used if it already has good data\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-03-31T09:59:27Z\u0022 title=\u002203/31/2016 09:59  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 31, 2016\u003C/time\u003E by Crzyrndm\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2016-03-31T13:43:07Z","Content":"\n\u003Cp\u003E\nI would need to see your code, especially the OnLoad method to help I think.\n\u003C/p\u003E\n\u003Cp\u003E\nBut can you change your design? By design I would expect data in the OnLoad method to override data in the OnStart method as presumably data being loaded from save is more correct. Where is the state 1 data in OnLoad coming from if you are not loading from a save file?\n\u003C/p\u003E\n\u003Cp\u003E\nThe other thing is to stick a Debug.Log line in each method. On issue I keep running into is that all these methods (Awake/Start/Load/Save) never seem to run in the order when I expect them to and I\u0027ve lost significant chunks of time trying to fix \u0022bugs\u0022 that were in fact just the methods not running at the time I expected them to.\n\u003C/p\u003E\n\u003Cp\u003E\nD.\n\u003C/p\u003E\n"},{"CreatedByName":"TheBossk","CreatedById":161171,"CreatedDateTime":"2016-03-31T19:20:30Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222484753\u0022 data-ipsquote-contentid=\u0022135483\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221459418273\u0022 data-ipsquote-userid=\u002292871\u0022 data-ipsquote-username=\u0022Crzyrndm\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n9 hours ago, Crzyrndm said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nSome more ideas:\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\n(probably) easy but slightly hacky way out, use a coroutine to delay the functionality currently executing in OnStart for 1-2 frames to put it after the scenarioModule is loaded\n\u003C/li\u003E\n\u003Cli\u003E\nAssign to a static variable in the scenario module from the partModule to tell it that data is already loaded and the data from OnLoad can be discarded\n\u003C/li\u003E\n\u003Cli\u003E\nRead through the source of scenario modules from other mods to see if any similar situations have already been dealt with(eg. \u003Ca href=\u0022https://github.com/ferram4/Ferram-Aerospace-Research/blob/master/FerramAerospaceResearch/FARSettingsScenarioModule.cs\u0022 rel=\u0022external nofollow\u0022\u003EFAR\u003C/a\u003E, TACLS, ...)\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\nIt sounds like you\u0027re trying to do something odd though as I\u0027m not quite grasping why the bad data is ever being used if it already has good data\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThanks for the suggestions!\u00A0 I\u0027ve already tried ideas #1 and #2, and they don\u0027t work because if the flight scene is already loaded, and another ship comes into focus (e.g. during a rendezvous), it will run OnStart, but not the scenario\u0027s load.\u00A0 No matter how you slice it, there are cases when either the part\u0027s OnStart or the scenario\u0027s OnLoad end up with a stale flag, and the code never reaches its proper state.\n\u003C/p\u003E\n\u003Cp\u003E\nI may have to read some existing code in detail.\u00A0 I\u0027ve so far tried to avoid that, since I\u0027m making a life support mod and I didn\u0027t want to end up implementing someone else\u0027s solutions/methods.\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027m not sure if this further clarifies what I\u0027m trying to do, but I\u0027m trying to store global info about how much life support is left in each Kerbal\u0027s suit.\u00A0 Maintaining a global dictionary makes it very easy to deduct, whether they are on EVA, or in a part with no life support remaining.\n\u003C/p\u003E\n\u003Cp\u003E\nThe fundamental problem is that the game loads vessels\u002Bparts, runs the parts\u0027 OnStart methods, THEN loads up the scenario.\u00A0 Ideally it would load everything (scenarios, vessels, etc.) first, then run the initialization (OnStart), and finally start running FixedUpdate.\u00A0 Unfortunately FixedUpdate\u0027s first frame is very non-deterministic.\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222485037\u0022 data-ipsquote-contentid=\u0022135483\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221459431787\u0022 data-ipsquote-userid=\u002281549\u0022 data-ipsquote-username=\u0022Diazo\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n5 hours ago, Diazo said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI would need to see your code, especially the OnLoad method to help I think.\n\u003C/p\u003E\n\u003Cp\u003E\nBut can you change your design? By design I would expect data in the OnLoad method to override data in the OnStart method as presumably data being loaded from save is more correct. Where is the state 1 data in OnLoad coming from if you are not loading from a save file?\n\u003C/p\u003E\n\u003Cp\u003E\nThe other thing is to stick a Debug.Log line in each method. On issue I keep running into is that all these methods (Awake/Start/Load/Save) never seem to run in the order when I expect them to and I\u0027ve lost significant chunks of time trying to fix \u0022bugs\u0022 that were in fact just the methods not running at the time I expected them to.\n\u003C/p\u003E\n\u003Cp\u003E\nD.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThanks for the reply.\n\u003C/p\u003E\n\u003Cp\u003E\nFor what it\u0027s worth, \u003Ca href=\u0022https://github.com/thebossk/SimpleSurvival/blob/427b887930eda98451079fd978ccf2feaba62df4/source/SimpleSurvival/SimpleSurvivalLoader.cs\u0022 rel=\u0022external nofollow\u0022\u003Ehere\u0027s a link to my loader\u003C/a\u003E.\u00A0 If you really want to poke around (which I\u0027d appreciate but wouldn\u0027t ask of you), SimpleSurvivalLoader calls EVALifeSupportTracker.Load(..), which maintains global tracking data in the form of a dictionary: [Kerbal name] -\u0026gt; [current EVA life support, max life support].\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/thebossk/SimpleSurvival/blob/427b887930eda98451079fd978ccf2feaba62df4/source/SimpleSurvival/LifeSupportModule.cs#L58\u0022 rel=\u0022external nofollow\u0022\u003EIn my PartModule\u0027s OnStart\u003C/a\u003E, I\u0027m checking lastUT (when the vessel was last loaded) and the current time, in order to deduct LifeSupport that was lost when the vessel was not loaded.\u00A0 The problem is that following this operation, the ScenarioModule is loading the tracking data that nullifies the resource drain.\u00A0 I have been trying to find the ConfigNode in memory that OnLoad access, but so far nothing has worked.\n\u003C/p\u003E\n\u003Cp\u003E\nI added the logging lines to all the startup methods (OnAwake, OnStart, OnLoad, OnInitialize, etc.) a while back and generated the output below.\u00A0 I didn\u0027t include FixedUpdate, because its start point was not deterministic.\n\u003C/p\u003E\n\u003Cp\u003E\nFYI, LSM == the PartModule that monitors life support.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E  OnAwake (LSM 1)\n  OnAwake (vessel, unloaded) ???\n  OnLoad (LSM 1)\n\n  OnAwake (LSM 2)\n  OnLoad (LSM 2)\n\n  OnStart (LSM 1)   \u0026lt;-----  This was modifying tracking data\n  OnStart (LSM 2)\n\n  SimpleSurvivalLoader.OnLoad()\n  \tEVALifeSupportTracker.Load()   \u0026lt;----   This was reloading stale data, undoing OnStart\u0027s changes\n\n  SimpleSurvivalLoader.OnSave()\n  \tEVALifeSupportTracker.Save()\n\n  OnInitialize (LSM 1)   \u0026lt;---- FOR FLIGHT ONLY. Loads before OnStart for VesselRollout.\n  OnInitialize (LSM 2)\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nAt this point, I\u0027m thinking that the only way this will work is if I move the global tracking data into the PartModules, and shuffle the tracking around as Kerbals move with GameEvents.onCrewTransfer.\u00A0 It seems like it may be a restriction that ScenarioModules are only useful for storing global data if it is considered read-only on load.\u00A0 But I\u0027ll have to check other mods to see if that\u0027s true.\n\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2016-03-31T20:18:00Z","Content":"\n\u003Cp\u003E\nOkay, looking at your program flow I think you need to make a design change.\n\u003C/p\u003E\n\u003Cp\u003E\nMy concern is that how can you have OnStart (LSM1) modifying data when the load has not finished yet? With how things are setup, the LSM partModule is deducting resources from an arbitrary amount as the ScenarioModule has not loaded yet so you the LSM OnStart is working with bad data.\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027d look at adding a OperationsQueue object to your \u003Cspan\u003EEVALifeSupportTracker\u003C/span\u003E class that the LSM partModules queue commands into, but only once the LS tracker is ready (so the load is finished) does it start processing the commands in the queue.\n\u003C/p\u003E\n\u003Cp\u003E\nSo the LSM\u0027s would go Queue.Add(Kerbal,Amount); and once it was finished loading, so probably in FixedUpdate, the LS tracker would check the Queue and process any commands present in it.\n\u003C/p\u003E\n\u003Cp\u003E\nD.\n\u003C/p\u003E\n"},{"CreatedByName":"Crzyrndm","CreatedById":92871,"CreatedDateTime":"2016-04-01T05:00:27Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222485773\u0022 data-ipsquote-contentid=\u0022135483\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221459452030\u0022 data-ipsquote-userid=\u0022161171\u0022 data-ipsquote-username=\u0022TheBossk\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n9 hours ago, TheBossk said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nThanks for the suggestions!\u00A0 I\u0027ve already tried ideas #1 and #2, and they don\u0027t work because if the flight scene is already loaded, and another ship comes into focus (e.g. during a rendezvous), it will run OnStart, but not the scenario\u0027s load.\u00A0 No matter how you slice it, there are cases when either the part\u0027s OnStart or the scenario\u0027s OnLoad end up with a stale flag, and the code never reaches its proper state.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThis is setting off all sorts of alarm bells for me (I haven\u0027t actually looked at the code linked at this stage)\n\u003C/p\u003E\n\u003Cp\u003E\nOriginally, my impression was that you wanted to load saved data before any operations were performed on it. Easy enough, delay Onstart() functionality using a coroutine. Once the data is loaded, we then let OnStart do its thing which then unlocks execution any other functions (eg. FixedUpdate).\u003Cbr\u003E\nNow you\u0027re saying that a craft loading into physics range that isn\u0027t the active vessel is a problem because scenario.OnLoad doesn\u0027t run at this time. That indicates to me that either scenario.OnLoad method is doing more than just unpackaging saved data, or the \u0022live\u0022 data is not always in the same location.\n\u003C/p\u003E\n\u003Cp\u003E\nI think Diazo is correct in recommending a design change, because something smells very fishy\n\u003C/p\u003E\n\u003Cp\u003E\nSomewhat obvious, but ensuring that the sequence is load-\u0026gt;start-\u0026gt;update is not difficult\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint prettyprinted\u0022\u003E\n\u003Cspan\u003ESave\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E:\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003EScenarioModule\u003C/span\u003E\u003Cspan\u003E\n\u003C/span\u003E\u003Cspan\u003E{\u003C/span\u003E\u003Cspan\u003E\n \u003C/span\u003E\u003Cspan\u003Epublic\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003Estatic\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003Ebool\u003C/span\u003E\u003Cspan\u003E hasLoaded \u003C/span\u003E\u003Cspan\u003E=\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003Efalse\u003C/span\u003E\u003Cspan\u003E;\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E// set true at end of OnLoad, set false by OnDestroy\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003E//...\u003C/span\u003E\u003Cspan\u003E\n\u003C/span\u003E\u003Cspan\u003E}\u003C/span\u003E\u003Cspan\u003E\n\n\u003C/span\u003E\u003Cspan\u003EModule\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E:\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003EPartModule\u003C/span\u003E\u003Cspan\u003E\n\u003C/span\u003E\u003Cspan\u003E{\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003Epublic\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003Ebool\u003C/span\u003E\u003Cspan\u003E hasStarted\u003C/span\u003E\u003Cspan\u003E;\u003C/span\u003E\u003Cspan\u003E\n \u003C/span\u003E\u003Cspan\u003Epublic\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003Evoid\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003EOnStart\u003C/span\u003E\u003Cspan\u003E(\u003C/span\u003E\u003Cspan\u003EStartState\u003C/span\u003E\u003Cspan\u003E)\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003E{\u003C/span\u003E\u003Cspan\u003E\n   \u003C/span\u003E\u003Cspan\u003Eif\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E(!\u003C/span\u003E\u003Cspan\u003ESave\u003C/span\u003E\u003Cspan\u003E.\u003C/span\u003E\u003Cspan\u003EhasLoaded\u003C/span\u003E\u003Cspan\u003E)\u003C/span\u003E\u003Cspan\u003E\n    \u003C/span\u003E\u003Cspan\u003EStartCoroutine\u003C/span\u003E\u003Cspan\u003E(\u003C/span\u003E\u003Cspan\u003Edelayed\u003C/span\u003E\u003Cspan\u003E);\u003C/span\u003E\u003Cspan\u003E\n   \u003C/span\u003E\u003Cspan\u003Eelse\u003C/span\u003E\u003Cspan\u003E\n     delayed\u003C/span\u003E\u003Cspan\u003E();\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003E}\u003C/span\u003E\u003Cspan\u003E\n  \n  \u003C/span\u003E\u003Cspan\u003Epublic\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003EIEnumerator\u003C/span\u003E\u003Cspan\u003E delayed\u003C/span\u003E\u003Cspan\u003E()\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003E{\u003C/span\u003E\u003Cspan\u003E\n    \u003C/span\u003E\u003Cspan\u003Ewhile\u003C/span\u003E\u003Cspan\u003E(!\u003C/span\u003E\u003Cspan\u003ESave\u003C/span\u003E\u003Cspan\u003E.\u003C/span\u003E\u003Cspan\u003EhasLoaded\u003C/span\u003E\u003Cspan\u003E)\u003C/span\u003E\u003Cspan\u003E\n      yield \u003C/span\u003E\u003Cspan\u003Ereturn\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E0\u003C/span\u003E\u003Cspan\u003E;\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E// I forget the exact syntax...\u003C/span\u003E\u003Cspan\u003E\n    \u003C/span\u003E\u003Cspan\u003E// stuff you wanted after load\u003C/span\u003E\u003Cspan\u003E\n    hasStarted \u003C/span\u003E\u003Cspan\u003E=\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003Etrue\u003C/span\u003E\u003Cspan\u003E;\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003E}\u003C/span\u003E\u003Cspan\u003E\n  \n  \u003C/span\u003E\u003Cspan\u003Epublic\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003Evoid\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003EFixedUpdate\u003C/span\u003E\u003Cspan\u003E()\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003E{\u003C/span\u003E\u003Cspan\u003E\n   \u003C/span\u003E\u003Cspan\u003Eif\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E(!\u003C/span\u003E\u003Cspan\u003EhasStarted\u003C/span\u003E\u003Cspan\u003E)\u003C/span\u003E\u003Cspan\u003E \u003C/span\u003E\u003Cspan\u003E// lock out fixed update until data has been loaded and processed\u003C/span\u003E\u003Cspan\u003E\n     \u003C/span\u003E\u003Cspan\u003Ereturn\u003C/span\u003E\u003Cspan\u003E;\u003C/span\u003E\u003Cspan\u003E\n    \u003C/span\u003E\u003Cspan\u003E// do stuff\u003C/span\u003E\u003Cspan\u003E\n  \u003C/span\u003E\u003Cspan\u003E}\u003C/span\u003E\u003Cspan\u003E\n\u003C/span\u003E\u003Cspan\u003E}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"TheBossk","CreatedById":161171,"CreatedDateTime":"2016-04-02T19:44:47Z","Content":"\n\u003Cp\u003E\nNot sure if I\u0027m responding to both of you directly.\u00A0 This is my first time using a message board like this.\u00A0 At any rate, I think I\u0027ve nailed it down, but first, my responses to both of you:\n\u003C/p\u003E\n\u003Cp\u003E\nStalling OnStart with a coroutine was originally what I tried (and I tried it a bunch of different ways), but the problem is twofold: PartModule.FixedUpdate may begin either before or after OnLoad, and OnLoad may not run at all.\u00A0 I don\u0027t remember whether I tried OnDestroy, although that is a good idea.\u00A0 Perhaps I\u0027ll perform that experiment if I have time and update this post.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cstrong\u003EThe solution, for anyone who stumbles across this\u003C/strong\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nThe solution seems to be using a KSPAddon instead of a ScenarioModule.\u00A0 This is what I was originally doing, but was having several problems with ConfigNodes at the time (my own doing), and decided a ScenarioModule would be easier.\u00A0 It turns out that I barely had to change anything moving back to an addon.\n\u003C/p\u003E\n\u003Cp\u003E\nBy plugging a KSPAddon method into GameEvents.onGameStateCreated, it will always load before PartModule.OnStart, which resolves any order-of-operations questions.\u00A0 I\u0027ve tested this switching from the tracking station to flight, quickloading from flight to flight, launching a new vessel, and loading a persistence file from the space center, but I\u0027ll update this post if I encounter any problems.\n\u003C/p\u003E\n\u003Cp\u003E\nHere\u0027s the loader mod-agnostic form:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E    [KSPAddon(KSPAddon.Startup.MainMenu, true)]\n    public class MyModLoader : MonoBehaviour\n    {\n        // The name of your mod\u0027s config node\n        // Use something descriptive, NOT \u0022MY_MOD\u0022\n        private const string TOPNAME = \u0022MY_MOD\u0022;\n\n        // Fire ONCE, hook routines into GameEvents\n        public void Awake()\n        {\n            KSPLog.Log(\u0022Loader Awake(..)\u0022);\n\n            GameEvents.onGameStateCreated.Add(OnLoad);\n            GameEvents.onGameStateSave.Add(OnSave);\n\n        }\n\n        public void OnSave(ConfigNode topnode)\n        {\n            KSPLog.Log(\u0022Loader OnSave(..)\u0022);\n\n            // ConfigNode should be in the process of being constructed\n            // from scratch, and not yet have the TOPNAME node\n            if (topnode.HasNode(TOPNAME))\n                KSPLog.Log(\u0022CheckThis -\u0026gt; Node \u0022 \u002B TOPNAME \u002B \u0022 already exists!\u0022);\n\n            ConfigNode mod_node = topnode.AddNode(TOPNAME);\n\n            EVALifeSupportTracker.Save(mod_node);\n            ContractChecker.Save(mod_node);\n        }\n\n        public void OnLoad(Game game)\n        {\n            KSPLog.Log(\u0022Loader OnLoad(..)\u0022);\n\n            // onGameStateCreated triggers OFTEN (including in the MainMenu scene)\n            // Have to make sure we\u0027ve actually loaded a game\n            if (!HighLogic.LoadedSceneIsGame)\n                return;\n            \n            ConfigNode mod_node;\n\n            // If this save is being loaded for the first time\n            // (b/c a new game was created OR the save\n            // previously did not have this mod installed),\n            // there is nothing to load, so create an empty node.\n            // It\u0027s up to each component loader to properly process\n            // an empty node and initialize its data.\n\n            if (game.config.HasNode(TOPNAME))\n                mod_node = game.config.GetNode(TOPNAME);\n            else\n                mod_node = new ConfigNode(TOPNAME);\n\n            EVALifeSupportTracker.Load(mod_node);\n            ContractChecker.Load(mod_node);\n        }\n    }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nI\u0027m not sure I understand the utility of ScenarioModules if their data isn\u0027t guaranteed to be loaded by the time FixedUpdate begins.\u00A0 Then again, I\u0027m looking for a very specific application, and ScenarioModule didn\u0027t fit the bill.\n\u003C/p\u003E\n\u003Cp\u003E\nThanks again \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022http://forum.kerbalspaceprogram.com/index.php?/profile/81549-diazo/\u0026amp;do=hovercard\u0022 data-mentionid=\u002281549\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/81549-diazo/\u0022\u003E@Diazo\u003C/a\u003E and \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022http://forum.kerbalspaceprogram.com/index.php?/profile/92871-crzyrndm/\u0026amp;do=hovercard\u0022 data-mentionid=\u002292871\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/92871-crzyrndm/\u0022\u003E@Crzyrndm\u003C/a\u003E for your input!\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-04-02T19:45:39Z\u0022 title=\u002204/02/2016 07:45  PM\u0022 data-short=\u00228 yr\u0022\u003EApril 2, 2016\u003C/time\u003E by TheBossk\u003C/strong\u003E\n\u003Cbr\u003ECleaned up code sample formatting\n\u003C/span\u003E\n"}]}