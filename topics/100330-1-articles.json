{"TopicId":100330,"ForumId":29,"TopicTitle":"Teleport active vessel to another vessel","CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-21T16:58:56Z","PageNum":1,"Articles":[{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-21T16:58:56Z","Content":"This is my first foray into plugin development and I know there are many plugins that do teleport stuff already, but this is a learning experience for me.\n\nEven after checking code from other plugins, I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2m having issues getting this to work\u00C3\u00A2\u00E2\u201A\u00AC\u00C2\u00A6\n\nI\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve built two \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153Jump Gates\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2 - Jump Gate LKO (in 100km orbit) \u0026 Jump Gate HKO (in 1000km orbit). Each of these has a Jump Gate Device part attached.\n\nI have player Ship in Kerbin orbit close to Jump Gate LKO.\n\nJump Gate Device on Jump Gate LKO has been assigned Jump Gate HKO as a destination via right-click menu.\n\nWith Player Ship active, I right click the Jump Gate Device attached to Jump Gate LKO and click \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153Jump\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2.\n\nWhat is supposed to happen:\n\nPlayer ship instantly teleports to Jump Gate HKO, matching its orbit. The player ship should teleport, the Jump Gates should not.\n\nWhat actually happens:\n\nPlayer ship does teleport to HKO, but the orbit is not set correctly - Player ship is now on escape trajectory. Furthermore - and this is the \\*really\\* strange bit - the Jump Gate HKO has also had its orbit changed; it\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2s also now on an escape trajectory too. Jump Gate LKO is fine though.\n\nHeres the relevant part of the code (part of \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153JumpDevice : PartModule\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2 class:\n\n        [KSPField(isPersistant = true, guiActive = true, guiName = \u0022Target\u0022)]    public string targetJumpGateName = \u0022Not set\u0022;    [KSPEvent(guiActiveUnfocused = true, externalToEVAOnly = false, unfocusedRange = 50f, guiName = \u0022Jump\u0022)]    public void JumpEvent() {        // At this point, targetJumpGateName has been set to a destination; i.e \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153Jump Gate HKO\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2.        Vessel targetJumpGate = findVesselByName(targetJumpGateName);        // Check the Jump Gate target vessel exists        if(targetJumpGate) {            // Check the Jump Gate target has a Jump Gate Device - i.e is it actually a Jump Gate            if(hasJumpGateDevice(targetJumpGate)) {                Vessel activeVessel = FlightGlobals.ActiveVessel;                activeVessel.GoOnRails();                // I probably need to add some distance between ship and jump gate so as not to collide, but for now they\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2re not                activeVessel.SetWorldVelocity(targetJumpGate.orbit.GetVel());                activeVessel.SetPosition(targetJumpGate.GetWorldPos3D());                activeVessel.GoOffRails();            } else {                // Target vessel does not have a Jump Gate Device part            }        } else {            // Target not found (might\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve been deleted)        }    }    public Vessel findVesselByName(string _name) {        List allVessels = FlightGlobals.Vessels;        foreach(var vessel in allVessels) {            if(vessel.GetName() == _name) {                return vessel;            }        }        return null;    }\n\nThe positioning code is based on plugin source I found here: [http://forum.kerbalspaceprogram.com/threads/16684-Hyperjump-System-Work-in-Progress-Models-wanted-Demo-Attached?highlight=teleport\u002Borbit](https://forum.kerbalspaceprogram.com/threads/16684-Hyperjump-System-Work-in-Progress-Models-wanted-Demo-Attached?highlight=teleport\u002Borbit)\n\nI\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve also tried creating a new orbit (see below) but I get the same problem (though this time its a sub-orbit straight into Kerbin, and the destination Jump Gate HKO still gets moved too, which it shouldn\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2t):\n\n        Orbit newOrbit = new Orbit(        targetJumpGate.orbit.inclination,        targetJumpGate.orbit.eccentricity,        targetJumpGate.orbit.semiMajorAxis,        targetJumpGate.orbit.LAN,        targetJumpGate.orbit.argumentOfPeriapsis,        targetJumpGate.orbit.meanAnomalyAtEpoch,        targetJumpGate.orbit.epoch - 1, // In theory this\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ll give us some distance so the ship doesn\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2t collide with the destination Jump Gate        targetJumpGate.orbit.referenceBody    );    activeVessel.orbitDriver.orbit = newOrbit;    activeVessel.orbitDriver.orbit.Init();    activeVessel.orbitDriver.orbit.UpdateFromUT(Planetarium.GetUniversalTime());\n\nThat orbit code is based on what I could find \u0026 understand of the HyperEdit source ([https://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs](https://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs)).\n\nSo I need help with two problems really:\n\n1. Getting the ship into a correct orbit nearby the destination Jump Gate\n\n2. Getting the destination Jump Gate to keep its damn orbit\n\nAny help would be much appreciated!\n\nThanks\n\nDave"},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2015-02-21T17:34:30Z","Content":"Check HyperEdit, it does that successfully. As far as I understand it simply edits orbit to match another body, with small difference in epoch."},{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-21T18:06:17Z","Content":"Thanks for the reply Sashan,\n\nI am already looking at the HyperEdit code; specifically here:\n\n[https://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs](https://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs)\n\nIn particular the \u0027HardsetOrbit\u0027 method. However, I must be missing something as when I use very similar code to what I find in HyperEdit, I still have the problem I mentioned above.\n\nI\u0027ll try looking over HyperEdit code again and see if I can disseminate the procedure it uses to get a stable orbit."},{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-22T11:17:16Z","Content":"I fixed it; I found that the problem was two-fold;\n\nFirst up, I needed to set the orbit of the vessel like I did in the second section of code I posted above. However, the line:\n\n        activeVessel.orbitDriver.orbit = newOrbit;\n\nwas doing too much; I only needed to copy certain properties of the orbit, not all of them. So that line is replaced with:\n\n        activeVessel.orbitDriver.orbit.inclination = newOrbit.inclination;    activeVessel.orbitDriver.orbit.eccentricity = newOrbit.eccentricity;    activeVessel.orbitDriver.orbit.semiMajorAxis = newOrbit.semiMajorAxis;    activeVessel.orbitDriver.orbit.LAN = newOrbit.LAN;    activeVessel.orbitDriver.orbit.argumentOfPeriapsis = newOrbit.argumentOfPeriapsis;    activeVessel.orbitDriver.orbit.meanAnomalyAtEpoch = newOrbit.meanAnomalyAtEpoch;    activeVessel.orbitDriver.orbit.epoch = newOrbit.epoch;    activeVessel.orbitDriver.orbit.referenceBody = newOrbit.referenceBody;\n\nIn addition to copying the orbit, I also needed to set the vessel position and velocity; like so:\n\n        // Add distance between player vessel and target jump gate (this is temporary, needs something more intelligent really)    Vector3d offset = new Vector3d(10, 0, 0);    // Set position and velocity of player    activeVessel.SetWorldVelocity(targetJumpGate.orbit.GetVel());    activeVessel.SetPosition(targetJumpGate.GetWorldPos3D() - offset);\n\nSince getting this to work I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve majorly refactored my code so the above is not quite what I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2m using right now. However I thought it\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2d be helpful to have this here nonetheless.\n\nIf/when I upload my Jump Gate plugin I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ll add a link to the full source here.\n\nDave"},{"CreatedByName":"lo-fi","CreatedById":111099,"CreatedDateTime":"2015-02-23T00:53:13Z","Content":"I\u0027m really interested to see your source, as I think it\u0027ll solve a few problems for a project of mine. Looking forward to the link ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)\n\nThanks for posting what you have already!"},{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-03-04T18:29:09Z","Content":"Hey\n\nI\u0027m looking forward to getting this mod working properly!\n\nI\u0027ve spent the past few days learning blender and have made a stock-ish looking Jump Device; this way you can build your own Jump Gate / Beacon out of your own parts rather than being stuck with just one model. You can also place multiple devices on one vessel so that it becomes a sort of intergalactic train station ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif)\n\nStill got one final problem to fix: the jump beacon you start from is still getting its orbit changed when the teleport completes. I\u0027ve still no idea why this is happening but I\u0027m working on it.\n\nIf I do get this thing working properly I\u0027ll post all the code with comments someplace and link it here!"}]}