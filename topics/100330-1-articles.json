{"TopicId":100330,"ForumId":29,"TopicTitle":"Teleport active vessel to another vessel","CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-21T16:58:56Z","PageNum":1,"Articles":[{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-21T16:58:56Z","Content":"\n\u003Cp\u003EThis is my first foray into plugin development and I know there are many plugins that do teleport stuff already, but this is a learning experience for me.\u003C/p\u003E\u003Cp\u003EEven after checking code from other plugins, I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2m having issues getting this to work\u00C3\u00A2\u00E2\u201A\u00AC\u00C2\u00A6\u003C/p\u003E\u003Cp\u003EI\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve built two \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153Jump Gates\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2 - Jump Gate LKO (in 100km orbit) \u0026amp; Jump Gate HKO (in 1000km orbit). Each of these has a Jump Gate Device part attached.\u003C/p\u003E\u003Cp\u003EI have player Ship in Kerbin orbit close to Jump Gate LKO.\u003C/p\u003E\u003Cp\u003EJump Gate Device on Jump Gate LKO has been assigned Jump Gate HKO as a destination via right-click menu.\u003C/p\u003E\u003Cp\u003EWith Player Ship active, I right click the Jump Gate Device attached to Jump Gate LKO and click \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153Jump\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2.\u003C/p\u003E\u003Cp\u003EWhat is supposed to happen:\u003C/p\u003E\u003Cp\u003EPlayer ship instantly teleports to Jump Gate HKO, matching its orbit. The player ship should teleport, the Jump Gates should not.\u003C/p\u003E\u003Cp\u003EWhat actually happens:\u003C/p\u003E\u003Cp\u003EPlayer ship does teleport to HKO, but the orbit is not set correctly - Player ship is now on escape trajectory. Furthermore - and this is the *really* strange bit - the Jump Gate HKO has also had its orbit changed; it\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2s also now on an escape trajectory too. Jump Gate LKO is fine though.\u003C/p\u003E\u003Cp\u003EHeres the relevant part of the code (part of \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153JumpDevice : PartModule\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2 class:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    [KSPField(isPersistant = true, guiActive = true, guiName = \u0022Target\u0022)]\u003Cbr\u003E    public string targetJumpGateName = \u0022Not set\u0022;\u003Cbr\u003E\u003Cbr\u003E    [KSPEvent(guiActiveUnfocused = true, externalToEVAOnly = false, unfocusedRange = 50f, guiName = \u0022Jump\u0022)]\u003Cbr\u003E    public void JumpEvent() {\u003Cbr\u003E\u003Cbr\u003E        // At this point, targetJumpGateName has been set to a destination; i.e \u00C3\u00A2\u00E2\u201A\u00AC\u00CB\u0153Jump Gate HKO\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2.\u003Cbr\u003E        Vessel targetJumpGate = findVesselByName(targetJumpGateName);\u003Cbr\u003E\u003Cbr\u003E        // Check the Jump Gate target vessel exists\u003Cbr\u003E        if(targetJumpGate) {\u003Cbr\u003E\u003Cbr\u003E            // Check the Jump Gate target has a Jump Gate Device - i.e is it actually a Jump Gate\u003Cbr\u003E            if(hasJumpGateDevice(targetJumpGate)) {\u003Cbr\u003E\u003Cbr\u003E                Vessel activeVessel = FlightGlobals.ActiveVessel;\u003Cbr\u003E\u003Cbr\u003E                activeVessel.GoOnRails();\u003Cbr\u003E\u003Cbr\u003E                // I probably need to add some distance between ship and jump gate so as not to collide, but for now they\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2re not\u003Cbr\u003E                activeVessel.SetWorldVelocity(targetJumpGate.orbit.GetVel());\u003Cbr\u003E                activeVessel.SetPosition(targetJumpGate.GetWorldPos3D());\u003Cbr\u003E\u003Cbr\u003E                activeVessel.GoOffRails();\u003Cbr\u003E\u003Cbr\u003E            } else {\u003Cbr\u003E\u003Cbr\u003E                // Target vessel does not have a Jump Gate Device part\u003Cbr\u003E            }\u003Cbr\u003E        } else {\u003Cbr\u003E\u003Cbr\u003E            // Target not found (might\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve been deleted)\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public Vessel findVesselByName(string _name) {\u003Cbr\u003E\u003Cbr\u003E        List\u0026lt;Vessel\u0026gt; allVessels = FlightGlobals.Vessels;\u003Cbr\u003E\u003Cbr\u003E        foreach(var vessel in allVessels) {\u003Cbr\u003E\u003Cbr\u003E            if(vessel.GetName() == _name) {\u003Cbr\u003E\u003Cbr\u003E                return vessel;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        return null;\u003Cbr\u003E    }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThe positioning code is based on plugin source I found here: \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/16684-Hyperjump-System-Work-in-Progress-Models-wanted-Demo-Attached?highlight=teleport\u002Borbit\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://forum.kerbalspaceprogram.com/threads/16684-Hyperjump-System-Work-in-Progress-Models-wanted-Demo-Attached?highlight=teleport\u002Borbit\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EI\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve also tried creating a new orbit (see below) but I get the same problem (though this time its a sub-orbit straight into Kerbin, and the destination Jump Gate HKO still gets moved too, which it shouldn\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2t):\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    Orbit newOrbit = new Orbit(\u003Cbr\u003E\u003Cbr\u003E        targetJumpGate.orbit.inclination,\u003Cbr\u003E        targetJumpGate.orbit.eccentricity,\u003Cbr\u003E        targetJumpGate.orbit.semiMajorAxis,\u003Cbr\u003E        targetJumpGate.orbit.LAN,\u003Cbr\u003E        targetJumpGate.orbit.argumentOfPeriapsis,\u003Cbr\u003E        targetJumpGate.orbit.meanAnomalyAtEpoch,\u003Cbr\u003E        targetJumpGate.orbit.epoch - 1, // In theory this\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ll give us some distance so the ship doesn\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2t collide with the destination Jump Gate\u003Cbr\u003E        targetJumpGate.orbit.referenceBody\u003Cbr\u003E    );\u003Cbr\u003E\u003Cbr\u003E    activeVessel.orbitDriver.orbit = newOrbit;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.Init();\u003Cbr\u003E    activeVessel.orbitDriver.orbit.UpdateFromUT(Planetarium.GetUniversalTime());\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThat orbit code is based on what I could find \u0026amp; understand of the HyperEdit source (\u003Ca href=\u0022https://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs\u003C/a\u003E).\u003C/p\u003E\u003Cp\u003ESo I need help with two problems really:\u003C/p\u003E\u003Cp\u003E1. Getting the ship into a correct orbit nearby the destination Jump Gate\u003C/p\u003E\u003Cp\u003E2. Getting the destination Jump Gate to keep its damn orbit\u003C/p\u003E\u003Cp\u003EAny help would be much appreciated!\u003C/p\u003E\u003Cp\u003EThanks\u003C/p\u003E\u003Cp\u003EDave\u003C/p\u003E\n"},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2015-02-21T17:34:30Z","Content":"\n\u003Cp\u003ECheck HyperEdit, it does that successfully. As far as I understand it simply edits orbit to match another body, with small difference in epoch.\u003C/p\u003E\n"},{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-21T18:06:17Z","Content":"\n\u003Cp\u003EThanks for the reply Sashan,\u003C/p\u003E\u003Cp\u003EI am already looking at the HyperEdit code; specifically here:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/Ezriilc/HyperEdit/blob/master/Model/OrbitEditor.cs\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EIn particular the \u0027HardsetOrbit\u0027 method. However, I must be missing something as when I use very similar code to what I find in HyperEdit, I still have the problem I mentioned above.\u003C/p\u003E\u003Cp\u003EI\u0027ll try looking over HyperEdit code again and see if I can disseminate the procedure it uses to get a stable orbit.\u003C/p\u003E\n"},{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-02-22T11:17:16Z","Content":"\n\u003Cp\u003EI fixed it; I found that the problem was two-fold;\u003C/p\u003E\u003Cp\u003EFirst up, I needed to set the orbit of the vessel like I did in the second section of code I posted above. However, the line:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    activeVessel.orbitDriver.orbit = newOrbit;\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Ewas doing too much; I only needed to copy certain properties of the orbit, not all of them. So that line is replaced with:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    activeVessel.orbitDriver.orbit.inclination = newOrbit.inclination;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.eccentricity = newOrbit.eccentricity;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.semiMajorAxis = newOrbit.semiMajorAxis;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.LAN = newOrbit.LAN;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.argumentOfPeriapsis = newOrbit.argumentOfPeriapsis;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.meanAnomalyAtEpoch = newOrbit.meanAnomalyAtEpoch;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.epoch = newOrbit.epoch;\u003Cbr\u003E    activeVessel.orbitDriver.orbit.referenceBody = newOrbit.referenceBody;\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EIn addition to copying the orbit, I also needed to set the vessel position and velocity; like so:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E\u003Cbr\u003E    // Add distance between player vessel and target jump gate (this is temporary, needs something more intelligent really)\u003Cbr\u003E    Vector3d offset = new Vector3d(10, 0, 0);\u003Cbr\u003E\u003Cbr\u003E    // Set position and velocity of player\u003Cbr\u003E    activeVessel.SetWorldVelocity(targetJumpGate.orbit.GetVel());\u003Cbr\u003E    activeVessel.SetPosition(targetJumpGate.GetWorldPos3D() - offset);\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003ESince getting this to work I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ve majorly refactored my code so the above is not quite what I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2m using right now. However I thought it\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2d be helpful to have this here nonetheless.\u003C/p\u003E\u003Cp\u003EIf/when I upload my Jump Gate plugin I\u00C3\u00A2\u00E2\u201A\u00AC\u00E2\u201E\u00A2ll add a link to the full source here.\u003C/p\u003E\u003Cp\u003EDave\u003C/p\u003E\n"},{"CreatedByName":"lo-fi","CreatedById":111099,"CreatedDateTime":"2015-02-23T00:53:13Z","Content":"\n\u003Cp\u003EI\u0027m really interested to see your source, as I think it\u0027ll solve a few problems for a project of mine. Looking forward to the link \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EThanks for posting what you have already!\u003C/p\u003E\n"},{"CreatedByName":"whoshotdk","CreatedById":115018,"CreatedDateTime":"2015-03-04T18:29:09Z","Content":"\n\u003Cp\u003EHey\u003C/p\u003E\u003Cp\u003EI\u0027m looking forward to getting this mod working properly!\u003C/p\u003E\u003Cp\u003EI\u0027ve spent the past few days learning blender and have made a stock-ish looking Jump Device; this way you can build your own Jump Gate / Beacon out of your own parts rather than being stuck with just one model. You can also place multiple devices on one vessel so that it becomes a sort of intergalactic train station \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/p\u003E\u003Cp\u003EStill got one final problem to fix: the jump beacon you start from is still getting its orbit changed when the teleport completes. I\u0027ve still no idea why this is happening but I\u0027m working on it.\u003C/p\u003E\u003Cp\u003EIf I do get this thing working properly I\u0027ll post all the code with comments someplace and link it here!\u003C/p\u003E\n"}]}