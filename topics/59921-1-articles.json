{"TopicId":59921,"ForumId":29,"TopicTitle":"Displaying Kerbals in IVA/EVA - Updated","CreatedByName":"Alskari","CreatedById":57638,"CreatedDateTime":"2014-01-14T03:28:00Z","PageNum":1,"Articles":[{"CreatedByName":"Alskari","CreatedById":57638,"CreatedDateTime":"2014-01-14T03:28:00Z","Content":"\n\u003Cp\u003EI have a mod oriented around hollow parts which allow players to create enclosed bases or ships for their kerbals to move around in. I\u0027m trying to alter the sfr code. Currently the IVA position and rotation is based off of the first part placed in the VAB. The code works perfectly if the command pod is the first thing used, however I would like to make it a bit more flexible. I\u0027ve posted the relevant bits of code below.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E/*\u003Cbr\u003E * sfr\u003Cbr\u003E * License: BY: Attribution-ShareAlike 3.0 Unported (CC BY-SA 3.0): http://creativecommons.org/licenses/by-sa/3.0/\u003Cbr\u003E */\u003Cbr\u003Eusing System;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003Eusing HSHModules.Extensions;\u003Cbr\u003Eusing KSP.IO;\u003Cbr\u003Eusing System.Collections;\u003Cbr\u003Eusing System.Collections.Generic;\u003Cbr\u003Eusing KSP;\u003Cbr\u003E\u003Cbr\u003Enamespace HSHModules\u003Cbr\u003E{\u003Cbr\u003E    public class FindTransform\u003Cbr\u003E    {\u003Cbr\u003E        private Transform f;\u003Cbr\u003E\u003Cbr\u003E        private Transform Find()\u003Cbr\u003E        {\u003Cbr\u003E            if (this.f)\u003Cbr\u003E                return this.f;\u003Cbr\u003E            else\u003Cbr\u003E                return (Transform)null;\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public class sfrUtility\u003Cbr\u003E    {\u003Cbr\u003E        public bool Found;\u003Cbr\u003E\u003Cbr\u003E        public static Camera FindCamera(string name)\u003Cbr\u003E        {\u003Cbr\u003E            foreach (Camera c in Camera.allCameras)\u003Cbr\u003E            {\u003Cbr\u003E                if (c.name == name)\u003Cbr\u003E                    return c;\u003Cbr\u003E            }\u003Cbr\u003E            return (Camera)null;\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public static int Find(Transform part, string name, ref List\u0026lt;Transform\u0026gt; aTransform)\u003Cbr\u003E        {\u003Cbr\u003E            IEnumerator enumerator = part.GetEnumerator();\u003Cbr\u003E            try\u003Cbr\u003E            {\u003Cbr\u003E                while (enumerator.MoveNext())\u003Cbr\u003E                {\u003Cbr\u003E                    Transform part1 = (Transform)enumerator.Current;\u003Cbr\u003E                    if (part1.name.StartsWith(name))\u003Cbr\u003E                        aTransform.Add(part1);\u003Cbr\u003E                    sfrUtility.Find(part1, name, ref aTransform);\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            finally\u003Cbr\u003E            {\u003Cbr\u003E                IDisposable disposable = enumerator as IDisposable;\u003Cbr\u003E                if (disposable != null)\u003Cbr\u003E                    disposable.Dispose();\u003Cbr\u003E            }\u003Cbr\u003E            return part.childCount;\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public static void ChangeLayer(Transform part, int layer)\u003Cbr\u003E        {\u003Cbr\u003E            if (!part)\u003Cbr\u003E                return;\u003Cbr\u003E            if (!part.camera)\u003Cbr\u003E                part.gameObject.layer = layer;\u003Cbr\u003E            IEnumerator enumerator = part.GetEnumerator();\u003Cbr\u003E            try\u003Cbr\u003E            {\u003Cbr\u003E                while (enumerator.MoveNext())\u003Cbr\u003E                    ChangeLayer((Transform)enumerator.Current, layer);\u003Cbr\u003E            }\u003Cbr\u003E            finally\u003Cbr\u003E            {\u003Cbr\u003E                IDisposable disposable = enumerator as IDisposable;\u003Cbr\u003E                if (disposable != null)\u003Cbr\u003E                    disposable.Dispose();\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public static Transform FindTransform(Transform transform1, string name)\u003Cbr\u003E        {\u003Cbr\u003E            if (transform1.name == name)\u003Cbr\u003E                return transform1;\u003Cbr\u003E            IEnumerator enumerator = transform1.GetEnumerator();\u003Cbr\u003E            try\u003Cbr\u003E            {\u003Cbr\u003E                while (enumerator.MoveNext())\u003Cbr\u003E                {\u003Cbr\u003E                    Transform transform = sfrUtility.FindTransform((Transform)enumerator.Current, name);\u003Cbr\u003E                    if (transform)\u003Cbr\u003E                        return transform;\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            finally\u003Cbr\u003E            {\u003Cbr\u003E                IDisposable disposable = enumerator as IDisposable;\u003Cbr\u003E                if (disposable != null)\u003Cbr\u003E                    disposable.Dispose();\u003Cbr\u003E            }\u003Cbr\u003E            return (Transform)null;\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public class sfrInternal : PartModule\u003Cbr\u003E    {\u003Cbr\u003E\u003Cbr\u003E        private Transform kspParent;\u003Cbr\u003E        private Vector3 kspPosition;\u003Cbr\u003E        private Quaternion kspRotation;\u003Cbr\u003E        private bool isActive;\u003Cbr\u003E        private bool packed;\u003Cbr\u003E\u003Cbr\u003E        public override void OnAwake()\u003Cbr\u003E        {\u003Cbr\u003E            base.OnAwake();\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public override void OnLoad(ConfigNode node)\u003Cbr\u003E        {\u003Cbr\u003E            base.OnLoad(node);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public override void OnSave(ConfigNode node)\u003Cbr\u003E        {\u003Cbr\u003E            base.OnSave(node);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public override void OnStart(PartModule.StartState state)\u003Cbr\u003E        {\u003Cbr\u003E            base.OnStart(state);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public override void OnUpdate()\u003Cbr\u003E        {\u003Cbr\u003E            base.OnUpdate();\u003Cbr\u003E\u003Cbr\u003E            if (!part.internalModel)\u003Cbr\u003E            {\u003Cbr\u003E                part.CreateInternalModel();\u003Cbr\u003E                part.vessel.SetActiveInternalPart(part);\u003Cbr\u003E                kspParent = part.transform;//InternalCamera.Instance.transform.parent;\u003Cbr\u003E                if (!part.internalModel)\u003Cbr\u003E                    part.internalModel.SetVisible(true);\u003Cbr\u003E                part.internalModel.transform.parent = part.transform;\u003Cbr\u003E                part.internalModel.transform.localRotation = new Quaternion(0.0f, 0.7f, -0.7f, 0.0f);\u003Cbr\u003E                part.internalModel.transform.localPosition = Vector3.zero;\u003Cbr\u003E                if (part.protoModuleCrew.Count \u0026gt; 0)\u003Cbr\u003E                {\u003Cbr\u003E                    part.internalModel.Initialize(part);\u003Cbr\u003E                    part.internalModel.enabled = true;\u003Cbr\u003E                    using (List\u0026lt;ProtoCrewMember\u0026gt;.Enumerator enumerator = ((List\u0026lt;ProtoCrewMember\u0026gt;)part.protoModuleCrew).GetEnumerator())\u003Cbr\u003E                    {\u003Cbr\u003E                        while (enumerator.MoveNext())\u003Cbr\u003E                        {\u003Cbr\u003E                            ProtoCrewMember current = enumerator.Current;\u003Cbr\u003E                            if (current.seat \u0026amp;\u0026amp; !part.vessel.packed)\u003Cbr\u003E                            {\u003Cbr\u003E                                current.seat.enabled = true;\u003Cbr\u003E                                current.seat.SpawnCrew();\u003Cbr\u003E                            }\u003Cbr\u003E                            if (current.KerbalRef)\u003Cbr\u003E                            {\u003Cbr\u003E                                current.KerbalRef.enabled = true;\u003Cbr\u003E                                current.KerbalRef.kerbalCam.cullingMask = 1;\u003Cbr\u003E                            }\u003Cbr\u003E                        }\u003Cbr\u003E                    }\u003Cbr\u003E                    using (List\u0026lt;InternalSeat\u0026gt;.Enumerator enumerator = part.internalModel.seats.GetEnumerator())\u003Cbr\u003E                    {\u003Cbr\u003E                        while (enumerator.MoveNext())\u003Cbr\u003E                        {\u003Cbr\u003E                            InternalSeat current = enumerator.Current;\u003Cbr\u003E                            if (current.kerbalRef)\u003Cbr\u003E                                current.SpawnCrew();\u003Cbr\u003E                            if (current.portraitCamera != null)\u003Cbr\u003E                                current.portraitCamera.cullingMask = 65537;\u003Cbr\u003E                        }\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            Exception exception;\u003Cbr\u003E            if (isActive != part.vessel.isActiveVessel \u0026amp;\u0026amp; !vessel.packed)\u003Cbr\u003E            {\u003Cbr\u003E                isActive = part.vessel.isActiveVessel;\u003Cbr\u003E                if (part.internalModel \u0026amp;\u0026amp; part.protoModuleCrew.Count \u0026gt; 0)\u003Cbr\u003E                {\u003Cbr\u003E                    part.vessel.SetActiveInternalPart(part);\u003Cbr\u003E                    part.internalModel.Initialize(part);\u003Cbr\u003E                    using (List\u0026lt;InternalSeat\u0026gt;.Enumerator enumerator = part.internalModel.seats.GetEnumerator())\u003Cbr\u003E                    {\u003Cbr\u003E                        while (enumerator.MoveNext())\u003Cbr\u003E                        {\u003Cbr\u003E                            InternalSeat current = enumerator.Current;\u003Cbr\u003E                            current.enabled = true;\u003Cbr\u003E                            if (current.portraitCamera)\u003Cbr\u003E                                current.portraitCamera.cullingMask = 1;\u003Cbr\u003E                        }\u003Cbr\u003E                    }\u003Cbr\u003E                    try\u003Cbr\u003E                    {\u003Cbr\u003E                        using (List\u0026lt;ProtoCrewMember\u0026gt;.Enumerator enumerator = part.protoModuleCrew.GetEnumerator())\u003Cbr\u003E                        {\u003Cbr\u003E                            while (enumerator.MoveNext())\u003Cbr\u003E                            {\u003Cbr\u003E                                ProtoCrewMember current = enumerator.Current;\u003Cbr\u003E                                if (current.seat \u0026amp;\u0026amp; !part.vessel.packed)\u003Cbr\u003E                                {\u003Cbr\u003E                                    current.seat.enabled = true;\u003Cbr\u003E                                    current.seat.SpawnCrew();\u003Cbr\u003E                                }\u003Cbr\u003E                                if (current.KerbalRef)\u003Cbr\u003E                                {\u003Cbr\u003E                                    current.KerbalRef.enabled = true;\u003Cbr\u003E                                    current.KerbalRef.kerbalCam.cullingMask = 1;\u003Cbr\u003E                                }\u003Cbr\u003E                            }\u003Cbr\u003E                        }\u003Cbr\u003E                    }\u003Cbr\u003E                    catch (Exception ex)\u003Cbr\u003E                    {\u003Cbr\u003E                        exception = ex;\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            try\u003Cbr\u003E            {\u003Cbr\u003E                if (sfrUtility.FindCamera(\u0022InternalCamera\u0022) \u0026amp;\u0026amp; part.vessel.isActiveVessel)\u003Cbr\u003E                {\u003Cbr\u003E                    sfrUtility.ChangeLayer(part.internalModel.transform, 16);\u003Cbr\u003E                    part.internalModel.transform.parent = kspParent;\u003Cbr\u003E                    part.internalModel.transform.localRotation = new Quaternion(0.0f, 0.7f, -0.7f, 0.0f); //Working at root\u003Cbr\u003E                    print(this.part.transform.localPosition.ToString());\u003Cbr\u003E                    kspPosition = this.part.transform.position - this.vessel.rootPart.transform.position;\u003Cbr\u003E                    part.internalModel.transform.position = new Vector3(kspPosition.x, kspPosition.y, kspPosition.z);  // Fairly certain these need to be reordered.\u003Cbr\u003E                    //part.internalModel.transform.localPosition = Vector3.zero; //Working at root\u003Cbr\u003E                    print(\u00221\u0022);\u003Cbr\u003E                }\u003Cbr\u003E                else\u003Cbr\u003E                {\u003Cbr\u003E                    sfrUtility.ChangeLayer(part.internalModel.transform, 0);\u003Cbr\u003E                    part.internalModel.SetVisible(true);\u003Cbr\u003E                    part.internalModel.gameObject.SetActive(true);\u003Cbr\u003E                    part.internalModel.transform.parent = part.transform;\u003Cbr\u003E                    part.internalModel.transform.localRotation = new Quaternion(0.0f, 0.7f, -0.7f, 0.0f);\u003Cbr\u003E                    part.internalModel.transform.localPosition = Vector3.zero;\u003Cbr\u003E                    print(\u00222\u0022);\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            catch (Exception ex)\u003Cbr\u003E            {\u003Cbr\u003E                exception = ex;\u003Cbr\u003E            }\u003Cbr\u003E            try\u003Cbr\u003E            {\u003Cbr\u003E                using (List\u0026lt;ProtoCrewMember\u0026gt;.Enumerator enumerator = part.protoModuleCrew.GetEnumerator())\u003Cbr\u003E                {\u003Cbr\u003E                    while (enumerator.MoveNext())\u003Cbr\u003E                    {\u003Cbr\u003E                        ProtoCrewMember current = enumerator.Current;\u003Cbr\u003E                        if (current.seat)\u003Cbr\u003E                        {\u003Cbr\u003E                            current.seat.enabled = true;\u003Cbr\u003E                            if (current.seat.portraitCamera)\u003Cbr\u003E                                current.seat.portraitCamera.cullingMask = (65537);\u003Cbr\u003E                        }\u003Cbr\u003E                        if (current.KerbalRef)\u003Cbr\u003E                        {\u003Cbr\u003E                            current.KerbalRef.enabled = true;\u003Cbr\u003E                            current.KerbalRef.kerbalCam.cullingMask = (65537);\u003Cbr\u003E                            if (current.KerbalRef.kerbalCamOverlay)\u003Cbr\u003E                                current.KerbalRef.kerbalCamOverlay.layer = 16;\u003Cbr\u003E                        }\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            catch (Exception ex)\u003Cbr\u003E            {\u003Cbr\u003E                exception = ex;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-03-31T04:17:06Z\u0022 title=\u002203/31/2014 04:17  AM\u0022 data-short=\u002210 yr\u0022\u003EMarch 31, 2014\u003C/time\u003E by Alskari\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"tygoo7","CreatedById":57345,"CreatedDateTime":"2014-01-14T03:34:42Z","Content":"\n\u003Cp\u003EI don\u0027t know anything about ksp modding but I think \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/24751-0-22-Version-0-04-sfr-Command-Pod-with-internal-parts-and-crew-visible-new-color\u0022 rel=\u0022external nofollow\u0022\u003Ethis mod\u003C/a\u003E might help.\u003C/p\u003E\n"},{"CreatedByName":"Alskari","CreatedById":57638,"CreatedDateTime":"2014-01-14T05:19:11Z","Content":"\n\u003Cp\u003EWow, I had played with this mod trying to get it to work back in September, thank you for pointing me to it again. I didn\u0027t realize it had been updated.\u003C/p\u003E\n"},{"CreatedByName":"Alskari","CreatedById":57638,"CreatedDateTime":"2014-01-26T21:11:00Z","Content":"\n\u003Cp\u003EOP updated. Help please.\u003C/p\u003E\n"},{"CreatedByName":"Ishkur","CreatedById":102933,"CreatedDateTime":"2014-02-10T00:58:28Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Alskari\u0022 data-cite=\u0022Alskari\u0022\u003E\u003Cdiv\u003EAdditionally exiting a part via the KerbalSeat module results in the kerbal being placed on the exterior of the vessel, which rules it out as a stopgap option.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ESorry if I\u0027m missing something apparent, but can\u0027t you put the hatch transform position on the inside of the module/model to get the kerbal to be placed where its needed?\u003C/p\u003E\n"},{"CreatedByName":"Alskari","CreatedById":57638,"CreatedDateTime":"2014-02-20T21:09:34Z","Content":"\n\u003Cp\u003EWhen seated the kerbal can be placed just fine. It\u0027s when the kerbal exits that the issue occurs. The stock code apparently determines the exit point for a kerbal based on the exterior most collision mesh of the entire vessel. I\u0027m trying to build hollow structures, so this results in kerbals teleporting outside after leaving a chair.\u003C/p\u003E\n"},{"CreatedByName":"Alskari","CreatedById":57638,"CreatedDateTime":"2014-02-25T21:01:33Z","Content":"\n\u003Cp\u003EAnyone else able to help? I\u0027ve tried altering the \u0027if (sfrUtility.FindCamera(\u0022InternalCamera\u0022))\u0027 contents, but to no avail. I\u0027m not understanding where it is changing the IVA position and rotation.\u003C/p\u003E\n"},{"CreatedByName":"LaydeeDem","CreatedById":5984,"CreatedDateTime":"2014-02-26T02:40:28Z","Content":"\n\u003Cp\u003EYou\u0027ll get a quicker answer in the #KSPModders IRC. Lots of nice and smart people.\u003C/p\u003E\n"},{"CreatedByName":"Alskari","CreatedById":57638,"CreatedDateTime":"2014-02-26T03:36:35Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Nutt007\u0022 data-cite=\u0022Nutt007\u0022\u003E\u003Cdiv\u003EYou\u0027ll get a quicker answer in the #KSPModders IRC. Lots of nice and smart people.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThey seem nice and smart, but I have yet to ever get an answer relating to code. I try for several consecutive days, get frustrated, leave and then repeat the cycle about every month.\u003C/p\u003E\n"}]}