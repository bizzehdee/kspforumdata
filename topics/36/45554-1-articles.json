{"TopicId":45554,"ForumId":36,"TopicTitle":"[WIP] Newtonian Orbital Mechanics plugin (maybe?)","CreatedByName":"Mattasmack","CreatedById":62809,"CreatedDateTime":"2013-09-10T22:04:05Z","PageNum":1,"Articles":[{"CreatedByName":"Mattasmack","CreatedById":62809,"CreatedDateTime":"2013-09-10T22:04:05Z","Content":"\n\u003Cp\u003EThis thread stems from a \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/showthread.php/49121-On-Newtonian-trajectories-vs-patched-conics\u0022 rel=\u0022external nofollow\u0022\u003Ethread\u003C/a\u003E I recently started in the general discussion forum. I believe that in terms of computational effort and numerical accuracy, it should be possible to calculate the trajectories of objects in KSP using Newtonian mechanics rather than Kepler\u0027s laws, and do so in a way that doesn\u0027t make things harder or more confusing for the average player. Naturally this is not something that the developers would tackle any time soon, and it was suggested that I should try implementing the idea in a mod first to see if it really can be done. So, here I am!\u003C/p\u003E\u003Cp\u003ENote that I am \u003Cstrong\u003Enot\u003C/strong\u003E talking about n-body simulations. I want to leave the planetary bodies alone, I just want vessels in space to be subject to gravity from multiple bodies at once. For that matter, as asmi suggested, I\u0027d be happy for starters to just be able to display the Newtonian trajectories in map view.\u003C/p\u003E\u003Cp\u003ESo, I have already the C\u002B\u002B code I wrote to do my little simulations to test the concept out, and that works reasonably well and is fast. It uses Dormand and Prince\u0027s RK5(4)7M scheme with an additional solution at the midpoint of the time step, per Shampine, which is used to calculate a 5th order interpolation function for location. I also added lookup tables for the planetary body locations that speeds the scheme up considerably (since calculating planetary body locations from Kepler orbital elements was the most costly part of the simulations).\u003C/p\u003E\u003Cp\u003EWhat I don\u0027t know anything about is modding KSP! I\u0027d appreciate any pointers regarding how to access things like the curves shown in map view, if it is indeed possible at all. Or if someone is interested with helping program the plugin, I\u0027m willing to share my code.\u003C/p\u003E\n"},{"CreatedByName":"Superfluous J","CreatedById":73725,"CreatedDateTime":"2013-09-10T22:24:40Z","Content":"\n\u003Cp\u003ESo you\u0027re talking that your orbit of each item will be affected by all major bodies in the game? That while I\u0027m orbiting Moho, a teeny tiny little bit of its orbit is affected by Laythe? This could become pretty processor intensive. Imagine having 30 missions and 100 pieces of debris all churning out a couple dozen of these calculations every tick!\u003C/p\u003E\u003Cp\u003EYou can simplify things, probably greatly, by utilizing the already-present Sphere Of Influence code. If your SOI is Sun, then each planet affects your orbit. Maybe each planet in this case would be the total mass of the planet and all moons, especially for Duna and Ike. Once you\u0027re in the SOI of a planet or a moon, Then it and its moons are separated so they affect you singly, but the other planets are still considered point objects. I don\u0027t think there\u0027s any situation (except maybe approaching Duna or Kerbin, or possibly Jool) where this would cause noticeable errors in the calculations, and you can fix the border cases by making those planets SOI\u0027s larger.\u003C/p\u003E\u003Cp\u003EI\u0027m excited about this concept. I\u0027d much rather have \u0022true\u0022 Newtonian orbits.\u003C/p\u003E\n"},{"CreatedByName":"OrbitusII","CreatedById":57305,"CreatedDateTime":"2013-09-10T22:33:31Z","Content":"\n\u003Cp\u003ESince the Unity Engine (and thus KSP) is written primarily in C#, all you need to do is convert to C# and the Unity syntax.\u003C/p\u003E\u003Cp\u003EHere\u0027s the script reference to get you started: \u003Ca href=\u0022http://docs.unity3d.com/Documentation/ScriptReference/\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://docs.unity3d.com/Documentation/ScriptReference/\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EThe KSP syntax is a little weird, but I wouldn\u0027t expect you to need it all that much for something that depends almost entirely on rigidbodies (which are core Unity components). We don\u0027t even have that much stuff to go off of, but it\u0027s available on the wiki if you need it.\u003C/p\u003E\u003Cp\u003EI\u0027d like to see what you can come up with, it was an interesting conversation to say the least. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"Mattasmack","CreatedById":62809,"CreatedDateTime":"2013-09-10T22:44:07Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u00225thHorseman\u0022 data-cite=\u00225thHorseman\u0022\u003E\u003Cdiv\u003ESo you\u0027re talking that your orbit of each item will be affected by all major bodies in the game? That while I\u0027m orbiting Moho, a teeny tiny little bit of its orbit is affected by Laythe? This could become pretty processor intensive. Imagine having 30 missions and 100 pieces of debris all churning out a couple dozen of these calculations every tick!\u003Cp\u003EYou can simplify things, probably greatly, by utilizing the already-present Sphere Of Influence code. If your SOI is Sun, then each planet affects your orbit. Maybe each planet in this case would be the total mass of the planet and all moons, especially for Duna and Ike. Once you\u0027re in the SOI of a planet or a moon, Then it and its moons are separated so they affect you singly, but the other planets are still considered point objects. I don\u0027t think there\u0027s any situation (except maybe approaching Duna or Kerbin, or possibly Jool) where this would cause noticeable errors in the calculations, and you can fix the border cases by making those planets SOI\u0027s larger.\u003C/p\u003E\u003Cp\u003EI\u0027m excited about this concept. I\u0027d much rather have \u0022true\u0022 Newtonian orbits.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EExactly. Since there are only 17 bodies in the Kerbol system, it\u0027s not unreasonable (and is simplest) to have each body influence each vessel all the time (within limitations -- see the original thread for more info, or \u003Ca href=\u0022http://www.roesle.org/cms25/index.php/projects/81-general/95-on-newtonian-trajectories-in-kerbal-space-program\u0022 rel=\u0022external nofollow\u0022\u003Ethis very long-winded article on my website\u003C/a\u003E for more on my no-man\u0027s-land concept for avoiding doing the calculations when in low orbits where they don\u0027t really matter). I have tried the simulations, and I can tell you the calculations are not that intensive. It is crucial to use at least a moderate-order integrator that allows long time steps to be taken. That way, for vessels that aren\u0027t under acceleration, a calculation only needs to be done every few tens of seconds (if in orbit around a planet) to every few millions of seconds (if in orbit around Kerbol in the outer solar system). The need for more calculations does grow with time warp, and they would need to be done continuously for a vessel that\u0027s accelerating.\u003C/p\u003E\u003Cp\u003EI have code for the trajectory calculation and interpolation that should be good enough for a proof-of-concept. (Though if it proves promising, higher-order integrators and schemes other than RK should be looked at, and approximations like what you suggest might prove to be necessary.) What I don\u0027t know is how to get it into a plugin for KSP, or if the necessary parts of KSP are even accessible to the modder.\u003C/p\u003E\n"},{"CreatedByName":"afranius","CreatedById":70322,"CreatedDateTime":"2013-09-11T00:05:21Z","Content":"\n\u003Cp\u003EWhy do you want such large time steps? There are only a few dozen gravity-producing bodies, you can probably do RK3 or something with a small step size and still comfortably run in real time. You might also want to read up on symplectic integrators if you want to preserve energy (you probably do). Having lots of ships in orbit might make things a bit more challenging, but probably not exceedingly so. At worst you might have to run the integrator in a parallel thread.\u003C/p\u003E\n"},{"CreatedByName":"Mihara","CreatedById":59752,"CreatedDateTime":"2013-09-11T00:30:39Z","Content":"\n\u003Cp\u003EI won\u0027t pretend to understand much about mathematics involved, but a thought for you: endeavour to do all the computations in a separate process if at all possible. \u003C/p\u003E\u003Cp\u003EThen, it will get offloaded to another core, and you will never be hurting for computational resources - almost all of us have several which KSP is not using.\u003C/p\u003E\n"},{"CreatedByName":"Mattasmack","CreatedById":62809,"CreatedDateTime":"2013-09-11T01:08:13Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022afranius\u0022 data-cite=\u0022afranius\u0022\u003E\u003Cdiv\u003EWhy do you want such large time steps? There are only a few dozen gravity-producing bodies, you can probably do RK3 or something with a small step size and still comfortably run in real time. You might also want to read up on symplectic integrators if you want to preserve energy (you probably do). Having lots of ships in orbit might make things a bit more challenging, but probably not exceedingly so. At worst you might have to run the integrator in a parallel thread.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EKeeping up with real-time is easy, and velocity Verlet would be good enough. But for map view to still work, I need to quickly predict each object\u0027s trajectory into the future (and then store that trajectory so that the vessel can follow it). I also need to recalculate the predicted trajectory as quickly as possible so that the player can still see some prediction in map view while his/her vessel is accelerating. And the calculations have to keep up with 100,000x time warp! If any of these don\u0027t work, then while the concept might work for simulations, it\u0027s a non-starter for KSP the game.\u003C/p\u003E\u003Cp\u003EI\u0027m not sure about symplectic integrators. I think I\u0027ll have to look at them at some point, although they\u0027re not needed for a first cut at the problem. But energy isn\u0027t conserved! My plan is to leave the planetary bodies on their current Keplerian trajectories, so a vessel getting a gravitational slingshot around a planet will gain energy without any other object losing it.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Mihara\u0022 data-cite=\u0022Mihara\u0022\u003E\u003Cdiv\u003EI won\u0027t pretend to understand much about mathematics involved, but a thought for you: endeavour to do all the computations in a separate process if at all possible. \u003Cp\u003EThen, it will get offloaded to another core, and you will never be hurting for computational resources - almost all of us have several which KSP is not using.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EAgreed!\u003C/p\u003E\n"},{"CreatedByName":"trepnick","CreatedById":56570,"CreatedDateTime":"2013-09-11T06:21:11Z","Content":"\n\u003Cp\u003ESo for those of us with almost zero understanding of the mathematics involved here and no understanding of the Wikipedia pages for Kepler and newtons laws, what exactly does this improve about KSP gameplay? Will we get gravitational effects like Lagrange points, or would a full n-body model be required for that? Lagrange points are honestly the only improvement I\u0027ve ever heard of as resulting from a better model, n-body or otherwise...\u003C/p\u003E\n"},{"CreatedByName":"Guest","CreatedById":-1,"CreatedDateTime":"2013-09-11T11:21:12Z","Content":"\n\u003Cp\u003EThat\u0027s a novel approach, good luck on it. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E I\u0027ve once had a similar idea, but instead using Keplerian equations for ships only, with planetary orbits being assumed constans. I also wanted to do more culling of forces that are meaningless in the current situation, for example around Jool, the Mun wouldn\u0027t be taken into account. Anyway, the end result should be the same, and your method seems much better than mine.\u003C/p\u003E\n"},{"CreatedByName":"asmi","CreatedById":59068,"CreatedDateTime":"2013-09-11T14:52:23Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Dragon01\u0022 data-cite=\u0022Dragon01\u0022\u003E\u003Cdiv\u003EThat\u0027s a novel approach, good luck on it. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E I\u0027ve once had a similar idea, but instead using Keplerian equations for ships only, with planetary orbits being assumed constans. I also wanted to do more culling of forces that are meaningless in the current situation, for example around Jool, the Mun wouldn\u0027t be taken into account. Anyway, the end result should be the same, and your method seems much better than mine.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EKeplerian equations is what is used by KSP now (patched conics are based on Keplerian laws).\u003C/p\u003E\n"},{"CreatedByName":"KrazyKrl","CreatedById":65849,"CreatedDateTime":"2013-09-11T22:04:11Z","Content":"\n\u003Cp\u003EWell, the cool thing about n-body, is that not only does it add cool orbital mechanics. But it\u0027s more gooder of learning for the people that do play KSP. Sure, at the beginning, people will feel overwhelmed by Lagrange points and orbital weirdness. But then they will learn that ALL bodies exert a force, and you can use gravity assists from them all at the same time. It\u0027ll add MUCH more depth to orbital mechanics. And it would enable something like \u003Ca href=\u0022https://en.wikipedia.org/wiki/Interplanetary_Transport_Network\u0022 rel=\u0022external nofollow\u0022\u003EThe Interplanetary Transport Network\u003C/a\u003E.\u003C/p\u003E\u003Cp\u003ESure, it MIGHT be more complex at points, but it\u0027s more realistic; and it adds just so much to the game. Right now the orbits are simple ellipses, and planetary transfers are mundane to say the least.\u003C/p\u003E\u003Cp\u003EI don\u0027t see more complexity in a game where you need to worry about the aerodynamic profile, thrust to weight ratio, and total delta-v of your vehicle; just to make your vehicle launch to orbit. Then just have an ellipse when you approach a planet. N-body would only really apply when you are doing interplanetary transfers. So until you get to that point in your space program, the extra complexity is not very apparent.\u003C/p\u003E\n"},{"CreatedByName":"Blaylock1988","CreatedById":57368,"CreatedDateTime":"2013-09-12T03:21:59Z","Content":"\n\u003Cp\u003EYou might as well include orbital perturbations like the J2, J3 and J4 effects, mainly on kerbin. Station Keeping with a high traffic space around kerbin could become a nightmare with 3rd body effects and J effects without some sort of automated station keeping system. This could become game-breakingly realistic. On the other hand, we could finally get sun-synchronous orbits and Lagrange points!\u003C/p\u003E\n"},{"CreatedByName":"Mattasmack","CreatedById":62809,"CreatedDateTime":"2013-09-12T21:11:55Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Blaylock1988\u0022 data-cite=\u0022Blaylock1988\u0022\u003E\u003Cdiv\u003EYou might as well include orbital perturbations like the J2, J3 and J4 effects, mainly on kerbin. Station Keeping with a high traffic space around kerbin could become a nightmare with 3rd body effects and J effects without some sort of automated station keeping system. This could become game-breakingly realistic. On the other hand, we could finally get sun-synchronous orbits and Lagrange points!\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EYeah, I was kind of disappointed to learn that sun-synchronous orbits depended on the shape of the earth, not the influence of other bodies, because it meant any approach based on point masses wouldn\u0027t have them. In the back of my mind I have the idea of replacing the point mass of Kerbin with a small ring of masses (say, 4 - 8 of them) in its equatorial plane to see if that would have the same effect. It\u0027s not something I anticipate doing any time soon, though.\u003C/p\u003E\n"},{"CreatedByName":"NovaSilisko","CreatedById":3897,"CreatedDateTime":"2013-09-12T21:17:13Z","Content":"\n\u003Cp\u003EAll I can say: GLHF\u003C/p\u003E\n"},{"CreatedByName":"Bezzier","CreatedById":81209,"CreatedDateTime":"2013-09-24T05:05:29Z","Content":"\n\u003Cp\u003EAnything new on this topic?\u003C/p\u003E\n"},{"CreatedByName":"BFGfreak","CreatedById":57395,"CreatedDateTime":"2013-09-24T05:35:27Z","Content":"\n\u003Cp\u003EThis might be FAR for space if you can get it to work properly. I wish you luck on your endeavor and hope you don\u0027t go crazy in the process.\u003C/p\u003E\n"},{"CreatedByName":"Guest","CreatedById":-1,"CreatedDateTime":"2013-11-20T21:52:38Z","Content":"\n\u003Cp\u003EWas there any progress? And if it died, could we get the code in it\u0027s current form? It looked like a very promising mod.\u003C/p\u003E\n"},{"CreatedByName":"Cheaterman","CreatedById":32757,"CreatedDateTime":"2013-11-20T21:58:14Z","Content":"\n\u003Cp\u003EI actually posted a thread myself explaining RK4 and showing the solution to a n-to-1 body physics problem. However the issue here is that you\u0027ll need to be able to change the current (\u0022on-rails\u0022) trajectory while warping - assuming you can do it, you\u0027d simply need to integrate enough. And to solve the potential CPU performance issues, just consider the bodies in the adjacent system - ie, Duna doesn\u0027t affect you in Kerbin\u0027s SOI while both Kerbin and Duna would while you\u0027re orbiting Kerbol (this is to ignore Jool\u0027s Moons most of the time - they would not influence you as long as you\u0027re not orbiting Jool itself).\u003C/p\u003E\n"},{"CreatedByName":"roady1990","CreatedById":18796,"CreatedDateTime":"2013-11-21T00:11:12Z","Content":"\n\u003Cp\u003EWouldn\u0027t using Runge-Kutta methods introduce the problem that they\u0027re not really energy conserving? and could thus make your orbits smaller or larger after longer periods of time?\u003C/p\u003E\n"},{"CreatedByName":"Itsdavyjones","CreatedById":57605,"CreatedDateTime":"2013-11-21T00:17:28Z","Content":"\n\u003Cp\u003Ewell this is the first i heard about this, and i wish you luck to get this to work, for this sounds like fun.\u003C/p\u003E\n"},{"CreatedByName":"BLUAV8R","CreatedById":83302,"CreatedDateTime":"2013-11-21T01:22:02Z","Content":"\n\u003Cp\u003ELOVE the idea \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E but this would really mess up my munar sattelite network over long periods of time xD stupid tidal orbit decaying\u003C/p\u003E\n"},{"CreatedByName":"Camacha","CreatedById":59088,"CreatedDateTime":"2013-11-21T10:50:45Z","Content":"\n\u003Cp\u003EI think this decaying things could all be fixed if kOS could be made to run while not in focus too. They got something like that to work for SCANsat and life support, so why not for kOS? That way you could beautifully automate stationkeeping with realistic associated costs.\u003C/p\u003E\n"},{"CreatedByName":"Autochton","CreatedById":70134,"CreatedDateTime":"2013-11-21T15:29:08Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Camacha\u0022 data-cite=\u0022Camacha\u0022\u003E\u003Cdiv\u003EI think this decaying things could all be fixed if kOS could be made to run while not in focus too. They got something like that to work for SCANsat and life support, so why not for kOS? That way you could beautifully automate stationkeeping with realistic associated costs.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EAt the cost of physically simulating every vehicle in the game. You\u0027d need to have propulsion to have station-keeping, and for propulsion you need fuel, electricity, comms if you have RT, simulating the structure of the ship to account for things like shifting centers of mass or other mishaps... It\u0027s just not feasible.\u003C/p\u003E\u003Cp\u003EWhat might be possible, though, is to have a sort of passive watcher on it, that alerts you (\u00C3\u0192\u00C2\u00A1 la Kerbal Alarm Clock) if a satellite needs station correction. You might set certain parameters its orbit needs to remain within, for example, and have it alert when it deviates from those. Then you can switch to it and correct or not as necessary.\u003C/p\u003E\n"},{"CreatedByName":"scorchdestroya","CreatedById":63262,"CreatedDateTime":"2013-11-21T15:45:00Z","Content":"\n\u003Cp\u003EWill ths make halo orbits possible?\u003C/p\u003E\n"},{"CreatedByName":"Mattasmack","CreatedById":62809,"CreatedDateTime":"2013-11-21T23:04:01Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Dragon01\u0022 data-cite=\u0022Dragon01\u0022\u003E\u003Cdiv\u003EWas there any progress? And if it died, could we get the code in it\u0027s current form? It looked like a very promising mod.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ENot much progress to speak of, unfortunately. I started learning Unity and plug in development, but after seeing just how many objects are associated with KSP and how little documented they are, I moved this project down several slots on my to-do list. Plus real life has intervened for the past six weeks or so. My wife and I moved last month and my stuff just arrived from storage. The living room and my (eventual) office are full of boxes, and the computer I\u0027d prefer to use for software development is busted. There isn\u0027t really any code to speak of to release.\u003C/p\u003E\u003Cp\u003EI still hope to go somewhere with this project eventually, but it isn\u0027t my top priority at this time.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022roady1990\u0022 data-cite=\u0022roady1990\u0022\u003E\u003Cdiv\u003EWouldn\u0027t using Runge-Kutta methods introduce the problem that they\u0027re not really energy conserving? and could thus make your orbits smaller or larger after longer periods of time?\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EUsing an inherently energy-conserving method isn\u0027t really important, especially since having the planetary bodies follow Keplerian orbits means the whole system doesn\u0027t conserve energy in the first place. Plus, I was envisioning using the Newtonian trajectories only at high enough altitudes above each planetary body that they would be used only where an orbit shouldn\u0027t be expected to be stable anyway. With a decent integration scheme and reasonable error limit, any numerical drift would be small compared to perturbation of the orbit by other bodies, and therefore not a problem.\u003C/p\u003E\u003Cp\u003EIncidentally, I went ahead and did an N-body simulation of the Kerbol system using this RK5(4) method just for fun, and over an error limit range of a few orders of magnitude the results were essentially the same for simulation lengths of 100 years. Over astronomical time periods an inherently energy-conserving method is probably important, but not over the length of a game.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022scorchdestroya\u0022 data-cite=\u0022scorchdestroya\u0022\u003E\u003Cdiv\u003EWill ths make halo orbits possible?\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EUnfortunately no. Having the planets and moons continue to follow Keplerian orbits means the balance of forces that make L-points and halo orbits exist is upset. Or at least, that\u0027s what I found in some simple tests back in September. I talked about them a bit more in the thread in the general discussion forum. It\u0027s something I\u0027d like to explore further someday.\u003C/p\u003E\n"}]}