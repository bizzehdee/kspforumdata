{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":142,"Articles":[{"CreatedByName":"Sabor","CreatedById":59932,"CreatedDateTime":"2016-02-29T03:04:29Z","Content":"\u003E \n\u003E \n\u003E 3 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Could you test if the performance issue persists with stock only?\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E This also doesn\u0027t make sense but whatever works...\n\u003E \n\nThe performance does occur with stock only if I use DX11. I don\u0027t know what the deal is there. It\u0027s fine if I click the runway, pick a craft, and launch.  But if I go into VAB or SPH, build/load a craft, hit launch, I\u0027m hit with that bug until restarting the game, it\u0027s unrelated to Scatterer but the only way I can use Scatterer with no graphical issues. DX9 and 10 work perfectly fine performance wise, but then terrain shadows are a bust and go all stripey\n\n**Edited \u003Ctime datetime=\u00222016-02-29T03:06:06Z\u0022 title=\u002202/29/2016 03:06  AM\u0022 data-short=\u00228 yr\u0022\u003EFebruary 29, 2016\u003C/time\u003E by Sabor**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-29T03:06:10Z","Content":"\u003E \n\u003E \n\u003E 2 minutes ago, Sabor said:\n\u003E \n\u003E \n\u003E The performance does occur with stock only if I use DX11. I\u0027m don\u0027t know what the deal is there. It\u0027s fine if I click the runway, pick a craft, and launch.  But if I go into VAB or SPH, build/load a craft, hit launch, I\u0027m hit with that bug until restarting the game. DX9 and 10 work perfectly fine, but then terrain shadows are a bust and go all stripey\n\u003E \n\nAre there no issues in the debug log? The terrain shadows issue is known as \u0022shadow acne\u0022 and is out of my hands, it\u0027s more of an issue with how unity does shadows, might be a reason why SQUAD chose to not have terrain shadows.\n\n**Edited \u003Ctime datetime=\u00222016-02-29T03:06:48Z\u0022 title=\u002202/29/2016 03:06  AM\u0022 data-short=\u00228 yr\u0022\u003EFebruary 29, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"Sabor","CreatedById":59932,"CreatedDateTime":"2016-02-29T03:16:38Z","Content":"\u003E \n\u003E \n\u003E 27 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Are there no issues in the debug log? The terrain shadows issue is known as \u0022shadow acne\u0022 and is out of my hands, it\u0027s more of an issue with how unity does shadows, might be a reason why SQUAD chose to not have terrain shadows.\n\u003E \n\nThe only issues in the log are...\n\n![HKb3sOx.jpg](http://i.imgur.com/HKb3sOx.jpg)\n\nAnd I don\u0027t \\*think\\* these would cause this performance issue in DX11 but not 9/10\n\nI guess I\u0027m just going to have to use DX10 and turn off terrain shadows, which is a shame because damn they look good\n\n**Edited \u003Ctime datetime=\u00222016-02-29T03:33:24Z\u0022 title=\u002202/29/2016 03:33  AM\u0022 data-short=\u00228 yr\u0022\u003EFebruary 29, 2016\u003C/time\u003E by Sabor**"},{"CreatedByName":"Oddible","CreatedById":74605,"CreatedDateTime":"2016-03-01T06:11:20Z","Content":"\u003Csnip\u003E\n\u003C/snip\u003E\n\n**Edited \u003Ctime datetime=\u00222016-03-01T06:28:54Z\u0022 title=\u002203/01/2016 06:28  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 1, 2016\u003C/time\u003E by Oddible**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-01T11:44:20Z","Content":"Quick question to anyone who would know, I have an issue with large float and Color arrays never getting garbage collected **despite** leaving no references or anything behind and the arrays going out of scope.\n\nShould I use unsafe code like [this](http://answers.unity3d.com/questions/225460/big-arrays-are-never-garbage-collected-why.html) to manage that memory myself?\n\n**Edited \u003Ctime datetime=\u00222016-03-01T11:44:47Z\u0022 title=\u002203/01/2016 11:44  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 1, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-01T11:58:50Z","Content":"\u003E \n\u003E \n\u003E 1 minute ago, Thomas P. said:\n\u003E \n\u003E \n\u003E Unitys Garbage Collector is old and broken, so this behaviour is normal ![:(](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_sad.gif \u0022:(\u0022) I\u0027m not sure if manually collecting them would work better.\n\u003E \n\nWell it seems using Marshal.FreeHGlobal() should work, or so the internet says, I was just wondering if there wouldn\u0027t be issues in runtime, or on linux and mac when using unsafe code."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-01T12:10:12Z","Content":"\u003E \n\u003E \n\u003E Just now, Thomas P. said:\n\u003E \n\u003E \n\u003E Well the problem here is that C# Unsafe is still executed through the runtime and still managed by the GarbageCollector, even if it is called manually. IIRC you would have to interop with C/C\u002B\u002B directly to free it, but that would make the GC go nuts again.\n\u003E \n\nI see, however in that ink I posted earlier the poster reports the memory successfully being freed. So I don\u0027t really know what\u0027s happening behind the scenes but I thought it might still be useful to try."},{"CreatedByName":"Tiptonian","CreatedById":159632,"CreatedDateTime":"2016-03-01T13:27:59Z","Content":"Lovely mod. Made the prolonged testing experience of my shuttle objectively better.![e0jl58kh.jpg](http://i.imgur.com/e0jl58kh.jpg)"},{"CreatedByName":"Joco223","CreatedById":92530,"CreatedDateTime":"2016-03-01T15:09:46Z","Content":"[@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) I have found a bug where there is no flare around the sun. Nor in atmosphere or in space. The sun right now for me is just white ball in the sky"},{"CreatedByName":"atomontage","CreatedById":153524,"CreatedDateTime":"2016-03-01T15:44:01Z","Content":"Hey [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/)! The game getting stuck at KSC is actually not an issue with Scatterer.\n\n\u003Ciframe data-embedcontent=\u0022\u0022 frameborder=\u00220\u0022 src=\u0022https://forum.kerbalspaceprogram.com/index.php?/topic/95383-weird-space-center-camera-bug/\u0026do=embed\u0026embedComment=2314650\u0026embedDo=findComment\u0022\u003E\u003C/iframe\u003E"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-01T16:14:21Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, Joco223 said:\n\u003E \n\u003E \n\u003E [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) I have found a bug where there is no flare around the sun. Nor in atmosphere or in space. The sun right now for me is just white ball in the sky\n\u003E \n\nAre you sure you have the latest version? Did this happen before? Are you using any rescale mods? Information is key here.\n\n\u003E \n\u003E \n\u003E 31 minutes ago, atomontage said:\n\u003E \n\u003E \n\u003E Hey [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/)! The game getting stuck at KSC is actually not an issue with Scatterer.\n\u003E \n\nYes I knew this for a while but people always associate it with scatterer regardless so I put it in the known issues sections. Also in the previous version (last week) there was a very similar bug with the view stuck but also with a blue background behind KSC that was indeed caused by scatterer so it was a bit confusing.\n\n**Edited \u003Ctime datetime=\u00222016-03-01T16:16:18Z\u0022 title=\u002203/01/2016 04:16  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 1, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"Wren","CreatedById":99277,"CreatedDateTime":"2016-03-01T18:01:02Z","Content":"I installed the latest version and I\u0027m amazed:\n\nSpoiler\n\n[http://imgur.com/a/1wvc3](http://imgur.com/a/1wvc3)\n\n[![1wvc3](http://imgur.com/a/1wvc3)](http://imgur.com/a/1wvc3)\n\n**Edited \u003Ctime datetime=\u00222016-03-01T18:05:25Z\u0022 title=\u002203/01/2016 06:05  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 1, 2016\u003C/time\u003E by Wren**\n  \nfixing pics"},{"CreatedByName":"Jovzin","CreatedById":105152,"CreatedDateTime":"2016-03-01T19:27:15Z","Content":"Guys this is a scatterer issue or  new EVE  ? \n\n![3OqWGRy.png](http://i.imgur.com/3OqWGRy.png)  \n\nAnd in the map view it is not there:\n\n![927S60f.png](http://i.imgur.com/927S60f.png)\n\n**Edited \u003Ctime datetime=\u00222016-03-01T19:27:44Z\u0022 title=\u002203/01/2016 07:27  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 1, 2016\u003C/time\u003E by Jovzin**"},{"CreatedByName":"MrMeeb","CreatedById":84238,"CreatedDateTime":"2016-03-01T20:05:34Z","Content":"\u003E \n\u003E \n\u003E 37 minutes ago, Jovzin said:\n\u003E \n\u003E \n\u003E Guys this is a scatterer issue or  new EVE  ? \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [![3OqWGRy.png](http://i.imgur.com/3OqWGRy.png)](http://i.imgur.com/3OqWGRy.png \u0022Enlarge image\u0022)  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E And in the map view it is not there:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [![927S60f.png](http://i.imgur.com/927S60f.png)](http://i.imgur.com/927S60f.png \u0022Enlarge image\u0022)\n\u003E \n\nI have a feeling it\u0027s EVE. I\u0027m experiencing the problem too"},{"CreatedByName":"Oddible","CreatedById":74605,"CreatedDateTime":"2016-03-02T03:15:47Z","Content":"Any way to resolve these weird lines?\n\n\u003Ciframe allowfullscreen=\u0022true\u0022 frameborder=\u00220\u0022 height=\u0022270\u0022 src=\u0022https://www.youtube.com/embed/tMDtG9y1fs4?feature=oembed\u0022 width=\u0022480\u0022\u003E\u003C/iframe\u003E\n\n**Edited \u003Ctime datetime=\u00222016-03-02T03:18:45Z\u0022 title=\u002203/02/2016 03:18  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 2, 2016\u003C/time\u003E by Oddible**"},{"CreatedByName":"DuoDex","CreatedById":107061,"CreatedDateTime":"2016-03-02T03:32:47Z","Content":"May be experiencing issues with nuEVE \u002B most recent version of Scatterer. Updates as I can."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-02T05:20:39Z","Content":"\u003E \n\u003E \n\u003E 9 hours ago, Jovzin said:\n\u003E \n\u003E \n\u003E Guys this is a scatterer issue or  new EVE  ? \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E And in the map view it is not there:\n\u003E \n\nCheck if removing scatterer fixes it.\n\n\u003E \n\u003E \n\u003E 2 hours ago, Oddible said:\n\u003E \n\u003E \n\u003E Any way to resolve these weird lines?\n\u003E \n\nSwitch to dx11 or disable terrain shadows."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-02T06:05:15Z","Content":"I shaved down the memory usage by about 200-300 mb by managing the memory myself, I only tested in 32bits on windows and dx11 and it seems to work well for me, but I\u0027m going to need you guys to test it out and confirm whether it works or not on your platform and if the savings are indeed real.\n\n[https://mega.nz/#!HQI2TTqB!dCS6guq2vDyb0c3QVtG33nR6KMAn0T6CnITf_CqTg7w](https://mega.nz/#!HQI2TTqB!dCS6guq2vDyb0c3QVtG33nR6KMAn0T6CnITf_CqTg7w)\n\n\u003E \n\u003E \n\u003E 18 hours ago, Thomas P. said:\n\u003E \n\u003E \n\u003E Well the problem here is that C# Unsafe is still executed through the runtime and still managed by the GarbageCollector, even if it is called manually. IIRC you would have to interop with C/C\u002B\u002B directly to free it, but that would make the GC go nuts again.\n\u003E \n\nIt seems to actually work, at the KSC I now get about 1450-1500 mb memory usage instead of 1700 mb and at the runway 1750 or so instead of 1980 mb, I posted the new .dll above and I\u0027m waiting for more people to report on how (or if) it works on their platform.\n\n**Edited \u003Ctime datetime=\u00222016-03-02T06:11:37Z\u0022 title=\u002203/02/2016 06:11  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 2, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"selfish_meme","CreatedById":125899,"CreatedDateTime":"2016-03-02T12:02:33Z","Content":"Linux 64bit OpenGL 1760mb free with old dll, 2072mb free with new dll, quite a saving"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-02T12:19:42Z","Content":"\u003E \n\u003E \n\u003E 16 minutes ago, selfish\\_meme said:\n\u003E \n\u003E \n\u003E Linux 64bit OpenGL 1760mb free with old dll, 2072mb free with new dll, quite a saving\n\u003E \n\nGreat, do you notice longer load times on switching scenes?"},{"CreatedByName":"selfish_meme","CreatedById":125899,"CreatedDateTime":"2016-03-02T12:20:34Z","Content":"Nothing noticeable yet"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-02T12:21:33Z","Content":"\u003E \n\u003E \n\u003E Just now, selfish\\_meme said:\n\u003E \n\u003E \n\u003E Nothing noticeable yet\n\u003E \n\nGreat, I might be able to save even more memory."},{"CreatedByName":"SkyKaptn","CreatedById":153990,"CreatedDateTime":"2016-03-02T12:56:39Z","Content":"\u003E \n\u003E \n\u003E 6 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E but I\u0027m going to need you guys to test it out and confirm whether it works or not on your platform and if the savings are indeed real.\n\u003E \n\nTested on 64bit workaround with dx9 at KSC. Old usage: 5657MB, new usage: 5472MB. Saved 185MB  \n\nCannot tell if load times have increased. Too little to notice in other words."},{"CreatedByName":"stratochief66","CreatedById":59541,"CreatedDateTime":"2016-03-02T15:45:03Z","Content":"[@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) I took at shot at scaling the sunflare.cfg for RSS with no luck today. Could you suggest some values for that file that might cause a visible increase in the flare size? Nothing I attempt to do appears to cause a change, and I\u0027ve tried a few different settings in DX9, DX11, and OpenGL."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-02T16:17:57Z","Content":"\u003E \n\u003E \n\u003E 35 minutes ago, stratochief66 said:\n\u003E \n\u003E \n\u003E [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) I took at shot at scaling the sunflare.cfg for RSS with no luck today. Could you suggest some values for that file that might cause a visible increase in the flare size? Nothing I attempt to do appears to cause a change, and I\u0027ve tried a few different settings in DX9, DX11, and OpenGL.\n\u003E \n\nI just tried\n\n    //sunFlare.png\n    flareSettings = 0.45,1,0.085\n    \n    //sunSpikes.png\n    spikesSettings = 0.6,1,0.1\n\nLiterally just made it 10 times bigger by adding a zero to the last value in the first line and a decimal point to the last value in the second line\n\nAnd the results:\n\n\u003Ciframe class=\u0022imgur-album\u0022 frameborder=\u00220\u0022 height=\u0022550\u0022 src=\u0022//imgur.com/a/pDraC/embed?background=ffffff\u0026text=1a1a1a\u0026link=4e76c9\u0022 width=\u0022100%\u0022\u003E\u003C/iframe\u003E\n\n**Edited \u003Ctime datetime=\u00222016-03-02T16:21:14Z\u0022 title=\u002203/02/2016 04:21  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 2, 2016\u003C/time\u003E by blackrack**"}]}