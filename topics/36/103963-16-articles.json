{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":16,"Articles":[{"CreatedByName":"TinyPirate","CreatedById":77813,"CreatedDateTime":"2015-04-29T11:46:21Z","Content":"Hey! Blackrack! I featured Scatterer in my 2 Minute Mods series. Hope you like the video, and please feel free to share around, use, and so on.\n\n\u003Ciframe width=\u0022480\u0022 height=\u0022270\u0022 src=\u0022https://www.youtube.com/embed/Pi1ZswcCITU?feature=oembed\u0022 frameborder=\u00220\u0022 allowfullscreen=\u0022true\u0022\u003E\u003C/iframe\u003E"},{"CreatedByName":"Bizz Keryear","CreatedById":68896,"CreatedDateTime":"2015-04-29T17:37:07Z","Content":"Since this mod is constantly worked on and yet still has to get a version that is stable and or fully working how you implement one of those amazing update check tool into it ... like e.g. CKAN?\n\nOther than this ... keep up the amazing work .. and thank you for making this mod."},{"CreatedByName":"Conzolax","CreatedById":62397,"CreatedDateTime":"2015-04-29T17:55:24Z","Content":"\u003E \n\u003E I Tried it in 1.0 It works but it has some artefacts. It seems that the atmosphere cut straight to black ( space ) around 30K or a bit higher. The loading is a Pink Square thing.\n\nHavent seen the pink loading thingy myself, but the sky turning black? /check\n\n![230exf.png](http://i59.tinypic.com/230exf.png)\n\nMine already starts going black at around 6000m for some reason ![:huh:](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_undecided.gif)\n\nBesides that, it looks absolutely gorgeous. ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-29T17:58:16Z","Content":"So apparently, the atmosphere looking too thick from orbit is a bug that found it\u0027s way in (among many other bugs) when I ported the shaders to dx9.\n\nWe all just dismissed it as the atmosphere being too dense because we thought it made sense.\n\nThis is how the shader is supposed to look from orbit:\n\n![vNm4ECO.jpg](http://i.imgur.com/vNm4ECO.jpg)\n\nThis is how it looks right now:\n\n![KflP0DZ.jpg](http://i.imgur.com/KflP0DZ.jpg)\n\nI haven\u0027t found the cause of it yet but when this is done the view from orbit should be way way better.\n\n\u003E \n\u003E Hey! Blackrack! I featured Scatterer in my 2 Minute Mods series. Hope you like the video, and please feel free to share around, use, and so on.\n\u003E \n\u003E \n\u003E \n\u003E \u003Ciframe width=\u0022480\u0022 height=\u0022270\u0022 src=\u0022https://www.youtube.com/embed/Pi1ZswcCITU?feature=oembed\u0022 frameborder=\u00220\u0022 allowfullscreen=\u0022true\u0022\u003E\u003C/iframe\u003E\n\nGreat video, keep it up.\n\n\u003E \n\u003E Some screenshots from tonight. I mostly avoided taking screenshots of areas with high mountains because aside from those it looks fantastic at all altitudes I was playing at tonight. I\u0027m running PlanetShine and a SweetFX config to brighten up the game a bit from its normally strange dark lighting.\n\u003E [http://imgur.com/a/Yea5d](http://imgur.com/a/Yea5d)\n\u003E \n\u003E This is one of my favorite mods in development right now. I can\u0027t give OP enough praise for how much better this makes the game look.\n\nI\u0027ll make a higher atmsphere for the next version, hopefully when/after I fix this bug.\n\n\u003E \n\u003E Since this mod is constantly worked on and yet still has to get a version that is stable and or fully working how you implement one of those amazing update check tool into it ... like e.g. CKAN?\n\u003E Other than this ... keep up the amazing work .. and thank you for making this mod.\n\nI\u0027ll look into one of these for the next version."},{"CreatedByName":"Errol","CreatedById":118622,"CreatedDateTime":"2015-04-29T18:11:55Z","Content":"I would put my vote on AVC if that is on the table."},{"CreatedByName":"SmallFatFetus","CreatedById":137860,"CreatedDateTime":"2015-04-29T18:23:15Z","Content":"PLEASE post pictures of everything you do. ![:kiss:](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_kiss.gif) I check this thread frequently and it\u0027s great to see screenshots of every step of development. \n\nSmallFatFetus"},{"CreatedByName":"HafCoJoe","CreatedById":80363,"CreatedDateTime":"2015-04-29T18:30:42Z","Content":"\u003E \n\u003E Following closely. Keep up the amazing work, blackrack! Finally, KSP is starting to resemble the KSP of my daydreams.\n\nSpeaking of this I had a dream a few days ago before 1.0 dropped where I walked up next to the cockpit of a plane. It ended up being the Mk2 inline. As I walked closed I realized that I could see inside the cockpit and then I woke up with the idea that KSP 1.0 had transparent windows that you could see in to from outside... ![;.;](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cry.gif)"},{"CreatedByName":"Drew Kerman","CreatedById":103177,"CreatedDateTime":"2015-04-29T18:42:02Z","Content":"gotta say this is the #1 thread I look forward to checking in on everytime I stop by these days. Keep up the good work and post plenty of pics"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-29T20:54:38Z","Content":"So, the water almost works.\n\n![0AyPUBJ.jpg](http://i.imgur.com/0AyPUBJ.jpg)\n\nBut the problem is, it moves up slightly whenever the camera moves up\n\n![17RFsFx.jpg](http://i.imgur.com/17RFsFx.jpg)\n\nIt doesn\u0027t follow the camera closely, just nudges slightly up with it but it\u0027s still enough to flood everything and create a jarring effect.\n\n![7t6VJjw.jpg](http://i.imgur.com/7t6VJjw.jpg)\n\nI\u0027m pretty bad at math, so I think the problem lies in this part with all the transformation matrices [https://github.com/blackrack/Scatterer/blob/master/scatterer/Ocean/OceanNode.cs#L262](https://github.com/blackrack/Scatterer/blob/master/scatterer/Ocean/OceanNode.cs#L262) (lines 262-383)\n\nIf anyone could review the code I\u0027d be grateful, I\u0027ve been stuck on this for a bit. If you want to try compiling/debugging yourself just compile and drop the .dll inside this build, [http://wikisend.com/download/915958/scatterer.zip](http://wikisend.com/download/915958/scatterer.zip) it has all the ocean shaders and the stuff necessary to run.\n\n**Edited \u003Ctime datetime=\u00222015-04-29T21:01:02Z\u0022 title=\u002204/29/2015 09:01  PM\u0022 data-short=\u00229 yr\u0022\u003EApril 29, 2015\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-04-29T21:09:18Z","Content":"\u003E \n\u003E So, the water almost works.\n\u003E [http://i.imgur.com/0AyPUBJ.jpg](http://i.imgur.com/0AyPUBJ.jpg)\n\u003E \n\u003E But the problem is, it moves up slightly whenever the camera moves up\n\u003E \n\u003E [http://i.imgur.com/17RFsFx.jpg](http://i.imgur.com/17RFsFx.jpg)\n\u003E \n\u003E It doesn\u0027t follow the camera closely, just nudges slightly up with it but it\u0027s still enough to flood everything and create a jarring effect.\n\u003E \n\u003E [http://i.imgur.com/7t6VJjw.jpg](http://i.imgur.com/7t6VJjw.jpg)\n\u003E \n\u003E I\u0027m pretty bad at math, so I think the problem lies in this part with all the transformation matrices [https://github.com/blackrack/Scatterer/blob/master/scatterer/Ocean/OceanNode.cs#L262](https://github.com/blackrack/Scatterer/blob/master/scatterer/Ocean/OceanNode.cs#L262) (lines 262-383)\n\u003E \n\u003E If anyone could review the code I\u0027d be grateful, I\u0027ve been stuck on this for a bit. If you want to try compiling/debugging yourself just compile and drop the .dll inside this build, [http://wikisend.com/download/915958/scatterer.zip](http://wikisend.com/download/915958/scatterer.zip) it has all the ocean shaders and the stuff necessary to run.\n\nthis doesn\u0027t seem right: Looks like you need a cameraToLocal or WorldToOcean instead.\n\n                            // compute ctoo = cameraToOcean transform\t\t\t// also should be correct\t\t\tMatrix4x4d cameraToOcean = localToOcean * cameraToWorld;\n\n- - - Updated - - -\n\nOh... Once you get everything working, reference shader params by their ID, not their name. Otherwise it has to do string lookups, and can add a good bit of processing time."},{"CreatedByName":"skykooler","CreatedById":60459,"CreatedDateTime":"2015-04-29T22:16:03Z","Content":"\u003E \n\u003E gotta say this is the #1 thread I look forward to checking in on everytime I stop by these days. Keep up the good work and post plenty of pics\n\nSame! I always save it for last, because it\u0027s the one that I\u0027m looking forward to the pictures in the most."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-29T22:27:32Z","Content":"\u003E \n\u003E this doesn\u0027t seem right: Looks like you need a cameraToLocal or WorldToOcean instead.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E                             // compute ctoo = cameraToOcean transform\t\t\t// also should be correct\t\t\tMatrix4x4d cameraToOcean = localToOcean * cameraToWorld;\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E - - - Updated - - -\n\u003E \n\u003E Oh... Once you get everything working, reference shader params by their ID, not their name. Otherwise it has to do string lookups, and can add a good bit of processing time.\n\nI think you\u0027re right (and I hope you are, for my sanity), I\u0027m going to try a using a WorldToOcean now."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-04-29T23:12:50Z","Content":"I hope so too! I really want to see those oceans!"},{"CreatedByName":"HafCoJoe","CreatedById":80363,"CreatedDateTime":"2015-04-30T00:25:05Z","Content":"This thread is so much fun to watch ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif). I just wanted to say that. Nothing like two modders working together to get a common collaborative goal."},{"CreatedByName":"Majorjim!","CreatedById":61954,"CreatedDateTime":"2015-04-30T01:02:56Z","Content":"You guys rock! I can see this becoming a \u0027necessary\u0027 mod soon. Keep up the great work."},{"CreatedByName":"BrutalRIP","CreatedById":59065,"CreatedDateTime":"2015-04-30T01:30:36Z","Content":"just a heads up [these lines](http://imgur.com/a/GpfuB) appear when installing [texture replacer](https://forum.kerbalspaceprogram.com/threads/107471)"},{"CreatedByName":"Ork","CreatedById":139856,"CreatedDateTime":"2015-04-30T01:31:06Z","Content":"Firstly, Proot, you sir are a bad man ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif)\n\nOnto bus i ness..\n\nNot sure if this helps or hinders but I was messing around with my son today, I walk away from the computer and my KSP looks like this.\n\n![screenshot0_zpsymj3ei2q.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot0_zpsymj3ei2q.png)\n\nAll kinds of pretty.\n\nHe takes a screenshot of launch to show me.\n\n![screenshot2_zpsz7ncndnk.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot2_zpsz7ncndnk.png)\n\nAll looks good.\n\nThen whilst making a cuppa tea he does something and takes a screeny for me.\n\n![screenshot3_zpswgmppu8k.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot3_zpswgmppu8k.png)\n\nClouds?\n\n![screenshot4_zps8dlvbahe.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot4_zps8dlvbahe.png)\n\n![screenshot5_zpskxgepdvl.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot5_zpskxgepdvl.png)\n\n![screenshot6_zpsifthqst4.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot6_zpsifthqst4.png)\n\n![screenshot7_zpsoylpomjw.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot7_zpsoylpomjw.png)\n\n![screenshot1_zpsotjzr5y9.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot1_zpsotjzr5y9.png)\n\nI have no idea what he did, neither does he.\n\nI know that they are not perfect but I have never had clouds with Scatterer before."},{"CreatedByName":"cobbman11","CreatedById":76711,"CreatedDateTime":"2015-04-30T01:33:08Z","Content":"I don\u0027t usually check up on mods every three hours, but I\u0027m incredibly interested in where this is going. Without a doubt, this is the coolest new mod in the works. That water is gorgeous and I can\u0027t wait for the next update!"},{"CreatedByName":"Proot","CreatedById":98932,"CreatedDateTime":"2015-04-30T02:11:38Z","Content":"\u003E \n\u003E Firstly, Proot, you sir are a bad man ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif)\n\u003E Onto bus i ness..\n\u003E \n\u003E Not sure if this helps or hinders but I was messing around with my son today, I walk away from the computer and my KSP looks like this.\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot0_zpsymj3ei2q.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot0_zpsymj3ei2q.png)\n\u003E \n\u003E All kinds of pretty.\n\u003E \n\u003E He takes a screenshot of launch to show me.\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot2_zpsz7ncndnk.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot2_zpsz7ncndnk.png)\n\u003E \n\u003E All looks good.\n\u003E \n\u003E Then whilst making a cuppa tea he does something and takes a screeny for me.\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot3_zpswgmppu8k.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot3_zpswgmppu8k.png)\n\u003E \n\u003E Clouds?\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot4_zps8dlvbahe.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot4_zps8dlvbahe.png)\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot5_zpskxgepdvl.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot5_zpskxgepdvl.png)\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot6_zpsifthqst4.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot6_zpsifthqst4.png)\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot7_zpsoylpomjw.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot7_zpsoylpomjw.png)\n\u003E \n\u003E [http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot1_zpsotjzr5y9.png](http://i8.photobucket.com/albums/a27/OrkHarrid/screenshot1_zpsotjzr5y9.png)\n\u003E \n\u003E I have no idea what he did, neither does he.\n\u003E \n\u003E I know that they are not perfect but I have never had clouds with Scatterer before.\n\nI got something similar since a little time. If is not a new atmo config (like in my case -these are my latest tests-) your son probably have touched the menu transparency. ![;)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif)\n\nMy test atmo is pretty higher than the default (\u0022finish\u0022 at 15000m limit at 69000m), and still you can see some mountains piercing the sky. I like that effect (pretty realistic for me), but I\u0027m still working to tune it and, of course, to get a much more credible atmo overall. \n\n![xXDO7nM.jpg](http://i.imgur.com/xXDO7nM.jpg)\n\n![NwL4Le2.jpg](http://i.imgur.com/NwL4Le2.jpg)"},{"CreatedByName":"skykooler","CreatedById":60459,"CreatedDateTime":"2015-04-30T02:49:26Z","Content":"...wow. That is beautiful!"},{"CreatedByName":"flightmaster","CreatedById":32617,"CreatedDateTime":"2015-04-30T06:35:35Z","Content":"Subbed ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-30T11:30:38Z","Content":"\u003E \n\u003E I hope so too! I really want to see those oceans!\n\nWell, I tried it yesterday and... it didn\u0027t work. Since local space in the context of the shader refers to space relative to the planet, I figured the localToWorld matrix is kerbin\u0027s localToWorld matrix. After that, I just did \n\n    camToLocal = cameraToWorld * localToWorld.Inverse();\n\nI also tried adjusting few other things since that\u0027s bound to throw everything off but couldn\u0027t figure out what\u0027s wrong. I have to admit that when stuff gets too \u0022matrix-y\u0022 I have trouble imagining it and getting an intuitive understanding of it, so I\u0027m not the best guy for the job.\n\nI\u0027m giving it another try now, I\u0027ll try and re-understand how the whole thing works from the ground up.\n\n\u003E \n\u003E This thread is so much fun to watch ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif). I just wanted to say that. Nothing like two modders working together to get a common collaborative goal.\n\n\u003E \n\u003E I don\u0027t usually check up on mods every three hours, but I\u0027m incredibly interested in where this is going. Without a doubt, this is the coolest new mod in the works. That water is gorgeous and I can\u0027t wait for the next update!\n\nI\u0027m glad you guys are enjoying this. Unfortunately, I have to say that development is going to slow down a LOT, mainly because I\u0027m going to be working a job from 9am to 5pm starting next monday, so I won\u0027t have half as much free time as I used to. That kind of sucks.\n\n\u003E \n\u003E I got something similar since a little time. If is not a new atmo config (like in my case -these are my latest tests-) your son probably have touched the menu transparency. ![;)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif)\n\u003E My test atmo is pretty higher than the default (\u0022finish\u0022 at 15000m limit at 69000m), and still you can see some mountains piercing the sky. I like that effect (pretty realistic for me), but I\u0027m still working to tune it and, of course, to get a much more credible atmo overall. \n\u003E \n\u003E [http://i.imgur.com/xXDO7nM.jpg](http://i.imgur.com/xXDO7nM.jpg) \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [http://i.imgur.com/NwL4Le2.jpg](http://i.imgur.com/NwL4Le2.jpg)\n\nFor a second there I thought I walked into the space engine thread. That image is simply amazing."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-30T13:08:28Z","Content":"So it seems I\u0027ve sort of found the issue, debugging the vector from camera to local, it seems it\u0027s magnitude starts at 600 000 (kerbin\u0027s radius) and gets smaller with altitude, which should be the opposite. Curiously, the only way I find to fix it was to inverse the cameraToWorld matrix, but that throws off all of the evctor directions, I remember reading somewhere that cameras have a flipped z axis or soemthing like that, could this have any relation to it?"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2015-04-30T13:18:30Z","Content":"\u003E \n\u003E Well, I tried it yesterday and... it didn\u0027t work. Since local space in the context of the shader refers to space relative to the planet, I figured the localToWorld matrix is kerbin\u0027s localToWorld matrix. After that, I just did \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E     camToLocal = cameraToWorld * localToWorld.Inverse();\n\nDon\u0027t think that works... Pretty sure it should be localToWorld.Inverse()\\*cameraToWorld. Remember that the order is inverted for matrix multiplication.\n\nAlso, I\u0027d probably convert the oceanToLocal to oceanToWorld rather than the change the camera matrix so you don\u0027t have to perform an inverse matrix calculation."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-30T14:00:10Z","Content":"\u003E \n\u003E Don\u0027t think that works... Pretty sure it should be localToWorld.Inverse()\\*cameraToWorld. Remember that the order is inverted for matrix multiplication.\n\u003E Also, I\u0027d probably convert the oceanToLocal to oceanToWorld rather than the change the camera matrix so you don\u0027t have to perform an inverse matrix calculation.\n\nWell I did that, so first the ocean still flooded in the same way but went black, I figured I had to remove the rotation from the localToWorld matrix I pulled from kerbin, since that\u0027s how it\u0027s done in proland, so I keep only the translation. So now the cameraToLocal should be the same as worldToLocal but translated to be relative to the planet\u0027s origin, I put it back in, the ocean works like it used to (moves up and down with the camera)."}]}