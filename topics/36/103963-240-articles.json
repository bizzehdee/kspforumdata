{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":240,"Articles":[{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-18T18:18:04Z","Content":"\u003E \n\u003E \n\u003E 21 minutes ago, MR L A said:\n\u003E \n\u003E \n\u003E huh, I\u0027ll whack it in and see what happens ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022)  \n\u003E   \n\u003E \n\u003E I\u0027ll do a bit of digging but I vaguely remember a few people saying their performance was unexpectedly (much more of a hit than Scatterer should have).  \n\u003E   \n\u003E \n\u003E I\u0027ve used a fresh install of KSP when testing scatterer ![:(](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_sad.gif \u0022:(\u0022) so conflicts don\u0027t appear to be the problem.  \n\u003E   \n\u003E \n\u003E I\u0027m not with my PC for about a week, so I can\u0027t currently show you my config.. it should be exactly as appears on download though\n\u003E \n\nThat was when people updated to the new version but kept using configs made for previous versions."},{"CreatedByName":"MR L A","CreatedById":150940,"CreatedDateTime":"2017-04-18T19:31:29Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, blackrack said:\n\u003E \n\u003E \n\u003E That was when people updated to the new version but kept using configs made for previous versions.\n\u003E \n\nAhh thanks ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022) I\u0027ll report back soon, hopefully I won\u0027t have anything negative to report ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-19T21:38:13Z","Content":"Yeah this is not totally what I expected when I wanted to make the water surface render from below, but it\u0027s a start\n\n![aB3nvs3.jpg](http://i.imgur.com/aB3nvs3.jpg)"},{"CreatedByName":"Poodmund","CreatedById":128643,"CreatedDateTime":"2017-04-19T21:41:42Z","Content":"You just landed upside down and flipped the camera over... you\u0027re so transparent. ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-19T21:44:26Z","Content":"\u003E \n\u003E \n\u003E 2 minutes ago, Poodmund said:\n\u003E \n\u003E \n\u003E You just landed upside down and flipped the camera over... you\u0027re so transparent. ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)\n\u003E \n\nDamn, what planet did I land on?\n\n![AHHFm7Y.jpg](http://i.imgur.com/AHHFm7Y.jpg)"},{"CreatedByName":"qromodynmc","CreatedById":87139,"CreatedDateTime":"2017-04-19T22:03:57Z","Content":"Add blur under water, then all set ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)"},{"CreatedByName":"HafCoJoe","CreatedById":80363,"CreatedDateTime":"2017-04-19T22:18:18Z","Content":"This just keeps getting better and better... ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022) Blackrack is there a chance you can extinguish the crazy underwater view distance from stock?"},{"CreatedByName":"JadeOfMaar","CreatedById":167617,"CreatedDateTime":"2017-04-19T22:26:11Z","Content":"\u003E \n\u003E \n\u003E 40 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Damn, what planet did I land on?\n\u003E \n\nAssuming it\u0027s one of [@StarCrusher96](https://forum.kerbalspaceprogram.com/index.php?/profile/148335-starcrusher96/)\u0027s many, many ~~sexy~~ planets, we have no hope of guessing right so just tell us. D:"},{"CreatedByName":"Galileo","CreatedById":150430,"CreatedDateTime":"2017-04-19T22:30:32Z","Content":"\u003E \n\u003E \n\u003E 3 minutes ago, JadeOfMaar said:\n\u003E \n\u003E \n\u003E Assuming it\u0027s one of [@StarCrusher96](https://forum.kerbalspaceprogram.com/index.php?/profile/148335-starcrusher96/)\u0027s many, many ~~sexy~~ planets, we have no hope of guessing right so just tell us. D:\n\u003E \n\nI think it\u0027s kerbin but it seems so alien underwater, that\u0027s why he said that"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-19T23:10:18Z","Content":"\u003E \n\u003E \n\u003E 52 minutes ago, Avera9eJoe said:\n\u003E \n\u003E \n\u003E This just keeps getting better and better... ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022) Blackrack is there a chance you can extinguish the crazy underwater view distance from stock?\n\u003E \n\nI\u0027m trying to nail the look of the underwater surface look first, I can\u0027t put my finger on what it is exactly but something is wrong, and the view feels restricted to a very small angle, smaller than I expected. The surface seems a bit plastic-y as well.\n\n![Jy1XAEt.jpg](http://i.imgur.com/Jy1XAEt.jpg)\n\n![FmmmFTJ.jpg](http://i.imgur.com/FmmmFTJ.jpg)\n\nNot sure what\u0027s wrong, maybe it just doesn\u0027t pop like this\n\n![1.jpg](https://cdn.shutterstock.com/shutterstock/videos/6205787/thumb/1.jpg)\n\nI\u0027ll try again tomorrow.\n\n\u003E \n\u003E \n\u003E 44 minutes ago, JadeOfMaar said:\n\u003E \n\u003E \n\u003E Assuming it\u0027s one of [@StarCrusher96](https://forum.kerbalspaceprogram.com/index.php?/profile/148335-starcrusher96/)\u0027s many, many ~~sexy~~ planets, we have no hope of guessing right so just tell us. D:\n\u003E \n\nWhat galileo said, it\u0027s kerbin underwater.\n\n**Edited \u003Ctime datetime=\u00222017-04-19T23:11:16Z\u0022 title=\u002204/19/2017 11:11  PM\u0022 data-short=\u00227 yr\u0022\u003EApril 19, 2017\u003C/time\u003E by blackrack**"},{"CreatedByName":"JadeOfMaar","CreatedById":167617,"CreatedDateTime":"2017-04-19T23:12:47Z","Content":"\u003E \n\u003E \n\u003E 2 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E What galileo said, it\u0027s kerbin underwater.\n\u003E \n\nI cannot accept this! ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022)"},{"CreatedByName":"Starwaster","CreatedById":71262,"CreatedDateTime":"2017-04-20T04:28:02Z","Content":"\u003E \n\u003E \n\u003E 5 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E I\u0027m trying to nail the look of the underwater surface look first, I can\u0027t put my finger on what it is exactly but something is wrong, and the view feels restricted to a very small angle, smaller than I expected. The surface seems a bit plastic-y as well.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Not sure what\u0027s wrong, maybe it just doesn\u0027t pop like this\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I\u0027ll try again tomorrow.\n\u003E \n\nIt\u0027s too dark where the normals aren\u0027t angled right at the camera, or away from it. Spots like that should still be getting light though it would be mostly blue due to scattering."},{"CreatedByName":"plonk","CreatedById":116062,"CreatedDateTime":"2017-04-20T16:44:16Z","Content":"\u003E \n\u003E \n\u003E 18 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E I\u0027m trying to nail the look of the underwater surface look first, I can\u0027t put my finger on what it is exactly but something is wrong, and the view feels restricted to a very small angle, smaller than I expected. The surface seems a bit plastic-y as well.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [![Jy1XAEt.jpg](http://i.imgur.com/Jy1XAEt.jpg)](http://i.imgur.com/Jy1XAEt.jpg \u0022Enlarge image\u0022)\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [snip]\n\u003E \n\nBy looking at the image, I assume you have the intensity of the refractive component calculated according to the fresnel equations.  \n\nTo me it looks, as if the transmittant (refractive)  component is rendered pretty good, and \u0022all that is missing\u0022 is the reflective component.\n\n(The observed phenomenon is called Snell\u0027s window. See [https://en.wikipedia.org/wiki/Snell\u0027s_window](https://en.wikipedia.org/wiki/Snell%27s_window) )\n\nAt this point, to achieve a physically accurate model, you\u0027ll probably need to incorporate another, custom tailored mie scattering. And reflection maps. And, and... ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022)\n\nMaybe I\u0027ve got an idea of how to crudely, naively and inaccurately (i.e. purely visually)  ~~approximate~~ fake the intensity values for the reflective component by taking into account 1) the distance of the camera to the surface (perpendicular) 2) the length of the view ray from camera to surface, 3) the length of the reflected view ray (clamped to a max value, length to ground otherwise) and 4) the cosine of the angle of the reflected view ray to the water surface (or sine using the normal). It\u0027s basically distance fog with additional steps to increase light intensity the nearer and more parallel the reflected view-ray is to the water surface. It\u0027s based on the assumption that there is more scattered light traveling in any direction at any point near the surface, exponentially decreasing in intensity the deeper it gets.\n\nJust an idea. Yours is probably already better![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022)\n\n**Edited \u003Ctime datetime=\u00222017-04-20T17:17:05Z\u0022 title=\u002204/20/2017 05:17  PM\u0022 data-short=\u00227 yr\u0022\u003EApril 20, 2017\u003C/time\u003E by plonk**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-20T17:19:15Z","Content":"\u003E \n\u003E \n\u003E 57 minutes ago, plonk said:\n\u003E \n\u003E \n\u003E By looking at the image, I assume you have the intensity of the refractive component calculated according to the fresnel equations.  \n\u003E \n\u003E To me it looks, as if the transmittant (refractive)  component is rendered pretty good, and \u0022all that is missing\u0022 is the reflective component.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E (The observed phenomenon is called Snell\u0027s window. See [https://en.wikipedia.org/wiki/Snell\u0027s_window](https://en.wikipedia.org/wiki/Snell%27s_window) )\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E At this point, to achieve a physically accurate model, you\u0027ll probably need to incorporate another, custom tailored mie scattering. And reflection maps. And, and... ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022)\n\u003E \n\u003E \n\u003E \n\u003E Maybe I\u0027ve got an idea of how to crudely, naively and inaccurately (i.e. purely visually)  approximate the intensity values for the reflective component by taking into account 1) the distance of the camera to the surface (perpendicular) 2) the length of the view ray from camera to surface, 3) the length of the reflected view ray (clamped to a max value, length to ground otherwise) and 4) the cosine of the angle of the reflected view ray to the water surface (or sine using the normal). It\u0027s basically distance fog with additional steps to increase light intensity the nearer and more parallel the reflected view-ray is to the water surface. It\u0027s based on the assumption that there is more scattered light traveling in any direction at any point near the surface, exponentially decreasing in intensity the deeper it gets.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Just an idea. Yours is probably already better![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022)\n\u003E \n\nI\u0027m using the fresnel equations but I think there is a problem somewhere in the refracted ray calculation.\n\nBasically when debugging the fresnel value visually I noticed that the \u0022snell\u0027s window\u0022 seems twice as large as in the image above, yet my refracted ray seems to be hitting maximum angle sooner. I probably messed up something stupid in the transformation from ocean space to world space or whatever.\n\nIf you look in the first image, you\u0027ll see 3 distinct zones, the center zone where you can see the sky, then the dark blue zone, then the outer, black zone at the edge of the screen.\n\nWhen debugging the fresnel value, zone 3 should be where we have total reflection and zone 1 and 2 are the same zone of refraction, where the refracted angle never reaches as low as the horizon.\n\nHowever what\u0027s happening up there is that in zone 1 the angle is refracted to go towards the sky, in zone 2 the angles are refracted towards the horizon or lower, which is why their shading is messed up, and zone 3 is total reflection.\n\nPlus there are these weird white spots and the whole look is off making me think something is off with the normals or whatever\n\n![l8sl3Hx.jpg](http://i.imgur.com/l8sl3Hx.jpg)\n\nAnyway, I\u0027m sure it\u0027s something stupid, I was tired last night and experimenting with something new. For the reflected component I haven\u0027t really thought about it yet but probably something similar to the distance fog you mentioned and if I can figure it out, some kind of light scattering depending on the viewing direction and the angle of the sun. I\u0027ll just have to research it and experiment a bit.\n\nEdited:\n\nHere\u0027s what debugging the fresnel value looks like, in red transmission and blue reflection, notice how much bigger it is than the one above.\n\n![3WCUjkc.jpg](http://i.imgur.com/3WCUjkc.jpg)\n\n**Edited \u003Ctime datetime=\u00222017-04-20T17:44:26Z\u0022 title=\u002204/20/2017 05:44  PM\u0022 data-short=\u00227 yr\u0022\u003EApril 20, 2017\u003C/time\u003E by blackrack**"},{"CreatedByName":"HafCoJoe","CreatedById":80363,"CreatedDateTime":"2017-04-20T17:21:56Z","Content":"Imo it\u0027s great as is :\u0027)\n\n**Edited \u003Ctime datetime=\u00222017-04-20T17:22:39Z\u0022 title=\u002204/20/2017 05:22  PM\u0022 data-short=\u00227 yr\u0022\u003EApril 20, 2017\u003C/time\u003E by Avera9eJoe**"},{"CreatedByName":"Starwaster","CreatedById":71262,"CreatedDateTime":"2017-04-20T23:20:44Z","Content":"\u003E \n\u003E \n\u003E 5 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E I\u0027m using the fresnel equations but I think there is a problem somewhere in the refracted ray calculation.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Basically when debugging the fresnel value visually I noticed that the \u0022snell\u0027s window\u0022 seems twice as large as in the image above, yet my refracted ray seems to be hitting maximum angle sooner. I probably messed up something stupid in the transformation from ocean space to world space or whatever.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E If you look in the first image, you\u0027ll see 3 distinct zones, the center zone where you can see the sky, then the dark blue zone, then the outer, black zone at the edge of the screen.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E When debugging the fresnel value, zone 3 should be where we have total reflection and zone 1 and 2 are the same zone of refraction, where the refracted angle never reaches as low as the horizon.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E However what\u0027s happening up there is that in zone 1 the angle is refracted to go towards the sky, in zone 2 the angles are refracted towards the horizon or lower, which is why their shading is messed up, and zone 3 is total reflection.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Plus there are these weird white spots and the whole look is off making me think something is off with the normals or whatever\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Anyway, I\u0027m sure it\u0027s something stupid, I was tired last night and experimenting with something new. For the reflected component I haven\u0027t really thought about it yet but probably something similar to the distance fog you mentioned and if I can figure it out, some kind of light scattering depending on the viewing direction and the angle of the sun. I\u0027ll just have to research it and experiment a bit.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Edited:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Here\u0027s what debugging the fresnel value looks like, in red transmission and blue reflection, notice how much bigger it is than the one above.\n\u003E \n\nSomewhere in there you\u0027re getting the dot product of the viewing angle and the normals, right? Are you using the absolute value of that? If not that could be why you\u0027re getting those results."},{"CreatedByName":"Drew Kerman","CreatedById":103177,"CreatedDateTime":"2017-04-21T11:15:19Z","Content":"have you been able to get the nearClipPlane parameter back in for the next release? Just a reminder. Really missing it for IVA photos because a lot of the time the IVA model gets clipped in view of the camera under stock settings\n\n**Edited \u003Ctime datetime=\u00222017-04-21T11:44:40Z\u0022 title=\u002204/21/2017 11:44  AM\u0022 data-short=\u00227 yr\u0022\u003EApril 21, 2017\u003C/time\u003E by Drew Kerman**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-21T21:11:07Z","Content":"Basic underwater surface \u002B distance \u0022fog\u0022 (only applied to water surface at the moment). Shading to be improved.\n\n\u003Ciframe data-controller=\u0022core.front.core.autosizeiframe\u0022 scrolling=\u0022no\u0022 src=\u0022https://forum.kerbalspaceprogram.com/index.php?app=core\u0026module=system\u0026controller=embed\u0026url=http://imgur.com/a/R95Jl\u0022 style=\u0022height:453px;\u0022\u003E\u003C/iframe\u003E\n\n\u003E \n\u003E \n\u003E 21 hours ago, Starwaster said:\n\u003E \n\u003E \n\u003E Somewhere in there you\u0027re getting the dot product of the viewing angle and the normals, right? Are you using the absolute value of that? If not that could be why you\u0027re getting those results.\n\u003E \n\nThat would be a very rookie mistake to make.\n\n\u003E \n\u003E \n\u003E 9 hours ago, Drew Kerman said:\n\u003E \n\u003E \n\u003E have you been able to get the nearClipPlane parameter back in for the next release? Just a reminder. Really missing it for IVA photos because a lot of the time the IVA model gets clipped in view of the camera under stock settings\n\u003E \n\nShould I just make it a separate, minimal mod?\n\n**Edited \u003Ctime datetime=\u00222017-04-21T21:11:51Z\u0022 title=\u002204/21/2017 09:11  PM\u0022 data-short=\u00227 yr\u0022\u003EApril 21, 2017\u003C/time\u003E by blackrack**"},{"CreatedByName":"Poodmund","CreatedById":128643,"CreatedDateTime":"2017-04-21T21:33:55Z","Content":"Wow, Kerbal Submarine Program can finally be a thing."},{"CreatedByName":"HafCoJoe","CreatedById":80363,"CreatedDateTime":"2017-04-21T22:47:12Z","Content":"The real question though is will the camera behave when deep underwater..."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-21T22:51:27Z","Content":"\u003E \n\u003E \n\u003E 3 minutes ago, Avera9eJoe said:\n\u003E \n\u003E \n\u003E The real question though is will the camera behave when deep underwater...\n\u003E \n\nWhy wouldn\u0027t it? What happens deep underwater?"},{"CreatedByName":"Halban","CreatedById":89536,"CreatedDateTime":"2017-04-21T23:01:37Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, blackrack said:\n\u003E \n\u003E \n\u003E Basic underwater surface \u002B distance \u0022fog\u0022 (only applied to water surface at the moment). Shading to be improved.\n\u003E \n\nCan\u0027t wait to film something in an environment like that, it looks stunning.\n\n\u003E \n\u003E \n\u003E 1 hour ago, blackrack said:\n\u003E \n\u003E \n\u003E Should I just make it a separate, minimal mod?\n\u003E \n\nI\u0027d appreciate something simple like that. Given that it\u0027s rather important to me."},{"CreatedByName":"HafCoJoe","CreatedById":80363,"CreatedDateTime":"2017-04-21T23:14:05Z","Content":"\u003E \n\u003E \n\u003E 21 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Why wouldn\u0027t it? What happens deep underwater?\n\u003E \n\nHm, it may have been fixed when they re-did water physics but it used to be that your camera would try and point straight up if you go into negative altitudes. I guess they removed that now?"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-04-21T23:15:26Z","Content":"\u003E \n\u003E \n\u003E Just now, Avera9eJoe said:\n\u003E \n\u003E \n\u003E Hm, it may have been fixed when they re-did water physics but it used to be that your camera would try and point straight up if you go into negative altitudes. I guess they removed that now?\n\u003E \n\nI just went 1 km deep and it seems everything is working fine."},{"CreatedByName":"Drew Kerman","CreatedById":103177,"CreatedDateTime":"2017-04-22T00:24:20Z","Content":"\u003E \n\u003E \n\u003E 3 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E Should I just make it a separate, minimal mod?\n\u003E \n\nI don\u0027t think it\u0027s worth the extra effort that would go with having to keep track of it separately, but that would be your call. From a user standpoint, I went back to 1.1.3 just so I could get one photo from an IVA using this setting and I did notice it affected the ground somewhat if it was set too low, so just having it as a value people can play with within Scatterer (since its Scatterer that would be causing any ground/water flickering) seems to make the most sense. Keeping all problems in one place and all that."}]}