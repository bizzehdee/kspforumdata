{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":143,"Articles":[{"CreatedByName":"Oddible","CreatedById":74605,"CreatedDateTime":"2016-03-02T17:40:12Z","Content":"\u003E \n\u003E \n\u003E 12 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E Switch to dx11 or disable terrain shadows.\n\u003E \n\nThanks that did it.  \n\nNext question:\n\nWhat other mods work great with scatterer for the best visuals - I\u0027ve seen some really fantastic screenshots and mine look nothing like that."},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2016-03-02T18:07:41Z","Content":"I didn\u0027t look too carefully, but I\u0027m assuming that the large arrays causing the memory issues are the big Color arrays used to set some texture.\n\nThere are a few things that might be of interest regarding Color vs Color32:\n\nUsing Color32 rather than Color saves a lot of memory. Since a Color object uses 4\\*32 bit floats, it takes up four times the memory of a Color32 object, which uses 4\\*8 bit bytes.\n\nIf the end result is to apply this Color array to a texture then there is no difference in the resulting texture colors as Unity converts all Color references to Color32.\n\nUsing [Texture.SetPixels is considerably slower than Texture.SetPixels32](http://answers.unity3d.com/questions/266170/for-different-texture-sizes-which-is-faster-setpix.html); that internal Color -\u003E Color32 conversion is actually quite slow, so cutting out that step can speed things up. The only drawback is that in Unity 4.x you have to set the entire texture\u0027s colors when using SetPixels32, whereas SetPixels allows for setting any arbitrary number of pixels; this is fixed in Unity 5; it looks like this isn\u0027t a problem here.\n\nThe only issue that I can think of is about the source of the colors in the first place. If they are all float Color values then you would have to convert them to Color32 and so would lose some of the speed advantage."},{"CreatedByName":"sDaZe","CreatedById":111181,"CreatedDateTime":"2016-03-02T19:09:01Z","Content":"New eclipses looking good ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022) \n\n![0cqHgmK.jpg](http://i.imgur.com/0cqHgmK.jpg)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-02T19:50:54Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, DMagic said:\n\u003E \n\u003E \n\u003E I didn\u0027t look too carefully, but I\u0027m assuming that the large arrays causing the memory issues are the big Color arrays used to set some texture.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E There are a few things that might be of interest regarding Color vs Color32:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Using Color32 rather than Color saves a lot of memory. Since a Color object uses 4\\*32 bit floats, it takes up four times the memory of a Color32 object, which uses 4\\*8 bit bytes.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E If the end result is to apply this Color array to a texture then there is no difference in the resulting texture colors as Unity converts all Color references to Color32.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Using [Texture.SetPixels is considerably slower than Texture.SetPixels32](http://answers.unity3d.com/questions/266170/for-different-texture-sizes-which-is-faster-setpix.html); that internal Color -\u003E Color32 conversion is actually quite slow, so cutting out that step can speed things up. The only drawback is that in Unity 4.x you have to set the entire texture\u0027s colors when using SetPixels32, whereas SetPixels allows for setting any arbitrary number of pixels; this is fixed in Unity 5; it looks like this isn\u0027t a problem here.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E The only issue that I can think of is about the source of the colors in the first place. If they are all float Color values then you would have to convert them to Color32 and so would lose some of the speed advantage.\n\u003E \n\nI create a big color array and a bunch of other float arrays as a preliminary step to loading a floating point texture from disk into a rendertexture. Since unity 4 doesn\u0027t support 32-bit per channel floating point textures outside of rendertextures the only way to do this is to read the file and encode it into 4 separate 8-bit per channel texture2D textures and then use a shader to read everything and decode it back to a 32-bit rendertexture. This is only done when switching scenes and after that I need all the arrays and texture2D textures gone ASAP. The issue is that the collector never gets rid of the Color and float arrays so although Color32 arrays would help it would still leak a bunch of memory. To get around this I used the Marshal class from System.Runtime.InteropServices to allocate some memory and then manage and free it manually, it seems to work quite nicely and saves up a lot of memory.\n\nAlthough using a Color32 array could limit the size of the \u0022memory spike\u0022 during loading by a bit so I\u0027ll do this. For your tip about SetPixels32, I would indeed need to convert float values to Color32 (or 1 byte floating point number, what\u0027s that called? a minifloat?) so in the end probably like you said there wouldn\u0027t be a speed advantage. To clarify the source is not Color values but rather their float components, calculated by the encode function.\n\n\u003E \n\u003E \n\u003E 2 hours ago, Oddible said:\n\u003E \n\u003E \n\u003E Thanks that did it.  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Next question:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E What other mods work great with scatterer for the best visuals - I\u0027ve seen some really fantastic screenshots and mine look nothing like that.\n\u003E \n\nYou could download EVE which adds clouds or get one of the visual packs (e.g SVE, KSPRC) which include EVE with custom cloud configs and other custom textures and miscellaneous visual mods.\n\n\u003E \n\u003E \n\u003E 52 minutes ago, sDaZe said:\n\u003E \n\u003E \n\u003E New eclipses looking good ![:D](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif \u0022:D\u0022)\n\u003E \n\nFinally, a screenshot with something other than lens flare, thank you ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)\n\n**Edited \u003Ctime datetime=\u00222016-03-02T20:01:25Z\u0022 title=\u002203/02/2016 08:01  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 2, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"sDaZe","CreatedById":111181,"CreatedDateTime":"2016-03-02T20:11:10Z","Content":"\u003E \n\u003E \n\u003E 20 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Finally, a screenshot with something other than lens flare, thank you ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)\n\u003E \n\nhehe np ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022)"},{"CreatedByName":"selfish_meme","CreatedById":125899,"CreatedDateTime":"2016-03-03T01:36:48Z","Content":"These parts I just decoupled I think are leaving god rays\n\n![UyiYGne.png](http://i.imgur.com/UyiYGne.png)\n\nI shouldn\u0027t have F2\u0027d before taking the screenshot or you would see the debris markers, so there\u0027s some unnecessary calculation going on there\n\n**Edited \u003Ctime datetime=\u00222016-03-03T01:39:31Z\u0022 title=\u002203/03/2016 01:39  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 3, 2016\u003C/time\u003E by selfish\\_meme**"},{"CreatedByName":"Brigadier","CreatedById":147109,"CreatedDateTime":"2016-03-03T02:01:50Z","Content":"\u003E \n\u003E \n\u003E 2 hours ago, selfish\\_meme said:\n\u003E \n\u003E \n\u003E These parts I just decoupled I think are leaving god rays\n\u003E \n\nTo be honest, I\u0027ve been getting these, too, lately.  As I\u0027m testing the new .dll for memory usage, I\u0027ll see if I can capture the effect.  Is there something in particular you want to see tested, or just memory consumption according to GCMonitor?\n\n\u003Cu\u003EEdit: Test Results\u003C/u\u003E\n\nKSP 1.0.5 32-bit, Win7 64-bit, 12GB RAM, Scatterer options enabled: Lens Flare, Eclipse, Godrays.  Ocean shaders don\u0027t work well for me and my older gfx card.\n\nKSP commandline: -popupwindow -single-instance -force-opengl\n\nThe game save was restored between the tests so it was the same starting point.  I started the game, went to the KSC, VAB, KSC, TS and a craft in Kerbin orbit, in sequence.\n\n| dll Version | Start | KSC | VAB | KSC | TS | Craft |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1.0.5900.13398 | 2351 | 2823 | 2906 | 2944 | 2904 | 2996 |\n| 1.0.5905.12084 | 2342 | 2714 | 2694 | 2855 | 2815 | 2892 |\n\nThe only anomaly was after I replaced the .dll and started the game, the Universal Storage mod parts were not recognized on getting to the KSC screen.  This happens to me occasionally when I update mods.  When it does, I clear the temporary Module Manager files to force it to rebuild its database.  The numbers above for the new dll run are for a post-rebuild game start.\n\nScreen changes to enter the KSC (from a craft or the VAB) and to load a craft from the TS seemed longer but I didn\u0027t time them.\n\nFinally, Scatterer doesn\u0027t show up on the KSP-AVC installed mods list.  Never noticed that before.  Of course, it appears in CKAN.\n\nAny memory saving is good :-)\n\n**Edited \u003Ctime datetime=\u00222016-03-03T03:50:45Z\u0022 title=\u002203/03/2016 03:50  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 3, 2016\u003C/time\u003E by Brigadier**\n  \nAdded test results"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-03T07:42:59Z","Content":"\u003E \n\u003E \n\u003E 12 hours ago, selfish\\_meme said:\n\u003E \n\u003E \n\u003E These parts I just decoupled I think are leaving god rays\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I shouldn\u0027t have F2\u0027d before taking the screenshot or you would see the debris markers, so there\u0027s some unnecessary calculation going on there\n\u003E \n\n\u003E \n\u003E \n\u003E 11 hours ago, Brigadier said:\n\u003E \n\u003E \n\u003E To be honest, I\u0027ve been getting these, too, lately.  As I\u0027m testing the new .dll for memory usage, I\u0027ll see if I can capture the effect.  Is there something in particular you want to see tested, or just memory consumption according to GCMonitor?\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E \u003Cu\u003EEdit: Test Results\u003C/u\u003E\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E KSP 1.0.5 32-bit, Win7 64-bit, 12GB RAM, Scatterer options enabled: Lens Flare, Eclipse, Godrays.  Ocean shaders don\u0027t work well for me and my older gfx card.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E KSP commandline: -popupwindow -single-instance -force-opengl\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E The game save was restored between the tests so it was the same starting point.  I started the game, went to the KSC, VAB, KSC, TS and a craft in Kerbin orbit, in sequence.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E | dll Version | Start | KSC | VAB | KSC | TS | Craft |\n\u003E | --- | --- | --- | --- | --- | --- | --- |\n\u003E | 1.0.5900.13398 | 2351 | 2823 | 2906 | 2944 | 2904 | 2996 |\n\u003E | 1.0.5905.12084 | 2342 | 2714 | 2694 | 2855 | 2815 | 2892 |\n\u003E \n\u003E \n\u003E \n\u003E The only anomaly was after I replaced the .dll and started the game, the Universal Storage mod parts were not recognized on getting to the KSC screen.  This happens to me occasionally when I update mods.  When it does, I clear the temporary Module Manager files to force it to rebuild its database.  The numbers above for the new dll run are for a post-rebuild game start.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Screen changes to enter the KSC (from a craft or the VAB) and to load a craft from the TS seemed longer but I didn\u0027t time them.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Finally, Scatterer doesn\u0027t show up on the KSP-AVC installed mods list.  Never noticed that before.  Of course, it appears in CKAN.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Any memory saving is good :-)\n\u003E \n\nFor the godrays it\u0027s a limitation of the current method, check the first entry in the known issues section in the OP.\n\nThanks for the test results.\n\n**Edited:**\n\nI pushed the memory optimizations even further, I believe the numbers speak for themselves.\n\n![vyu8I08.png](http://i.imgur.com/vyu8I08.png)\n\nAs with the previous one, this might be a bit dodgy so please test it out and report on whether it works or not and what kind of memory savings you get from it. If you have the 64bit workaround on windows also do test with it.  \n  \n[https://github.com/LGhassen/Scatterer/raw/improvedMemoryManagement/scatterer/bin/Release/scatterer.dll](https://github.com/LGhassen/Scatterer/raw/improvedMemoryManagement/scatterer/bin/Release/scatterer.dll)\n\nPaging the people who tested the previous version: [@Brigadier](https://forum.kerbalspaceprogram.com/index.php?/profile/147109-brigadier/)  [@SkyKaptn](https://forum.kerbalspaceprogram.com/index.php?/profile/153990-skykaptn/) [@selfish_meme](https://forum.kerbalspaceprogram.com/index.php?/profile/125899-selfish_meme/)  \n\nI believe the loading process should be near optimal now, there might still be some \u0022per-frame\u0022 leaks which I will check out next.\n\nIf this works for everyone this should be great news for people with a memory budget and people on 32bit.\n\n**Edited \u003Ctime datetime=\u00222016-03-03T13:43:19Z\u0022 title=\u002203/03/2016 01:43  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 3, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"JDarksword","CreatedById":145985,"CreatedDateTime":"2016-03-03T15:30:12Z","Content":"for some reason (idk why probably the amount of mods i have though) i crash on startup with this mod, it really makes me sad\n\nill try to link a error report if possible."},{"CreatedByName":"Paul_Sawyer","CreatedById":152646,"CreatedDateTime":"2016-03-03T16:35:01Z","Content":"Windows 8 64bit, KSP 1-0-5 32bit  \n\nOpenGL forced  \n\nThis is what GCmonitor shows to me:\n\n|  | Original dll | Newest dll |\n| --- | --- | --- |\n| KSC | 3217 | 3143 |\n| Runway | 3513 | 3214 |\n| In orbit | 3756 | 3294 |\n\nHaven\u0027t noticed any extra loading time. I pretty much like it ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022)  \n\nEDIT: And also, as I have already mentioned, I like the Sun...  \n![yv50EUH.png](http://i.imgur.com/yv50EUH.png)\n\n**Edited \u003Ctime datetime=\u00222016-03-03T17:36:19Z\u0022 title=\u002203/03/2016 05:36  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 3, 2016\u003C/time\u003E by Paul\\_Sawyer**"},{"CreatedByName":"MR L A","CreatedById":150940,"CreatedDateTime":"2016-03-03T16:52:06Z","Content":"Love the work!\n\nI\u0027ve been using scatterer for a while now, stuck with it when the ocean was a Z-fighting (no not the Goku kind) mess too.  \n\nLatest release is simply beautiful too. I haven\u0027t noticed any bugs additional to the ones already reported.. though I was wondering, if it is possible for you to tell, what the release of 1.1 will have on the mod? Are you expecting a million new bugs/unplayable until you update scatterer or will the shift between Unity variants not impact your graphical work so much?"},{"CreatedByName":"Brigadier","CreatedById":147109,"CreatedDateTime":"2016-03-03T17:20:20Z","Content":"Under the same test conditions (exactly the same mods but a later game save - I\u0027ve moved on).  Previous test result included for comparison:\n\n| dll Version | Start | KSC | VAB | KSC | TS | Vessel |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1.0.5905.12084 | 2342 | 2714 | 2694 | 2855 | 2815 | 2892 |\n| 1.0.5609.26962 | 2324 | 2579 | 2600 | 2737 | 2698 | 2748 |\n\nNice improvement.\n\nIdeally, I should run this scenario a couple of time to get an average but...well...I actually want to play a game ![:wink:](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif \u0022:wink:\u0022)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-03T17:48:10Z","Content":"\u003E \n\u003E \n\u003E 2 hours ago, JDarksword said:\n\u003E \n\u003E \n\u003E for some reason (idk why probably the amount of mods i have though) i crash on startup with this mod, it really makes me sad\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E ill try to link a error report if possible.\n\u003E \n\nIt\u0027s probably your memory usage going over the 32bit limit, try to remove all other mods and see if it works, also try the new .dll linked above, it does wonders for the memory usage.\n\n\u003E \n\u003E \n\u003E 52 minutes ago, MR L A said:\n\u003E \n\u003E \n\u003E Love the work!\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I\u0027ve been using scatterer for a while now, stuck with it when the ocean was a Z-fighting (no not the Goku kind) mess too.  \n\u003E \n\u003E Latest release is simply beautiful too. I haven\u0027t noticed any bugs additional to the ones already reported.. though I was wondering, if it is possible for you to tell, what the release of 1.1 will have on the mod? Are you expecting a million new bugs/unplayable until you update scatterer or will the shift between Unity variants not impact your graphical work so much?\n\u003E \n\nOf course when 1.1 releases nothing will work until I update the mod, but I\u0027m not expecting any significant difficulties in making it run on 1.1\n\n\u003E \n\u003E \n\u003E 1 hour ago, Paul\\_Sawyer said:\n\u003E \n\u003E \n\u003E Windows 8 64bit, KSP 1-0-5 32bit  \n\u003E \n\u003E OpenGL forced  \n\u003E \n\u003E This is what GCmonitor shows to me:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E |  | Original dll | Newest dll |\n\u003E | --- | --- | --- |\n\u003E | KSC | 3217 | 3143 |\n\u003E | Runway | 3513 | 3214 |\n\u003E | In orbit | 3756 | 3294 |\n\u003E \n\u003E \n\u003E \n\u003E Haven\u0027t noticed any extra loading time. I pretty much like it ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022)  \n\u003E   \n\u003E \n\u003E EDIT: And also, as I have already mentioned, I like the Sun...\n\u003E \n\n\u003E \n\u003E \n\u003E 24 minutes ago, Brigadier said:\n\u003E \n\u003E \n\u003E Under the same test conditions (exactly the same mods but a later game save - I\u0027ve moved on).  Previous test result included for comparison:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E | dll Version | Start | KSC | VAB | KSC | TS | Vessel |\n\u003E | --- | --- | --- | --- | --- | --- | --- |\n\u003E | 1.0.5905.12084 | 2342 | 2714 | 2694 | 2855 | 2815 | 2892 |\n\u003E | 1.0.5609.26962 | 2324 | 2579 | 2600 | 2737 | 2698 | 2748 |\n\u003E \n\u003E \n\u003E \n\u003E Nice improvement.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Ideally, I should run this scenario a couple of time to get an average but...well...I actually want to play a game ![:wink:](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif \u0022:wink:\u0022)\n\u003E \n\nGreat, thank you both! Now all I need is some reports that it also works fine on linux and mac."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-03-03T18:13:40Z","Content":"So what\u0027s this I hear about manual buffer alloc/dealloc? I use color arrays in DTL, and may be curious to know if that might have a memory leak from loading textures?"},{"CreatedByName":"Nansuchao","CreatedById":135151,"CreatedDateTime":"2016-03-03T18:35:54Z","Content":"That\u0027s pure poetry. Thanks again, Blackrack\n\n![RDRbLv8.png](http://i.imgur.com/RDRbLv8.png)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-03T18:58:59Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, rbray89 said:\n\u003E \n\u003E \n\u003E So what\u0027s this I hear about manual buffer alloc/dealloc? I use color arrays in DTL, and may be curious to know if that might have a memory leak from loading textures?\n\u003E \n\nI use large arrays as a preliminary step to get data from disk into a 32-bit per channel rendertexture. I noticed that large color and float arrays don\u0027t seem to be freed after they are destroyed or go out of scope and the collector is called, I made sure there were no remaining references or anything. I only need to keep the 16mb rendertexture after processing but every time the memory usage would balloon up by 300mb or so. I\u0027m not sure what exactly was going on, some people will tell you that the garbage collector is itself garbage and doesn\u0027t manage arrays well etc etc... in the end the only thing that helped was using System.Runtime.InteropServices to [allocate some unmanaged memory](https://github.com/LGhassen/Scatterer/blob/improvedMemoryManagement/scatterer/EncodeFloat.cs#L47), and then[manage it manually](https://github.com/LGhassen/Scatterer/blob/improvedMemoryManagement/scatterer/EncodeFloat.cs#L262-L265) as a float or color buffer and free it when I\u0027m done, works like a charm (sorry source code is a bit of a mess right now as I mostly left he old code commented and there are bits and pieces everywhere). I\u0027ve also had to avoid functions that return arrays in general, for example BitConverter.getBytes() was also causing some leaks along a few other things, when used in loops those were pretty bad.\n\nOne peculiar behaviour that I observed is that these leaks don\u0027t go on forever with every scene change or operation but seem to top out at 500 mb or so, I\u0027ve read somewhere that arrays are managed differently in memory, so maybe 500 mb is some kind of limit at which the collector starts doing something for the arrays but 500 mb is still way too much for KSP. Don\u0027t know, maybe you could shed some light on this.\n\nYou could isolate the color arrays and check their impact on memory, and whether destroying and creating new ones will keep inflating the memory usage. In my case the combined size of temporary arrays was a bit big so having them keep leaking on scene changes was really bad.\n\n\u003E \n\u003E \n\u003E 48 minutes ago, Nansuchao said:\n\u003E \n\u003E \n\u003E That\u0027s pure poetry. Thanks again, Blackrack\n\u003E \n\nYou\u0027re welcome ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)\n\n**Edited \u003Ctime datetime=\u00222016-03-03T19:24:24Z\u0022 title=\u002203/03/2016 07:24  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 3, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2016-03-03T20:55:21Z","Content":"Btw, assuming that the body is perfectly circular isn\u0027t always working - sun flare is visible through Gilly, for example. Would it be possible to check it against body shape mor eprecisely in later versions? Maybe it isn\u0027t needed for all bodies, as large ones can be assumed to be perfect spheres."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-03T21:11:46Z","Content":"\u003E \n\u003E \n\u003E 15 minutes ago, sashan said:\n\u003E \n\u003E \n\u003E Btw, assuming that the body is perfectly circular isn\u0027t always working - sun flare is visible through Gilly, for example. Would it be possible to check it against body shape mor eprecisely in later versions? Maybe it isn\u0027t needed for all bodies, as large ones can be assumed to be perfect spheres.\n\u003E \n\nWhy do you think I\u0027m assuming spheres for the lens flare? It works via raycasting and checking the depth buffer, but I guess the depth buffer isn\u0027t rendered for planets that don\u0027t have scattering effects, I\u0027ll fix it for next updates."},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2016-03-03T21:14:59Z","Content":"\u003E \n\u003E \n\u003E Just now, blackrack said:\n\u003E \n\u003E \n\u003E Why do you think I\u0027m assuming spheres for the lens flare? It works via raycasting and checking the depth buffer, but I guess the depth buffer isn\u0027t rendered for planets that don\u0027t have scattering effects, I\u0027ll fix it for next updates.\n\u003E \n\nBecause that\u0027s what it looks like on GIlly - there\u0027s an invisible sphere with surface at 0m altitude that blocks the flare, and large hills that stick out don\u0027t block it. So, I guess your guess is right. Anyway, I had to report it. ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-03T21:18:46Z","Content":"\u003E \n\u003E \n\u003E 1 minute ago, sashan said:\n\u003E \n\u003E \n\u003E Because that\u0027s what it looks like on GIlly - there\u0027s an invisible sphere with surface at 0m altitude that blocks the flare, and large hills that stick out don\u0027t block it. So, I guess your guess is right. Anyway, I had to report it. ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)\n\u003E \n\nWell it works with the mountains on Kerbin so that\u0027s not really it ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022) Anyway, I\u0027m guessing that\u0027s Just raycasting in scaledSpace working, but not quite matching up to the PQS. I had the same problem on Kerbin before I decided to just use the depth buffer. I\u0027ll make it so the depth buffer renders for checking occlusion even on planets without scattering effects, perhaps with a reduced resolution in this case."},{"CreatedByName":"sashan","CreatedById":98897,"CreatedDateTime":"2016-03-03T21:25:57Z","Content":"\u003E \n\u003E \n\u003E 8 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Well it works with the mountains on Kerbin so that\u0027s not really it\n\u003E \n\nThey are too small and rare to notice it easily.  \n\nBtw, it works while landed - it\u0027s only scaled space and orbit view that are buggy. I\u0027ll test it more tomorrow - I have a base on Gilly.  \n\nOh, and you need to change Eve setup - it\u0027s kinda broken from certain angles.  \n![7wi6CGY.png](http://i.imgur.com/7wi6CGY.png)  \n\nIt looks great from low altitudes tho:  \n![12823433_860848314037835_821158690191566](https://scontent-ams3-1.xx.fbcdn.net/hphotos-xtp1/t31.0-8/12823433_860848314037835_8211586901915668393_o.jpg)\n\n**Edited \u003Ctime datetime=\u00222016-03-03T21:27:03Z\u0022 title=\u002203/03/2016 09:27  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 3, 2016\u003C/time\u003E by sashan**"},{"CreatedByName":"stratochief66","CreatedById":59541,"CreatedDateTime":"2016-03-03T22:06:33Z","Content":"[12:56] \u003Ctheysen\u003E stratochief|away, so the parameters editing he showed result in a much brighter and wider sunflare / spiking on the ground, but the actual problem is that once you pass a certain altitude the sun is just a tiny little dot for me.\u003Cbr\u003E\u003Cbr\u003E\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022http://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/\u0026do=hovercard\u0022 data-mentionid=\u0022104258\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/\u0022\u003E@blackrack\u003C/a\u003E I had the same experience yesterday, but was too sick/tired to make that connection. above somewhere in 90-140km range the sunflare just disappears with RSS. not that I expect you to fix it, I just wanted you to have a better description of the issue we are seeing. your scaling works well in the atmosphere, but seems to cause no sunflare to be applied when out in space\n\u003C/theysen\u003E"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-03T22:12:49Z","Content":"\u003E \n\u003E \n\u003E 5 minutes ago, stratochief66 said:\n\u003E \n\u003E \n\u003E [12:56] \u003Ctheysen\u003E stratochief|away, so the parameters editing he showed result in a much brighter and wider sunflare / spiking on the ground, but the actual problem is that once you pass a certain altitude the sun is just a tiny little dot for me.\u003Cbr\u003E\u003Cbr\u003E\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022http://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/\u0026do=hovercard\u0022 data-mentionid=\u0022104258\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/\u0022\u003E@blackrack\u003C/a\u003E I had the same experience yesterday, but was too sick/tired to make that connection. above somewhere in 90-140km range the sunflare just disappears with RSS. not that I expect you to fix it, I just wanted you to have a better description of the issue we are seeing. your scaling works well in the atmosphere, but seems to cause no sunflare to be applied when out in space\n\u003E \u003C/theysen\u003E\n\u003E \n\nDoes it still work in mapview?"},{"CreatedByName":"Theysen","CreatedById":144656,"CreatedDateTime":"2016-03-03T22:43:09Z","Content":"\u003E \n\u003E \n\u003E 22 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Does it still work in mapview?\n\u003E \n\nI actually just made some screens during ascent. The first picture shows the default sunflare.cfg values, then I exaggerated it and set them to 0.0011 but it didn\u0027t change anything. \n\nMapview flaring doesn\u0027t work either. I also tried upping the value of sunglare scale in the settings.cfg but this didn\u0027t change the size of the sun. \n\nI know your disclaimer says current RSS/Rescale might not work (besides the heavy z-fighting), but maybe this is of help. \n\n\u003Ciframe class=\u0022imgur-album\u0022 frameborder=\u00220\u0022 height=\u0022550\u0022 src=\u0022//imgur.com/a/6Gtig/embed?background=ffffff\u0026text=1a1a1a\u0026link=4e76c9\u0022 width=\u0022100%\u0022\u003E\u003C/iframe\u003E\n\nMods used:   Stock \u002B RSS only (so it loads as fast as unmodded install basically) \u002B scatterer \n\nLog (if needed): [https://www.dropbox.com/s/rtg05gwlp5y552k/output_log.txt?dl=0](https://www.dropbox.com/s/rtg05gwlp5y552k/output_log.txt?dl=0)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-03-03T22:49:51Z","Content":"\u003E \n\u003E \n\u003E 5 minutes ago, Theysen said:\n\u003E \n\u003E \n\u003E I actually just made some screens during ascent. The first picture shows the default sunflare.cfg values, then I exaggerated it and set them to 0.0011 but it didn\u0027t change anything. \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Mapview flaring doesn\u0027t work either. I also tried upping the value of sunglare scale in the settings.cfg but this didn\u0027t change the size of the sun. \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I know your disclaimer says current RSS/Rescale might not work (besides the heavy z-fighting), but maybe this is of help. \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Mods used:   Stock \u002B RSS only (so it loads as fast as unmodded install basically) \u002B scatterer \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Log (if needed): [https://www.dropbox.com/s/rtg05gwlp5y552k/output_log.txt?dl=0](https://www.dropbox.com/s/rtg05gwlp5y552k/output_log.txt?dl=0)\n\u003E \n\nDoes mapview ever work at all? Which version of the mod are you on?"}]}