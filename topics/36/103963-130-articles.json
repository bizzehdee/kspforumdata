{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":130,"Articles":[{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-11T14:55:17Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, Chimer4 said:\n\u003E \n\u003E \n\u003E Hi blackrack, just a quick one. It seems that the scattering effects hides the city lights from EVE on the night side of a planet in map view, but they are still visible from orbit. I couldn\u0027t see this mentioned in the know issues and couldn\u0027t see it in the most recent pages, so apologies if you already know about this\n\u003E \n\nCan you post some screens?  Preferably before/after.\n\n\u003E \n\u003E \n\u003E 3 hours ago, Gaiiden said:\n\u003E \n\u003E \n\u003E Blackrack do you plan to have the light reflect onto crafts as well?\n\u003E \n\nMost likely not, the planetshine mod has been doing this for a while and looks like it does a very good job at it, besides, all the visual packs already include configs for it and everything. I\u0027m suspecting however he didn\u0027t add planetshine effects to planets because the stock sky/atmo doesn\u0027t take them into account."},{"CreatedByName":"Valerian","CreatedById":124076,"CreatedDateTime":"2016-02-11T15:13:55Z","Content":"\u003E \n\u003E \n\u003E 4 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Most likely not, the planetshine mod has been doing this for a while and looks like it does a very good job at it, besides, all the visual packs already include configs for it and everything. I\u0027m suspecting however he didn\u0027t add planetshine effects to planets because the stock sky/atmo doesn\u0027t take them into account.\n\u003E \n\n\u003E \n\u003E \n\u003E 4 hours ago, Gaiiden said:\n\u003E \n\u003E \n\u003E Nice! Make sure [@Valerian](https://forum.kerbalspaceprogram.com/index.php?/profile/124076-valerian/) knows about this, as although his mod adds planetshine to crafts, he was also planning on doing it for planets as well. Blackrack do you plan to have the light reflect onto crafts as well?\n\u003E \n\nActually I already have everything necessary to make actual planetshine work, and I have already started to code it at an early stage in my experimental branch (on github), I don\u0027t think I need to do anything regarding stock shaders and skies/atmospheres to make it work properly. However I would be interested to know how to make sure that PlanetShine works properly with scatterer.\n\nIf you want to implement it yourself, go for it, because I don\u0027t know when I will have time to start working again on PlanetShine. You could even try to make it work in combination with the current PlanetShine, we could agree on some kind of API, feel free to suggest anything.\n\nFor determining the light color of other bodies, I strongly advise you to use the automatic determining that I use in my experimental version, which renders a view of a celestial body through a hidden camera on a tiny texture, and then gets the average color from it, without needing any config files for planet/moon colors.\n\nThe source code of the experimental version has been refactored a lot and is much cleaner than the master branch, so please only use the experimental branch if possible."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-11T16:09:16Z","Content":"\u003E \n\u003E \n\u003E 42 minutes ago, Valerian said:\n\u003E \n\u003E \n\u003E Actually I already have everything necessary to make actual planetshine work, and I have already started to code it at an early stage in my experimental branch (on github), I don\u0027t think I need to do anything regarding stock shaders and skies/atmospheres to make it work properly. However I would be interested to know how to make sure that PlanetShine works properly with scatterer.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E If you want to implement it yourself, go for it, because I don\u0027t know when I will have time to start working again on PlanetShine. You could even try to make it work in combination with the current PlanetShine, we could agree on some kind of API, feel free to suggest anything.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E For determining the light color of other bodies, I strongly advise you to use the automatic determining that I use in my experimental version, which renders a view of a celestial body through a hidden camera on a tiny texture, and then gets the average color from it, without needing any config files for planet/moon colors.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E The source code of the experimental version has been refactored a lot and is much cleaner than the master branch, so please only use the experimental branch if possible.\n\u003E \n\nI see, though I would personally leave it up to the user to finetune the actual color and set it to what they find visually pleasing, regardless of what the average color is. Especially since the scatterer atmosphere doesn\u0027t cooperate with additional cameras for now.\n\nDo you also render this hidden camera every frame so you can also account for sunsets and dimming realistically?\n\nAnyway, unless I missed something, in my last round of testing I saw that the stock sky doesn\u0027t work with additional lights. I will take a look at what you already have. My main goal is to add atmospheric scattering from light sources other than the sun but I figured it needed some kind of terrain lighting also. I haven\u0027t decided what I want to do yet but I will keep you updated."},{"CreatedByName":"Valerian","CreatedById":124076,"CreatedDateTime":"2016-02-11T16:18:33Z","Content":"\u003E \n\u003E \n\u003E Just now, blackrack said:\n\u003E \n\u003E \n\u003E I see, though I would personally leave it up to the user to finetune the actual color and set it to what they find visually pleasing, regardless of what the average color is. Especially since the scatterer atmosphere doesn\u0027t cooperate with additional cameras for now.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Do you also render this hidden camera every frame so you can also account for sunsets and dimming realistically?\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Anyway, unless I missed something, in my last round of testing I saw that the stock sky doesn\u0027t work with additional lights. I will take a look at what you already have. My main goal is to add atmospheric scattering from light sources other than the sun but I figured it needed some kind of terrain lighting also. I haven\u0027t decided what I want to do yet but I will keep you updated.\n\u003E \n\nCurrently there is an option to fully override the automatic detection for a single celestial body, but I\u0027m also planning in the future to add more fine tuning options per-body for the auto detection, such as intensity, hue, etc.\n\nIf I remember well, I render the camera on LateUpdate(), with a bit of frame skipping (optional), on a 32x32 px texture.\n\nI didn\u0027t test it with scatterer.\n\nI don\u0027t think the armosphere shader will work with anything else than the sun, I was only planning to make the terrain work, using a spotlight."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-11T16:22:14Z","Content":"\u003E \n\u003E \n\u003E 3 minutes ago, Valerian said:\n\u003E \n\u003E \n\u003E Currently there is an option to fully override the automatic detection for a single celestial body, but I\u0027m also planning in the future to add more fine tuning options per-body for the auto detection, such as intensity, hue, etc.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E If I remember well, I render the camera on LateUpdate(), with a bit of frame skipping (optional), on a 32x32 px texture.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I didn\u0027t test it with scatterer.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E I don\u0027t think the armosphere shader will work with anything else than the sun, I was only planning to make the terrain work, using a spotlight.\n\u003E \n\nGot it, any particular reason for picking a spotlight?"},{"CreatedByName":"Valerian","CreatedById":124076,"CreatedDateTime":"2016-02-11T16:25:07Z","Content":"\u003E \n\u003E \n\u003E 14 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Got it, any particular reason for picking a spotlight?\n\u003E \n\nBecause a directional light will illuminate some unintended stuff obviously, and a point light as well.\n\nThe spotlight seems to best solution given what I can do (I know nothing about shaders), but it\u0027s far from perfect obviously, I would have to handle several special \u0022collision\u0022 cases.\n\nIf you have a better solution to suggest I would be glad to hear about it!\n\nThe thing is that currently I can focus on the player vessel because it\u0027s on a different culling layer than the other stuff, but I don\u0027t know of any way that I can use to make a light apply to a specific celestial body, other than the spotlight.\n\n**Edited \u003Ctime datetime=\u00222016-02-11T16:37:36Z\u0022 title=\u002202/11/2016 04:37  PM\u0022 data-short=\u00228 yr\u0022\u003EFebruary 11, 2016\u003C/time\u003E by Valerian**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-11T16:46:24Z","Content":"\u003E \n\u003E \n\u003E 16 minutes ago, Valerian said:\n\u003E \n\u003E \n\u003E Because a directional light will illuminate some unintended stuff obviously, and a point light as well.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E The spotlight seems to best solution given what I can do (I know nothing about shaders), but it\u0027s far from perfect obviously, I would have to handle several special \u0022collision\u0022 cases.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E If you have a better solution to suggest I would be glad to hear about it!\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E The thing is that currently I can focus on the player vessel because it\u0027s on a different culling layer than the other stuff, but I don\u0027t know of any way that I can use to make a light apply to a specific celestial body, other than the spotlight.\n\u003E \n\nI\u0027m afraid there isn\u0027t much we can do about this unless someone re-does the terrain and planet shaders or figures out how to make shaders that work in the same way, then we can build all sort of custom lighting into them without messing up anything else. For now I guess your spotlight method is the best way."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-02-11T17:15:32Z","Content":"\u003E \n\u003E \n\u003E On 2/3/2016 at 7:12 PM, blackrack said:\n\u003E \n\u003E \n\u003E Yeah I see what you mean, this effect is simulated in Proland and is something I am shooting for\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [http://proland.imag.fr/gallery/terrains/image204.png](http://proland.imag.fr/gallery/terrains/image204.png)\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [http://proland.imag.fr/gallery/edition/image390.png](http://proland.imag.fr/gallery/edition/image390.png)\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E However I can\u0027t really achieve it unless I can also modify the orginal terrain shaders to alter the lighting and build both the scattering and a HDR effect directly in them. The depth and extinction settings I have now don\u0027t really compare. The effect is still more or less just an overlay in the end.\n\u003E \n\nYou could also apply another material on top that performs secondary passes like my city lights shader does..."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-11T17:19:29Z","Content":"\u003E \n\u003E \n\u003E 3 minutes ago, rbray89 said:\n\u003E \n\u003E \n\u003E You could also apply another material on top that performs secondary passes like my city lights shader does...\n\u003E \n\nI did try it a while ago but couldn\u0027t quite get the right effect."},{"CreatedByName":"TaintedLion","CreatedById":137942,"CreatedDateTime":"2016-02-11T19:16:59Z","Content":"I\u0027m not seeing scatter effects in the tracking station, and not in the map view either, unless I am controlling a craft in orbit around an atmospheric body."},{"CreatedByName":"HafCoJoe","CreatedById":80363,"CreatedDateTime":"2016-02-11T19:46:15Z","Content":"\u003E \n\u003E \n\u003E 28 minutes ago, TaintedLion said:\n\u003E \n\u003E \n\u003E I\u0027m not seeing scatter effects in the tracking station, and not in the map view either, unless I am controlling a craft in orbit around an atmospheric body.\n\u003E \n\nYep! Nothing out of the ordinary."},{"CreatedByName":"Chimer4","CreatedById":58864,"CreatedDateTime":"2016-02-11T19:57:31Z","Content":"Hi there blackrack, here are the screens you asked for of the city lights being hidden by scatterer. Noticed the first on my main 64bit install, but reproduced on a clean 32bit install with only EVE and scatterer\n\n\u003Ciframe class=\u0022imgur-album\u0022 frameborder=\u00220\u0022 height=\u0022550\u0022 src=\u0022//imgur.com/a/l7KhE/embed?background=ffffff\u0026text=1a1a1a\u0026link=4e76c9\u0022 width=\u0022100%\u0022\u003E\u003C/iframe\u003E"},{"CreatedByName":"Deizelpunk","CreatedById":154790,"CreatedDateTime":"2016-02-11T22:06:02Z","Content":"\u003E \n\u003E \n\u003E 13 hours ago, gkorgood said:\n\u003E \n\u003E \n\u003E it\u0027s unfortunately bugged to hell, and I was only able to get it out to the ocean using hack grav AND hyperedit, and even then it crashed on physics load the next time I went back to it. I\u0027ll put it up on kerbalx if you really want, but I don\u0027t advise using this file.\n\u003E \n\nAlright, if I COULD have the file I would really like it, I will probably modify it a lot but il be sure to credit you if I use it in a video or something!"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-12T02:45:48Z","Content":"\u003E \n\u003E \n\u003E 6 hours ago, Chimer4 said:\n\u003E \n\u003E \n\u003E Hi there blackrack, here are the screens you asked for of the city lights being hidden by scatterer. Noticed the first on my main 64bit install, but reproduced on a clean 32bit install with only EVE and scatterer\n\u003E \n\nI will take a look at it. Has this been happening for a while or only with the new version?\n\n\u003E \n\u003E \n\u003E 7 hours ago, TaintedLion said:\n\u003E \n\u003E \n\u003E I\u0027m not seeing scatter effects in the tracking station, and not in the map view either, unless I am controlling a craft in orbit around an atmospheric body.\n\u003E \n\nThey\u0027re disabled there, loading effects on all planets at once is very memory-heavy and takes a while.\n\n**Edited \u003Ctime datetime=\u00222016-02-12T02:46:01Z\u0022 title=\u002202/12/2016 02:46  AM\u0022 data-short=\u00228 yr\u0022\u003EFebruary 12, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"Drew Kerman","CreatedById":103177,"CreatedDateTime":"2016-02-12T03:32:05Z","Content":"\u003E \n\u003E \n\u003E 10 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E I\u0027m afraid there isn\u0027t much we can do about this unless someone re-does the terrain and planet shaders or figures out how to make shaders that work in the same way, then we can build all sort of custom lighting into them without messing up anything else. For now I guess your spotlight method is the best way.\n\u003E \n\ndoes the new PBR lighting model discussed in this week\u0027s dev notes have anything to do with planet lighting or is that mainly for parts?"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-12T03:33:49Z","Content":"\u003E \n\u003E \n\u003E 1 minute ago, Gaiiden said:\n\u003E \n\u003E \n\u003E does the new PBR lighting model discussed in this week\u0027s dev notes have anything to do with planet lighting or is that mainly for parts?\n\u003E \n\nAs far as I know it\u0027s only for parts."},{"CreatedByName":"Chimer4","CreatedById":58864,"CreatedDateTime":"2016-02-12T07:40:48Z","Content":"\u003E \n\u003E \n\u003E 4 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E I will take a look at it. Has this been happening for a while or only with the new version?\n\u003E \n\nI think it\u0027s been happening for quite some time now. Not exactly sure when I first noticed it."},{"CreatedByName":"Joco223","CreatedById":92530,"CreatedDateTime":"2016-02-12T09:36:21Z","Content":"[@Gaiiden](https://forum.kerbalspaceprogram.com/index.php?/profile/103177-gaiiden/) I think that lightning model is not coming out in 1.1, because its not optimized right now"},{"CreatedByName":"MrMeeb","CreatedById":84238,"CreatedDateTime":"2016-02-12T10:37:23Z","Content":"That would be correct, [@Joco223](https://forum.kerbalspaceprogram.com/index.php?/profile/92530-joco223/) and [@Gaiiden](https://forum.kerbalspaceprogram.com/index.php?/profile/103177-gaiiden/)"},{"CreatedByName":"Joco223","CreatedById":92530,"CreatedDateTime":"2016-02-12T14:27:10Z","Content":"[@Elthy](https://forum.kerbalspaceprogram.com/index.php?/profile/63317-elthy/) [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) Ok, im back at my PC with R9 280X and these are the glitches im getting: [http://imgur.com/zxS4ylP](http://imgur.com/zxS4ylP)"},{"CreatedByName":"TheUnamusedFox","CreatedById":5606,"CreatedDateTime":"2016-02-13T00:15:53Z","Content":"\u003E \n\u003E \n\u003E 9 hours ago, Joco223 said:\n\u003E \n\u003E \n\u003E [@Elthy](https://forum.kerbalspaceprogram.com/index.php?/profile/63317-elthy/) [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) Ok, im back at my PC with R9 280X and these are the glitches im getting: [http://imgur.com/zxS4ylP](http://imgur.com/zxS4ylP)\n\u003E \n\n-I\u0027m on 64-bit WINDOWS. Warning, take it with a grain of salt...- I\u0027m getting the exact same effect with 64k, and only with 64k. GTX 970, 4gb vram."},{"CreatedByName":"Joco223","CreatedById":92530,"CreatedDateTime":"2016-02-13T08:59:57Z","Content":"[@lagcity613](https://forum.kerbalspaceprogram.com/index.php?/profile/5606-lagcity613/) Im using Sigmas Dimensions to scale it up to 6.4"},{"CreatedByName":"TaintedLion","CreatedById":137942,"CreatedDateTime":"2016-02-13T13:15:49Z","Content":"I\u0027m getting the stock ocean appearing through the waves on Laythe. I tried looking for the Compiled-OceanBack.shader and Compiled-SphereOcean.shader to delete them, but they don\u0027t exist in my GameData."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-13T22:13:06Z","Content":"\u003E \n\u003E \n\u003E 8 hours ago, TaintedLion said:\n\u003E \n\u003E \n\u003E I\u0027m getting the stock ocean appearing through the waves on Laythe. I tried looking for the Compiled-OceanBack.shader and Compiled-SphereOcean.shader to delete them, but they don\u0027t exist in my GameData.\n\u003E \n\nThis still happens randomly because the stock ocean isn\u0027t cmpletely disabled but hidden. Rbray sent me a snippet that appears to fix this and also gives a small performance bump. It seems pretty stable so far, I will release it with next version.\n\n**Edited \u003Ctime datetime=\u00222016-02-13T22:13:56Z\u0022 title=\u002202/13/2016 10:13  PM\u0022 data-short=\u00228 yr\u0022\u003EFebruary 13, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"pingopete","CreatedById":74168,"CreatedDateTime":"2016-02-14T18:16:06Z","Content":"\u003E \n\u003E \n\u003E 20 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E This still happens randomly because the stock ocean isn\u0027t cmpletely disabled but hidden. Rbray sent me a snippet that appears to fix this and also gives a small performance bump. It seems pretty stable so far, I will release it with next version.\n\u003E \n\nI don\u0027t suppose this fix might also fix EVE\u0027s cloud shadows on your 3D ocean waves?"}]}