{"TopicId":26968,"ForumId":36,"TopicTitle":"A lesson learnt about UnityEngine WWW and the \u0026quot;file://\u0026quot; uri","CreatedByName":"TriggerAu","CreatedById":57838,"CreatedDateTime":"2013-05-15T13:17:06Z","PageNum":1,"Articles":[{"CreatedByName":"TriggerAu","CreatedById":57838,"CreatedDateTime":"2013-05-15T13:17:06Z","Content":"\n\u003Cp\u003EThis is a bit of a Public Service Announcement, so forgive me if I post it in the wrong location. In the Kerbal Alarm Clock I use quite a few images/textures and these get loaded when the plugin spawns. After mucking around with directories, etc I found that I could use code like the below to load these from subfolders inside plugindata into Unity.Texture2D Objects.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Epublic static void LoadImageIntoTexture(ref Texture2D tex, String FileName){\u003Cbr\u003E    WWW img1 = new WWW(String.Format(\u0022file://{0}Icons/{1}\u0022, PlugInPath, FileName));\u003Cbr\u003E    img1.LoadImageIntoTexture(tex);\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThis worked great for me, and lots of people, but there were a number or people who found that when the plugin was loading the game would \u0022freeze\u0022. On investigating the plugin would eventually load, but would take about 3-5 secs per file (regardless of size), after some fiddling and with the assistance of some very helpful KSPites who helped me test on machines with the issue I figured that this was some form of client thing around the use of the file:// uri.\u003C/p\u003E\u003Cp\u003EIn the end I went back to using the KSP.IO.File.ReadAllBytes and the Unity.Texture2D.LoadImage functions - just means all my images are in the one folder, and noone has these pauses in the loading..\u003C/p\u003E\u003Cp\u003EI never did get to the bottom of why some clients seem to have a timeout of some sort occuring for each loaded image, but thought I\u0027d share this in case any coders see this behaviour and wonder if its a new thing.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003E\u003Cspan style=\u0022color:#FF0000;\u0022\u003EUPDATE\u003C/span\u003E\u003C/strong\u003E - From other thread - User Nando found a working solution! was posted elsewhere, but have edited this as well in case people end up here.\u003C/p\u003E\u003Cp\u003EDisable any and all network devices on your computer which are not currently in use. Instructions on how are below. Many thanks to Nando for finding the solution!\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://windows.microsoft.com/is-is/windows-vista/enable-or-disable-a-network-adapter\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://windows.microsoft.com/is-is/windows-vista/enable-or-disable-a-network-adapter\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://levynewsnetwork.wordpress.com/2011/12/01/windows-7-default-internet-connection-choice/\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://levynewsnetwork.wordpress.com/2011/12/01/windows-7-default-internet-connection-choice/\u003C/a\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222013-06-11T13:42:46Z\u0022 title=\u002206/11/2013 01:42  PM\u0022 data-short=\u002211 yr\u0022\u003EJune 11, 2013\u003C/time\u003E by TriggerAu\u003C/strong\u003E\n\u003Cbr\u003EAdding fault details - so people dont have to read the whole thread\n\u003C/span\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-05-15T13:50:09Z","Content":"\n\u003Cp\u003EFirewall settings perhaps? If WWW is acting as a web/network client and loading via localhost or similar then it could well be security settings interfering.\u003C/p\u003E\u003Cp\u003EHave you tried PartReader.BitmapReader.ReadTexture2D(string path)? I haven\u0027t tried it, but I know the model reader in the parent class works.\u003C/p\u003E\n"},{"CreatedByName":"JeBuSBrian","CreatedById":66324,"CreatedDateTime":"2013-05-15T21:40:08Z","Content":"\n\u003Cp\u003EPerformance in Unity drops the more separate texture files you use. This is because for every material (texture in this case), Unity has to make a new draw call. If all of your objects use the same material, all of your objects will get batched together into a single draw call. I would suggest combining all of your icons / textures into a single larger texture.\u003C/p\u003E\u003Cp\u003EIt has also occurred to me that this may play a small part in the overall poor performance of KSP in general. I don\u0027t believe the parts can properly batch in the Unity engine, because Squad has for some reason forced each part to use its own texture. Anyway, that has nothing to do with you, sorry.\u003C/p\u003E\n"},{"CreatedByName":"TriggerAu","CreatedById":57838,"CreatedDateTime":"2013-05-15T22:43:23Z","Content":"\n\u003Cp\u003EI did try a bunch of different things - and I think security settings/IEZones is probably the cause. Even if it is something like that I can\u0027t control how people run their clients (unless I run a botnet \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 alt=\u0022:wink:\u0022\u003E), so more wanted to post this in case a dev is using it and wasn\u0027t aware that some people do see an issue, or if they get reports of issues at the loading screen with their plugin and this may help them find a resolution so more people use their plugin.\u003C/p\u003E\n"},{"CreatedByName":"TriggerAu","CreatedById":57838,"CreatedDateTime":"2013-05-16T13:11:16Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022JeBuSBrian\u0022 data-cite=\u0022JeBuSBrian\u0022\u003E\u003Cdiv\u003EPerformance in Unity drops the more separate texture files you use. This is because for every material (texture in this case), Unity has to make a new draw call. If all of your objects use the same material, all of your objects will get batched together into a single draw call. I would suggest combining all of your icons / textures into a single larger texture.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI\u0027ll definately look into this one, thanks\u003C/p\u003E\n"},{"CreatedByName":"SkyRender","CreatedById":10651,"CreatedDateTime":"2013-06-02T15:44:08Z","Content":"\n\u003Cp\u003EThis particular Unity issue has been getting a lot more attention lately since now the main game itself is exerting this anomalous behavior for the unlucky few. We\u0027ve got an active effort now to track down what\u0027s causing it. So far the best results we\u0027ve gotten are from looking at what Windows is actually doing during that lag via Process Monitor. The results are interesting (also, huge; there\u0027s about 670MB overall of data between two different versions of KSP with a total time recorded of about 1 minute and 30 seconds; it\u0027s kinda ridiculous).\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://www.skyrender.net/ksp_procmon_log.zip\u0022 rel=\u0022external nofollow\u0022\u003EKSP 0.20.2 no-mods Process Monitor file\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://www.skyrender.net/ksp191_procmon_log.zip\u0022 rel=\u0022external nofollow\u0022\u003EKSP 0.19.1 Process Monitor file with HOME, DEMV ANT, and KER installed\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EThe main interesting similarity between these are that Kerbal Engineering Redux parts in 0.19.1 are exhibiting the same issue as stock files in KSP 0.20.2 are. I can\u0027t confirm for certain that KER is loading files the same way as mentioned in this topic, but given that the symptoms are so exact, it seems likely.\u003C/p\u003E\n"},{"CreatedByName":"OrbitusII","CreatedById":57305,"CreatedDateTime":"2013-06-02T16:09:45Z","Content":"\n\u003Cp\u003EThe Unity WWW class is primarily used to access webpages, not files. Unfortunately its functionality is severely limited to either grabbing images or unparsed code, not the actual webpage as users will see it. It can be used to access files that are present on the user\u0027s computer, but compared to KSP\u0027s default system it\u0027s not as effective (as evidenced by the OP).\u003C/p\u003E\n"},{"CreatedByName":"TriggerAu","CreatedById":57838,"CreatedDateTime":"2013-06-02T23:13:55Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022OrbitusII\u0022 data-cite=\u0022OrbitusII\u0022\u003E\u003Cdiv\u003EThe Unity WWW class is primarily used to access webpages, not files. Unfortunately its functionality is severely limited to either grabbing images or unparsed code, not the actual webpage as users will see it. It can be used to access files that are present on the user\u0027s computer, but compared to KSP\u0027s default system it\u0027s not as effective (as evidenced by the OP).\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ESome indications from a number of people show that the new KSP loading system \u0022may\u0022 be using this method for resource loading - So \u0022maybe\u0022 this is the new default system, thus SkyRender\u0027s comments. For more you can read \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/showthread.php/32897-Excessive-start-up-loading-times\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://forum.kerbalspaceprogram.com/showthread.php/32897-Excessive-start-up-loading-times\u003C/a\u003E - most reports from these people show the same behavior seen in my first post.\u003C/p\u003E\u003Cp\u003EYes, I know theres some assumptions here, that do need to be confirmed.\u003C/p\u003E\n"},{"CreatedByName":"jheriko","CreatedById":67666,"CreatedDateTime":"2013-06-05T06:03:44Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022OrbitusII\u0022 data-cite=\u0022OrbitusII\u0022\u003E\u003Cdiv\u003EUnfortunately its functionality is severely limited to either grabbing images or unparsed code, not the actual webpage as users will see it.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EIts a matter of perspective. It lets you do everything that is possible with HTTP GET and POST... which is most of the internet. making web requests should be distinct from rendering... you get the same data for a webpage that your browser would get for instance.\u003C/p\u003E\u003Cp\u003Ei\u0027m glad to see this works. I just wrote a pile of code with HTTPWebRequest and am now refactoring to use UnityEngine.WWW instead... \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EAbout loading times, I\u0027ve heard that everything needs loading up front? Is this really true? Surely we can create textures on the fly? In which case a multithreaded/timesliced background loading type solution is completely feasible. (I may have a past history of assembling these with such \u0027impossible\u0027 timescales as \u0027a week\u0027 or \u0027two days\u0027 \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 alt=\u0022;)\u0022\u003E)\u003C/p\u003E\u003Cp\u003EMy existing solutions are all native code that runs across every platform so they will probably be awkward to repurpose and wrap into C# for KSP use but there is no reason why similar can\u0027t be remade in C# very quickly. The key is just being able to load the textures etc. on the fly - all the threading/timeslicing stuff is less important afaik and rewriting it using nice handholdy C# should be a breeze. there is probably some lockless job queue thing already laying around.\u003C/p\u003E\u003Cp\u003EI know very little about Unity, just learning right now for the sake of modding KSP. Shame we don\u0027t have a good, clean, portable interface for the mods... just thinking of the needless overhead of \u0027do nothing\u0027 mods makes me light headed... 5000 super late binding C# calls are not healthy.\u003C/p\u003E\n"},{"CreatedByName":"jheriko","CreatedById":67666,"CreatedDateTime":"2013-06-06T07:14:40Z","Content":"\n\u003Cp\u003EOkay, so now I have used this I am worried about people using it without understanding what they are doing and why this can create huge stalls.\u003C/p\u003E\u003Cp\u003EUnityEngine.WWW starts an asynchronous process when instantiated. To dumb that down a bit - it makes a thread on \u0027new\u0027.\u003C/p\u003E\u003Cp\u003EWhat this means for you is that you are now writing timesliced or multi-threaded code, and you must account for the case of a single hardware thread where you need to yield to allow execution - implementing efficient spin-waits is a subject all of its own, but luckily the C# devs did it for you. Unfortunately that mechanism doesn\u0027t work in KSP :/\u003C/p\u003E\u003Cp\u003EEDIT: just realised i missed the \u0027linking information\u0027 - file i/o is always at least partly asynchronous and thread-safe! which explains why not doing this will result in stalls...\u003C/p\u003E\u003Cp\u003EEDIT\u002B\u002B: actually the code I gave actually doesn\u0027t work in KSP, although it works fine in general unity/.net... for whatever reason KSP can\u0027t load SpinOnce from mscorlib.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222013-06-06T13:12:10Z\u0022 title=\u002206/06/2013 01:12  PM\u0022 data-short=\u002211 yr\u0022\u003EJune 6, 2013\u003C/time\u003E by jheriko\u003C/strong\u003E\n\u003Cbr\u003Emissing info\n\u003C/span\u003E\n"},{"CreatedByName":"SkyRender","CreatedById":10651,"CreatedDateTime":"2013-06-06T21:39:31Z","Content":"\n\u003Cp\u003ESo a fix was found for this problem. For mod makers using this command who have had users complain about long lag times, suggest to them that they disable all network connections on their system that are inactive. Apparently Unity\u0027s handling method for this particular command has to contend with all possible connections, even ones that are disabled. Once it\u0027s down to only active connections, the load times drop back down to normal levels.\u003C/p\u003E\n"},{"CreatedByName":"TriggerAu","CreatedById":57838,"CreatedDateTime":"2013-06-06T21:58:00Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022SkyRender\u0022 data-cite=\u0022SkyRender\u0022\u003E\u003Cdiv\u003ESo a fix was found for this problem. For mod makers using this command who have had users complain about long lag times, suggest to them that they disable all network connections on their system that are inactive. Apparently Unity\u0027s handling method for this particular command has to contend with all possible connections, even ones that are disabled. Once it\u0027s down to only active connections, the load times drop back down to normal levels.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThanks for the update SkyRender. This is great to know, and makes a lot more sense than some form of random hardware issue.\u003C/p\u003E\n"}]}