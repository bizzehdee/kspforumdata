{"TopicId":133810,"ForumId":29,"TopicTitle":"C# Reflection Question","CreatedByName":"artwhaley","CreatedById":118388,"CreatedDateTime":"2016-03-09T04:44:55Z","PageNum":1,"Articles":[{"CreatedByName":"artwhaley","CreatedById":118388,"CreatedDateTime":"2016-03-09T04:44:56Z","Content":"\n\u003Cp\u003E\nI\u0027m trying to write a reflection wrapper for Mechjeb, to use with kRPC... \u00A0and it\u0027s my first foray into reflection. \u00A0I\u0027ve got methods working fine... \u00A0But I\u0027m having trouble with properties? \u00A0 In the wrapper I\u0027m doing this: \u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cbr\u003E\n\u00A0 \u00A0\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E \u00A0 \u00A0public static bool ExecStatusGet()\n\u00A0 \u00A0 \u00A0 \u00A0 {\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 System.Type ExecutorType = AssemblyLoader.loadedAssemblies\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 .Select(a =\u0026gt; a.assembly.GetExportedTypes())\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 .SelectMany(t =\u0026gt; t)\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 .FirstOrDefault(t =\u0026gt; t.FullName == \u0022MechJebModuleNodeExecutor\u0022);\n\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 PropertyInfo pi = ExecutorType.GetProperty(\u0022enabled\u0022);\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 return (bool)pi.GetValue(null, null);\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0\n\u00A0 \u00A0 \u00A0 \u00A0 }\n\n\u00A0 \u00A0 \u00A0 \u00A0 public static void ExecStatusSet(bool stat)\n\u00A0 \u00A0 \u00A0 \u00A0 {\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 System.Type ExecutorType = AssemblyLoader.loadedAssemblies\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 .Select(a =\u0026gt; a.assembly.GetExportedTypes())\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 .SelectMany(t =\u0026gt; t)\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 .FirstOrDefault(t =\u0026gt; t.FullName == \u0022MechJebModuleNodeExecutor\u0022);\n\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 PropertyInfo pi = ExecutorType.GetProperty(\u0022enabled\u0022);\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 pi.SetValue(null, stat, null);\n\u00A0 \u00A0 \u00A0 \u00A0 }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nThen over in the actual service class that\u0027s accessible in the game doing one of these...\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E\u00A0 [KRPCProperty]\n\u00A0 \u00A0 \u00A0 \u00A0 public static bool ExecutorStatus\n\u00A0 \u00A0 \u00A0 \u00A0 {\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 get\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 {\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 return MJWrapper.ExecStatusGet();\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 }\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 set\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 {\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 MJWrapper.ExecStatusSet(value);\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 }\n\n\u00A0 \u00A0 \u00A0 \u00A0 }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nBut I\u0027m getting an \u0022Object reference not set to an instance of an object\u0022 error at the end of it. \u00A0I\u0027m sure I\u0027m missing something... \u00A0but it\u0027s basically the same way I\u0027m \u00A0getting access to methods - \u00A0the following code is working:\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E public static void hohmann()\n        {\n            System.Type OrbitalManeuverCalculatorType = AssemblyLoader.loadedAssemblies\n                   .Select(a =\u0026gt; a.assembly.GetExportedTypes())\n                   .SelectMany(t =\u0026gt; t)\n                   .FirstOrDefault(t =\u0026gt; t.FullName == \u0022MuMech.OrbitalManeuverCalculator\u0022);\n            MethodInfo ReflectedMethod = OrbitalManeuverCalculatorType.GetMethod(\u0022DeltaVAndTimeForHohmannTransfer\u0022, BindingFlags.Public | BindingFlags.Static);\n            object[] parameters = { vessel.orbit, target.GetOrbit(), Planetarium.GetUniversalTime(), null };\n            Vector3d deltav = (Vector3d)ReflectedMethod.Invoke(null, parameters);\n            double time = (double)parameters[3];\n            vessel.PlaceManeuverNode(vessel.orbit, deltav, time);\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nThanks for any help you come up with!\n\u003C/p\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2016-03-09T08:41:34Z","Content":"\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022 style=\u0022font-family:monospace, monospace;font-size:14px;clear:both;white-space:pre-wrap;padding:2px;border:1px solid rgb(136,136,136);color:rgb(39,42,52);font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:22.4px;text-indent:0px;text-transform:none;word-spacing:0px;background:rgb(250,250,250);\u0022\u003E\n\u003Cspan\u003E(bool)pi.GetValue(null, null);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nYou need an instance of the module to replace that first null. So you would have to do in reflection\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nMechJebCore mechjebCore = vessel.getMasterMechjeb();\n\u003C/p\u003E\n\u003Cp\u003E\nMechJebModuleNodeExecutor nodeExecutor =\u00A0mechjebCore.node;\n\u003C/p\u003E\n\u003Cp\u003E\nAnd then do your\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n(bool)pi.GetValue(nodeExecutor , null);\n\u003C/p\u003E\n\u003Cp\u003E\n(same thing for set)\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI am quite sure someone already do\u00A0something\u00A0similar\u00A0but I can\u0027t remembrer where.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2016-03-09T15:08:07Z","Content":"\n\u003Cp\u003E\nI\u0027ve messed around with reflection some and I\u0027m not going to try posting code on my mobile (it would be wrong), I\u0027m pretty sure I know what\u0027s going on and agree with sarbian, I\u0027m just going to be more verbose about it as I got stuck at the same place and found it quite counter-intuitive myself as well.\n\u003C/p\u003E\n\u003Cp\u003E\nWhat I\u0027m pretty sure is tripping you up is this line:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003EPropertyInfo pi = ExecutorType.GetProperty(\u0022enabled\u0022);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nThis line returns \u0027pi\u0027 as a PropertyInfo object which described the \u0022enabled\u0022 property. \u003Cem\u003EIt does not include a reference to a specific object, \u003C/em\u003Eit just describes \u0022enabled\u0022.\n\u003C/p\u003E\n\u003Cp\u003E\nTherefore:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003Ereturn (bool)pi.GetValue(null, null);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nfails because pi has no object reference, it merely described the \u0022enabled\u0022 field. You need to pass a reference to a specific \u0022MechJebNodeExectuor\u0022 object inside the GetValue method to tell it which actual object you are searching for the \u0022enabled\u0022 property in, as described by the \u0027pi\u0027 object.\n\u003C/p\u003E\n\u003Cp\u003E\nHopefully that\u0027s clear enough on what\u0027s happening.\n\u003C/p\u003E\n\u003Cp\u003E\nD.\n\u003C/p\u003E\n"},{"CreatedByName":"artwhaley","CreatedById":118388,"CreatedDateTime":"2016-03-09T20:08:23Z","Content":"\n\u003Cp\u003E\nThat... does make sense. \u00A0I\u0027m treating the computer module like it\u0027s static, when it\u0027s not. \u00A0 I think I know where to start now... \u00A0maybe... \u00A0will post working code when I get it. \u00A0Or... the next disaster when I have it. \u003Cimg alt=\u0022:P\u0022 data-emoticon=\u0022true\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 title=\u0022:P\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"Papa_Joe","CreatedById":10788,"CreatedDateTime":"2016-03-16T03:27:14Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222449667\u0022 data-ipsquote-contentid=\u0022133810\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221457554103\u0022 data-ipsquote-userid=\u0022118388\u0022 data-ipsquote-username=\u0022artwhaley\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nOn 3/8/2016 at 2:08 PM, artwhaley said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nThat... does make sense. \u00A0I\u0027m treating the computer module like it\u0027s static, when it\u0027s not. \u00A0 I think I know where to start now... \u00A0maybe... \u00A0will post working code when I get it. \u00A0Or... the next disaster when I have it. \u003Cimg alt=\u0022:P\u0022 data-emoticon=\u0022true\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 title=\u0022:P\u0022\u003E\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nYou can also take a look at a few mods that implement reflection apis such as DeepFreeze, ShipManifest, \u00A0These should give you examples of how to do it.\n\u003C/p\u003E\n"},{"CreatedByName":"JPLRepo","CreatedById":114736,"CreatedDateTime":"2016-03-16T03:35:46Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222449667\u0022 data-ipsquote-contentid=\u0022133810\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221457554103\u0022 data-ipsquote-userid=\u0022118388\u0022 data-ipsquote-username=\u0022artwhaley\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nOn 9/3/2016 at 7:08 AM, artwhaley said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nThat... does make sense. \u00A0I\u0027m treating the computer module like it\u0027s static, when it\u0027s not. \u00A0 I think I know where to start now... \u00A0maybe... \u00A0will post working code when I get it. \u00A0Or... the next disaster when I have it. \u003Cimg alt=\u0022:P\u0022 data-emoticon=\u0022true\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 title=\u0022:P\u0022\u003E\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nLike Papa_Joe suggested...\u003Cbr\u003E\nI have written several wrappers already in DeepFreeze, Ship Manifest, Roster Manager, and AmpYear mods.\u003Cbr\u003E\nLook here for some examples: \u003Ca href=\u0022https://github.com/JPLRepo/DeepFreeze/tree/master/Source/APIs\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/JPLRepo/DeepFreeze/tree/master/Source/APIs\u003C/a\u003E\u003Cbr\u003E\nFirst:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003EPropertyInfo pi = ExecutorType.GetProperty(\u0022enabled\u0022);\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 return (bool)pi.GetValue(null, null);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nTo get the property you need to also specify the bindingflags on your getproperty.\u003Cbr\u003E\nAnd like others have said, to get the value you need the actual instance of the class. which depends on what kind of class it is.. singleton or not...\u003Cbr\u003E\nUsually if it\u0027s not, there needs to be a static \u0022Instance\u0022 property which is actually set to the instance of the class that you can retrieve.\u003Cbr\u003E\nSee Sarbian\u0027s response above for your specific problem with MJ.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cbr\u003E\nIf this is not clear, or from the examples drop me an PM or reply here.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-03-16T03:36:52Z\u0022 title=\u002203/16/2016 03:36  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 16, 2016\u003C/time\u003E by JPLRepo\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"artwhaley","CreatedById":118388,"CreatedDateTime":"2017-05-22T09:42:17Z","Content":"\n\u003Cp\u003E\nI\u0027m going to violate the laws of the internet and necro a year old post... but... \u00A0I\u0027ve necro\u0027ed the project so it seems only fitting. \u00A0\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI am just ramming my head into the wall with my attempt to move my KRPC \u0026gt;\u0026gt; \u00A0Mechjeb interface service from hard linked to soft linked using reflection. \u00A0I KNOW it\u0027s not a complicated concept... but... \u00A0every implementation I can find of it is too \u0027elegant\u0027 for me to be able to take apart and understand - utilizing delegates and such and... \u00A0blah. \u00A0I\u0027m frustrated. \u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve cut my code down to the bare minimum in a test project. \u00A0I have accessing a static method in the orbital maneuver calculator module working just fine. \u00A0But everything I\u0027ve tried to grab the right instance of a dynamic method or property hasn\u0027t worked, so I\u0027ve deleted all of that code. \u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nHere\u0027s what I THINK I\u0027m missing -\n\u003C/p\u003E\n\u003Col\u003E\u003Cli\u003E\nIn the .GetCore() method of the wrapper I need to somehow get my hands on either the core\u0027s MasterMechJeb property, or the active vessels GetMasterMechJeb() method (from the mechjeb vessel extensions...so reflected. \u00A0\n\u003C/li\u003E\n\u003Cli\u003E\nThe body of the ExecuteOne() method - which I think should call GetCore() to get the active mechjeb core, then reflect that core\u0027s instance of\u00A0MechJebModuleNodeExecutor then grab the method info and invoke the\u00A0ExecuteOneNode method.\n\u003C/li\u003E\n\u003Cli\u003E\nAnd the body of the get for the ExecStatus property... which I think needs to do largely the same thing - GetCore to grab the active core, then grab the instance of the Node Executor module, then grab the instanced property info for the .enabled property.\n\u003C/li\u003E\n\u003C/ol\u003E\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nWhat I\u0027ve got working to get the static method working is the approach from \u0027gravity turn.\u0027 \u00A0And like I said, I think it\u0027s skipping the step to find a master mechjeb module... and I think that\u0027s important on ships with more than one mechjeb part. \u00A0\u00A0I\u0027ve TRIED to digest the Mechjeb Wrappers in Persistent Rotation and RasterPropManager... \u00A0 but... they\u0027re just over my head. \u00A0I feel like I\u0027ve been CLOSE.... but... \u00A0I can\u0027t figure out what I\u0027m doing wrong. \u00A0 I\u0027m just in over my head trying to learn 3 things at once and not sure which I\u0027m screwing up. \u00A0I hate to dump a DO THIS FOR ME PLEASE post here... \u00A0but I\u0027m hoping by cutting this down to just the three methods it might be easy enough for someone to type up or point me towards a simple enough example or c# tutorial that will explain it in clear enough terms I can finally get it. \u00A0\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve posted just the mechjeb wrapper to Gist... \u00A0here-\u00A0\u003Ca href=\u0022https://gist.github.com/artwhaley/f5bb453b8ed18fa89b53e47ffde46407\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://gist.github.com/artwhaley/f5bb453b8ed18fa89b53e47ffde46407\u003C/a\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nAND the whole cut down project here - this includes the wrapper but also the addon code, the krpc service, and the orbital extensions from \u003Cabbr title=\u0022Mechjeb (mod)\u0022\u003EMJ\u003C/abbr\u003E I\u0027ve borrowed to make it work temporarily here -\u00A0\u003Ca href=\u0022https://gist.github.com/artwhaley/b5d1770fd6a0389920620a6a17bd2166\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://gist.github.com/artwhaley/b5d1770fd6a0389920620a6a17bd2166\u003C/a\u003E\n\u003C/p\u003E\n"}]}