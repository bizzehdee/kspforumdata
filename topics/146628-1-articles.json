{"TopicId":146628,"ForumId":29,"TopicTitle":"Creating a mesh visible in flight","CreatedByName":"Gotbread","CreatedById":165173,"CreatedDateTime":"2016-08-27T03:39:35Z","PageNum":1,"Articles":[{"CreatedByName":"Gotbread","CreatedById":165173,"CreatedDateTime":"2016-08-27T03:39:35Z","Content":"\n\u003Cp\u003E\nI\u0027m currently trying to create a box from the raw vertices, and make this object visible in flight (map view, tracking view, normal view).\n\u003C/p\u003E\n\u003Cp\u003E\nHere is my code so far:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003Eusing System;\nusing System.Collections.Generic;\nusing UnityEngine;\n\nnamespace KSPPlugin\n{\n    [KSPAddon(KSPAddon.Startup.EveryScene, false)]\n    public class KSPPlugin : MonoBehaviour\n    {\n        private float last_time = 0.0f;\n        private float interval = 5.0f;\n\t\t\n\t\tprivate GameObject testbox_obj = null;\n\t\tprivate MeshRenderer testbox_renderer = null;\n\t\tprivate MeshFilter testbox_filter = null;\n\n\t\tprivate const int MAP_LAYER = 10;\n\t\tprivate const int FLIGHT_LAYER = 15;\n\n\t\tvoid Awake()\n        {\n            \n        }\n        void Start()\n        {\n\t\t\tDebug.Log(\u0022TEST ADD CUBE\u0022);\n\t\t\t\n\t\t\ttestbox_obj = new GameObject(\u0022testbox\u0022);\n\t\t\ttestbox_filter = testbox_obj.AddComponent\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;MeshFilter\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E();\n\t\t\tMesh mesh = testbox_filter.mesh = new Mesh();\n\t\t\ttestbox_renderer = testbox_obj.AddComponent\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;MeshRenderer\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E();\n\n\t\t\tfloat length = 20f;\n\t\t\tfloat width = 20f;\n\t\t\tfloat height = 20f;\n\n\t\t\t#region Vertices\n\t\t\tVector3 p0 = new Vector3(-length * .5f, -width * .5f, height * .5f);\n\t\t\tVector3 p1 = new Vector3(length * .5f, -width * .5f, height * .5f);\n\t\t\tVector3 p2 = new Vector3(length * .5f, -width * .5f, -height * .5f);\n\t\t\tVector3 p3 = new Vector3(-length * .5f, -width * .5f, -height * .5f);\n\n\t\t\tVector3 p4 = new Vector3(-length * .5f, width * .5f, height * .5f);\n\t\t\tVector3 p5 = new Vector3(length * .5f, width * .5f, height * .5f);\n\t\t\tVector3 p6 = new Vector3(length * .5f, width * .5f, -height * .5f);\n\t\t\tVector3 p7 = new Vector3(-length * .5f, width * .5f, -height * .5f);\n\n\t\t\tVector3[] vertices = new Vector3[]\n\t\t\t{\n\t\t\t\tp0, p1, p2, p3,// Bottom\n\t\t\t\tp7, p4, p0, p3,// Left\n\t\t\t\tp4, p5, p1, p0,// Front\n\t\t\t\tp6, p7, p3, p2,// Back\n\t\t\t\tp5, p6, p2, p1,// Right\n\t\t\t\tp7, p6, p5, p4// Top\n\t\t\t};\n\t\t\t#endregion\n\n\t\t\t#region Color\n\t\t\tColor[] colors = new Color[]\n\t\t\t{\n\t\t\t\tColor.red, Color.red, Color.red, Color.red,\n\t\t\t\tColor.green, Color.green, Color.green, Color.green,\n\t\t\t\tColor.blue, Color.blue, Color.blue, Color.blue,\n\t\t\t\tColor.yellow, Color.yellow, Color.yellow, Color.yellow,\n\t\t\t\tColor.white, Color.white, Color.white, Color.white,\n\t\t\t\tColor.gray, Color.gray, Color.gray, Color.gray\n\t\t\t};\n\t\t\t#endregion\n\n\t\t\t#region Normales\n\t\t\tVector3 up = Vector3.up;\n\t\t\tVector3 down = Vector3.down;\n\t\t\tVector3 front = Vector3.forward;\n\t\t\tVector3 back = Vector3.back;\n\t\t\tVector3 left = Vector3.left;\n\t\t\tVector3 right = Vector3.right;\n\n\t\t\tVector3[] normales = new Vector3[]\n\t\t\t{\n\t\t\t\tdown, down, down, down,// Bottom\n\t\t\t\tleft, left, left, left,// Left\n\t\t\t\tfront, front, front, front,// Front\n\t\t\t\tback, back, back, back,// Back\n\t\t\t\tright, right, right, right,// Right\n\t\t\t\tup, up, up, up// Top\n\t\t\t};\n\t\t\t#endregion\n\n\t\t\t#region UVs\n\t\t\tVector2 _00 = new Vector2(0f, 0f);\n\t\t\tVector2 _10 = new Vector2(1f, 0f);\n\t\t\tVector2 _01 = new Vector2(0f, 1f);\n\t\t\tVector2 _11 = new Vector2(1f, 1f);\n\n\t\t\tVector2[] uvs = new Vector2[]\n\t\t\t{\n\t\t\t\t_11, _01, _00, _10,// Bottom\n\t\t\t\t_11, _01, _00, _10,// Left\n\t\t\t\t_11, _01, _00, _10,// Front\n\t\t\t\t_11, _01, _00, _10,// Back\n\t\t\t\t_11, _01, _00, _10,// Right\n\t\t\t\t_11, _01, _00, _10,// Top\n\t\t\t};\n\t\t\t#endregion\n\n\t\t\t#region Triangles\n\t\t\tint[] triangles = new int[]\n\t\t\t{\n\t\t\t\t// Bottom\n\t\t\t\t3, 1, 0,\n\t\t\t\t3, 2, 1,\t\t\t\n \n\t\t\t\t// Left\n\t\t\t\t3 \u002B 4 * 1, 1 \u002B 4 * 1, 0 \u002B 4 * 1,\n\t\t\t\t3 \u002B 4 * 1, 2 \u002B 4 * 1, 1 \u002B 4 * 1,\n \n\t\t\t\t// Front\n\t\t\t\t3 \u002B 4 * 2, 1 \u002B 4 * 2, 0 \u002B 4 * 2,\n\t\t\t\t3 \u002B 4 * 2, 2 \u002B 4 * 2, 1 \u002B 4 * 2,\n \n\t\t\t\t// Back\n\t\t\t\t3 \u002B 4 * 3, 1 \u002B 4 * 3, 0 \u002B 4 * 3,\n\t\t\t\t3 \u002B 4 * 3, 2 \u002B 4 * 3, 1 \u002B 4 * 3,\n \n\t\t\t\t// Right\n\t\t\t\t3 \u002B 4 * 4, 1 \u002B 4 * 4, 0 \u002B 4 * 4,\n\t\t\t\t3 \u002B 4 * 4, 2 \u002B 4 * 4, 1 \u002B 4 * 4,\n \n\t\t\t\t// Top\n\t\t\t\t3 \u002B 4 * 5, 1 \u002B 4 * 5, 0 \u002B 4 * 5,\n\t\t\t\t3 \u002B 4 * 5, 2 \u002B 4 * 5, 1 \u002B 4 * 5,\n\n\t\t\t};\n\t\t\t#endregion\n\n\t\t\tmesh.name = \u0022testbox\u0022;\n\t\t\tmesh.vertices = vertices;\n\t\t\tmesh.normals = normales;\n\t\t\tmesh.uv = uvs;\n\t\t\tmesh.triangles = triangles;\n\t\t\tmesh.colors = colors;\n\n\t\t\tmesh.RecalculateBounds();\n\t\t\tmesh.Optimize();\n\n\t\t\ttestbox_renderer.material = new Material(Shader.Find(\u0022Particles/Additive\u0022));\n\n\t\t\ttestbox_renderer.enabled = true;\n\t\t\ttestbox_obj.SetActive(true);\n\t\t}\n        void Update()\n        {\n            if (Time.time - last_time \u0026gt; interval)\n            {\n                last_time = Time.time;\n                Debug.Log(\u0022Update. Is on map? \u0022 \u002B MapView.MapIsEnabled.ToString());\n            }\n\t\t\tfloat scale = 1.0f;\n\t\t\tif (MapView.MapIsEnabled)\n\t\t\t\tscale = ScaledSpace.InverseScaleFactor;\n\t\t\t\n\t\t\ttestbox_obj.layer = MapView.MapIsEnabled ? MAP_LAYER : FLIGHT_LAYER;\n\t\t\ttestbox_obj.transform.position = FlightGlobals.ActiveVessel.GetWorldPos3D();\n\t\t}\n        void OnDestroy()\n        {\n\t\t\tDestroy(testbox_filter);\n\t\t\tDestroy(testbox_renderer);\n\t\t\tDestroy(testbox_obj);\n        }\n    }\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nThe final goal is to create a sphere (i started with a box because it\u0027s easier to debug), center it around a celestial body, and apply a custom shader to it.\n\u003C/p\u003E\n\u003Cp\u003E\nI dont see the object and i dont get any errors. How do i make the object visible?\n\u003C/p\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2016-08-27T21:57:47Z","Content":"\n\u003Cp\u003E\nYour problem is that your cube is not where you want it to be. KPS uses multiple coordinate system to deal with the single vs double precision problem.\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nGetWorldPos3D give you the position relative to the sun. In the flight scene your vessel is at vessel.transform.position. In the map scene you need to use\u00A0ScaledSpace.LocalToScaledSpace(vessel.GetWorldPos3D()) (from memory, I hope I am not mixing up stuff \u003Cimg alt=\u0022:P\u0022 data-emoticon=\u0022true\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 title=\u0022:P\u0022\u003E\u00A0)\n\u003C/p\u003E\n"},{"CreatedByName":"Gotbread","CreatedById":165173,"CreatedDateTime":"2016-08-27T22:14:37Z","Content":"\n\u003Cp\u003E\nYey, it is working! The transformation was indeed the issue!\n\u003C/p\u003E\n"}]}