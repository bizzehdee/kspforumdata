{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":124,"Articles":[{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-28T21:18:45Z","Content":"I think I may have a solution... It would use something similar to what you do with the ocean. A mesh applied on screen, moved to the locations on the depth buffer, and the depth buffer normals extrude the secondary mesh.  \n\nDownside is that you\u0027d need both a depth buffer and normals buffer.\n\nEDIT:  \n\nThe issue stems obviously from not all  vertices being connected to each-other. In regular objects this of-course is to maintain proper normals rather than sharing them and making them inaccurate at hard edges (your cube example). In the case of terrain however, the surface is made up of disjointed quad objects, meaning the vertexes could never be connected.  \n\nI think the secondary screen mesh should work though. You\u0027d probably have to filter out the cases where the vertex doesn\u0027t hit anything, but you already do a good job in the ocean anyways.\n\n**Edited \u003Ctime datetime=\u00222016-01-28T21:33:44Z\u0022 title=\u002201/28/2016 09:33  PM\u0022 data-short=\u00228 yr\u0022\u003EJanuary 28, 2016\u003C/time\u003E by rbray89**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-28T21:58:07Z","Content":"\u003E \n\u003E \n\u003E 27 minutes ago, rbray89 said:\n\u003E \n\u003E \n\u003E I think I may have a solution... It would use something similar to what you do with the ocean. A mesh applied on screen, moved to the locations on the depth buffer, and the depth buffer normals extrude the secondary mesh.  \n\u003E   \n\u003E \n\u003E Downside is that you\u0027d need both a depth buffer and normals buffer.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E EDIT:  \n\u003E \n\u003E The issue stems obviously from not all  vertices being connected to each-other. In regular objects this of-course is to maintain proper normals rather than sharing them and making them inaccurate at hard edges (your cube example). In the case of terrain however, the surface is made up of disjointed quad objects, meaning the vertexes could never be connected.  \n\u003E   \n\u003E \n\u003E I think the secondary screen mesh should work though. You\u0027d probably have to filter out the cases where the vertex doesn\u0027t hit anything, but you already do a good job in the ocean anyways.\n\u003E \n\nI see, another projected grid to work as a base for extrusions. Very clever actually. However I must point out that relying on depth and normals buffers means that objects off-screen won\u0027t be able to generate any godrays, basically godrays will only be visible head-on. Still I guess one could render an arbitrary camera from the direction of the light source and build the geometry off of it to get around this issue but that may give precision issues.\n\nAlso, another problem with the extrusion method in general, I don\u0027t really know how to navigate these shadow volumes, I just write their depth value and then use that depth value for the scattering effect. Basically if the viewing ray intersects multiple separate lightshafts only the top one will be seen. This makes me consider that shadow mapping approach instead."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-28T22:11:23Z","Content":"\u003E \n\u003E \n\u003E 11 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E I see, another projected grid to work as a base for extrusions. Very clever actually. However I must point out that relying on depth and normals buffers means that objects off-screen won\u0027t be able to generate any godrays, basically godrays will only be visible head-on. Still I guess one could render an arbitrary camera from the direction of the light source and build the geometry off of it to get around this issue but that may give precision issues.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Also, another problem with the extrusion method in general, I don\u0027t really know how to navigate these shadow volumes, I just write their depth value and then use that depth value for the scattering effect. Basically if the viewing ray intersects multiple separate lightshafts only the top one will be seen. This makes me consider that shadow mapping approach instead.\n\u003E \n\nGotcha... Though, with any geometry based approach you\u0027d have the issue with off-screen rendering... You\u0027d have to alter the rendersphere to make sure it was rendered anyways.  \n\nI look forward to see what can be done with shadow mapping ![:)](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif \u0022:)\u0022)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-28T22:26:59Z","Content":"Well, the terrain geometry seems to exist off-screen right now even if at lower detail, so mountains off screen cause godrays that end up on-screen already (I think it\u0027s visible in one of the shots I posted).\n\nAnyway, I expect shadow mapping won\u0027t be easy either, especially at planetary scales but I guess I\u0027ll have to try to find out."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-29T15:33:22Z","Content":"Found the root of all the ocean artifacts. However fixing it makes the ocean look pixelated in the distance like this (not the black line on the horizon):\n\n![igyDflN.png](http://i.imgur.com/igyDflN.png)\n\nFunny enough someone complained about this bug 2 days ago, describing the ocean as \u0022having too much resolution\u0022 and said changing video modes gave him the black artifacts instead, so these two things are related. I should be able to fix both by the end of the day.\n\nEdited:\n\nAlright, everyone with the black ocean bug try this:  [https://mega.nz/#!bB4mAKZB!u9jmQxWMNp7PtavizZ-QK7T41Rjm6wpDamf9iHeJORk](https://mega.nz/#!bB4mAKZB!u9jmQxWMNp7PtavizZ-QK7T41Rjm6wpDamf9iHeJORk)\n\n**Edited \u003Ctime datetime=\u00222016-01-29T16:02:32Z\u0022 title=\u002201/29/2016 04:02  PM\u0022 data-short=\u00228 yr\u0022\u003EJanuary 29, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-29T16:08:49Z","Content":"\u003E \n\u003E \n\u003E 34 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Found the root of all the ocean artifacts. However fixing it makes the ocean look pixelated in the distance like this (not the black line on the horizon):\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E ![igyDflN.png](http://i.imgur.com/igyDflN.png)\n\u003E \n\u003E \n\u003E \n\u003E Funny enough someone complained about this bug 2 days ago, describing the ocean as \u0022having too much resolution\u0022 and said changing video modes gave him the black artifacts instead, so these two things are related. I should be able to fix both by the end of the day.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Edited:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Alright, everyone with the black ocean bug try this:  [https://mega.nz/#!bB4mAKZB!u9jmQxWMNp7PtavizZ-QK7T41Rjm6wpDamf9iHeJORk](https://mega.nz/#!bB4mAKZB!u9jmQxWMNp7PtavizZ-QK7T41Rjm6wpDamf9iHeJORk)\n\u003E \n\nOut of sheer curiosity, what was the issue?"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-29T16:12:45Z","Content":"\u003E \n\u003E \n\u003E 4 minutes ago, rbray89 said:\n\u003E \n\u003E \n\u003E Out of sheer curiosity, what was the issue?\n\u003E \n\nSome issue with mipmaps, so I\u0027m guessing they work differently on different GPUs (and apparently between scene refreshes). For now I disabled it on the foam rendertextures, so foam might start looking too sharp and pixely, I\u0027ll try to find a better fix later on if this takes care of the issue for everyone.\n\n**Edited \u003Ctime datetime=\u00222016-01-29T16:13:56Z\u0022 title=\u002201/29/2016 04:13  PM\u0022 data-short=\u00228 yr\u0022\u003EJanuary 29, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-29T16:23:23Z","Content":"\u003E \n\u003E \n\u003E 7 minutes ago, blackrack said:\n\u003E \n\u003E \n\u003E Some issue with mipmaps, so I\u0027m guessing they work differently on different GPUs (and apparently between scene refreshes). For now I disabled it on the foam rendertextures, so foam might start looking too sharp and pixely, I\u0027ll try to find a better fix later on if this takes care of the issue for everyone.\n\u003E \n\nHmmm.... it may have been that the dv/du values weren\u0027t being calculated properly? You could always test by selecting a specific mip map level to see if they are being generated properly, or it is just the selection."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-29T16:28:04Z","Content":"\u003E \n\u003E \n\u003E 4 minutes ago, rbray89 said:\n\u003E \n\u003E \n\u003E Hmmm.... it may have been that the dv/du values weren\u0027t being calculated properly? You could always test by selecting a specific mip map level to see if they are being generated properly, or it is just the selection.\n\u003E \n\nI will check, thanks for the pointers!"},{"CreatedByName":"colmo","CreatedById":25950,"CreatedDateTime":"2016-01-29T16:31:34Z","Content":"Excellent news, the mod was unusable on Linux/Nvidia."},{"CreatedByName":"skykooler","CreatedById":60459,"CreatedDateTime":"2016-01-29T18:15:22Z","Content":"\u003E \n\u003E \n\u003E 20 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E I see, another projected grid to work as a base for extrusions. Very clever actually. However I must point out that relying on depth and normals buffers means that objects off-screen won\u0027t be able to generate any godrays, basically godrays will only be visible head-on. Still I guess one could render an arbitrary camera from the direction of the light source and build the geometry off of it to get around this issue but that may give precision issues.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Also, another problem with the extrusion method in general, I don\u0027t really know how to navigate these shadow volumes, I just write their depth value and then use that depth value for the scattering effect. Basically if the viewing ray intersects multiple separate lightshafts only the top one will be seen. This makes me consider that shadow mapping approach instead.\n\u003E \n\nWhat if, instead of creating a plane of vertices that you project, you create a half-sphere (in the direction between the player and the sun)? And then deform the vertices the same way you were doing.\n\nEdit: on further consideration, you\u0027d need the other side of the sphere too if you were facing away from the sun, but not if facing toward it. So, I guess, project a section of a sphere that is the union of a half-sphere in the direction of the sun and a half-sphere in the direction the camera is facing. (You could project a whole sphere, but that would have a lot of unnecessary vertices that are behind you *and* don\u0027t deform to somewhere you can see.)\n\n**Edited \u003Ctime datetime=\u00222016-01-29T18:18:34Z\u0022 title=\u002201/29/2016 06:18  PM\u0022 data-short=\u00228 yr\u0022\u003EJanuary 29, 2016\u003C/time\u003E by skykooler**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-29T18:42:26Z","Content":"\u003E \n\u003E \n\u003E 26 minutes ago, skykooler said:\n\u003E \n\u003E \n\u003E What if, instead of creating a plane of vertices that you project, you create a half-sphere (in the direction between the player and the sun)? And then deform the vertices the same way you were doing.\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E  \n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Edit: on further consideration, you\u0027d need the other side of the sphere too if you were facing away from the sun, but not if facing toward it. So, I guess, project a section of a sphere that is the union of a half-sphere in the direction of the sun and a half-sphere in the direction the camera is facing. (You could project a whole sphere, but that would have a lot of unnecessary vertices that are behind you *and* don\u0027t deform to somewhere you can see.)\n\u003E \n\nThe problem there is that you\u0027d also need another camera. The idea of using a plane infront of the primary camera, is that you have the depth buffer already."},{"CreatedByName":"TheDog","CreatedById":137239,"CreatedDateTime":"2016-01-29T20:19:09Z","Content":"\u003E \n\u003E \n\u003E 4 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E Edited:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E Alright, everyone with the black ocean bug try this:  [https://mega.nz/#!bB4mAKZB!u9jmQxWMNp7PtavizZ-QK7T41Rjm6wpDamf9iHeJORk](https://mega.nz/#!bB4mAKZB!u9jmQxWMNp7PtavizZ-QK7T41Rjm6wpDamf9iHeJORk)\n\u003E \n\nTotally fixed this for me! (Linux x64, NVIDIA 960M)"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-29T20:59:01Z","Content":"\u003E \n\u003E \n\u003E 39 minutes ago, TheDog said:\n\u003E \n\u003E \n\u003E Totally fixed this for me! (Linux x64, NVIDIA 960M)\n\u003E \n\nGreat, foam will look a little different though until a proper fix."},{"CreatedByName":"skykooler","CreatedById":60459,"CreatedDateTime":"2016-01-30T00:22:33Z","Content":"\u003E \n\u003E \n\u003E 5 hours ago, rbray89 said:\n\u003E \n\u003E \n\u003E The problem there is that you\u0027d also need another camera. The idea of using a plane infront of the primary camera, is that you have the depth buffer already.\n\u003E \n\nhmm. I thought that Scatterer was rendering its own depth buffer?"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-30T00:31:37Z","Content":"\u003E \n\u003E \n\u003E 21 hours ago, skykooler said:\n\u003E \n\u003E \n\u003E hmm. I thought that Scatterer was rendering its own depth buffer?\n\u003E \n\nYes, he means the main camera already has a depth buffer rendered which means no additional rendering time is wasted with that approach. Creating another camera from another angle would require rendering an additional depth buffer.\n\nEdited:\n\n[@rbray89](https://forum.kerbalspaceprogram.com/index.php?/profile/48847-rbray89/), I tried displaying the lod levels separately to check for problems.\n\nThis is what it looks like what the texture is used without mipmapping.\n\n![Oqd6Oas.jpg](http://i.imgur.com/Oqd6Oas.jpg)\n\nHowever when there are problems they seem to happen randomly at random LOD levels, this what LOD level 3 looks like\n\n![ysGoXpu.png](http://i.imgur.com/ysGoXpu.png)\n\nWhat I noticed however, when everything is fine, the rendertexture and it\u0027s LODs are updated every frame and things move around. However when there are issues, any LOD level with problems will be frozen at the same frame all the time, while unaffected LODs will continue to work as normal.\n\nAny idea what might possibly be going on?\n\n**Edited \u003Ctime datetime=\u00222016-01-30T21:33:43Z\u0022 title=\u002201/30/2016 09:33  PM\u0022 data-short=\u00228 yr\u0022\u003EJanuary 30, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-31T00:57:53Z","Content":"as per [http://docs.unity3d.com/ScriptReference/RenderTexture-useMipMap.html](http://docs.unity3d.com/ScriptReference/RenderTexture-useMipMap.html) what is the resolution of the texture?"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-31T01:34:29Z","Content":"\u003E \n\u003E \n\u003E 33 minutes ago, rbray89 said:\n\u003E \n\u003E \n\u003E as per [http://docs.unity3d.com/ScriptReference/RenderTexture-useMipMap.html](http://docs.unity3d.com/ScriptReference/RenderTexture-useMipMap.html) what is the resolution of the texture?\n\u003E \n\nSame as the fourier grid size, so 128x128 by default and always enforced to be power of two anyway."},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-31T05:42:10Z","Content":"\u003E \n\u003E \n\u003E 4 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E Same as the fourier grid size, so 128x128 by default and always enforced to be power of two anyway.\n\u003E \n\nI assume both useMipMap and   [generateMips](http://docs.unity3d.com/ScriptReference/RenderTexture-generateMips.html)  are set to true? A decent work-around would be to generate the mips manually..."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-31T11:42:04Z","Content":"\u003E \n\u003E \n\u003E 11 hours ago, rbray89 said:\n\u003E \n\u003E \n\u003E I assume both useMipMap and   [generateMips](http://docs.unity3d.com/ScriptReference/RenderTexture-generateMips.html)  are set to true? A decent work-around would be to generate the mips manually...\n\u003E \n\nYep. How does one generate mipmaps manually?\n\nEdited:\n\nOnly way I can think of is to create a bunch of scaled down textures, pass them to the shader and then do the selection and bilinear/trilinear filtering manually to \u0022emulate\u0022 mipmaps. Might end up working well, shouldn\u0027t impact performance much.\n\n**Edited \u003Ctime datetime=\u00222016-01-31T17:29:21Z\u0022 title=\u002201/31/2016 05:29  PM\u0022 data-short=\u00228 yr\u0022\u003EJanuary 31, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"rbray89","CreatedById":48847,"CreatedDateTime":"2016-01-31T17:50:28Z","Content":"\u003E \n\u003E \n\u003E 5 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E Yep. How does one generate mipmaps manually?\n\u003E \n\nWhen you run SetRenderTarget You can specify a mipmap level. I think there must be a unity bug that doesn\u0027t take into consideration the way you are building the texture. I\u0027d expect if you were using Blit or a camera it would just work though."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-01-31T18:03:03Z","Content":"\u003E \n\u003E \n\u003E 6 hours ago, rbray89 said:\n\u003E \n\u003E \n\u003E When you run SetRenderTarget You can specify a mipmap level. I think there must be a unity bug that doesn\u0027t take into consideration the way you are building the texture. I\u0027d expect if you were using Blit or a camera it would just work though.\n\u003E \n\nHmm, the problem is that I\u0027m using the overload of Graphics.SetRenderTarget that allows to use multiple render targets and it doesn\u0027t allow manually setting the mip levels. As far as I know with Graphics.Blit or using a camera you can\u0027t render to multiple render targets. So between doing two passes, one for each render target, or manually emulating mipmaps I\u0027m not sure which would be faster. Although I might just try doing two passes as it\u0027s easier to try and then maybe the impact on performance is negligible. Normally it should be as this shader is the lightest in all the ocean shaders.\n\nEdited: Did two passes with graphics.Blit, seems to work well. Although I\u0027ll have to test more as the bug comes and goes at random.\n\nEdited again:\n\nJust posted a new version with all the recent bug fixes. Other features I\u0027ve been showing lately are not ready yet. Enjoy.\n\n**Edited \u003Ctime datetime=\u00222016-02-01T00:04:42Z\u0022 title=\u002202/01/2016 12:04  AM\u0022 data-short=\u00228 yr\u0022\u003EFebruary 1, 2016\u003C/time\u003E by blackrack**"},{"CreatedByName":"Gkirmathal","CreatedById":135480,"CreatedDateTime":"2016-02-01T00:40:15Z","Content":"[@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) Finally updated ksp to 1.0.5, but does the Skytone Mapper you released some months ago functions in 1.0.5?"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2016-02-01T00:54:58Z","Content":"\u003E \n\u003E \n\u003E 13 minutes ago, Gkirmathal said:\n\u003E \n\u003E \n\u003E [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) Finally updated ksp to 1.0.5, but does the Skytone Mapper you released some months ago functions in 1.0.5?\n\u003E \n\nI think it should work though I never tried. Any reason you\u0027d rather use the tone mapper instead of scatterer?"},{"CreatedByName":"KillAshley","CreatedById":128696,"CreatedDateTime":"2016-02-01T08:24:29Z","Content":"\u003E \n\u003E \n\u003E 7 hours ago, Gkirmathal said:\n\u003E \n\u003E \n\u003E [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) Finally updated ksp to 1.0.5, but does the Skytone Mapper you released some months ago functions in 1.0.5?\n\u003E \n\nit works fine in 1.0.5, im using it a lot"}]}