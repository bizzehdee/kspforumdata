{"TopicId":141196,"ForumId":29,"TopicTitle":"VesselModules, docking, undocking, and you","CreatedByName":"MOARdV","CreatedById":60950,"CreatedDateTime":"2016-06-04T17:14:39Z","PageNum":1,"Articles":[{"CreatedByName":"MOARdV","CreatedById":60950,"CreatedDateTime":"2016-06-04T17:14:39Z","Content":"\n\u003Cp\u003E\nOr maybe it\u0027s just me, because I didn\u0027t get the memo. \u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u00A0But this may be useful for other modders.\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve been chasing some nasty bugs in RasterPropMonitor where docking two vessels and undocking them in the same game session leads to really bad behavior. \u00A0I\u00A0tracked it down to unexpected behavior of the VesselModules (well, *I* didn\u0027t expect it). \u00A0Here\u0027s a sketch of what happens:\n\u003C/p\u003E\n\u003Cp\u003E\nGo to flight with two vessels ready to dock. \u00A0I track the VesselModules by the GUID of the craft. \u00A0I\u0027ll call the GUIDs\u00A0A and B. \u00A0The VesselModule caches the guid so I can see if the vessel changes.\n\u003C/p\u003E\n\u003Cp\u003E\nWhen the two craft dock, the vessel that was the FROM vessel in the OnPartCouple callback disappears. \u00A0The VesselModule sees the onVesselDestroy event, so I remove the GUID from the static dictionary of \u0026lt;GUID, VesselModule\u0026gt; mappings. \u00A0The VesselModule is not destroyed, however.\u00A0The cached reference to the vessel that I stored in the VesselModule is set to null, but the VesselModule still sees FixedUpdates, etc.\n\u003C/p\u003E\n\u003Cp\u003E\nIf I undock the craft *without* leaving the scene, the VesselModule for A sees an onVesselCreate callback that contains a new vessel. \u00A0If I GetComponent\u0026lt;Vessel\u0026gt; in the callback, I see that same vessel, so the VesselModule now knows it belongs to new vessel C.\n\u003C/p\u003E\n\u003Cp\u003E\nHowever, when I leave the scene (return to SpaceCenter), the OnSave method for the VesselModule\u00A0for vessel C is never called. \u00A0Vessel B\u0027s is called, but the repurposed VesselModule\u0027s onSave doesn\u0027t fire. \u00A0I assume this is not intended.\n\u003C/p\u003E\n\u003Cp\u003E\nIn summary, VesselModule instances can be detached from a vessel when two craft dock; if one of these zombie VesselModules is available when craft undock, the zombie is assigned to the new craft. \u00A0However, the reassigned VesselModule doesn\u0027t fire OnSave.\n\u003C/p\u003E\n"},{"CreatedByName":"MOARdV","CreatedById":60950,"CreatedDateTime":"2016-06-04T20:41:19Z","Content":"\n\u003Cp\u003E\nAn additional note: all of the VESSEL entries in\u00A0the persistent file are missing if you do enough docks / undocks without changing scenes.\n\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2016-06-05T01:24:04Z","Content":"\n\u003Cp\u003E\nThat\u0027s annoying to say the least, it drastically reduces their usefulness.\n\u003C/p\u003E\n\u003Cp\u003E\nI see there\u0027s a VesselModuleManager class. I don\u0027t recall a Manager class for any of the other classes we work with. I wonder if something\u0027s gone screwy in there?\n\u003C/p\u003E\n\u003Cp\u003E\nStill, not something I think we can deal with though so we\u0027ll have to see what happens.\n\u003C/p\u003E\n\u003Cp\u003E\nD.\n\u003C/p\u003E\n"},{"CreatedByName":"MOARdV","CreatedById":60950,"CreatedDateTime":"2016-06-06T17:45:47Z","Content":"\n\u003Cp\u003E\nUpdate to this:\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222616509\u0022 data-ipsquote-contentid=\u0022141196\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221465072879\u0022 data-ipsquote-userid=\u002260950\u0022 data-ipsquote-username=\u0022MOARdV\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nOn 6/4/2016 at 3:41 PM, MOARdV said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nAn additional note: all of the VESSEL entries in\u00A0the persistent file are missing if you do enough docks / undocks without changing scenes.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nIt looks like the problem was in my code. \u00A0When my VesselModule\u0027s OnDestroy was called, I looked at my cached copy of Vessel to determine if I had a legitimate vessel to destroy. \u00A0However, Vessel can be set to null by KSP. \u00A0The problem was that if Vessel was null, I didn\u0027t unregister callbacks, and later the destroyed VesselModule saw an OnVesselCreate callback while at the Space Center, and when it tried to GetComponent\u0026lt;Vessel\u0026gt;, it threw an exception that appears to have prevented the game state from saving.\n\u003C/p\u003E\n\u003Cp\u003E\nIn my original implementation, I set vessel to null if it\u0027s a craft I don\u0027t care about (unmanned), and I skipped callback registration. \u00A0However, since KSP can set vessel to null as well when it detaches a VesselModule from its vessel, I need an additional field to keep track of whether I\u0027m registered, and, if I am, make sure I unregister in OnDestroy (or always unregister callbacks, provided no one throws exceptions for unregistering an unregistered callback).\n\u003C/p\u003E\n"}]}