{"TopicId":123156,"ForumId":29,"TopicTitle":"PartModule - I\u0026#039;m confused.","CreatedByName":"Fengist","CreatedById":78435,"CreatedDateTime":"2015-10-16T11:10:10Z","PageNum":1,"Articles":[{"CreatedByName":"Fengist","CreatedById":78435,"CreatedDateTime":"2015-10-16T11:10:10Z","Content":"\n\u003Cp\u003EPerhaps I\u0027m not understanding correctly but I was under the assumption that when the partmodule class was used that it was only called when that part was found on the active vessel. According to my log file, it\u0027s being called on any vessel within 2km of the vessel with the part.\u003C/p\u003E\u003Cp\u003EFor example: I have an aircraft landed on a vessel. The vessel has a partmodule called MPSub with 2 values. If I go straight to the aircraft, it\u0027s finding the partmodule and the values and applying them to the aircraft. I\u0027m confused. Why?\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    public class MPSub : PartModule\u003Cbr\u003E    {\u003Cbr\u003E        [KSPField]\u003Cbr\u003E        public bool manageIntakes = false;\u003Cbr\u003E\u003Cbr\u003E        [KSPField]\u003Cbr\u003E        public bool manageThrottle = false;\u003Cbr\u003E\u003Cbr\u003E        bool intakesOpen = true;\u003Cbr\u003E        bool hasSplashed = false;\u003Cbr\u003E        bool checkOnce = false;\u003Cbr\u003E\u003Cbr\u003E        public override void OnStart(StartState state)\u003Cbr\u003E        {\u003Cbr\u003E            MPLog.Writelog(\u0022[Maritime Pack] Sub Found\u0022);\u003Cbr\u003E            if (manageIntakes)\u003Cbr\u003E            {\u003Cbr\u003E                MPLog.Writelog(\u0022[Maritime Pack] Intakes Enabled\u0022);\u003Cbr\u003E            }\u003Cbr\u003E            if (manageThrottle)\u003Cbr\u003E            {\u003Cbr\u003E                MPLog.Writelog(\u0022[Maritime Pack] Engines Enabled\u0022);\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"Hary R","CreatedById":111339,"CreatedDateTime":"2015-10-16T11:41:42Z","Content":"\n\u003Cp\u003ENo, as PartModule is used for any part in any vessel (engine, wheel, tank, asteroid, even kerbal on EVA), the class is called for every vessel that are within physic range, or else they can not be act upon( or even loaded). If you want your plug-in to be activate only for the active vessel, you need to call the bool IsActiveVessel.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-10-16T11:45:33Z\u0022 title=\u002210/16/2015 11:45  AM\u0022 data-short=\u00228 yr\u0022\u003EOctober 16, 2015\u003C/time\u003E by Hary R\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Fengist","CreatedById":78435,"CreatedDateTime":"2015-10-16T13:39:10Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Hary R\u0022 data-cite=\u0022Hary R\u0022\u003E\u003Cdiv\u003ENo, as PartModule is used for any part in any vessel (engine, wheel, tank, asteroid, even kerbal on EVA), the class is called for every vessel that are within physic range, or else they can not be act upon( or even loaded). If you want your plug-in to be activate only for the active vessel, you need to call the bool IsActiveVessel.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ESo if I read you correctly, it should be this:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E        public override void OnStart(StartState state)\u003Cbr\u003E        {\u003Cbr\u003E            if (!vessel.isActiveVessel)\u003Cbr\u003E            {\u003Cbr\u003E                return;\u003Cbr\u003E            }\u003Cbr\u003E            MPLog.Writelog(\u0022[Maritime Pack] Sub Found\u0022);\u003Cbr\u003E            if (manageIntakes)\u003Cbr\u003E            {\u003Cbr\u003E                MPLog.Writelog(\u0022[Maritime Pack] Intakes Enabled\u0022);\u003Cbr\u003E            }\u003Cbr\u003E            if (manageThrottle)\u003Cbr\u003E            {\u003Cbr\u003E                MPLog.Writelog(\u0022[Maritime Pack] Engines Enabled\u0022);\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EWhich brings up another question. If OnStart is only run once and the part isn\u0027t on the active vessel, which method should be used to recheck the partmodule should the user switch to that vessel? OnAwake or OnActive?\u003C/p\u003E\u003Cp\u003EOr, do I just detect the partmodule settings in OnStart and then check the isActiveVessel in OnUpdate?\u003C/p\u003E\u003Cp\u003ERather confusing how this works.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-10-16T14:21:27Z\u0022 title=\u002210/16/2015 02:21  PM\u0022 data-short=\u00228 yr\u0022\u003EOctober 16, 2015\u003C/time\u003E by Fengist\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"MrHappyFace","CreatedById":76365,"CreatedDateTime":"2015-10-16T14:42:35Z","Content":"\n\u003Cp\u003EYou should only have code in OnStart that needs to happen for \u003Cem\u003Eevery\u003C/em\u003E vessel, that way you don\u0027t run into any issues. In OnUpdate, there can be code that only happens for the active vessel, and code that happens for every vessel, like this:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Epublic override void OnStart(StartState state)\u003Cbr\u003E{\u003Cbr\u003E            //onstart code\u003Cbr\u003E}\u003Cbr\u003Epublic override void OnUpdate()\u003Cbr\u003E{\u003Cbr\u003E            // whatever code you need to run on every vessel\u003Cbr\u003E\u003Cbr\u003E            if (!vessel.isActiveVessel)            {\u003Cbr\u003E                return;\u003Cbr\u003E            }\u003Cbr\u003E\u003Cbr\u003E            // whatever code you need to run on only the active vessel\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThere\u0027s also the GameEvents class, where you can listen for events to see if the active vessel changes, like this:\u003C/p\u003E\u003Cp\u003EGameEvents example:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E[KSPAddon(KSPAddon.Startup.Flight, false)]\u003Cbr\u003Epublic class GameEventSubscriber : MonoBehaviour\u003Cbr\u003E{\u003Cbr\u003E                void Start()\u003Cbr\u003E\t\t{\u003Cbr\u003E                        //this event is the onHideUI event (activated when F2 is pressed to hide the UI)\u003Cbr\u003E\t\t\tGameEvents.onHideUI.Add (OnHideUI);\u003Cbr\u003E\t\t}\u003Cbr\u003E                void OnDestroy()\u003Cbr\u003E                {\u003Cbr\u003E                        //this part is important too!\u003Cbr\u003E                        GameEvents.onHideUI.Remove(OnHideUI);\u003Cbr\u003E                }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\t\tvoid OnHideUI()\u003Cbr\u003E\t\t{\u003Cbr\u003E\t\t\tDebug.Log(\u0022OnHideUI\u0022);\u003Cbr\u003E\t\t}\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-10-16T14:47:23Z\u0022 title=\u002210/16/2015 02:47  PM\u0022 data-short=\u00228 yr\u0022\u003EOctober 16, 2015\u003C/time\u003E by MrHappyFace\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Fengist","CreatedById":78435,"CreatedDateTime":"2015-10-16T18:56:11Z","Content":"\n\u003Cp\u003EI think what I\u0027m seeing is this then:\u003C/p\u003E\u003Cp\u003EI need to locate all the key/value pairs in the partmodule OnStart. That\u0027ll find all of them from any vessel in range. If I come in range of another vessel, it\u0027ll run OnStart again. From there, in my OnUpdate or FixedUpdate, I need to use the isActiveVessel to determine if that partmodule is on the current vessel or one nearby.\u003C/p\u003E\u003Cp\u003EAnd wow, hadn\u0027t looked at GameEvents before. Lots of triggers in there.\u003C/p\u003E\u003Cp\u003EThanks.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2015-10-16T19:23:15Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022\u003E\u003Cdiv\u003EIf I come in range of another vessel, it\u0027ll run OnStart again.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThis line isn\u0027t the clearest but be careful because you do need to be careful keeping track of which part (and partModules) are loaded.\u003C/p\u003E\u003Cp\u003EA different copy of your PartModule loads for each part it is attached to. If you have 2 vessels with your partModule on them, one being the active vessel and one being out of range, the OnStart() will run in the partModule on the active vessel when you load into it when switching from space center to flight.\u003C/p\u003E\u003Cp\u003EAs you approach the second vessel, at about 2km, that vessel will load into the flight scene and the OnStart() in the partModule on the second vessel will run, the OnStart() on your active vessel will \u003Cem\u003Enot\u003C/em\u003E run a second time.\u003C/p\u003E\u003Cp\u003ENote that this means most of the time when you are writing code for a partModule, you should use this.vessel instead of FlightGlobals.ActiveVessel. The this.vessel reference will look at the vessel your partModule is attached to, FlightGlobals.ActiveVessel will always look at the currently active vessel even if the partModule in question is on a different, nearby, vessel.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-10-16T19:27:35Z\u0022 title=\u002210/16/2015 07:27  PM\u0022 data-short=\u00228 yr\u0022\u003EOctober 16, 2015\u003C/time\u003E by Diazo\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Fengist","CreatedById":78435,"CreatedDateTime":"2015-10-18T14:27:48Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Diazo\u0022 data-cite=\u0022Diazo\u0022\u003E\u003Cdiv\u003EThis line isn\u0027t the clearest but be careful because you do need to be careful keeping track of which part (and partModules) are loaded.\u003Cp\u003EA different copy of your PartModule loads for each part it is attached to. If you have 2 vessels with your partModule on them, one being the active vessel and one being out of range, the OnStart() will run in the partModule on the active vessel when you load into it when switching from space center to flight.\u003C/p\u003E\u003Cp\u003EAs you approach the second vessel, at about 2km, that vessel will load into the flight scene and the OnStart() in the partModule on the second vessel will run, the OnStart() on your active vessel will \u003Cem\u003Enot\u003C/em\u003E run a second time.\u003C/p\u003E\u003Cp\u003ENote that this means most of the time when you are writing code for a partModule, you should use this.vessel instead of FlightGlobals.ActiveVessel. The this.vessel reference will look at the vessel your partModule is attached to, FlightGlobals.ActiveVessel will always look at the currently active vessel even if the partModule in question is on a different, nearby, vessel.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThanks!\u003C/p\u003E\u003Cp\u003EThe way you describe the OnStart is pretty much what I was seeing happen. Though it didn\u0027t actually work, I was attempting to shut the throttle down on my sub once it went over 2m altitude to keep it from flying. As I tried to land a VTOL on it, it shut that throttle down too once I got close... which is why this thread is here.\u003C/p\u003E\u003Cp\u003EI think I understand the difference now between this. and flightglobals. They\u0027d both have the same effect on the active vessel but this. would apply to any vessel in range with that partmodule.\u003C/p\u003E\u003Cp\u003EI\u0027ve seen this. used in other instances, like in monobehavours and to be honest, it\u0027s pretty confusing exactly what it\u0027s referencing.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2015-10-18T16:41:25Z","Content":"\n\u003Cp\u003EYou are slightly off on how this. works.\u003C/p\u003E\u003Cp\u003EIn C#, this. refers to the object you are currently running within. So when you use this.vessel inside your partModule code, you are referencing the partModule.vessel object. Note it is only on the partModule executing the code, not all loaded partModules as you say in the previous post.\u003C/p\u003E\u003Cp\u003ENow, on the behavior you are seeing where the VTOL\u0027s engines are getting shut down, I can think of two things:\u003C/p\u003E\u003Cp\u003E1) Both vessels are referencing the same throttle (probably the main throttle controlled by shift/ctrl?) so when the Sub\u0027s throttle shuts down, it carries over the VTOL.\u003C/p\u003E\u003Cp\u003E2) The throttle control code is running on both vessels. So at the VTOL approaches the sub, it\u0027s flight conditions trigger the throttle control code and it shuts the VTOL\u0027s throttle down.\u003C/p\u003E\u003Cp\u003EWould need to see some code to see what is going on though.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"Fengist","CreatedById":78435,"CreatedDateTime":"2015-10-19T02:50:39Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Diazo\u0022 data-cite=\u0022Diazo\u0022\u003E\u003Cdiv\u003EYou are slightly off on how this. works.\u003Cp\u003EIn C#, this. refers to the object you are currently running within. So when you use this.vessel inside your partModule code, you are referencing the partModule.vessel object. Note it is only on the partModule executing the code, not all loaded partModules as you say in the previous post.\u003C/p\u003E\u003Cp\u003ENow, on the behavior you are seeing where the VTOL\u0027s engines are getting shut down, I can think of two things:\u003C/p\u003E\u003Cp\u003E1) Both vessels are referencing the same throttle (probably the main throttle controlled by shift/ctrl?) so when the Sub\u0027s throttle shuts down, it carries over the VTOL.\u003C/p\u003E\u003Cp\u003E2) The throttle control code is running on both vessels. So at the VTOL approaches the sub, it\u0027s flight conditions trigger the throttle control code and it shuts the VTOL\u0027s throttle down.\u003C/p\u003E\u003Cp\u003EWould need to see some code to see what is going on though.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHarry R\u0027s post helped me fix it. I wasn\u0027t using this.isActiveVessel so it was shutting down the throttle on every vessel close by. Or rather, it was setting the visible throttle to 0 but you could still throttle up, which I don\u0027t fully understand.\u003C/p\u003E\u003Cp\u003EHere\u0027s the code I\u0027m using now which seems to work.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E            if (manageThrottle \u0026amp;\u0026amp; vessel.isActiveVessel \u0026amp;\u0026amp; this.vessel.mainBody.ocean)\u003Cbr\u003E            {\u003Cbr\u003E                if (this.vessel.altitude \u0026gt; 2.0)\u003Cbr\u003E                {\u003Cbr\u003E                    FlightInputHandler.state.mainThrottle = 0.0f;\u003Cbr\u003E                    MPLog.Writelog(\u0022[Maritime Pack] Engines Disabled @ altitude \u0022 \u002B this.vessel.altitude);\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EmanageThrottle is a partModule setting.\u003C/p\u003E\u003Cp\u003EI initially tried to go through each engine part and shut them down individually but, I\u0027m using Firespitter\u0027s electric engine mod to propel this thing and it isn\u0027t recognized as a ModuleEngine.\u003C/p\u003E\n"},{"CreatedByName":"JPLRepo","CreatedById":114736,"CreatedDateTime":"2015-10-19T03:50:51Z","Content":"\n\u003Cp\u003EI recently ran into this fixing a bug and found isactivevessel not always accurate depending on where you are checking. I.e.:onstart. I found checking this.vessel.id == flightglobals.activevessel.id worked much better and always accurate\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2015-10-19T03:52:59Z","Content":"\n\u003Cp\u003EAlright, it looks like you have it working but there are two things I\u0027m going to point out:\u003C/p\u003E\u003Cp\u003EThe actual throttle for a vessel is: this.vessel.ctrlState.mainThrottle (this is a partModule). It is just for the FlightGlobals.ActiveVessel, the FlightInputHandler.stat.mainThrottle value you are using has priority and overrides it.\u003C/p\u003E\u003Cp\u003EYour current code will only control FlightGlobals.ActiveVessel, if you use vessel.ctrlStat.mainThrottle you can use your code on nearby vessels that don\u0027t have focus.\u003C/p\u003E\u003Cp\u003EThe other thing I will point out is that while FireSpitter\u0027s engine doesn\u0027t use the ModuleEngine partModule, it almost certainly inherits from it, so you can use the isAssignable method to check if it does.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"Fengist","CreatedById":78435,"CreatedDateTime":"2015-10-22T04:16:31Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022JPLRepo\u0022 data-cite=\u0022JPLRepo\u0022\u003E\u003Cdiv\u003EI recently ran into this fixing a bug and found isactivevessel not always accurate depending on where you are checking. I.e.:onstart. I found checking this.vessel.id == flightglobals.activevessel.id worked much better and always accurate\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHumm... I\u0027ll have to look over my code. I think I looked at putting isactivevessel in my onstart and it just didn\u0027t seem right. But thanks. I released my plugin with my new parts pack so I should know in the near future if I screwed that up.\u003C/p\u003E\n"}]}