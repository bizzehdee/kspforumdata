{"TopicId":169912,"ForumId":29,"TopicTitle":"CommNet.CommLink return, sometimes, false information","CreatedByName":"Li0n","CreatedById":142527,"CreatedDateTime":"2018-01-21T11:06:11Z","PageNum":1,"Articles":[{"CreatedByName":"Li0n","CreatedById":142527,"CreatedDateTime":"2018-01-21T11:06:11Z","Content":"\n\u003Cp\u003E\nWhile developing a new feature for my mod Antenna Helper I came across a bug in the CommLink list attached to each vessel.\n\u003C/p\u003E\n\u003Cp\u003E\nIn order to get the \u0022real signal strength\u0022 of a vessel I need to multiply the signal strength of each link in the path between this vessel and the DSN. I do it like this :\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E\n\nforeach (Vessel v in FlightGlobals.Vessels) {\n\n\tdouble realSignal = 1d;\n\n\tforeach (CommNet.CommLink link in v.Connection.ControlPath) {\n\n\t\trealSignal *= link.signalStrength;\n\t}\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nAnd it works good, most of the time, sometimes the link.signalStrength is off, still in the 0 - 1 range but wrong according to the in-flight display :\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nin flight : it\u0027s always accurate\n\u003C/li\u003E\n\u003Cli\u003E\nat the space center :\u003Cbr\u003E\n* when coming from the main menu : accurate most of the time\u003Cbr\u003E\n* when coming from the editor or the tracking station : always accurate\u003Cbr\u003E\n* when coming from flight : always wrong\n\u003C/li\u003E\n\u003Cli\u003E\nat the Tracking Station :\u003Cbr\u003E\n* first time entering it : accurate most of the time\u003Cbr\u003E\n* n\u002B1 time entering it : always wrong\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\nAt first I believed I was getting the info too early, before the CommNet gets properly initialized, but even with a coroutine that wait 10s before retrieving the signal strength it was still off.\n\u003C/p\u003E\n\u003Cp\u003E\nFor a proper testing I wrote a little plugin that display all the link of all the vessel when a CommNet event is fired (only three exist : OnNetworkInitialized, OnCommStatusChange and OnCommHomeStatusChange), the plugin also display the link when pressing X.\n\u003C/p\u003E\n\u003Cp\u003E\nYou can find it, along with its source, \u003Ca href=\u0022https://github.com/Li0n-0/CommNetTry\u0022 rel=\u0022external nofollow\u0022\u003Ehere\u003C/a\u003E. (Launch a game, open the console and look for entry starting by \u0022[CommTry]\u0022)\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://www.dropbox.com/s/1nunkckyxjp3836/saves.zip?dl=0\u0022 rel=\u0022external nofollow\u0022\u003EThis save\u003C/a\u003E can be helpful, it has three ships, relay_A (signal of : 66%), relay_B (signal of : 36%) and transmitter (connected to relay_B : 69%, combined : 25%).\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI wanted to bring it to the attention of the forum before writing a proper bug report, I check and it haven\u0027t been reported. But \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0026amp;do=hovercard\u0022 data-mentionid=\u002274999\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0022 rel=\u0022\u0022\u003E@TaxiService\u003C/a\u003E made a \u003Ca href=\u0022https://bugs.kerbalspaceprogram.com/issues/13194\u0022 rel=\u0022external nofollow\u0022\u003Ebug report\u003C/a\u003E about incorrect value in the CommNet instance. This may be connect to my issue but not sure : in the CommNet instance, values are always off (and way off, not even in the 0 - 1 range) but in the Vessel.Connection.ControlPath.CommLink they are sometimes valid...\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0026amp;do=hovercard\u0022 data-mentionid=\u002274999\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0022 rel=\u0022\u0022\u003E@TaxiService\u003C/a\u003E your issue still stand, I add a method to test it in my plugin, press Y and it list all the existing links (from CommNet.CommNetNetwork.Instance.CommNet.Links).\n\u003C/p\u003E\n\u003Cp\u003E\nPinging \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/105198-roverdude/\u0026amp;do=hovercard\u0022 data-mentionid=\u0022105198\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/105198-roverdude/\u0022 rel=\u0022\u0022\u003E@RoverDude\u003C/a\u003E, he was assigned \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0026amp;do=hovercard\u0022 data-mentionid=\u002274999\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0022 rel=\u0022\u0022\u003E@TaxiService\u003C/a\u003E issue.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"TaxiService","CreatedById":74999,"CreatedDateTime":"2018-01-21T13:06:58Z","Content":"\n\u003Cp\u003E\nHi Li0n,\n\u003C/p\u003E\n\u003Cp\u003E\nOn KSP 1.3.1.1891 (with DebugStuff, \u003Cabbr title=\u0022Module Manager (mod)\u0022\u003EMM\u003C/abbr\u003E, StockRTAntennas and CommNetTry), I ran some of your scenarios that should give incorrect values but the values are always\u00A0same on my side no matter what I tried.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cimg alt=\u0022sPsSTYj.png\u0022 class=\u0022ipsImage\u0022 height=\u0022177\u0022 src=\u0022https://i.imgur.com/sPsSTYj.png\u0022 width=\u0022427\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nCan you check if I performed the tests correctly?\n\u003C/p\u003E\n\u003Cp\u003E\nP.S. The bug I reported in the bug tracker is due to the incorrect assignment logic. It has nothing to do with your bug.\n\u003C/p\u003E\n"},{"CreatedByName":"Li0n","CreatedById":142527,"CreatedDateTime":"2018-01-21T16:01:54Z","Content":"\n\u003Cp\u003E\n\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0026amp;do=hovercard\u0022 data-mentionid=\u002274999\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/74999-taxiservice/\u0022 rel=\u0022\u0022\u003E@TaxiService\u003C/a\u003E thanks for testing it. I\u0027ve remade a test and can (re-)confirm :\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cimg alt=\u0022YoHv0Ql.png\u0022 class=\u0022ipsImage\u0022 height=\u0022163\u0022 src=\u0022https://i.imgur.com/YoHv0Ql.png\u0022 width=\u0022393\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nHow to reproduce :\n\u003C/p\u003E\n\u003Col\u003E\u003Cli\u003E\nLaunch a save\n\u003C/li\u003E\n\u003Cli\u003E\ngo to the tracking station\n\u003C/li\u003E\n\u003Cli\u003E\nback to the space center\n\u003C/li\u003E\n\u003Cli\u003E\ntracking station again\n\u003C/li\u003E\n\u003C/ol\u003E\u003Cp\u003E\nThis steps always reproduce the issue.\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve made my test on Windows 10 x64 with the last version of KSP (x64). The install is clean, nothing except my CommTry.dll\n\u003C/p\u003E\n"},{"CreatedByName":"Li0n","CreatedById":142527,"CreatedDateTime":"2018-01-21T17:59:21Z","Content":"\n\u003Cp\u003E\nI\u0027ve done a little more testing and find a way to reset the CommPath/Link to its \u0022real\u0022 values (in the Tracking Station), one vessel at a time.\n\u003C/p\u003E\n\u003Cp\u003E\nWhen focusing a vessel its CommPath gets updated, no event is fired but the values do change.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cimg alt=\u0022TZAbn8K.png\u0022 class=\u0022ipsImage\u0022 height=\u0022413\u0022 src=\u0022https://i.imgur.com/TZAbn8K.png\u0022 width=\u0022491\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nAs you can see after focusing the vessel \u0022Transmitter\u0022 its links show the \u0022real\u0022 values. But it\u0027s not updated \u0022recursively\u0022, the link attached to the relay this connection depend on isn\u0027t updated. Not sure that\u0027s clear, in the screenshot the two links underlined in red represent the same thing and should be equal.\n\u003C/p\u003E\n\u003Cp\u003E\nHow to reproduce this :\n\u003C/p\u003E\n\u003Col\u003E\u003Cli\u003E\nlaunch the save I provided earlier\n\u003C/li\u003E\n\u003Cli\u003E\ngo to the tracking station\n\u003C/li\u003E\n\u003Cli\u003E\ngo back to the space center\n\u003C/li\u003E\n\u003Cli\u003E\nagain to the tracking station\n\u003C/li\u003E\n\u003Cli\u003E\nopen the console\n\u003C/li\u003E\n\u003Cli\u003E\npress X\n\u003C/li\u003E\n\u003Cli\u003E\nIn the console you\u0027ll see a list of vessel and theirs links, one link per vessel, all green (the first CommTry block in the screenshot)\n\u003C/li\u003E\n\u003Cli\u003E\nClick on the \u0022Transmitter\u0022 in the vessel list\n\u003C/li\u003E\n\u003Cli\u003E\npress X\n\u003C/li\u003E\n\u003Cli\u003E\nthe transmitter links are updated but not the relay it depends on\n\u003C/li\u003E\n\u003C/ol\u003E\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI also found a CommNet.CommNetNetwork.Reset\u00A0() method, unfortunately it doesn\u0027t solve this problem.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nEDIT :\n\u003C/p\u003E\n\u003Cp\u003E\nWith my last discovery I found a workaround on how to get accurate signal strength of all the vessel in the tracking station : I set the PlanetariumCamera target to every vessel, then back to its original target. Doing this in one frame is transparent to the user and I am, relatively, sure that I get the right number.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222018-01-21T18:13:33Z\u0022 title=\u002201/21/2018 06:13  PM\u0022 data-short=\u00226 yr\u0022\u003EJanuary 21, 2018\u003C/time\u003E by Li0n\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"TaxiService","CreatedById":74999,"CreatedDateTime":"2018-01-22T14:06:46Z","Content":"\n\u003Cp\u003E\nGlad that you managed to find this workaround.\n\u003C/p\u003E\n\u003Cp\u003E\nI managed to reproduce the bug but only in the official release build,\u00A0KSP_x64. It is not there in the unity dev build,\u00A0KSP_x64_Dbg. Both builds are same in file and product versions though.\n\u003C/p\u003E\n\u003Cp\u003E\nI am not sure why the release build gives inaccurate values.\n\u003C/p\u003E\n"},{"CreatedByName":"Li0n","CreatedById":142527,"CreatedDateTime":"2018-01-22T14:39:08Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223274785\u0022 data-ipsquote-contentid=\u0022169912\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221516630006\u0022 data-ipsquote-userid=\u002274999\u0022 data-ipsquote-username=\u0022TaxiService\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n23 minutes ago, TaxiService said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI managed to reproduce the bug but only in the official release build,\u00A0KSP_x64. It is not there in the unity dev build,\u00A0KSP_x64_Dbg. Both builds are same in file and product versions though.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nWhat\u0027s the unity dev build ?\n\u003C/p\u003E\n\u003Cp\u003E\nFor the way to reproduce it, after way more testing, I\u0027m not sure anymore. I think I got the wrong values in all situation : Flight, Tracking Station and Space Center. It appears very often in the tracking station, never the first time tho. Very infrequently in Flight.\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223274785\u0022 data-ipsquote-contentid=\u0022169912\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221516630006\u0022 data-ipsquote-userid=\u002274999\u0022 data-ipsquote-username=\u0022TaxiService\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n27 minutes ago, TaxiService said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nGlad that you managed to find this workaround.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nMe too \u003Cimg alt=\u0022:D\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 title=\u0022:D\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nHow I implement it in the last version of Antenna Helper :\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nwait for GameEvents.CommNet.CommStatusChange to fire\n\u003C/li\u003E\n\u003Cli\u003E\nwait .1s\n\u003C/li\u003E\n\u003Cli\u003E\nfocus the camera on the vessel that fire this event\n\u003C/li\u003E\n\u003Cli\u003E\nThe values are now correct\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\nIf one step is missing it, may, not works. \u003Cimg alt=\u0022:(\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_sad.gif\u0022 title=\u0022:(\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"TaxiService","CreatedById":74999,"CreatedDateTime":"2018-01-22T15:44:31Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223274811\u0022 data-ipsquote-contentid=\u0022169912\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221516631948\u0022 data-ipsquote-userid=\u0022142527\u0022 data-ipsquote-username=\u0022Li0n\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, Li0n said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nWhat\u0027s the unity dev build ?\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nIt is the unity player window exe came with the standard Unity installation per the \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/index.php?/topic/102909-ksp-plugin-debugging-and-profiling-for-visual-studio-and-monodevelop-on-all-os/\u0022 rel=\u0022\u0022\u003Ethread\u003C/a\u003E on the debugging environment.\u00A0\n\u003C/p\u003E\n\u003Cdiv class=\u0022ipsSpoiler\u0022 data-ipsspoiler=\u0022\u0022\u003E\n\u003Cdiv class=\u0022ipsSpoiler_header\u0022\u003E\n\u003Cspan\u003ESpoiler\u003C/span\u003E\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsSpoiler_contents\u0022\u003E\n\u003Cul style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\u003Cli\u003E\nFirst you need a\u003Cspan\u003E\u00A0\u003C/span\u003E\u003Ca href=\u0022http://unity3d.com/get-unity/download/archive\u0022 rel=\u0022external nofollow\u0022 style=\u0022background-color:transparent;color:#3d6594;\u0022\u003EUnity installation\u003C/a\u003E\u003Cspan\u003E\u00A0\u003C/span\u003Eusing the exact same version as your current KSP (For 1.1 you need Unity 5.2.4f1). That version is in the first line of the output_log.txt/Player.log.\n\u003C/li\u003E\n\u003Cli\u003E\nGo to your Unity install for that version ( \u0022C:\\Program Files\\Unity\\Editor\u0022 most likely) and then go in the \u0022Data\\PlaybackEngines\\windowsstandalonesupport\\Variations\\win64_development_mono\u0022 sub-directory. Copy the \u0022player_win.exe\u0022 file to your KSP dev install (next to KSP.exe)\n\u003C/li\u003E\n\u003Cli\u003E\nRename that \u0022player_win.exe\u0022 to \u0022KSP_x64_Dbg.exe\u0022\n\u003C/li\u003E\n\u003C/ul\u003E\u003C/div\u003E\n\u003C/div\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"}]}