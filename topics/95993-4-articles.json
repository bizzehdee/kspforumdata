{"TopicId":95993,"ForumId":69,"TopicTitle":"Slight freeze every 5 seconds (or so)","CreatedByName":"SessoSaidSo","CreatedById":111600,"CreatedDateTime":"2015-01-08T04:38:35Z","PageNum":4,"Articles":[{"CreatedByName":"katateochi","CreatedById":35181,"CreatedDateTime":"2015-06-05T00:52:06Z","Content":"\n\u003Cp\u003ESome interesting developments in here guys, nice 1! Unfortunately I\u0027ve not had any time for KSP these last few days (and won\u0027t till Sunday now), but when I do get some time I\u0027ll see if these suggestions improve my game and report back.\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-05T02:39:44Z","Content":"\n\u003Cp\u003ESome disappointing results as I am testing more.\u003C/p\u003E\u003Cp\u003EI am almost positive it is the GC causing the stutter; I got GCMonitor and the stutters coincide with the GC sawtooth. So by fiddling with the framerate, I think I was minimizing the impact of it, because from some quick testing, the frequency of the garbage collection is linked with the framerate. 30fps = 17s stutter, 72fps = 11s stutter, 144fps = 6s stutter.\u003C/p\u003E\u003Cp\u003EThe section at the end of this is interesting and would suggest there are a few ways of triggering GC: \u003Ca href=\u0022http://docs.unity3d.com/Manual/UnderstandingAutomaticMemoryManagement.html\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://docs.unity3d.com/Manual/UnderstandingAutomaticMemoryManagement.html\u003C/a\u003E\u003C/p\u003E\u003Cp\u003ESomeone with more than an arts degree like me should really try to patch something in (not easy to do, from my reading) that slows down GC so that people with x64 and big RAM could both cap frames at 30fps and go for long stretches before getting hit.\u003C/p\u003E\u003Cp\u003Eedit:\u003C/p\u003E\u003Cp\u003ESpent a few more hours digging into this last night, I am quite convinced this is GC related. I found some code on github called \u0022GCThrash\u0022 (\u003Ca href=\u0022https://github.com/Gerry1135/GCThrash\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/Gerry1135/GCThrash\u003C/a\u003E) that I compiled, that seems to purposely fill up the memory and speed up the rate of GC, if you push it, it will grind KSP to a halt with the same stutter effect in GCMonitor that we are seeing.\u003C/p\u003E\u003Cp\u003EFrom reading a TON of unity developer discussions / blog posts, seems like it is 1) partially Unity\u0027s fault by using a very old version of Mono (2.6.5 circa 2010) as compared to newer versions of Mono which have more advanced GC method and 2) partially Squad\u0027s fault as there are many workarounds and efficiencies that developers use to avoid this.\u003C/p\u003E\u003Cp\u003EWhen GC occurs, instead of the frame being generated real time at whatever current fps is (e.g. 1/60s, 1/144s) it may take as long as 1/10s (unclear why it takes so long, but general opinion is that the implementation in Mono 2.6.5 is HORRIBLE). This would explain why higher end systems may be impacted more as it is less frequent at lower frame rates AND it is less perceptible if fps is 20-30 etc. \u003C/p\u003E\u003Cp\u003EFor those who do not have the stutter issue at all, it would be helpful to grab GCMonitor and watch for the \u0022sawtooth\u0022 and see what happens to your fps. It may still be occurring but not perceptible to you. \u003C/p\u003E\u003Cp\u003EI\u0027m still at a loss for what we can actually do about it as even if Squad implements Unity 5, it seems to still use Mono 2.6.5 which does not have \u0022generational\u0022 based GC tools that are more efficient. Until Unity updates Mono Squad will need to optimize their own code. Alternatively, there may be some difference in hardware which would be interesting to see if there is a user-side workaround.\u003C/p\u003E\u003Cp\u003E[note -- again, I have zero programming knowledge so apologies if I am incorrect -- don\u0027t often find myself the tip of the spear on technical issues like this.]\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-05T15:15:57Z\u0022 title=\u002206/05/2015 03:15  PM\u0022 data-short=\u00229 yr\u0022\u003EJune 5, 2015\u003C/time\u003E by antilochus\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2015-06-06T16:57:06Z","Content":"\n\u003Cp\u003EThe reason the GC rate depends on framerate is that the memory is being allocated and released per frame so the more frames that are rendered the more garbage is created that needs to be collected.\u003C/p\u003E\u003Cp\u003EThe garbage collection takes so long because it has to do a lot of work to calculate which objects are still referenced and which are not and can be collected. Basically (there are some optimisations but this is the general principle), each time it runs it first marks all objects in the heap as being \u0022unreferenced\u0022 and then looks through all the reference variables (both global and on the stack) and marks those objects as \u0022referenced\u0022. For each object that is marked as referenced it then scans through the whole object and any object references it contains are also marked as referenced and this continues until all the objects that can still be reached by code have been marked. Then it runs through all the objects that are still marked as unreferenced and cleans them up.\u003C/p\u003E\u003Cp\u003EKSP could probably be \u0022fixed\u0022 so that very little, if any, garbage was created per frame but it would be a difficult job. I believe the current Unity UI framework (GUI/GUILayout) itself is responsible for quite a lot of the current garbage but that the new UI Squad is working on for Unity 5 should be much better in this respect so, even though the same garbage collector is used, the Unity 5 version should improve things as the collector shouldn\u0027t need to run as often.\u003C/p\u003E\n"},{"CreatedByName":"danfarnsy","CreatedById":67183,"CreatedDateTime":"2015-06-06T18:22:50Z","Content":"\n\u003Cp\u003EAntilochus,\u003C/p\u003E\u003Cp\u003EThanks for running this down.\u003C/p\u003E\u003Cp\u003EI\u0027m having the same issue, even with small part-count craft. The slower rise in the first graph is where I paused the game. The second image is when I switched to the KSC, where the sawtooth was much slower.\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://imgur.com/a/WePDj\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://imgur.com/a/WePDj\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EI have a large number of mods running in 64-bit Linux, with 5 GB of memory use for KSP. I\u0027m trying to figure out how to force the framerate lower with the NVidia settings in Linux.\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2015-06-06T18:56:19Z","Content":"\n\u003Cp\u003EHmmm, that garbage rate looks very high. Can you try with all the MJ windows (and any other mod-provided UI) closed?\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-06T19:34:18Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022danfarnsy\u0022 data-cite=\u0022danfarnsy\u0022\u003E\u003Cdiv\u003EAntilochus,\u003Cp\u003EThanks for running this down.\u003C/p\u003E\u003Cp\u003EI\u0027m having the same issue, even with small part-count craft. The slower rise in the first graph is where I paused the game. The second image is when I switched to the KSC, where the sawtooth was much slower.\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://imgur.com/a/WePDj\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://imgur.com/a/WePDj\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EI have a large number of mods running in 64-bit Linux, with 5 GB of memory use for KSP. I\u0027m trying to figure out how to force the framerate lower with the NVidia settings in Linux.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EYour FPS in flight is in the mid 30s? I wouldn\u0027t limit the framerate too much lower than that or else the FPS might annoy you more than stutters.\u003C/p\u003E\u003Cp\u003EI\u0027d also guess with all the mods running you would be creating more garbage than if you were in stock (as Padishar seems to indicate)\u003C/p\u003E\u003Cp\u003EEdit: I checked out my linux64 KSP, it appears you can edit the settings.cfg framerate limit (FRAMERATE_LIMIT) to an arbitrary value and it works pretty well. At 30 fps the impact of the stutter is minimal (but it is still present). I don\u0027t think the nvidia drivers have a framerater limiter, or at least I wasn\u0027t able to find anything online.\u003C/p\u003E\u003Cp\u003EI\u0027m going to fiddle with the physics delta time and see if I can get further improvements. I was doing all my testing in Windows as it is the best documented but I actually want to play in linux64, so I\u0027m going to keep working with it.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-06T20:07:43Z\u0022 title=\u002206/06/2015 08:07  PM\u0022 data-short=\u00229 yr\u0022\u003EJune 6, 2015\u003C/time\u003E by antilochus\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"katateochi","CreatedById":35181,"CreatedDateTime":"2015-06-07T15:56:03Z","Content":"\n\u003Cp\u003ETurning the frame limit down (by adjusting FRAMERATE_LIMIT in settings.cfg to 30) does make a slight improvement. I\u0027ve have a small (35 part) rover parked at KSC which I\u0027ve been using as a test point for this.\u003C/p\u003E\u003Cp\u003EWith the FPS limited to 30 the spikes are still noticeable but slightly further apart (about 9 seconds apart), without the limit and with an FPS of around 100, they are 6 seconds apart. So it does make a difference, just not very much.\u003C/p\u003E\u003Cp\u003EI\u0027m also trying look at KSP\u0027s performance with regard to part count so I\u0027ve been trying various graphics settings. With regard to this issue, graphics settings do not seem to have any impact on the stutter (or on part count performance for that matter). On max graphics settings or with everything turned right down the stutter is about the same.\u003C/p\u003E\u003Cp\u003EI\u0027ve tried the -nolog setting as well and that doesn\u0027t seem to have any noticeable difference.\u003C/p\u003E\u003Cp\u003EClearly this is a GC issue. But is that because unity\u0027s GC is not optimal or is it because of how KSP is utilizing objects? I have the sinking feeling that while an improvement to unity\u0027s GC will make some difference, it isn\u0027t the whole answer.\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-07T16:37:43Z","Content":"\n\u003Cp\u003EFrom the reading I\u0027ve done, it is a Unity issue that developers have to work around.\u003C/p\u003E\u003Cp\u003EThere are dozens of posts on the Unity forums as well as a few independent programmer blog posts discussing mitigation strategies for this. Unfortunately, I haven\u0027t found any that offer a solution to end users.\u003C/p\u003E\n"},{"CreatedByName":"sal_vager","CreatedById":16426,"CreatedDateTime":"2015-06-07T19:28:09Z","Content":"\n\u003Cp\u003EI guess we\u0027re stuck, I really wish I knew a way to fix this, all I can really do is give you my setup in case it helps you.\u003C/p\u003E\u003Cp\u003EHardware:\u003C/p\u003E\u003Cp\u003EA10 5800k AMD APU.\u003C/p\u003E\u003Cp\u003ENvidia GeForce GTX650\u003C/p\u003E\u003Cp\u003E4gb DDR3 RAM\u003C/p\u003E\u003Cp\u003ESoftware:\u003C/p\u003E\u003Cp\u003EXubuntu Vivid Vervet 15.04 64bit\u003C/p\u003E\u003Cp\u003EProprietary Linux Nvidia driver 346\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://hastebin.com/gobegimula.xml\u0022 rel=\u0022external nofollow\u0022\u003EHardinfo report on Hastebin\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://hastebin.com/omecubibaz.py\u0022 rel=\u0022external nofollow\u0022\u003ESettings.cfg\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://hastebin.com/cekawayule.vala\u0022 rel=\u0022external nofollow\u0022\u003E.nvidia-settings-rc\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EMy refresh rate is stuck at 60hz thanks to the driver which may be why I don\u0027t see the pausing, and Xfce uses at most 9% of the system RAM, and nothing else I run while playing KSP is using much memory or constantly scanning files.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-08T16:33:12Z\u0022 title=\u002206/08/2015 04:33  PM\u0022 data-short=\u00229 yr\u0022\u003EJune 8, 2015\u003C/time\u003E by sal_vager\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2015-06-07T20:24:11Z","Content":"\n\u003Cp\u003EI\u0027ve written another little plugin that displays a graph of the time between calls to Update (the frame time) and the garbage collections.\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://www.dropbox.com/s/co25o6tccwg7vy4/FrameGraph_1.0.0.0.zip?dl=0\u0022 rel=\u0022external nofollow\u0022\u003EDLL Download\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://github.com/Gerry1135/FrameGraph\u0022 rel=\u0022external nofollow\u0022\u003ESource link\u003C/a\u003E (MIT licence)\u003C/p\u003E\u003Cp\u003EHit Mod-= to display the window. The full height corresponds to 250ms, a constant framerate should show a constant low green bar. Garbage collections during the frame are indicated by a red bar.\u003C/p\u003E\u003Cp\u003ECan people that can\u0027t see this effect try running this plugin and just spinning the camera with a pod on the launch pad until a glitch happens and then confirm if you can see the glitch?\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-08T15:22:01Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022sal_vager\u0022 data-cite=\u0022sal_vager\u0022\u003E\u003Cdiv\u003E\u003Cp\u003EHardware:\u003C/p\u003E\u003Cp\u003EA10 5800k AMD APU.\u003C/p\u003E\u003Cp\u003ENvidia GeForce GTX650\u003C/p\u003E\u003Cp\u003E4gb DDR3 RAM\u003C/p\u003E\u003Cp\u003ESoftware:\u003C/p\u003E\u003Cp\u003EXubuntu Vivid Vervet 15.04 64bit\u003C/p\u003E\u003Cp\u003EProprietary Linux Nvidia driver 346.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI can\u0027t contain my jealously, honestly, I would pay a lot to have stutter-free performance.\u003C/p\u003E\u003Cp\u003ECould you post your settings.cfg and xorg.conf?\u003C/p\u003E\n"},{"CreatedByName":"sal_vager","CreatedById":16426,"CreatedDateTime":"2015-06-08T16:22:21Z","Content":"\n\u003Cp\u003EThe *buntu\u0027s don\u0027t make an xorg.conf anymore and I have not made my own, settings.cfg added to post above.\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-08T16:30:57Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022sal_vager\u0022 data-cite=\u0022sal_vager\u0022\u003E\u003Cdiv\u003EThe *buntu\u0027s don\u0027t make an xorg.conf anymore and I have not made my own, settings.cfg added to post above.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThanks, can you post your ~/.nvidia-settings-rc?\u003C/p\u003E\n"},{"CreatedByName":"sal_vager","CreatedById":16426,"CreatedDateTime":"2015-06-08T16:34:45Z","Content":"\n\u003Cp\u003EYep, I have not changed much from the defaults by the way, KSP does get slow when the hair shader is active (re-entry heat effect) but that\u0027s about it.\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-08T16:37:13Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022sal_vager\u0022 data-cite=\u0022sal_vager\u0022\u003E\u003Cdiv\u003EYep, I have not changed much from the defaults by the way, KSP does get slow when the hair shader is active (re-entry heat effect) but that\u0027s about it.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EReally appreciate it. I wonder if it\u0027s something obscure like HPET (which appears to have helped in other cases).\u003C/p\u003E\n"},{"CreatedByName":"Carraux","CreatedById":60890,"CreatedDateTime":"2015-06-09T09:24:33Z","Content":"\n\u003Cp\u003EMy system is a i7-2600k running Win 10 x64 with 8GB RAM and a Geforce 970 and a 2x200GB SSD system disk as RAID0 hosting KSP. It still stutters on my system\u003C/p\u003E\u003Cp\u003EIF - and only if - the garbage collector is the reason for this stutter, then the question is: Which part of the program (or Unity) is constantly allocating and freeing memory while the rocket/plane is in midair? Stuttering even occurs when there is no staging. Just flying. So we have a static rocket/plane model which need no allocating/freeing. We have a more or less static landscape model which have some LOD logic but I doubt that this needs constant memory allocating.\u003C/p\u003E\u003Cp\u003EThe only thing left is... sound. Please listen. To have a constant engine sound KSP has to play the engine sound file repeatedly. But you won\u0027t hear any sound repitition from the engines without stutter. The stutter occurs at the end of the sound file.\u003C/p\u003E\u003Cp\u003EI assume the program logic looks like: REPEAT -\u0026gt; Allocate memory for sound file -\u0026gt; Play sound file -\u0026gt; Free memory -\u0026gt; REPEAT-UNTIL Enging is off\u003C/p\u003E\u003Cp\u003EInstead of: Allocate memory for sound file -\u0026gt; REPEAT -\u0026gt; Play sound file -\u0026gt; REPEAT-UNTIL Enging is off -\u0026gt; Free memory\u003C/p\u003E\u003Cp\u003ECould this be?\u003C/p\u003E\u003Cp\u003ESquad, do you read?\u003C/p\u003E\n"},{"CreatedByName":"sal_vager","CreatedById":16426,"CreatedDateTime":"2015-06-09T10:50:42Z","Content":"\n\u003Cp\u003E\u003Ca href=\u0022http://docs.unity3d.com/Manual/AudioOverview.html\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003EAudio\u003C/strong\u003E\u003C/a\u003E is handled by the \u003Ca href=\u0022http://unity3d.com/\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003EUnity3D\u003C/strong\u003E\u003C/a\u003E engine, and changes to how Unity handles audio would require access to source code and breach of the \u003Ca href=\u0022http://unity3d.com/legal/eula\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003EUnity license\u003C/strong\u003E\u003C/a\u003E.\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://answers.unity3d.com/questions/779941/why-is-this-stuttering-so-much.html\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003EUnity\u003C/strong\u003E\u003C/a\u003E\u003Cstrong\u003E \u003C/strong\u003E\u003Ca href=\u0022http://answers.unity3d.com/questions/344856/stuttering-every-2-seconds.html\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003Estutters\u003C/strong\u003E\u003C/a\u003E\u003Cstrong\u003E \u003C/strong\u003E\u003Ca href=\u0022http://answers.unity3d.com/questions/275016/updatefixedupdate-motion-stutter-not-another-novic.html\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003Eeven\u003C/strong\u003E\u003C/a\u003E\u003Cstrong\u003E \u003C/strong\u003E\u003Ca href=\u0022http://answers.unity3d.com/questions/644102/resolving-a-stutter-in-framerate-during-play.html\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003Ewith\u003C/strong\u003E\u003C/a\u003E\u003Cstrong\u003E \u003C/strong\u003E\u003Ca href=\u0022http://answers.unity3d.com/questions/125752/unity-is-stuttering-every-15-seconds-about.html\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003Esimple\u003C/strong\u003E\u003C/a\u003E\u003Cstrong\u003E \u003C/strong\u003E\u003Ca href=\u0022http://answers.unity3d.com/questions/663337/game-engine-stuttering.html\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cstrong\u003Escenes.\u003C/strong\u003E\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EThis is a real problem with the Unity3D game engine, and is worse for some than others, all we can do is try to mitigate this as much as possible and hope that Unity5 fixes the issue.\u003C/p\u003E\u003Cp\u003ESquad cannot fix this, but are moving to Unity5.\u003C/p\u003E\n"},{"CreatedByName":"Majorjim!","CreatedById":61954,"CreatedDateTime":"2015-06-09T13:19:56Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022sal_vager\u0022 data-cite=\u0022sal_vager\u0022\u003E\u003Cdiv\u003EYep, I have not changed much from the defaults by the way, KSP does get slow when the hair shader is active (re-entry heat effect) but that\u0027s about it.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ESo running on linux is a fix? What is your part count limit? Could you try a 600 part ship?\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-09T14:13:50Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Majorjim\u0022 data-cite=\u0022Majorjim\u0022\u003E\u003Cdiv\u003ESo running on linux is a fix? What is your part count limit? Could you try a 600 part ship?\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ELinux is not a fix for me. I have the stutter noted here in both Linux (LMDE Mate) and Windows (Win7) and it occurs with 1 part ships just as often as large ones.\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2015-06-09T14:19:50Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Carraux\u0022 data-cite=\u0022Carraux\u0022\u003E\u003Cdiv\u003EIF - and only if - the garbage collector is the reason for this stutter, then the question is: Which part of the program (or Unity) is constantly allocating and freeing memory while the rocket/plane is in midair? Stuttering even occurs when there is no staging. Just flying. So we have a static rocket/plane model which need no allocating/freeing. We have a more or less static landscape model which have some LOD logic but I doubt that this needs constant memory allocating.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThere is no \u0022if\u0022 about it, this effect is definitely caused by the Unity/Mono garbage collector. Unity itself is pretty good about not creating lots of garbage but various features of the Unity API do make it quite awkward (if not, downright impossible) for KSP (and mods) to do some things without creating unnecessary garbage though KSP and quite a lot of mods do also create quite a lot of other unnecessary garbage themselves that it should be quite easy to fix. In an ideal KSP, the turnover of memory would be low enough so that garbage collections could be deliberately triggered at key points where a frame rate glitch will not be noticeable (scene changes, switch to/from map view, pause game, save etc.) and it wouldn\u0027t need to run at any other times. This would be tricky to achieve but it should be quite easy to vastly reduce the rate of garbage collections from where it is now.\u003C/p\u003E\u003Cp\u003EThe GCMonitor mod (linked somewhere earlier in the thread) allows you to easily see the memory turnover and garbage collections happening. The rate of rise of the line should be much lower than it ever is at the moment, ideally it would only ever rise during flight when something does actually need to be allocated.\u003C/p\u003E\n"},{"CreatedByName":"sal_vager","CreatedById":16426,"CreatedDateTime":"2015-06-09T15:40:33Z","Content":"\n\u003Cp\u003ELinux isn\u0027t a fix for crazy builds, no.\u003C/p\u003E\u003Cp\u003EI keep all my craft to below 200 parts, when I test someone\u0027s megawhatsit I have to turn everything down and I still have a low frame rate, but still no obvious pausing.\u003C/p\u003E\u003Cp\u003EThis stutter issue can affect players with only one part.\u003C/p\u003E\n"},{"CreatedByName":"antilochus","CreatedById":144588,"CreatedDateTime":"2015-06-09T20:21:53Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022sal_vager\u0022 data-cite=\u0022sal_vager\u0022\u003E\u003Cdiv\u003E\u003Cp\u003E\u003Ca href=\u0022http://hastebin.com/gobegimula.xml\u0022 rel=\u0022external nofollow\u0022\u003EHardinfo report on Hastebin\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://hastebin.com/omecubibaz.py\u0022 rel=\u0022external nofollow\u0022\u003ESettings.cfg\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://hastebin.com/cekawayule.vala\u0022 rel=\u0022external nofollow\u0022\u003E.nvidia-settings-rc\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EMy refresh rate is stuck at 60hz thanks to the driver which may be why I don\u0027t see the pausing, and Xfce uses at most 9% of the system RAM, and nothing else I run while playing KSP is using much memory or constantly scanning files.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHave you noticed any benefits (fps-wise) to running at a lower resolution in windowed mode in Linux? Do you have any performance issues when running full-res and fullscreen?\u003C/p\u003E\n"},{"CreatedByName":"Phantasmogasm","CreatedById":144815,"CreatedDateTime":"2015-06-10T01:10:58Z","Content":"\n\u003Cp\u003Ei found this thread after googling this same problem, after reading the thread for a bit i started watching GCM and saw some odd stuff when i turned up the precision on the graph drawing.\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://imgur.com/JQ7DORW\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://i.imgur.com/JQ7DORW\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EIts more easy to see on the higher precision graph:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://i.imgur.com/TNTgwFu.jpg\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://i.imgur.com/TNTgwFu.jpg\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E but for my game it looks like the system is dumping a boatload of memory into mono, continuously, mono then bricks itself, dumps all the excess memory, and stutters, causing what looks like the entire application to hang, and then the whole process starts again.\u003C/p\u003E\u003Cp\u003Ewhats even more confusing, is if this had anything to do with the memory required to do real time physics processing, why the hell would:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://i.imgur.com/kAd52vb.png\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://i.imgur.com/kAd52vb.png\u003C/a\u003E\u003C/p\u003E\u003Cp\u003Eit be happening at the start menu?\u003C/p\u003E\u003Cp\u003Eon start up my KSP uses 4.2GB of RAM, rising to about 5.5/6 during intensive gameplay, but the memory graph for KSP remains relatively constant and so does my fps, even during the stutters, which really points the finger at mono.\u003C/p\u003E\u003Cp\u003EThough by no means am i an expert or claim to be.\u003C/p\u003E\u003Cp\u003EI really hope a fix for this comes about soon, i love KSP and will continue to play the life out of it, but the stuttering is so off putting its almost headache inducing to watch.\u003C/p\u003E\u003Cp\u003ESys Specs:\u003C/p\u003E\u003Cp\u003EFX-8320 3.4GHz\u003C/p\u003E\u003Cp\u003EGTX-970 4GB (3.5/.5) VRAM\u003C/p\u003E\u003Cp\u003E16GB 1600MHz Corsair XMS3\u003C/p\u003E\u003Cp\u003EUbuntu 15.04 x64 / KSP x64\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-06-10T01:25:47Z\u0022 title=\u002206/10/2015 01:25  AM\u0022 data-short=\u00229 yr\u0022\u003EJune 10, 2015\u003C/time\u003E by Phantasmogasm\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"katateochi","CreatedById":35181,"CreatedDateTime":"2015-06-10T11:04:01Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Majorjim\u0022 data-cite=\u0022Majorjim\u0022\u003E\u003Cdiv\u003ESo running on linux is a fix? What is your part count limit? Could you try a 600 part ship?\u003C/div\u003E\u003C/blockquote\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022antilochus\u0022 data-cite=\u0022antilochus\u0022\u003E\u003Cdiv\u003ELinux is not a fix for me. I have the stutter noted here in both Linux (LMDE Mate) and Windows (Win7) and it occurs with 1 part ships just as often as large ones.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ELinux doesn\u0027t help with the stuttering (or the part-count related performance) for me either \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_sad.gif\u0022 alt=\u0022:(\u0022\u003E\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Carraux\u0022 data-cite=\u0022Carraux\u0022\u003E\u003Cdiv\u003EMy system is a i7-2600k running Win 10 x64 with 8GB RAM and a Geforce 970 and a 2x200GB SSD system disk as RAID0 hosting KSP. It still stutters on my system\u003Cp\u003EIF - and only if - the garbage collector is the reason for this stutter, then the question is: Which part of the program (or Unity) is constantly allocating and freeing memory while the rocket/plane is in midair? Stuttering even occurs when there is no staging. Just flying. So we have a static rocket/plane model which need no allocating/freeing. We have a more or less static landscape model which have some LOD logic but I doubt that this needs constant memory allocating.\u003C/p\u003E\u003Cp\u003EThe only thing left is... sound. Please listen. To have a constant engine sound KSP has to play the engine sound file repeatedly. But you won\u0027t hear any sound repitition from the engines without stutter. The stutter occurs at the end of the sound file.\u003C/p\u003E\u003Cp\u003EI assume the program logic looks like: REPEAT -\u0026gt; Allocate memory for sound file -\u0026gt; Play sound file -\u0026gt; Free memory -\u0026gt; REPEAT-UNTIL Enging is off\u003C/p\u003E\u003Cp\u003EInstead of: Allocate memory for sound file -\u0026gt; REPEAT -\u0026gt; Play sound file -\u0026gt; REPEAT-UNTIL Enging is off -\u0026gt; Free memory\u003C/p\u003E\u003Cp\u003ECould this be?\u003C/p\u003E\u003Cp\u003ESquad, do you read?\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI don\u0027t think it\u0027s anything to do with engine sounds, I get the stutter with a craft that is just sitting on the runway before any of it\u0027s engines are even activated (it happens constantly regardless of what is going on. It happens in the editors too although when looking at the GCmonitor graphs the interval between calls to the CG is greater).\u003C/p\u003E\u003Cp\u003EBut I think you are right to question why it is that something is constantly allocating and freeing memory. \u003C/p\u003E\u003Cp\u003EFrom what I\u0027ve read, this stuttering issue IS a unity GC problem, BUT it can be mitigated with more optimal use of resources. One answer on \u003Ca href=\u0022http://stackoverflow.com/questions/17481863/unity3d-optimize-garbage-collection\u0022 rel=\u0022external nofollow\u0022\u003Estackoverflow\u003C/a\u003E talks about the need to load your resources at the start rather than on the fly and about creating a pool of objects and enabling and disabling them rather than destroying them. It suggests that you should avoid calls to Instantiate, Destroy and Resources.UnloadUnusedAssets while ingame (while the latter can optimize memory usage it could be costly if it\u0027s being called too often). \u003C/p\u003E\u003Cp\u003E(I\u0027m just summarizing here from what I\u0027ve understood)\u003C/p\u003E\u003Cp\u003EAs I understand it the move to unity 5 won\u0027t just solve this because the GC is still pretty much the same (I may be wrong about this, I hope I am). If the GC isn\u0027t being significantly changed, then this problem won\u0027t just go away. SQUAD needs to go over how resources are loaded and unloaded and make improvement to work around this unity limitation. \u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022sal_vager\u0022 data-cite=\u0022sal_vager\u0022\u003E\u003Cdiv\u003ELinux isn\u0027t a fix for crazy builds, no.\u003Cp\u003EI keep all my craft to below 200 parts, when I test someone\u0027s megawhatsit I have to turn everything down and I still have a low frame rate, but still no obvious pausing.\u003C/p\u003E\u003Cp\u003EThis stutter issue can affect players with only one part.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EIs more than 200 parts a crazy build!? In the past I used to regularly build craft with 400-500 parts and still have reasonable performance. 200 is such a low part-count in my view and it really prevents detailed designs. Sure you can get anywhere in a 100 part craft, but from a creative building point of view that\u0027s a real killer.\u003C/p\u003E\u003Cp\u003EI\u0027ve been experimenting with part-count performance and graphics settings and adjusting graphics settings doesn\u0027t make any difference on my FPS for craft above a certain part count. For example my 300 part station will run at 5-10FPS when on the very very lowest graphics settings or when I\u0027ve turned everything right up to full. \u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003EMy specs just for completeness sake:\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003ECPU: Intel Core i7 @ 3.07GHz\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003ERAM: 16GB DDR3 (corsair dominator)\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003EMB: Asus Rampage III extreme\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003EGPU: GTX 760\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003EphysX: GTX 460\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003EMain HDD: 500GB Samsung SSD (I\u0027ve also tried having KSP on a different disk to the OS, no difference)\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003Cspan\u003EOS: primarily Win7, also tried it in Ubuntu 14.04LTS\u003C/span\u003E\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"sal_vager","CreatedById":16426,"CreatedDateTime":"2015-06-10T11:46:42Z","Content":"\n\u003Cp\u003EIt\u0027s crazy for me, I couldn\u0027t think of a better word at the time, \u0022Whackjobian build\u0022 maybe? \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 alt=\u0022;)\u0022\u003E\u003C/p\u003E\u003Cp\u003EI just don\u0027t make big craft, so I tried to go overboard with fuel tanks but it turns out KSP doesn\u0027t like lots of round-8\u0027s, it doesn\u0027t even like loading \u003C/p\u003E\u003Cblockquote class=\u0022ipsStyle_spoiler\u0022 data-ipsspoiler=\u0022\u0022 tabindex=\u00220\u0022\u003E\u003Cimg src=\u0022http://i.imgur.com/GyTiyFU.jpg\u0022 alt=\u0022GyTiyFU.jpg\u0022\u003E\u003C/blockquote\u003E\u003Cblockquote\u003E in the VAB.\u003C/blockquote\u003E\u003Cp\u003EOh and guess what, on my max resolution of 1920x1080 and full screen I\u0027m seeing stutter, it\u0027s really slight and I have to be looking for it, but it\u0027s there, I always played windowed because I am also on the forums and IRC at the same time.\u003C/p\u003E\u003Cp\u003Ekatateochi, the stackoverflow stuff is interesting but I don\u0027t know if it\u0027d help, as KSP does load everything at the start and just makes instances of each object when one is needed, it\u0027s only those instances that are destroyed, ie a reference to an object with its own variables for position, speed and stuff, the instance doesn\u0027t have its own texture or mesh, they aren\u0027t loaded from disk each time.\u003C/p\u003E\u003Cp\u003EAt least that is how Unity \u003Cem\u003Eshould \u003C/em\u003Ebe handling assets, but even the Unity manual page says excessive garbage collection can cause performance issues.\u003C/p\u003E\u003Cp\u003EA Unity or Mono dev might be able to tell us more about what controls they have for CG, I don\u0027t know if it\u0027s fully automatic with no input from a developer or if there\u0027s any way to defer collection, also we don\u0027t know what efforts Squad have already tried, this issue was reported by HarvesteR years ago so it\u0027s fair to assume they have tried to deal with this.\u003C/p\u003E\u003Cp\u003EI do know though that Unity uses a modified Mono, so even if they stick to the same version for U5, that doesn\u0027t mean it won\u0027t have also been modified to work better with the newer engine.\u003C/p\u003E\n"}]}