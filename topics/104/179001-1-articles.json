{"TopicId":179001,"ForumId":104,"TopicTitle":"[KSP 1.5] Problems with Stage Icons in mod (Support from KSP Devs is needed)","CreatedByName":"jrodriguez","CreatedById":130617,"CreatedDateTime":"2018-10-16T06:02:38Z","PageNum":1,"Articles":[{"CreatedByName":"jrodriguez","CreatedById":130617,"CreatedDateTime":"2018-10-16T06:02:39Z","Content":"\n\u003Cp\u003E\nHi!\n\u003C/p\u003E\n\u003Cp\u003E\nI belong to the BDArmory team. I was doing some tests on KSP 1.5 yesterday and I have found some issues. We have some code for weapons that creates stage icons for weapons. However an Exception is raised in KSP 1.5. I would like to have some feedback from KSP dev team regarding this. I will attach the code that I think may be causing this.\n\u003C/p\u003E\n\u003Cp\u003E\nException log:\n\u003C/p\u003E\n\u003Cp\u003E\nEXC 20:43:43.716] ArgumentOutOfRangeException: Argument is out of range.\u003Cbr\u003E\nParameter name: index\u003Cbr\u003E\n\u00A0 \u00A0 System.Collections.Generic.List\u00601[KSP.UI.Screens.StageGroup].get_Item (Int32 index)\u003Cbr\u003E\n\u00A0 \u00A0 KSP.UI.Screens.StageManager.AddHeldIconsToStages (.Part selectedPart, Boolean switchingVessels)\u003Cbr\u003E\n\u00A0 \u00A0 KSP.UI.Screens.StageManager.SortIconsSequence (.Part p, Boolean switchingVessels)\u003Cbr\u003E\n\u00A0 \u00A0 KSP.UI.Screens.StageManager\u002B\u0026lt;SortIconsSequence\u0026gt;c__Iterator0.MoveNext ()\u003Cbr\u003E\n\u00A0 \u00A0 UnityEngine.SetupCoroutine.InvokeMoveNext (IEnumerator enumerator, IntPtr returnValueAddress)\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222018-10-16T09:26:20Z\u0022 title=\u002210/16/2018 09:26  AM\u0022 data-short=\u00225 yr\u0022\u003EOctober 16, 2018\u003C/time\u003E by jrodriguez\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Ruedii","CreatedById":57704,"CreatedDateTime":"2018-10-16T07:51:29Z","Content":"\n\u003Cp\u003E\nA few quick sanity checks first before you pester the KSP devs:\u003Cbr\u003E\nThis is an issue with DLLs?\u003Cbr\u003E\nThis appears to be an issue with porting to Win64 architecture (i.e. changes to the INT and Pointer typings).\u003Cbr\u003E\u003Cbr\u003E\nAre you ALWAYS handing ints and int32?\u003Cbr\u003E\nAre you moving an Int32 to an Int and back to an Int32?\u00A0\u00A0\u003Cbr\u003E\nAre you moving a pointer into an Integer of any sort?\u003Cbr\u003E\u003Cbr\u003E\nWhile Int32 should be type-compatible with Int and Long, there are options in the compile template in Win64 to override this standard.\u00A0 This results in various issues.\u003Cbr\u003E\nThey are not type compatible with Pointers.\u00A0\u003Cbr\u003E\u003Cbr\u003E\nSimply put, never cross types.\u00A0\u00A0 If it\u0027s a pointer, ALWAYS use a pointer, if it\u0027s an Int, ALWAYS use an Int, if it\u0027s a Long, ALWAYS use a Long, and if it\u0027s an INT32 always use an INT32.\u00A0\u00A0 NEVER assume they are compatible even if they traditionally are.\u003Cbr\u003E\u003Cbr\u003E\nI hope that helps.\u00A0\u00A0 If not, default to the devs.\u003Cbr\u003E\u003Cbr\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"jrodriguez","CreatedById":130617,"CreatedDateTime":"2018-10-16T09:24:02Z","Content":"\n\u003Cp\u003E\n\u003Cspan\u003E\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/57704-ruedii/\u0026amp;do=hovercard\u0022 data-mentionid=\u002257704\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/57704-ruedii/\u0022 rel=\u0022\u0022\u003E@Ruedii\u003C/a\u003E\u00A0I don\u0027t think this issue has nothing to do with x86 x64 architecture.\u003C/span\u003E\u003Cbr\u003E\u003Cbr\u003E\nMy feeling with the\u00A0\u00A0\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003EArgume\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\uFEFF\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003EntOutOfRangeException\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\uFEFF\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\uFEFF is that the code is iterating through a stagegroup icon list however is accounting for more icons than the icons that are actually in the list.\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003EMy question for the devs is:\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\u00BFHave something changed between 1.4.5 and 1.5 releases in regards of StageManager class and the way the stage icons are managed?\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nHere you can see the code we are using to create the icon, this has been working fine until KSP 1.5.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/PapaJoesSoup/BDArmory/blob/master/BDArmory/Modules/ModuleWeapon.cs#L773\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/PapaJoesSoup/BDArmory/blob/master/BDArmory/Modules/ModuleWeapon.cs#L773\u003C/a\u003E\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E\n\nif (part.stackIcon.StageIcon == null)\n{\n\tpart.stackIcon.CreateIcon();\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Ruedii","CreatedById":57704,"CreatedDateTime":"2018-10-16T13:34:21Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223468838\u0022 data-ipsquote-contentid=\u0022179001\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221539681842\u0022 data-ipsquote-userid=\u0022130617\u0022 data-ipsquote-username=\u0022jrodriguez\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n3 hours ago, jrodriguez said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\n\u003Cspan\u003E\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/57704-ruedii/\u0026amp;do=hovercard\u0022 data-mentionid=\u002257704\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/57704-ruedii/\u0022 rel=\u0022\u0022\u003E@Ruedii\u003C/a\u003E\u00A0I don\u0027t think this issue has nothing to do with x86 x64 architecture.\u003C/span\u003E\u003Cbr\u003E\u003Cbr\u003E\nMy feeling with the\u00A0\u00A0\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003EArgume\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\uFEFF\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003EntOutOfRangeException\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\uFEFF\u003C/span\u003E\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\uFEFF is that the code is iterating through a stagegroup icon list however is accounting for more icons than the icons that are actually in the list.\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003EMy question for the devs is:\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003E\u00BFHave something changed between 1.4.5 and 1.5 releases in regards of StageManager class and the way the stage icons are managed?\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nHere you can see the code we are using to create the icon, this has been working fine until KSP 1.5.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/PapaJoesSoup/BDArmory/blob/master/BDArmory/Modules/ModuleWeapon.cs#L773\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/PapaJoesSoup/BDArmory/blob/master/BDArmory/Modules/ModuleWeapon.cs#L773\u003C/a\u003E\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\n\u003Cspan class=\u0022pln\u0022\u003E\n\nif (part.stackIcon.StageIcon == null)\n{\n\tpart.stackIcon.CreateIcon();\u003Cspan\u003E\uFEFF\u003C/span\u003E\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\n\u003Cbr\u003E\nWell, staging icons weren\u0027t really designed to be added and removed dynamically, and thus should not be considered an operation to do safely.\u00A0 Running part.stackIcon.CreateIcon while the game is inflight is an unsafe operation.\u00A0 The game pauses to avoid unsafe behavior when handling part detach and part destruction removal of staging icons, and resetting the staging order when docking.\u00A0 Pausing the game frequently is not something I would recommend.\u003Cbr\u003E\u003Cbr\u003E\nThe way I would recommend fixing the issue is just doing it in a manner more inline with standard KSP behavior.\u003Cbr\u003E\u003Cbr\u003E\nYou should instead take parachutes as a model for behavior.\u00A0\u003Cbr\u003E\nYou should have the icon attached to the base tree of the part from KSP\u0027s startup.\u00A0 (This can be inserted by your module).\u00A0 For any state indicator you should change to color of the icon.\u00A0 You should never have to remove or add an icon add an icon.\u003Cbr\u003E\u003Cbr\u003E\nThe icon should be added in the parent object that attaches in automatically to every BDArmory object with the specified capability.\u00A0\u003Cbr\u003E\u003Cbr\u003E\nIt should be attached automatically before vessel-load and only be removed when the part is removed from the craft, and KSP automatically removes icons for destroyed and detached parts, so you shouldn\u0027t have to worry about this.\u003Cbr\u003E\u003Cbr\u003E\nIn other words, this code shouldn\u0027t be necessary at all, because your mod should be written so that the icon exist attached to the part at least from the \u003Cabbr title=\u0022Vehicle Assembly Building\u0022\u003EVAB\u003C/abbr\u003E, if not from game startup.\n\u003C/p\u003E\n"},{"CreatedByName":"Ruedii","CreatedById":57704,"CreatedDateTime":"2018-10-16T13:49:45Z","Content":"\n\u003Cp\u003E\nI\u0027m going to look deeper into your exact issue, though.\u00A0 I found the documentation, and I\u0027m going to RTFM when I get home this afternoon.\u00A0 I\u0027m already running late.\u003Cbr\u003E\u003Cbr\u003E\nHowever, I highly recommend moving to a behavior that doesn\u0027t create and destroy staging icons inflight, if only for the sake of optimization.\u00A0 The create routine for stage icons wasn\u0027t intended to be run on a frequent basis, and thus will likely lag you a lot.\u003Cbr\u003E\u003Cbr\u003E\nIt seems that a null comparison is fine in C# to detect the instance of an object.\u00A0 I personally don\u0027t like that method of doing things, but I didn\u0027t create the programming language.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222018-10-16T14:06:17Z\u0022 title=\u002210/16/2018 02:06  PM\u0022 data-short=\u00225 yr\u0022\u003EOctober 16, 2018\u003C/time\u003E by Ruedii\u003C/strong\u003E\n\u003Cbr\u003Enull comparison note.\n\u003C/span\u003E\n"},{"CreatedByName":"jrodriguez","CreatedById":130617,"CreatedDateTime":"2018-10-16T17:50:34Z","Content":"\n\u003Cp\u003E\nThanks for the hints\u00A0\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/57704-ruedii/\u0026amp;do=hovercard\u0022 data-mentionid=\u002257704\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/57704-ruedii/\u0022 rel=\u0022\u0022\u003E@Ruedii\u003C/a\u003E\u00A0I will analyse the behaviour of Parachutes.\n\u003C/p\u003E\n\u003Cp\u003E\nGiven your knowledge of internals I was wondering if you are KSP developer?\n\u003C/p\u003E\n"},{"CreatedByName":"Ruedii","CreatedById":57704,"CreatedDateTime":"2018-10-17T17:45:46Z","Content":"\n\u003Cp\u003E\nNo, and in fact I just read the API documentation a few days ago.\u003Cbr\u003E\u003Cbr\u003E\nI\u0027m just really familiar with what causes problems in object oriented code.\u00A0 (Sort of a natural with object oriented and prototype-oriented code).\u00A0\u003Cbr\u003E\u003Cbr\u003E\nBTW, there is a switch to hide and unhide stage icons, while it also isn\u0027t used in-flight anywhere, it is far more likely to be safe, as it retains the staging order objects were placed in. \u00A0 You probably should see about using that.\u00A0 This way you aren\u0027t destroying and creating objects dynamically in-flight, which always slows stuff down.\u00A0 Simply hiding and unhiding always works better than creating and destroying.\u00A0\u003Cbr\u003E\u003Cbr\u003E\nI also noted you were not assigning staging order to objects before creating the icon.\u00A0 That might be the issue.\u00A0\u00A0 Recent compiler changes in Unity made null and void no longer equal zero in a lot of objects, and I noticed that KSP had a unity version release.\u00A0 Still, the easiest way to deal with this is just assign a deactivated staging icon to every single part in the game during game loading (all the way back at the loading screen before the title screen.)\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222018-10-17T17:46:36Z\u0022 title=\u002210/17/2018 05:46  PM\u0022 data-short=\u00225 yr\u0022\u003EOctober 17, 2018\u003C/time\u003E by Ruedii\u003C/strong\u003E\n\u003Cbr\u003Eforgot void\n\u003C/span\u003E\n"}]}