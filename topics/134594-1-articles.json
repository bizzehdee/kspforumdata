{"TopicId":134594,"ForumId":29,"TopicTitle":"Exception while debugging : CompareBaseObjectsInternal can only be called from the main thread ??","CreatedByName":"Baleine","CreatedById":131757,"CreatedDateTime":"2016-03-20T16:06:17Z","PageNum":1,"Articles":[{"CreatedByName":"Baleine","CreatedById":131757,"CreatedDateTime":"2016-03-20T16:06:17Z","Content":"\n\u003Cp\u003E\nHello guys. I\u0027m new to debugging in unity so maybe I missed something obvious (that must be the case).\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI tried to debug some functions in existing mods. I set up my debugging environment and it\u0027s working just fine. However, most of the mods I try to use are now completely broken and don\u0027t want to run correctly.\n\u003C/p\u003E\n\u003Cp\u003E\nI did found the problem, which stands in that Exception :\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nQuote\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nCompareBaseObjectsInternal can only be called from the main thread.\u003Cbr\u003E\nConstructors and field initializers will be executed from the loading thread when loading a scene.\u003Cbr\u003E\nDon\u0027t use this function in the constructor or field initializers, instead move initialization code to the Awake or Start function.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI understand that constructors should not use any compare functions since they are not executed in the main thread, but I don\u0027t really understand why they were running fine in \u0022production\u0022 environment. Kerbal Engineer Redux and FAR are the source of theses exception. And they were working fine before I set up\u00A0the debugging environment.\n\u003C/p\u003E\n\u003Cp\u003E\nI am using unity 4.6.4f1 for KSP 1.0.5, trying to debug with Visual Studio 2015 under Windows 8 and I did installed Sean McDougal\u00A0KspDevModePatcher, as well as the latest mono libraries to get a correct mdb file for my visual studio version.\n\u003C/p\u003E\n\u003Cp\u003E\nWould anyone happen to know some fix I could use to avoid these errors (and avoid changing every constructor in FAR or KER, that would be a pain since I don\u0027t want to debug them, but rather a mod depending on FAR)\n\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2016-03-20T18:58:25Z","Content":"\n\u003Cp\u003E\nI believe that both of those mods use a background thread to do various calculations.\u00A0 This is definitely true of KER (the vessel simulation code that calculates the deltaV is run in a background thread) and is probably also true of FAR.\u00A0 I don\u0027t know why they work fine in release and not in debug but I do remember something related to this in the thread about setting up the debug environment.\n\u003C/p\u003E\n\u003Cp\u003E\nIf you find that there is something in KER that could easily be changed to avoid this issue then please post about it in the KER thread.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-03-20T20:28:15Z\u0022 title=\u002203/20/2016 08:28  PM\u0022 data-short=\u00228 yr\u0022\u003EMarch 20, 2016\u003C/time\u003E by Padishar\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Baleine","CreatedById":131757,"CreatedDateTime":"2016-03-20T22:27:47Z","Content":"\n\u003Cp\u003E\nThank you for your help. That does not arrange me because I\u0027m trying to debug a mod relying on FAR and if FAR isn\u0027t working properly, then the mod does not work as intended.\n\u003C/p\u003E\n\u003Cp\u003E\nI kept on trying to find a way to solve this issue, and it seems that\u0027s something common in Unity. As far as I understood, there are a lot of functions and properties you can\u0027t access on a Component if you\u0027re not doing it on the main thread, and there\u0027s no easy way to invoke a function on the main thread. The problem with FAR is that it does its voxelization in background. I guess KER problem is somewhat related.\n\u003C/p\u003E\n\u003Cp\u003E\nI guess that means I can\u0027t debug to solve the problem on the mod I\u0027m working on. Thanks anyway\n\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2016-03-20T23:11:57Z","Content":"\n\u003Cp\u003E\nAs I understand it, the issue isn\u0027t because the mods call Unity code from other threads (KER doesn\u0027t access any Unity objects from the background thread)\u00A0but that initialisers get run in\u00A0a different thread in the development version of the Unity player and this causes the errors that happen.\u00A0 There is \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/index.php?/topic/102909-ksp-plugin-debugging-for-visual-studio-and-monodevelop-on-all-os/\u0026amp;do=findComment\u0026amp;comment=2310605\u0022\u003Ea post\u003C/a\u003E\u00A0in the debugging thread that mentions exactly the problem you are having in the same situation so the poster of that may have found a solution.\u00A0 This may involve changing and recompiling FAR or it may involve a modified version of the KSPDevModePatcher configured to patch the necessary bits of the FAR dll.\u00A0 I haven\u0027t looked into the patcher but that way\u00A0may be easier than trawling through the FAR source.\u00A0 Alternatively, it may be enough to compile a debug version of FAR as that may do something different with where the code gets put.\n\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2016-03-21T01:50:34Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222465499\u0022 data-ipsquote-contentid=\u0022134594\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221458489977\u0022 data-ipsquote-userid=\u0022131757\u0022 data-ipsquote-username=\u0022Baleine\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n9 hours ago, Baleine said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI understand that constructors should not use any compare functions since they are not executed in the main thread, but I don\u0027t really understand why they were running fine in \u0022production\u0022 environment. Kerbal Engineer Redux and FAR are the source of theses exception. And they were working fine before I set up\u00A0the debugging environment.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI think the release version of the engine might suppress warnings like this\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222466104\u0022 data-ipsquote-contentid=\u0022134594\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221458515517\u0022 data-ipsquote-userid=\u002297386\u0022 data-ipsquote-username=\u0022Padishar\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n2 hours ago, Padishar said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nAs I understand it, the issue isn\u0027t because the mods call Unity code from other threads (KER doesn\u0027t access any Unity objects from the background thread)\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nKER does appear to access a Unity object from the background thread (assuming the code on git is correct). It\u0027s easy to identify if you have the whole stack trace of the error to go by:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode\u0022\u003E\n[LOG 18:37:17.542] KerbalEngineer -\u0026gt; SimManager.RunSimulation() // CompareBaseObjectsInternal can only be called from the main thread.\nConstructors and field initializers will be executed from the loading thread when loading a scene.\nDon\u0027t use this function in the constructor or field initializers, instead move initialization code to the Awake or Start function.\n[LOG 18:37:17.544] KerbalEngineer -\u0026gt;   at (wrapper managed-to-native) UnityEngine.Object:CompareBaseObjectsInternal (UnityEngine.Object,UnityEngine.Object)\n  at UnityEngine.Object.CompareBaseObjects (UnityEngine.Object lhs, UnityEngine.Object rhs) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at UnityEngine.Object.op_Equality (UnityEngine.Object x, UnityEngine.Object y) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at PhysicsGlobals.get_Instance () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at PhysicsGlobals.get_Stack_PriUsesSurf () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at KerbalEngineer.VesselSimulator.EngineSim.SetResourceDrains (System.Collections.Generic.List\u00601 allParts, System.Collections.Generic.List\u00601 allFuelLines, System.Collections.Generic.HashSet\u00601 drainingParts) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at KerbalEngineer.VesselSimulator.Simulation.UpdateResourceDrains () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at KerbalEngineer.VesselSimulator.Simulation.RunSimulation () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at KerbalEngineer.VesselSimulator.SimManager.RunSimulation (System.Object simObject) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2016-03-21T07:54:44Z","Content":"\n\u003Cp\u003E\nAhh, thanks for that. \u00A0That was a very recent change that Cybutek made to support a new feature in KSP 1.0.5. \u00A0That will need changing to copy that flag in PrepareSimulation...\n\u003C/p\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2016-03-21T09:01:28Z","Content":"\n\u003Cp\u003E\nI just want to add my experience with thread an Unity object. If you share a Unity object between the main thread and your threads you can get really strange results. For example a FloatCurve will reply to your thread vith values asked in the main thread, and vice-versa. You need a copy of the object for the thread.\n\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2016-03-21T11:38:18Z","Content":"\n\u003Cp\u003E\nIt sounds like FloatCurve must be storing intermediate values for the calculation in a member variable and this causes an issue for simultaneous calls, though I can\u0027t see why they would want or need to. \u00A0I could understand if it generated coefficients for each section of the curve lazily but it would be better to store them for all the sections separately if you\u0027re going to bother storing them at all.\n\u003C/p\u003E\n\u003Cp\u003E\nEdit: Also, is FloatCurve a Unity thing? \u00A0It isn\u0027t mentioned anywhere in their documentation. \u00A0Are you sure it isn\u0027t a KSP thing...?\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-03-21T11:40:35Z\u0022 title=\u002203/21/2016 11:40  AM\u0022 data-short=\u00228 yr\u0022\u003EMarch 21, 2016\u003C/time\u003E by Padishar\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2016-03-21T12:27:39Z","Content":"\n\u003Cp\u003E\nYes, most likely. For MJ I found a way to clone them easily.\n\u003C/p\u003E\n\u003Cp\u003E\nFloatCurve is a KSP thing but they use AnimationCurve internally, which are in Unity.They more or less just warp the config node loading and saving.\n\u003C/p\u003E\n"}]}