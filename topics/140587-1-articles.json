{"TopicId":140587,"ForumId":70,"TopicTitle":"Massive frame rate issues, getting worse as save goes on","CreatedByName":"Chris97b","CreatedById":2686,"CreatedDateTime":"2016-05-26T20:52:24Z","PageNum":1,"Articles":[{"CreatedByName":"Chris97b","CreatedById":2686,"CreatedDateTime":"2016-05-26T20:52:24Z","Content":"\n\u003Cp\u003E\nOk, so I\u0027ve been having some issues of late, and I\u0027m really at a loss as to where to look. I have a fairly heavily modded (~100 mods) install, and initially the performance wasn\u0027t perfect, but it was definitely manageable. It seems though that the further my career save goes, the worse the problem gets, to the point where the last couple of launches have been complete slide-shows, maybe 5 fps if I\u0027m lucky. Just going around in Kerbin orbit with a decent sized ship (maybe 150 parts?) I\u0027m seeing maybe 3 FPS at best. I don\u0027t have any reason to believe it\u0027s related to part count or a particular mod, as the modlist hasn\u0027t really changed since I started the save, and I have flown the same ship several times before with nowhere near this degree of issues. Loading the same vessel into a sandbox game gives me expected performance (not spectacular, but 25-30 FPS at least).\n\u003C/p\u003E\n\u003Cp\u003E\nI do have some visual mods (EVE, scatterer) installed, and my system isn\u0027t exactly bleeding edge (GTX 670, i7 4770, 32GB), but none of that would seem to explain how the performance would be fine initially, but severely degrade over time. Memory and CPU usage aren\u0027t terrible (around 12GB and hovering at about 20%, not maxing out any of the cores), and I\u0027m at a loss to find the bottleneck.\n\u003C/p\u003E\n\u003Cp\u003E\nThe only thing I can think of, is that perhaps it\u0027s somehow related to the number of vessels in the save? I have an admittedly large (~115) number of flights in progress, but I can\u0027t seem to understand how having many unloaded vessels on the other side of the solar system would effect the performance of the active vessel. There can\u0027t be *that* much processing going on with them, can there? I mean it\u0027s not like KSP does any kind of background processing, other than their orbits, which should be on rails anyway right?\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027m mostly posting this in the hopes that someone might have some advice on whether there is any kind of profiling I can do, or other ways to help narrow down the issue. I\u0027m stuck at this point feeling like I have no idea where to look, and no good way to narrow down the options.\n\u003C/p\u003E\n\u003Cp\u003E\nThanks!\n\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2016-05-26T21:50:58Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222602823\u0022 data-ipsquote-contentid=\u0022140587\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221464295944\u0022 data-ipsquote-userid=\u00222686\u0022 data-ipsquote-username=\u0022Chris97b\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, Chris97b said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nThere can\u0027t be *that* much processing going on with them, can there? I mean it\u0027s not like KSP does any kind of background processing, other than their orbits, which should be on rails anyway right?\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nUnfortunately, this just isn\u0027t the case. \u00A0There is a known inefficiency in the handling of on-rails vessels due to the game recalculating the mass of every vessel on every physics update. \u00A0Not only does this use a considerable amount of CPU, but the code that does the calculations using the unloaded vessel data also creates a large amount of garbage.\n\u003C/p\u003E\n\u003Cp\u003E\nThere are also other things that are calculated, such as heat effects and\u00A0whether any on-rails vessels have entered the current physics bubble and need to be loaded.\n\u003C/p\u003E\n\u003Cp\u003E\nAs a further test to flying the same ship in an empty save, you could also make a copy of your save and then terminate vessels in the tracking station a few at a time and see what effect it has on the frame rate. \u00A0Another thing that might show interesting results is running my MemGraph mod (linked in my sig below) to display the memory allocation rate and garbage collection frequency. \u00A0The heap padding feature probably wont help you but it\u0027s worth doing it on the off chance that your performance issue is actually due to the garbage collector running almost constantly.\n\u003C/p\u003E\n\u003Cp\u003E\nEdit: I also meant to say that the devs are aware of this issue and do plan to fix it though they might appreciate seeing any performance figures you come up with...\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-05-26T22:07:36Z\u0022 title=\u002205/26/2016 10:07  PM\u0022 data-short=\u00228 yr\u0022\u003EMay 26, 2016\u003C/time\u003E by Padishar\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Chris97b","CreatedById":2686,"CreatedDateTime":"2016-05-26T22:09:30Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222602924\u0022 data-ipsquote-contentid=\u0022140587\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221464299458\u0022 data-ipsquote-userid=\u002297386\u0022 data-ipsquote-username=\u0022Padishar\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n15 minutes ago, Padishar said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nUnfortunately, this just isn\u0027t the case. \u00A0There is a known inefficiency in the handling of on-rails vessels due to the game recalculating the mass of every vessel on every physics update. \u00A0Not only does this use a considerable amount of CPU, but the code that does the calculations using the unloaded vessel data also creates a large amount of garbage.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nWhoa... I shudder to think how many parts I probably have unloaded at the moment. That would certainly explain a few things. I guess I don\u0027t understand why that\u0027s necessary though, how could the mass of a vessel change if physics aren\u0027t being applied? I can\u0027t imagine a corner case where simply saving the total mass in the persistence file when a vessel goes on rails wouldn\u0027t be sufficient.\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222602924\u0022 data-ipsquote-contentid=\u0022140587\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221464299458\u0022 data-ipsquote-userid=\u002297386\u0022 data-ipsquote-username=\u0022Padishar\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n17 minutes ago, Padishar said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nAs a further test to flying the same ship in an empty save, you could also make a copy of your save and then terminate vessels in the tracking station a few at a time and see what effect it has on the frame rate. \u00A0Another thing that might show interesting results is running my MemGraph mod (linked in my sig below) to display the memory allocation rate and garbage collection frequency. \u00A0The heap padding feature probably wont help you but it\u0027s worth doing it on the off chance that your performance issue is actually due to the garbage collector running almost constantly.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nYep, I\u0027ll do some testing and see what I can come up with. Thanks very much for the tips!\n\u003C/p\u003E\n"},{"CreatedByName":"Padishar","CreatedById":97386,"CreatedDateTime":"2016-05-26T22:32:15Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222602950\u0022 data-ipsquote-contentid=\u0022140587\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221464300570\u0022 data-ipsquote-userid=\u00222686\u0022 data-ipsquote-username=\u0022Chris97b\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n2 minutes ago, Chris97b said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nWhoa... I shudder to think how many parts I probably have unloaded at the moment. That would certainly explain a few things. I guess I don\u0027t understand why that\u0027s necessary though, how could the mass of a vessel change if physics aren\u0027t being applied? I can\u0027t imagine a corner case where simply saving the total mass in the persistence file when a vessel goes on rails wouldn\u0027t be sufficient.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI guess you were typing that when I edited my first post. \u00A0It\u0027s basically a\u00A0case of \u003Ca href=\u0022https://en.wikipedia.org/wiki/Technical_debt\u0022 rel=\u0022external nofollow\u0022\u003Etechnical debt\u003C/a\u003E built up during the early access development period that didn\u0027t get cleaned up before release. \u00A0The devs are aware of it (and a number of others)\u00A0and have plans to address them as soon as practical. \u00A0I don\u0027t believe\u00A0the stock game ever changes the mass of any parts\u00A0while a vessel is on rails but some mods do. \u00A0Any\u00A0mass change could be communicated to the vessel directly rather than the vessel adding up the mass of all the parts every time. \u00A0Unfortunately, while this should work quite nicely for resources being produced and consumed, it\u00A0doesn\u0027t fit very well with the IPartMassModifier interface that mods can use to dynamically adjust the non-resource bit of part masses. \u00A0However, I\u0027m sure the Squad devs will be able to sort it out...\n\u003C/p\u003E\n"},{"CreatedByName":"Chris97b","CreatedById":2686,"CreatedDateTime":"2016-05-26T22:51:30Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222602991\u0022 data-ipsquote-contentid=\u0022140587\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221464301935\u0022 data-ipsquote-userid=\u002297386\u0022 data-ipsquote-username=\u0022Padishar\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n9 minutes ago, Padishar said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI guess you were typing that when I edited my first post. \u00A0It\u0027s basically a\u00A0case of \u003Ca href=\u0022https://en.wikipedia.org/wiki/Technical_debt\u0022 rel=\u0022external nofollow\u0022\u003Etechnical debt\u003C/a\u003E built up during the early access development period that didn\u0027t get cleaned up before release. \u00A0The devs are aware of it (and a number of others)\u00A0and have plans to address them as soon as practical. \u00A0I don\u0027t believe\u00A0the stock game ever changes the mass of any parts\u00A0while a vessel is on rails but some mods do. \u00A0Any\u00A0mass change could be communicated to the vessel directly rather than the vessel adding up the mass of all the parts every time. \u00A0Unfortunately, while this should work quite nicely for resources being produced and consumed, it\u00A0doesn\u0027t fit very well with the IPartMassModifier interface that mods can use to dynamically adjust the non-resource bit of part masses. \u00A0However, I\u0027m sure the Squad devs will be able to sort it out...\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nYep, some basic testing pretty much confirms the issue is just a matter of too many unloaded vessels. Interestingly enough, the perceived performance (IOW my \u0022feel\u0022 for the frame rate) seemed to improve dramatically after removing only 2-3 vessels (out of ~115), and they weren\u0027t particularly more complicated than any others. I have an armada of 28 ships heading to Jool, mostly copies of each other headed to each moon. Removing 3 of them nearly doubled the performance. It\u0027s almost like there\u0027s a line that once crossed, everything goes downhill fast.\n\u003C/p\u003E\n\u003Cp\u003E\nThat\u0027s sorta unfortunate actually. I was kinda hoping maybe there would be something I could do to make it playable at least. I guess I could remove Remote Tech and whack all of my comms setups, but that\u0027s the only thing I can think of that would still fit the goal of the save (colonize all 5 of Jool\u0027s moons).\n\u003C/p\u003E\n\u003Cp\u003E\nInterestingly enough, it doesn\u0027t really seem to be related to memory or GC. The memory usage was pretty constant across tests and the GC stutter is painful, but no more so than it has been the entire save lol. This would seem to agree with the idea that the issue is simply CPU related in terms of processing a number of unloaded vessels.\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027m no expert coder by any means (not on your guys\u0027 level anyway), but it seems to me that if there\u0027s an interface that mods are implementing to change the mass of unloaded vessels, couldn\u0027t that interface have a mechanism to set a flag that the vessel mass needed to be recalculated?\n\u003C/p\u003E\n"}]}