{"TopicId":136877,"ForumId":29,"TopicTitle":"[Solved] How to update engine fx through a plugin","CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-04-13T18:18:11Z","PageNum":1,"Articles":[{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-04-13T18:18:11Z","Content":"\n\u003Cp\u003E\nI\u0027m creating an engine switcher, and now I\u0027m looking af switch the effects along with engine stats. Now I\u0027ve run into en issue where the fx does not update properly from \u0022OnLoad()\u0022 event.\n\u003C/p\u003E\n\u003Cp\u003E\nBasically what I do is\n\u003C/p\u003E\n\u003Col\u003E\u003Cli\u003E\nLoad settings from custom module\n\u003C/li\u003E\n\u003Cli\u003E\nIdentify engine module to change\n\u003C/li\u003E\n\u003Cli\u003E\nUse ConfigNode to replace values regarding Fx in the engine\n\u003C/li\u003E\n\u003Cli\u003E\nLoad the new values to the engine.\n\u003C/li\u003E\n\u003C/ol\u003E\u003Cp\u003E\nI only have one update function, which is called by the OnLoad() event as well as by my switch button in the right click menu. However, when loading (or starting) a flight scene, the animation is just running with the animation from the original part. The issue seems to be triggered when\u00A0the fx intended is different from the original one.... The behavior is not affected by deactivating the engine... (\u003Ca href=\u0022https://github.com/WarezCrawler/Guybrush101/blob/master/Guybrush101/Core/EngineClassSwitch_Effects.cs\u0022 rel=\u0022external nofollow\u0022\u003Efull code can be accessed here\u003C/a\u003E)\n\u003C/p\u003E\n\u003Cdiv class=\u0022ipsSpoiler\u0022 data-ipsspoiler=\u0022\u0022\u003E\n\u003Cdiv class=\u0022ipsSpoiler_header\u0022\u003E\n\u003Cspan\u003ESpoiler\u003C/span\u003E\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsSpoiler_contents\u0022\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\n\u003Cspan\u003Epublic void updateEngineModuleEffects(ModuleEngines moduleEngine, bool calledByPlayer, string callingFunction = \u0022player\u0022)\n        {\n            ConfigNode newEngineEffectNode = new ConfigNode();\n            ConfigNode EngineEffectNode = newEngineEffectNode;\n            \n\n            if (!runningEffectNameEmpty)\n            {\n\n                if (string.IsNullOrEmpty(propList[selectedPropellant].runningEffectName))\t\t//propList is a custom list where the setting values are stored untill needed.\n                {\n                    EngineEffectNode.RemoveValue(\u0022runningEffectName\u0022);\n                    moduleEngine.DeactivateRunningFX();\n                }\n                else\n                {\n                    EngineEffectNode.AddValue(\u0022runningEffectName\u0022, propList[selectedPropellant].runningEffectName);\n                    moduleEngine.ActivateRunningFX();\n                }\n\n                \n                Debug.Log(\n                        \u0022\\npropList[selectedPropellant].runningEffectName \u0022 \u002B propList[selectedPropellant].runningEffectName \u002B\n                        \u0022\\nstring.IsNullOrEmpt \u0022 \u002B string.IsNullOrEmpty(propList[selectedPropellant].runningEffectName) \u002B\n                        \u0022\u0022 \u002B \u0022\u0022);\n            }\n            if (!powerEffectNameEmpty)\n            {\n                if (string.IsNullOrEmpty(propList[selectedPropellant].runningEffectName))\n                {\n                    EngineEffectNode.RemoveValue(\u0022powerEffectName\u0022);\n                    moduleEngine.DeactivatePowerFX();\n                }\n                else\n                {\n                    EngineEffectNode.AddValue(\u0022powerEffectName\u0022, propList[selectedPropellant].powerEffectName);\n                    moduleEngine.ActivatePowerFX();\n                }\n\n\n\n                \n                Debug.Log(\u0022propList[selectedPropellant].powerEffectName: \u0022 \u002B propList[selectedPropellant].powerEffectName);\n            }\n            if (!spoolEffectNameEmpty)\n            {\n                EngineEffectNode.AddValue(\u0022spoolEffectName\u0022, propList[selectedPropellant].spoolEffectName);\n                Debug.Log(\u0022propList[selectedPropellant].spoolEffectName: \u0022 \u002B propList[selectedPropellant].spoolEffectName);\n            }\n\n\n\n            moduleEngine.Load(EngineEffectNode);\n            moduleEngine.InitializeFX();\n            \n            //moduleEngine.FXReset();\n            //moduleEngine.FXUpdate();\n            //moduleEngine.\n            //}\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/div\u003E\n\u003Cp\u003E\nI guess there is some trick to get the fx changes to take effect, but I just can\u0027t figure out what it is. Does anybody out there know what is needed?\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-04-16T21:59:20Z\u0022 title=\u002204/16/2016 09:59  PM\u0022 data-short=\u00228 yr\u0022\u003EApril 16, 2016\u003C/time\u003E by Warezcrawler\u003C/strong\u003E\n\u003Cbr\u003ESolved\n\u003C/span\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-04-14T14:04:37Z","Content":"\n\u003Cp\u003E\nSome testing have showed that switching from UI work\u0027s in current version, however if switching while throttled up, then animation/effects is not switched correctly... It does switch in the engine is not running, or running very slowly (spinning down) after being used).\n\u003C/p\u003E\n\u003Cp\u003E\nThere must be some trick to have the animation take effect in engines.\n\u003C/p\u003E\n\u003Cp\u003E\nSo, the challenge of changing effect have been identified when loading the scene, and when switching while the engine is running.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nDoes anybody have an idea of how to attack this?\n\u003C/p\u003E\n"},{"CreatedByName":"Shadowmage","CreatedById":138730,"CreatedDateTime":"2016-04-14T20:12:16Z","Content":"\n\u003Cp\u003E\nHere is my FX updating code that I use for some resizable SRB parts; it is more oriented towards rescaling, but perhaps it contains some useful information applicable to your situation (it does force-reload the FX through the part rather than engine; might need to do both). (note that scaling doesn\u0027t work for stock effects.... and that it only works properly for RealPlume configured effects; though that should not matter for the reloading/re-init code)\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/shadowmage45/SSTULabs/blob/master/Source/Module/SSTUModularBooster.cs#L806-L903\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/shadowmage45/SSTULabs/blob/master/Source/Module/SSTUModularBooster.cs#L806-L903\u003C/a\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-04-16T09:57:41Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222514082\u0022 data-ipsquote-contentid=\u0022136877\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221460664736\u0022 data-ipsquote-userid=\u0022138730\u0022 data-ipsquote-username=\u0022Shadowmage\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nOn 14/4/2016 at 10:12 PM, Shadowmage said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nHere is my FX updating code that I use for some resizable SRB parts; it is more oriented towards rescaling, but perhaps it contains some useful information applicable to your situation (it does force-reload the FX through the part rather than engine; might need to do both). (note that scaling doesn\u0027t work for stock effects.... and that it only works properly for RealPlume configured effects; though that should not matter for the reloading/re-init code)\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/shadowmage45/SSTULabs/blob/master/Source/Module/SSTUModularBooster.cs#L806-L903\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/shadowmage45/SSTULabs/blob/master/Source/Module/SSTUModularBooster.cs#L806-L903\u003C/a\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThanks. I\u0027ll have a look at it.\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-04-16T12:23:09Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222514082\u0022 data-ipsquote-contentid=\u0022136877\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221460664736\u0022 data-ipsquote-userid=\u0022138730\u0022 data-ipsquote-username=\u0022Shadowmage\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nOn 14/4/2016 at 10:12 PM, Shadowmage said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nHere is my FX updating code that I use for some resizable SRB parts; it is more oriented towards rescaling, but perhaps it contains some useful information applicable to your situation (it does force-reload the FX through the part rather than engine; might need to do both). (note that scaling doesn\u0027t work for stock effects.... and that it only works properly for RealPlume configured effects; though that should not matter for the reloading/re-init code)\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/shadowmage45/SSTULabs/blob/master/Source/Module/SSTUModularBooster.cs#L806-L903\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/shadowmage45/SSTULabs/blob/master/Source/Module/SSTUModularBooster.cs#L806-L903\u003C/a\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI tried the Onload method in several ways, but it does not seem to change anything\u00A0\u003Cimg alt=\u0022:(\u0022 data-emoticon=\u0022true\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_sad.gif\u0022 title=\u0022:(\u0022\u003E\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003Epart.Effects.OnLoad(copiedEffectsNode);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nI\u0027ve even tried using confignodes to copy the entire engine module, and reload it into the part..... Maybe I\u0027m doing it wrong, but it basically did nothing for me.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nTo restate my issue:\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nWhen loading a scene, the FX is just running, disregarding that the engine is of.\n\u003Cul\u003E\u003Cli\u003E\nThe FX running is also the parts normal FX and not the one I set in my mod.\n\u003C/li\u003E\n\u003Cli\u003E\nThe FX is reset to the right one if I do manual switch by UI after scene is loaded.\n\u003Cul\u003E\u003Cli\u003E\nThe update function is to same one as when the scene is loaded.\n\u003C/li\u003E\n\u003C/ul\u003E\u003C/li\u003E\n\u003C/ul\u003E\u003C/li\u003E\n\u003Cli\u003E\nIf changing Fx while engine is running, the Fx does not change as it should.\n\u003Cul\u003E\u003Cli\u003E\nIt does change correctly if the engine have had time to spin down first, otherwise it will retain the fx it had...\n\u003C/li\u003E\n\u003C/ul\u003E\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\nI somehow need to destroy the fx already running/in the engine, and replace it by new ones.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nCurrently I have (I have cut out \u0022noise\u0022 code)\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003EConfigNode EngineEffectNode = newEngineEffectNode;\n\nEngineEffectNode.AddValue(\u0022runningEffectName\u0022, propList[selectedPropellant].runningEffectName);\nEngineEffectNode.AddValue(\u0022powerEffectName\u0022, propList[selectedPropellant].powerEffectName);\nEngineEffectNode.AddValue(\u0022spoolEffectName\u0022, propList[selectedPropellant].spoolEffectName);\n\nmoduleEngine.Load(EngineEffectNode);\n\n//Where propList[selectedPropellant].XYZ is the new effect\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nThen CFG nodes/value I\u0027m trying to change are\n\u003C/p\u003E\n\u003Cdiv class=\u0022ipsSpoiler\u0022 data-ipsspoiler=\u0022\u0022\u003E\n\u003Cdiv class=\u0022ipsSpoiler_header\u0022\u003E\n\u003Cspan\u003ESpoiler\u003C/span\u003E\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsSpoiler_contents\u0022\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\n\u003Cspan\u003EPART\n{\n\tname = turboFanEngine_modified\n\t...\n\tMODULE\n\t{\n\t\tname = ModuleEnginesFX\n\t\t...\n\t\trunningEffectName = shockDiamond\t\t\t\t\t//Change to running_dry\n\t\tpowerEffectName = running_thrust\t\t\t\t\t//Change to power_dry\n\t\tspoolEffectName = running_turbine\t\t\t\t\t//Change to running_dry\n\t\t...\n\t}\n}\n\n//I\u0027ve added new effects using module manager to the effects node\n\u002BPART[turboFanEngine]\t\t\t\t\t//Yes I\u0027m creating a copy which I change\n{\n\t@name = turboFanEngine_modified\n\t@title = J-X4 \u0022Whiplash\u0022 MODIFIED\n\t@EFFECTS\n\t{\n\t\t\n\t\trunning_dry\n\t\t{\n\t\t\tPREFAB_PARTICLE\n\t\t\t{\n\t\t\t\tprefabName = fx_smokeTrail_light\n\t\t\t\ttransformName = smokePoint\n\t\t\t\temission = 0.0 0.0\n\t\t\t\temission = 0.05 0.0\n\t\t\t\temission = 0.075 0.25\n\t\t\t\temission = 1.0 1.25\n\t\t\t\tspeed = 0.0 0.25\n\t\t\t\tspeed = 1.0 1.0\n\t\t\t\tlocalOffset = 0, 0, 1\n\t\t\t\tlocalRotation = 1, 0, 0, -90\n\t\t\t}\n\t\t\tAUDIO\n\t\t\t{\n\t\t\t\tchannel = Ship\n\t\t\t\tclip = sound_jet_low\n\t\t\t\tvolume = 0.0 0.0\n\t\t\t\tvolume = 0.05 0.9\n\t\t\t\tvolume = 1.0 1.0\n\t\t\t\tpitch = 0.0 0.5\n\t\t\t\tpitch = 0.05 0.6\n\t\t\t\tpitch = 0.33 1.0\n\t\t\t\tpitch = 1.0 1.2\n\t\t\t\tloop = true\n\t\t\t}\n\t\t}\n\t\tpower_dry\n\t\t{\n\t\t\tAUDIO\n\t\t\t{\n\t\t\t\tchannel = Ship\n\t\t\t\tclip = sound_jet_deep\n\t\t\t\tvolume = 0.0 0.0\n\t\t\t\tvolume = 0.05 0.4\n\t\t\t\tvolume = 1.0 0.9\n\t\t\t\tpitch = 0.0 0.8\n\t\t\t\tpitch = 1.0 1.4\n\t\t\t\tloop = true\n\t\t\t}\n\t\t}\n\t}\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/div\u003E\n\u003Cp\u003E\nSo I\u0027m not changing the EFFECTS node in my plugin, I use MM for that. By I do try to change the engine references using my plugin.\n\u003C/p\u003E\n\u003Cp\u003E\nDoes anyone notice what I might be doing wrong?\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-04-16T12:35:04Z\u0022 title=\u002204/16/2016 12:35  PM\u0022 data-short=\u00228 yr\u0022\u003EApril 16, 2016\u003C/time\u003E by Warezcrawler\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2016-04-16T21:46:58Z","Content":"\n\u003Cp\u003E\nI found a way. Somehow the effect animations did not reset correctly. I was succesfull in getting the effects to reset by doing two things.\n\u003C/p\u003E\n\u003Cp\u003E\nFor the animation of effects running af scene load, I used the monobehavior \u0022invoke\u0022, and introduced a short delay of 1 sec at scene load.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003E//I used this\nInvoke(\u0022updateEngineModule\u0022, 1f);\n\n//and it replaced\nupdateEngineModule();\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nnext issue was when switching between engine configurations, the effect again did not update correctly. Apparently I had to disable 3 Fx methods to achieve that the new effects could take over correctly, and not having to old ones running indefinately.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan\u003EcurrentModuleEngine.DeactivateLoopingFX();\ncurrentModuleEngine.DeactivatePowerFX();\ncurrentModuleEngine.DeactivateRunningFX();\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nSpecial thanks to Shadowmage and FreeThinker for helping me at this matter.\n\u003C/p\u003E\n\u003Cp\u003E\nHappy coding\n\u003C/p\u003E\n"}]}