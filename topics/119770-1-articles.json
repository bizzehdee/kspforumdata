{"TopicId":119770,"ForumId":29,"TopicTitle":"Rescaling Gas Giants","CreatedByName":"nightingale","CreatedById":119307,"CreatedDateTime":"2015-08-30T19:58:49Z","PageNum":1,"Articles":[{"CreatedByName":"nightingale","CreatedById":119307,"CreatedDateTime":"2015-08-30T19:58:49Z","Content":"\n\u003Cp\u003ETesting out some ideas for a new contract pack, and one thing I want to do requires me to play the planetary scale a little bit. Note that this wouldn\u0027t be a Kopernicus thing, as the scaling is dependent on an event. Also, what I\u0027m doing is far far simpler (in theory) than Kopernicus - just a simple rescale of a body without a PQS.\u003C/p\u003E\u003Cp\u003EAnyway, after much trial and error, I\u0027ve gotten my 50% rescale test working for everything but the atmosphere. I was hoping someone can get me the last mile:\u003C/p\u003E\u003Cp\u003EBefore:\u003C/p\u003E\u003Cp\u003E\u003Cimg src=\u0022http://i.imgur.com/nEhrpnE.png\u0022 alt=\u0022nEhrpnE.png\u0022\u003E\u003C/p\u003E\u003Cp\u003EAfter:\u003C/p\u003E\u003Cp\u003E\u003Cimg src=\u0022http://i.imgur.com/kYRb4Xr.png\u0022 alt=\u0022kYRb4Xr.png\u0022\u003E\u003C/p\u003E\u003Cp\u003EI know that the general issue is that the atmosphere background isn\u0027t being scaled, but I can\u0027t seem to figure out what is needed to set the scale for that. Any assistance is appreciated. Here\u0027s my test code:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E        private void DoRescale()        {\u003Cbr\u003E            Debug.Log(\u0022doing Jool Rescale\u0022);\u003Cbr\u003E            PSystemBody psbJool = PSystemManager.Instance.systemPrefab.rootBody.children.Where(psb =\u0026gt; psb.celestialBody.name == \u0022Jool\u0022).First();\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            // This works\u003Cbr\u003E            MeshFilter joolMeshFilter = psbJool.scaledVersion.GetComponent\u0026lt;MeshFilter\u0026gt;();\u003Cbr\u003E            ScaleMesh(joolMeshFilter.sharedMesh);\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            // This does nothing\u003Cbr\u003E            MeshFilter atmoMeshFilter = psbJool.scaledVersion.GetComponentsInChildren\u0026lt;MeshFilter\u0026gt;(true).Where(mr =\u0026gt; mr.name == \u0022Atmosphere\u0022).First();\u003Cbr\u003E            ScaleMesh(atmoMeshFilter.sharedMesh);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        private void ScaleMesh(Mesh mesh)\u003Cbr\u003E        {\u003Cbr\u003E            Vector3[] oldVertices = mesh.vertices;\u003Cbr\u003E            Vector3[] newVertices = new Vector3[oldVertices.Count()];\u003Cbr\u003E            for (int i = 0; i \u0026lt; oldVertices.Count(); i\u002B\u002B)\u003Cbr\u003E            {\u003Cbr\u003E                newVertices[i] = oldVertices[i] * 0.5f;\u003Cbr\u003E            }\u003Cbr\u003E            mesh.vertices = newVertices;\u003Cbr\u003E        }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EI\u0027ve also played around with the AtmosphereFromGround class a bunch to no avail, as well as changing the Atmosphere transform.\u003C/p\u003E\n"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2015-08-31T01:56:38Z","Content":"\n\u003Cp\u003EGiven who you are, code may be faster than words. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_happy.png\u0022 alt=\u0022^_^\u0022\u003E\u003C/p\u003E\u003Cp\u003ESearch \u0060AtmosphereFromGround\u0060 here. \u003Ca href=\u0022https://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E(tl;dr there\u0027s an AtmosphereFromGround object that makes that halo, and you need to update some properties. Easiest to just call Start() on it, but if you want to fine tune it you need the method above.)\u003C/p\u003E\n"},{"CreatedByName":"nightingale","CreatedById":119307,"CreatedDateTime":"2015-08-31T03:04:33Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022NathanKell\u0022 data-cite=\u0022NathanKell\u0022\u003E\u003Cdiv\u003EGiven who you are, code may be faster than words. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_happy.png\u0022 alt=\u0022^_^\u0022\u003E\u003Cp\u003ESearch \u0060AtmosphereFromGround\u0060 here. \u003Ca href=\u0022https://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E(tl;dr there\u0027s an AtmosphereFromGround object that makes that halo, and you need to update some properties. Easiest to just call Start() on it, but if you want to fine tune it you need the method above.)\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHeh, I had already looked at that code file and tried some stuff from it to no avail. But now that I know that\u0027s where I should focus my efforts hopefully I\u0027ll have more success.\u003C/p\u003E\n"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2015-08-31T04:26:03Z","Content":"\n\u003Cp\u003ELet me know if you need more guidance, happy to help, especially with all the time you sunk into helping me! \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"nightingale","CreatedById":119307,"CreatedDateTime":"2015-08-31T04:43:36Z","Content":"\n\u003Cp\u003EI may have to take you up on this, I don\u0027t seem to be getting anywhere.\u003C/p\u003E\u003Cp\u003EI\u0027ve tried poking at the AtmosphereFromGround component, at first I would get some nasty NullRef exceptions for every method I call (extremely suspiciously, the mainCamera, sunLight and planet fields were all null. Was able to set those and hit the code that updates the shaders, but not real luck on getting rid of the white halo.\u003C/p\u003E\u003Cp\u003ESo I started to suspect that I must still be barking up the wrong tree, and nuked the Atmosphere GameObject via Destroy. Halo still present. So any thoughts on where I may need to look? Here\u0027s a dump of Jool\u0027s components from PSystemBody down:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003EPSystemBody component: PSystemBody (UnityEngine.Transform)\u003Cbr\u003EPSystemBody component: PSystemBody (PSystemBody)\u003Cbr\u003EPSystemBody component: Jool (UnityEngine.Transform)\u003Cbr\u003EPSystemBody component: Jool (CelestialBody)\u003Cbr\u003EPSystemBody component: Jool (PResource)\u003Cbr\u003EPSystemBody component: Jool (OrbitDriver)\u003Cbr\u003EPSystemBody component: Jool (OrbitRenderer)\u003Cbr\u003EcelestialBody component: Jool (UnityEngine.Transform)\u003Cbr\u003EcelestialBody component: Jool (CelestialBody)\u003Cbr\u003EcelestialBody component: Jool (PResource)\u003Cbr\u003EcelestialBody component: Jool (OrbitDriver)\u003Cbr\u003EcelestialBody component: Jool (OrbitRenderer)\u003Cbr\u003EscaledVersion component: Jool (UnityEngine.Transform)\u003Cbr\u003EscaledVersion component: Jool (UnityEngine.MeshFilter)\u003Cbr\u003EscaledVersion component: Jool (UnityEngine.MeshRenderer)\u003Cbr\u003EscaledVersion component: Jool (UnityEngine.SphereCollider)\u003Cbr\u003EscaledVersion component: Jool (ScaledSpaceFader)\u003Cbr\u003EscaledVersion component: Jool (MaterialSetDirection)\u003Cbr\u003EscaledVersion component: Atmosphere (UnityEngine.Transform)\u003Cbr\u003EscaledVersion component: Atmosphere (UnityEngine.MeshFilter)\u003Cbr\u003EscaledVersion component: Atmosphere (UnityEngine.MeshRenderer)\u003Cbr\u003EscaledVersion component: Atmosphere (AtmosphereFromGround)\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003ELooking over that list, I think I\u0027m going to take a closer look at the ScaledSpaceFader... that\u0027s about the only thing left that I haven\u0027t messed around with yet.\u003C/p\u003E\n"},{"CreatedByName":"nightingale","CreatedById":119307,"CreatedDateTime":"2015-08-31T05:23:02Z","Content":"\n\u003Cp\u003EAlright, didn\u0027t seem to have any luck there.\u003C/p\u003E\u003Cp\u003EThe other possibility would be that I dismissed the atmosphere stuff too quickly - I assumed that destroying the gameObject actually got rid of everything... but I suppose that it could be leaving some shader behind somewhere that is still getting executed? Not really too familiar with how unity destruction works - I just assumed it\u0027ll take care of everything in the hierarchy, but I guess if the Squad code isn\u0027t setting it up properly....\u003C/p\u003E\u003Cp\u003EAlright, enough for tonight - I\u0027ll play around with this some more tomorrow evening... any advice in the meantime is appreciated.\u003C/p\u003E\n"},{"CreatedByName":"nightingale","CreatedById":119307,"CreatedDateTime":"2015-08-31T14:23:33Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Thomas P.\u0022 data-cite=\u0022Thomas P.\u0022\u003E\u003Cdiv\u003ESince the ScaledSpace uses the same mesh-size for every planet (6000 units) \u002B the localScale property to scale the Mesh down / up, you could simply use this:\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Epublic void ScaleJool(float scale)\u003Cbr\u003E{\u003Cbr\u003E   // Find Jool (PSystemManager.Instance.localBodies is replaceable with FlightGlobals.Bodies)\u003Cbr\u003E   CelestialBody jool = PSystemManager.Instance.localBodies.Find(b =\u0026gt; b.name == \u0022Jool\u0022);\u003Cbr\u003E\u003Cbr\u003E   // Null Check\u003Cbr\u003E   if (jool == null) return;\u003Cbr\u003E\u003Cbr\u003E   // Change Jool\u0027s (display-)radius\u003Cbr\u003E   jool.Radius *= scale;\u003Cbr\u003E\u003Cbr\u003E   // Rescale Jool\u0027s ScaledVersion Transform\u003Cbr\u003E   jool.scaledBody.transform.localScale *= scale;\u003Cbr\u003E\u003Cbr\u003E   // Rescale the Collider (if it exists)\u003Cbr\u003E   SphereCollider collider = jool.scaledBody.GetComponent\u0026lt;SphereCollider\u0026gt;();\u003Cbr\u003E   if (collider != null) collider.radius *= scale;\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThis code must be executed after PSystemSpawn, ie. at KSPAddon.Startup.MainMenu or KSPAddon.Startup.PSystemSpawn in the Start() method. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E You can, of course, transform this into prefab-modification code, but that\u0027d break compatibility with Kopernicus. \u003C/p\u003E\u003Cp\u003ECheers!\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThanks! I swear I\u0027d tried all those things (at least individually) without luck, but it worked. Unfortunately, there\u0027s still the white atmospheric \u0022halo\u0022 doing it this way, so I still seem to be missing one critical piece.\u003C/p\u003E\n"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2015-08-31T19:04:50Z","Content":"\n\u003Cp\u003ESure!\u003C/p\u003E\u003Cp\u003EFirst, you need to find the right AFG. See here for how I loop through all and match on name.\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L1912-L1921\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L1912-L1921\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EThen I actually do the updating. That\u0027s this block here:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L114-L215\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L114-L215\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EThis does default rescaling (the way KSP sets up scaling of these things by default--you need to do it again here if the body changes radius): \u003Ca href=\u0022https://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L192-L194\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L192-L194\u003C/a\u003E\u003C/p\u003E\u003Cp\u003ENext we recalculate all the derived members:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L196-L205\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L196-L205\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EFinally we apply the changes: \u003Ca href=\u0022https://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L208-L209\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/NathanKell/RealSolarSystem/blob/master/Source/RealSolarSystem.cs#L208-L209\u003C/a\u003E\u003C/p\u003E\n"},{"CreatedByName":"nightingale","CreatedById":119307,"CreatedDateTime":"2015-08-31T19:54:38Z","Content":"\n\u003Cp\u003ESo the AtmosphereFromGround object that was tied to the Atmosphere GameObject is NOT the same object that I get when I use your method linked above, which was the problem. I did a dump of the info on the AFG object your method found, and it\u0027s also on a GameObject called Atmosphere, with the same components (Transform, MeshFilter, MeshRenderer, AtmosphereFromGround). This bugs me to no end. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EAnyway, it worked, so thank you both very much for your assistance here!\u003C/p\u003E\u003Cp\u003E\u003Cspan style=\u0022font-size:8px;\u0022\u003E\u003Cspan style=\u0022color:#C0C0C0;\u0022\u003E- - - Updated - - -\u003C/span\u003E\u003C/span\u003E\u003C/p\u003E\u003Cp\u003EOkay, I figured out why I was having so much trouble originally (and Thomas P made reference to it if I had been thinking clearer about the implications). I was messing around on the preFab object, long after the Jool CelestialBody had been instantiated. Which is why I had so much trouble and the only thing that seemed to give me results was doing very destructive things like altering the shared mesh (I was also wondering why altering the localized copy of the mesh via the mesh property hadn\u0027t work).\u003C/p\u003E\u003Cp\u003ESo it all makes sense now, thanks again.\u003C/p\u003E\n"},{"CreatedByName":"NathanKell","CreatedById":75006,"CreatedDateTime":"2015-08-31T21:35:31Z","Content":"\n\u003Cp\u003EAh! Yeah, there\u0027s multple copies, it\u0027s confusing. :]\u003C/p\u003E\u003Cp\u003EGlad it\u0027s sorted! \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"}]}