{"TopicId":137340,"ForumId":29,"TopicTitle":"How to get notifications in editor of changes to a resource container","CreatedByName":"Snark","CreatedById":125662,"CreatedDateTime":"2016-04-19T17:35:19Z","PageNum":1,"Articles":[{"CreatedByName":"Snark","CreatedById":125662,"CreatedDateTime":"2016-04-19T17:35:19Z","Content":"\n\u003Cp\u003E\nLet\u0027s say I\u0027m in the vehicle editor, and I want to trap an event when one of the following things happen:\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nThe amount of resource in the container was changed (e.g. if the user clicks on the \u0022amount\u0022 slider in the right-click menu)\n\u003C/li\u003E\n\u003Cli\u003E\nThe resource was enabled/disabled (e.g. if the user clicks on the little checkbox to the right of the slider)\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\nHow do I do that?\n\u003C/p\u003E\n\u003Cp\u003E\nI would have \u003Cem\u003E\u003Cu\u003Eexpected\u003C/u\u003E\u003C/em\u003E to get a GameEvents.onEditorPartEvent for the affected part, with a ConstructionEventType of \u0022PartTweaked\u0022, for both cases.\u00A0 However, here\u0027s what I observe:\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nI never get any GameEvents.onEditorPartEvent notifications with PartTweaked, at all, for anything, ever.\n\u003C/li\u003E\n\u003Cli\u003E\nIf I change the resource slider amount, I \u003Cem\u003E\u003Cu\u003Edo\u003C/u\u003E\u003C/em\u003E get a GameEvents.onEditorShipModified (so I know the ship was touched... but I have no idea which part was modified)\n\u003C/li\u003E\n\u003Cli\u003E\nIf I check/uncheck the \u0022enabled\u0022 checkbox... as far as I can tell, I get no notifications at all.\u00A0 Specifically, I do \u003Cem\u003E\u003Cu\u003Enot\u003C/u\u003E\u003C/em\u003E get a GameEvents.onEditorShipModified, the way I get one with the resource slider changing.\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\nDoes anyone have any suggestions?\u00A0 How do I track this?\n\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2016-04-19T19:36:15Z","Content":"\n\u003Cp\u003E\nI\u0027d look to editing the resource item prefab and adding a component that fires GameEvents.onEditorPartEvent, or your own event if you want more information. Here\u0027s how it might look in 1.1, 1.0.5 would be similar but with EzGUI instead of uGUI\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode\u0022\u003E\n[KSPAddon(KSPAddon.Startup.EditorAny, false)]\nclass TestResourceTweakEvents : MonoBehaviour\n{\n    public void Start() { GameEvents.onEditorPartEvent.Add(EditorPartEvent); }\n        \n    private void OnDestroy() { GameEvents.onEditorPartEvent.Remove(EditorPartEvent); }\n\n    private void EditorPartEvent(ConstructionEventType constructionEvent, Part part)\n    {\n        if (constructionEvent != ConstructionEventType.PartTweaked) return;\n\n        print(\u0022Part tweaked: \u0022 \u002B part \u002B \u0022, \u0022 \u002B EditorLogic.fetch.ship.parts.IndexOf(part));\n    }\n}\n\n\n[KSPAddon(KSPAddon.Startup.EditorAny, false)]\nclass InstallResourceTweakListener : MonoBehaviour\n{\n    class ResourceTweakListener : MonoBehaviour\n    {\n        // the UIPartActionResourceEditor contains everything we might want to know, right down\n        // to which exact PartModule and resource has been edited\n        private UIPartActionResourceEditor _host;\n        private Slider _resourceSlider;\n        private UIButtonToggle _resourceToggle;\n\n        private void Start()\n        {\n            _host = GetComponentInParent\u0026lt;UIPartActionResourceEditor\u0026gt;();\n\n            // use the version of GetComponentsInChildren that returns inactive objects as well, since resources with\n            // no flow mode will have the toggle button disabled\n            _resourceToggle = GetComponentsInChildren\u0026lt;UIButtonToggle\u0026gt;(true).FirstOrDefault();\n            _resourceSlider = GetComponentInChildren\u0026lt;Slider\u0026gt;();\n\n            if (!_host || !_resourceSlider || !_resourceToggle)\n            {\n                Debug.LogError(\u0022Couldn\u0027t find something ResourceTweakListener needed\u0022);\n                _resourceSlider = null;\n                _resourceToggle = null;\n                Destroy(this);\n            }\n            else\n            {\n                _resourceSlider.onValueChanged.AddListener(ResourceValueChanged);\n                _resourceToggle.onToggle.AddListener(ResourceToggled);\n            }\n        }\n\n\n        private void OnDestroy()\n        {\n            if (_resourceSlider != null)\n                _resourceSlider.onValueChanged.RemoveListener(ResourceValueChanged);\n            if (_resourceToggle != null)\n                _resourceToggle.onToggle.RemoveListener(ResourceToggled);\n        }\n\n\n        // note: slider value is in range of [0..1]\n        private void ResourceValueChanged(float newValue)\n        {\n            print(\u0022Resource \u0022 \u002B _host.Resource.resourceName \u002B \u0022 set to \u0022 \u002B _host.Resource.amount);\n            GameEvents.onEditorPartEvent.Fire(ConstructionEventType.PartTweaked, _host.Part);\n        }\n\n\n        private void ResourceToggled()\n        {\n            print(\u0022Resource \u0022 \u002B _host.Resource.resourceName \u002B \u0022 toggled: \u0022 \u002B (_resourceToggle.state ? \u0022ON\u0022 : \u0022OFF\u0022));\n            GameEvents.onEditorPartEvent.Fire(ConstructionEventType.PartTweaked, _host.Part);\n        }\n    }\n\n\n    private IEnumerator Start()\n    {\n        while (UIPartActionController.Instance == null) yield return 0;\n\n        UIPartActionController.Instance.resourceItemEditorPrefab.gameObject\n            .AddOrGetComponent\u0026lt;ResourceTweakListener\u0026gt;();\n\n        Destroy(gameObject);\n    }\n}\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Snark","CreatedById":125662,"CreatedDateTime":"2016-04-19T23:41:08Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222522932\u0022 data-ipsquote-contentid=\u0022137340\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221461094575\u0022 data-ipsquote-userid=\u002275857\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n3 hours ago, xEvilReeperx said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI\u0027d look to editing the resource item prefab and adding a component that fires GameEvents.onEditorPartEvent, or your own event if you want more information. Here\u0027s how it might look in 1.1, 1.0.5 would be similar but with EzGUI instead of uGUI\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThanks!\u00A0 A few questions about the code:\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\nMaybe a stupid question, but what\u0027s the deal with OnDestroy?\u00A0 You\u0027ve included an OnDestroy method in both of your classes there.\u00A0 I assume that you\u0027re talking about \u003Ca href=\u0022http://docs.unity3d.com/ScriptReference/MonoBehaviour.OnDestroy.html\u0022 rel=\u0022external nofollow\u0022\u003Ethis Unity thing\u003C/a\u003E?\u00A0 What\u0027s confusing me is that in both cases, you\u0027ve declared the method as \u003Cstrong\u003Eprivate \u003C/strong\u003E(which means nobody but this class can call it), but then the class itself doesn\u0027t call it.\u00A0 The example that\u0027s given in the abovelinked Unity documentation has an OnDestroy method that\u0027s \u003Cem\u003E\u003Cu\u003Enot\u003C/u\u003E\u003C/em\u003E marked private.\u00A0 Therefore I\u0027m confused, how / from where does this get called?\n\u003C/li\u003E\n\u003Cli\u003E\nObject lifecycle question.\u00A0 Is it always the case that every MonoBehaviour will have Start() called exactly once, and OnDestroy() called exactly once, and therefore I should use those two methods in \u0022bookend\u0022 fashion to register/unregister events?\n\u003C/li\u003E\n\u003Cli\u003E\nUnity \u003Ca href=\u0022http://docs.unity3d.com/ScriptReference/MonoBehaviour.Start.html\u0022 rel=\u0022external nofollow\u0022\u003Edocuments the Start() method\u003C/a\u003E as being void, and shows an example of it with default access; but you have the Start method of InstallResourceTweakListener as private and returning IEnumerator, which confuses me.\u00A0 What\u0027s the story there?\n\u003C/li\u003E\n\u003Cli\u003E\nBroadly speaking, I\u0027m really having trouble getting a toehold on what\u0027s the deal with InstallResourceTweakListener, no doubt because I\u0027m fairly ignorant of Unity stuff (e.g. don\u0027t know what a prefab is or why it\u0027s important or how this code works).\u00A0 I won\u0027t ask you to explain everything because it would probably take many pages to do so and I don\u0027t expect you to teach me Unity. \u003Cimg alt=\u0022:wink:\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 title=\u0022;)\u0022\u003E\u00A0 However, I \u003Cem\u003E\u003Cu\u003Ewould\u003C/u\u003E\u003C/em\u003E like to at least verify that my basic impression of what that code does is correct.\u00A0 Here\u0027s how I interpret this:\n\u003Cul\u003E\u003Cli\u003E\nin an ideal world, PartTweaked events would just work as I expect them to\n\u003C/li\u003E\n\u003Cli\u003E\nhowever, KSP being idiosyncratic, it doesn\u0027t, so there\u0027s a \u0022bug\u0022 where it won\u0027t fire the notification I want\n\u003C/li\u003E\n\u003Cli\u003E\nyou\u0027re going in and doing some sort of Unity brain surgery to correct the way that KSP fires events in general, in effect a bugfix in the editor\n\u003C/li\u003E\n\u003C/ul\u003E\u003C/li\u003E\n\u003C/ul\u003E\u003Cp\u003E\n...is that last item basically the correct impression?\n\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2016-04-20T03:31:33Z","Content":"\n\u003Cp\u003E\nSure, happy to answer\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222523659\u0022 data-ipsquote-contentid=\u0022137340\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221461109268\u0022 data-ipsquote-userid=\u0022125662\u0022 data-ipsquote-username=\u0022Snark\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, Snark said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cul\u003E\u003Cli\u003E\nMaybe a stupid question, but what\u0027s the deal with OnDestroy?\u00A0 You\u0027ve included an OnDestroy method in both of your classes there.\u00A0 I assume that you\u0027re talking about \u003Ca href=\u0022http://docs.unity3d.com/ScriptReference/MonoBehaviour.OnDestroy.html\u0022 rel=\u0022external nofollow\u0022\u003Ethis Unity thing\u003C/a\u003E?\u00A0 What\u0027s confusing me is that in both cases, you\u0027ve declared the method as \u003Cstrong\u003Eprivate \u003C/strong\u003E(which means nobody but this class can call it), but then the class itself doesn\u0027t call it.\u00A0 The example that\u0027s given in the abovelinked Unity documentation has an OnDestroy method that\u0027s \u003Cem\u003E\u003Cu\u003Enot\u003C/u\u003E\u003C/em\u003E marked private.\u00A0 Therefore I\u0027m confused, how / from where does this get called?\n\u003C/li\u003E\n\u003C/ul\u003E\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nUnity will call those magic name methods if they exist on MonoBehaviour-derived objects, regardless of their access level. The example actually shows a private OnDestroy (the default access modifier for a struct/class member is private, if not specified)\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222523659\u0022 data-ipsquote-contentid=\u0022137340\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221461109268\u0022 data-ipsquote-userid=\u0022125662\u0022 data-ipsquote-username=\u0022Snark\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, Snark said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nObject lifecycle question.\u00A0 Is it always the case that every MonoBehaviour will have Start() called exactly once, and OnDestroy() called exactly once, and therefore I should use those two methods in \u0022bookend\u0022 fashion to register/unregister events?\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nYes. There are some specifics to be aware of (see Unity docs).\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222523659\u0022 data-ipsquote-contentid=\u0022137340\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221461109268\u0022 data-ipsquote-userid=\u0022125662\u0022 data-ipsquote-username=\u0022Snark\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, Snark said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nUnity \u003Ca href=\u0022http://docs.unity3d.com/ScriptReference/MonoBehaviour.Start.html\u0022 rel=\u0022external nofollow\u0022\u003Edocuments the Start() method\u003C/a\u003E as being void, and shows an example of it with default access; but you have the Start method of InstallResourceTweakListener as private and returning IEnumerator, which confuses me.\u00A0 What\u0027s the story there?\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nSome of the magic methods can be coroutines (Start is the only one I\u0027ve ever used personally) which Unity will automatically start for you if they have the correct return type. I could have sworn that was in the unity documentation at one point \u003Cimg alt=\u0022:huh:\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_undecided.gif\u0022 title=\u0022:huh:\u0022\u003E but I can\u0027t find it now. Moving the code from Start into a new IEnumerator MyMethod() and having Start call StartCoroutine(MyMethod()) would be equivalent. It might not even be necessary in this case, if UIPartActionController.Instance always exists by the time KSPAddons are created. I didn\u0027t check\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222523659\u0022 data-ipsquote-contentid=\u0022137340\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221461109268\u0022 data-ipsquote-userid=\u0022125662\u0022 data-ipsquote-username=\u0022Snark\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n3 hours ago, Snark said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cul\u003E\u003Cli\u003E\nin an ideal world, PartTweaked events would just work as I expect them to\n\u003C/li\u003E\n\u003Cli\u003E\nhowever, KSP being idiosyncratic, it doesn\u0027t, so there\u0027s a \u0022bug\u0022 where it won\u0027t fire the notification I want\n\u003C/li\u003E\n\u003Cli\u003E\nyou\u0027re going in and doing some sort of Unity brain surgery to correct the way that KSP fires events in general, in effect a bugfix in the editor\n\u003C/li\u003E\n\u003C/ul\u003E\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI suppose you could call it a bugfix. I wouldn\u0027t say it\u0027s brain surgery though. In a nutshell, the code takes advantage of the way \u003Ca href=\u0022http://docs.unity3d.com/ScriptReference/Object.Instantiate.html\u0022 rel=\u0022external nofollow\u0022\u003EInstantiate \u003C/a\u003Eworks by inserting a script into the resource slider prefab. Whenever that prefab gets cloned, the custom script gets cloned too.\n\u003C/p\u003E\n"}]}