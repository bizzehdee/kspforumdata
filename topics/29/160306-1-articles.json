{"TopicId":160306,"ForumId":29,"TopicTitle":"ScenarioModule help needed (solved)","CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2017-05-07T12:47:36Z","PageNum":1,"Articles":[{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2017-05-07T12:47:36Z","Content":"\n\u003Cp\u003E\nMy (flawed) understanding of the ScenarioModule was that OnLoad and OnSave was where the data to be saved/loaded could be set. \u00A0But, in my recent testing, it doesn\u0027t work.\n\u003C/p\u003E\n\u003Cp\u003E\nOnSave gets called, but no data gets saved unless it\u0027s a KSPField(isPersistant = true)\n\u003C/p\u003E\n\u003Cp\u003E\nAs a test, I manually added the missing fields to the scenario module in the persistent file after exiting a game and THAT worked. \u00A0So, it appears that the OnLoad works, but the OnSave, while it is being called, is not saving the data, is it possible that it\u0027s being called too late?\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nSee the following module for an example of what doesn\u0027t work.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E    [KSPScenario(ScenarioCreationOptions.AddToNewCareerGames | ScenarioCreationOptions.AddToExistingCareerGames, GameScenes.SPACECENTER)]\n    public class KSPCasherData : ScenarioModule\n    {\n        public override void OnSave(ConfigNode node)\n        {\n            Debug.Log(\u0022KSPCasherData.OnSave\u0022);\n\n            ConfigNode n = new ConfigNode(\u0022KSPCasher\u0022);\n            n.SetValue(\u0022LastBudget\u0022, KSPCasher.instance.LastBudget);\n            n.SetValue(\u0022Multiplier\u0022, KSPCasher.BudgetMultiplier.ToString());\n            n.SetValue(\u0022SciBuy\u0022, KSPCasher.ScienceBuyMultiplier.ToString());\n            n.SetValue(\u0022SciSell\u0022, KSPCasher.ScienceSellMultiplier.ToString());\n            node.AddNode(n);\n            base.OnSave(node);\n        }\n\n//\n// The following did work after manually putting data into the persistent.sfs file\n//\n        public override void OnLoad(ConfigNode node)\n        {\n            Debug.Log(\u0022KSPCasherData.OnLoad\u0022);\n            base.OnLoad(node);\n\n            var n = node.GetNode(\u0022KSPCasher\u0022);\n\n            if (n != null)\n            {\n                string param = n.GetValue(\u0022LastBudget\u0022);\n                if (param != null)\n                    KSPCasher.instance.LastBudget = param;\n\n                param = n.GetValue(\u0022Multiplier\u0022);\n                if (param != null)\n                    KSPCasher.BudgetMultiplier = double.Parse(param);\n\n                param = n.GetValue(\u0022SciBuy\u0022);\n                if (param != null)\n                    KSPCasher.ScienceBuyMultiplier = double.Parse(param);\n\n                param = n.GetValue(\u0022SciSell\u0022);\n                if (param != null)\n                    KSPCasher.ScienceSellMultiplier = double.Parse(param);\n            }\n        }\n    }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cstrong\u003EEdit: \u00A0The problem was that SetValue was being used instead of AddValue\u003C/strong\u003E\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222017-05-07T14:38:00Z\u0022 title=\u002205/07/2017 02:38  PM\u0022 data-short=\u00227 yr\u0022\u003EMay 7, 2017\u003C/time\u003E by linuxgurugamer\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2017-05-07T13:08:47Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223047937\u0022 data-ipsquote-contentid=\u0022160306\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221494161256\u0022 data-ipsquote-userid=\u0022129964\u0022 data-ipsquote-username=\u0022linuxgurugamer\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n17 minutes ago, linuxgurugamer said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nMy (flawed) understanding of the ScenarioModule was that OnLoad and OnSave was where the data to be saved/loaded could be set. \u00A0But, in my recent testing, it doesn\u0027t work.\n\u003C/p\u003E\n\u003Cp\u003E\nOnSave gets called, but no data gets saved unless it\u0027s a KSPField(isPersistant = true)\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nTry and take a look at\u00A0\n\u003C/p\u003E\n\u003Ciframe data-embedcontent=\u0022\u0022 frameborder=\u00220\u0022 src=\u0022https://forum.kerbalspaceprogram.com/index.php?/topic/128204-122-kerbal-research-development/\u0026amp;do=embed\u0022\u003E\u003C/iframe\u003E\n\u003Cp\u003E\n-\u003Cabbr title=\u0022Module Manager (mod)\u0022\u003EMM\u003C/abbr\u003E- uses scenario module for persisting global data. I think that will get you going.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/mmoench/KRnD/blob/master/Source/KRnD.cs#L1159-L1235\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/mmoench/KRnD/blob/master/Source/KRnD.cs#L1159-L1235\u003C/a\u003E\n\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2017-05-07T13:34:35Z","Content":"\n\u003Cp\u003E\nSo I looked, and the only difference I could see was that you weren\u0027t calling the \u0022base.OnSave\u0022\n\u003C/p\u003E\n\u003Cp\u003E\nAaarrrgggghhhh!!!!!\n\u003C/p\u003E\n\u003Cp\u003E\nThe code had \u0022SetValue\u0022 instead of \u0022AddValue\u0022\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2017-05-07T13:54:19Z","Content":"\n\u003Cp\u003E\nhmmm... setvalue only work when the value is already present, right? So addvalue would probably be the way to go.\u00A0\u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2017-05-07T14:35:04Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223047983\u0022 data-ipsquote-contentid=\u0022160306\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221494165259\u0022 data-ipsquote-userid=\u0022145377\u0022 data-ipsquote-username=\u0022Warezcrawler\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n40 minutes ago, Warezcrawler said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nhmmm... setvalue only work when the value is already present, right? So addvalue would probably be the way to go.\u00A0\u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nYes. \u00A0I\u0027m guessing that it used to work both ways, when the mod was originally written, it worked well. \u00A0But with updates, it was broken.\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2017-05-07T17:23:50Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223048027\u0022 data-ipsquote-contentid=\u0022160306\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221494167704\u0022 data-ipsquote-userid=\u0022129964\u0022 data-ipsquote-username=\u0022linuxgurugamer\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n2 hours ago, linuxgurugamer said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nYes. \u00A0I\u0027m guessing that it used to work both ways, when the mod was originally written, it worked well. \u00A0But with updates, it was broken.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nWell, based on a peek at the definition of SetValue, I guess you might have had a true as the last argument (createIfNotFound), or it was defaulted to true previously.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003Epublic bool SetValue(string name, string newValue, bool createIfNotFound = false);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"}]}