{"TopicId":78714,"ForumId":29,"TopicTitle":"Nonsensical InvalidCastException","CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-20T22:47:09Z","PageNum":1,"Articles":[{"CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-20T22:47:09Z","Content":"\n\u003Cp\u003EI\u0027m trying to update the SmartParts Auto Stager so the user can select the resource they wish to monitor, using a KSPAPIExpansion textfield. Unfortunately, as is usually the case with my attempts to code for KSP, I\u0027m running into an issue.\u003C/p\u003E\u003Cp\u003EI have the auto stager check it\u0027s parent part \u0022OnEditorAttach\u0022. Unfortunately, this causes all kinds of weird problems, the most common of which is a \u0022InvalidCastException: Cannot cast from source type to destination type.\u0022, which I find amusing, since I\u0027m not casting from anything. If I use \u0022Invoke\u0022 to delay it .25 seconds from editor attach, it does seem to work, sort of, at least until I pick up the parent part at which point everything goes sideways again and I get yet another \u0022InvalidCastException\u0022. It\u0027s as if KSP doesn\u0027t know the parent part of the Smart Stager until some arbitrary time AFTER it\u0027s attached to a tank. How the devil can I work with that?\u003C/p\u003E\u003Cp\u003ESo, does anyone have any idea what is causing this? Or, more importantly, what options I have to detect the parent\u0027s resources when the Smart Stager is attached? I\u0027ve tried simply detecting the parent part and passing that to a Part variably, but quite naturally that failed too.\u003C/p\u003E\u003Cp\u003EAny help at all would be appreciated. These modifications, if I can get them working, would make this thing much more friendly for users of RealFuels, which is what I\u0027m after.\u003C/p\u003E\u003Cp\u003ELog messages showing debug code\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E[LOG 18:25:04.169] KM Stager Started\u003Cbr\u003E[LOG 18:25:05.316] km.smart.fuel(Clone) added to ship - part count: 2\u003Cbr\u003E[LOG 18:25:05.317] KM Stager: Monitoring parent tank\u003Cbr\u003E[LOG 18:25:05.317] DEBUG:check this part parent resources\u003Cbr\u003E[LOG 18:25:05.318] DEBUG:succeed PartResourceList\u003Cbr\u003E[LOG 18:25:05.318] stage count is: 0\u003Cbr\u003E[EXC 18:25:05.319] InvalidCastException: Cannot cast from source type to destination type.\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003ECode relating (I think) to the problem\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E      [KSPField(isPersistant = true)]\u003Cbr\u003E      public PartResourceList partRes = null;\u003Cbr\u003E\u003Cbr\u003E      public override void OnStart(StartState state) {\u003Cbr\u003E            if (state == StartState.Editor) {\u003Cbr\u003E                this.part.OnEditorAttach \u002B= OnEditorAttach;\u003Cbr\u003E                this.part.OnEditorDetach \u002B= OnEditorDetach;\u003Cbr\u003E                this.part.OnEditorDestroy \u002B= OnEditorDestroy;\u003Cbr\u003E            }\u003Cbr\u003E            print(\u0022KM Stager Started\u0022);\u003Cbr\u003E      }\u003Cbr\u003E\u003Cbr\u003E      private void findResources() {\u003Cbr\u003E            if (this.part.Resources.Count \u0026gt; 0) {\u003Cbr\u003E                print(\u0022KM Stager: Monitoring smart tank\u0022);\u003Cbr\u003E                print(\u0022DEBUG:check this part resources\u0022);\u003Cbr\u003E                partRes = this.part.Resources;\u003Cbr\u003E                print(\u0022DEBUG:succeed \u0022 \u002B partRes.ToString());\u003Cbr\u003E                smartTank = true;\u003Cbr\u003E            }\u003Cbr\u003E            else if (this.part.parent.Resources.Count \u0026gt; 0) {\u003Cbr\u003E                print(\u0022KM Stager: Monitoring parent tank\u0022);\u003Cbr\u003E                print(\u0022DEBUG:check this part parent resources\u0022);\u003Cbr\u003E                partRes = this.part.parent.Resources;\u003Cbr\u003E                print(\u0022DEBUG:succeed \u0022 \u002B partRes.ToString());\u003Cbr\u003E                smartTank = false;\u003Cbr\u003E            }\u003Cbr\u003E            else {\u003Cbr\u003E                print(\u0022DEBUG:no matches. Setting null\u0022);\u003Cbr\u003E                partRes = null;\u003Cbr\u003E            }\u003Cbr\u003E            //updateList();\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        private void OnEditorAttach() {\u003Cbr\u003E            RenderingManager.AddToPostDrawQueue(99, updateEditor);\u003Cbr\u003E            findResources();\u003Cbr\u003E        }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-07-21T00:51:00Z\u0022 title=\u002207/21/2014 12:51  AM\u0022 data-short=\u00229 yr\u0022\u003EJuly 21, 2014\u003C/time\u003E by Firov\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"blizzy78","CreatedById":68543,"CreatedDateTime":"2014-07-20T23:23:54Z","Content":"\n\u003Cp\u003EDid you have a look into your output_log.txt? While it\u0027s not logging the actual line where the exception occurred, it\u0027s logging the method where it did, so that should help you out a bit.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-07-20T23:32:28Z","Content":"\n\u003Cp\u003ENevermind.\u003C/p\u003E\u003Cp\u003EThere is a \u0022Stage Count is 0\u0022 in there, that is a line printed by base KSP. That means my theory is no good.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-20T23:44:44Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022blizzy78\u0022 data-cite=\u0022blizzy78\u0022\u003E\u003Cdiv\u003EDid you have a look into your output_log.txt? While it\u0027s not logging the actual line where the exception occurred, it\u0027s logging the method where it did, so that should help you out a bit.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI just checked the output log. If I\u0027m reading this right, it looks like the exception isn\u0027t being caused directly by the SmartParts.dll.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E(Filename: C:/BuildAgent/work/d63dfc6385190b60/artifacts/StandalonePlayerGenerated/UnityEngineDebug.cpp Line: 49)\u003Cbr\u003E\u003Cbr\u003EInvalidCastException: Cannot cast from source type to destination type.\u003Cbr\u003E  at BaseField.GetStringValue (System.Object host, Boolean gui) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E  at BaseFieldList.Save (.ConfigNode node) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E  at PartModule.Save (.ConfigNode node) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E  at ShipConstruct.SaveShip () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E  at ShipConstruction.CreateBackup (.ShipConstruct ship) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E  at EditorLogic.SetBackup () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E  at EditorLogic.UpdatePartMode () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003Cbr\u003E  at EditorLogic.Update () [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"blizzy78","CreatedById":68543,"CreatedDateTime":"2014-07-20T23:59:18Z","Content":"\n\u003Cp\u003EI\u0027m really getting into guessing-type terrain here, because I\u0027m not at all familiar with it, but could this be the culprit?\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E[KSPField(isPersistant = true)]\u003Cbr\u003Eprivate PartResourceList partRes = null;\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EMeaning that you\u0027re trying to save a PartResourceList into the vessel?\u003C/p\u003E\u003Cp\u003EAgain, I haven\u0027t used [KSPField] at all so far, so please disregard if I\u0027m talking nonsense here.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-07-21T00:31:15Z","Content":"\n\u003Cp\u003EAlso, note that KSPFields have to be public.\u003C/p\u003E\u003Cp\u003EWhich makes sense, KSPFields populate the partModule.fields list, so the KSPField is private and you try to reference it from outside the partmodule you\u0027ll get a null reference error.\u003C/p\u003E\u003Cp\u003EI think this explains blizzy\u0027s error as it is in a BaseField.\u003C/p\u003E\u003Cp\u003EMight also have to do with type, KSPFields are limited in the type of object they can be.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"blizzy78","CreatedById":68543,"CreatedDateTime":"2014-07-21T00:34:50Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Diazo\u0022 data-cite=\u0022Diazo\u0022\u003E\u003Cdiv\u003EMight also have to do with type, KSPFields are limited in the type of object they can be.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThat\u0027s what I was trying to get at, sorry for not being more specific.\u003C/p\u003E\n"},{"CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-21T00:56:34Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022blizzy78\u0022 data-cite=\u0022blizzy78\u0022\u003E\u003Cdiv\u003EThat\u0027s what I was trying to get at, sorry for not being more specific.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHmm. Thanks for the suggestion. It makes sense.\u003C/p\u003E\u003Cp\u003EUnfortunately, that\u0027s not the solution. Even after changing the field to public it still throws that same exception. Also, I don\u0027t get that exception if I attach the Smart Stager to something that doesn\u0027t have resources, so it doesn\u0027t appear to be an issue with \u0022partRes\u0022 itself being Null. It\u0027s something else.\u003C/p\u003E\u003Cp\u003EWhat\u0027s more unusual is that if I invoke \u0022findResources()\u0022 after a delay of, say, .25 seconds it will allow me to place it initially without an exception being thrown. Though that\u0027s not an acceptable long term solution since it throws that exception again if I try to move a subassembly that the Stager is attached to. \u003C/p\u003E\u003Cp\u003EI\u0027m convinced that this is a problem with timing, but I\u0027m not sure how, and I\u0027m especially not sure how to fix it... \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_sad.gif\u0022 alt=\u0022:(\u0022\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-07-21T03:19:13Z\u0022 title=\u002207/21/2014 03:19  AM\u0022 data-short=\u00229 yr\u0022\u003EJuly 21, 2014\u003C/time\u003E by Firov\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"blizzy78","CreatedById":68543,"CreatedDateTime":"2014-07-21T08:48:07Z","Content":"\n\u003Cp\u003EI think you misunderstood both Diazo and me, so I\u0027ll be clear here: We think that KSPField does not accept every \u003Cstrong\u003Etype\u003C/strong\u003E you can think of, but only primitive types like bool, string, and such. At least that\u0027s what I have been thinking \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EEdit: Also, I believe it works when it\u0027s null, because null can be cast into any type.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-07-21T09:02:53Z\u0022 title=\u002207/21/2014 09:02  AM\u0022 data-short=\u00229 yr\u0022\u003EJuly 21, 2014\u003C/time\u003E by blizzy78\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-21T13:36:09Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022blizzy78\u0022 data-cite=\u0022blizzy78\u0022\u003E\u003Cdiv\u003EI think you misunderstood both Diazo and me, so I\u0027ll be clear here: We think that KSPField does not accept every \u003Cstrong\u003Etype\u003C/strong\u003E you can think of, but only primitive types like bool, string, and such. At least that\u0027s what I have been thinking \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003Cp\u003EEdit: Also, I believe it works when it\u0027s null, because null can be cast into any type.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHmm. Now I see, and that does make sense. When I get back from the office I\u0027ll check that and report back. Thanks for the help so far, Diazo and Blizzy.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-07-21T14:19:08Z","Content":"\n\u003Cp\u003EWhich reminds me we have that list. From the dev\u0027s release notes when they implemented KSPField:\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Dev\u0022 data-cite=\u0022Dev\u0022\u003E\u003Cdiv\u003EThe limitation for adding the KSPField attribute is that it can only be applied to classes which implement the IConfigNode interface (more on this later) or one of the types; string, bool, int, float, Vector2, Vector3, Vector4 or Quaternion\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ENote that double is \u003Cem\u003Enot\u003C/em\u003E on the list, that has caused plenty of headaches before.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n"},{"CreatedByName":"Agathorn","CreatedById":99662,"CreatedDateTime":"2014-07-21T16:12:48Z","Content":"\n\u003Cp\u003EAnd even stuff that does implement IConfigNode is iffy. I\u0027ve been fighting with the ConfigNode stuff all weekend and still scratching my head half the time. There seems to be some unwritten rules on what works and doesn\u0027t work, and annoyingly the original sample given by the devs when this stuff was released doesn\u0027t even work.\u003C/p\u003E\u003Cp\u003EIn your case specifically the error is happening because its trying to cast values to a different type for persistence and can\u0027t.\u003C/p\u003E\n"},{"CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-21T22:14:30Z","Content":"\n\u003Cp\u003EYes. This \u003Cstrong\u003Ewas\u003C/strong\u003E the issue. It works perfectly now. Thanks for the input and help everyone. I appreciate it!\u003C/p\u003E\n"},{"CreatedByName":"blizzy78","CreatedById":68543,"CreatedDateTime":"2014-07-21T22:15:26Z","Content":"\n\u003Cp\u003ESweet. Now on to some real programming instead of bug chasing \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-21T22:21:53Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022blizzy78\u0022 data-cite=\u0022blizzy78\u0022\u003E\u003Cdiv\u003ESweet. Now on to some real programming instead of bug chasing \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EHeh. Hopefully. At least for the next few minutes until I get mired in another endless bug hunt. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/p\u003E\u003Cp\u003EAnyway, thanks again guys. You\u0027ve spared my sanity once again.\u003C/p\u003E\n"},{"CreatedByName":"Agathorn","CreatedById":99662,"CreatedDateTime":"2014-07-21T22:32:05Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Firov\u0022 data-cite=\u0022Firov\u0022\u003E\u003Cdiv\u003EYes. This \u003Cstrong\u003Ewas\u003C/strong\u003E the issue. It works perfectly now. Thanks for the input and help everyone. I appreciate it!\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ECare to share how you got it working? I\u0027m still fighting with properly loading and persisting ConfigNodes.\u003C/p\u003E\n"},{"CreatedByName":"Firov","CreatedById":57445,"CreatedDateTime":"2014-07-22T16:17:23Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Agathorn\u0022 data-cite=\u0022Agathorn\u0022\u003E\u003Cdiv\u003ECare to share how you got it working? I\u0027m still fighting with properly loading and persisting ConfigNodes.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EAgathorn, I just made the resource list not persistent, and not a field, which allows me to attach it without throwing an exception. I\u0027m now reconfiguring it so it rechecks the resources every time it loads/changes scenes, rather than relying on persistence. Not as convenient, but I don\u0027t see another option.\u003C/p\u003E\n"}]}