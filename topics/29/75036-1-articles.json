{"TopicId":75036,"ForumId":29,"TopicTitle":"Project Ground Anchor AKA: Please help me I don\u0026#039;t know what I\u0026#039;m doing...","CreatedByName":"the_bT","CreatedById":3876,"CreatedDateTime":"2014-06-14T14:47:39Z","PageNum":1,"Articles":[{"CreatedByName":"the_bT","CreatedById":3876,"CreatedDateTime":"2014-06-14T14:47:39Z","Content":"\n\u003Cp\u003EI\u0027m trying to do my first plugin, it kinda works like I want it but not quite.\u003C/p\u003E\u003Cp\u003EI\u0027d like to make a module that when triggered in some way anchors the part its on to it\u0027s current position. But only if the part is close (1-2m max) to the ground and the vessel doesn\u0027t move. \u003C/p\u003E\u003Cp\u003ESo far I managed to set up Mono, and make a dll with a module and add that to a part. \u003C/p\u003E\u003Cp\u003EThis is my code:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Eusing System;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Epublic class GroundAnchor : PartModule\u003Cbr\u003E{\u003Cbr\u003E\u003Cbr\u003E\t/*\u003Cbr\u003E\t * This event is active when controlling the vessel with the part.\u003Cbr\u003E\t */\u003Cbr\u003E\t[KSPEvent(guiActive = true, guiName = \u0022Activate\u0022)]\u003Cbr\u003E\tpublic void ActivateEvent ()\u003Cbr\u003E\t{\u003Cbr\u003E\t\tScreenMessages.PostScreenMessage (\u0022Anchored\u0022, 5.0f, ScreenMessageStyle.UPPER_CENTER);\u003Cbr\u003E\u003Cbr\u003E\t\tFixedJoint fj = this.part.gameObject.AddComponent\u0026lt;FixedJoint\u0026gt;();\u003Cbr\u003E\t\tfj.breakForce = Mathf.Infinity;\u003Cbr\u003E\t\tfj.breakTorque = Mathf.Infinity;\u003Cbr\u003E\u003Cbr\u003E\t\t// This will hide the Activate event.\u003Cbr\u003E\t\tEvents [\u0022ActivateEvent\u0022].active = false;\u003Cbr\u003E\t}\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EAs you see, I\u0027m not doing much at the moment. I\u0027ve got the activate by right click stuff from the \u003Ca href=\u0022https://github.com/taraniselsu/TacExamples\u0022 rel=\u0022external nofollow\u0022\u003ETAC Examples\u003C/a\u003E which works as advertised. I removed much of it because I need my module to work only once. I create a fixed joint on my part and set it to be unbreakable, I do not set a part to be joined to so it will join me to the world instead.\u003C/p\u003E\u003Cp\u003EI still need to implement the close enough to ground and speed checks though, and I don\u0027t know how I would go about that. But the bigger problem for the moment is that my anchor stops anchoring on quickload. I assume it will do that whenever the vessel is loaded. \u003C/p\u003E\u003Cp\u003EI figure I need to save the joint somehow (I assume adding a member variable to my class will do?) and reapply it on vessel load. How do I do that?\u003C/p\u003E\n"},{"CreatedByName":"malkuth","CreatedById":57414,"CreatedDateTime":"2014-06-14T19:59:49Z","Content":"\n\u003Cp\u003EYou need to take advantage of OnStart and OnFixedUpdate.\u003C/p\u003E\u003Cp\u003EAnd also use KSPField to make things Persistent.\u003C/p\u003E\u003Cp\u003Eright now you have everthing to activate when player pushes the button, so when the player changes screens or loads something else and goes back, you function is wiped and never restarted.\u003C/p\u003E\u003Cp\u003EBetter way would be to have the Button to active a KspField (like a bool)\u003C/p\u003E\u003Cp\u003EExample \u003C/p\u003E\u003Cp\u003E[KSPField(isPersistant = true)]\u003C/p\u003E\u003Cp\u003Eprivate bool activateAnchor = false;\u003C/p\u003E\u003Cp\u003EThen use OnStart()\u003C/p\u003E\u003Cp\u003Eif (activateAnchor != false)\u003C/p\u003E\u003Cp\u003E{\u003C/p\u003E\u003Cp\u003EActivateEvent();\u003C/p\u003E\u003Cp\u003E}\u003C/p\u003E\u003Cp\u003Ethen onFixedUpdate()\u003C/p\u003E\u003Cp\u003E{\u003C/p\u003E\u003Cp\u003Eif (activateAnchor != false)\u003C/p\u003E\u003Cp\u003EactivateEvent()\u003C/p\u003E\u003Cp\u003E}\u003C/p\u003E\u003Cp\u003EWhat this does is KSPField keeps ActivateAnchor persistant at all times.(Saves it under the part in player save file)\u003C/p\u003E\u003Cp\u003EOnStart keeps you Fuction alive if the player leaves vessel or comes back and part activate again (only ever checks once)\u003C/p\u003E\u003Cp\u003EonFixedUpdate is the initial start of your function when player starts it from a cold state. (checks each FXframe)\u003C/p\u003E\u003Cp\u003EThen you have your function an actual separate value in code and not part of KSPEvent instead have your bool activated by push GUI Button.\u003C/p\u003E\u003Cp\u003EIt might be argued that you don\u0027t need the Onstart() part, because KSPField and OnFixedUpdate should be all you need, but since what you seem to be writing is a lockdown code, I would argue you want to make sure it always work no matter what the player does. Leaves game, switches around to other vessels. You can try it without and test it for yourself.. Since OnStart() only does check once its not to much of a big deal for such small code.\u003C/p\u003E\u003Cp\u003Eyou also want to shut off your code, when the player is done using it. All you need is another button to Turn it off and set bool false.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-06-14T20:12:28Z\u0022 title=\u002206/14/2014 08:12  PM\u0022 data-short=\u002210 yr\u0022\u003EJune 14, 2014\u003C/time\u003E by malkuth\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"the_bT","CreatedById":3876,"CreatedDateTime":"2014-06-14T20:35:15Z","Content":"\n\u003Cp\u003EThis is very enlightening, thank you.\u003C/p\u003E\u003Cp\u003EI will try to implement this as you suggested.\u003C/p\u003E\u003Cp\u003EI still need to check the height above ground, any advice on that?\u003C/p\u003E\n"},{"CreatedByName":"malkuth","CreatedById":57414,"CreatedDateTime":"2014-06-14T20:55:07Z","Content":"\n\u003Cp\u003Ebest bet is to forget about the distance to ground.. You can do it but its a little more complicated (not much) and your going to have to do a little math.\u003C/p\u003E\u003Cp\u003Ewhat you want is maybe just to make sure the vessel is landed so you can use that. (its already made for you) This is a value in vessel.situations that can give you status of ship, one of them is landed. So vessel.situations.landed will tell you when your vessel is landed on dry ground.\u003C/p\u003E\u003Cp\u003Eso look something like this, you can modify it to work with what ever you want. You want to intiate vessel. so.\u003C/p\u003E\u003Cp\u003EVessel vs = new Vessel(); or parameter CodeName(Vessel v)\u003C/p\u003E\u003Cp\u003EThen the code as check\u003C/p\u003E\u003Cp\u003Eif (vs.situation.Equals(vs.situations.landed)\u003C/p\u003E\u003Cp\u003E{\u003C/p\u003E\u003Cp\u003E Place code.\u003C/p\u003E\u003Cp\u003E}\u003C/p\u003E\u003Cp\u003Ethis does not need to be persistent because you only need to check once, when player pushes GU Button. You might want to have an Else that gives a message that vessel is not landed (in case its not).\u003C/p\u003E\u003Cp\u003EOtherwise if you want to use the height above ground you will have to do calculations, and I know of 2 Mods that do this. MechJeb and Kerbal engineer. But they most likely use.\u003C/p\u003E\u003Cp\u003EVessel.heightFromTerrain which gives you height above terrain, Vessel.altitude give you height above sealevel.\u003C/p\u003E\u003Cp\u003Ethen you can do your maths for 2 meters part. Also if you want height with Part, and not the vessel you will have to do a little more work to make that happen too, right now the above will only apply to the actual vessel, and no an individual part.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-06-14T21:06:31Z\u0022 title=\u002206/14/2014 09:06  PM\u0022 data-short=\u002210 yr\u0022\u003EJune 14, 2014\u003C/time\u003E by malkuth\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"the_bT","CreatedById":3876,"CreatedDateTime":"2014-06-15T14:08:50Z","Content":"\n\u003Cp\u003EThanks again, I was messing around and found the part.checkLanded() method. It seems to return true when a part itself touches the ground.\u003C/p\u003E\u003Cp\u003EIt\u0027s close enough for what I want. I use it on each frame to enable or disable the GUI event. It seems to work good enough, there might be some cases where this fails, will test that later, a second check in ActivateEvent() should not be the big problem. Might even be better that way because I can better communicate to the user like that...\u003C/p\u003E\u003Cp\u003EAs for the originally planned height above terrain, I really only wanted to test for really close distance to ground, so I was thinking about casting a ray and see if I hit ground or something. However I discovered a problem with the whole approach, if I anchor myself to nothing like this and no part of my vessel is touching the ground, the vessel will be set to flying state, it will therefore be deleted when you switch scenes or drive away from it. So It might be best to drop the whole Idea \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 alt=\u0022:P\u0022\u003E\u003C/p\u003E\u003Cp\u003EThis is my current code:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eusing System;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Epublic class GroundAnchor : PartModule\u003Cbr\u003E{\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\t[KSPField(isPersistant = true)]\u003Cbr\u003E\tprivate bool anchorActive = false;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\tpublic override void OnStart(StartState state)\u003Cbr\u003E\t{\u003Cbr\u003E\t\tif ( anchorActive ) {\u003Cbr\u003E\t\t\tattachToGround();\u003Cbr\u003E\t\t}\u003Cbr\u003E\t}\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\tpublic override void OnUpdate()\u003Cbr\u003E\t{\u003Cbr\u003E\u003Cbr\u003E\t\tif ( this.part.checkLanded() \u0026amp;\u0026amp; !anchorActive) {\u003Cbr\u003E\t\t\tEvents [\u0022ActivateEvent\u0022].active = true;\u003Cbr\u003E\t\t} else {\u003Cbr\u003E\t\t\tEvents [\u0022ActivateEvent\u0022].active = false;\u003Cbr\u003E\t\t}\u003Cbr\u003E\t}\u003Cbr\u003E\u003Cbr\u003E\t/*\u003Cbr\u003E\t * This event is active when controlling the vessel with the part.\u003Cbr\u003E\t */\u003Cbr\u003E\t[KSPEvent(guiActive = true, guiName = \u0022Activate\u0022)]\u003Cbr\u003E\tpublic void ActivateEvent ()\u003Cbr\u003E\t{\u003Cbr\u003E\t\tScreenMessages.PostScreenMessage (\u0022Anchor fired\u0022, 5.0f, ScreenMessageStyle.UPPER_CENTER);\u003Cbr\u003E\u003Cbr\u003E\t\tattachToGround();\u003Cbr\u003E\t\tanchorActive = true;\u003Cbr\u003E\u003Cbr\u003E\t\tEvents [\u0022ActivateEvent\u0022].active = false;\u003Cbr\u003E\t}\u003Cbr\u003E\u003Cbr\u003E\tprivate void attachToGround ()\u003Cbr\u003E\t{\u003Cbr\u003E\u003Cbr\u003E\t\tFixedJoint fj = this.part.gameObject.AddComponent\u0026lt;FixedJoint\u0026gt;();\u003Cbr\u003E\t\tfj.breakForce = Mathf.Infinity;\u003Cbr\u003E\t\tfj.breakTorque = Mathf.Infinity;\u003Cbr\u003E\t}\u003Cbr\u003E\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EI think it\u0027s pretty ok, but please point out problems if you see any.\u003C/p\u003E\u003Cp\u003EThanks.\u003C/p\u003E\n"}]}