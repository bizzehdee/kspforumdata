{"TopicId":158482,"ForumId":29,"TopicTitle":"[Answered] Strange problem with onVesselSwitching","CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2017-03-31T17:19:32Z","PageNum":1,"Articles":[{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2017-03-31T17:19:32Z","Content":"\n\u003Cp\u003E\nI\u0027m having a very strange problem with onVesselSwitching event.\n\u003C/p\u003E\n\u003Cp\u003E\nSo, to start, here is a class I use for logging:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003Enamespace EvaFuel\n{\n    public static class Log\n    {\n        public enum LEVEL\n        {\n            OFF = 0,\n            ERROR = 1,\n            WARNING = 2,\n            INFO = 3,\n            DETAIL = 4,\n            TRACE = 5\n        };\n        static string PREFIX = \u0022EVAFuel: \u0022;\n\n        [ConditionalAttribute(\u0022DEBUG\u0022)]\n        public static void Info(String msg)\n        {\n            if (IsLogable(LEVEL.INFO))\n            {\n                UnityEngine.Debug.Log(PREFIX \u002B msg);\n            }\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nThis is the beginning of the class with the problems:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E    [KSPAddon(KSPAddon.Startup.SpaceCentre, true)]\n    public class EvaFuelManager : MonoBehaviour\n    {\n        private void Start()\n        {\n            Log.Info(\u0022Start\u0022);\n            DontDestroyOnLoad(this);\n        }\n        public void Awake()\n        {\n            Log.Info(\u0022Awake\u0022);\n           \n            GameEvents.onVesselSwitching.Add(this.onVesselSwitching);\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nAnd here is where I\u0027m having problems:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E      void mylog(string s)\n        {\n            // Set a variable to the My Documents path.\n            string mydocpath = @\u0022R:\\tmplog.txt\u0022;\n\n\n            System.IO.StreamWriter sw = System.IO.File.AppendText(mydocpath);\n            try\n            {\n                string logLine = System.String.Format(\n                    \u0022{0:G}: {1}.\u0022, System.DateTime.Now, s);\n                sw.WriteLine(logLine);\n            }\n            finally\n            {\n                sw.Close();\n            }\n        }\n\npublic string resourceName {  get { return HighLogic.CurrentGame.Parameters.CustomParams\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;EVAFuelSettings\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E().EvaPropellantName; } }\n  \n        private void onVesselSwitching(Vessel from, Vessel to)\n        {\n            mylog(\u0022onVesselSwitching\u0022);\n            Log.Info(\u0022onVesselSwitching\u0022);\n\n            if (to == null || from == null)\n            {\n                Log.Info(\u0022to or from are null\u0022);\n                return;\n            }\n            mylog(\u0022onVesselSwitching 1\u0022);\n            Log.Info(\u0022onVesselSwitching 1\u0022);\n            if (lastPart == null)\n                return;\n            mylog(\u0022lastPart not null: \u0022 \u002B lastPart.partInfo.title);\n            Log.Info(\u0022lastPart not null: \u0022 \u002B lastPart.partInfo.title);\n\n            mylog(\u0022onVesselSwitching 2\u0022);\n            Log.Info(\u0022onVesselSwitching 2\u0022);\n            mylog(\u0022onVesselSwitching: from: \u0022 \u002B from.Parts.First().partInfo.title \u002B \u0022   to: \u0022 \u002B to.Parts.First().partInfo.title);\n            Log.Info(\u0022onVesselSwitching: from: \u0022 \u002B from.Parts.First().partInfo.title \u002B \u0022   to: \u0022 \u002B to.Parts.First().partInfo.title);\n            Log.Info(\u0022lastPart == data.to\u0022);\n\n            KerbalEVA kEVA = to.Parts.First().FindModuleImplementing\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;KerbalEVA\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E();           \n\n            if (to.parts == null || to.parts.Count == 0)\n                return;\n            if (from.parts == null || from.parts.Count == 0)\n                return;\n\n            PartResource kerbalResource = null;\n            PartResource shipResource = null;\n\n  \t\t\t// When the following return is here (or the following two lines are commented out) no errors.  \n            return;\n            kerbalResource = to.parts.First().Resources.Where(p =\u0026gt; p.resourceName == resourceName).First();\n            shipResource = from.parts.First().Resources.Where(p =\u0026gt; p.resourceName == resourceName).First();\n\n\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nWhat is strange is that I\u0027m getting an error if the last two lines are there, but no error if commented out. \u00A0The strange part is that NONE of those logging statements are executed when the error occurs, but when the lines are commented out, the logging statements work. \u00A0Additional strangeness is that if I have a return in front of those lines, no error happens.\n\u003C/p\u003E\n\u003Cp\u003E\nOriginally, those two lines were using:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003Eto.Parts\nfrom.Parts\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nI added that \u0022mylog\u0022 function because I was thinking that there may have been a race condition, and that writing directly to a file would at least show it\u0027s being called.\n\u003C/p\u003E\n\u003Cp\u003E\nI even tried adding a try/catch around those two lines, but didn\u0027t make any difference.\n\u003C/p\u003E\n\u003Cp\u003E\nWhen I run with the two lines disabled, I see the following:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003EEVAFuel: onVesselSwitching\n \n(Filename: C:/buildslave/unity/build/artifacts/generated/common/runtime/UnityEngineDebugBindings.gen.cpp Line: 42)\n\nEVAFuel: to or from are null\n \u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nWhen not disabled, the error:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E\nException handling event onVesselSwitching in class EvaFuelManager:System.TypeLoadException: Could not load type \u0027System.Func\u00602\u0027 from assembly \u0027mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\u0027.\n  at EventData\u00602[Vessel,Vessel].Fire (.Vessel data0, .Vessel data1) [0x00000] in \u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;filename\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E \u003C/span\u003E\u003Cspan class=\u0022atn\u0022\u003Eunknown\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E:0 \n \n(Filename: C:/buildslave/unity/build/artifacts/generated/common/runtime/UnityEngineDebugBindings.gen.cpp Line: 42)\n\nTypeLoadException: Could not load type \u0027System.Func\u00602\u0027 from assembly \u0027mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\u0027.\n  at EventData\u00602[Vessel,Vessel].Fire (.Vessel data0, .Vessel data1) [0x00000] in \u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;filename\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E \u003C/span\u003E\u003Cspan class=\u0022atn\u0022\u003Eunknown\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E:0 \nUnityEngine.DebugLogHandler:Internal_LogException(Exception, Object)\nUnityEngine.DebugLogHandler:LogException(Exception, Object)\nUnityEngine.Logger:LogException(Exception, Object)\nUnityEngine.Debug:LogException(Exception)\nEventData\u00602:Fire(Vessel, Vessel)\nFlightGlobals:setActiveVessel(Vessel, Boolean)\nFlightGlobals:SetActiveVessel(Vessel)\nFlightDriver:Start()\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222017-04-02T02:47:10Z\u0022 title=\u002204/02/2017 02:47  AM\u0022 data-short=\u00227 yr\u0022\u003EApril 2, 2017\u003C/time\u003E by linuxgurugamer\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2017-03-31T17:29:01Z","Content":"\n\u003Cp\u003E\n\u0022co\u003Cspan style=\u0022color:#000000;\u0022\u003Euld not load type \u0027System.Func\u00602\u0027 from assembly \u0027mscorlib, Version=4.0.0.0,\u0022\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan style=\u0022color:#000000;\u0022\u003EYou did not built it for .NET 3.5.\u00A0\u003C/span\u003E\n\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2017-03-31T17:30:27Z","Content":"\n\u003Cp\u003E\nFacepalm!!!!!!!!!!\n\u003C/p\u003E\n\u003Cp\u003E\nThank you\n\u003C/p\u003E\n"}]}