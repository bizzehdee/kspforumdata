{"TopicId":29104,"ForumId":29,"TopicTitle":"Custom Engine Activation with Animation","CreatedByName":"MWJ","CreatedById":62258,"CreatedDateTime":"2013-05-25T18:05:44Z","PageNum":1,"Articles":[{"CreatedByName":"MWJ","CreatedById":62258,"CreatedDateTime":"2013-05-25T18:05:44Z","Content":"\n\u003Cp\u003EHello everybody...\u003C/p\u003E\u003Cp\u003EStill trying to figure out how I possibly could get this to work...\u003C/p\u003E\u003Cp\u003EI read all the resources about Plugin-Developing I found, but\u003C/p\u003E\u003Cp\u003EI don\u0027t really get it.\u003C/p\u003E\u003Cp\u003EWhat i intend to do:\u003C/p\u003E\u003Cp\u003EI built a engine that folds it\u0027s nozzle. (Save space while stored)\u003C/p\u003E\u003Cp\u003EUsed ModuleGenericAnimator and everything worked beautifully...\u003C/p\u003E\u003Cp\u003EBut:\u003C/p\u003E\u003Cp\u003ENow I wanted to add a custom Engine Activation routine:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003EOn 1st activation the engine should unfold and activate after the animation is complete\u003C/div\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003EOn deactivation and every other activation it would stay in it\u0027s unfolded state. \u003C/div\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EHow could I elegantly translate this into working code?\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222013-05-25T18:08:39Z\u0022 title=\u002205/25/2013 06:08  PM\u0022 data-short=\u002211 yr\u0022\u003EMay 25, 2013\u003C/time\u003E by MWJ\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"OrbitusII","CreatedById":57305,"CreatedDateTime":"2013-05-26T02:09:56Z","Content":"\n\u003Cp\u003EUse some Boolean logic- check to see if the engine is active and that another variable (deployed) is false. When the engine is first activated, play the animation and then set deployed to true. Pretty basic stuff, hope you can get it to work. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"MWJ","CreatedById":62258,"CreatedDateTime":"2013-05-26T10:35:51Z","Content":"\n\u003Cp\u003EWorks fine now. \u003C/p\u003E\u003Cp\u003EThanks for the tips.\u003C/p\u003E\u003Cp\u003EMaybe this could be merged with the \u0022Help a fellow Dev\u0022-Thread? Saw that one a bit too late.\u003C/p\u003E\u003Cp\u003EHere\u0027s the Code, not commented, but it\u0027s not that complex...\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Eusing System;\u003Cbr\u003Eusing System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Epublic class ModuleEngineFolder : PartModule\u003Cbr\u003E{\u003Cbr\u003E    [KSPField]\u003Cbr\u003E    public string AnimationName = \u0022hydrashift\u0022;\u003Cbr\u003E    public bool folded = true;\u003Cbr\u003E    public bool thrustcut = false;\u003Cbr\u003E    float MaxThrustRest;\u003Cbr\u003E    float MinThrustRest;\u003Cbr\u003E\u003Cbr\u003E    ModuleEngines engine;\u003Cbr\u003E\u003Cbr\u003E    bool EngineIgnited\u003Cbr\u003E    {\u003Cbr\u003E        get\u003Cbr\u003E        {\u003Cbr\u003E            return engine.EngineIgnited;\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    Animation foldinganim\u003Cbr\u003E    {\u003Cbr\u003E        get\u003Cbr\u003E        {\u003Cbr\u003E            return part.FindModelAnimators(AnimationName)[0];\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public override void OnStart(PartModule.StartState state)\u003Cbr\u003E{\u003Cbr\u003E     if (part.Modules.Contains(\u0022ModuleEngines\u0022))\u003Cbr\u003E         engine = part.Modules[\u0022ModuleEngines\u0022] as ModuleEngines;\u003Cbr\u003E}\u003Cbr\u003E\u003Cbr\u003E    public override void OnUpdate()\u003Cbr\u003E    {\u003Cbr\u003E\u003Cbr\u003E        if (folded == true)\u003Cbr\u003E        {\u003Cbr\u003E            if (thrustcut == false)\u003Cbr\u003E            {\u003Cbr\u003E                MaxThrustRest = engine.maxThrust;\u003Cbr\u003E                MinThrustRest = engine.minThrust;\u003Cbr\u003E                engine.minThrust = 0;\u003Cbr\u003E                engine.maxThrust = 0;\u003Cbr\u003E                thrustcut = true;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E        if (engine.EngineIgnited == true)\u003Cbr\u003E        {\u003Cbr\u003E            if (folded == true)\u003Cbr\u003E            {\u003Cbr\u003E                foldinganim[AnimationName].speed = 1;\u003Cbr\u003E                foldinganim.Play(AnimationName);\u003Cbr\u003E                folded = false;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E        if (folded == false)\u003Cbr\u003E        {\u003Cbr\u003E            if (foldinganim.isPlaying == false)\u003Cbr\u003E            {\u003Cbr\u003E                engine.minThrust = MinThrustRest;\u003Cbr\u003E                engine.maxThrust = MaxThrustRest;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }       \u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-05-26T17:39:33Z","Content":"\n\u003Cp\u003EUse OnActive rather than OnUpdate \u0026amp; A check for inition, that\u0027ll get fired when they part gets activated (staged etc.)\u003C/p\u003E\n"},{"CreatedByName":"MWJ","CreatedById":62258,"CreatedDateTime":"2013-05-26T21:01:44Z","Content":"\n\u003Cp\u003EOk. Thanks for tip. \u003C/p\u003E\u003Cp\u003ESomehow I had the impression part activation was equal to part loading rather than staging / in game activation.\u003C/p\u003E\u003Cp\u003EAm I right to say the main advantage with \u0022onActive\u0022 is that the code won\u0027t run every frame and therefore is less heavy on the CPU?\u003C/p\u003E\n"},{"CreatedByName":"EndlessWaves","CreatedById":41302,"CreatedDateTime":"2013-05-26T23:52:35Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022MWJ\u0022 data-cite=\u0022MWJ\u0022\u003E\u003Cdiv\u003ESomehow I had the impression part activation was equal to part loading rather than staging / in game activation.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EOnAwake is called to initialise the plugin\u003C/p\u003E\u003Cp\u003EOnStart is called when that particular copy of the part is created (including on scene change, e.g. editor to flight)\u003C/p\u003E\u003Cp\u003EOnLoad is called when the part data needs to be loaded from a ConfigNode (config file, craft file, persistance file, save file)\u003C/p\u003E\u003Cp\u003EOnActive is called when the part is set to the active state (staging, action groups etc.) and it also seems to be called when an active part is on a ship that has just performed a docking operation\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022MWJ\u0022 data-cite=\u0022MWJ\u0022\u003E\u003Cdiv\u003E\u003Cp\u003EAm I right to say the main advantage with \u0022onActive\u0022 is that the code won\u0027t run every frame and therefore is less heavy on the CPU?\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThe main advantage is code clarity, with something simple like that the effect on performance isn\u0027t going to be noticeable.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222013-05-30T11:06:54Z\u0022 title=\u002205/30/2013 11:06  AM\u0022 data-short=\u002211 yr\u0022\u003EMay 30, 2013\u003C/time\u003E by EndlessWaves\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"MWJ","CreatedById":62258,"CreatedDateTime":"2013-05-27T04:21:50Z","Content":"\n\u003Cp\u003EOK, thank you very much for clearing everything up.\u003C/p\u003E\u003Cp\u003EWill post updated code and a pic of the working engine when I\u0027m done.\u003C/p\u003E\n"},{"CreatedByName":"MWJ","CreatedById":62258,"CreatedDateTime":"2013-05-30T10:52:57Z","Content":"\n\u003Cp\u003EWell, here is the final \u0022OnActive\u0022 Code I am using.\u003C/p\u003E\u003Cp\u003EPictures of the Engine can be found \u003Ca href=\u0022http://imgur.com/a/q6uiT\u0022 rel=\u0022external nofollow\u0022\u003E\u003Cspan style=\u0022text-decoration:underline;\u0022\u003E\u003Cstrong\u003Ehere\u003C/strong\u003E\u003C/span\u003E\u003C/a\u003E\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Eusing System;\u003Cbr\u003Eusing System.Collections;\u003Cbr\u003Eusing System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Epublic class ModuleEngineFolder : PartModule\u003Cbr\u003E{\u003Cbr\u003E    [KSPField]\u003Cbr\u003E    public string AnimationName = \u0022hydrav2shift\u0022;\u003Cbr\u003E    public bool folded = true;\u003Cbr\u003E    public bool thrustcut = false;\u003Cbr\u003E    float MaxThrustRest;\u003Cbr\u003E    float MinThrustRest;\u003Cbr\u003E\u003Cbr\u003E    ModuleEngines engine;\u003Cbr\u003E\u003Cbr\u003E    Animation foldinganim\u003Cbr\u003E    {\u003Cbr\u003E        get\u003Cbr\u003E        {\u003Cbr\u003E            return part.FindModelAnimators(AnimationName)[0];\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    public override void OnStart(PartModule.StartState state)\u003Cbr\u003E{\u003Cbr\u003E     if (part.Modules.Contains(\u0022ModuleEngines\u0022))\u003Cbr\u003E         engine = part.Modules[\u0022ModuleEngines\u0022] as ModuleEngines;\u003Cbr\u003E         foldinganim[AnimationName].layer = 2;\u003Cbr\u003E}\u003Cbr\u003E\u003Cbr\u003E    public override void OnActive()\u003Cbr\u003E    {\u003Cbr\u003E        if (thrustcut == false)\u003Cbr\u003E        {\u003Cbr\u003E            MaxThrustRest = engine.maxThrust;\u003Cbr\u003E            MinThrustRest = engine.minThrust;\u003Cbr\u003E            engine.minThrust = 0;\u003Cbr\u003E            engine.maxThrust = 0;\u003Cbr\u003E            thrustcut = true;\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        if (folded == true \u0026amp;\u0026amp; thrustcut == true)\u003Cbr\u003E        {\u003Cbr\u003E            StartCoroutine(timedanimator());\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E            IEnumerator timedanimator()\u003Cbr\u003E            {\u003Cbr\u003E                foldinganim[AnimationName].speed = 1;\u003Cbr\u003E                foldinganim.Play(AnimationName);\u003Cbr\u003E                folded = false;\u003Cbr\u003E                yield return new WaitForSeconds(foldinganim[AnimationName].length);\u003Cbr\u003E                engine.maxThrust = MaxThrustRest;\u003Cbr\u003E                engine.minThrust = MinThrustRest;\u003Cbr\u003E            }\u003Cbr\u003E}\u003Cbr\u003E\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThe only problem I\u0027m encountering is a non-working emissive heat animation... (Animation works if toggled by \u0022ModuleAnimateGeneric\u0022)\u003C/p\u003E\u003Cp\u003EThe Engine seems to produce no heat at all, not even with ridiculously high heating-settings.\u003C/p\u003E\u003Cp\u003EMaybe because the heat-function is based on maxThrust and I set it to 0 on activate?\u003C/p\u003E\u003Cp\u003EAnd a minor thing, the fairing is visible in the part preview in VAB, even tough it\u0027s invisible In-VAB editor window and In-Game as long as the bottom node isn\u0027t used. (MeshRenderer and FairingObject turned off in Unity)\u003C/p\u003E\n"}]}