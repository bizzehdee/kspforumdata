{"TopicId":68599,"ForumId":29,"TopicTitle":"Need some help with science transfer plugin","CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-08T00:38:17Z","PageNum":1,"Articles":[{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-08T00:38:17Z","Content":"\n\u003Cp\u003EI\u0027ve been trying to make a plugin to automatically collect experiment data and move it to a science container.\u003C/p\u003E\u003Cp\u003ENothing works. I can\u0027t even get the print() to show in the log. I\u0027m terrible with lists and foreach statements, which is part of the reason why I\u0027m pushing myself to do this, but no matter how I change things, nothing seems to work. No print output, no collection to a container. Although the nose cone experiment on my vessel appears to be having it\u0027s data fetched. That is the only sign of life I get from the plugin.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eusing System;\u003Cbr\u003Eusing System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Enamespace ForScience\u003Cbr\u003E{\u003Cbr\u003E    [KSPAddon(KSPAddon.Startup.Flight, false)]\u003Cbr\u003E    public class ForScience : Part\u003Cbr\u003E    {\u003Cbr\u003E        public void getScience()\u003Cbr\u003E        {\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            Vessel activeVessel = FlightGlobals.ActiveVessel;\u003Cbr\u003E            ScienceData[] data = null;\u003Cbr\u003E            ModuleScienceContainer container = null;\u003Cbr\u003E\u003Cbr\u003E            List\u0026lt;Part\u0026gt; parts = activeVessel.parts;            \u003Cbr\u003E            foreach (Part part in parts)\u003Cbr\u003E            {\u003Cbr\u003E                foreach (PartModule partModules in Modules)\u003Cbr\u003E                {\u003Cbr\u003E                    ModuleScienceExperiment experiment = partModules as ModuleScienceExperiment;\u003Cbr\u003E                    data = experiment.GetData();\u003Cbr\u003E\u003Cbr\u003E                }\u003Cbr\u003E\u003Cbr\u003E                foreach (PartModule partModules in Modules)\u003Cbr\u003E                {\u003Cbr\u003E                    if (partModules is ModuleScienceContainer \u0026amp; container == null)\u003Cbr\u003E                    {\u003Cbr\u003E                        container = partModules as ModuleScienceContainer;\u003Cbr\u003E                        int i = 0;\u003Cbr\u003E                        for (i = 0; i \u0026lt; data.Length; i\u002B\u002B)\u003Cbr\u003E                        {\u003Cbr\u003E                            container.AddData(data[i]);\u003Cbr\u003E                            container.RemoveData(data[i]);\u003Cbr\u003E                        }\u003Cbr\u003E                    }\u003Cbr\u003E\u003Cbr\u003E                }\u003Cbr\u003E\u003Cbr\u003E            }\u003Cbr\u003E\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public void OnUpdate()\u003Cbr\u003E        {\u003Cbr\u003E                getScience();\u003Cbr\u003E                print(\u0022please work\u0022);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E     }\u003Cbr\u003E\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EAny help would be appreciated.\u003C/p\u003E\n"},{"CreatedByName":"stupid_chris","CreatedById":62017,"CreatedDateTime":"2014-04-08T00:43:46Z","Content":"\n\u003Cp\u003EDon\u0027t use OnUpdate(). It\u0027s only called when the Part is active (Staged) just use Update() and FixedUpdate() \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-08T01:09:15Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022stupid_chris\u0022 data-cite=\u0022stupid_chris\u0022\u003E\u003Cdiv\u003EDon\u0027t use OnUpdate(). It\u0027s only called when the Part is active (Staged) just use Update() and FixedUpdate() \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EYay! Error Messages! Now I can actually debug. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EIf I could give you a hug, I would. Instead I\u0027ll have to settle for giving you some internet points. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"stupid_chris","CreatedById":62017,"CreatedDateTime":"2014-04-08T01:11:59Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022WaveFunctionP\u0022 data-cite=\u0022WaveFunctionP\u0022\u003E\u003Cdiv\u003EYay! Error Messages! Now I can actually debug. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003Cp\u003EIf I could give you a hug, I would. Instead I\u0027ll have to settle for giving you some internet points. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ENo problem \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EOnUpdate() and OnFixedUpdate() are usefull for stuff that deals with staging, but apart from that there\u0027s no need to use them. \u003Cspan style=\u0022text-decoration:line-through;\u0022\u003EI stopped using them for realchute because the staging controller is totally dysfunctional and catching the staging keypress and switching a bool is more reliable but shh.\u003C/span\u003E\u003C/p\u003E\n"},{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-09T08:22:22Z","Content":"\n\u003Cp\u003EAlrighty, I bashes my head against these problems long enough.\u003C/p\u003E\u003Cp\u003EThe plugin seems to work...on the first vessel loaded. Reloading the vessel to launch pad or exiting back out and using a different vessel causes no apparent activity from the plugin, and no errors are thrown.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eusing System;\u003Cbr\u003Eusing System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Enamespace ForScience\u003Cbr\u003E{\u003Cbr\u003E    [KSPAddon(KSPAddon.Startup.Flight, true)]\u003Cbr\u003E    public class ForScience : MonoBehaviour\u003Cbr\u003E    {\u003Cbr\u003E        ModuleScienceExperiment experiment = null;\u003Cbr\u003E        ModuleScienceContainer container = null;\u003Cbr\u003E        ScienceData[] data = null;\u003Cbr\u003E\u003Cbr\u003E        void Update()\u003Cbr\u003E        {\u003Cbr\u003E            Debug.Log(\u0022[For Science] initialized at \u0022 \u002B experiment.name \u002B container.name \u002B data);\u003Cbr\u003E            foreach (Part part in FlightGlobals.ActiveVessel.parts)\u003Cbr\u003E            {\u003Cbr\u003E                Debug.Log(\u0022[For Science] searching parts\u0022);\u003Cbr\u003E                foreach (PartModule partModules in part.Modules)\u003Cbr\u003E                {\u003Cbr\u003E                    Debug.Log(\u0022[For Science] searching modules\u0022);\u003Cbr\u003E                    if (partModules is ModuleScienceContainer)\u003Cbr\u003E                    {\u003Cbr\u003E                        container = partModules as ModuleScienceContainer;\u003Cbr\u003E                        Debug.Log(\u0022[For Science] found container: \u0022 \u002B container);\u003Cbr\u003E                    }\u003Cbr\u003E                    else if (partModules is ModuleScienceExperiment)\u003Cbr\u003E                    {\u003Cbr\u003E                        experiment = partModules as ModuleScienceExperiment;\u003Cbr\u003E                        Debug.Log(\u0022[For Science] found experiment: \u0022 \u002B experiment);\u003Cbr\u003E                        if (experiment.GetScienceCount() \u0026gt; 0)\u003Cbr\u003E                        {\u003Cbr\u003E                            Debug.Log(\u0022[For Science] Collecting: \u0022 \u002B experiment.name);\u003Cbr\u003E                            data = experiment.GetData();                            \u003Cbr\u003E                            container.AddData(data[0]);\u003Cbr\u003E                            experiment.ResetExperiment();\u003Cbr\u003E\u003Cbr\u003E                        }\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EI also have a secondary problem in that the plugin stores multiple copies of the experiments even though the experiments are supposed to be reset and presumably cleared after the data is stored into ScienceData[] and only pulled from there into the container once. I\u0027ve run up to 8 experiments and has it store 32 data in the pod. Obviously with 3 duplicate data for each experiment. I\u0027ve tried transferring the data to container directly, but I get type conversion errors in the compiler.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-04-09T12:03:57Z\u0022 title=\u002204/09/2014 12:03  PM\u0022 data-short=\u002210 yr\u0022\u003EApril 9, 2014\u003C/time\u003E by WaveFunctionP\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2014-04-09T14:43:53Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022WaveFunctionP\u0022 data-cite=\u0022WaveFunctionP\u0022\u003E\u003Cdiv\u003EI also have a secondary problem in that the plugin stores multiple copies of the experiments even though the experiments are supposed to be reset and presumably cleared after the data is stored into ScienceData[] and only pulled from there into the container once. I\u0027ve run up to 8 experiments and has it store 32 data in the pod. Obviously with 3 duplicate data for each experiment. I\u0027ve tried transferring the data to container directly, but I get type conversion errors in the compiler.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThe only-works-once problem is, I think, due to that \u0022true\u0022 at the end of the \u0022[KSPAddon\u0022 line at the top. I think that should be false, so that it loads up every time you go to the flight scene.\u003C/p\u003E\u003Cp\u003EThe duplicate science problem might have something to do with how you\u0027re looping through every part to find containers and experiments. It seems like it might choke if it found the experiment before the container, or it might find multiple containers and send science data to different containers based on the part order of your vessel. I\u0027m not really sure why any of this would send duplicate results though. Maybe you also need to clear out the data[] array after each transfer, too.\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-04-10T00:03:02Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022WaveFunctionP\u0022 data-cite=\u0022WaveFunctionP\u0022\u003E\u003Cdiv\u003EI also have a secondary problem in that the plugin stores multiple copies of the experiments even though the experiments are supposed to be reset and presumably cleared after the data is stored into ScienceData[] and only pulled from there into the container once. I\u0027ve run up to 8 experiments and has it store 32 data in the pod. Obviously with 3 duplicate data for each experiment. I\u0027ve tried transferring the data to container directly, but I get type conversion errors in the compiler.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EVessel has a handy function called FindPartModulesImplementing\u0026lt;T\u0026gt; that can be used to greatly simplify your code:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Evar containers = FlightGlobals.ActiveVessel.FindPartModulesImplementing\u0026lt;ModuleScienceContainer\u0026gt;();\u003Cbr\u003Evar sourceData = FlightGlobals.ActiveVessel.FindPartModulesImplementing\u0026lt;ModuleScienceExperiment\u0026gt;().Cast\u0026lt;IScienceDataContainer\u0026gt;().ToList();\u003Cbr\u003E\u003Cbr\u003Econtainers[0].StoreData(sourceData, true);\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThis works fine for the only experiment I tested, the gravioli detector. I\u0027m not sure resetting experiments is necessary (it wasn\u0027t for the one I tested) but I\u0027ll leave that to you. Good luck\u003C/p\u003E\n"},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2014-04-10T00:07:38Z","Content":"\n\u003Cp\u003EAnother thing to add. If manually resetting the experiment is necessary you should be using ModuleScienceExperiment.DumpData() (or maybe the IScienceDataContainer interface\u0027s method) not ResetExperiment(). The latter is used for throwing out data, either through the experiment results page, the reset Event/Action, or the EVA reset. Dumpdata() is what is called after you transmit something and it will properly set the experiment as inoperable if need be.\u003C/p\u003E\n"},{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-10T03:19:12Z","Content":"\n\u003Cp\u003EThank you, to all of you.\u003C/p\u003E\u003Cp\u003EThe setting true to false on the kspaddon line did the trick for swapping vessels.\u003C/p\u003E\u003Cp\u003EI had tried using the isciencecontainer, but didn\u0027t know how to use it. It works perfectly for removing and setting experiments non-repeatable experiments inoperable. I was using dumpdata() and/or resetexperiment() just to try and stop duplicates. There\u0027s still so much I need to learn about programming. I was trying to cast using something like (ThingIWantToCastTo) thingIWantRecast.\u003C/p\u003E\u003Cp\u003EThat FindPartModulesImplimenting method is a godsend.\u003C/p\u003E\u003Cp\u003ENow I can hopefully start working on features and adding a gui.\u003C/p\u003E\u003Cp\u003EThanks again.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-04-10T03:21:17Z\u0022 title=\u002204/10/2014 03:21  AM\u0022 data-short=\u002210 yr\u0022\u003EApril 10, 2014\u003C/time\u003E by WaveFunctionP\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-16T12:31:34Z","Content":"\n\u003Cp\u003EAlrighty, so I\u0027ve been developing some logic to run experiments if there is new data to be had and we haven\u0027t already collected it onboard.\u003C/p\u003E\u003Cp\u003EThe problem I\u0027m having is that the all of the situation/biome functions that I\u0027ve tried aren\u0027t returning the correct values for the launchpad, and presumably elsewhere at KSP. Instead the return shores. It\u0027s driving me batty, because I feel like I\u0027m so close to being able to add this functionality in a very complete way. As usual, I expect that I\u0027m probably doing it the hard way. (You can ignore the commented sections, I was jumping through hoops trying to check experiment results without actually running the experiment and run them against what is stored in the container.)\u003C/p\u003E\u003Cp\u003EThe debugs will return \u003Ca href=\u0022/cdn-cgi/l/email-protection#c9ecfe8ba6b9bda0a6a7ecfe8d\u0022\u003E\u003Cspan class=\u0022__cf_email__\u0022 data-cfemail=\u00224d3a252c39283b283f0d636363212c38232e25\u0022\u003E[email\u0026#160;protected]\u003C/span\u003E\u003C/a\u003Epad from the existing data stored in container (as that is what the actual experiment as returned), and \u003Ca href=\u0022/cdn-cgi/l/email-protection#92b7a5d0fde2e6fbfdfcb7a5d6\u0022\u003E\u003Cspan class=\u0022__cf_email__\u0022 data-cfemail=\u00221f68777e6b7a697a6d5f3131316c77706d7a6c\u0022\u003E[email\u0026#160;protected]\u003C/span\u003E\u003C/a\u003E from the \u0022currentfunctions\u0022, be it via the vessel.situations or from getexperimentsituation.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Evar currentBody = vessel.mainBody;\u003Cbr\u003E            var currentBiome = ScienceUtil.GetExperimentBiome(currentBody, vessel.latitude, vessel.longitude);\u003Cbr\u003E            var currentSituation = ScienceUtil.GetExperimentSituation(vessel);\u003Cbr\u003E\u003Cbr\u003Evar experimentList = vessel.FindPartModulesImplementing\u0026lt;ModuleScienceExperiment\u0026gt;();\u003Cbr\u003E            foreach (ModuleScienceExperiment experiment in experimentList)\u003Cbr\u003E            {\u003Cbr\u003E                ScienceExperiment currentExperimentID = ResearchAndDevelopment.GetExperiment(experiment.experimentID);\u003Cbr\u003E                ScienceSubject checkExisting = ResearchAndDevelopment.GetExperimentSubject(currentExperimentID, currentSituation,  currentBody, currentBiome);\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E                bool dataIsInContainer = false;\u003Cbr\u003E                foreach (ScienceData containerData in container.GetData())\u003Cbr\u003E                {\u003Cbr\u003E                    if (containerData.subjectID == experiment.experimentID) dataIsInContainer = true;\u003Cbr\u003E                    Debug.Log(\u0022container: \u0022 \u002B containerData.subjectID);\u003Cbr\u003E                    Debug.Log(\u0022experiment: \u0022 \u002B checkExisting.id);\u003Cbr\u003E                }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E                if (checkExisting.scientificValue \u0026gt; 0f \u0026amp; !dataIsInContainer)\u003Cbr\u003E                {\u003Cbr\u003E                    Debug.Log(\u0022dataisincontainer = \u0022 \u002B dataIsInContainer);\u003Cbr\u003E\u003Cbr\u003E                    //experiment.DeployExperiment();\u003Cbr\u003E                    //ScienceData[] currentExperimentData = experiment.GetData();\u003Cbr\u003E                    //if (data.Contains(currentExperimentData[0])) experiment.DumpData(currentExperimentData[0]);\u003Cbr\u003E                    //else\u003Cbr\u003E                    //{\u003Cbr\u003E                    //    container.AddData(currentExperimentData[0]);\u003Cbr\u003E                    //    experiment.DumpData(currentExperimentData[0]);\u003Cbr\u003E\u003Cbr\u003E                    //}\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            container.StoreData(experimentList.Cast\u0026lt;IScienceDataContainer\u0026gt;().ToList(), true);\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EI can concoct a string if needed (and I\u0027ve tried) , but I need a function that will return the correct value for situation. Otherwise, my container check will fail and won\u0027t run experiments or will run duplicates and spam the user with duplicate reports.\u003C/p\u003E\u003Cp\u003EI hate making special cases, and I suspect I\u0027m doing this wrong, because it seems like it should be such a simple thing to check if you have the data already.\u003C/p\u003E\n"},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2014-04-16T14:44:23Z","Content":"\n\u003Cp\u003EThis is what I use to check the biome.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Epublic string getBiome(ExperimentSituations s)\u003Cbr\u003E        {\u003Cbr\u003E            if (scienceExp.BiomeIsRelevantWhile(s))\u003Cbr\u003E            {\u003Cbr\u003E                switch (vessel.landedAt)\u003Cbr\u003E                {\u003Cbr\u003E                    case \u0022LaunchPad\u0022:\u003Cbr\u003E                        return vessel.landedAt;\u003Cbr\u003E                    case \u0022Runway\u0022:\u003Cbr\u003E                        return vessel.landedAt;\u003Cbr\u003E                    case \u0022KSC\u0022:\u003Cbr\u003E                        return vessel.landedAt;\u003Cbr\u003E                    default:\u003Cbr\u003E                        return FlightGlobals.currentMainBody.BiomeMap.GetAtt(vessel.latitude * Mathf.Deg2Rad, vessel.longitude * Mathf.Deg2Rad).name;\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            else return \u0022\u0022;\u003Cbr\u003E        }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThough looking at it, it could probably be simpler. vessel.landedAt returns an empty string (I think) anywhere outside of the KSC, so you could just check to see if that is empty, if not return that value for the biome, and if it is do the regular biome check. I\u0027ve heard that you can also get results for the \u0022KSC\u0022 biome while flying above it (or maybe in space if you\u0027re really quick?), but I don\u0027t know how that works or how to replicate it.\u003C/p\u003E\u003Cp\u003EDo you get accurate biome results using vessel.latitude/longitude? Using the method I showed always requires position in radians not degrees.\u003C/p\u003E\u003Cp\u003EAs for the experimental situation, check around. I consider it a bug that you can only conduct atmospheric science while on a sub-orbital trajectory, so all of my experiments use a method that returns flying high/low anytime you are in the atmosphere. All of the methods I\u0027ve seen are basically the same as mine, there are just a few adjustments that need to be made to return stock science behavior. \u003C/p\u003E\u003Cp\u003EIgnore the bit about asteroids at the top...\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Epublic ExperimentSituations getSituation()\u003Cbr\u003E        {\u003Cbr\u003E            //Check for asteroids, return values that should sync with existing parts\u003Cbr\u003E            if (asteroidReports \u0026amp;\u0026amp; AsteroidScience.asteroidGrappled()) return ExperimentSituations.SrfLanded;\u003Cbr\u003E            if (asteroidReports \u0026amp;\u0026amp; AsteroidScience.asteroidNear()) return ExperimentSituations.InSpaceLow;\u003Cbr\u003E            switch (vessel.situation)\u003Cbr\u003E            {\u003Cbr\u003E                case Vessel.Situations.LANDED:\u003Cbr\u003E                case Vessel.Situations.PRELAUNCH:\u003Cbr\u003E                    return ExperimentSituations.SrfLanded;\u003Cbr\u003E                case Vessel.Situations.SPLASHED:\u003Cbr\u003E                    return ExperimentSituations.SrfSplashed;\u003Cbr\u003E                default:\u003Cbr\u003E                    if (vessel.altitude \u0026lt; vessel.mainBody.maxAtmosphereAltitude \u0026amp;\u0026amp; vessel.mainBody.atmosphere)\u003Cbr\u003E                    {\u003Cbr\u003E                        if (vessel.altitude \u0026lt; vessel.mainBody.scienceValues.flyingAltitudeThreshold)\u003Cbr\u003E                            return ExperimentSituations.FlyingLow;\u003Cbr\u003E                        else\u003Cbr\u003E                            return ExperimentSituations.FlyingHigh;\u003Cbr\u003E                    }\u003Cbr\u003E                    if (vessel.altitude \u0026lt; vessel.mainBody.scienceValues.spaceAltitudeThreshold)\u003Cbr\u003E                        return ExperimentSituations.InSpaceLow;\u003Cbr\u003E                    else\u003Cbr\u003E                        return ExperimentSituations.InSpaceHigh;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EEdit: If you want a good look at how to check experiment status for stock science look at the code for xEvilReeperx\u0027s \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/76793-0-23-5-ScienceAlert-Experiment-availability-feedback\u0022 rel=\u0022external nofollow\u0022\u003EScienceAlert\u003C/a\u003E, last I checked it had the methods you need for these kinds of things.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-04-16T14:53:00Z\u0022 title=\u002204/16/2014 02:53  PM\u0022 data-short=\u002210 yr\u0022\u003EApril 16, 2014\u003C/time\u003E by DMagic\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-16T15:53:36Z","Content":"\n\u003Cp\u003EThanks, I\u0027ll be sure to check that out.\u003C/p\u003E\u003Cp\u003EI get what seems to be accurate results for biomes. The problem was that at KSC it would return shores. I simply pass the appropriate FlightGlobal.ActiveVessel parameters directly into ScienceUtil.GetExperimentBiome(). From there I can get a lot of parameters from ResearchAndDevelopment. No math or casts involved. No idea if that is optimal or not.\u003C/p\u003E\u003Cp\u003EI ended up doing a check for landed and concocting a string together with vessel.landedAt. Seems to work.\u003C/p\u003E\u003Cp\u003EAfter that, a quick test shows that it immediately picks up on biome and situation changes.\u003C/p\u003E\u003Cp\u003ENew problem is that deployexperiment seems to always run twice. I\u0027ve checked and it isn\u0027t looping twice. It is simply returning double results, which pops up an annoying message box. So each time I hit a new biome, I have click to close it. I\u0027ve been looking around in the library, but I don\u0027t see any reference to this window. Would be nice to hide the results dialogs, or have my routine pause and only collect data when I click save, but atleast it\u0027s working now.\u003C/p\u003E\u003Cp\u003EHere\u0027s what I\u0027m doing currently. I may need to handle the landedat better if it does return null.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eprivate void TransferScience()\u003Cbr\u003E        {\u003Cbr\u003E            Vessel vessel = FlightGlobals.ActiveVessel;\u003Cbr\u003E            var containerList = vessel.FindPartModulesImplementing\u0026lt;ModuleScienceContainer\u0026gt;();\u003Cbr\u003E            if (container == null) container = containerList[0];\u003Cbr\u003E            data = container.GetData();\u003Cbr\u003E\u003Cbr\u003E            var currentBody = vessel.mainBody;\u003Cbr\u003E            var currentBiome = ScienceUtil.GetExperimentBiome(currentBody, vessel.latitude, vessel.longitude);\u003Cbr\u003E            var currentSituation = ScienceUtil.GetExperimentSituation(vessel);\u003Cbr\u003E\u003Cbr\u003E            var experimentList = vessel.FindPartModulesImplementing\u0026lt;ModuleScienceExperiment\u0026gt;();\u003Cbr\u003E            foreach (ModuleScienceExperiment experiment in experimentList)\u003Cbr\u003E            {\u003Cbr\u003E                ScienceExperiment currentExperimentID = ResearchAndDevelopment.GetExperiment(experiment.experimentID);\u003Cbr\u003E                ScienceSubject currentSubject = ResearchAndDevelopment.GetExperimentSubject(currentExperimentID, currentSituation, currentBody, currentBiome);\u003Cbr\u003E\u003Cbr\u003E                bool dataIsInContainer = false;\u003Cbr\u003E                foreach (ScienceData containerData in container.GetData())\u003Cbr\u003E                {\u003Cbr\u003E                    if (vessel.Landed)\u003Cbr\u003E                    {\u003Cbr\u003E                        currentSubject.id = experiment.experimentID \u002B \u0022@\u0022 \u002B vessel.mainBody.name \u002B currentSituation \u002B vessel.landedAt;\u003Cbr\u003E                    }\u003Cbr\u003E                    if (containerData.subjectID == currentSubject.id) dataIsInContainer = true;\u003Cbr\u003E\u003Cbr\u003E                    Debug.Log(\u0022landedAt: \u0022 \u002B vessel.landedAt);\u003Cbr\u003E                    Debug.Log(\u0022currentSituation: \u0022 \u002B currentSituation);\u003Cbr\u003E                    Debug.Log(\u0022container: \u0022 \u002B containerData.subjectID);\u003Cbr\u003E                    Debug.Log(\u0022experiment: \u0022 \u002B currentSubject.id);\u003Cbr\u003E                    Debug.Log(\u0022dataisincontainer = \u0022 \u002B dataIsInContainer);\u003Cbr\u003E                }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E                if (currentSubject.scientificValue \u0026gt; 0f \u0026amp; !dataIsInContainer)\u003Cbr\u003E                {\u003Cbr\u003E                    Debug.Log(\u0022dataisincontainer = \u0022 \u002B dataIsInContainer);\u003Cbr\u003E\u003Cbr\u003E                    experiment.DeployExperiment();\u003Cbr\u003E\u003Cbr\u003E                    container.StoreData(experimentList.Cast\u0026lt;IScienceDataContainer\u0026gt;().ToList(), true);\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E        }\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Eedit: Well, this is fun. When I recover the vessel, none of the data is recovered. Back to the drawing board.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-04-16T17:04:51Z\u0022 title=\u002204/16/2014 05:04  PM\u0022 data-short=\u002210 yr\u0022\u003EApril 16, 2014\u003C/time\u003E by WaveFunctionP\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-16T18:10:39Z","Content":"\n\u003Cp\u003EDo I get a medal for breaking an install?\u003C/p\u003E\u003Cp\u003Eedit: Yup, something in there is breaking the whole install.\u003C/p\u003E\u003Cp\u003Edefinitely have to start over from scratch, there\u0027s no indication as to how or why data recovery gets broken.\u003C/p\u003E\u003Cp\u003Eedit: I suspect it was the researchanddevelopment references.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-04-16T20:04:19Z\u0022 title=\u002204/16/2014 08:04  PM\u0022 data-short=\u002210 yr\u0022\u003EApril 16, 2014\u003C/time\u003E by WaveFunctionP\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"WaveFunctionP","CreatedById":104784,"CreatedDateTime":"2014-04-16T20:40:36Z","Content":"\n\u003Cp\u003EI removed the rnd references, which apparently I didn\u0027t need to begin with. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 alt=\u0022:P\u0022\u003E\u003C/p\u003E\u003Cp\u003ENow it is recovering science properly now, and appears to be running experiments at the appropriate times.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eprivate void TransferScience()\u003Cbr\u003E        {\u003Cbr\u003E            var v = FlightGlobals.ActiveVessel;\u003Cbr\u003E            var containerList = v.FindPartModulesImplementing\u0026lt;ModuleScienceContainer\u0026gt;();\u003Cbr\u003E            if (container == null) container = containerList[0];\u003Cbr\u003E\u003Cbr\u003E            var currentBody = v.mainBody;\u003Cbr\u003E            var currentBiome = ScienceUtil.GetExperimentBiome(currentBody, v.latitude, v.longitude);\u003Cbr\u003E            var currentSituation = ScienceUtil.GetExperimentSituation(v);\u003Cbr\u003E\u003Cbr\u003E            var experimentList = v.FindPartModulesImplementing\u0026lt;ModuleScienceExperiment\u0026gt;();\u003Cbr\u003E            foreach (ModuleScienceExperiment experiment in experimentList)\u003Cbr\u003E            {\u003Cbr\u003E                var dataIsInContainer = false;\u003Cbr\u003E                foreach (ScienceData data in container.GetData())\u003Cbr\u003E                {\u003Cbr\u003E                    var currentExperiment = (experiment.experimentID \u002B \u0022@\u0022 \u002B currentBody.name \u002B currentSituation \u002B currentBiome);\u003Cbr\u003E                    if (v.landedAt != \u0022\u0022)\u003Cbr\u003E                    {\u003Cbr\u003E                        currentExperiment = (experiment.experimentID \u002B \u0022@\u0022 \u002B currentBody.name \u002B currentSituation \u002B v.landedAt);\u003Cbr\u003E                    }\u003Cbr\u003E                    if (data.subjectID == currentExperiment)\u003Cbr\u003E                    {\u003Cbr\u003E                        Debug.Log(\u0022experiment: \u0022 \u002B currentExperiment);\u003Cbr\u003E                        Debug.Log(\u0022data:\u0022 \u002B data.subjectID);\u003Cbr\u003E                        dataIsInContainer = true;\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E                if (dataIsInContainer == false)\u003Cbr\u003E                {\u003Cbr\u003E                    experiment.DeployExperiment();\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E\u003Cbr\u003E            container.StoreData(experimentList.Cast\u0026lt;IScienceDataContainer\u0026gt;().ToList(), true);\u003Cbr\u003E        }\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EI\u0027m still getting more than one experiment run, which pops up a duplicate dialog. Which is annoying. But at least it isn\u0027t breaking installs any longer. \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"}]}