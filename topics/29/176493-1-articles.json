{"TopicId":176493,"ForumId":29,"TopicTitle":"onVesselsUndocking() doesn\u0026#039;t appear to be working","CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2018-07-05T03:13:31Z","PageNum":1,"Articles":[{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2018-07-05T03:13:31Z","Content":"\n\u003Cp\u003E\nI have been trying to catch an undocking of vessels.\u00A0 I found the really cool callback called:\u00A0 GameVents.onVesselsUndocking(Vessel, Vessel), but it doesn\u0027t appear to be working.\n\u003C/p\u003E\n\u003Cp\u003E\nI added the following to the Start() of a vessel\u00A0 module:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003EGameEvents.onVesselsUndocking.Add(undocking);\n\n...\n\nvoid undocking(Vessel v1, Vessel v2)\n{\n     Debug.Log(\u0022undocking\u0022);\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI know it was added to the event list, I had a debug statement right before the Add.\u00A0 But the function never gets called\n\u003C/p\u003E\n"},{"CreatedByName":"peteletroll","CreatedById":144573,"CreatedDateTime":"2018-07-05T06:36:40Z","Content":"\n\u003Cp\u003E\nI don\u0027t know about onVesselsUndocking, but onPartUndock and onPartUndockComplete work for me.\n\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2018-07-05T08:45:00Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223410671\u0022 data-ipsquote-contentid=\u0022176493\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221530772600\u0022 data-ipsquote-userid=\u0022144573\u0022 data-ipsquote-username=\u0022peteletroll\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n2 hours ago, peteletroll said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI don\u0027t know about onVesselsUndocking, but onPartUndock and onPartUndockComplete work for me.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nBut only for one of the parts, not for both of them.\u00A0 I need to be able to know both vessels, the original, and the new one which was created via the undocking.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cstrong\u003EEdit 1:\u003C/strong\u003E\u00A0 A bit more info:\u00A0 I tested these three both in a vessel module and in a regular MonoBehaviour class.:\n\u003C/p\u003E\n\u003Cp\u003E\nIn the VesselModule, the Start() is called and\u00A0adds these three callbacks\u00A0for all vessels and objects in the system,.\u00A0 Then, when an undocking is performed, Start is called again in the vessel module to add the callbacks for the new vessel which is created.\u00A0 But, the callbacks are never called.\n\u003C/p\u003E\n\u003Cp\u003E\nIn the Monobehaviour class, the Start is called once.\u00A0 But the callbacks are not called when an undocking is done.\n\u003C/p\u003E\n\u003Cp\u003E\nCode for the regular MonoBehaviour class:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E [KSPAddon(KSPAddon.Startup.Flight, false)]\n    public class BPB_Flight : MonoBehaviour\n    {\n        void Start()\n        {\n            Log.Info(\u0022BPB_Flight. Added Undocks\u0022);\n            GameEvents.onPartUndock.Add(onPartUndock);\n            GameEvents.onPartUndockComplete.Add(onPartUndockComplete);\n            GameEvents.onVesselsUndocking.Add(onVesselsUndocking);\n        }\n\n        void onVesselsUndocking(Vessel v1, Vessel v2)\n        {\n            Log.Info(\u0022BPB_Flight.onVesselsUndocking\u0022);\n        }\n        void onPartUndock(Part p)\n        {\n            Log.Info(\u0022BPB_Flight.onPartUndock, part \u0022 \u002B p.partInfo.title);\n        }\n        void onPartUndockComplete(Part p)\n        {\n            Log.Info(\u0022BPB_Flight.onPartUndockComplete, part \u0022 \u002B p.partInfo.title);\n        }\n    }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nCode for the VesselModule class:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E    class BPB_VesselModule : VesselModule\n    {\n        Vessel lastActiveVessel;\n        BPB_VesselModule vm;\n\n        bool timeoutInProgress = false;\n\n        void Start()\n        {\n            if (HighLogic.LoadedSceneIsFlight)\n            {\n                Vessel v = FlightGlobals.ActiveVessel;\n                var vm = v.GetComponent\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;BPB_VesselModule\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E();\n\n \n                if (FlightGlobals.ActiveVessel.missionTime \u0026gt; vm.disableAfter)\n                {\n                    vm.armed = false;\n                }\n                Log.Info(\u0022Added Undocks\u0022);\n                GameEvents.onPartUndock.Add(onPartUndock);\n                GameEvents.onPartUndockComplete.Add(onPartUndockComplete);\n            }            \n        }\n        void onPartUndock(Part p)\n        {\n            Log.Info(\u0022onPartUndock, part \u0022 \u002B p.partInfo.title);\n        }\n        void onPartUndockComplete(Part p)\n        {\n            Log.Info(\u0022onPartUndockComplete, part \u0022 \u002B p.partInfo.title);\n        }\n                  \n...\n                  }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nEdit 2:\u00A0 Apparently \u0022uncoupling\u0022 isn\u0027t the same as \u0022undocking\u0022.\u00A0 I\u0027ve been testing with two vessels docked together in the \u003Cabbr title=\u0022Vehicle Assembly Building\u0022\u003EVAB\u003C/abbr\u003E, I just tested by undocking and redocking, and they seemed to work better\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222018-07-05T09:08:59Z\u0022 title=\u002207/05/2018 09:08  AM\u0022 data-short=\u00226 yr\u0022\u003EJuly 5, 2018\u003C/time\u003E by linuxgurugamer\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"peteletroll","CreatedById":144573,"CreatedDateTime":"2018-07-05T09:03:45Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223410613\u0022 data-ipsquote-contentid=\u0022176493\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221530760411\u0022 data-ipsquote-userid=\u0022129964\u0022 data-ipsquote-username=\u0022linuxgurugamer\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n5 hours ago, linuxgurugamer said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI added the following to the Start() of a vessel\u00A0 module:\u003Cspan\u003E\uFEFF\u003C/span\u003E\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nMaybe you can try to set the callbacks in\u00A0OnAwake(). Works for me (TM).\u00A0\u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nEDIT: but I\u0027m working on a PartModule. Your situation could be different.\n\u003C/p\u003E\n\u003Cp\u003E\nEDIT AGAIN: or maybe OnStart() instead of Start().\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222018-07-05T09:09:38Z\u0022 title=\u002207/05/2018 09:09  AM\u0022 data-short=\u00226 yr\u0022\u003EJuly 5, 2018\u003C/time\u003E by peteletroll\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2018-07-05T09:09:32Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223410712\u0022 data-ipsquote-contentid=\u0022176493\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221530781425\u0022 data-ipsquote-userid=\u0022144573\u0022 data-ipsquote-username=\u0022peteletroll\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n5 minutes ago, peteletroll said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nMaybe you can try to set the callbacks in\u00A0OnAwake(). Works for me (TM).\u00A0\u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nEDIT: but I\u0027m working on a PartModule. Your situation could be different.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nSee my second edit (we did it simultanously)\n\u003C/p\u003E\n"},{"CreatedByName":"peteletroll","CreatedById":144573,"CreatedDateTime":"2018-07-05T09:18:09Z","Content":"\n\u003Cp\u003E\nSee my second edit too \u003Cspan\u003E\u003Cspan\u003E\u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/span\u003E\u003C/span\u003E\n\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2018-07-05T15:21:29Z","Content":"\n\u003Cp\u003E\nIt turns out that the callback \u003Cstrong\u003EGameEvents.onVesselsUndocking\u003C/strong\u003E does work, but it does NOT fire if a couple of docking ports are together during the launch, in that case, when you separate, it is seen as an uncouple event.\u00A0 In order to catch that, you need to use the \u003Cstrong\u003EGameEvents.onVesselCreate\u003C/strong\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nThis is a problem if the new vessel needs to know the old vessel.\u00A0 In my case, I need to know the current mission time of the original\u00A0vessel.\u00A0 The following code seems to work.\u00A0 I\u0027m not done with my testin\u003Cs\u003Eg, but it looks like the callback for the onVesselCreate is called before the VesselModule.Start is done on the new vessel;\u00A0 or maybe it\u0027s not being called\u003C/s\u003E.\u00A0 I\u0027ll update this as I proceed with\u00A0 my testing\n\u003C/p\u003E\n\u003Cp\u003E\nEdit:\u00A0 I know the code has a problem, the currentVessel is totally incorrect for now.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E[KSPAddon(KSPAddon.Startup.Flight, false)]\npublic class BPB_Flight : MonoBehaviour\n{\n    Vessel currentVessel;\n\n    void Start()\n    {\n        GameEvents.onVesselsUndocking.Add(onVesselsUndocking);\n        GameEvents.onVesselCreate.Add(onVesselCreate);\n\n        currentVessel = FlightGlobals.ActiveVessel;\n    }\n\n    void OnDestroy()\n    {\n        GameEvents.onVesselsUndocking.Remove(onVesselsUndocking);\n        GameEvents.onVesselCreate.Remove(onVesselCreate);\n    }\n\n    void onVesselCreate(Vessel v)\n    {\n        var vm = v.GetComponent\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;BPB_VesselModule\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E();\n        vm.missionTime = currentVessel.missionTime;\n    }\n  \n    void onVesselsUndocking(Vessel v1, Vessel v2)\n    {\n        var vm1 = v1.GetComponent\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;BPB_VesselModule\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E();\n        var vm2 = v2.GetComponent\u003C/span\u003E\u003Cspan class=\u0022tag\u0022\u003E\u0026lt;BPB_VesselModule\u0026gt;\u003C/span\u003E\u003Cspan class=\u0022pln\u0022\u003E();\n        vm1.missionTime = Math.Max(v1.missionTime, v2.missionTime);\n        vm2.missionTime = vm1.missionTime;\n    }\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222018-07-05T15:25:37Z\u0022 title=\u002207/05/2018 03:25  PM\u0022 data-short=\u00226 yr\u0022\u003EJuly 5, 2018\u003C/time\u003E by linuxgurugamer\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"peteletroll","CreatedById":144573,"CreatedDateTime":"2018-07-05T15:51:57Z","Content":"\n\u003Cp\u003E\nA wild idea on the train home: what about using parts flightID to track the parts after decoupling?\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2018-07-05T18:52:15Z","Content":"\n\u003Cp\u003E\nThere are lots of ways to solve this.\u00A0 The trick is to do it in a way which won\u0027t impact the performance of the system.\u00A0 If I start tracking each part, it will get slow very fast.\n\u003C/p\u003E\n\u003Cp\u003E\nBut, I do have the problem identified, and hope to release a working fix in the next day or so\n\u003C/p\u003E\n"}]}