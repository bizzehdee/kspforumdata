{"TopicId":167562,"ForumId":29,"TopicTitle":"Finding building heights from PQS? (Or another way?)","CreatedByName":"MOARdV","CreatedById":60950,"CreatedDateTime":"2017-11-15T14:04:29Z","PageNum":1,"Articles":[{"CreatedByName":"MOARdV","CreatedById":60950,"CreatedDateTime":"2017-11-15T14:04:29Z","Content":"\n\u003Cp\u003E\nI\u0027m working on some code to return terrain height at an arbitrary location.\u00A0 I already know about CelestialBody.pqsController.GetSurfaceHeight, and that works for a first-pass.\u00A0 However, I\u0027d also like to be able to account for buildings / anomalies / whatevers when I am querying.\u00A0 I haven\u0027t really done much with the PQS stuff or the city related code, so I\u0027m not sure where to look.\n\u003C/p\u003E\n\u003Cp\u003E\nNote that this is not necessarily for pinging directly below the vessel - it is for an arbitrary location on the planet which may or may not be in physics range.\u00A0 Otherwise I could use some of the vessel data fields and a physics raycast to find what I need.\n\u003C/p\u003E\n"},{"CreatedByName":"Sigma88","CreatedById":113260,"CreatedDateTime":"2017-11-23T00:19:15Z","Content":"\n\u003Cp\u003E\nI\u0027m interested in this as well since\u00A0\u003Cspan style=\u0022background-color:#ffffff;color:#353c41;font-size:14px;\u0022\u003ECelestialBody.pqsController.GetSurfaceHeight doesn\u0027t work properly anyways\u003C/span\u003E\n\u003C/p\u003E\n"},{"CreatedByName":"Ger_space","CreatedById":167349,"CreatedDateTime":"2017-11-23T05:54:50Z","Content":"\n\u003Cp\u003E\nMaybe you will find an answer on the laserdist code from \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/63481-steven-mading/\u0026amp;do=hovercard\u0022 data-mentionid=\u002263481\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/63481-steven-mading/\u0022 rel=\u0022\u0022\u003E@Steven Mading\u003C/a\u003E\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Sigma88","CreatedById":113260,"CreatedDateTime":"2017-11-23T11:55:28Z","Content":"\n\u003Cp\u003E\n\u003Cspan\u003E\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/63481-steven-mading/\u0026amp;do=hovercard\u0022 data-mentionid=\u002263481\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/63481-steven-mading/\u0022 rel=\u0022\u0022\u003E@Steven Mading\u003C/a\u003E\u00A0I tried looking at the code of laserdist but I got a bit lost, I need to check the altitude of the terrain at a certain lat/lon\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nthis seems like a simpler case compared to your problem since my origin is always the center of the planet so I only really need to input the direction to get my result.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nthe problem is that all the Methods I\u0027ve tried either don\u0027t work or don\u0027t return the correct value. could you give me a couple of pointers so that I can get to the number I\u0027m looking for... thanks \u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"Benjamin Kerman","CreatedById":172792,"CreatedDateTime":"2017-11-24T16:49:19Z","Content":"\n\u003Cp\u003E\nJust cause I\u0027m wondering, could you link the code \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/167349-ger_space/\u0026amp;do=hovercard\u0022 data-mentionid=\u0022167349\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/167349-ger_space/\u0022 rel=\u0022\u0022\u003E@Ger_space\u003C/a\u003E?\n\u003C/p\u003E\n\u003Cp\u003E\nEdit: heres a couple of pointers \u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/113260-sigma88/\u0026amp;do=hovercard\u0022 data-mentionid=\u0022113260\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/113260-sigma88/\u0022 rel=\u0022\u0022\u003E@Sigma88\u003C/a\u003E: *int\u00A0* float\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cimg alt=\u0022:P\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif\u0022 title=\u0022:P\u0022\u003E\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222017-11-24T16:52:14Z\u0022 title=\u002211/24/2017 04:52  PM\u0022 data-short=\u00226 yr\u0022\u003ENovember 24, 2017\u003C/time\u003E by Benjamin Kerman\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2017-11-25T23:08:34Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00223226212\u0022 data-ipsquote-contentid=\u0022167562\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221511438128\u0022 data-ipsquote-userid=\u0022113260\u0022 data-ipsquote-username=\u0022Sigma88\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nOn 11/23/2017 at 5:55 AM, Sigma88 said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\n\u003Cspan\u003E\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/63481-steven-mading/\u0026amp;do=hovercard\u0022 data-mentionid=\u002263481\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/63481-steven-mading/\u0022 rel=\u0022\u0022\u003E@Steven Mading\u003C/a\u003E\u00A0I tried looking at the code of laserdist but I got a bit lost, I need to check the altitude of the terrain at a certain lat/lon\u003C/span\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nthis seems like a simpler case compared to your problem since my origin is always the center of the planet so I only really need to input the direction to get my result.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nDo I understand that all you want is a method that does this?\n\u003C/p\u003E\n\u003Cp\u003E\nGivens:\n\u003C/p\u003E\n\u003Cp\u003E\n- which body\n\u003C/p\u003E\n\u003Cp\u003E\n- latitude\n\u003C/p\u003E\n\u003Cp\u003E\n- longitude\n\u003C/p\u003E\n\u003Cp\u003E\nOutput:\n\u003C/p\u003E\n\u003Cp\u003E\n- Altitude (above seal level) of the terrain at that position on that body.\n\u003C/p\u003E\n\u003Cp\u003E\nIf that\u0027s what you want, then instead of looking at LaserDist, you\u0027re better off examining the code in kOS that implements geocoordinates:terrainheight, which is this method here:\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/KSP-KOS/KOS/blob/develop/src/kOS/Suffixed/GeoCoordinates.cs#L124\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/KSP-KOS/KOS/blob/develop/src/kOS/Suffixed/GeoCoordinates.cs#L124\u003C/a\u003E\n\u003C/p\u003E\n\u003Cp\u003E\nThis is a method of a class in kOS called GeoCoordinates that represents a spot on a world.\u00A0 The class has members: Body, lat, and lng - so the givens are already \u0022in\u0022 the class, and this method just outputs the terrain height of its own spot.\u00A0 I think everything the method is doing is just calls into KSP (instead of calls into other parts of kOS) so you should be able to copy its steps almost verbatim.\n\u003C/p\u003E\n\u003Cp\u003E\nThe problem it\u0027s trying to solve is this:\u00A0 KSP lets you query its PQS system which returns a hypothetical altitude at any given lat/lng by using formulae that return smoothly curving values describing the terrain as a math function.\u00A0 BUT this is only the hypothetical ideal terrain altitude at that spot.\u00A0 In practice once your active vessel gets close to that spot the game will create a mesh of polygons that is only an approximation of this curved surface the PQS result described. (It takes samples from the PQS system to define where the polygon vertexes are.)\u00A0 Depending on how low your terrain detail is set, this could be quite different from what PQS predicted.\n\u003C/p\u003E\n\u003Cp\u003E\nFor most game purposes, you care about the altitude of the actual polygon you could smash into, not the ideal smooth altitude you never get to see that the polygon is approximating.\n\u003C/p\u003E\n\u003Cp\u003E\nSo the method calculates PQS terrain height as good-enough fallback, but before it resorts to returning that, it first tries to refine it further with an actual raycast to find the exact height of the polygon hit at that spot.\u00A0 If the colliders are not present, then the raycast fails and it just has to make do with the PQS hit.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222017-11-25T23:12:12Z\u0022 title=\u002211/25/2017 11:12  PM\u0022 data-short=\u00226 yr\u0022\u003ENovember 25, 2017\u003C/time\u003E by Steven Mading\u003C/strong\u003E\n\u003C/span\u003E\n"}]}