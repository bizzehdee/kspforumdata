{"TopicId":161371,"ForumId":29,"TopicTitle":"VesselModules, PartResources and save sequences","CreatedByName":"Nertea","CreatedById":83952,"CreatedDateTime":"2017-05-31T16:03:01Z","PageNum":1,"Articles":[{"CreatedByName":"Nertea","CreatedById":83952,"CreatedDateTime":"2017-05-31T16:03:01Z","Content":"\n\u003Cp\u003E\nI have a VesselModule that makes some changes to one or more PartResources present on a vessel in response to some changes. I want these changes to be reverted before the game is saved so that those changes don\u0027t make it into the persistence file.\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI can\u0027t quite work out how to do this.\n\u003C/p\u003E\n\u003Cp\u003E\nIn my current attempt, ideally this function should fire before the save sequence starts. It really just reverts the amount and maxAmount of a PartResource to their original values that the VesselModule is storing.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003Eprotected void ClearBufferStorage()\n        {\n           Debug.Log(\u0022Trying to clear buffer storage\u0022);\n          if (bufferStorage != null)\n          {\n              bufferStorage.amount = (double)Mathf.Clamp((float)bufferStorage.amount, 0f, (float)(originalMax));\n            bufferStorage.maxAmount = originalMax;\n\n            Debug.Log(String.Format(\u0022{0}, {1}\u0022, bufferStorage.amount, bufferStorage.maxAmount));\n            \n          }\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nI\u0027ve tried to do this by overriding the OnSave method in VesselModule, simple enough.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E        protected override void OnSave(ConfigNode node)\n        {\n            ClearBufferStorage();\n            base.OnSave(node);\n        }\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nBased on my logging, this should work. The log shows the game being paused, then the\u00A0ClearBufferStorage() being called (the log calls to the PartResource showing the correct 270, 270 that should be preesent), then the save occurring after the storage has been cleared\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003E[LOG 08:52:15.008] Game Paused!\n[LOG 08:52:16.558] Trying to clear buffer storage\n[LOG 08:52:16.558] 270, 270\n[LOG 08:52:16.558] Flight State Captured\n[LOG 08:52:16.559] Saving Achievements Tree...\n[LOG 08:52:16.559] [MessageSystem] Save Messages\n[LOG 08:52:16.560] Trying to clear buffer storage\n[LOG 08:52:16.562] 270, 270\n[LOG 08:52:16.568] Game State Saved to saves/default/persistent\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nHowever, when I inspect the persistence file or reload the game, it turns out that the resource has not been reverted to 270, 270 correctly.\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nAm I not understanding the saving sequence correctly here? This seems like it should work.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222017-05-31T16:03:39Z\u0022 title=\u002205/31/2017 04:03  PM\u0022 data-short=\u00227 yr\u0022\u003EMay 31, 2017\u003C/time\u003E by Nertea\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Nertea","CreatedById":83952,"CreatedDateTime":"2017-05-31T17:18:46Z","Content":"\n\u003Cp\u003E\nI think I found the answer to this. At this stage, updating the amount and maxAmount fields of the PartResource doesn\u0027t correctly serialize to the associated ProtoPartResource. I guess that would happen next tick.\n\u003C/p\u003E\n\u003Cp\u003E\nDirectly setting the fields of the ProtoPartResource appears to successfully reverts the changes.\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222017-05-31T17:18:55Z\u0022 title=\u002205/31/2017 05:18  PM\u0022 data-short=\u00227 yr\u0022\u003EMay 31, 2017\u003C/time\u003E by Nertea\u003C/strong\u003E\n\u003C/span\u003E\n"}]}