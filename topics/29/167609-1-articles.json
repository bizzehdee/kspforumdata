{"TopicId":167609,"ForumId":29,"TopicTitle":"Setting Autopilot.SAS Hold Orientation","CreatedByName":"Kramer","CreatedById":151907,"CreatedDateTime":"2017-11-17T05:05:06Z","PageNum":1,"Articles":[{"CreatedByName":"Kramer","CreatedById":151907,"CreatedDateTime":"2017-11-17T05:05:06Z","Content":"\n\u003Cp\u003E\nI am working on a plugin for docking and am trying to align the current vessel with the docking axis of the target. I am trying to use the vessel Autopilot.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E to do this and so far it does not seem to work.\n\u003C/p\u003E\n\u003Cp\u003E\nIn my FixedUpdate() handler I am first ensuring that it is in StabilityAssist mode:\u003Cbr\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 if (vessel.Autopilot.Mode != VesselAutopilot.AutopilotMode.StabilityAssist)\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 {\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Deb.Log(\u0022Engaging StabilityAssist\u0022);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 vessel.Autopilot.SetMode(VesselAutopilot.AutopilotMode.StabilityAssist);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 sas_orientation_set = false;\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 }\n\u003C/p\u003E\n\u003Cp\u003E\nAnd then calculating a quaternion based on the target zaxis (which is the target transform forward vector) and the target transform up vector:\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Quaternion quat = Quaternion.LookRotation(-zaxis, tgt_tr.up.normalized);\n\u003C/p\u003E\n\u003Cp\u003E\nAnd then setting that if I have not already set it:\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 if (!sas_orientation_set)\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 {\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Deb.Log(\u0022\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E set to quat: {0}\u0022, quat);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 vessel.Autopilot.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E.LockRotation(quat);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 sas_orientation_set = true;\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 }\n\u003C/p\u003E\n\u003Cp\u003E\nI also am printing out the current \u0022lockedRotation\u0022 quant and what I set it to:\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Deb.Log(\u0022currentRotationLock: {0}\u0022, vessel.Autopilot.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E.lockedRotation);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Deb.Log(\u0022desiredRotationLock: {0}\u0022, quat);\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cbr\u003E\nInitially the two values match up, but after a few updates, the lockedRotation value changes to what it was before I set it:\n\u003C/p\u003E\n\u003Cp\u003E\n[LOG 23:42:22.139] [KRAMAX] currentRotationLock: (0.0, -0.6, 0.0, -0.8)\u003Cbr\u003E\n[LOG 23:42:22.139] [KRAMAX] desiredRotationLock: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.140] [KRAMAX] \u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E set to quat: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.163] [KRAMAX] currentRotationLock: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.164] [KRAMAX] desiredRotationLock: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.164] [KRAMAX] \u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E set to quat: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.187] [KRAMAX] currentRotationLock: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.187] [KRAMAX] desiredRotationLock: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.192] [KRAMAX] currentRotationLock: (0.0, -0.6, 0.0, -0.8)\u003Cbr\u003E\n[LOG 23:42:22.193] [KRAMAX] desiredRotationLock: (-0.3, -0.3, 0.2, 0.9)\u003Cbr\u003E\n[LOG 23:42:22.215] [KRAMAX] currentRotationLock: (0.0, -0.6, 0.0, -0.8)\u003Cbr\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nDoes anyone know how to make this work? I would really like to use \u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E to do this and not have to write my own yaw/pitch/roll autopilot or require users to use mechjeb.\n\u003C/p\u003E\n\u003Cp\u003E\n-Thanks, Kramer\n\u003C/p\u003E\n"},{"CreatedByName":"Kramer","CreatedById":151907,"CreatedDateTime":"2017-11-18T05:01:33Z","Content":"\n\u003Cp\u003E\nWell I figured this out, so to answer my own question...\n\u003C/p\u003E\n\u003Cp\u003E\nI think I read in another post that you cannot change the rotation lock my a large amount. Thinking about how it is used via the GUI this makes some sense. It normally keeps the __CURRENT__ orientation when you engage this mode. So I changed the code to gradually shift the rotation lock quaternion from the current position to the desired one. This worked very well.\n\u003C/p\u003E\n\u003Cp\u003E\nHere is code that I came up with that I put in my FixedUpdate() handler:\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 bool sasWasOn = vessel.ActionGroups[KSPActionGroup.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E];\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 vessel.ActionGroups.SetGroup(KSPActionGroup.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E, true);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 vessel.ActionGroups.SetGroup(KSPActionGroup.\u003Cabbr title=\u0022Reaction Control System\u0022\u003ERCS\u003C/abbr\u003E, true);\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 if (vessel.Autopilot.Mode != VesselAutopilot.AutopilotMode.StabilityAssist || !vessel.Autopilot.Enabled || !sasWasOn)\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 {\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 vessel.Autopilot.Enable(VesselAutopilot.AutopilotMode.StabilityAssist);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 sas_orientation_set = false;\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 }\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Quaternion quat = Quaternion.LookRotation(tgt_tr.up.normalized, -zaxis);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Quaternion cquat = vessel.Autopilot.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E.lockedRotation;\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 float angle = Math.Abs(Quaternion.Angle(cquat, quat));\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 //\u00A0really we just want to move like 0.1 degrees per update or something\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 // so to do that we would have fractional amount f: f*angle = 0.1 or f = 0.1/angle\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 if (angle \u0026gt; 0)\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 {\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 float f = 0.1f / angle;\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 Quaternion getting_there = Quaternion.Slerp(cquat, quat, f);\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 vessel.Autopilot.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E.LockRotation(getting_there);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 sas_orientation_set = true;\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 }\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 else if (!sas_orientation_set)\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 {\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 vessel.Autopilot.\u003Cabbr title=\u0022Stability Augmentation System\u0022\u003ESAS\u003C/abbr\u003E.LockRotation(quat);\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 sas_orientation_set = true;\u003Cbr\u003E\n\u00A0 \u00A0 \u00A0 \u00A0 \u00A0 \u00A0 }\u003Cbr\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nHope this may help anyone trying to do the same thing.\n\u003C/p\u003E\n"}]}