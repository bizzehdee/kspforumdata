{"TopicId":83649,"ForumId":29,"TopicTitle":"KSP4X, looking for undocumented event","CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-02T20:49:04Z","PageNum":1,"Articles":[{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-02T20:49:04Z","Content":"\n\u003Cp\u003EHi,\u003C/p\u003E\u003Cp\u003EI am developping a mod that adds an inventory to the game: \u003C/p\u003E\u003Cp\u003EFrom the editor, dragging parts on a button stores them in your inventory.\u003C/p\u003E\u003Cp\u003EAnother button allows you to toggle between the complete part list and the ones currently in your inventory (it works as a filter on the part list).\u003C/p\u003E\u003Cp\u003EPicking a part from your inventory should remove it... but i cannot find any event to help me determine when a part has been clicked in the list.\u003C/p\u003E\u003Cp\u003EAlternatively knowing when a part was dropped in the VAB background (unattached) could also do the trick.\u003C/p\u003E\u003Cp\u003EHas anyone seen such events? or can you think or a workaround?\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-09-02T22:33:10Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022SiriusSam\u0022 data-cite=\u0022SiriusSam\u0022\u003E\u003Cdiv\u003EPicking a part from your inventory should remove it... but i cannot find any event to help me determine when a part has been clicked in the list.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EAssuming you\u0027re talking about the stock editor part list and not some other list that\u0027s part of your inventory, the simplest way is to modify the prefab that gets used to create each part button. This should get you off the ground:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E[KSPAddon(KSPAddon.Startup.EditorAny, false)]\u003Cbr\u003Eclass EditPartListPrefab : MonoBehaviour\u003Cbr\u003E{\u003Cbr\u003E    class ClickListener : MonoBehaviour\u003Cbr\u003E    {\u003Cbr\u003E        AvailablePart myPart;\u003Cbr\u003E        EditorPartIcon icon;\u003Cbr\u003E        bool mouseFlag = false;\u003Cbr\u003E\u003Cbr\u003E        void Start()\u003Cbr\u003E        {\u003Cbr\u003E            GetComponent\u0026lt;UIButton\u0026gt;().AddValueChangedDelegate(OnClick);\u003Cbr\u003E            GetComponent\u0026lt;UIButton\u0026gt;().AddInputDelegate(OnInput);\u003Cbr\u003E            myPart = GetComponent\u0026lt;EditorPartIcon\u0026gt;().partInfo;\u003Cbr\u003E            icon = GetComponent\u0026lt;EditorPartIcon\u0026gt;();\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        void OnClick(IUIObject obj)\u003Cbr\u003E        {\u003Cbr\u003E            print(\u0022User clicked \u0022 \u002B myPart.partPrefab.name);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        void OnInput(ref POINTER_INFO ptr)\u003Cbr\u003E        {\u003Cbr\u003E            switch (ptr.evt)\u003Cbr\u003E            {\u003Cbr\u003E                case POINTER_INFO.INPUT_EVENT.MOVE:\u003Cbr\u003E                    if (!mouseFlag)\u003Cbr\u003E                    {\u003Cbr\u003E                        mouseFlag = true;\u003Cbr\u003E                        print(\u0022User moused over \u0022 \u002B myPart.partPrefab.name);\u003Cbr\u003E                    }\u003Cbr\u003E                    break;\u003Cbr\u003E                case POINTER_INFO.INPUT_EVENT.MOVE_OFF:\u003Cbr\u003E                    mouseFlag = false;\u003Cbr\u003E                    break;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    void Start()\u003Cbr\u003E    {\u003Cbr\u003E        EditorPartList.Instance.iconPrefab.gameObject.AddComponent\u0026lt;ClickListener\u0026gt;();\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-02T22:42:50Z","Content":"\n\u003Cp\u003Ewow thanks!\u003C/p\u003E\u003Cp\u003EI\u0027ll try this first thing tomorrow.\u003C/p\u003E\n"},{"CreatedByName":"pellinor","CreatedById":85299,"CreatedDateTime":"2014-09-02T23:20:35Z","Content":"\n\u003Cp\u003EI would only count parts attached to the current vessel. The transparent stuff in the editor might behave in unexpected ways, like multiplying when symmetry mode changes. Just imagine dragging a subassembly including a \u0027one of a kind\u0027 part around. As you pass over a part with symmetry, the editor decides to spontaneously switch to 4x symmetry, and the assembly vanishes because you do not have enough parts. \u003C/p\u003E\u003Cp\u003EAlso, when dragging parts around you\u0027d have to be sure to cover any way such a part could vanish (including gui glitches, other mods or whatever), because you need to put it back into the inventory. The current vessel on the other hand should always provide a list of its parts, so keeping things consistent is much easier. \u003C/p\u003E\u003Cp\u003EDiagnostic calculations like mechjeb\u0027s delta-v are done whenever attaching a new part. This also gives the ability to set parts of the vessel aside to exclude them from the calculation. It would be quite tedious if I need to remove a complete lifter from the editor in order to see the stats of its payload. That is probably the main point why I would consider transparent parts as non-existent.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-09-02T23:30:29Z\u0022 title=\u002209/02/2014 11:30  PM\u0022 data-short=\u00229 yr\u0022\u003ESeptember 2, 2014\u003C/time\u003E by pellinor\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-03T09:46:00Z","Content":"\n\u003Cp\u003E@xEvilReaperx\u003C/p\u003E\u003Cp\u003EThanks, it worked like a charm. Any idea how i could display a number in those icons? XD\u003C/p\u003E\u003Cp\u003E@pellinor\u003C/p\u003E\u003Cp\u003EHi,\u003C/p\u003E\u003Cp\u003EIt actually works the way you described, but i ran into a little problem.\u003C/p\u003E\u003Cp\u003EParts are stored when dropped onto the \u0022inventory\u0022 button.\u003C/p\u003E\u003Cp\u003EParts are removed from inventory when something gets attached to the ship.\u003C/p\u003E\u003Cp\u003ESo, the player can drag a part directly from the inventorylist to the store button..... which clones it.\u003C/p\u003E\u003Cp\u003EI could hide the \u0022store\u0022 button while inventory is active, but then the player must toggle back to factory to store legit ship parts...\u003C/p\u003E\u003Cp\u003EI\u0027ll try to use the click event as a way of finding out where this part came from.\u003C/p\u003E\u003Cp\u003E------\u003C/p\u003E\u003Cp\u003EAn alternative is to store anything that is \u0022detached\u0022 from the ship.... but the ergonomy is terribly counter intuitive...\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-09-03T10:02:48Z\u0022 title=\u002209/03/2014 10:02  AM\u0022 data-short=\u00229 yr\u0022\u003ESeptember 3, 2014\u003C/time\u003E by SiriusSam\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-03T12:14:32Z","Content":"\n\u003Cp\u003ESource code and prototype can be found in this thread:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/89942-Kerbal-4X-inventory-and-scavenging\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://forum.kerbalspaceprogram.com/threads/89942-Kerbal-4X-inventory-and-scavenging\u003C/a\u003E\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-09-03T12:46:03Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022SiriusSam\u0022 data-cite=\u0022SiriusSam\u0022\u003E\u003Cdiv\u003E@xEvilReaperx\u003Cp\u003EThanks, it worked like a charm. Any idea how i could display a number in those icons? XD\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EYou can put whatever you\u0027d like in there. Here\u0027s a basic bug-filled (lots of edge cases need to be solved) version of what you want:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E[KSPAddon(KSPAddon.Startup.EditorAny, false)]\u003Cbr\u003Eclass EditPartListPrefab : MonoBehaviour\u003Cbr\u003E{\u003Cbr\u003E    class ClickListener : MonoBehaviour\u003Cbr\u003E    {\u003Cbr\u003E        AvailablePart myPart;\u003Cbr\u003E        EditorPartIcon icon;\u003Cbr\u003E        SpriteText text;\u003Cbr\u003E        int amount = 0;\u003Cbr\u003E        bool mouseFlag = false;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        void Start()\u003Cbr\u003E        {\u003Cbr\u003E            GetComponent\u0026lt;UIButton\u0026gt;().AddValueChangedDelegate(OnClick);\u003Cbr\u003E            GetComponent\u0026lt;UIButton\u0026gt;().AddInputDelegate(OnInput);\u003Cbr\u003E            myPart = GetComponent\u0026lt;EditorPartIcon\u0026gt;().partInfo;\u003Cbr\u003E            icon = GetComponent\u0026lt;EditorPartIcon\u0026gt;();\u003Cbr\u003E            text = transform.Find(\u0022CounterLabel\u0022).GetComponent\u0026lt;SpriteText\u0026gt;();\u003Cbr\u003E\u003Cbr\u003E            amount = EditPartListPrefab.Instance.GetPartQuantity(myPart);\u003Cbr\u003E            UpdateCounter();\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        void OnClick(IUIObject obj)\u003Cbr\u003E        {\u003Cbr\u003E            print(\u0022User clicked \u0022 \u002B myPart.partPrefab.name);\u003Cbr\u003E\u003Cbr\u003E            if (amount \u0026gt; 0)\u003Cbr\u003E            {\u003Cbr\u003E                --amount;\u003Cbr\u003E                EditPartListPrefab.Instance.SetPartQuantity(myPart, amount);\u003Cbr\u003E                UpdateCounter();\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        void UpdateCounter()\u003Cbr\u003E        {\u003Cbr\u003E            text.Text = amount.ToString();\u003Cbr\u003E\u003Cbr\u003E            if (amount == 0)\u003Cbr\u003E                icon.SetGrey(\u0022Ran out of this item\u0022);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        void OnInput(ref POINTER_INFO ptr)\u003Cbr\u003E        {\u003Cbr\u003E            switch (ptr.evt)\u003Cbr\u003E            {\u003Cbr\u003E                case POINTER_INFO.INPUT_EVENT.MOVE:\u003Cbr\u003E                    if (!mouseFlag)\u003Cbr\u003E                    {\u003Cbr\u003E                        mouseFlag = true;\u003Cbr\u003E                        print(\u0022User moused over \u0022 \u002B myPart.partPrefab.name);\u003Cbr\u003E                    }\u003Cbr\u003E                    break;\u003Cbr\u003E                case POINTER_INFO.INPUT_EVENT.MOVE_OFF:\u003Cbr\u003E                    mouseFlag = false;\u003Cbr\u003E                    break;\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E    public static EditPartListPrefab Instance { private set; get; }\u003Cbr\u003E    private Dictionary\u0026lt;AvailablePart, int\u0026gt; quantities = new Dictionary\u0026lt;AvailablePart, int\u0026gt;();\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E    int GetPartQuantity(AvailablePart part)\u003Cbr\u003E    {\u003Cbr\u003E        return quantities[part];\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    void SetPartQuantity(AvailablePart part, int qty)\u003Cbr\u003E    {\u003Cbr\u003E        quantities[part] = qty;\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E    void Start()\u003Cbr\u003E    {\u003Cbr\u003E        Instance = this;\u003Cbr\u003E\u003Cbr\u003E        // edit icon prefab\u003Cbr\u003E        var iconPrefab = EditorPartList.Instance.iconPrefab.gameObject;\u003Cbr\u003E\u003Cbr\u003E        if (iconPrefab.GetComponent\u0026lt;ClickListener\u0026gt;() == null)\u003Cbr\u003E        {\u003Cbr\u003E            iconPrefab.AddComponent\u0026lt;ClickListener\u0026gt;();\u003Cbr\u003E\u003Cbr\u003E            GameObject labelHolder = new GameObject(\u0022CounterLabel\u0022);\u003Cbr\u003E            var label = labelHolder.AddComponent\u0026lt;SpriteText\u0026gt;();\u003Cbr\u003E            label.RenderCamera = Camera.allCameras.Where(c =\u0026gt; (c.cullingMask \u0026amp; (1 \u0026lt;\u0026lt; labelHolder.layer)) != 0).Single();\u003Cbr\u003E\u003Cbr\u003E            labelHolder.layer = LayerMask.NameToLayer(\u0022EzGUI_UI\u0022);\u003Cbr\u003E            labelHolder.transform.parent = iconPrefab.transform;\u003Cbr\u003E            labelHolder.transform.localPosition = Vector3.zero;\u003Cbr\u003E            labelHolder.transform.Translate(new Vector3(EditorPartList.Instance.iconSize * 0.35f, EditorPartList.Instance.iconSize * -0.425f, label.RenderCamera.nearClipPlane - labelHolder.transform.position.z - 1f), Space.Self);\u003Cbr\u003E\u003Cbr\u003E            label.Text = \u0022[count]\u0022;\u003Cbr\u003E            label.alignment = SpriteText.Alignment_Type.Right;\u003Cbr\u003E            label.font = UIManager.instance.defaultFont;\u003Cbr\u003E            label.renderer.sharedMaterial = UIManager.instance.defaultFontMaterial;\u003Cbr\u003E            label.SetColor(Color.white);\u003Cbr\u003E            label.SetAnchor(SpriteText.Anchor_Pos.Lower_Right);\u003Cbr\u003E            label.SetCharacterSize(12f);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        // generate some random quantity for each part\u003Cbr\u003E        PartLoader.LoadedPartsList.ForEach(ap =\u0026gt; quantities.Add(ap, UnityEngine.Random.Range(0, 15)));\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-06T09:14:46Z","Content":"\n\u003Cp\u003EHello,\u003C/p\u003E\u003Cp\u003EI implemented the counters. I just have a little bug :\u003C/p\u003E\u003Cp\u003EWhen the VAB gets reloaded i get a lot of nullpointer exceptions. This disappears if i stop adding the click listener (but of course the counters don\u0027t update...).\u003C/p\u003E\u003Cp\u003EI suppose the events don\u0027t get deleted, but i can\u0027t manage to fix it.\u003C/p\u003E\u003Cp\u003EHere is the source and DLL:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://3dstudios.fr/KSP4X/KSP4X.zip\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://3dstudios.fr/KSP4X/KSP4X.zip\u003C/a\u003E\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-09-06T15:49:01Z","Content":"\n\u003Cp\u003EA lil bug in my logic \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 alt=\u0022;)\u0022\u003E Change the prefab editor start method to this:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Evoid Start()\u003Cbr\u003E{\u003Cbr\u003E    Debug.Log(\u0022Start EditPartListPrefab\u0022);\u003Cbr\u003E\u003Cbr\u003E    // edit icon prefab\u003Cbr\u003E    var iconPrefab = EditorPartList.Instance.iconPrefab.gameObject;\u003Cbr\u003E\u003Cbr\u003E    if (iconPrefab.GetComponent\u0026lt;ClickListener\u0026gt;() == null)\u003Cbr\u003E    {\u003Cbr\u003E        GameObject labelHolder = new GameObject(\u0022CounterLabel\u0022);\u003Cbr\u003E        var label = labelHolder.AddComponent\u0026lt;SpriteText\u0026gt;();\u003Cbr\u003E        labelHolder.layer = LayerMask.NameToLayer(\u0022EzGUI_UI\u0022);\u003Cbr\u003E        label.RenderCamera = Camera.allCameras.Where(c =\u0026gt; (c.cullingMask \u0026amp; (1 \u0026lt;\u0026lt; labelHolder.layer)) != 0).Single();\u003Cbr\u003E        labelHolder.transform.parent = iconPrefab.transform;\u003Cbr\u003E        labelHolder.transform.localPosition = Vector3.zero;\u003Cbr\u003E        labelHolder.transform.Translate(new Vector3(EditorPartList.Instance.iconSize * 0.35f, EditorPartList.Instance.iconSize * -0.425f, label.RenderCamera.nearClipPlane - labelHolder.transform.position.z - 1f), Space.Self);\u003Cbr\u003E        label.Text = \u0022[count]\u0022;\u003Cbr\u003E        label.alignment = SpriteText.Alignment_Type.Right;\u003Cbr\u003E        label.font = UIManager.instance.defaultFont;\u003Cbr\u003E        label.renderer.sharedMaterial = UIManager.instance.defaultFontMaterial;\u003Cbr\u003E        label.SetColor(Color.white);\u003Cbr\u003E        label.SetAnchor(SpriteText.Anchor_Pos.Lower_Right);\u003Cbr\u003E        label.SetCharacterSize(12f);\u003Cbr\u003E        DontDestroyOnLoad(labelHolder);\u003Cbr\u003E\u003Cbr\u003E        iconPrefab.AddComponent\u0026lt;ClickListener\u0026gt;();\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-09-06T18:30:57Z\u0022 title=\u002209/06/2014 06:30  PM\u0022 data-short=\u00229 yr\u0022\u003ESeptember 6, 2014\u003C/time\u003E by xEvilReeperx\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-06T18:16:01Z","Content":"\n\u003Cp\u003EThanks a lot, all nasty red messages are gone!\u003C/p\u003E\u003Cp\u003EIf by any chance you know how to get the Ship currently on the assembly line... (i must remove the parts from the catalog when the user enters the VAB). Problem is i can\u0027t find the Vessel... only its name (ShipAssembly.currentShipName).\u003C/p\u003E\u003Cp\u003EBeen foraging a lot in the DLL definition but with no luck so far.\u003C/p\u003E\u003Cp\u003EI think i have taken care of most of the other problems.\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-09-06T18:24:10Z","Content":"\n\u003Cp\u003EYou don\u0027t deal with a Vessel in the editor; you\u0027re looking for ShipConstruct which you can find in EditorLogic.fetch.ship\u003C/p\u003E\n"},{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-06T19:06:23Z","Content":"\n\u003Cp\u003Edammit.. i thought i had tried all the variables in EditorLogic \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EThanks again, going to pack this up right away!\u003C/p\u003E\n"},{"CreatedByName":"SiriusSam","CreatedById":116426,"CreatedDateTime":"2014-09-06T23:16:52Z","Content":"\n\u003Cp\u003EDone. Loopholes have almost all been plugged!\u003C/p\u003E\u003Cp\u003ENow I must persist this in the savegame instead of config file..\u003C/p\u003E\n"}]}