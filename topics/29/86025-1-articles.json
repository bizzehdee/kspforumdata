{"TopicId":86025,"ForumId":29,"TopicTitle":"HELP! Why won\u0026#039;t InputLockManager lock out the \u0026quot;X\u0026quot; key?","CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2014-10-04T00:27:14Z","PageNum":1,"Articles":[{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2014-10-04T00:27:14Z","Content":"\n\u003Cp\u003EIn the kOS mod, we respond to keypresses when our terminal window is focused. But one frustrating thing is that even when the window is focused, KSP itself still gets first dibs on the \u0027X\u0027 key and it uses it to kill the throttle before allowing the keypress to pass through to our mod. So while someone *can* type a command like \u0022SET X TO 1.\u0022 in the terminal and it works, doing so will have the side effect of killing the throttle when they get to the \u0022X\u0022 key. Currently this only seems to happen with the \u0022X\u0022 key and no others. If the user types \u0022SET WASD TO 1.\u0022, then the \u0022WASD\u0022 part has no effect on the piloting, as we\u0027d prefer, and the spaces don\u0027t cause staging, and so on. Only the \u0022X\u0022 key has this problem because it seems KSP is doing something different with it than it does with all the other piloting keys.\u003C/p\u003E\u003Cp\u003EUntil now this has been just slightly annoying. But there\u0027s rumors that soon the \u0022Z\u0022 key will go full throttle in stock, and if that\u0027s true then this same behavior would really screw us up big time there if SQUAD implements the \u0022Z\u0022 key the same way they\u0027ve implemented the \u0022X\u0022 key (which seems likely). So we need to find a solution before 0.25 is out.\u003C/p\u003E\u003Cp\u003EAny ideas?\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-10-05T05:08:04Z\u0022 title=\u002210/05/2014 05:08  AM\u0022 data-short=\u00229 yr\u0022\u003EOctober 5, 2014\u003C/time\u003E by Steven Mading\u003C/strong\u003E\n\u003Cbr\u003Echange title to reflect newer information.\n\u003C/span\u003E\n"},{"CreatedByName":"ratchet freak","CreatedById":119895,"CreatedDateTime":"2014-10-04T13:29:25Z","Content":"\n\u003Cp\u003Eunbind the key temporarily?\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-10-04T15:55:19Z","Content":"\n\u003Cp\u003EI would look at the inputlockmanager class, you can lock parts of the game so they don\u0027t accept inputs while locked.\u003C/p\u003E\u003Cp\u003EThere is a list of which parts can be locked on the forum somethwere but my google skills are failing me at the moment.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\u003Cp\u003Eedit: \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/7544-The-official-unoffical-help-a-fellow-plugin-developer-thread?p=1381378\u0026amp;viewfull=1#post1381378\u0022 rel=\u0022external nofollow\u0022\u003EFound it here.\u003C/a\u003E\u003C/p\u003E\u003Cp\u003ESo something like:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E//on textbox gain focus:\u003Cbr\u003EInputLockManager.SetControlLock(ControlTypes.THROTTLE, \u0022YourControlLock\u0022);\u003Cbr\u003E\u003Cbr\u003E//on textbox lose focus:\u003Cbr\u003EInputLockManager.RemoveControlLock(\u0022YourControlLock\u0022);\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EI used to use the unbind key temporarily method in AGX, but switched to inputlock manager because it is so much simpler and have had no problems with it.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-10-04T16:02:33Z\u0022 title=\u002210/04/2014 04:02  PM\u0022 data-short=\u00229 yr\u0022\u003EOctober 4, 2014\u003C/time\u003E by Diazo\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2014-10-05T05:13:04Z","Content":"\n\u003Cp\u003EOkay, now I\u0027ve used the ALT-F12 debug menu to view the lock being created by the terminal.\u003C/p\u003E\u003Cp\u003EThis is the code that does the lock - it\u0027s just trying to lock ALL things:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003EInputLockManager.SetControlLock(\u0022kOSTerminal\u0022);\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EAnd yet, it still doesn\u0027t lock the \u0022X\u0022 key out. \u0022X\u0022 still gets seen by KSP and kills the throttle before KOS ever sees it. No other keys have this problem.\u003C/p\u003E\u003Cp\u003EHere\u0027s the screenshot showing the input locks - note all the bits are set to 1:\u003C/p\u003E\u003Cp\u003E\u003Cimg src=\u0022http://i.imgur.com/0ZsC1rO.png\u0022 alt=\u00220ZsC1rO.png\u0022\u003E\u003C/p\u003E\u003Cp\u003EAnd it still killed the throttle when I typed \u0022X\u0022.\u003C/p\u003E\u003Cp\u003EIf \u0022Z\u0022 gets implemented the same way \u0022X\u0022 was, then this will ruin our mod when 0.25 comes out. Help! I\u0027ve seem other mods that allow you to type \u0022X\u0022 and it doesn\u0027t kill throttle. How?? is there no way to do it unless you use a Unity GUI textbox? That\u0027s going to be a problem since we\u0027re trying to manipulate the terminal manually and can\u0027t let Unity\u0027s textbox do the work.\u003C/p\u003E\n"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2014-10-05T06:43:06Z","Content":"\n\u003Cp\u003EWell, the Game settings keybindings kludge does seem to work, I\u0027m still trying to figure out why I have to resort to it. It\u0027s an ugly hack and it seems like it\u0027s a band-aid around something in the API that feels a bit broken.\u003C/p\u003E\u003Cp\u003ESpecifically, the game settings hack is to change the user\u0027s key bindings from the Settings screen temporarily, then put it back to whatever it was later.\u003C/p\u003E\u003Cp\u003ELike so:\u003C/p\u003E\u003Cp\u003EWhen the terminal window gains focus:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    rememberThrottleCutoffKey = GameSettings.THROTTLE_CUTOFF;\u003Cbr\u003E    GameSettings.THROTTLE_CUTOFF = new KeyBinding(KeyCode.None);\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EWhen the terminal window loses focus:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    if (rememberThrottleCutoffKey != null)\u003Cbr\u003E        GameSettings.THROTTLE_CUTOFF = rememberThrottleCutoffKey;\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThis hack works. It just seems like it shouldn\u0027t be necessary. All the *other* keys get trapped properly by normal Unity GUI widgetry, just not \u0022X\u0022.\u003C/p\u003E\n"},{"CreatedByName":"Diazo","CreatedById":81549,"CreatedDateTime":"2014-10-05T13:49:47Z","Content":"\n\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003EInputLockManager.SetControlLock(\u0022kOSTerminal\u0022);\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Edoes lock everything, including the Throttle. To lock only a part of the interface you need the 2 variable method:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003EInputLockManager.SetControlLock(ControlTypes.THROTTLE, \u0022kOSTerminalThrottle\u0022);\u003C/pre\u003E\u003Cp\u003E will lock out the throttle.\u003C/p\u003E\u003Cp\u003EWhich does not explain the X key still being registered while your input lock is in effect, that does feel like an oversight to me.\u003C/p\u003E\u003Cp\u003EWell, that\u0027s all I have for you on InputManager.\u003C/p\u003E\u003Cp\u003EOn the keybinding thing, ensure that the losing focus code runs when exiting a non-standard way. (ESC key to bring up menu, leaving Flight scene with focus on the text box, etc.) If the player can make it to the settings screen somehow without the unfocus code running, the key will be unbound in the settings file and the player will have to reassign it. I don\u0027t know if the in-flight settings screen is sufficient or you have to go to the Main Menu settings screen to run into this but it was my biggest headache when I was using that method.\u003C/p\u003E\u003Cp\u003EI don\u0027t know if this will actually be an issue for you, I was using it a lot more then you are (my rebind Key was running in the OnDisable method), but it is something to watch for.\u003C/p\u003E\u003Cp\u003ED.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-10-05T14:00:01Z\u0022 title=\u002210/05/2014 02:00  PM\u0022 data-short=\u00229 yr\u0022\u003EOctober 5, 2014\u003C/time\u003E by Diazo\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2014-10-06T02:08:15Z","Content":"\n\u003Cp\u003EI strongly suspect that the reason the \u0022X\u0022 key is handled differently is in some way related to the fact that you can use it from the Map View even when the navball isn\u0027t showing. (Normally to use ship controls from the map view, you need to enable the navball tab on the map first. But the \u0022X\u0022 key will kill throttle from anywhere, anywhen, as an emergency measure.) To do that SQUAD had to keep the \u0022X\u0022 key out of the ControlTypes.THROTTLE set of keys, but then they appear to have forgotten to include some other control flag somewhere that does include it. It seems to be utterly outside of any of the ControlType bitflags.\u003C/p\u003E\n"}]}