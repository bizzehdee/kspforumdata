{"TopicId":64627,"ForumId":29,"TopicTitle":"[SOLVED] Backup/Restore tech tree and experiments","CreatedByName":"nadvornm","CreatedById":6613,"CreatedDateTime":"2014-03-01T17:21:04Z","PageNum":1,"Articles":[{"CreatedByName":"nadvornm","CreatedById":6613,"CreatedDateTime":"2014-03-01T17:21:04Z","Content":"\n\u003Cp\u003EHi all,\u003C/p\u003E\u003Cp\u003EI\u0027m looking for a way to backup and restore the tech tree and the experiment history. I know it is possible to get that data from the persistent.sfs file. However I need a method to get and also restore the data while KSP is running.\u003C/p\u003E\u003Cp\u003EWhat I tried so far is using ResearchAndDevelopment.Instance:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003EResearchAndDevelopment rdinstance;\u003Cbr\u003E//Backup\u003Cbr\u003Erdinstance = ResearchAndDevelopment.Instance\u003Cbr\u003E//Restore\u003Cbr\u003EResearchAndDevelopment.Instance = rdinstance\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EHowever it didn\u0027t work. Unfortunately I didn\u0027t find any projects that are accessing the R\u0026amp;D data in a way I would like to do.\u003C/p\u003E\u003Cp\u003EAny help would be appreciated!\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222014-03-01T21:56:37Z\u0022 title=\u002203/01/2014 09:56  PM\u0022 data-short=\u002210 yr\u0022\u003EMarch 1, 2014\u003C/time\u003E by nadvornm\u003C/strong\u003E\n\u003Cbr\u003Eproblem solved\n\u003C/span\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-03-01T17:50:29Z","Content":"\n\u003Cp\u003ER\u0026amp;D.Instance might not be available until a few frames have passed, so work in some way of waiting for it to exist before trying to use it. If you\u0027re really lucky, you might be able to get the game to do your heavy lifting for you by calling R\u0026amp;D.OnLoad/OnSave yourself. Otherwise, here\u0027s an example snippet that unlocks any parts that haven\u0027t been \u0022bought\u0022 in tech nodes that have been unlocked. It might give you some ideas:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eforeach (var part in PartLoader.LoadedPartsList)\u003Cbr\u003E{\u003Cbr\u003E    var techNode = ResearchAndDevelopment.Instance.GetTechState(part.TechRequired);\u003Cbr\u003E\u003Cbr\u003E    if (techNode != null)\u003Cbr\u003E        if (ResearchAndDevelopment.GetTechnologyState(techNode.techID) == RDTech.State.Available)\u003Cbr\u003E            if (!ResearchAndDevelopment.PartModelPurchased(part) \u0026amp;\u0026amp; !techNode.partsPurchased.Contains(part))\u003Cbr\u003E            {\u003Cbr\u003E                techNode.partsPurchased.Add(part);\u003Cbr\u003E                ResearchAndDevelopment.Instance.SetTechState(techNode.techID, techNode);\u003Cbr\u003E            }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"notfirestorm","CreatedById":66483,"CreatedDateTime":"2014-03-01T18:14:45Z","Content":"\n\u003Cp\u003EI think the problem you\u0027re running into is the old Reference vs. Value problem. Short version is, I think the \u0027ResearchAndDevelopment.Instance\u0027 is just returning a reference to the data you\u0027re trying to save, a memory pointer. Saving the reference doesn\u0027t do what you\u0027re hoping to, since someone else can change the values in that area of memory. You\u0027ll need to dig through that object to find \u0026amp; copy all the values you\u0027re interested in (and set those values back when you want to restore).\u003C/p\u003E\n"},{"CreatedByName":"nadvornm","CreatedById":6613,"CreatedDateTime":"2014-03-01T18:22:05Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022 data-cite=\u0022xEvilReeperx\u0022\u003E\u003Cdiv\u003ER\u0026amp;D.Instance might not be available until a few frames have passed, so work in some way of waiting for it to exist before trying to use it. If you\u0027re really lucky, you might be able to get the game to do your heavy lifting for you by calling R\u0026amp;D.OnLoad/OnSave yourself. Otherwise, here\u0027s an example snippet that unlocks any parts that haven\u0027t been \u0022bought\u0022 in tech nodes that have been unlocked. It might give you some ideas:\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eforeach (var part in PartLoader.LoadedPartsList)\u003Cbr\u003E{\u003Cbr\u003E    var techNode = ResearchAndDevelopment.Instance.GetTechState(part.TechRequired);\u003Cbr\u003E\u003Cbr\u003E    if (techNode != null)\u003Cbr\u003E        if (ResearchAndDevelopment.GetTechnologyState(techNode.techID) == RDTech.State.Available)\u003Cbr\u003E            if (!ResearchAndDevelopment.PartModelPurchased(part) \u0026amp;\u0026amp; !techNode.partsPurchased.Contains(part))\u003Cbr\u003E            {\u003Cbr\u003E                techNode.partsPurchased.Add(part);\u003Cbr\u003E                ResearchAndDevelopment.Instance.SetTechState(techNode.techID, techNode);\u003Cbr\u003E            }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThanks for your reply xEvilReeperx. As I not only need to purchase the parts but also really unlock the tech nodes it is not enough to just iterate through the parts and purchase them. So I will try to use the OnLoad and OnSave methods. However the methods take a ConfigNode as parameter. Can you give me a hint on how to call the methods and where to get the ConfigNode parameter from? Unfortunately I\u0027m not a very experienced programmer...\u003C/p\u003E\n"},{"CreatedByName":"nadvornm","CreatedById":6613,"CreatedDateTime":"2014-03-01T18:27:24Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022notfirestorm\u0022 data-cite=\u0022notfirestorm\u0022\u003E\u003Cdiv\u003EI think the problem you\u0027re running into is the old Reference vs. Value problem. Short version is, I think the \u0027ResearchAndDevelopment.Instance\u0027 is just returning a reference to the data you\u0027re trying to save, a memory pointer. Saving the reference doesn\u0027t do what you\u0027re hoping to, since someone else can change the values in that area of memory. You\u0027ll need to dig through that object to find \u0026amp; copy all the values you\u0027re interested in (and set those values back when you want to restore).\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EOkay now I understand why it was not working. However I can see the methods GetExperiment(string) and GetTechnologyState(string) but for setting the values there is only SetTechState(string, ProtoTechNode) but no mehtod for setting the experiments. So if there\u0027s someone who could tell me how to put an experiment into the R\u0026amp;D instance I would be very lucky\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-03-01T18:38:03Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022nadvornm\u0022 data-cite=\u0022nadvornm\u0022\u003E\u003Cdiv\u003EOkay now I understand why it was not working. However I can see the methods GetExperiment(string) and GetTechnologyState(string) but for setting the values there is only SetTechState(string, ProtoTechNode) but no mehtod for setting the experiments. So if there\u0027s someone who could tell me how to put an experiment into the R\u0026amp;D instance I would be very lucky\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EYou\u0027re looking for ScienceSubjects, data that comes as a result of performing experiments\u003C/p\u003E\n"},{"CreatedByName":"nadvornm","CreatedById":6613,"CreatedDateTime":"2014-03-01T18:43:17Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022 data-cite=\u0022xEvilReeperx\u0022\u003E\u003Cdiv\u003EYou\u0027re looking for ScienceSubjects, data that comes as a result of performing experiments\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EWell I know I need ScienceSubject. It is also returned from R\u0026amp;D\u0027s GetExperiment() method. But my question is how to restore a ScienceSubject once I have saved it\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-03-01T20:20:23Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022nadvornm\u0022 data-cite=\u0022nadvornm\u0022\u003E\u003Cdiv\u003EWell I know I need ScienceSubject. \u003Cstrong\u003EIt is also returned from R\u0026amp;D\u0027s GetExperiment() method\u003C/strong\u003E. But my question is how to restore a ScienceSubject once I have saved it\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EGetExperiment() returns ScienceExperiment. You could use the ScienceExperiment to get a ScienceSubject related to a particular experiment, but your case doesn\u0027t seem interested in specific subject \u002B experiment \u002B situation \u002B body combinations.\u003C/p\u003E\u003Cp\u003ESubmitScienceData seems likely to me. Assuming OnSave/OnLoad didn\u0027t work for you?\u003C/p\u003E\n"},{"CreatedByName":"nadvornm","CreatedById":6613,"CreatedDateTime":"2014-03-01T20:27:21Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022nadvornm\u0022 data-cite=\u0022nadvornm\u0022\u003E\u003Cdiv\u003ECan you give me a hint on how to call the methods and where to get the ConfigNode parameter from? Unfortunately I\u0027m not a very experienced programmer...\u003C/div\u003E\u003C/blockquote\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022 data-cite=\u0022xEvilReeperx\u0022\u003E\u003Cdiv\u003EGetExperiment() returns ScienceExperiment. You could use the ScienceExperiment to get a ScienceSubject related to a particular experiment, but your case doesn\u0027t seem interested in specific subject \u002B experiment \u002B situation \u002B body combinations.\u003Cp\u003ESubmitScienceData seems likely to me. Assuming OnSave/OnLoad didn\u0027t work for you?\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EWell I didn\u0027t try OnSave/Load. As I already said I don\u0027t know how to call the methods. It would be nice if you could explain it to me \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-03-01T21:49:35Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022nadvornm\u0022 data-cite=\u0022nadvornm\u0022\u003E\u003Cdiv\u003EWell I didn\u0027t try OnSave/Load. As I already said I don\u0027t know how to call the methods. It would be nice if you could explain it to me \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EOnSave/OnLoad seem to work, you should use those (after modifying R\u0026amp;D). Use OnLoad with an empty ConfigNode to load an initial state.\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022nadvornm\u0022 data-cite=\u0022nadvornm\u0022\u003E\u003Cdiv\u003EWell I didn\u0027t try OnSave/Load. As I already said I don\u0027t know how to call the methods. It would be nice if you could explain it to me \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EMost of the time you\u0027ll just have to experiment. I will help you on this one but that\u0027s it. \u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Evar saveRnd = new ConfigNode();\u003Cbr\u003EResearchAndDevelopment.Instance.OnSave(saveRnd);\u003Cbr\u003EDebug.Log(saveRnd.ToString());\u003Cbr\u003EResearchAndDevelopment.Instance.OnLoad(new ConfigNode()); // reset tech tree\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"nadvornm","CreatedById":6613,"CreatedDateTime":"2014-03-01T21:54:01Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022 data-cite=\u0022xEvilReeperx\u0022\u003E\u003Cdiv\u003EOnSave/OnLoad seem to work, you should use those (after modifying R\u0026amp;D). Use OnLoad with an empty ConfigNode to load an initial state.\u003Cp\u003EMost of the time you\u0027ll just have to experiment. I will help you on this one but that\u0027s it. \u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Evar saveRnd = new ConfigNode();\u003Cbr\u003EResearchAndDevelopment.Instance.OnSave(saveRnd);\u003Cbr\u003EDebug.Log(saveRnd.ToString());\u003Cbr\u003EResearchAndDevelopment.Instance.OnLoad(new ConfigNode()); // reset tech tree\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EWorked perfectly. Thanks a lot!\u003C/p\u003E\n"}]}