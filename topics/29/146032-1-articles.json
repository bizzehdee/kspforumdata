{"TopicId":146032,"ForumId":29,"TopicTitle":"QuaternionD.LookRotation MissingMethodException","CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2016-08-16T21:22:50Z","PageNum":1,"Articles":[{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2016-08-16T21:22:50Z","Content":"\n\u003Cp\u003E\nI\u0027m getting a weird thing where the *compiler* claims a method exists that at *runtime* it throws an exception on and says it does not exist.\n\u003C/p\u003E\n\u003Cp\u003E\nIt\u0027s this:\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode\u0022\u003E\nSystem.MissingMethodException: Cannot find the requested method.\n\n  at (wrapper managed-to-native) UnityEngine.QuaternionD:INTERNAL_CALL_LookRotation (Vector3d\u0026amp;,Vector3d\u0026amp;)\n  at UnityEngine.QuaternionD.LookRotation (Vector3d forward, Vector3d upwards) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at kOS.Function.FunctionHeading.Execute (kOS.SharedObjects shared) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at kOS.Function.FunctionBase.Execute (kOS.Safe.SafeSharedObjects shared) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at kOS.Safe.Function.FunctionManager.CallFunction (System.String functionName) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at kOS.Safe.Execution.CPU.CallBuiltinFunction (System.String functionName) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at kOS.Safe.Compilation.OpcodeCall.StaticExecute (ICpu cpu, Boolean direct, System.Object destination, Boolean calledFromKOSDelegateCall) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at kOS.Safe.Compilation.OpcodeCall.Execute (ICpu cpu) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \n  at kOS.Safe.Execution.CPU.ExecuteInstruction (IProgramContext context, Boolean doProfiling) [0x00000] in \u0026lt;filename unknown\u0026gt;:0 \u003C/pre\u003E\n\u003Cp\u003E\nAccording to the compiler, UnityEngine.QuaternionD.LookRotation emphatically does exist, with those exact arguments.\u00A0 But at runtime it does not.\u00A0 I\u0027m not sure what \u0022INTERNAL_CALL\u0022 means, but I\u0027m guessing it means \u0022this isn\u0027t implemented in the normal C# way\u0022 or something like that.\u00A0 (i.e. maybe it\u0027s dropping down into some other language for that part, or doing something implemented in raw machine language instead of in the MSIL\u0027s opcodes?)\n\u003C/p\u003E\n\u003Cp\u003E\nThis came about because I was trying to replace all our Quaternion usages with QuaternionD\u0027s because when working with large vectors (i.e. the distance from Kerbin to Duna, for example), the 32-bit precision of Quaternion\u0027s was beginning to multiply into rather big errors after several operations of using them to rotate those big vectors.\u00A0 But it looks like not everything that was implemented for Quaternion got re-implemented for QuaterionD\u0027\u0027s.\n\u003C/p\u003E\n\u003Cp\u003E\nAm I going to have to resort to running my own matrix multiplications to perform rotations or is there some other solution to this?\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Boris-Barboris","CreatedById":133181,"CreatedDateTime":"2016-08-16T21:57:25Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222719403\u0022 data-ipsquote-contentid=\u0022146032\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221471382570\u0022 data-ipsquote-userid=\u002263481\u0022 data-ipsquote-username=\u0022Steven Mading\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n26 minutes ago, Steven Mading said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nAm I going to have to resort to running my own matrix multiplications to perform rotations or is there some other solution to this?\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nNormalizing before rotating (and then denormalizing) may solve precision issues for float quat. Exception text indeed means, that method is lacking implementation in some native library.\n\u003C/p\u003E\n"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2016-08-17T04:17:58Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222719435\u0022 data-ipsquote-contentid=\u0022146032\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221471384645\u0022 data-ipsquote-userid=\u0022133181\u0022 data-ipsquote-username=\u0022Boris-Barboris\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n6 hours ago, Boris-Barboris said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nNormalizing before rotating (and then denormalizing) may solve precision issues for float quat. Exception text indeed means, that method is lacking implementation in some native library.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nWell, I was hoping I didn\u0027t have to do that (normalize, rotate, then un-normalize) but it looks like it\u0027s the only good way.\u00A0 I really don\u0027t want to re-implement Quaternions because....ugh....Complex Numbers.\n\u003C/p\u003E\n"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2016-08-17T06:34:25Z","Content":"\n\u003Cp\u003E\nI\u0027m finding a suspiciously large number of these missing extern methods in QuaternionD.\u00A0 I\u0027ve been trying to build our own replacements for them, but each time I implement one, that just makes me find another one is missing the next time I run.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nSo far, all the following are ones I\u0027ve had this problem with and I had to re-implement them myself:\n\u003C/p\u003E\n\u003Cp\u003E\nQuaternionD.LookRotation()\n\u003C/p\u003E\n\u003Cp\u003E\nQuaternionD.FromToRotation()\n\u003C/p\u003E\n\u003Cp\u003E\nQuaternionD.eulerAngles\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027m starting to wonder if the real problem might be one of the following possibilities:\n\u003C/p\u003E\n\u003Cp\u003E\n1 - QuaternionD is part of some refactor that never got completed and I shouldn\u0027t really be using it at all.\n\u003C/p\u003E\n\u003Cp\u003E\n2 - QuaternionD depends on an additional DLL I\u0027m meant to be compiling with that I\u0027m neglecting to add to the build or runtime environment.\n\u003C/p\u003E\n\u003Cp\u003E\n3 - QuaternionD is designed for KSP-only and modders aren\u0027t supposed to be using it.\n\u003C/p\u003E\n\u003Cp\u003E\n4- QuaternionD is only used by KSP in just a few places here and there, and only the parts that were needed by SQUAD got implemented, with everything else left as an extern method because it was meant as a \u0022TODO\u0022 for later if need-be.\n\u003C/p\u003E\n\u003Cp\u003E\nIf it\u0027s any of the above, then I probably shouldn\u0027t be trying to implement my own versions of these missing methods.\u00A0 If it\u0027s 1, 3, or 4, then I shouldn\u0027t be using QuaternionD at all and I should just find ways to get by without it.\u00A0 If it\u0027s 2, then I should be trying to figure out what I\u0027m missing from my build or runtime environment.\n\u003C/p\u003E\n\u003Cp\u003E\n(Note, despite being in the UnityEngine namespace, QuaternionD seems to actually be part of the KSPUtils DLL file, not the UnityEngine DLL file.)\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Boris-Barboris","CreatedById":133181,"CreatedDateTime":"2016-08-17T06:38:32Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222719851\u0022 data-ipsquote-contentid=\u0022146032\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221471415665\u0022 data-ipsquote-userid=\u002263481\u0022 data-ipsquote-username=\u0022Steven Mading\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n4 minutes ago, Steven Mading said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nIf it\u0027s any of the above, then I probably shouldn\u0027t be trying to implement my own versions of these missing methods\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI\u0027d bet on 4.\u003Cbr\u003E\nAlso, I think float quaternion\u0027s precision is enough, and you\u0027re probably doing something bizarre or wrong if you run into problems.\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-08-17T06:38:41Z\u0022 title=\u002208/17/2016 06:38  AM\u0022 data-short=\u00227 yr\u0022\u003EAugust 17, 2016\u003C/time\u003E by Boris-Barboris\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Dunbaratu","CreatedById":63481,"CreatedDateTime":"2016-08-17T06:49:13Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222719855\u0022 data-ipsquote-contentid=\u0022146032\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221471415912\u0022 data-ipsquote-userid=\u0022133181\u0022 data-ipsquote-username=\u0022Boris-Barboris\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n11 minutes ago, Boris-Barboris said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI\u0027d bet on 4.\u003Cbr\u003E\nAlso, I think float quaternion\u0027s precision is enough, and you\u0027re probably doing something bizarre or wrong if you run into problems.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI\u0027ve done tests where using a Quaternion to rotate a vector produces enormous errors if the vector has a large magnitude, but works fine if you try to rotate the unit-vector version of the vector instead, and then multiply the magnitude of the vector back to full size again afterward.\u00A0 When I found QuaternionD I was sort of hoping it would avoid me having to perform those extra steps but it really looks like QuaternionD is sort of half \u0022not there\u0022 so this technique won\u0027t work well.\u00A0 It looks like I will have to resort to the normalize, rotate, denormalize technique.\u00A0 It\u0027s not impossible, but it\u0027s a big edit because of how many places we perform vector rotations that I will have to replace with calls to some wrapper method instead that does those steps.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-08-17T06:50:00Z\u0022 title=\u002208/17/2016 06:50  AM\u0022 data-short=\u00227 yr\u0022\u003EAugust 17, 2016\u003C/time\u003E by Steven Mading\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"Boris-Barboris","CreatedById":133181,"CreatedDateTime":"2016-08-17T07:22:15Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222719863\u0022 data-ipsquote-contentid=\u0022146032\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221471416553\u0022 data-ipsquote-userid=\u002263481\u0022 data-ipsquote-username=\u0022Steven Mading\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n27 minutes ago, Steven Mading said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nnot\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nYou can always just explicitly state in docs that user should normalize large vectors. Norm denorm every time blindly is indeed quite ugly, I think it\u0027s better to offload the decision to someone, who knows the context - end user.\n\u003C/p\u003E\n"}]}