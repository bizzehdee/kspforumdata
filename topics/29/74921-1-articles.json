{"TopicId":74921,"ForumId":29,"TopicTitle":"KSPAddon instantiated twice","CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-13T12:39:24Z","PageNum":1,"Articles":[{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-13T12:39:24Z","Content":"\n\u003Cp\u003EHello, I\u0027m making a partless plugin derived from ScenarioModule.\u003C/p\u003E\u003Cp\u003EI want it to start at every scene \u0022in game\u0022, as in only those that are accessible when a save file is loaded.\u003C/p\u003E\u003Cp\u003ESo I set the KSPAddon attribute like this:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E    [KSPAddon(KSPAddon.Startup.EveryScene, false)]\u003Cbr\u003E    public class CrewFiles : ScenarioModule\u003Cbr\u003E    {\u003Cbr\u003E        ...\u003Cbr\u003E    }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003Eand then filter out the scenes I don\u0027t want by running my logic only when HighLogic says I\u0027m in a scene I\u0027m ok with.\u003C/p\u003E\u003Cp\u003EHowever, looking at the log my addon gets instantiated TWICE for each scene. If I set KSPAddon.Startup.SpaceCentre, then it\u0027s fine and only one instance is created.\u003C/p\u003E\u003Cp\u003EWhat am I doing wrong? Oo\u003C/p\u003E\n"},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2014-06-13T14:08:58Z","Content":"\n\u003Cp\u003EThe doubling thing might be caused by having two copies of the .dll somewhere, though that might not be the case if it only happens some of the time.\u003C/p\u003E\u003Cp\u003EThe best option is to ditch the standard KSPAddon and use this one: \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/79889-Expanded-KSPAddon-modes?p=1157014\u0026amp;viewfull=1#post1157014\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://forum.kerbalspaceprogram.com/threads/79889-Expanded-KSPAddon-modes?p=1157014\u0026amp;viewfull=1#post1157014\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EIt lets you specify multiple scenes for your addon to start in. I\u0027ve used it in several mods and it works great.\u003C/p\u003E\n"},{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-13T19:14:09Z","Content":"\n\u003Cp\u003EWell, no, I\u0027m sure there is only one dll. Also, I only get 2 instances when I set it to startup in every scene, but only 1 when I startup in the KSC.\u003C/p\u003E\u003Cp\u003EAnyway, I\u0027ll take your suggestion and use the improved version \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EThank you!\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2014-06-13T20:01:23Z","Content":"\n\u003Cp\u003EYou\u0027ve got a bit of a mistake in there. ScenarioModules are handled differently. The game\u0027s persistence file contains a list of them and which scenes to load them in and the game uses that information to load them, rather than the KSPAddon attribute. \u003C/p\u003E\u003Cp\u003EWhat you need is a special KSPAddon that checks to see if your ScenarioModule was added to the game or not. I seem to recall a cleaner method of going about this but I couldn\u0027t find it, so in the meantime I\u0027ll give you my version:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E//note the lack of any attributes on this one\u003Cbr\u003Epublic class YourScenarioModule : ScenarioModule { }\u003Cbr\u003E\u003Cbr\u003E[KSPAddon(KSPAddon.Startup.SpaceCentre, false)]\u003Cbr\u003Epublic class ScenarioCreator : MonoBehaviour\u003Cbr\u003E{\u003Cbr\u003E    public void Start()\u003Cbr\u003E    {\u003Cbr\u003E        bool scenarioExists = !HighLogic.CurrentGame.scenarios.All(scenario =\u0026gt;\u003Cbr\u003E            scenario.moduleName != typeof(YourScenarioModule).Name\u003Cbr\u003E        );\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        if (!scenarioExists)\u003Cbr\u003E        {\u003Cbr\u003E            try\u003Cbr\u003E            {\u003Cbr\u003E                Debug.Log(\u0022Adding YourScenarioModule to game \u0027\u0022 \u002B HighLogic.CurrentGame.Title \u002B \u0022\u0027\u0022);\u003Cbr\u003E                HighLogic.CurrentGame.AddProtoScenarioModule(typeof(YourScenarioModule), new GameScenes[1] { GameScenes.FLIGHT });\u003Cbr\u003E                // the game will add this scenario to the appropriate persistent file on save from now on\u003Cbr\u003E            }\u003Cbr\u003E            catch (ArgumentException ae)\u003Cbr\u003E            {\u003Cbr\u003E                Debug.LogException(ae);\u003Cbr\u003E            }\u003Cbr\u003E            catch\u003Cbr\u003E            {\u003Cbr\u003E                Debug.Log(\u0022Unknown failure while adding scenario.\u0022);\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E        Destroy(this);\u003Cbr\u003E    }\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EModify the GameScenes array passed into AddProtoScenarioModule to include any scenes in which your ScenarioModule should be loaded. Once you\u0027ve run this code once, look into the persistence file (or a quicksave) and confirm that a section that looks like this is in there:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003ESCENARIO\u003Cbr\u003E\t{\u003Cbr\u003E\t\tname = YourScenarioModule\u003Cbr\u003E\t\tscene = 7\u003Cbr\u003E\t}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-13T20:17:11Z","Content":"\n\u003Cp\u003EUh, ok... I\u0027m not quite sure how this kind of things are handled, sorry \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EBasically, I just want to have my plugin to start execution when the game is loaded and stop when the player exits a save and goes back to the main menu.\u003C/p\u003E\u003Cp\u003EWith your solution my scenario module will be re-instantiated at every scene, is that correct?\u003C/p\u003E\n"},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2014-06-13T20:44:14Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Ippo\u0022 data-cite=\u0022Ippo\u0022\u003E\u003Cdiv\u003EUh, ok... I\u0027m not quite sure how this kind of things are handled, sorry \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003Cp\u003EBasically, I just want to have my plugin to start execution when the game is loaded and stop when the player exits a save and goes back to the main menu.\u003C/p\u003E\u003Cp\u003EWith your solution my scenario module will be re-instantiated at every scene, is that correct?\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EThe ScenarioModule will only be loaded in the GameScenes you specified during the initial setup (the AddProtoScenarioModule step), this is when it runs the OnLoad/OnSave methods that allow you to store data in the persistent file. You might also have to delete the existing ScenarioModule from your persistent.sfs file while you\u0027re still developing and making changes. If the ScenarioModule already exists you might not be able to change which GameScenes it will start in.\u003C/p\u003E\u003Cp\u003EThe second class, the one you\u0027re instantiating the ScenarioModule from, will start whenever you want it to using KSPAddon, or KSPAddonImproved. \u003C/p\u003E\u003Cp\u003EThe more common way of using ScenarioModules, at least that I\u0027ve seen (\u003Ca href=\u0022https://github.com/S-C-A-N/SCANsat/blob/master/SCANcontroller.cs#L17-L32\u0022 rel=\u0022external nofollow\u0022\u003ESCANsat here\u003C/a\u003E, \u003Ca href=\u0022https://github.com/Majiir/Kethane/blob/master/Plugin/KethaneData.cs#L8-L28\u0022 rel=\u0022external nofollow\u0022\u003EKethane here\u003C/a\u003E), is to put all of the instantiating code inside the ScenarioModule, and run an instance of it from your secondary class. Then you can do stuff with whatever you stored in the ScenarioModule with your secondary class.\u003C/p\u003E\n"},{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-13T20:54:53Z","Content":"\n\u003Cp\u003ESo if I\u0027m not mistaken, this (from scansat) does basically the same that you told me, except it\u0027s only in one class.\u003C/p\u003E\u003Cp\u003EIt tries to get the controller from the loaded modules, and creates one if it can\u0027t find it.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003E[B]public[/B] [B]static[/B] SCANcontroller controller {\u003Cbr\u003E            [B]get[/B] {\u003Cbr\u003E                Game g = HighLogic.CurrentGame;\u003Cbr\u003E                [B]if[/B](g == [B]null[/B]) [B]return[/B] [B]null[/B];\u003Cbr\u003E                [B]foreach[/B](ProtoScenarioModule mod [B]in[/B] g.scenarios) {\u003Cbr\u003E                    [B]if[/B](mod.moduleName == [B]typeof[/B](SCANcontroller).Name) {\u003Cbr\u003E                        [B]return[/B] (SCANcontroller)mod.moduleRef;\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E                [B]return[/B] (SCANcontroller)g.AddProtoScenarioModule([B]typeof[/B](SCANcontroller), GameScenes.FLIGHT).moduleRef;\u003Cbr\u003E            }\u003Cbr\u003E            [B]private[/B] [B]set[/B] { }\u003Cbr\u003E        }\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-13T21:24:32Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022DMagic\u0022 data-cite=\u0022DMagic\u0022\u003E\u003Cdiv\u003EThe doubling thing might be caused by having two copies of the .dll somewhere, though that might not be the case if it only happens some of the time.\u003Cp\u003EThe best option is to ditch the standard KSPAddon and use this one: \u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/79889-Expanded-KSPAddon-modes?p=1157014\u0026amp;viewfull=1#post1157014\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://forum.kerbalspaceprogram.com/threads/79889-Expanded-KSPAddon-modes?p=1157014\u0026amp;viewfull=1#post1157014\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EIt lets you specify multiple scenes for your addon to start in. I\u0027ve used it in several mods and it works great.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EOk, I am using KSPAddonImproved: it does precisely what I need and it\u0027s super-easy to use \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\u003Cp\u003EI just tested it and I\u0027m super happy with it \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/p\u003E\n"},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2014-06-13T22:14:47Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Ippo\u0022 data-cite=\u0022Ippo\u0022\u003E\u003Cdiv\u003ESo if I\u0027m not mistaken, this (from scansat) does basically the same that you told me, except it\u0027s only in one class.\u003Cp\u003EIt tries to get the controller from the loaded modules, and creates one if it can\u0027t find it.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EBy itself yes, it\u0027s all in one class. But data from the ScenarioModule is used by other classes by calling SCANcontroller.controller.something. \u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Ippo\u0022 data-cite=\u0022Ippo\u0022\u003E\u003Cdiv\u003EOk, I am using KSPAddonImproved: it does precisely what I need and it\u0027s super-easy to use \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003Cp\u003EI just tested it and I\u0027m super happy with it \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EIf you don\u0027t need to store stuff in the persistent file then you should be fine with that. There are obviously other ways to store info, it\u0027s just that ScenarioModules provide a simple way of globally storing data for the entire save file.\u003C/p\u003E\n"},{"CreatedByName":"Ippo","CreatedById":107018,"CreatedDateTime":"2014-06-13T22:34:54Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022DMagic\u0022 data-cite=\u0022DMagic\u0022\u003E\u003Cdiv\u003EIf you don\u0027t need to store stuff in the persistent file then you should be fine with that. There are obviously other ways to store info, it\u0027s just that ScenarioModules provide a simple way of globally storing data for the entire save file.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EAbsolutely. Actually I don\u0027t need any persistence for the module itself: it maintains a copy of the hired and applicant kerbals in a separate cfg file so that you can have a persistence file for each kerbal \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 alt=\u0022:D\u0022\u003E\u003C/p\u003E\u003Cp\u003EIll release it soon, probably tomorrow: I want to write a short documentation before I upload it, but it\u0027s midnight here so I\u0027m going to sleep before \u003Cimg src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 alt=\u0022:)\u0022\u003E\u003C/p\u003E\n"}]}