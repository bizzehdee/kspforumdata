{"TopicId":73597,"ForumId":29,"TopicTitle":"Eva Kerbal - Duplicates on reboarding vessel","CreatedByName":"Stavell","CreatedById":75521,"CreatedDateTime":"2014-05-29T22:05:51Z","PageNum":1,"Articles":[{"CreatedByName":"Stavell","CreatedById":75521,"CreatedDateTime":"2014-05-29T22:05:51Z","Content":"\n\u003Cp\u003EMy EVA Code\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003Eusing System;\u003Cbr\u003Eusing System.Collections.Generic;\u003Cbr\u003Eusing System.Linq;\u003Cbr\u003Eusing System.Text;\u003Cbr\u003Eusing UnityEngine;\u003Cbr\u003Eusing KSP.IO;\u003Cbr\u003Eusing KSP;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003Enamespace IFILifeSupport\u003Cbr\u003E{\u003Cbr\u003E       public class IFILifeSupportEVA : PartModule  // Life Support Consumption Module for EVA\u003Cbr\u003E    {\u003Cbr\u003E        private PluginConfiguration cfg = PluginConfiguration.CreateForType\u0026lt;IFILifeSupportEVA\u0026gt;();\u003Cbr\u003E\u003Cbr\u003E        public bool initialized = false;\u003Cbr\u003E        private static double Rate_Per_Kerbal = 0.000046; // Per Second use based on Life support requirements from Life Support wiki\u003Cbr\u003E        private int IFITimer; // Used to track LS use on inactive eva\u0027d kerbals\u003Cbr\u003E        private float IFICWLS = 5; // Used to track Kerbal death chance after life support runs out.\u003Cbr\u003E        // Right Click Info display for Part\u003Cbr\u003E        [KSPField(guiActive = true, guiName = \u0022Life Support Pack Status\u0022, isPersistant = false)]\u003Cbr\u003E        public string lifeSupportStatus;\u003Cbr\u003E        [KSPField(guiActive = true, guiName = \u0022Life Support \u0022, guiUnits = \u0022 HOURS \u0022, guiFormat = \u0022F0\u0022, isPersistant = false)]\u003Cbr\u003E        public int displayRate;\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        public override void OnLoad(ConfigNode node)\u003Cbr\u003E        {\u003Cbr\u003E            IFIDBLog(\u0022 OnLoad(): OnLoad Fired\u0022);\u003Cbr\u003E            //if (initialized == true)\u003Cbr\u003E            //{\u003Cbr\u003E            //    cfg.load();\u003Cbr\u003E            //    Vessel active = part.vessel;\u003Cbr\u003E            //    if (active)\u003Cbr\u003E            //    {\u003Cbr\u003E            //        string IFICfgLabel = \u0022IFITimer\u0022 \u002B active.id;\u003Cbr\u003E            //        IFITimer = cfg.GetValue\u0026lt;int\u0026gt;(IFICfgLabel);\u003Cbr\u003E            //    }\u003Cbr\u003E            //}\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        public override void OnSave(ConfigNode node)\u003Cbr\u003E        {\u003Cbr\u003E\u003Cbr\u003E            base.OnSave(node);\u003Cbr\u003E            IFIDBLog(\u0022 OnSave() Fired\u0022);\u003Cbr\u003E            Vessel active = part.vessel;\u003Cbr\u003E            if (active)\u003Cbr\u003E            {\u003Cbr\u003E                cfg.load();\u003Cbr\u003E                IFITimer = Convert.ToInt32(Planetarium.fetch.time);\u003Cbr\u003E                IFIDBLog(\u0022 Init Eva Values\u0022);\u003Cbr\u003E\u003Cbr\u003E                string IFICfgLabel = \u0022IFITimer\u0022 \u002B active.id;\u003Cbr\u003E                cfg[IFICfgLabel] = IFITimer;\u003Cbr\u003E                IFICfgLabel = \u0022IFIEVAPACK\u0022 \u002B active.id;\u003Cbr\u003E               double EvaLSRem = IFIGetAllResources(\u0022LifeSupport\u0022);\u003Cbr\u003E                cfg[IFICfgLabel] = EvaLSRem;\u003Cbr\u003E\u003Cbr\u003E                IFICfgLabel = \u0022IFIBool\u0022 \u002B active.id;\u003Cbr\u003E                cfg[IFICfgLabel] = 1;\u003Cbr\u003E                cfg.save();\u003Cbr\u003E            }\u003Cbr\u003E        }\u003Cbr\u003E        public override void OnInactive() // Called when part is destroyed\u003Cbr\u003E        {\u003Cbr\u003E            IFIDBLog(\u0022 EVA Inactive Fired\u0022);\u003Cbr\u003E            base.OnInactive();\u003Cbr\u003E\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        public override void OnUpdate()\u003Cbr\u003E        {\u003Cbr\u003E            base.OnUpdate();\u003Cbr\u003E            Vessel active = part.vessel;\u003Cbr\u003E            if (active.isEVA == true)\u003Cbr\u003E            {\u003Cbr\u003E                IFIDBLog(\u0022 EVA ACCESSED\u0022);\u003Cbr\u003E                lifeSupportStatus = \u0022Active\u0022;\u003Cbr\u003E                displayRate = 4;\u003Cbr\u003E                if (!initialized)  Initialize();\u003Cbr\u003E                int TTtest = Convert.ToInt32(Planetarium.fetch.time) - IFITimer;\u003Cbr\u003E                double ResourceAval = IFIGetAllResources(\u0022LifeSupport\u0022);\u003Cbr\u003E             displayRate = Convert.ToInt16(((ResourceAval / Rate_Per_Kerbal) / 60 / 60));\u003Cbr\u003E              if (displayRate \u0026gt; 0 \u0026amp;\u0026amp; displayRate \u0026lt; 1)\u003Cbr\u003E              {\u003Cbr\u003E                  lifeSupportStatus = \u0022CAUTION \u0022;\u003Cbr\u003E              }\u003Cbr\u003E              else if (displayRate \u0026lt;= 0)\u003Cbr\u003E              {\u003Cbr\u003E                  lifeSupportStatus = \u0022Warning!\u0022;\u003Cbr\u003E              }\u003Cbr\u003E              if (TTtest \u0026gt;= 180) // only consume resources every 3 mins try to control lag\u003Cbr\u003E              {\u003Cbr\u003E                  double resourceRequest;\u003Cbr\u003E                  double resourceReturn;\u003Cbr\u003E                  resourceRequest = Rate_Per_Kerbal  * TTtest;//* TimeWarp.deltaTime; not sure if timewarp is needed but need to check.\u003Cbr\u003E                  resourceReturn = this.part.RequestResource(\u0022LifeSupport\u0022, resourceRequest);\u003Cbr\u003E                  IFIDBLog(\u0022 resource Avalible == \u0022 \u002B Convert.ToString(ResourceAval));\u003Cbr\u003E                  IFIDBLog(\u0022 LS Resource Return == \u0022 \u002B Convert.ToString(resourceReturn));\u003Cbr\u003E\u003Cbr\u003E                  if (ResourceAval \u0026lt; resourceRequest)\u003Cbr\u003E                  {\u003Cbr\u003E                      resourceRequest = ResourceAval;\u003Cbr\u003E                      resourceReturn = this.part.RequestResource(\u0022LifeSupport\u0022, resourceRequest);\u003Cbr\u003E\u003Cbr\u003E                  }\u003Cbr\u003E\u003Cbr\u003E                  if (resourceReturn \u0026lt;= 0 )\u003Cbr\u003E                  {\u003Cbr\u003E                      IFIDBLog(\u0022 Crew has no LS Remaining \u0022);\u003Cbr\u003E                      TimeWarp.SetRate(0, true);\u003Cbr\u003E                      CrewTest(); // Check for crew death\u003Cbr\u003E                  }\u003Cbr\u003E\u003Cbr\u003E                  IFITimer = Convert.ToInt32(Planetarium.fetch.time);\u003Cbr\u003E                  if (active)\u003Cbr\u003E                  {\u003Cbr\u003E                      cfg.load();\u003Cbr\u003E\u003Cbr\u003E                      IFITimer = Convert.ToInt32(Planetarium.fetch.time);\u003Cbr\u003E                      IFIDBLog(\u0022 Init Eva Values\u0022);\u003Cbr\u003E\u003Cbr\u003E                      string IFICfgLabel = \u0022IFITimer\u0022 \u002B active.id;\u003Cbr\u003E                      cfg[IFICfgLabel] = IFITimer;\u003Cbr\u003E                      IFICfgLabel = \u0022IFIEVAPACK\u0022 \u002B active.id;\u003Cbr\u003E                      double EvaLSRem = IFIGetAllResources(\u0022LifeSupport\u0022);\u003Cbr\u003E                      cfg[IFICfgLabel] = EvaLSRem;\u003Cbr\u003E\u003Cbr\u003E                      IFICfgLabel = \u0022IFIBool\u0022 \u002B active.id;\u003Cbr\u003E                      cfg[IFICfgLabel] = 1;\u003Cbr\u003E                      cfg.save();\u003Cbr\u003E                  }\u003Cbr\u003E              }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            }\u003Cbr\u003E\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        private void Initialize()\u003Cbr\u003E        {\u003Cbr\u003E            double EvaLSRem;\u003Cbr\u003E            cfg.load();\u003Cbr\u003E            Vessel active = part.vessel;\u003Cbr\u003E            GameEvents.onCrewBoardVessel.Add(OnCrewBoardVessel);\u003Cbr\u003E           // resourceReturn = this.part.resor (\u0022LifeSupport\u0022, resourceRequest);\u003Cbr\u003E\u003Cbr\u003E            string IFICfgLabel = \u0022IFIBool\u0022 \u002B active.id;\u003Cbr\u003E            int IFIBool = cfg.GetValue\u0026lt;int\u0026gt;(IFICfgLabel);\u003Cbr\u003E            if (IFIBool == 1)\u003Cbr\u003E            {\u003Cbr\u003E                IFICfgLabel = \u0022IFITimer\u0022 \u002B active.id;\u003Cbr\u003E                IFITimer = cfg.GetValue\u0026lt;int\u0026gt;(IFICfgLabel);\u003Cbr\u003E                IFICfgLabel = \u0022IFIEVAPACK\u0022 \u002B active.id;\u003Cbr\u003E                EvaLSRem = cfg.GetValue\u0026lt;double\u0026gt;(IFICfgLabel);\u003Cbr\u003E            }\u003Cbr\u003E            else\u003Cbr\u003E            {\u003Cbr\u003E                IFITimer = Convert.ToInt32(Planetarium.fetch.time);\u003Cbr\u003E                IFIDBLog(\u0022 Init Eva Values\u0022);\u003Cbr\u003E\u003Cbr\u003E                IFICfgLabel = \u0022IFITimer\u0022 \u002B active.id;\u003Cbr\u003E                cfg[IFICfgLabel] = IFITimer;\u003Cbr\u003E                IFICfgLabel = \u0022IFIEVAPACK\u0022 \u002B active.id;\u003Cbr\u003E                cfg[IFICfgLabel] = Rate_Per_Kerbal * 60 * 60 * 4;\u003Cbr\u003E                EvaLSRem = Rate_Per_Kerbal * 60 * 60 * 4;\u003Cbr\u003E                IFICfgLabel = \u0022IFIBool\u0022 \u002B active.id;\u003Cbr\u003E                cfg[IFICfgLabel] = 1;\u003Cbr\u003E                cfg.save();\u003Cbr\u003E            }\u003Cbr\u003E            ConfigNode node = new ConfigNode(\u0022RESOURCE\u0022);\u003Cbr\u003E            node.AddValue(\u0022name\u0022, \u0022LifeSupport\u0022);\u003Cbr\u003E            node.AddValue(\u0022maxAmount\u0022, Rate_Per_Kerbal * 60 * 60 * 4);\u003Cbr\u003E            node.AddValue(\u0022amount\u0022, EvaLSRem);\u003Cbr\u003E            part.AddResource(node);\u003Cbr\u003E            initialized = true;\u003Cbr\u003E            IFIDBLog(\u0022 Init(): OnInit Fired\u0022);\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E        private void CrewTest()\u003Cbr\u003E        {\u003Cbr\u003E            float rand;\u003Cbr\u003E            ProtoCrewMember iCrew;\u003Cbr\u003E            for (int i = 0; i \u0026lt; part.protoModuleCrew.Count; i\u002B\u002B)\u003Cbr\u003E            {\u003Cbr\u003E                rand = UnityEngine.Random.Range(0.0f, 100.0f);\u003Cbr\u003E                if (IFICWLS \u0026gt; rand)\u003Cbr\u003E                {\u003Cbr\u003E                    iCrew = part.protoModuleCrew[i];\u003Cbr\u003E                    part.RemoveCrewmember(iCrew);// Remove crew from part\u003Cbr\u003E                    iCrew.Die();// Kill crew after removal or death will reset to active.\u003Cbr\u003E                    IFIDBLog(\u0022Kerbal Killed due to no LS - \u0022 \u002B iCrew.name);\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            IFICWLS \u002B= 5; // Increase chance of death on next check.\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        private double IFIGetAllResources(string IFIResource)  \u003Cbr\u003E        {\u003Cbr\u003E            double IFIResourceAmt = 0.0;\u003Cbr\u003E            Vessel active = part.vessel;\u003Cbr\u003E            foreach (Part p in active.parts)\u003Cbr\u003E            {\u003Cbr\u003E                foreach (PartResource pr in p.Resources)\u003Cbr\u003E                {\u003Cbr\u003E                    if (pr.resourceName.Equals(IFIResource))\u003Cbr\u003E                    {\u003Cbr\u003E                        IFIResourceAmt \u002B= pr.amount;\u003Cbr\u003E                        break;\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E            return IFIResourceAmt;\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E        private void OnCrewBoardVessel(GameEvents.FromToAction\u0026lt;Part, Part\u0026gt; action)\u003Cbr\u003E        {\u003Cbr\u003E            double IFIResourceAmt = 0.0;\u003Cbr\u003E            foreach (Part p in action.from.vessel.parts)\u003Cbr\u003E            {\u003Cbr\u003E                foreach (PartResource pr in p.Resources)\u003Cbr\u003E                {\u003Cbr\u003E                    if (pr.resourceName.Equals(\u0022LifeSupport\u0022))\u003Cbr\u003E                    {\u003Cbr\u003E                        IFIResourceAmt \u002B= pr.amount;\u003Cbr\u003E                        break;\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E           double resourceReturn = action.to.RequestResource(\u0022LifeSupport\u0022, 0.0 - IFIResourceAmt);\u003Cbr\u003E            Debug.Log(\u0022IFI Life Support Message: EVA - Ended - \u0022 \u002B action.from.name \u002B \u0022 Boarded Vessel\u0022);\u003Cbr\u003E\u003Cbr\u003E        } \u003Cbr\u003E\u003Cbr\u003E        private void IFIDBLog(string IMessage) // Debug Strings to Log File\u003Cbr\u003E        {\u003Cbr\u003E           #if DEBUG\u003Cbr\u003E            Debug.Log(\u0022IFI Life Support Message: EVA -\u0022 \u002B IMessage);\u003Cbr\u003E            #endif\u003Cbr\u003E        }\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E    }\u003Cbr\u003E\u003Cbr\u003E}\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EWhen this code block is not commented out. if I send a Kerbal on eva then try and reboard. he stays on the ladder and a copy of him shows back up in the pod. Not sure what I\u0027m missing but I\u0027m sure it\u0027s simple.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E        private void OnCrewBoardVessel(GameEvents.FromToAction\u0026lt;Part, Part\u0026gt; action)\u003Cbr\u003E        {\u003Cbr\u003E            double IFIResourceAmt = 0.0;\u003Cbr\u003E            foreach (Part p in action.from.vessel.parts)\u003Cbr\u003E            {\u003Cbr\u003E                foreach (PartResource pr in p.Resources)\u003Cbr\u003E                {\u003Cbr\u003E                    if (pr.resourceName.Equals(\u0022LifeSupport\u0022))\u003Cbr\u003E                    {\u003Cbr\u003E                        IFIResourceAmt \u002B= pr.amount;\u003Cbr\u003E                        break;\u003Cbr\u003E                    }\u003Cbr\u003E                }\u003Cbr\u003E            }\u003Cbr\u003E           double resourceReturn = action.to.RequestResource(\u0022LifeSupport\u0022, 0.0 - IFIResourceAmt);\u003Cbr\u003E            Debug.Log(\u0022IFI Life Support Message: EVA - Ended - \u0022 \u002B action.from.name \u002B \u0022 Boarded Vessel\u0022);\u003Cbr\u003E\u003Cbr\u003E        } \u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\n"},{"CreatedByName":"Faark","CreatedById":69775,"CreatedDateTime":"2014-05-29T22:20:33Z","Content":"\n\u003Cp\u003EI would bet on an exception in your code preventing KSP from finishing the boarding logic. Have you checked your logs?\u003C/p\u003E\n"},{"CreatedByName":"Stavell","CreatedById":75521,"CreatedDateTime":"2014-05-30T19:58:11Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Faark\u0022 data-cite=\u0022Faark\u0022\u003E\u003Cdiv\u003EI would bet on an exception in your code preventing KSP from finishing the boarding logic. Have you checked your logs?\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EYou are correct due to that parsing int spam in log I missed a null reference exception line. After using try and catch I found the problem.\u003C/p\u003E\u003Cp\u003EWhich was simple as I surmised. Since a Kerbal on eva is a 1 part vessel. I did not need the for-next loop looking for multiple parts. which was copied from my code running on a pod for resource counts. removing that loop fixed the null reference.\u003C/p\u003E\n"},{"CreatedByName":"wallythewonderful","CreatedById":129093,"CreatedDateTime":"2014-11-13T22:30:44Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Stavell\u0022 data-cite=\u0022Stavell\u0022\u003E\u003Cdiv\u003EYou are correct due to that parsing int spam in log I missed a null reference exception line. After using try and catch I found the problem.\u003Cp\u003EWhich was simple as I surmised. Since a Kerbal on eva is a 1 part vessel. I did not need the for-next loop looking for multiple parts. which was copied from my code running on a pod for resource counts. removing that loop fixed the null reference.\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI just started having this problem too. KSP .25 with MecJeb2 and MCEC. It only seams to happen when Im on a rescue mission. Any other time i can EVA and reboard with no problem. I dont know how to find much less edit the code! Any help will be appreciated!\u003C/p\u003E\n"},{"CreatedByName":"Kamik423","CreatedById":111881,"CreatedDateTime":"2014-11-21T14:58:26Z","Content":"\n\u003Cp\u003Eme too, a solution would be nice\u003C/p\u003E\n"},{"CreatedByName":"philotical","CreatedById":109390,"CreatedDateTime":"2014-11-22T11:57:17Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Kamik423\u0022 data-cite=\u0022Kamik423\u0022\u003E\u003Cdiv\u003Eme too, a solution would be nice\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003Ethere is not \u0022the solution\u0022!\u003C/p\u003E\u003Cp\u003EI mean it\u0027s stated above allready - but some seem to need it twice..\u003C/p\u003E\u003Cp\u003ESo here we go again:\u003C/p\u003E\u003Cp\u003Eyou both have a mod installed that bugs the boarding process - find out wich one and go to the developper or update that mod or remove that mod.\u003C/p\u003E\u003Cp\u003EIf you inform the autor of that mod, the chances are it\u0027ll get fixed..\u003C/p\u003E\u003Cp\u003Eif not, nothing will happen and you will keep that issue.\u003C/p\u003E\u003Cp\u003EOpen your log, find the culprit - done..\u003C/p\u003E\n"},{"CreatedByName":"ttr","CreatedById":128859,"CreatedDateTime":"2014-11-22T17:18:20Z","Content":"\n\u003Cp\u003EGuys, If you\u0027re using Lazor mod, there is your problem. Already reported this bug to devs.\u003C/p\u003E\n"},{"CreatedByName":"Jansn67","CreatedById":158367,"CreatedDateTime":"2016-02-27T16:22:48Z","Content":"\n\u003Cp\u003E\nI never used Lazor, but have this problem now since last updates too.\n\u003C/p\u003E\n\u003Cp\u003E\nStepped back to KIS 1.2.3 from 1.2.4_Proper and 1.2.5, no dupes anymore.\n\u003C/p\u003E\n"},{"CreatedByName":"Red Iron Crown","CreatedById":12858,"CreatedDateTime":"2016-02-27T17:58:33Z","Content":"\n\u003Cp\u003E\n\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022http://forum.kerbalspaceprogram.com/index.php?/profile/158367-jansn67/\u0026amp;do=hovercard\u0022 data-mentionid=\u0022158367\u0022 href=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/158367-jansn67/\u0022\u003E@Jansn67\u003C/a\u003E\u00A0This thread is a year and a half old and likely not relevant anymore. Better to start a new thread, please.\n\u003C/p\u003E\n\u003Cp\u003E\nClosed.\n\u003C/p\u003E\n"}]}