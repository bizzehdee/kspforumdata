{"TopicId":156769,"ForumId":29,"TopicTitle":"BackgroundWorker runs RunWorkerCompleted handler on the wrong thread","CreatedByName":"HebaruSan","CreatedById":156657,"CreatedDateTime":"2017-02-20T19:43:03Z","PageNum":1,"Articles":[{"CreatedByName":"HebaruSan","CreatedById":156657,"CreatedDateTime":"2017-02-20T19:43:03Z","Content":"\n\u003Cp\u003E\nIs BackgroundWorker safe to use in KSP mods? I\u0027m using it to offload intensive calculations, but I need it to trigger a UI update when done, and whenever I do this by any means other than setting a bool that I check later in the main thread\u0027s Update(), the whole game crashes. \u003Cem\u003EIncluding\u003C/em\u003E\u00A0via the\u00A0RunWorkerCompleted event.\n\u003C/p\u003E\n\u003Cul\u003E\u003Cli\u003E\n\u003Ca href=\u0022https://msdn.microsoft.com/en-us/library/hybbz6ke(v=vs.110).aspx\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://msdn.microsoft.com/en-us/library/hybbz6ke(v=vs.110).aspx\u003C/a\u003E\n\u003C/li\u003E\n\u003Cli\u003E\n\u003Ca href=\u0022https://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker(v=vs.110).aspx\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker(v=vs.110).aspx\u003C/a\u003E\n\u003C/li\u003E\n\u003C/ul\u003E\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nQuote\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp style=\u0022color:rgb(42,42,42);margin:0px;padding-bottom:15px;line-height:18px;font-family:\u0027Segoe UI\u0027, \u0027Lucida Grande\u0027, Verdana, Arial, Helvetica, sans-serif;font-size:13px;font-style:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;\u0022\u003E\nYou must be careful not to manipulate any user-interface objects in your\u003Cspan\u003E\u00A0\u003C/span\u003E\u003Ca href=\u0022https://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker.dowork(v=vs.110).aspx\u0022 style=\u0022text-decoration:none;color:rgb(0,112,159);\u0022 rel=\u0022external nofollow\u0022\u003EDoWork\u003C/a\u003E\u003Cspan\u003E\u00A0\u003C/span\u003Eevent handler. Instead, \u003Cstrong\u003Ecommunicate to the user interface through the\u003Cspan\u003E\u00A0\u003C/span\u003E\u003Ca href=\u0022https://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker.progresschanged(v=vs.110).aspx\u0022 style=\u0022text-decoration:none;color:rgb(0,112,159);\u0022 rel=\u0022external nofollow\u0022\u003EProgressChanged\u003C/a\u003E\u003Cspan\u003E\u00A0\u003C/span\u003Eand\u003Cspan\u003E\u00A0\u003C/span\u003E\u003Ca href=\u0022https://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker.runworkercompleted(v=vs.110).aspx\u0022 style=\u0022text-decoration:none;color:rgb(0,112,159);\u0022 rel=\u0022external nofollow\u0022\u003ERunWorkerCompleted\u003C/a\u003E\u003Cspan\u003E\u00A0\u003C/span\u003Eevents.\u003C/strong\u003E\n\u003C/p\u003E\n\u003Cp style=\u0022color:rgb(42,42,42);margin:0px;padding-bottom:0px;line-height:18px;font-family:\u0027Segoe UI\u0027, \u0027Lucida Grande\u0027, Verdana, Arial, Helvetica, sans-serif;font-size:13px;font-style:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;\u0022\u003E\n\u003Cspan\u003EBackgroundWorker\u003C/span\u003E\u003Cspan\u003E\u00A0\u003C/span\u003Eevents are not marshaled across\u003Cspan\u003E\u00A0\u003C/span\u003E\u003Ca href=\u0022https://msdn.microsoft.com/en-us/library/system.appdomain(v=vs.110).aspx\u0022 style=\u0022text-decoration:none;color:rgb(0,112,159);\u0022 rel=\u0022external nofollow\u0022\u003EAppDomain\u003C/a\u003E\u003Cspan\u003E\u00A0\u003C/span\u003Eboundaries. Do not use a\u003Cspan\u003E\u00A0\u003C/span\u003E\u003Cspan\u003EBackgroundWorker\u003C/span\u003E\u003Cspan\u003E\u00A0\u003C/span\u003Ecomponent to perform multithreaded operations in more than one\u003Cspan\u003E\u00A0\u003C/span\u003E\u003Ca href=\u0022https://msdn.microsoft.com/en-us/library/system.appdomain(v=vs.110).aspx\u0022 style=\u0022text-decoration:none;color:rgb(0,112,159);\u0022 rel=\u0022external nofollow\u0022\u003EAppDomain\u003C/a\u003E.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI tried logging\u00A0Thread.CurrentThread.ManagedThreadId, and that seemed to confirm what I suspected, that it\u0027s running the\u00A0RunWorkerCompleted handler on a background thread, sometimes the worker thread, sometimes a completely new thread:\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nQuote\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\n\u003Cspan style=\u0022font-size:9px;\u0022\u003E\u003Cspan style=\u0022font-family:\u0027Courier New\u0027, Courier, monospace;\u0022\u003E[LOG 13:13:09.679] [Astrogator 036.738] Background worker created by thread 1\u003Cbr\u003E\n[LOG 13:13:09.679] [Astrogator 036.738] Background worker started by thread 1\u003Cbr\u003E\n[LOG 13:13:09.680] [Astrogator 036.738] Background worker running on thread 2\u003Cbr\u003E\u003Cspan style=\u0022color:#ff0000;\u0022\u003E\u003Cstrong\u003E[LOG 13:13:09.686] [Astrogator 036.745] Background worker completion handled on thread 3\u003C/strong\u003E\u003C/span\u003E\u003Cbr\u003E\n[LOG 13:13:15.342] [Astrogator 042.400] Background worker created by thread 1\u003Cbr\u003E\n[LOG 13:13:15.342] [Astrogator 042.400] Background worker started by thread 1\u003Cbr\u003E\n[LOG 13:13:15.342] [Astrogator 042.400] Background worker running on thread 2\u003Cbr\u003E\u003Cspan style=\u0022color:#ff0000;\u0022\u003E\u003Cstrong\u003E[LOG 13:13:15.342] [Astrogator 042.401] Background worker completion handled on thread 2\u003C/strong\u003E\u003C/span\u003E\u003Cbr\u003E\n[LOG 13:13:19.419] [Astrogator 046.478] Background worker created by thread 1\u003Cbr\u003E\n[LOG 13:13:19.419] [Astrogator 046.478] Background worker started by thread 1\u003Cbr\u003E\n[LOG 13:13:19.420] [Astrogator 046.478] Background worker running on thread 4\u003Cbr\u003E\u003Cspan style=\u0022color:#ff0000;\u0022\u003E\u003Cstrong\u003E[LOG 13:13:19.420] [Astrogator 046.479] Background worker completion handled on thread 4\u003C/strong\u003E\u003C/span\u003E\u003C/span\u003E\u003C/span\u003E\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nI expected each of those bold red thread IDs to be 1, since that\u0027s the thread that kicked off the worker. Are there any known\u00A0tricks that will make this work the way the C# documentation says it does? People on stackoverflow\u00A0are talking about\u00A0SynchronizationContext.Current, which is\u00A0null the very first time but non-null after that, but setting it to a new instance of SynchronizationContext doesn\u0027t change the above output at all.\n\u003C/p\u003E\n"},{"CreatedByName":"paulprogart","CreatedById":174587,"CreatedDateTime":"2017-02-20T21:13:58Z","Content":"\n\u003Cp\u003E\nNo, BackgroundWorker won\u0027t work properly with Unity because BW is a ComponentModel class and Unity does not support ComponentModel.\u00A0 BW needs the infrastructure provided by WInForms or ASP.NET that lets it (and other such classes) say to the main thread \u0022pardon me, I need you to call this method next time it\u0027s convenient\u0022.\n\u003C/p\u003E\n\u003Cp\u003E\nYou can prove this:\u00A0 Try a BW in a WinForms app like the one in the MSDN help and it\u0027ll work as documented, but try it in a plain Console app and the result will be the same as you got.\n\u003C/p\u003E\n\u003Cp\u003E\nSo I\u0027d go with the bool flag and check on Update().\u00A0 Or if you can live with a bit of UI update latency you can spawn a Unity coroutine that only checks every 1/10th of a second (or whatever delay you can live with).\u00A0 In either case, make sure to use lock whenever you change the flag.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2017-02-20T21:40:10Z","Content":"\n\u003Cp\u003E\nOr you can use something that will call your UI event on the main thread.\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nLook for dispatcher in my MechJeb code\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/MuMech/MechJeb2/tree/master/MechJeb2/UnityToolbag/Dispatcher\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/MuMech/MechJeb2/tree/master/MechJeb2/UnityToolbag/Dispatcher\u003C/a\u003E\n\u003C/p\u003E\n"},{"CreatedByName":"HebaruSan","CreatedById":156657,"CreatedDateTime":"2017-02-20T22:37:19Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222962104\u0022 data-ipsquote-contentid=\u0022156769\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221487625238\u0022 data-ipsquote-userid=\u0022174587\u0022 data-ipsquote-username=\u0022paulprogart\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n29 minutes ago, paulprogart said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nNo, BackgroundWorker won\u0027t work properly with Unity because BW is a ComponentModel class and Unity does not support ComponentModel.\u00A0 BW needs the infrastructure provided by WInForms or ASP.NET that lets it (and other such classes) say to the main thread \u0022pardon me, I need you to call this method next time it\u0027s convenient\u0022.\n\u003C/p\u003E\n\u003Cp\u003E\nYou can prove this:\u00A0 Try a BW in a WinForms app like the one in the MSDN help and it\u0027ll work as documented, but try it in a plain Console app and the result will be the same as you got.\n\u003C/p\u003E\n\u003Cp\u003E\nSo I\u0027d go with the bool flag and check on Update().\u00A0 Or if you can live with a bit of UI update latency you can spawn a Unity coroutine that only checks every 1/10th of a second (or whatever delay you can live with).\u00A0 In either case, make sure to use lock whenever you change the flag.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThanks! Kind of annoying that they ship a component with a limitation like this and make it\u00A0look\u00A0like a generic utility that does exactly what I want (and it doesn\u0027t even throw exceptions when its prerequisites aren\u0027t met).\n\u003C/p\u003E\n\u003Cp\u003E\nGood shout on the lock.\n\u003C/p\u003E\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222962129\u0022 data-ipsquote-contentid=\u0022156769\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221487626810\u0022 data-ipsquote-userid=\u002257146\u0022 data-ipsquote-username=\u0022sarbian\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n3 minutes ago, sarbian said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nOr you can use something that will call your UI event on the main thread.\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nLook for dispatcher in my MechJeb code\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://github.com/MuMech/MechJeb2/tree/master/MechJeb2/UnityToolbag/Dispatcher\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/MuMech/MechJeb2/tree/master/MechJeb2/UnityToolbag/Dispatcher\u003C/a\u003E\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nYeah, I found a similar class that I\u0027m hoping to use to craft my own\u00A0UnityBackgroundWorker...\n\u003C/p\u003E\n\u003Cp\u003E\nHow do you make Unity call Update on a MonoBehaviour? Mine never runs. Am I supposed to register it somewhere?\n\u003C/p\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2017-02-20T23:20:35Z","Content":"\n\u003Cp\u003E\nYou need to create a game object and add the monobehaviour to it. Look at the last method in my code\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"HebaruSan","CreatedById":156657,"CreatedDateTime":"2017-02-20T23:54:05Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222962251\u0022 data-ipsquote-contentid=\u0022156769\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221487632835\u0022 data-ipsquote-userid=\u002257146\u0022 data-ipsquote-username=\u0022sarbian\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n31 minutes ago, sarbian said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nYou need to create a game object and add the monobehaviour to it. Look at the last method in my code\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\n... so it\u00A0\u003Cem\u003Ehas\u003C/em\u003E\u00A0to be a singleton, and I can\u0027t use a parameterized\u00A0constructor. Never mind about the UnityBackgroundWorker, I\u0027m just going to set that bool and be done with it.\n\u003C/p\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2017-02-21T13:04:01Z","Content":"\n\u003Cp\u003E\nhum, I don\u0027t understand the problem. When your mod start you call\u00A0CreateDispatcher to make sure it is up (My call could use some love to check if it s already there). In your background code whenever you need to call unity objects you just call\u00A0InvokeAsync (or Invoke)\u00A0on the singleton. Nothing complex and it works fine.\n\u003C/p\u003E\n\u003Cp\u003E\nI do it in \u003Cabbr title=\u0022Mechjeb (mod)\u0022\u003EMJ\u003C/abbr\u003E to log from a thread :\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003EDispatcher.InvokeAsync(() =\u0026gt; Debug.LogException(ex));\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"Warezcrawler","CreatedById":145377,"CreatedDateTime":"2017-02-22T22:19:26Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222961991\u0022 data-ipsquote-contentid=\u0022156769\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221487619783\u0022 data-ipsquote-userid=\u0022156657\u0022 data-ipsquote-username=\u0022HebaruSan\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\nOn 20/2/2017 at 8:43 PM, HebaruSan said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cp\u003E\nIs BackgroundWorker safe to use in KSP mods? I\u0027m using it to offload intensive calculations, but I need it to trigger a UI update when done, and whenever I do this by any means other than setting a bool that I check later in the main thread\u0027s Update(), the whole game crashes. \u003Cem\u003EIncluding\u003C/em\u003E\u00A0via the\u00A0RunWorkerCompleted event.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nIf you create a new thread, I\u0027ve noticed that if that thread call a coroutine, then that coroutine is executed on the main thread. Maybe that could help you.\n\u003C/p\u003E\n\u003Cp\u003E\nSo I\u0027m thinking something like calling a coroutine when the calculation in the thread finishes.\n\u003C/p\u003E\n"}]}