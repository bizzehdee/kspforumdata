{"TopicId":152217,"ForumId":29,"TopicTitle":"Update vessel position at every frame","CreatedByName":"Dagger","CreatedById":147766,"CreatedDateTime":"2016-11-18T11:13:24Z","PageNum":1,"Articles":[{"CreatedByName":"Dagger","CreatedById":147766,"CreatedDateTime":"2016-11-18T11:13:24Z","Content":"\n\u003Cp\u003E\nHi, I\u0027m doing a fork of DMP and I\u0027m having problems when updating a vessel position.\n\u003C/p\u003E\n\u003Cp\u003E\nThe idea is that aproximately every 30ms I receive a message with a vessel position, I store it in a buffer and I apply it on the fixedupdate\u00A0to the corresponding\u00A0vessel in a way that I always have 1 packet in the buffer (otherwise the vessel would stop moving until I receive the next one and the movement would jitter)\n\u003C/p\u003E\n\u003Cp\u003E\nBetween those 30ms between packets I interpolate the vessel position with the function Lerp. but still, when flying in formation and at high speeds\u00A0the vessel jitters and \u0022jumps\u0022 in it\u0027s movement, even if it\u0027s packed or unpacked.\n\u003C/p\u003E\n\u003Cp\u003E\nHere is the code that I use for the vessel positioning.\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003Eprivate void ApplySurfaceInterpolation(float interpolationValue)\n{\n\t//interpolationValue is a value between 0 and 1 to do the Lerp logic.\n\t//Velocity components are sent as vessel.rb_velocityD\n      var currentVelocity = GetInterpolatedVelocity(interpolationValue, currentAcc);\n\n      Vessel.latitude = Lerp(LatLonAlt[0], Target.LatLonAlt[0], interpolationValue);\n      Vessel.longitude = Lerp(LatLonAlt[1], Target.LatLonAlt[1], interpolationValue);\n      Vessel.altitude = Lerp(LatLonAlt[2], Target.LatLonAlt[2], interpolationValue);\n      var worldSurfacePosition = Vessel.mainBody.GetWorldSurfacePosition(Vessel.latitude, Vessel.longitude, Vessel.altitude);\n\n      var startWorldPos = new Vector3d(WorldPosition[0], WorldPosition[1], WorldPosition[2]);\n      var targetWorldPos = new Vector3d(Target.WorldPosition[0], Target.WorldPosition[1], Target.WorldPosition[2]);\n      var currentWorldPos = Vector3d.Lerp(startWorldPos, targetWorldPos, interpolationValue);\n\n      Vessel.SetPosition(worldSurfacePosition, true);\n      Vessel.CoMD = currentWorldPos;\n\n      var startOrbitPos = new Vector3d(OrbitPosition[0], OrbitPosition[1], OrbitPosition[2]);\n      var targetOrbitPos = new Vector3d(Target.OrbitPosition[0], Target.OrbitPosition[1], Target.OrbitPosition[2]);\n      var currentOrbitPos = Vector3d.Lerp(startOrbitPos, targetOrbitPos, interpolationValue);\n      Vessel.orbit.pos = currentOrbitPos;\n\n      Vessel.SetWorldVelocity(currentVelocity);\n}\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nIs there something I\u0027m missing or some other vessel position variable that I must send?\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-11-18T11:57:38Z\u0022 title=\u002211/18/2016 11:57  AM\u0022 data-short=\u00227 yr\u0022\u003ENovember 18, 2016\u003C/time\u003E by Dagger\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2016-11-18T12:52:33Z","Content":"\n\u003Cp\u003E\nHey. I could not reply to your IRC message since you were gone by the time I was online.\n\u003C/p\u003E\n\u003Cp\u003E\nMoving a vessel by hand is actually quite complex in 1.2 and the call to make it easier are only meant to move the active vessel...\n\u003C/p\u003E\n\u003Cp\u003E\nThe problem is that you are fighting the orbit and flight integrator code and you set things you should not set by hand (CoMD is not at the position,orbit.pos should be computed by the oribit code). I am at work so my reply will be from memory (with the help of the API site) but if you want to move those vessel yourself (since they position are from a remote host) you should make sure all the stock position / movement system are off (at least I would do it that way, I may be missing an obvious problem to that).\n\u003C/p\u003E\n\u003Cp\u003E\nSo I would set the vessel to on rail and set its OrbitDriver\u00A0 updateMode\u00A0 to IDLE. That should solve some of your problem. But I don\u0027t know how DMP handle remote vessel so it may require a lot more like disabling most vessel components.\n\u003C/p\u003E\n\u003Cp\u003E\nSetPosition \u0026amp; SetWorldVelocity are only relevant on packed vessels.\n\u003C/p\u003E\n"},{"CreatedByName":"Dagger","CreatedById":147766,"CreatedDateTime":"2016-11-18T23:07:44Z","Content":"\n\u003Cp\u003E\nHi sarbian, thanks a lot for your answer.\n\u003C/p\u003E\n\u003Cp\u003E\nI changed the code so all the other player controlled vessels are packed (by editing the vesselRanges) and it seems much better and smooth \u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-11-18T23:08:26Z\u0022 title=\u002211/18/2016 11:08  PM\u0022 data-short=\u00227 yr\u0022\u003ENovember 18, 2016\u003C/time\u003E by Dagger\u003C/strong\u003E\n\u003C/span\u003E\n"}]}