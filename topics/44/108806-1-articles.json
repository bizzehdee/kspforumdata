{"TopicId":108806,"ForumId":44,"TopicTitle":"Missing physics component? My simulation results are off. [0.90]","CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-05-11T19:23:17Z","PageNum":1,"Articles":[{"CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-05-11T19:23:17Z","Content":"To help me build better ships, I programmed a numerical simulator in Mathematica that allows me to input the attributes of the ship\u0027s stages and output how far it can go. This was back in the \u003C=0.90 era, I haven\u0027t moved to 1.x yet.\n\nI\u0027ve included in it pretty much everything I could think of (including some not-completely-trivial aspects of the rotating reference frame), but the results are still a bit off compared to what I see in-game. With simple rockets that stay within the atmosphere or briefly exit it, the highest altitude reached is about 1% different from simulation. Not something that would materially affect ship design, but not good enough for a perfectionist like me.\n\nThis has been driving me crazy and I\u0027ve spent several hours trying to isolate the problem. I\u0027ve recently collected some data from a rocket in flight (after the thrust phase, to keep it simple), applied locally cubic regression with a Gaussian kernel, and investigated the result.\n\n**(Edit:** The following example, it appears, is merely an artifact of incorrect altitude values reported by the game. But, there is still something I can\u0027t account for, which is apparent in longer flights (about 1% difference at 10km).)\n\nFor example, I concluded that when my rocket was at 2000m and moving upwards (the direction shouldn\u0027t differ materially from straight up, and anyway, I calculated that a slight deviation wouldn\u0027t explain the discrepancy) at a speed of 252.1 m/s, the acceleration in-game is -47.77 m/s^2.\n\nWhat I would expect:\n\nGravity: -9.81 \\* (600000/602000)^2 = -9.745\n\nCentrifugal force: (2pi/21600)^2 \\* 600000 = 0.051\n\nDrag: -0.5 \\* 0.008 \\* 1.2231 \\* 0.2 \\* Exp(-2000/5000) \\* 252.1^2 = -41.685\n\nTotal: -51.38 m/s^2\n\nSo my deceleration in-game is 3.6 m/s^2 lower that what my math says.\n\nI experimented with a lift force proportional to speed, and it does seem to help a bit, but I still don\u0027t get consistent results, and I don\u0027t understand why there should be such a force - the parts I\u0027ve used don\u0027t have a lift rating AFAICT.\n\nAnd yeah, I know 0.90 aerodynamics aren\u0027t realistic, but I\u0027m not looking for realistic, I\u0027m looking for internally consistent.\n\nCould someone please put me out of my misery and explain what is going on?\n\nThanks.\n\n**Edited \u003Ctime datetime=\u00222015-05-13T19:54:59Z\u0022 title=\u002205/13/2015 07:54  PM\u0022 data-short=\u00229 yr\u0022\u003EMay 13, 2015\u003C/time\u003E by Holy-Fire**"},{"CreatedByName":"Hobbes Novakoff","CreatedById":129018,"CreatedDateTime":"2015-05-12T05:49:26Z","Content":"I don\u0027t know, but it\u0027s probably floating-point errors in KSP that are causing your imbalance.\n\n- - - Updated - - -\n\nEither that or just messed-up pre-1.0 aerodynamics."},{"CreatedByName":"ElWanderer","CreatedById":114015,"CreatedDateTime":"2015-05-12T06:43:49Z","Content":"Does your craft consist entirely of parts with a drag coefficient of 0.2, or do you have some less draggy parts?\n\nI remember I could never get my 0.90 height record simulations to match reality (worse performance/more drag than I predicted) until I realised SRBs had a drag coefficient of 0.3."},{"CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-05-12T08:48:41Z","Content":"\u003E \n\u003E I don\u0027t know, but it\u0027s probably floating-point errors in KSP that are causing your imbalance.\n\nI doubt it. It\u0027s too big of an error. And it\u0027s not just something that accumulates over a long time, I can detect differences in short timescales as well.\n\n\u003E Either that or just messed-up pre-1.0 aerodynamics.\n\nMaybe... But how exactly are they messed up? What\u0027s missing compared to the calculation above?\n\n\u003E \n\u003E Does your craft consist entirely of parts with a drag coefficient of 0.2, or do you have some less draggy parts?\n\u003E I remember I could never get my 0.90 height record simulations to match reality (worse performance/more drag than I predicted) until I realised SRBs had a drag coefficient of 0.3.\n\nYes. In this example I just have 3 parts - Probodobodyne HECS, Oscar-B Fuel Tank, Rockomax 48-7S. Of course, this happens also with other simple liquid-only configurations.\n\n**Edited \u003Ctime datetime=\u00222015-05-12T15:07:10Z\u0022 title=\u002205/12/2015 03:07  PM\u0022 data-short=\u00229 yr\u0022\u003EMay 12, 2015\u003C/time\u003E by Holy-Fire**"},{"CreatedByName":"Korizan","CreatedById":142032,"CreatedDateTime":"2015-05-12T12:33:30Z","Content":"Drag is not a constant, it will vary based on altitude. Apparently in .9 and below the atmosphere was kind of messed up to make things work.\n\nand / or the drag you are using is not the same number that KSP is using. (example drag of a single part is .2 but KSP is adding up all the parts and assigning a different drag coefficient for the rocket as a whole)\n\nSo the question is are your dependencies linear or are they variant based on altitude ?\n\nThat should help you narrow down the problem."},{"CreatedByName":"ElWanderer","CreatedById":114015,"CreatedDateTime":"2015-05-12T13:06:33Z","Content":"For what it\u0027s worth, I just opened my vertical launch calculator and fiddled with some values to get a velocity of about 252m/s at 2000m and I agree with your calculated/expected results for gravity and drag.\n\nHow accurate are your measured-in-flight values? If your prediction for max alt is only 1% off, I wouldn\u0027t expect observed drag to be ~10% away from your calculated value.\n\nI found my results for peak altitude were never quite right. I didn\u0027t take into account the rotation, which I always assumed was the culprit."},{"CreatedByName":"KerikBalm","CreatedById":91917,"CreatedDateTime":"2015-05-12T13:19:05Z","Content":"I thought in KSP, for some reason, surface gravity was 9.82 m/s... though that is not going to account for more than 1% of the error.\n\n\u0022the direction shouldn\u0027t differ materially from straight up, and anyway, I calculated that a slight deviation wouldn\u0027t explain the discrepancy\u0022\n\nAre you sure? the rotation of Kerbin is quite significant at such a small scale. There was a thread about fins on rockets, and kerbin\u0027s rotation was enough that the rockets consistently tipped over into a westward gravity turn with no control input."},{"CreatedByName":"hirschhornsalz","CreatedById":118991,"CreatedDateTime":"2015-05-12T13:25:53Z","Content":"Your centrifugal force seems to be a bit off, you are using the values at the ground. Assuming you are going straight up relative to the ground, it should be (2pi/21600)^2 \\* 602000, bit this is not enough to explain the difference.\n\nI agree that most likely either the drag displayed ingame is wrong or nor correctly calculated. But the 0.90 athmospheric model is now obsolete anyway, except you are planning for staying at 0.90 long term."},{"CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-05-12T15:06:43Z","Content":"\u003E \n\u003E Drag is not a constant, it will vary based on altitude. Apparently in .9 and below the atmosphere was kind of messed up to make things work.\n\u003E and / or the drag you are using is not the same number that KSP is using. (example drag of a single part is .2 but KSP is adding up all the parts and assigning a different drag coefficient for the rocket as a whole)\n\nWell, it seems weird that there would be such a difference. Any insights about how it could work?\n\n\u003E \n\u003E So the question is are your dependencies linear or are they variant based on altitude ?\n\u003E \n\u003E That should help you narrow down the problem.\n\nIdeally I would be able to collect enough data to determine the difference as a function of speed and height. But collecting data is too time-consuming for me. Which mods make it easier to collect such data?\n\n\u003E \n\u003E How accurate are your measured-in-flight values?\n\nI mentioned a gap of 3.6 m/s^2; the inaccuracy is enough for that figure to actually be anywhere from 3 to 4 m/s^2, but I doubt it\u0027s outside this range. Even if only 3, it\u0027s very significant.\n\n\u003E \n\u003E If your prediction for max alt is only 1% off, I wouldn\u0027t expect observed drag to be ~10% away from your calculated value.\n\nThe exact difference in max alt varies; in this case, I predict 3339 m and reach 3404 m, so about 2%. Anyway, the difference of 10% persists only for a short period of time; as the speed goes down, gravity dominates, and seems to work as expected.\n\n\u003E I found my results for peak altitude were never quite right. I didn\u0027t take into account the rotation, which I always assumed was the culprit.\n\nI doubt it. Centrifugal force has only a small effect, and other rotation effects turned out to be negligible in my calculations, definitely at lower altitudes.\n\n\u003E \n\u003E I thought in KSP, for some reason, surface gravity was 9.82 m/s... though that is not going to account for more than 1% of the error.\n\nIsp is calculated based on g=9.82. But the actual g is 9.81 as far as I can tell. Hard to measure ground gravity directly with all the confounding factors, but measuring gravity in orbit confirms that at R=600000 it should be 9.81. I think this was also supported by my measurements of terminal velocity with a parachute, though maybe it wasn\u0027t accurate enough to be definite.\n\n\u003E \n\u003E \u0022the direction shouldn\u0027t differ materially from straight up, and anyway, I calculated that a slight deviation wouldn\u0027t explain the discrepancy\u0022\n\u003E Are you sure? the rotation of Kerbin is quite significant at such a small scale. There was a thread about fins on rockets, and kerbin\u0027s rotation was enough that the rockets consistently tipped over into a westward gravity turn with no control input.\n\nSounds odd - Coriolis force shouldn\u0027t apply torque to a rigid body - but it doesn\u0027t take much to tip an unstable equilibrium, and it could result from higher order effects. But assuming a point body and talking about max altitude, in the low atmosphere, it\u0027s not significant.\n\n\u003E \n\u003E Your centrifugal force seems to be a bit off, you are using the values at the ground. Assuming you are going straight up relative to the ground, it should be (2pi/21600)^2 \\* 602000, bit this is not enough to explain the difference.\n\nNot quite. Yes, the actual centrifugal force is w^2\\*602000, **but**, as you go up to 2000, Coriolis force gives you a side velocity of w\\*2000. Coriolis force from this side velocity applies a downward force of w^2\\*2000. This exactly cancels out with the increase in centrifugal force. Other affects of the side velocity are negligible in this scenario. So it\u0027s safe to simply talk about a constant centrifugal force of w^2\\*600000.\n\n\u003E \n\u003E I agree that most likely either the drag displayed ingame is wrong or nor correctly calculated.\n\nThe thing is, it can\u0027t be simply \u0022different drag\u0022 since simulating a fixed change in drag doesn\u0027t result in the experimental trajectory. There seems to be a dependence on the altitude or speed, but I can\u0027t figure out what it is.\n\n\u003E But the 0.90 athmospheric model is now obsolete anyway, except you are planning for staying at 0.90 long term.\n\nI might. Most of what I\u0027ve read about 1.x makes me feel I will enjoy it less than 0.90. And this mystery has become a mostly academic thing now, I hope to solve it before moving on.\n\nIs there a way to ask the developers about this? Surely they would know..."},{"CreatedByName":"Korizan","CreatedById":142032,"CreatedDateTime":"2015-05-13T15:47:58Z","Content":"Sadly I can\u0027t think of any mods that might help you.\n\nIt is a question of does the atmosphere effect the drag like it should and how is the atmosphere worked out.\n\nDid they use a log^ to create it or it just hard boundaries at certain altitudes, I don\u0027t know.\n\nAnother thought may be a case of truncating you don\u0027t know how the game is calculating its numbers, truncating can some serious deviation."},{"CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-05-13T16:30:38Z","Content":"\u003E \n\u003E It is a question of does the atmosphere effect the drag like it should and how is the atmosphere worked out.\n\u003E Did they use a log^ to create it or it just hard boundaries at certain altitudes, I don\u0027t know.\n\nI don\u0027t think they use a piecewise function for the atmospheric density. First, it would make little sense for them to do so, since it\u0027s actually more complicated; and, it\u0027s not consistent with measured results. For example, if you descend with a deployed parachute, your speed will be essentially equal to terminal velocity, and you can see it gradually go down as density increases. If they do use a very fine lookup table, it shouldn\u0027t materially affect the results.\n\n\u003E Another thought may be a case of truncating you don\u0027t know how the game is calculating its numbers, truncating can some serious deviation.\n\nI doubt this is it. The gap is too big to be the result of any sane truncating; and, a game of this type should be expected to use high accuracy - all calculations being done in double, or at least single, precision floating-point, with no rounding except for display purposes."},{"CreatedByName":"arkie87","CreatedById":103434,"CreatedDateTime":"2015-05-13T17:06:08Z","Content":"\u003E \n\u003E To help me build better ships, I programmed a numerical simulator in Mathematica that allows me to input the attributes of the ship\u0027s stages and output how far it can go. This was back in the \u003C=0.90 era, I haven\u0027t moved to 1.x yet.\n\u003E I\u0027ve included in it pretty much everything I could think of (including some not-completely-trivial aspects of the rotating reference frame), but the results are still a bit off compared to what I see in-game. With simple rockets that stay within the atmosphere or briefly exit it, the highest altitude reached is about 1% different from simulation. Not something that would materially affect ship design, but not good enough for a perfectionist like me.\n\u003E \n\u003E This has been driving me crazy and I\u0027ve spent several hours trying to isolate the problem. I\u0027ve recently collected some data from a rocket in flight (after the thrust phase, to keep it simple), applied locally cubic regression with a Gaussian kernel, and investigated the result.\n\u003E \n\u003E For example, I concluded that when my rocket was at 2000m and moving upwards (the direction shouldn\u0027t differ materially from straight up, and anyway, I calculated that a slight deviation wouldn\u0027t explain the discrepancy) at a speed of 252.1 m/s, the acceleration in-game is -47.77 m/s^2.\n\u003E \n\u003E What I would expect:\n\u003E \n\u003E Gravity: -9.81 \\* (600000/602000)^2 = -9.745\n\u003E \n\u003E Centrifugal force: (2pi/21600)^2 \\* 600000 = 0.051\n\u003E \n\u003E Drag: -0.5 \\* 0.008 \\* 1.2231 \\* 0.2 \\* Exp(-2000/5000) \\* 252.1^2 = -41.685\n\u003E \n\u003E Total: -51.38 m/s^2\n\u003E \n\u003E So my deceleration in-game is 3.6 m/s^2 lower that what my math says.\n\u003E \n\u003E I experimented with a lift force proportional to speed, and it does seem to help a bit, but I still don\u0027t get consistent results, and I don\u0027t understand why there should be such a force - the parts I\u0027ve used don\u0027t have a lift rating AFAICT.\n\u003E \n\u003E And yeah, I know 0.90 aerodynamics aren\u0027t realistic, but I\u0027m not looking for realistic, I\u0027m looking for internally consistent.\n\u003E \n\u003E Could someone please put me out of my misery and explain what is going on?\n\u003E \n\u003E Thanks.\n\nTry turning \u0022hack gravity\u0022 on to see if that makes it better or worse (isolate variables). Also try making a craft exclusively from 0.2 drag coefficient parts...\n\nI\u0027d also recommend you use a reliable source for the values you are using. The altitude meter takes time to update (it lags behind correct value) and maybe velocity value isnt updated as fast as required. Perhaps pause the game and take values manually from debug menu or your own plugin?\n\n- - - Updated - - -\n\n\u003E I doubt this is it. The gap is too big to be the result of any sane truncating; and, a game of this type should be expected to use high accuracy - all calculations being done in double, or at least single, precision floating-point, with no rounding except for display purposes.\n\nTruncation error CAN cause serious problems for integration (i.e. how high up it goes), but it should introduce negligible instantaneous error (which is what you are reporting). \n\nFurthermore, assuming KSP uses doubles for physics, integration error due to truncation is probably negligible. However, integration error due to step size is for sure not. In this case, you can expect results to match less if you improve the integration scheme, since Unity uses simple forward-euler integration. For best results, you should use forward Euler integration with the same time step.\n\n**Edited \u003Ctime datetime=\u00222015-05-13T17:20:08Z\u0022 title=\u002205/13/2015 05:20  PM\u0022 data-short=\u00229 yr\u0022\u003EMay 13, 2015\u003C/time\u003E by arkie87**"},{"CreatedByName":"Frida Space","CreatedById":60943,"CreatedDateTime":"2015-05-13T18:33:11Z","Content":"Maybe the gravitational acceleration is a bit off? It does decrease ever so slightly as you go up. It could make up for, say, .5% maybe of your 1% margin error"},{"CreatedByName":"arkie87","CreatedById":103434,"CreatedDateTime":"2015-05-13T19:38:05Z","Content":"\u003E \n\u003E Maybe the gravitational acceleration is a bit off? It does decrease ever so slightly as you go up. It could make up for, say, .5% maybe of your 1% margin error\n\nif you look at OP\u0027s calculations, he accounts for that"},{"CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-05-13T19:49:52Z","Content":"\u003E \n\u003E The altitude meter takes time to update (it lags behind correct value) and maybe velocity value isnt updated as fast as required.\n\nTHIS. In all of my recent measurements, I used these reported values mid-flight, because I wanted to isolate away the thrust phase. I was hoping they give me the correct value, and I could find the rest by interpolation. But if those are inaccurate... It can easily explain the discrepancies.\n\nSo I simulated the short flights from launch, and the discrepancy in max height is small. This still leaves me with a discrepancy that accumulates over longer flights, which is what I started with before trying to isolate things.\n\n\u003E \n\u003E Also try making a craft exclusively from 0.2 drag coefficient parts...\n\nI did, or at least I thought I did. Playing around in the debug window revealed that there are two drag values associated with each part. I tried a ship made purely of parts with equal min and max drag, but it doesn\u0027t help much.\n\n\u003E I\u0027d also recommend you use a reliable source for the values you are using. Perhaps pause the game and take values manually from debug menu or your own plugin?\n\nI didn\u0027t find in the debug menu a way to get altitude and velocity values (\u0022Flight debug stats\u0022 seems to just have some useless stuff). Can you suggest a way to get the data? If not in stock, perhaps an existing plugin, doing one myself is too much for me.\n\nIf I could find a way to measure local values accurately, it will certainly help.\n\n\u003E \n\u003E However, integration error due to step size is for sure not. In this case, you can expect results to match less if you improve the integration scheme, since Unity uses simple forward-euler integration. For best results, you should use forward Euler integration with the same time step.\n\nMy current setting is max dt/frame = 0.03 sec, which is too low to explain the discrepancy. I use a slightly fancier integration method, but I need a step size of ~2 secs to reach this kind of error. If all else fails I might try to rewrite my integration to match, but I doubt this is it."},{"CreatedByName":"arkie87","CreatedById":103434,"CreatedDateTime":"2015-05-14T12:42:51Z","Content":"\u003E \n\u003E THIS. In all of my recent measurements, I used these reported values mid-flight, because I wanted to isolate away the thrust phase. I was hoping they give me the correct value, and I could find the rest by interpolation. But if those are inaccurate... It can easily explain the discrepancies.\n\u003E So I simulated the short flights from launch, and the discrepancy in max height is small. This still leaves me with a discrepancy that accumulates over longer flights, which is what I started with before trying to isolate things.\n\u003E \n\u003E I did, or at least I thought I did. Playing around in the debug window revealed that there are two drag values associated with each part. I tried a ship made purely of parts with equal min and max drag, but it doesn\u0027t help much.\n\u003E \n\u003E I didn\u0027t find in the debug menu a way to get altitude and velocity values (\u0022Flight debug stats\u0022 seems to just have some useless stuff). Can you suggest a way to get the data? If not in stock, perhaps an existing plugin, doing one myself is too much for me.\n\u003E \n\u003E If I could find a way to measure local values accurately, it will certainly help.\n\u003E \n\u003E My current setting is max dt/frame = 0.03 sec, which is too low to explain the discrepancy. I use a slightly fancier integration method, but I nep size of ~2 secs to reach this kind of error. If all else fails I might try to rewrite my integration to match, but I doubt this is it.\n\nTime step only effects integration values. I.e. max altitude. It will have zero affect on instantaneous measurements, like acceleration. That value should still match. \n\nIs there a way in the debug menu to display forces on parts?\n\nIf so, use time control mod to slow down time to 1/64 real time. Which is almost like pausing game. \n\nIncidentally, time control mod might also be the easiest way to get accurate readouts...."},{"CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-05-14T13:17:49Z","Content":"\u003E \n\u003E Time step only effects integration values. I.e. max altitude. It will have zero affect on instantaneous measurements, like acceleration. That value should still match.\n\nI\u0027ll clarify that, now that I know that the instantaneous altitude reported by the game isn\u0027t accurate (lags by some amount), I no longer have evidence for a problem in the instantaneous acceleration. I only see a difference in max altitude.\n\n\u003E \n\u003E Is there a way in the debug menu to display forces on parts?\n\nNone that I\u0027ve seen.\n\n\u003E \n\u003E If so, use time control mod to slow down time to 1/64 real time. Which is almost like pausing game. \n\u003E \n\u003E Incidentally, time control mod might also be the easiest way to get accurate readouts....\n\nI\u0027ll try it. If this solves the altitude lag and I can get fine-grained, accurate altitude measurements, interpolating acceleration is relatively easy.\n\nUpdate: Time Control turns out to be only marginally useful. Kerbulator, on the other hand, is extremely useful. I\u0027ll play around a bit and report what I find.\n\n**Edited \u003Ctime datetime=\u00222015-05-14T14:34:43Z\u0022 title=\u002205/14/2015 02:34  PM\u0022 data-short=\u00229 yr\u0022\u003EMay 14, 2015\u003C/time\u003E by Holy-Fire**"},{"CreatedByName":"arkie87","CreatedById":103434,"CreatedDateTime":"2015-05-14T20:32:19Z","Content":"\u003E \n\u003E I\u0027ll clarify that, now that I know that the instantaneous altitude reported by the game isn\u0027t accurate (lags by some amount), I no longer have evidence for a problem in the instantaneous acceleration. I only see a difference in max altitude.\n\u003E None that I\u0027ve seen.\n\u003E \n\u003E I\u0027ll try it. If this solves the altitude lag and I can get fine-grained, accurate altitude measurements, interpolating acceleration is relatively easy.\n\u003E \n\u003E Update: Time Control turns out to be only marginally useful. Kerbulator, on the other hand, is extremely useful. I\u0027ll play around a bit and report what I find.\n\nI once used Time Control to slam into Kerbin\u0027s atmosphere at 300,000 m/s (using infinite fuel) at 1/64th time. It was glorious."},{"CreatedByName":"Holy-Fire","CreatedById":143761,"CreatedDateTime":"2015-06-01T16:19:01Z","Content":"I promised I\u0027d report what I found, so... My results were inconclusive. It seems I could not even get consistent results even with the velocity, let alone acceleration. That is, given a segment where vertical velocity ranged in [a, b], the difference in altitude was outside the range [a dt, b dt]. So there\u0027s definitely something weird going on, maybe some discrepancies in the coordinate system. I\u0027ve given up on trying to replicate it."}]}