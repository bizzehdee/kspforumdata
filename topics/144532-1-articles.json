{"TopicId":144532,"ForumId":29,"TopicTitle":"Stop click-through in KSP 1.1?","CreatedByName":"Angelo Kerman","CreatedById":106975,"CreatedDateTime":"2016-07-25T17:40:50Z","PageNum":1,"Articles":[{"CreatedByName":"Angelo Kerman","CreatedById":106975,"CreatedDateTime":"2016-07-25T17:40:50Z","Content":"\n\u003Cp\u003E\nHi all,\n\u003C/p\u003E\n\u003Cp\u003E\nI\u0027ve been researching ways to prevent click-through, a situation where, when you\u0027re doing a GUILayout and the user clicks the mouse button, and there is a context menu open beneath the window, then the context menu also receives the click event. So far I haven\u0027t had much luck stopping that from happening. For context, here is an image of what I\u0027m talking about. Notice how the context menu has a button right underneath the Coolant button. If I click the Coolant button, the context menu button also gets pressed. In this case, the button opens a \u003Cabbr title=\u0022Kerbal Inventory System (mod)\u0022\u003EKIS\u003C/abbr\u003E inventory, but imagine if it was something like a Decouple button..\n\u003C/p\u003E\n\u003Cp\u003E\nAnyway, So far, I\u0027ve found a few approaches:\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://forum.kerbalspaceprogram.com/index.php?/topic/75552-fixed-stopping-click-through-a-gui-window-part-menu-in-flight-and-editor/\u0022 rel=\u0022\u0022\u003EDisabling the UIPartActionWindow\u003C/a\u003E: I tried this and get NREs, so I\u0027m not sure it\u0027s working in KSP 1.1.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022https://forum.kerbalspaceprogram.com/index.php?/topic/121540-any-way-to-stop-the-clickthrough/\u0022 rel=\u0022\u0022\u003EInput lock\u003C/a\u003E: This will lock the game controls (landing gear, lights, editor buttons), but won\u0027t stop the event from propagating to the context menu.\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Ca href=\u0022http://docs.unity3d.com/es/current/ScriptReference/Event.Use.html\u0022 rel=\u0022external nofollow\u0022\u003EEvent.Use()\u003C/a\u003E: The context menu doesn\u0027t appear to respect this. I suspect that it has to do with the fact that KSP is using the newer \u003Ca href=\u0022https://docs.unity3d.com/Manual/UICanvas.html\u0022 rel=\u0022external nofollow\u0022\u003Ecanvas-based UI\u003C/a\u003E in Unity.\n\u003C/p\u003E\n\u003Cp\u003E\nShort of converting all my GUI code over to the newer canvas-based system, which might not solve the problem, is there another method that I\u0027m not seeing?\n\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2016-07-26T07:18:21Z","Content":"\n\u003Cp\u003E\nThe new UI would solve your problem (and it\u0027s worthwhile to use: even optimized, the below creates at least 176 bytes in GC allocations per frame), but another option is to take advantage of the EventSystem the new UI uses by adding a raycaster that \u0022hits\u0022 your window first and directs all events to it. Here\u0027s a hacky example (real world multi-window mod should probably factor out the raycaster code into some kind of manager and enable/disable the mouse controller a bit more intelligently to play nicely with anybody else doing the same)\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode\u0022\u003E\n[KSPAddon(KSPAddon.Startup.Flight, false)]\nclass ClickthroughExample : BaseRaycaster\n{\n    // normal UI stuff\n    private Rect _window = new Rect(0f, 0f, 300f, 300f);\n\n    // these two save a bit on garbage created in OnGUI\n    private readonly GUILayoutOption[] _emptyOptions = new GUILayoutOption[0];\n    private GUI.WindowFunction _windowFunction;\n\n    // enable/disable this to prevent the \u0022No Target\u0022 from popping up by double-clicking on the window \n    private Mouse _mouseController; \n\n    protected override void Awake()\n    {\n        _windowFunction = DrawWindow;\n        _mouseController = HighLogic.fetch.GetComponent\u0026lt;Mouse\u0026gt;();\n\n        _window.center = new Vector2(Screen.width * 0.5f, Screen.height * 0.5f);\n        name = \u0022ClickthroughExample\u0022;\n    }\n\n    private void OnDestroy()\n    {\n        if (_mouseController) _mouseController.enabled = true;\n    }\n\n    // 88 bytes GCAlloc per call, 2x per frame \u002B 1 for each event\n    private void OnGUI()\n    {\n        _window = KSPUtil.ClampRectToScreen(GUILayout.Window(GetInstanceID(), _window, _windowFunction, \u0022Clickthrough Example\u0022, HighLogic.Skin.window, _emptyOptions));\n    }\n\n    private void DrawWindow(int winid)\n    {\n        GUILayout.Label(\u0022Drag this window around and see if you can click through on anything\u0022, _emptyOptions);\n        GUI.DragWindow();\n    }\n\n    public override void Raycast(PointerEventData eventData, List\u0026lt;RaycastResult\u0026gt; resultAppendList)\n    {\n        var mouse = Input.mousePosition;\n        var screenPos = new Vector2(mouse.x, Screen.height - mouse.y);\n\n        if (!_window.Contains(screenPos))\n        {\n            _mouseController.enabled = true;\n            return;\n        }\n\n        _mouseController.enabled = false;\n        Mouse.Left.ClearMouseState();\n        Mouse.Middle.ClearMouseState();\n        Mouse.Right.ClearMouseState();\n\n        resultAppendList.Add(new RaycastResult\n        {\n            depth = 0,\n            distance = 0f,\n            gameObject = gameObject,\n            module = this,\n            sortingLayer = MainCanvasUtil.MainCanvas.sortingLayerID,\n            screenPosition = screenPos\n        });\n    }\n\n    public override Camera eventCamera\n    {\n        get { return null; }\n    }\n\n    public override int sortOrderPriority\n    {\n        get { return MainCanvasUtil.MainCanvas.sortingOrder - 1; }\n    }\n}\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2016-07-26T08:34:39Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222691383\u0022 data-ipsquote-contentid=\u0022144532\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221469517501\u0022 data-ipsquote-userid=\u002275857\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n1 hour ago, xEvilReeperx said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nThe new UI would solve your problem (and it\u0027s worthwhile to use: even optimized, the below creates at least 176 bytes in GC allocations per frame), but another option is to take advantage of the EventSystem the new UI uses by adding a raycaster that \u0022hits\u0022 your window first and directs all events to it. Here\u0027s a hacky example (real world multi-window mod should probably factor out the raycaster code into some kind of manager and enable/disable the mouse controller a bit more intelligently to play nicely with anybody else doing the same)\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\n\u003Cspan class=\u0022pln\u0022\u003E_window = KSPUtil.ClampRectToScreen(GUILayout.Window(GetInstanceID(), _window, _windowFunction, \u0022Clickthrough Example\u0022, HighLogic.Skin.window, _emptyOptions));\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nEdit : err. no. Ignore me while I hide in the corner \u003Cimg alt=\u0022:D\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_cheesy.gif\u0022 title=\u0022:D\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nEdit 2 : try to replace \u0022Clickthrough Example\u0022 with a static instance of\u00A0 \u0022new GUIContent( \u0022Clickthrough Example\u0022 )\u0022, like the empty array\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-07-26T08:39:24Z\u0022 title=\u002207/26/2016 08:39  AM\u0022 data-short=\u00227 yr\u0022\u003EJuly 26, 2016\u003C/time\u003E by sarbian\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2016-07-26T08:39:05Z","Content":"\n\u003Cp\u003E\nHighLogic.Skin.window is a GUIStyle, not a GUILayoutOption. This is the overload I\u0027m using:\n\u003C/p\u003E\n\u003Cp\u003E\n\u003Cspan style=\u0022color:#008000;\u0022\u003E// UnityEngine.GUILayout\u003C/span\u003E\u003Cbr\u003E\u003Cspan style=\u0022color:#0000ff;font-weight:bold;\u0022\u003Epublic\u003C/span\u003E \u003Cspan style=\u0022color:#a52a2a;\u0022\u003Estatic\u003C/span\u003E Rect \u003Cspan style=\u0022color:#191970;font-weight:bold;\u0022\u003EWindow\u003C/span\u003E(\u003Cspan style=\u0022color:#ff0000;font-weight:bold;\u0022\u003Eint\u003C/span\u003E id, Rect screenRect, GUI.WindowFunction func, \u003Cspan style=\u0022color:#ff0000;\u0022\u003Estring\u003C/span\u003E text, GUIStyle style, \u003Cspan style=\u0022color:#ff1493;font-weight:bold;\u0022\u003Eparams\u003C/span\u003E GUILayoutOption[] options)\n\u003C/p\u003E\n\u003Cp\u003E\nEdit to respond to edit: still isn\u0027t an issue \u003Cimg alt=\u0022:wink:\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 title=\u0022;)\u0022\u003E That overload uses a temp GUIContent so it isn\u0027t allocating\n\u003C/p\u003E\n\u003Cp\u003E\n\u00A0\n\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-07-26T08:43:02Z\u0022 title=\u002207/26/2016 08:43  AM\u0022 data-short=\u00227 yr\u0022\u003EJuly 26, 2016\u003C/time\u003E by xEvilReeperx\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"sarbian","CreatedById":57146,"CreatedDateTime":"2016-07-26T08:41:10Z","Content":"\n\u003Cp\u003E\n\u003Ca contenteditable=\u0022false\u0022 data-ipshover=\u0022\u0022 data-ipshover-target=\u0022https://forum.kerbalspaceprogram.com/index.php?/profile/75857-xevilreeperx/\u0026amp;do=hovercard\u0022 data-mentionid=\u002275857\u0022 href=\u0022%7B___base_url___%7D/index.php?/profile/75857-xevilreeperx/\u0022 rel=\u0022external\u0022\u003E@xEvilReeperx\u003C/a\u003E see my edit \u003Cimg alt=\u0022:wink:\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_wink.gif\u0022 title=\u0022;)\u0022\u003E\u003C/p\u003E\n\u003Cp\u003E\nEdit : I should not look at that while working \u003Cimg alt=\u0022:)\u0022 data-emoticon=\u0022\u0022 src=\u0022//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_smiley.gif\u0022 title=\u0022:)\u0022\u003E\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222016-07-26T08:46:30Z\u0022 title=\u002207/26/2016 08:46  AM\u0022 data-short=\u00227 yr\u0022\u003EJuly 26, 2016\u003C/time\u003E by sarbian\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"westamastaflash","CreatedById":110546,"CreatedDateTime":"2016-07-27T01:12:04Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222691383\u0022 data-ipsquote-contentid=\u0022144532\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221469517501\u0022 data-ipsquote-userid=\u002275857\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n17 hours ago, xEvilReeperx said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nThe new UI would solve your problem (and it\u0027s worthwhile to use: even optimized, the below creates at least 176 bytes in GC allocations per frame)\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nIs there a good tutorial on setting up the new UI? Everything I\u0027ve seen seems to require I build an entire GUI system from scratch in code, or else figure out the unity editor. I would much prefer to do it in code like now, the immediate mode GUI makes it very easy to set up basic windows...\n\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2016-07-27T06:07:02Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222692600\u0022 data-ipsquote-contentid=\u0022144532\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221469581924\u0022 data-ipsquote-userid=\u0022110546\u0022 data-ipsquote-username=\u0022westamastaflash\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n4 hours ago, westamastaflash said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nI would much prefer to do it in code like now, the immediate mode GUI makes it very easy to set up basic windows...\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nIn my experience, it isn\u0027t worthwhile to set up the new GUI through pure code. It\u0027s possible for the simplest of UIs but you\u0027ll be much better off working inside the Unity editor in the vast majority of cases. Tutorial-wise, most of the standard UI tutorials apply and there\u0027s example code to load from AssetBundles lying around here somewhere\n\u003C/p\u003E\n"},{"CreatedByName":"DMagic","CreatedById":57416,"CreatedDateTime":"2016-07-27T15:30:41Z","Content":"\n\u003Cp\u003E\nI\u0027ve been using that old part action window click-through workaround in 1.1.x and it seems to be fine.\n\u003C/p\u003E\n\u003Cp\u003E\nBut looking at the code again it seems like a horrendously inefficient method. That\u0027s a\u00A0FindObjectsOfType and two Linq statements for every GUI frame when the mouse is over your window. I suppose if this is an infrequently used window that might be ok, but for anything that is meant to be open a lot it seems very bad.\n\u003C/p\u003E\n\u003Cp\u003E\nUIPartActionController would seem to be the best option for looking for open part action windows. Unfortunately the simple list of windows looks like it\u0027s private, so the only way to get the active windows is by searching through for every part.\n\u003C/p\u003E\n\u003Cpre class=\u0022ipsCode prettyprint lang-html prettyprinted\u0022\u003E\n\u003Cspan class=\u0022pln\u0022\u003EUIPartActionWindow window = UIPartActionController.Instance.GetItem(part, symmetry bool);\u003C/span\u003E\u003C/pre\u003E\n\u003Cp\u003E\nI\u0027m not sure\u00A0that running through each part is faster than the FindObjectsOfType method, it probably\u00A0depends\u00A0on how the\u00A0UIPartActionController method works and how many parts you have. And you would have to run through the parts for all unpacked vessels to get accurate results...\n\u003C/p\u003E\n\u003Cp\u003E\nMaking a public version of that internal window list would really help.\n\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2016-07-27T16:18:46Z","Content":"\n\u003Cblockquote class=\u0022ipsQuote\u0022 data-ipsquote=\u0022\u0022 data-ipsquote-contentapp=\u0022forums\u0022 data-ipsquote-contentclass=\u0022forums_Topic\u0022 data-ipsquote-contentcommentid=\u00222693270\u0022 data-ipsquote-contentid=\u0022144532\u0022 data-ipsquote-contenttype=\u0022forums\u0022 data-ipsquote-timestamp=\u00221469633441\u0022 data-ipsquote-userid=\u002257416\u0022 data-ipsquote-username=\u0022DMagic\u0022\u003E\n\u003Cdiv class=\u0022ipsQuote_citation\u0022\u003E\n43 minutes ago, DMagic said:\n\u003C/div\u003E\n\u003Cdiv class=\u0022ipsQuote_contents\u0022\u003E\n\u003Cp\u003E\nUIPartActionController would seem to be the best option for looking for open part action windows. Unfortunately the simple list of windows looks like it\u0027s private, so the only way to get the active windows is by searching through for every part.\n\u003C/p\u003E\n\u003C/div\u003E\n\u003C/blockquote\u003E\n\u003Cp\u003E\nThe window prefab is exposed so you can just add a tracking component that keeps them in a list to avoid FindObjectsOfType or any iterating. I agree that just making the list public would be handy though\u003Cspan\u003E \u003C/span\u003E\n\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2016-09-04T22:56:29Z","Content":"\n\u003Cp\u003E\nJust wanted to say that this was great, solved a problem I was having.\n\u003C/p\u003E\n\u003Cp\u003E\nThanks\n\u003C/p\u003E\n"}]}