{"TopicId":103963,"ForumId":36,"TopicTitle":"[WIP][1.9.x-1.12.x] Scatterer-atmospheric scattering (0.0838 - 14/08/2022) Scattering improvements, in-game atmo generation and multi-sun support","CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2015-04-12T08:37:35Z","PageNum":274,"Articles":[{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-11-27T13:25:55Z","Content":"\u003E \n\u003E \n\u003E 4 hours ago, DrPastah said:\n\u003E \n\u003E \n\u003E How do I optimize terrain shadows? I think that\u0027s the issue as my FPS goes up when I\u0027m high above Kerbin. I don\u0027t understand the settings.\n\u003E \n\nThe only setting affecting shadow performance is in the game settings under \u0022shadow quality\u0022 and \u0022shadow cascades\u0022. The settings in scatterer are for fixing artifacts.\n\nYou can do what Agustin said, that\u0027s it really, other settings don\u0027t affect performance."},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-11-27T19:38:34Z","Content":"Hello everyone,\n\nif the current **\u0022Draw atmo on top of \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E clouds(old cloud shading, use with \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E 7-4)\u0022** was removed to allow for improvements to the scaled space shaders and a more coherent look throughout (only the new \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E integration would be left) as well as fixes to atmosphere draw orders and to streamline development, would this be an issue?"},{"CreatedByName":"Galileo","CreatedById":150430,"CreatedDateTime":"2017-11-27T19:44:00Z","Content":"\u003E \n\u003E \n\u003E 4 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E Hello everyone,\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E if the current **\u0022Draw atmo on top of \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E clouds(old cloud shading, use with \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E 7-4)\u0022** was removed to allow for improvements to the scaled space shaders and a more coherent look throughout (only the new \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E integration would be left) as well as fixes to atmosphere draw orders and to streamline development, would this be an issue?\n\u003E \n\nNope, I\u2019m all for progression. Having to continue to develop for an older plugin will just continue to slow development. \n\n**Edited \u003Ctime datetime=\u00222017-11-27T23:47:54Z\u0022 title=\u002211/27/2017 11:47  PM\u0022 data-short=\u00226 yr\u0022\u003ENovember 27, 2017\u003C/time\u003E by Galileo**"},{"CreatedByName":"Galileo","CreatedById":150430,"CreatedDateTime":"2017-11-27T20:05:43Z","Content":"[@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) is there anyway you can make the map view match the configPoint with the highest altitude by default instead of us having to try an match it up manually? I hate getting a body to look good, but then I forget to adjust the map view and have to spend more time on that.\n\n**Edited \u003Ctime datetime=\u00222017-11-27T20:13:44Z\u0022 title=\u002211/27/2017 08:13  PM\u0022 data-short=\u00226 yr\u0022\u003ENovember 27, 2017\u003C/time\u003E by Galileo**"},{"CreatedByName":"blackrack","CreatedById":104258,"CreatedDateTime":"2017-11-27T20:14:04Z","Content":"\u003E \n\u003E \n\u003E 7 minutes ago, Galileo said:\n\u003E \n\u003E \n\u003E [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) is there anyway you can make the map view match the configPoint instead by default instead of us having to try an match it up manually? I hate getting a body to look good, but then I forget to adjust the map view and have to spend more time on that.\n\u003E \n\nI can add a \u0022copy settings from top node\u0022 button I guess, just make sure to remind me If I forget ![:P](//kerbal-forum-uploads.s3.us-west-2.amazonaws.com/emoticons/default_k_tongue.gif \u0022:P\u0022)"},{"CreatedByName":"Galileo","CreatedById":150430,"CreatedDateTime":"2017-11-27T20:15:01Z","Content":"That would be awesome"},{"CreatedByName":"Poodmund","CreatedById":128643,"CreatedDateTime":"2017-11-27T21:55:13Z","Content":"\u003E \n\u003E \n\u003E 2 hours ago, blackrack said:\n\u003E \n\u003E \n\u003E Hello everyone,\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E if the current **\u0022Draw atmo on top of \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E clouds(old cloud shading, use with \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E 7-4)\u0022** was removed to allow for improvements to the scaled space shaders and a more coherent look throughout (only the new \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E integration would be left) as well as fixes to atmosphere draw orders and to streamline development, would this be an issue?\n\u003E \n\nAbsolutely not an issue. \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E 7-4 should not be used, its archaic and if its holding back potential development of this plugin then that is pretty sad to be honest."},{"CreatedByName":"Agustin","CreatedById":172127,"CreatedDateTime":"2017-11-28T18:12:43Z","Content":"\u003E \n\u003E \n\u003E 22 hours ago, Galileo said:\n\u003E \n\u003E \n\u003E [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) is there anyway you can make the map view match the configPoint with the highest altitude by default instead of us having to try an match it up manually? I hate getting a body to look good, but then I forget to adjust the map view and have to spend more time on that.\n\u003E \n\nwhat is that?"},{"CreatedByName":"Shadowmage","CreatedById":138730,"CreatedDateTime":"2017-11-30T16:22:36Z","Content":"\u003E \n\u003E \n\u003E On 11/27/2017 at 12:38 PM, blackrack said:\n\u003E \n\u003E \n\u003E scaled space shaders and a more coherent look throughout (only the new \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E integration would be left) as well as fixes to atmosphere draw orders and to streamline development, would this be an issue?\n\u003E \n\nWhile I have absolutely nothing against dropping of legacy \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E support (yay for progress) -- I\u0027m curious if the changes to the Scatterer shaders will have any impact on the ability to capture the visuals in standard cameras (e.g. TextureReplacer / TexturesUnlimited)?\n\nCurrently I\u0027m able to capture the standard (non-scaled space) atmosphere scattering properly during cubemap creation (e.g. while on the surface/in the atmo) -- but the scaled space scatter appears to be done as a post-process effect rather than as a rendered mesh (e.g. no atmosphere/scattering in reflections when on-orbit).  Is this still the case / changing at all?\n\n(On that note, I would love for there to be a method to properly capture the post-process effects (ocean/scaled-space scatter) in cubemap reflection cameras; could possibly put together a PR if there was interest in such a feature/support)"},{"CreatedByName":"MOARdV","CreatedById":60950,"CreatedDateTime":"2017-11-30T22:41:55Z","Content":"\u003E \n\u003E \n\u003E 6 hours ago, Shadowmage said:\n\u003E \n\u003E \n\u003E (On that note, I would love for there to be a method to properly capture the post-process effects (ocean/scaled-space scatter) in cubemap reflection cameras; could possibly put together a PR if there was interest in such a feature/support)\n\u003E \n\nThe RPM / MAS cameras show visual errors with scatterer / \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E currently.  I\u0027ve blindly poked at the problem with a sharp stick several times, but it keeps resurfacing.  If this PR was general enough to work for non-cubemap-reflection cameras, I would be extremely happy."},{"CreatedByName":"Shadowmage","CreatedById":138730,"CreatedDateTime":"2017-11-30T23:05:58Z","Content":"\u003E \n\u003E \n\u003E 15 minutes ago, MOARdV said:\n\u003E \n\u003E \n\u003E The RPM / MAS cameras show visual errors with scatterer / \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E currently.  I\u0027ve blindly poked at the problem with a sharp stick several times, but it keeps resurfacing.  If this PR was general enough to work for non-cubemap-reflection cameras, I would be extremely happy.\n\u003E \n\nWell, currently if you give your camera the same name as the Texture Replacer camera -- it ~~will~~ *should* remove the visual artifacts ( name:  TRReflectionCamera  ).  This is some code built-into Scatterer that disables the post-processing anytime a camera with that specific name is doing any rendering, and it works great so far from my interactions with it.\n\nBut it does this by disabling post processing for those cameras -- which, by its nature, precludes any potential to use the effects from that post-processing (god-ray-shadows, ocean surfaces, probably more I haven\u0027t poked at).\n\n*If* I\u0027ve read the Scatterer code correctly -- it *might* be possible to properly setup the post-processing effects so that they are applied to the cubemap/other cameras properly.  I say -might-, because I\u0027m not sure how resource/computation the setup is for the different camera location/perspectives/frustum setups.  Potentially it could be \u0027as simple\u0027 as pushing a camera location, orientation and near/far clip data into the post-processing setup."},{"CreatedByName":"Shadowmage","CreatedById":138730,"CreatedDateTime":"2017-12-01T00:23:43Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, MOARdV said:\n\u003E \n\u003E \n\u003E \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003E[...snip...] problems with EVE\u003C/abbr\u003E currently.\n\u003E \n\nThis is actually a second problem that I had to find a solution for -- \u003Cabbr title=\u0022Environmental Visual Enhancement (mod)\u0022\u003EEVE\u003C/abbr\u003E by default writes \u00270\u0027 into the alpha channel of anything underneath a \u0027cloud shadow\u0027.  Basically you have to add a full-screen post-process filter to fix the alpha channel.  -- [https://github.com/shadowmage45/TexturesUnlimited/blob/master/CustomShaders/SSTU-SetAlpha.shader](https://github.com/shadowmage45/TexturesUnlimited/blob/master/CustomShaders/SSTU-SetAlpha.shader) -- [https://github.com/shadowmage45/TexturesUnlimited/blob/master/Plugin/SSTUTools/KSPShaderTools/Addon/ReflectionManager.cs#L265](https://github.com/shadowmage45/TexturesUnlimited/blob/master/Plugin/SSTUTools/KSPShaderTools/Addon/ReflectionManager.cs#L265) --  [https://github.com/shadowmage45/TexturesUnlimited/blob/master/Plugin/SSTUTools/KSPShaderTools/Addon/ReflectionManager.cs#L756-L791](https://github.com/shadowmage45/TexturesUnlimited/blob/master/Plugin/SSTUTools/KSPShaderTools/Addon/ReflectionManager.cs#L756-L791)\n\n(Apologies for the semi-off-topic stuff....)"},{"CreatedByName":"Tynton","CreatedById":130307,"CreatedDateTime":"2017-12-01T05:22:02Z","Content":"[@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) I\u0027ve been trying to use some of JadeofMaar\u0027s lensflares for a mod that adds a number of new stars. Well what happened is that I ended up running out of RAM almost with only two stars after testing his lensflares. I\u0027m not certain entirely what is going wrong but I did use the stock scatterer lensflares without issue."},{"CreatedByName":"Galileo","CreatedById":150430,"CreatedDateTime":"2017-12-01T05:38:58Z","Content":"\u003E \n\u003E \n\u003E 17 minutes ago, Tynton said:\n\u003E \n\u003E \n\u003E [@blackrack](https://forum.kerbalspaceprogram.com/index.php?/profile/104258-blackrack/) I\u0027ve been trying to use some of JadeofMaar\u0027s lensflares for a mod that adds a number of new stars. Well what happened is that I ended up running out of RAM almost with only two stars after testing his lensflares. I\u0027m not certain entirely what is going wrong but I did use the stock scatterer lensflares without issue.\n\u003E \n\nHis textures are 5k textures. That may be an issue for your system. I would bring it up with [@JadeOfMaar](https://forum.kerbalspaceprogram.com/index.php?/profile/167617-jadeofmaar/) on his thread. I would have logs ready so he can get a look at your specs\n\n**Edited \u003Ctime datetime=\u00222017-12-01T05:39:52Z\u0022 title=\u002212/01/2017 05:39  AM\u0022 data-short=\u00226 yr\u0022\u003EDecember 1, 2017\u003C/time\u003E by Galileo**"},{"CreatedByName":"Tynton","CreatedById":130307,"CreatedDateTime":"2017-12-01T05:40:12Z","Content":"[@Galileo](https://forum.kerbalspaceprogram.com/index.php?/profile/150430-galileo/) I turned the resolution down to 1K, I was PM\u0027ing him about the issue and we decided to bring it up to blackrack."},{"CreatedByName":"Galileo","CreatedById":150430,"CreatedDateTime":"2017-12-01T05:41:20Z","Content":"\u003E \n\u003E \n\u003E Just now, Tynton said:\n\u003E \n\u003E \n\u003E [@Galileo](https://forum.kerbalspaceprogram.com/index.php?/profile/150430-galileo/) I turned the resolution down to 1K, I was PM\u0027ing him about the issue and we decided to bring it up to blackrack.\n\u003E \n\nAh wierd.. well I would have logs ready any way, just in case it\u2019s something easily identifiable in them"},{"CreatedByName":"Tynton","CreatedById":130307,"CreatedDateTime":"2017-12-01T05:48:58Z","Content":"Links to output log and KSP log: [https://www.dropbox.com/sh/ci6u0gqhwxd2i3b/AACjf47Tl8C9tAIAxYi_ulNFa?dl=0](https://www.dropbox.com/sh/ci6u0gqhwxd2i3b/AACjf47Tl8C9tAIAxYi_ulNFa?dl=0)"},{"CreatedByName":"Agustin","CreatedById":172127,"CreatedDateTime":"2017-12-01T12:57:54Z","Content":"i have lots of these:  \n\n[EXC 18:15:14.273] NullReferenceException  \n\n    scatterer.DisableEffectsForTextureReplacer.OnPreCull ()  \n\n    UnityEngine.Camera:RenderToCubemap(RenderTexture, Int32)  \n\n    KSPShaderTools.ReflectionManager:renderCubeFace(RenderTexture, Int32, Vector3, Int32, Single, Single)  \n\n    KSPShaderTools.ReflectionManager:renderFace(RenderTexture, Int32, Vector3)  \n\n    KSPShaderTools.ReflectionManager:updateReflections(Boolean)  \n\n    KSPShaderTools.ReflectionManager:Update()\n\nKSP.log:\n\n[https://www.dropbox.com/s/py8hy3j7hozherp/KSP LOG AGUSTIN.rar?dl=0](https://www.dropbox.com/s/py8hy3j7hozherp/KSP%20LOG%20AGUSTIN.rar?dl=0)\n\n![1A4HGFv.png](https://i.imgur.com/1A4HGFv.png)\n\n**Edited \u003Ctime datetime=\u00222017-12-01T13:00:15Z\u0022 title=\u002212/01/2017 01:00  PM\u0022 data-short=\u00226 yr\u0022\u003EDecember 1, 2017\u003C/time\u003E by Agustin**"},{"CreatedByName":"maja","CreatedById":168379,"CreatedDateTime":"2017-12-01T13:20:16Z","Content":"\u003E \n\u003E \n\u003E 16 minutes ago, Agustin said:\n\u003E \n\u003E \n\u003E i have lots of these:  \n\u003E \n\u003E [EXC 18:15:14.273] NullReferenceException  \n\u003E \n\u003E     scatterer.DisableEffectsForTextureReplacer.OnPreCull ()  \n\u003E \n\u003E     UnityEngine.Camera:RenderToCubemap(RenderTexture, Int32)  \n\u003E \n\u003E     KSPShaderTools.ReflectionManager:renderCubeFace(RenderTexture, Int32, Vector3, Int32, Single, Single)  \n\u003E \n\u003E     KSPShaderTools.ReflectionManager:renderFace(RenderTexture, Int32, Vector3)  \n\u003E \n\u003E     KSPShaderTools.ReflectionManager:updateReflections(Boolean)  \n\u003E \n\u003E     KSPShaderTools.ReflectionManager:Update()\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E KSP.log:\n\u003E \n\u003E \n\u003E \n\u003E \n\u003E [https://www.dropbox.com/s/py8hy3j7hozherp/KSP LOG AGUSTIN.rar?dl=0](https://www.dropbox.com/s/py8hy3j7hozherp/KSP%20LOG%20AGUSTIN.rar?dl=0)\n\u003E \n\nI see that you have TextureReplacerReplaced v0.5.1.0. Try to update to the latest version (v0.5.3) and if this isn\u0027t help, then try to narrow it to the lowest number of mods to replicate this exception. I have the latest scatterer, SVE and TRR and don\u0027t have this issue."},{"CreatedByName":"Galileo","CreatedById":150430,"CreatedDateTime":"2017-12-01T15:52:58Z","Content":"Agustin, it may also be Texures Unlimited since it\u2019s deals with A LOT of reflections...."},{"CreatedByName":"Shadowmage","CreatedById":138730,"CreatedDateTime":"2017-12-01T16:24:31Z","Content":"\u003E \n\u003E \n\u003E 21 minutes ago, Galileo said:\n\u003E \n\u003E \n\u003E Agustin, it may also be Texures Unlimited since it\u2019s deals with A LOT of reflections....\n\u003E \n\nExcept that in this case the error is occurring from inside of Scatterer specific code, being called through standard Unity methods.\n\nSomething in the Scatterer code is not checking its references properly in that function (  scatterer.DisableEffectsForTextureReplacer.OnPreCull ()  ).  It is not a function that TU is calling, but is one of the Unity callbacks that has been built into scatterer code, which Unity calls whenever any camera renders anything (I have zero control over that function from TU end of things).  Nor is TU at any point touching anything in Scatterer ( there is no code-side interaction between the two ).\n\nI\u0027\u0027m more than happy to try and help track down *what* is going on, but it is not something that *I* will be able to fix."},{"CreatedByName":"Agustin","CreatedById":172127,"CreatedDateTime":"2017-12-01T16:36:24Z","Content":"I updated Texture Replacer Replaced and it still happens anyway. I\u0027ll try to do some testing and come back but I have this err logs for quite some time now... Sometimes it gets worse, sometimes it doesn\u0027t... Now I am playing and the ALT\u002BF12 windoes is full of red messages saying exception null reference.\n\nIn kspx64 folder there are these as well... This last time more than before...\n\nNullReferenceException  \n\n  at (wrapper managed-to-native) UnityEngine.Renderer:set\\_enabled (bool)  \n\n  at scatterer.DisableEffectsForTextureReplacer.OnPreCull () [0x00000] in \u003Cfilename unknown=\u0022\u0022\u003E:0\u003Cbr\u003E\nUnityEngine.Camera:Internal_RenderToCubemapRT(RenderTexture, Int32)\u003Cbr\u003E\nUnityEngine.Camera:RenderToCubemap(RenderTexture, Int32)\u003Cbr\u003E\nKSPShaderTools.ReflectionManager:renderCubeFace(RenderTexture, Int32, Vector3, Int32, Single, Single)\u003Cbr\u003E\nKSPShaderTools.ReflectionManager:renderFace(RenderTexture, Int32, Vector3)\u003Cbr\u003E\nKSPShaderTools.ReflectionManager:updateReflections(Boolean)\u003Cbr\u003E\nKSPShaderTools.ReflectionManager:Update()\n\u003C/filename\u003E\n\n(Filename:  Line: -1)\n\n**Edited \u003Ctime datetime=\u00222017-12-01T16:41:39Z\u0022 title=\u002212/01/2017 04:41  PM\u0022 data-short=\u00226 yr\u0022\u003EDecember 1, 2017\u003C/time\u003E by Agustin**"},{"CreatedByName":"maja","CreatedById":168379,"CreatedDateTime":"2017-12-01T16:59:56Z","Content":"[@Augustin](https://forum.kerbalspaceprogram.com/index.php?/profile/156145-augustin/) narrow it down to least amount of mods needed to reproduce this error. It will help track down this bug."},{"CreatedByName":"Agustin","CreatedById":172127,"CreatedDateTime":"2017-12-01T18:16:54Z","Content":"\u003E \n\u003E \n\u003E 1 hour ago, maja said:\n\u003E \n\u003E \n\u003E [@Augustin](https://forum.kerbalspaceprogram.com/index.php?/profile/156145-augustin/) narrow it down to least amount of mods needed to reproduce this error. It will help track down this bug.\n\u003E \n\nI am trying but it\u0027s difficult. Recently I launched a rocket and everything was okay. Then I reverted to the \u003Cabbr title=\u0022Vehicle Assembly Building\u0022\u003EVAB\u003C/abbr\u003E and launched again, and full of constant nullreference messages. I reverted back and launched again(exact thing I did before, seconds after launchnig) and the errors were not there anymore. Maybe I am in space and it starts to happen again with no aparent reason...\n\nNext time it happens I will save and try to make it reproducable or something\n\n**Edited \u003Ctime datetime=\u00222017-12-01T18:46:30Z\u0022 title=\u002212/01/2017 06:46  PM\u0022 data-short=\u00226 yr\u0022\u003EDecember 1, 2017\u003C/time\u003E by Agustin**"},{"CreatedByName":"Shadowmage","CreatedById":138730,"CreatedDateTime":"2017-12-01T19:17:37Z","Content":"[@Agustin](https://forum.kerbalspaceprogram.com/index.php?/profile/172127-agustin/) The error is not caused by TextureReplacer, but is being triggered by TexturesUnlimited; the code with the error would *appear* to be in the Scatterer code that disables scatterer for reflection cameras  (I say *appear*, as sometimes the root cause of a problem can be not what it would seem).  The solution will likely have to come on the Scatterer end of things, though I won\u0027t know more until I can setup the Scatterer repo/build environment and dig in for some testing.\n\n(I am quite curious why I have not seen any of these problems during my debug/testing?  Are you using DX9 by chance? )"}]}