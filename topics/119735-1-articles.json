{"TopicId":119735,"ForumId":36,"TopicTitle":"Craft images","CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-08-30T13:27:23Z","PageNum":1,"Articles":[{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-08-30T13:27:23Z","Content":"\n\u003Cp\u003EAny know how to generate an image of a craft from a craft file? Specifically, small images like shown when selecting a craft in the VAB\u003C/p\u003E\u003Cp\u003EThanks\u003C/p\u003E\n"},{"CreatedByName":"Yukon0009","CreatedById":109376,"CreatedDateTime":"2015-08-30T13:28:59Z","Content":"\n\u003Cp\u003EIt should be in the \u0022thumbs\u0022 file.\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-08-30T14:58:29Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Yukon0009\u0022 data-cite=\u0022Yukon0009\u0022\u003E\u003Cdiv\u003EIt should be in the \u0022thumbs\u0022 file.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI need to know how to generate the \u0022thumbs\u0022 file\u003C/p\u003E\u003Cp\u003EThanks\u003C/p\u003E\n"},{"CreatedByName":"Yukon0009","CreatedById":109376,"CreatedDateTime":"2015-08-30T15:02:23Z","Content":"\n\u003Cp\u003EThe thumbnails are generated automatically, in the KSP main file there is a subfile called thumbs that is there with the otheres eg GameData.\u003C/p\u003E\n"},{"CreatedByName":"MrHappyFace","CreatedById":76365,"CreatedDateTime":"2015-08-30T16:15:19Z","Content":"\n\u003Cp\u003EIf you want to do it using code, try the CraftThumbnail class\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-08-30T19:15:19Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022Yukon0009\u0022 data-cite=\u0022Yukon0009\u0022\u003E\u003Cdiv\u003EThe thumbnails are generated automatically, in the KSP main file there is a subfile called thumbs that is there with the otheres eg GameData.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EI know that, I\u0027d like to be able to generate them BEFORE putting a craft into the craft directory.\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-08-30T21:46:40Z","Content":"\n\u003Cp\u003EI found this posting:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/119609-Manually-generating-ship-thumbnail\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://forum.kerbalspaceprogram.com/threads/119609-Manually-generating-ship-thumbnail\u003C/a\u003E\u003C/p\u003E\u003Cp\u003Eand it works well for a single ship.\u003C/p\u003E\u003Cp\u003Ehowever, i\u0027m having a problem with generating a number of images all at once:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Efor (int i = 0; i \u0026lt; m_filesWithImages.Length; \u002B\u002Bi) {\u003Cbr\u003E    if (m_files [i].Contains (\u0022.craft\u0022)) {\u003Cbr\u003E        string f = m_newDirectory \u002B \u0022/\u0022 \u002B m_files [i];\u003Cbr\u003E\u003Cbr\u003E        if (System.IO.File.Exists (f)) {\u003Cbr\u003E\u003Cbr\u003E            var configFile = ConfigNode.Load (f);\u003Cbr\u003E\u003Cbr\u003E            ShipConstruct ship = new ShipConstruct ();\u003Cbr\u003E            ship.LoadShip (configFile);\u003Cbr\u003E\u003Cbr\u003E            ThumbnailHelper.CaptureThumbnail (ship, 256, \u0022tmp\u0022, m_files [i] \u002B i.ToString());\u003Cbr\u003E            ShipConstruction.CaptureThumbnail (ship, \u0022tmp\u0022, m_files [i] \u002B \u0022-2-\u0022 \u002B i.ToString ());\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            configFile = null;\u003Cbr\u003E            ship = null;\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThe first one or two work fine, but then the images start to become a mishmosh of all the previous craft.\u003C/p\u003E\u003Cp\u003EIf I only do a single craft, there is no problem.\u003C/p\u003E\u003Cp\u003EMy guess is that the CraftThumbnail.TakeSnapshot function (which both the above functions use) is in a different thread and takes longer to generate the images than it takes to loop through that array\u003C/p\u003E\u003Cp\u003EAnother clue is that in the log, I see message like this:\u003C/p\u003E\u003Cp\u003ETwo-Stage Lander loaded\u003C/p\u003E\u003Cp\u003Ewhich are not from my mod, so maybe the craft has to be loaded first before taking the snapshot, and there is a race condition somewhere\u003C/p\u003E\u003Cp\u003EI added some code to watch the png files to be sure they are done being written, but that didn\u0027t help\u003C/p\u003E\u003Cp\u003EAny other ideas?\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-08-30T21:52:52Z\u0022 title=\u002208/30/2015 09:52  PM\u0022 data-short=\u00228 yr\u0022\u003EAugust 30, 2015\u003C/time\u003E by linuxgurugamer\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-08-31T13:18:14Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022linuxgurugamer\u0022 data-cite=\u0022linuxgurugamer\u0022\u003E\u003Cdiv\u003EI found this posting:\u003Cp\u003E\u003Ca href=\u0022https://forum.kerbalspaceprogram.com/threads/119609-Manually-generating-ship-thumbnail\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://forum.kerbalspaceprogram.com/threads/119609-Manually-generating-ship-thumbnail\u003C/a\u003E\u003C/p\u003E\u003Cp\u003Eand it works well for a single ship.\u003C/p\u003E\u003Cp\u003Ehowever, i\u0027m having a problem with generating a number of images all at once:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003E\u003Cbr\u003Efor (int i = 0; i \u0026lt; m_filesWithImages.Length; \u002B\u002Bi) {\u003Cbr\u003E    if (m_files [i].Contains (\u0022.craft\u0022)) {\u003Cbr\u003E        string f = m_newDirectory \u002B \u0022/\u0022 \u002B m_files [i];\u003Cbr\u003E\u003Cbr\u003E        if (System.IO.File.Exists (f)) {\u003Cbr\u003E\u003Cbr\u003E            var configFile = ConfigNode.Load (f);\u003Cbr\u003E\u003Cbr\u003E            ShipConstruct ship = new ShipConstruct ();\u003Cbr\u003E            ship.LoadShip (configFile);\u003Cbr\u003E\u003Cbr\u003E            ThumbnailHelper.CaptureThumbnail (ship, 256, \u0022tmp\u0022, m_files [i] \u002B i.ToString());\u003Cbr\u003E            ShipConstruction.CaptureThumbnail (ship, \u0022tmp\u0022, m_files [i] \u002B \u0022-2-\u0022 \u002B i.ToString ());\u003Cbr\u003E\u003Cbr\u003E\u003Cbr\u003E            configFile = null;\u003Cbr\u003E            ship = null;\u003Cbr\u003E        }\u003Cbr\u003E    }\u003Cbr\u003E}\u003Cbr\u003E\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EThe first one or two work fine, but then the images start to become a mishmosh of all the previous craft.\u003C/p\u003E\u003Cp\u003EIf I only do a single craft, there is no problem.\u003C/p\u003E\u003Cp\u003EMy guess is that the CraftThumbnail.TakeSnapshot function (which both the above functions use) is in a different thread and takes longer to generate the images than it takes to loop through that array\u003C/p\u003E\u003Cp\u003EAnother clue is that in the log, I see message like this:\u003C/p\u003E\u003Cp\u003ETwo-Stage Lander loaded\u003C/p\u003E\u003Cp\u003Ewhich are not from my mod, so maybe the craft has to be loaded first before taking the snapshot, and there is a race condition somewhere\u003C/p\u003E\u003Cp\u003EI added some code to watch the png files to be sure they are done being written, but that didn\u0027t help\u003C/p\u003E\u003Cp\u003EAny other ideas?\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003EOn second thought, it might be that it hasn\u0027t finished clearing out the previous ship before I load the next one. But how can I tell if that\u0027s the problem, and if so, how can I prevent this from happening?\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-09-01T01:30:51Z","Content":"\n\u003Cp\u003EAfter a lot of tests, I\u0027ve been able to conclude that for some reason, loading multiple ships will, after loading 2 or 3 ships, start corrupting the loaded ships.\u003C/p\u003E\u003Cp\u003EI\u0027m not sure why yet. But what I\u0027ve done is to load all the ships, but only make one thumbnail and it is bad, but if I load the same ship by itself and make the thumbnail, it\u0027s correct.\u003C/p\u003E\u003Cp\u003EI tried adding a ship.Clear(), in the hope that it would clear whatever memory is being used, but that didn\u0027t help.\u003C/p\u003E\u003Cp\u003EThis happens even when the variable goes out of context and therefore the memory it uses is released.\u003C/p\u003E\u003Cp\u003EAnybody have any suggestions?\u003C/p\u003E\u003Cp\u003EEdit: Interesting observation. the \u0022ship.LoadShip\u0022 actually loads the ship into the current scene. So what I\u0027m guessing is happening is that all the ships are being loaded into the scene and mashed together. \u003C/p\u003E\u003Cp\u003ELooks kind of interesting, but crashes the VAB\u003C/p\u003E\u003Cp\u003ESo, I\u0027m trying to find the following:\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cul\u003E\u003Cli\u003EA function to find the currently loaded ship and copy it\u003Cbr\u003E\u003C/li\u003E\u003Cli\u003EA function to clear the currently loaded ship\u003Cbr\u003E\u003C/li\u003E\u003C/ul\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EWhat I want to do is to first copy the currently loaded ship, clear it, then load each craft file and take a thumbnail snapshot, and finally to restore the originally loaded ship\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-09-01T12:37:27Z\u0022 title=\u002209/01/2015 12:37  PM\u0022 data-short=\u00228 yr\u0022\u003ESeptember 1, 2015\u003C/time\u003E by linuxgurugamer\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-09-03T16:26:50Z","Content":"\n\u003Cp\u003EAfter more testing, it seems that when I load a craft in the VAB using the above code, sometimes it will get loaded as a ship, and sometimes as a part, into the VAB scene itself. It\u0027s repeatable, so is obviously dependent on something in the .craft files.\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2015-09-03T23:41:00Z","Content":"\n\u003Cp\u003EYou\u0027ve basically nailed the problem. The parts are hanging around for each snapshot. Destroy them after you\u0027ve captured a thumbnail\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-09-04T03:08:32Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022 data-cite=\u0022xEvilReeperx\u0022\u003E\u003Cdiv\u003EYou\u0027ve basically nailed the problem. The parts are hanging around for each snapshot. Destroy them after you\u0027ve captured a thumbnail\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003ESo how do you destroy an entire ship, the \u0022clear\u0022 function doesn\u0027t seem to do anything.\u003C/p\u003E\n"},{"CreatedByName":"xEvilReeperx","CreatedById":75857,"CreatedDateTime":"2015-09-04T04:44:57Z","Content":"\n\u003Cp\u003EIt probably isn\u0027t destroying the parts, then.\u003C/p\u003E\u003Cp\u003E\u003C/p\u003E\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003EShipConstruct ship = blah;\u003Cbr\u003E\u003Cbr\u003Eforeach (var p in ship.Parts)\u003Cbr\u003E    UnityEngine.Object.Destroy(p.gameObject);\u003C/pre\u003E\u003Cp\u003E\u003C/p\u003E\u003Cp\u003EIf this doesn\u0027t solve it, I\u0027ll have a look myself in the morning\u003C/p\u003E\n"},{"CreatedByName":"linuxgurugamer","CreatedById":129964,"CreatedDateTime":"2015-09-04T19:38:45Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022xEvilReeperx\u0022 data-cite=\u0022xEvilReeperx\u0022\u003E\u003Cdiv\u003EIt probably isn\u0027t destroying the parts, then.\u003Cdiv\u003E\u003C/div\u003E\u003Cpre class=\u0022ipsCode\u0022\u003EShipConstruct ship = blah;\u003C/pre\u003E\u003Cp\u003Eforeach (var p in ship.Parts)\u003C/p\u003E\u003Cp\u003E UnityEngine.Object.Destroy(p.gameObject);\u003C/p\u003E\u003Cp\u003EIf this doesn\u0027t solve it, I\u0027ll have a look myself in the morning\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\n"}]}