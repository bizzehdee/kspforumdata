{"TopicId":118744,"ForumId":15,"TopicTitle":"animated container plugin and performance","CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-18T11:17:41Z","PageNum":1,"Articles":[{"CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-18T11:17:41Z","Content":"\n\u003Cp\u003EI\u0027ve created a container with drill bits that use Bahamuto\u0027s BDanimationModules (\u003Ca href=\u0022https://github.com/BahamutoD/BDAnimationModules/blob/master/BDAnimationModules/AnimatedContainer.cs\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/BahamutoD/BDAnimationModules/blob/master/BDAnimationModules/AnimatedContainer.cs\u003C/a\u003E) plugin to show how full/empty it is. The animation consists of 11 elements that follow same path in the container (so 2 keyframes per object). Now the problem is performance, having 10 or even 5 such containers in the scene seriously slows down KSP (yellow timer).\u003C/p\u003E\u003Cp\u003EIs there any animation trick or plugin edit that I can use to improve performance?\u003C/p\u003E\u003Cp\u003EPhoto below: 2 trucks, each with 5 drill bit containers results in low fps and yellow timer even when there\u0027s no animation:\u003C/p\u003E\u003Cp\u003E\u003Cimg src=\u0022http://i.imgur.com/ty1eUO8.jpg\u0022 alt=\u0022ty1eUO8.jpg\u0022\u003E\u003C/p\u003E\u003Cp\u003Eedit: changed title to better describe a problem\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-08-19T09:07:39Z\u0022 title=\u002208/19/2015 09:07  AM\u0022 data-short=\u00228 yr\u0022\u003EAugust 19, 2015\u003C/time\u003E by riocrokite\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-18T20:18:28Z","Content":"\n\u003Cp\u003Etested different animations and I think the main reason behind slow performance seems to be the plugin or unity limitations :/ In other words no matter how simple or how complex the animation is, slowdown is the same.\u003C/p\u003E\n"},{"CreatedByName":"landeTLS","CreatedById":97925,"CreatedDateTime":"2015-08-19T00:27:17Z","Content":"\n\u003Cp\u003EYou could try using the skinned mesh renderer. That would allow the animated meshes to be combined into a single object. To set this up if you are using blender youll need to use an armature to drive the meshes. The advantage of this is that you can use the more extensive bone constraint system in blender to bake the animation. I have not done any benchmarks on if this method results in better fps or not. From what i read the disadvantage of using it is that there is a greater cpu overhead as the vertecies needs to be translated before drawing(only while the animations are playing) but less total drawcalls because of the lower object count. There may be a point at which it becomes better than standard parent/child animations (if there are many moving parts) but im not sure when that is.\u003C/p\u003E\u003Cp\u003EThat is if there are not other setup related or keyframing issues causing the slowdown. \u003C/p\u003E\u003Cp\u003EEdit. Read the op again. Saw your using a plugin for the animation. So im not sure if this could be the cause or not. The animations would still be played by the unity legacy animation component but perhaps the plugin is polling for animation status too often causing cpu overhead. But seeing as its the one made by bahamuto it should be pretty optimised(the guy made a kickass mech game from scratch:cool:) but worth checking out in the source nonetheless\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-08-19T00:40:15Z\u0022 title=\u002208/19/2015 12:40  AM\u0022 data-short=\u00228 yr\u0022\u003EAugust 19, 2015\u003C/time\u003E by landeTLS\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"lo-fi","CreatedById":111099,"CreatedDateTime":"2015-08-19T01:40:24Z","Content":"\n\u003Cp\u003EI\u0027ve seen random performance issues pop up with animations here and there, but I can\u0027t give you anything definitive. There shouldn\u0027t be performance issues, I can tell you that much. What happens if you trigger the animation with stock or FS modules?\u003C/p\u003E\n"},{"CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-19T08:38:20Z","Content":"\n\u003Cp\u003EI think the reason lies in the plugin (or unity limitations), however don\u0027t know how to resolve it.\u003C/p\u003E\u003Cp\u003E@lo-fi: I\u0027ve tried to trigger animation with stock animation module, max fps when animation is not triggered, low fps only with animation:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://i.imgur.com/mF7wIn6.png\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://i.imgur.com/mF7wIn6.png\u003C/a\u003E - before animation\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://i.imgur.com/KEBsQzd.png\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://i.imgur.com/KEBsQzd.png\u003C/a\u003E -when animating\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022http://i.imgur.com/h45ol73.png\u0022 rel=\u0022external nofollow\u0022\u003Ehttp://i.imgur.com/h45ol73.png\u003C/a\u003E - after animation\u003C/p\u003E\u003Cp\u003E@landeTLS:\u003C/p\u003E\u003Cp\u003Ethe whole code I use from Bahamuto is here:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://github.com/BahamutoD/BDAnimationModules/blob/master/BDAnimationModules/AnimatedContainer.cs\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://github.com/BahamutoD/BDAnimationModules/blob/master/BDAnimationModules/AnimatedContainer.cs\u003C/a\u003E\u003C/p\u003E\u003Cp\u003ECode consists of 4 elements: onStart, onUpdate, onUpdate in editor and AnimationState.\u003C/p\u003E\u003Cp\u003EI\u0027ve tried deleting whole \u0027onUpdate\u0027 section but that didn\u0027t resolve low fps problem (even though that disabled an animation).\u003C/p\u003E\u003Cp\u003ESo it\u0027s like onStart or AnimationState component causes a situation where a KSP part is \u0027always animating\u0027 even though animation is stopped.\u003C/p\u003E\u003Cp\u003EIdeally the plugin would trigger animation only when amount of resource is changing, otherwise not doing stuff that lowers fps.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-08-19T08:52:59Z\u0022 title=\u002208/19/2015 08:52  AM\u0022 data-short=\u00228 yr\u0022\u003EAugust 19, 2015\u003C/time\u003E by riocrokite\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"lo-fi","CreatedById":111099,"CreatedDateTime":"2015-08-19T09:43:20Z","Content":"\n\u003Cp\u003EI\u0027m thinking there\u0027s something messed up with the animation itself, I\u0027m sure I\u0027ve seen this kind of thing before..\u003C/p\u003E\u003Cp\u003ECould you bundle all the assets up into a .unitypackage so I can take a look at how its rigged up? I think we\u0027ll find the culprit is hiding in there, and the animation modules are struggling to deal with it somehow.\u003C/p\u003E\n"},{"CreatedByName":"landeTLS","CreatedById":97925,"CreatedDateTime":"2015-08-19T14:16:16Z","Content":"\n\u003Cp\u003EThe plugin is very simple. The animation init method used is the same as used by kethane etc. I dont think it is the issue. I agree with lo-fi. The problem lies in the setup not the api. Unity can handle more complex animations without issues\u003C/p\u003E\n"},{"CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-19T19:04:55Z","Content":"\n\u003Cp\u003Ethanks for help guys, now I\u0027m puzzled :/\u003C/p\u003E\u003Cp\u003Ehere\u0027s unity package:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://www.dropbox.com/s/tkp97kkpdclrpsh/animated_container.unitypackage?dl=0\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://www.dropbox.com/s/tkp97kkpdclrpsh/animated_container.unitypackage?dl=0\u003C/a\u003E\u003C/p\u003E\u003Cp\u003EIs there any other mod that uses bahamuto\u0027s BDanimatedContainer module? I don\u0027t recall any :/\u003C/p\u003E\n"},{"CreatedByName":"lo-fi","CreatedById":111099,"CreatedDateTime":"2015-08-19T20:28:40Z","Content":"\n\u003Cp\u003EThanks, but could you include a saved .unity scene with it all rigged up ready to go please? Without that, I can\u0027t tell how you\u0027ve got everything setup.\u003C/p\u003E\n"},{"CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-19T21:22:08Z","Content":"\n\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022 data-ipsquote-username=\u0022lo-fi\u0022 data-cite=\u0022lo-fi\u0022\u003E\u003Cdiv\u003EThanks, but could you include a saved .unity scene with it all rigged up ready to go please? Without that, I can\u0027t tell how you\u0027ve got everything setup.\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003Eok, saved scene, hopefully this is ok:\u003C/p\u003E\u003Cp\u003E\u003Ca href=\u0022https://www.dropbox.com/s/b8k3wbfxla634zk/animatedContainer.unity?dl=0\u0022 rel=\u0022external nofollow\u0022\u003Ehttps://www.dropbox.com/s/b8k3wbfxla634zk/animatedContainer.unity?dl=0\u003C/a\u003E\u003C/p\u003E\n"},{"CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-20T09:12:34Z","Content":"\n\u003Cp\u003Etried different type of animation (1 container = 11 objects not following bezier curve but moving linearly between 6 locations - used 6 key frames per each object). Results are \u0027weird\u0027:\u003C/p\u003E\u003Cp\u003EDifference in editor:\u003C/p\u003E\u003Cp\u003Enew linear animation: 4 containers = 55 fps, 8 containers = 37 fps\u003C/p\u003E\u003Cp\u003Eold bcurve animation: 4 containers = 40 fps, 8 containers = 23 fps\u003C/p\u003E\u003Cp\u003EDifference when launched:\u003C/p\u003E\u003Cp\u003Enew linear animation: 4 containers = 33 fps, 8 containers = 22 fps\u003C/p\u003E\u003Cp\u003Eold bcurve animation: 4 containers = 38 fps, 8 containers = 23 fps\u003C/p\u003E\u003Cp\u003Eso simple animation using just location keyframes (compared to following bezier curve path) behaves better in editor however worse when launched :/\u003C/p\u003E\u003Cp\u003E\u003Cem\u003Eedit\u003C/em\u003E: played a bit with Bahamuto\u0027s plugin;\u003C/p\u003E\u003Cp\u003Echanging WrapMode from ClampForever to Once causes certain bugs however has one desired effect: disables animation when container is full. In effect I have 60fps with 8 containers (and that drops to above numbers when containers are even slightly depleted).\u003C/p\u003E\u003Cp\u003EI would be totally happy if I could disable animation with full and empty container since I would be using stack_priority_search when using resources so only one container would be animated at the same time rest being either full or empty thus not slowing down KSP.\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-08-20T09:25:28Z\u0022 title=\u002208/20/2015 09:25  AM\u0022 data-short=\u00228 yr\u0022\u003EAugust 20, 2015\u003C/time\u003E by riocrokite\u003C/strong\u003E\n\u003C/span\u003E\n"},{"CreatedByName":"riocrokite","CreatedById":129319,"CreatedDateTime":"2015-08-20T10:17:41Z","Content":"\n\u003Cp\u003Eok, code fiddling brought desired effects:\u003C/p\u003E\u003Cp\u003EI can disable animation when container is either full or empty: change in code:\u003C/p\u003E\u003Cblockquote data-ipsquote=\u0022\u0022 class=\u0022ipsQuote\u0022\u003E\u003Cdiv\u003Eforeach (var cs in containerStates)\u003Cp\u003E {\u003C/p\u003E\u003Cp\u003E cs.normalizedTime = (float)normalizedRes;\u003C/p\u003E\u003Cp\u003E \u003Cstrong\u003Ecs.enabled=true;\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003E \u003Cstrong\u003Eif (normalizedRes \u0026gt;= 0.99f || normalizedRes \u0026lt;= 0.01f)\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003E {\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003E cs.enabled = false;\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003E }\u003C/strong\u003E\u003C/p\u003E\u003Cp\u003E }\u003C/p\u003E\u003C/div\u003E\u003C/blockquote\u003E\u003Cp\u003Eso full 60 fps if container is either empty or full.\u003C/p\u003E\u003Cp\u003ENow I believe that further optimization to plugin is possible. For example enable animation only when resources in container have changed. Any hints how to do it?\u003C/p\u003E\u003Cp\u003E------------------------------------------------\u003C/p\u003E\u003Cp\u003E\u003Cem\u003Eedit:\u003C/em\u003E\u003C/p\u003E\u003Cp\u003EMy problem is mostly resolved for now:\u003C/p\u003E\u003Cp\u003E\u002B disabling animation when container is either empty or full (look above)\u003C/p\u003E\u003Cp\u003E\u002B making sure that container resource and users of them have STACK_PRIORITY_SEARCH config - this ensures that only one container is animated at the time (rest being either full or empty thus not affecting performance)\u003C/p\u003E\u003Cp\u003E- the only problem that remains is filling containers again (using another converter or drill) since it will always fill them equally thus activating all animations and slowing down the game\u003C/p\u003E\n\u003Cspan class=\u0022ipsType_reset ipsType_medium ipsType_light\u0022 data-excludequote=\u0022\u0022\u003E\n\u003Cstrong\u003EEdited \u003Ctime datetime=\u00222015-08-20T11:43:36Z\u0022 title=\u002208/20/2015 11:43  AM\u0022 data-short=\u00228 yr\u0022\u003EAugust 20, 2015\u003C/time\u003E by riocrokite\u003C/strong\u003E\n\u003C/span\u003E\n"}]}